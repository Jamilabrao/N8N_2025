{"createdAt":"2025-09-01T14:27:59.787Z","updatedAt":"2025-09-02T15:07:09.139Z","id":"XtB82qQyuXJqEADf","name":"DISPARAPRO 2.0","active":true,"isArchived":false,"nodes":[{"parameters":{"html":"<!DOCTYPE html>\n<html lang=\"pt-BR\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>Conectar WhatsApp</title>\n    <style>\n        * {\n            margin: 0;\n            padding: 0;\n            box-sizing: border-box;\n        }\n\n        body {\n            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);\n            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n            color: white;\n            min-height: 100vh;\n            margin: 0;\n            padding: 0;\n        }\n\n        .app-layout {\n            display: flex;\n            min-height: 100vh;\n        }\n\n        /* Sidebar */\n        .sidebar {\n            width: 70px;\n            background: rgba(0, 0, 0, 0.3);\n            backdrop-filter: blur(10px);\n            border-right: 1px solid rgba(255, 255, 255, 0.1);\n            transition: all 0.3s ease;\n            position: relative;\n            z-index: 1000;\n            display: flex;\n            flex-direction: column;\n            height: 100vh;\n        }\n\n        .sidebar:hover {\n            width: 250px;\n        }\n\n        .sidebar-header {\n            padding: 20px;\n            text-align: center;\n            border-bottom: 1px solid rgba(255, 255, 255, 0.1);\n        }\n\n        .sidebar-logo {\n            font-size: 1.5rem;\n            font-weight: 600;\n            background: linear-gradient(135deg, #25d366 0%, #128c7e 100%);\n            -webkit-background-clip: text;\n            -webkit-text-fill-color: transparent;\n            background-clip: text;\n            white-space: nowrap;\n            opacity: 0;\n            transition: opacity 0.3s ease;\n        }\n\n        .sidebar:hover .sidebar-logo {\n            opacity: 1;\n        }\n\n        .sidebar-menu {\n            padding: 20px 0;\n            flex: 1;\n        }\n\n        .menu-item {\n            display: flex;\n            align-items: center;\n            padding: 15px 20px;\n            color: #ccc;\n            text-decoration: none;\n            transition: all 0.3s ease;\n            position: relative;\n            white-space: nowrap;\n        }\n\n        .menu-item:hover {\n            background: rgba(37, 211, 102, 0.1);\n            color: #25d366;\n        }\n\n        .menu-item.active {\n            background: rgba(37, 211, 102, 0.2);\n            color: #25d366;\n            border-right: 3px solid #25d366;\n        }\n\n        .menu-icon {\n            font-size: 1.2rem;\n            width: 30px;\n            text-align: center;\n            flex-shrink: 0;\n        }\n\n        .menu-text {\n            margin-left: 15px;\n            opacity: 0;\n            transition: opacity 0.3s ease;\n        }\n\n        .sidebar:hover .menu-text {\n            opacity: 1;\n        }\n\n        .sidebar-footer {\n            margin-top: auto;\n            border-top: 1px solid rgba(255, 255, 255, 0.1);\n            padding: 10px 0;\n        }\n\n        .logout-item {\n            color: #ff6b6b !important;\n        }\n\n        .logout-item:hover {\n            background: rgba(255, 107, 107, 0.1) !important;\n            color: #ff6b6b !important;\n        }\n\n        /* Main content */\n        .main-content {\n            flex: 1;\n            padding: 20px;\n            overflow-x: auto;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            min-height: 100vh;\n        }\n\n        .container {\n            width: 100%;\n            height: 100%;\n            display: flex;\n            gap: 60px;\n            align-items: stretch;\n            justify-content: center;\n            max-width: none;\n        }\n\n        .left-section {\n            flex: 1;\n            display: flex;\n            flex-direction: column;\n            justify-content: center;\n            min-height: 70vh;\n        }\n\n        .right-section {\n            flex: 1;\n            display: flex;\n            flex-direction: column;\n            justify-content: center;\n            min-height: 70vh;\n        }\n\n        .header {\n            text-align: center;\n            margin-bottom: 30px;\n        }\n\n        .header h1 {\n            font-size: 2.5rem;\n            font-weight: 600;\n            margin-bottom: 15px;\n        }\n\n        .header p {\n            color: #888;\n            font-size: 1rem;\n            line-height: 1.5;\n        }\n\n        .qr-section {\n            background: rgba(255, 255, 255, 0.02);\n            border: 1px solid rgba(255, 255, 255, 0.1);\n            border-radius: 12px;\n            padding: 40px;\n            text-align: center;\n            backdrop-filter: blur(10px);\n        }\n\n        .qr-section h2 {\n            font-size: 1.3rem;\n            margin-bottom: 30px;\n            color: #fff;\n        }\n\n        .input-group {\n            margin-bottom: 25px;\n        }\n\n        .input-group input {\n            width: 100%;\n            padding: 15px;\n            background: rgba(255, 255, 255, 0.05);\n            border: 1px solid rgba(255, 255, 255, 0.2);\n            border-radius: 8px;\n            color: white;\n            font-size: 1rem;\n            outline: none;\n            transition: all 0.3s ease;\n        }\n\n        .input-group input::placeholder {\n            color: #888;\n        }\n\n        .input-group input:focus {\n            border-color: #25d366;\n            box-shadow: 0 0 0 2px rgba(37, 211, 102, 0.2);\n        }\n\n        .generate-btn {\n            width: 100%;\n            padding: 15px;\n            background: linear-gradient(135deg, #25d366 0%, #128c7e 100%);\n            border: none;\n            border-radius: 8px;\n            color: white;\n            font-size: 1rem;\n            font-weight: 600;\n            cursor: pointer;\n            transition: all 0.3s ease;\n            margin-bottom: 25px;\n        }\n\n        .generate-btn:hover {\n            transform: translateY(-2px);\n            box-shadow: 0 8px 25px rgba(37, 211, 102, 0.3);\n        }\n\n        .generate-btn:disabled {\n            background: #444;\n            cursor: not-allowed;\n            transform: none;\n            box-shadow: none;\n        }\n\n        .qr-display {\n            display: none;\n            flex-direction: column;\n            align-items: center;\n            gap: 20px;\n        }\n\n        .qr-display.show {\n            display: flex;\n        }\n\n        .qr-code {\n            width: 250px;\n            height: 250px;\n            border: 2px solid rgba(255, 255, 255, 0.1);\n            border-radius: 12px;\n            background: white;\n            padding: 10px;\n        }\n\n        .qr-code img {\n            width: 100%;\n            height: 100%;\n            object-fit: contain;\n        }\n\n        .refresh-btn {\n            background: rgba(255, 255, 255, 0.1);\n            border: 1px solid rgba(255, 255, 255, 0.2);\n            color: white;\n            padding: 10px 20px;\n            border-radius: 6px;\n            cursor: pointer;\n            font-size: 0.9rem;\n            transition: all 0.3s ease;\n        }\n\n        .refresh-btn:hover {\n            background: rgba(255, 255, 255, 0.2);\n        }\n\n        .refresh-btn:disabled {\n            background: #444;\n            cursor: not-allowed;\n        }\n\n        .timer {\n            color: #25d366;\n            font-size: 0.9rem;\n            margin-top: 10px;\n        }\n\n        .instructions {\n            background: rgba(255, 255, 255, 0.02);\n            border: 1px solid rgba(255, 255, 255, 0.1);\n            border-radius: 12px;\n            padding: 30px;\n            backdrop-filter: blur(10px);\n        }\n\n        .instructions h3 {\n            color: #25d366;\n            margin-bottom: 20px;\n            font-size: 1.2rem;\n        }\n\n        .step {\n            display: flex;\n            align-items: flex-start;\n            gap: 15px;\n            margin-bottom: 20px;\n            padding: 15px;\n            background: rgba(255, 255, 255, 0.02);\n            border-radius: 8px;\n        }\n\n        .step-number {\n            background: #25d366;\n            color: white;\n            width: 28px;\n            height: 28px;\n            border-radius: 50%;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            font-weight: bold;\n            font-size: 0.9rem;\n            flex-shrink: 0;\n        }\n\n        .step-content h4 {\n            color: #fff;\n            margin-bottom: 5px;\n            font-size: 1rem;\n        }\n\n        .step-content p {\n            color: #888;\n            font-size: 0.9rem;\n            line-height: 1.4;\n        }\n\n        .loading {\n            display: none;\n            align-items: center;\n            justify-content: center;\n            gap: 10px;\n            color: #25d366;\n            margin: 20px 0;\n        }\n\n        .loading.show {\n            display: flex;\n        }\n\n        .spinner {\n            width: 20px;\n            height: 20px;\n            border: 2px solid rgba(37, 211, 102, 0.3);\n            border-top: 2px solid #25d366;\n            border-radius: 50%;\n            animation: spin 1s linear infinite;\n        }\n\n        @keyframes spin {\n            0% { transform: rotate(0deg); }\n            100% { transform: rotate(360deg); }\n        }\n\n        .error {\n            background: rgba(255, 59, 48, 0.1);\n            border: 1px solid rgba(255, 59, 48, 0.3);\n            color: #ff3b30;\n            padding: 15px;\n            border-radius: 8px;\n            margin: 15px 0;\n            display: none;\n        }\n\n        .error.show {\n            display: block;\n        }\n\n        .connection-status {\n            background: rgba(37, 211, 102, 0.1);\n            border: 1px solid rgba(37, 211, 102, 0.3);\n            color: #25d366;\n            padding: 15px;\n            border-radius: 8px;\n            margin: 15px 0;\n            display: none;\n        }\n\n        .connection-status.show {\n            display: block;\n        }\n\n        @media (max-width: 768px) {\n            .container {\n                flex-direction: column;\n                gap: 30px;\n            }\n            \n            .header h1 {\n                font-size: 2rem;\n            }\n            \n            .qr-section, .instructions {\n                padding: 25px;\n            }\n\n            .sidebar {\n                width: 60px;\n            }\n\n            .sidebar:hover {\n                width: 200px;\n            }\n\n            .main-content {\n                padding: 15px;\n            }\n        }\n    </style>\n</head>\n<body>\n    <div class=\"app-layout\">\n        <!-- Sidebar -->\n        <div class=\"sidebar\">\n            <div class=\"sidebar-header\">\n                <div class=\"sidebar-logo\">EnviaZap</div>\n            </div>\n            <nav class=\"sidebar-menu\">\n                <a href=\"#\" class=\"menu-item\" onclick=\"navigateToPage('https://n8n.typebot.pro/webhook/dashboard')\">\n                    <span class=\"menu-icon\">📊</span>\n                    <span class=\"menu-text\">Dashboard</span>\n                </a>\n                <a href=\"#\" class=\"menu-item\" onclick=\"navigateToPage('https://n8n.typebot.pro/webhook/historico-disparos')\">\n                    <span class=\"menu-icon\">📋</span>\n                    <span class=\"menu-text\">Histórico de disparos</span>\n                </a>\n                <a href=\"#\" class=\"menu-item active\">\n                    <span class=\"menu-icon\">🔗</span>\n                    <span class=\"menu-text\">Nova Conexão</span>\n                </a>\n                <a href=\"#\" class=\"menu-item\" onclick=\"navigateToPage('https://n8n.typebot.pro/webhook/conexoes')\">\n                    <span class=\"menu-icon\">🔌</span>\n                    <span class=\"menu-text\">Conexões</span>\n                </a>\n                <a href=\"#\" class=\"menu-item\" onclick=\"navigateToPage('https://n8n.typebot.pro/webhook/disparos-individuais')\">\n                    <span class=\"menu-icon\">📱</span>\n                    <span class=\"menu-text\">Disparos individuais</span>\n                </a>\n                <a href=\"#\" class=\"menu-item\" onclick=\"navigateToPage('https://n8n.typebot.pro/webhook/disparos-grupos')\">\n                    <span class=\"menu-icon\">👥</span>\n                    <span class=\"menu-text\">Disparos em grupo</span>\n                </a>\n                <a href=\"#\" class=\"menu-item\" onclick=\"navigateToPage('https://n8n.typebot.pro/webhook/listas')\">\n                    <span class=\"menu-icon\">📝</span>\n                    <span class=\"menu-text\">Listas</span>\n                </a>\n            </nav>\n            <div class=\"sidebar-footer\">\n                <a href=\"#\" class=\"menu-item logout-item\" onclick=\"logout()\">\n                    <span class=\"menu-icon\">🚪</span>\n                    <span class=\"menu-text\">Sair</span>\n                </a>\n            </div>\n        </div>\n\n        <!-- Main Content -->\n        <div class=\"main-content\">\n            <div class=\"container\">\n                <div class=\"left-section\">\n                    <div class=\"header\">\n                        <h1>Conectar WhatsApp</h1>\n                        <p>Escaneie o QR Code ou use o código de pareamento para conectar sua conta do WhatsApp à Evolution API.</p>\n                    </div>\n\n                    <div class=\"qr-section\">\n                        <h2>Escaneie o QR Code</h2>\n                        \n                        <div class=\"form-section\" id=\"formSection\">\n                            <div class=\"input-group\">\n                                <input type=\"text\" id=\"instanceName\" placeholder=\"Digite o nome da conexão\" maxlength=\"50\">\n                            </div>\n                            <button class=\"generate-btn\" id=\"generateBtn\">Gerar QR Code</button>\n                        </div>\n\n                        <div class=\"loading\" id=\"loading\">\n                            <div class=\"spinner\"></div>\n                            <span>Gerando QR Code...</span>\n                        </div>\n\n                        <div class=\"error\" id=\"error\">\n                            <span id=\"errorMessage\"></span>\n                        </div>\n\n                        <div class=\"connection-status\" id=\"connectionStatus\">\n                            <span id=\"statusMessage\"></span>\n                        </div>\n\n                        <div class=\"qr-display\" id=\"qrDisplay\">\n                            <div class=\"qr-code\">\n                                <img id=\"qrImage\" src=\"\" alt=\"QR Code\">\n                            </div>\n                            <button class=\"refresh-btn\" id=\"refreshBtn\">🔄 Gerar Novamente</button>\n                            <div class=\"timer\" id=\"timer\">Expira em 29 segundos</div>\n                        </div>\n                    </div>\n                </div>\n\n                <div class=\"right-section\">\n                    <div class=\"instructions\">\n                        <h3>Como conectar</h3>\n                        \n                        <div class=\"step\">\n                            <div class=\"step-number\">1</div>\n                            <div class=\"step-content\">\n                                <h4>Abra o WhatsApp no seu celular</h4>\n                                <p>Certifique-se de que você está usando a versão mais recente do aplicativo.</p>\n                            </div>\n                        </div>\n\n                        <div class=\"step\">\n                            <div class=\"step-number\">2</div>\n                            <div class=\"step-content\">\n                                <h4>Acesse as configurações</h4>\n                                <p>Toque em <strong>Configurações → Dispositivos conectados</strong></p>\n                            </div>\n                        </div>\n\n                        <div class=\"step\">\n                            <div class=\"step-number\">3</div>\n                            <div class=\"step-content\">\n                                <h4>Escolha um método de conexão</h4>\n                                <p>📱 Toque em <strong>Conectar um dispositivo</strong> e escaneie o QR Code</p>\n                                <p style=\"margin-top: 8px;\"><strong>OU</strong></p>\n                                <p style=\"margin-top: 8px;\">📱 Toque em <strong>Conectar um dispositivo</strong> e digite o código de pareamento</p>\n                            </div>\n                        </div>\n\n                        <div class=\"step\">\n                            <div class=\"step-number\">4</div>\n                            <div class=\"step-content\">\n                                <h4>Aguarde a Conexão</h4>\n                                <p>Após escanear o QR Code ou inserir o código, aguarde a confirmação da conexão.</p>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        </div>\n    </div>\n\n    <script>\n        // Elementos do DOM\n        const instanceNameInput = document.getElementById('instanceName');\n        const generateBtn = document.getElementById('generateBtn');\n        const loading = document.getElementById('loading');\n        const error = document.getElementById('error');\n        const errorMessage = document.getElementById('errorMessage');\n        const connectionStatus = document.getElementById('connectionStatus');\n        const statusMessage = document.getElementById('statusMessage');\n        const qrDisplay = document.getElementById('qrDisplay');\n        const qrImage = document.getElementById('qrImage');\n        const refreshBtn = document.getElementById('refreshBtn');\n        const timer = document.getElementById('timer');\n        const formSection = document.getElementById('formSection');\n\n        // Variáveis globais\n        let timerInterval;\n        let connectionCheckInterval;\n        let timeLeft = 29;\n        let currentInstanceName = '';\n        let secureUserId = null;\n\n        // Função para ler cookies\n        function getCookie(name) {\n            const value = `; ${document.cookie}`;\n            const parts = value.split(`; ${name}=`);\n            if (parts.length === 2) return parts.pop().split(';').shift();\n            return null;\n        }\n\n        // Função para obter userId de forma segura via cookies\n        function getSecureUserId() {\n            const userId = getCookie('userId');\n            if (userId && /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(userId)) {\n                console.log('✅ UserId (UUID) obtido dos cookies:', userId);\n                return userId;\n            }\n            console.error('❌ UserId (UUID) não encontrado ou formato inválido nos cookies!');\n            return null;\n        }\n\n        // Autenticação obrigatória ao carregar a página\n        function checkAuth() {\n            const userId = getSecureUserId();\n            if (!userId) {\n                window.location.href = 'https://n8n.typebot.pro/webhook/login';\n            }\n        }\n\n        // Navegação simplificada (sem parâmetros de autenticação)\n        function navigateToPage(url) {\n            window.location.href = url;\n        }\n\n        // Função para gerar sufixo aleatório\n        function generateRandomSuffix() {\n            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';\n            return Array.from({length: 6}, () => chars[Math.floor(Math.random() * chars.length)]).join('');\n        }\n\n        // Função para mostrar erros\n        function showError(message) {\n            console.log('Mostrando erro:', message);\n            errorMessage.textContent = message;\n            error.classList.add('show');\n            connectionStatus.classList.remove('show');\n            setTimeout(() => {\n                error.classList.remove('show');\n            }, 5000);\n        }\n\n        // Função para mostrar status\n        function showStatus(message) {\n            console.log('Mostrando status:', message);\n            statusMessage.textContent = message;\n            connectionStatus.classList.add('show');\n            error.classList.remove('show');\n        }\n\n        // Função para iniciar timer\n        function startTimer() {\n            timeLeft = 29;\n            timerInterval = setInterval(() => {\n                timer.textContent = `Expira em ${timeLeft} segundos`;\n                timeLeft--;\n                \n                if (timeLeft < 0) {\n                    clearInterval(timerInterval);\n                    timer.textContent = 'QR Code expirado';\n                    timer.style.color = '#ff3b30';\n                }\n            }, 1000);\n        }\n\n        // Função para resetar timer\n        function resetTimer() {\n            if (timerInterval) {\n                clearInterval(timerInterval);\n            }\n            if (connectionCheckInterval) {\n                clearInterval(connectionCheckInterval);\n            }\n            timer.style.color = '#25d366';\n        }\n\n        // Função para verificar estado da conexão\n        async function checkConnectionState() {\n            try {\n                console.log('Verificando estado da conexão para:', currentInstanceName);\n                const response = await fetch(`https://whatsapi.typebot.pro/instance/connectionState/${currentInstanceName}`, {\n                    method: 'GET',\n                    headers: {\n                        'apikey': 'b4d71f9c38e3ac12a6b08e4b6d53aa90'\n                    }\n                });\n\n                const data = await response.json();\n                console.log('Estado da conexão:', data);\n                \n                if (data.instance && data.instance.state === 'open') {\n                    // Conexão estabelecida com sucesso\n                    clearInterval(connectionCheckInterval);\n                    resetTimer();\n                    \n                    // Mostrar mensagem de sucesso\n                    timer.textContent = '✅ Conectado com sucesso!';\n                    timer.style.color = '#34c759';\n                    showStatus('✅ WhatsApp conectado com sucesso! Salvando dados...');\n                    \n                    // Salvar foto do perfil antes de redirecionar\n                    try {\n                        console.log('Salvando foto do perfil...');\n                        const userId = getSecureUserId();\n                        \n                        const savePhotoResponse = await fetch('https://n8n.typebot.pro/webhook/salvarfoto', {\n                            method: 'POST',\n                            headers: {\n                                'Content-Type': 'application/json'\n                            },\n                            body: JSON.stringify({\n                                userId: userId,\n                                instanceName: currentInstanceName\n                            })\n                        });\n\n                        if (!savePhotoResponse.ok) {\n                            console.error('Erro ao salvar foto:', await savePhotoResponse.text());\n                            // Continua mesmo se falhar ao salvar a foto\n                        } else {\n                            console.log('Foto salva com sucesso');\n                        }\n                        \n                    } catch (photoError) {\n                        console.error('Erro na requisição para salvar foto:', photoError);\n                        // Continua mesmo se falhar ao salvar a foto\n                    }\n                    \n                    // Redirecionar após salvar (ou tentar salvar) a foto\n                    showStatus('✅ WhatsApp conectado com sucesso! Redirecionando...');\n                    setTimeout(() => {\n                                            // Redirecionar para página de conexões\n                    window.location.href = 'https://n8n.typebot.pro/webhook/conexoes';\n                    }, 1500);\n                }\n            } catch (err) {\n                console.error('Erro ao verificar estado da conexão:', err);\n            }\n        }\n\n        // Função para iniciar verificação de conexão\n        function startConnectionCheck() {\n            console.log('Iniciando verificação de conexão');\n            connectionCheckInterval = setInterval(checkConnectionState, 5000);\n        }\n\n        // Função principal para gerar QR Code\n        async function generateQRCode() {\n            console.log('Iniciando geração de QR Code');\n            \n            const instanceBaseName = instanceNameInput.value.trim();\n            const userId = getSecureUserId();\n            \n            if (!instanceBaseName) {\n                showError('Por favor, digite o nome da conexão');\n                return;\n            }\n\n            if (!userId) {\n                showError('Sessão inválida. Recarregue a página.');\n                return;\n            }\n\n            console.log('Processando requisição para instância:', instanceBaseName);\n\n            // Reset states\n            error.classList.remove('show');\n            connectionStatus.classList.remove('show');\n            qrDisplay.classList.remove('show');\n            resetTimer();\n\n            // Show loading\n            loading.classList.add('show');\n            generateBtn.disabled = true;\n\n            try {\n                console.log('Fazendo requisição para criar conexão');\n                const response = await fetch('https://n8n.typebot.pro/webhook/criarconexaoback', {\n                    method: 'POST',\n                    headers: {\n                        'Content-Type': 'application/json'\n                    },\n                    body: JSON.stringify({\n                        userId: userId,\n                        instanceName: instanceBaseName\n                    })\n                });\n\n                console.log('Status da resposta:', response.status);\n                const data = await response.json();\n                console.log('Dados recebidos:', data);\n\n                if (!response.ok) {\n                    throw new Error(data.message || 'Erro ao gerar QR Code');\n                }\n\n                if (data.qrcode && data.instanceName) {\n                    console.log('QR Code recebido, exibindo');\n                    \n                    // Armazenar o nome da instância retornado pela API\n                    currentInstanceName = data.instanceName;\n                    \n                    // Show QR Code\n                    qrImage.src = data.qrcode;\n                    \n                    qrDisplay.classList.add('show');\n                    formSection.style.display = 'none';\n                    startTimer();\n                    startConnectionCheck();\n                    showStatus('QR Code gerado! Escaneie com seu WhatsApp.');\n                } else {\n                    throw new Error('QR Code ou instanceName não foi retornado pela API');\n                }\n\n            } catch (err) {\n                console.error('Erro:', err);\n                showError(err.message || 'Erro ao conectar com a API');\n            } finally {\n                loading.classList.remove('show');\n                generateBtn.disabled = false;\n            }\n        }\n\n        // Função para refresh do QR Code\n        async function refreshQRCode() {\n            console.log('Fazendo refresh do QR Code');\n            \n            if (!currentInstanceName) {\n                showError('Nome da instância não encontrado');\n                return;\n            }\n\n            // Reset states\n            error.classList.remove('show');\n            connectionStatus.classList.remove('show');\n            resetTimer();\n\n            // Show loading\n            loading.classList.add('show');\n            refreshBtn.disabled = true;\n\n            try {\n                console.log('Fazendo requisição para reconectar');\n                const response = await fetch(`https://whatsapi.typebot.pro/instance/connect/${currentInstanceName}`, {\n                    method: 'GET',\n                    headers: {\n                        'apikey': 'b4d71f9c38e3ac12a6b08e4b6d53aa90'\n                    }\n                });\n\n                const data = await response.json();\n                console.log('Dados do refresh:', data);\n\n                if (!response.ok) {\n                    throw new Error(data.message || 'Erro ao gerar novo QR Code');\n                }\n\n                if (data.qrcode && data.qrcode.base64) {\n                    // Update QR Code\n                    qrImage.src = data.qrcode.base64;\n                    startTimer();\n                    startConnectionCheck();\n                    showStatus('Novo QR Code gerado! Escaneie com seu WhatsApp.');\n                } else {\n                    throw new Error('QR Code não foi retornado pela API');\n                }\n\n            } catch (err) {\n                console.error('Erro:', err);\n                showError(err.message || 'Erro ao gerar novo QR Code');\n            } finally {\n                loading.classList.remove('show');\n                refreshBtn.disabled = false;\n            }\n        }\n\n        // Event listeners\n        generateBtn.addEventListener('click', function(e) {\n            e.preventDefault();\n            console.log('Botão clicado');\n            generateQRCode();\n        });\n\n        refreshBtn.addEventListener('click', function(e) {\n            e.preventDefault();\n            console.log('Botão refresh clicado');\n            refreshQRCode();\n        });\n\n        instanceNameInput.addEventListener('keypress', function(e) {\n            if (e.key === 'Enter') {\n                e.preventDefault();\n                generateQRCode();\n            }\n        });\n\n        // Verificar autenticação ao carregar a página\n        checkAuth();\n        \n        // Auto focus no input\n        instanceNameInput.focus();\n        \n        console.log('Script carregado com sucesso');\n\n        // Função de logout\n        function logout() {\n            console.log('🚪 Iniciando logout...');\n            \n            // Limpar todos os cookies\n            document.cookie = 'userId=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';\n            document.cookie = 'idLista=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';\n            document.cookie = 'idConexao=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';\n            document.cookie = 'idDisparo=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';\n            \n            // Limpar sessionStorage\n            sessionStorage.clear();\n            \n            console.log('🧹 Cookies e sessionStorage limpos');\n            console.log('🔄 Redirecionando para login...');\n            \n            // Redirecionar para página de login\n            window.location.href = 'https://n8n.typebot.pro/webhook/login';\n        }\n    </script>\n</body>\n</html>"},"type":"n8n-nodes-base.html","typeVersion":1.2,"position":[-4208,-7104],"id":"b2287861-6ea6-4848-bb75-18d52fc4fdac","name":"HTML"},{"parameters":{"respondWith":"text","responseBody":"={{ $json.html }}","options":{}},"type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-4000,-7104],"id":"1f0bfaf8-67d7-4689-a25d-3db72d674ee3","name":"Respond to Webhook1"},{"parameters":{"path":"disparos-individuais","responseMode":"responseNode","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-4448,-6816],"id":"3a6815b9-a7bc-4f11-931d-0333ccb255ec","name":"Webhook","webhookId":"bffe6be0-84a5-4250-8695-636b89e17afd"},{"parameters":{"html":"<!DOCTYPE html>\n<html lang=\"pt-BR\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>Disparos de Mensagens</title>\n    <style>\n        * {\n            margin: 0;\n            padding: 0;\n            box-sizing: border-box;\n        }\n\n        body {\n            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);\n            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n            color: white;\n            min-height: 100vh;\n            margin: 0;\n            padding: 0;\n        }\n\n        .app-layout {\n            display: flex;\n            min-height: 100vh;\n        }\n\n        /* Sidebar */\n        .sidebar {\n            width: 70px;\n            background: rgba(0, 0, 0, 0.3);\n            backdrop-filter: blur(10px);\n            border-right: 1px solid rgba(255, 255, 255, 0.1);\n            transition: all 0.3s ease;\n            position: relative;\n            z-index: 1000;\n            display: flex;\n            flex-direction: column;\n            height: 100vh;\n        }\n\n        .sidebar:hover {\n            width: 250px;\n        }\n\n        .sidebar-header {\n            padding: 20px;\n            text-align: center;\n            border-bottom: 1px solid rgba(255, 255, 255, 0.1);\n        }\n\n        .sidebar-logo {\n            font-size: 1.5rem;\n            font-weight: 600;\n            background: linear-gradient(135deg, #25d366 0%, #128c7e 100%);\n            -webkit-background-clip: text;\n            -webkit-text-fill-color: transparent;\n            background-clip: text;\n            white-space: nowrap;\n            opacity: 0;\n            transition: opacity 0.3s ease;\n        }\n\n        .sidebar:hover .sidebar-logo {\n            opacity: 1;\n        }\n\n        .sidebar-menu {\n            padding: 20px 0;\n            flex: 1;\n        }\n\n        .menu-item {\n            display: flex;\n            align-items: center;\n            padding: 15px 20px;\n            color: #ccc;\n            text-decoration: none;\n            transition: all 0.3s ease;\n            position: relative;\n            white-space: nowrap;\n        }\n\n        .menu-item:hover {\n            background: rgba(37, 211, 102, 0.1);\n            color: #25d366;\n        }\n\n        .menu-item.active {\n            background: rgba(37, 211, 102, 0.2);\n            color: #25d366;\n            border-right: 3px solid #25d366;\n        }\n\n        .menu-icon {\n            font-size: 1.2rem;\n            width: 30px;\n            text-align: center;\n            flex-shrink: 0;\n        }\n\n        .menu-text {\n            margin-left: 15px;\n            opacity: 0;\n            transition: opacity 0.3s ease;\n        }\n\n        .sidebar:hover .menu-text {\n            opacity: 1;\n        }\n\n        .sidebar-footer {\n            margin-top: auto;\n            border-top: 1px solid rgba(255, 255, 255, 0.1);\n            padding: 10px 0;\n        }\n\n        .logout-item {\n            color: #ff6b6b !important;\n        }\n\n        .logout-item:hover {\n            background: rgba(255, 107, 107, 0.1) !important;\n            color: #ff6b6b !important;\n        }\n\n        /* Main content */\n        .main-content-wrapper {\n            flex: 1;\n            padding: 20px;\n            overflow-x: auto;\n        }\n\n        .container {\n            max-width: 1400px;\n            margin: 0 auto;\n        }\n\n        .header {\n            margin-bottom: 40px;\n        }\n\n        .header-info h1 {\n            font-size: 2.5rem;\n            font-weight: 600;\n            margin-bottom: 10px;\n            color: white;\n        }\n\n        .header-info p {\n            color: #888;\n            font-size: 1.1rem;\n        }\n\n        .main-content {\n            display: grid;\n            grid-template-columns: 1fr 400px;\n            gap: 40px;\n        }\n\n        .form-container {\n            background: rgba(255, 255, 255, 0.02);\n            border: 1px solid rgba(255, 255, 255, 0.1);\n            border-radius: 16px;\n            padding: 40px;\n            backdrop-filter: blur(10px);\n        }\n\n        .form-grid {\n            display: grid;\n            grid-template-columns: 1fr 1fr;\n            gap: 30px;\n            margin-bottom: 30px;\n        }\n\n        .form-group {\n            display: flex;\n            flex-direction: column;\n        }\n\n        .form-group.full-width {\n            grid-column: 1 / -1;\n        }\n\n        .form-group label {\n            color: #fff;\n            font-weight: 500;\n            margin-bottom: 8px;\n            font-size: 0.95rem;\n        }\n\n        .form-group input,\n        .form-group textarea {\n            background: rgba(255, 255, 255, 0.05);\n            border: 1px solid rgba(255, 255, 255, 0.2);\n            border-radius: 8px;\n            padding: 12px 15px;\n            color: white;\n            font-size: 1rem;\n            outline: none;\n            transition: all 0.3s ease;\n        }\n\n        .form-group input:focus,\n        .form-group textarea:focus {\n            border-color: #25d366;\n            box-shadow: 0 0 0 2px rgba(37, 211, 102, 0.2);\n        }\n\n        .form-group input::placeholder,\n        .form-group textarea::placeholder {\n            color: #888;\n        }\n\n        .form-group textarea {\n            resize: vertical;\n            min-height: 100px;\n        }\n\n        .messages-section {\n            margin-bottom: 30px;\n        }\n\n        .message-item {\n            background: rgba(255, 255, 255, 0.02);\n            border: 1px solid rgba(255, 255, 255, 0.1);\n            border-radius: 12px;\n            padding: 20px;\n            margin-bottom: 15px;\n        }\n\n        .message-header {\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            margin-bottom: 15px;\n        }\n\n        .message-title {\n            color: #25d366;\n            font-size: 0.9rem;\n            font-weight: 600;\n        }\n\n        .remove-message {\n            background: rgba(255, 59, 48, 0.1);\n            border: 1px solid rgba(255, 59, 48, 0.3);\n            color: #ff3b30;\n            padding: 5px 10px;\n            border-radius: 6px;\n            cursor: pointer;\n            font-size: 0.8rem;\n            transition: all 0.3s ease;\n        }\n\n        .remove-message:hover {\n            background: rgba(255, 59, 48, 0.2);\n        }\n\n        .media-upload {\n            display: grid;\n            grid-template-columns: repeat(4, 1fr);\n            gap: 10px;\n            margin-top: 15px;\n        }\n\n        .media-preview-section {\n            margin-top: 15px;\n        }\n\n        .media-selected {\n            background: rgba(37, 211, 102, 0.1);\n            border: 1px solid rgba(37, 211, 102, 0.3);\n            border-radius: 8px;\n            padding: 12px;\n            display: flex;\n            align-items: center;\n            justify-content: space-between;\n        }\n\n        .media-info-display {\n            display: flex;\n            align-items: center;\n            gap: 10px;\n        }\n\n        .media-icon-display {\n            font-size: 1.2rem;\n        }\n\n        .media-name-display {\n            color: #fff;\n            font-weight: 500;\n        }\n\n        .media-size-display {\n            color: #888;\n            font-size: 0.9rem;\n        }\n\n        .remove-media-btn {\n            background: rgba(255, 59, 48, 0.1);\n            border: 1px solid rgba(255, 59, 48, 0.3);\n            color: #ff3b30;\n            padding: 5px 8px;\n            border-radius: 4px;\n            cursor: pointer;\n            font-size: 0.9rem;\n            transition: all 0.3s ease;\n        }\n\n        .remove-media-btn:hover {\n            background: rgba(255, 59, 48, 0.2);\n        }\n\n        .media-btn {\n            background: rgba(255, 255, 255, 0.05);\n            border: 1px solid rgba(255, 255, 255, 0.2);\n            border-radius: 8px;\n            padding: 12px 8px;\n            color: white;\n            cursor: pointer;\n            text-align: center;\n            font-size: 0.8rem;\n            transition: all 0.3s ease;\n            position: relative;\n        }\n\n        .media-btn:hover {\n            background: rgba(37, 211, 102, 0.1);\n            border-color: #25d366;\n        }\n\n        .media-btn input[type=\"file\"] {\n            position: absolute;\n            opacity: 0;\n            width: 100%;\n            height: 100%;\n            cursor: pointer;\n        }\n\n        .media-btn.active {\n            background: rgba(37, 211, 102, 0.2);\n            border-color: #25d366;\n            color: #25d366;\n        }\n\n        .file-size-limit {\n            font-size: 0.7rem;\n            color: #888;\n            margin-top: 4px;\n            font-weight: 400;\n        }\n\n        .add-message-btn {\n            width: 100%;\n            padding: 15px;\n            background: rgba(37, 211, 102, 0.1);\n            border: 2px dashed rgba(37, 211, 102, 0.3);\n            border-radius: 8px;\n            color: #25d366;\n            font-size: 1rem;\n            cursor: pointer;\n            transition: all 0.3s ease;\n            margin-bottom: 20px;\n        }\n\n        .add-message-btn:hover {\n            background: rgba(37, 211, 102, 0.2);\n            border-color: #25d366;\n        }\n\n        .time-range {\n            display: flex;\n            gap: 20px;\n            align-items: center;\n        }\n\n        .time-input {\n            flex: 0 0 auto;\n        }\n\n        .time-separator {\n            color: #888;\n            font-weight: 500;\n            font-size: 0.9rem;\n            padding: 0 5px;\n        }\n\n        .file-upload {\n            position: relative;\n            display: flex;\n            flex-direction: column;\n            align-items: center;\n            padding: 30px;\n            border: 2px dashed rgba(255, 255, 255, 0.3);\n            border-radius: 12px;\n            background: rgba(255, 255, 255, 0.02);\n            transition: all 0.3s ease;\n            cursor: pointer;\n        }\n\n        .file-upload:hover {\n            border-color: #25d366;\n            background: rgba(37, 211, 102, 0.05);\n        }\n\n        .file-upload.dragover {\n            border-color: #25d366;\n            background: rgba(37, 211, 102, 0.1);\n        }\n\n        .file-upload input[type=\"file\"] {\n            position: absolute;\n            opacity: 0;\n            width: 100%;\n            height: 100%;\n            cursor: pointer;\n        }\n\n        .file-upload-content {\n            text-align: center;\n            pointer-events: none;\n        }\n\n        .file-upload-icon {\n            font-size: 3rem;\n            color: #25d366;\n            margin-bottom: 15px;\n        }\n\n        .file-upload-text {\n            color: #fff;\n            font-size: 1.1rem;\n            margin-bottom: 5px;\n        }\n\n        .file-upload-hint {\n            color: #888;\n            font-size: 0.9rem;\n        }\n\n        .file-info {\n            display: none;\n            background: rgba(37, 211, 102, 0.1);\n            border: 1px solid rgba(37, 211, 102, 0.3);\n            border-radius: 8px;\n            padding: 15px;\n            margin-top: 15px;\n        }\n\n        .file-info.show {\n            display: block;\n        }\n\n        .file-info-content {\n            display: flex;\n            align-items: center;\n            justify-content: space-between;\n        }\n\n        .file-details {\n            display: flex;\n            align-items: center;\n            gap: 10px;\n        }\n\n        .file-icon {\n            color: #25d366;\n            font-size: 1.2rem;\n        }\n\n        .file-name {\n            color: #fff;\n            font-weight: 500;\n        }\n\n        .contact-count {\n            color: #25d366;\n            font-size: 0.9rem;\n        }\n\n        .remove-file {\n            background: none;\n            border: none;\n            color: #ff3b30;\n            cursor: pointer;\n            font-size: 1.2rem;\n            padding: 5px;\n            border-radius: 4px;\n            transition: all 0.3s ease;\n        }\n\n        .remove-file:hover {\n            background: rgba(255, 59, 48, 0.1);\n        }\n\n        .dispatch-btn {\n            width: 100%;\n            padding: 18px;\n            background: linear-gradient(135deg, #25d366 0%, #128c7e 100%);\n            border: none;\n            border-radius: 12px;\n            color: white;\n            font-size: 1.1rem;\n            font-weight: 600;\n            cursor: pointer;\n            transition: all 0.3s ease;\n            margin-top: 20px;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            gap: 10px;\n        }\n\n        .dispatch-btn:hover {\n            transform: translateY(-2px);\n            box-shadow: 0 12px 30px rgba(37, 211, 102, 0.4);\n        }\n\n        .dispatch-btn:disabled {\n            background: #444;\n            cursor: not-allowed;\n            transform: none;\n            box-shadow: none;\n        }\n\n\n\n        .loading-connections {\n            text-align: center;\n            padding: 40px 20px;\n            color: #888;\n        }\n\n        .loading-spinner-large {\n            width: 40px;\n            height: 40px;\n            border: 3px solid rgba(37, 211, 102, 0.3);\n            border-top: 3px solid #25d366;\n            border-radius: 50%;\n            animation: spin 1s linear infinite;\n            margin: 0 auto 15px;\n        }\n\n        .connections-section {\n            margin-bottom: 30px;\n        }\n\n        .connections-grid {\n            display: grid;\n            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));\n            gap: 15px;\n            margin-top: 15px;\n        }\n\n        .loading-connections {\n            text-align: center;\n            padding: 40px 20px;\n            color: #888;\n        }\n\n        .loading-spinner-large {\n            width: 40px;\n            height: 40px;\n            border: 3px solid rgba(37, 211, 102, 0.3);\n            border-top: 3px solid #25d366;\n            border-radius: 50%;\n            animation: spin 1s linear infinite;\n            margin: 0 auto 15px;\n        }\n\n        .connections-section {\n            margin-bottom: 30px;\n        }\n\n        .connections-grid {\n            display: grid;\n            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));\n            gap: 12px;\n            margin-top: 15px;\n            max-height: 180px; /* Altura para 3 linhas (3 x 50px + 2 x 12px gap) */\n            overflow-y: auto;\n            padding-right: 5px;\n        }\n\n        /* Estilização da scrollbar */\n        .connections-grid::-webkit-scrollbar {\n            width: 6px;\n        }\n\n        .connections-grid::-webkit-scrollbar-track {\n            background: rgba(0, 0, 0, 0.05);\n            border-radius: 3px;\n        }\n\n        .connections-grid::-webkit-scrollbar-thumb {\n            background: rgba(0, 0, 0, 0.2);\n            border-radius: 3px;\n        }\n\n        .connections-grid::-webkit-scrollbar-thumb:hover {\n            background: rgba(0, 0, 0, 0.3);\n        }\n\n        .connection-card {\n            background: rgba(255, 255, 255, 0.03);\n            border: 1px solid rgba(255, 255, 255, 0.1);\n            border-radius: 8px;\n            padding: 16px;\n            cursor: pointer;\n            transition: all 0.3s ease;\n            position: relative;\n            min-height: 80px;\n        }\n\n        .connection-card:hover {\n            border-color: rgba(37, 211, 102, 0.4);\n            background: rgba(37, 211, 102, 0.05);\n            transform: translateY(-1px);\n        }\n\n        .connection-card.selected {\n            border-color: #25d366;\n            background: rgba(37, 211, 102, 0.1);\n            box-shadow: 0 0 0 1px rgba(37, 211, 102, 0.2);\n        }\n\n        .connection-card.selected::before {\n            content: '✓';\n            position: absolute;\n            top: 8px;\n            right: 8px;\n            background: #25d366;\n            color: white;\n            width: 18px;\n            height: 18px;\n            border-radius: 50%;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            font-size: 0.7rem;\n            font-weight: bold;\n        }\n\n        .connection-header {\n            display: flex;\n            align-items: center;\n            gap: 12px;\n            position: relative;\n            padding-right: 30px;\n        }\n\n        .connection-avatar {\n            width: 36px;\n            height: 36px;\n            border-radius: 50%;\n            background: #25d366;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            color: white;\n            font-weight: bold;\n            font-size: 1rem;\n            flex-shrink: 0;\n        }\n\n        .connection-avatar img {\n            width: 100%;\n            height: 100%;\n            border-radius: 50%;\n            object-fit: cover;\n        }\n\n        .connection-info {\n            flex: 1;\n            min-width: 0;\n        }\n\n        .connection-name {\n            color: #fff;\n            font-size: 0.95rem;\n            font-weight: 600;\n            margin-bottom: 4px;\n            line-height: 1.2;\n            overflow: hidden;\n            text-overflow: ellipsis;\n            white-space: nowrap;\n        }\n\n        .connection-phone {\n            color: #888;\n            font-size: 0.8rem;\n            font-weight: 400;\n            overflow: hidden;\n            text-overflow: ellipsis;\n            white-space: nowrap;\n        }\n\n        .connection-status-pill {\n            position: absolute;\n            top: 8px;\n            right: 8px;\n            padding: 2px 8px;\n            border-radius: 10px;\n            font-size: 0.65rem;\n            font-weight: 600;\n            text-transform: uppercase;\n            letter-spacing: 0.3px;\n            line-height: 1;\n        }\n\n        .connection-status-pill.connected {\n            background: rgba(52, 199, 89, 0.15);\n            color: #34c759;\n            border: 1px solid rgba(52, 199, 89, 0.3);\n        }\n\n        .connection-status-pill.disconnected {\n            background: rgba(255, 59, 48, 0.15);\n            color: #ff3b30;\n            border: 1px solid rgba(255, 59, 48, 0.3);\n        }\n\n        .connections-header {\n            display: flex;\n            align-items: center;\n            justify-content: space-between;\n            margin-bottom: 6px;\n        }\n\n        .connections-header-buttons {\n            display: flex;\n            align-items: center;\n            gap: 8px;\n        }\n\n        .select-active-btn {\n            background: rgba(52, 199, 89, 0.1);\n            border: 1px solid rgba(52, 199, 89, 0.3);\n            color: #34c759;\n            padding: 4px 8px;\n            border-radius: 4px;\n            cursor: pointer;\n            font-size: 0.75rem;\n            font-weight: 500;\n            transition: all 0.3s ease;\n        }\n\n        .select-active-btn:hover {\n            background: rgba(52, 199, 89, 0.2);\n            transform: translateY(-1px);\n        }\n\n        .select-active-btn:active {\n            transform: translateY(0);\n        }\n\n        .refresh-connections-btn-small {\n            background: rgba(37, 211, 102, 0.1);\n            border: 1px solid rgba(37, 211, 102, 0.2);\n            color: #25d366;\n            padding: 4px 8px;\n            border-radius: 4px;\n            cursor: pointer;\n            font-size: 0.75rem;\n            transition: all 0.3s ease;\n        }\n\n        .refresh-connections-btn-small:hover {\n            background: rgba(37, 211, 102, 0.2);\n            transform: rotate(180deg);\n        }\n\n        .connections-selected {\n            background: rgba(37, 211, 102, 0.08);\n            border: 1px solid rgba(37, 211, 102, 0.2);\n            border-radius: 6px;\n            padding: 12px;\n            margin-top: 12px;\n            display: none;\n            font-size: 0.9rem;\n        }\n\n        .connections-selected.show {\n            display: block;\n        }\n\n        .no-connections {\n            text-align: center;\n            padding: 40px 20px;\n            color: #888;\n            border: 2px dashed rgba(255, 255, 255, 0.2);\n            border-radius: 12px;\n        }\n\n        .refresh-connections-btn {\n            background: rgba(37, 211, 102, 0.1);\n            border: 1px solid rgba(37, 211, 102, 0.3);\n            color: #25d366;\n            padding: 8px 12px;\n            border-radius: 6px;\n            cursor: pointer;\n            font-size: 0.9rem;\n            margin-left: 10px;\n            transition: all 0.3s ease;\n        }\n\n        .refresh-connections-btn:hover {\n            background: rgba(37, 211, 102, 0.2);\n            transform: rotate(180deg);\n        }\n\n        .refresh-connections-btn:disabled {\n            opacity: 0.5;\n            cursor: not-allowed;\n            transform: none;\n        }\n\n        /* Lists Section Styles */\n        .lists-section {\n            margin-bottom: 30px;\n        }\n\n        .lists-header {\n            display: flex;\n            align-items: center;\n            justify-content: space-between;\n            margin-bottom: 6px;\n        }\n\n        .refresh-lists-btn-small {\n            background: rgba(37, 211, 102, 0.1);\n            border: 1px solid rgba(37, 211, 102, 0.2);\n            color: #25d366;\n            padding: 4px 8px;\n            border-radius: 4px;\n            cursor: pointer;\n            font-size: 0.75rem;\n            transition: all 0.3s ease;\n        }\n\n        .refresh-lists-btn-small:hover {\n            background: rgba(37, 211, 102, 0.2);\n            transform: rotate(180deg);\n        }\n\n        .loading-lists {\n            text-align: center;\n            padding: 40px 20px;\n            color: #888;\n        }\n\n        .lists-grid {\n            display: grid;\n            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));\n            gap: 12px;\n            margin-top: 15px;\n            max-height: 180px; /* Altura para 3 linhas (3 x 50px + 2 x 12px gap) */\n            overflow-y: auto;\n            padding-right: 5px;\n        }\n\n        /* Estilização da scrollbar para listas */\n        .lists-grid::-webkit-scrollbar {\n            width: 6px;\n        }\n\n        .lists-grid::-webkit-scrollbar-track {\n            background: rgba(0, 0, 0, 0.05);\n            border-radius: 3px;\n        }\n\n        .lists-grid::-webkit-scrollbar-thumb {\n            background: rgba(0, 0, 0, 0.2);\n            border-radius: 3px;\n        }\n\n        .lists-grid::-webkit-scrollbar-thumb:hover {\n            background: rgba(0, 0, 0, 0.3);\n        }\n\n        .list-card {\n            background: rgba(255, 255, 255, 0.03);\n            border: 1px solid rgba(255, 255, 255, 0.1);\n            border-radius: 8px;\n            padding: 16px;\n            cursor: pointer;\n            transition: all 0.3s ease;\n            position: relative;\n            min-height: 60px;\n        }\n\n        .list-card:hover {\n            border-color: rgba(37, 211, 102, 0.4);\n            background: rgba(37, 211, 102, 0.05);\n            transform: translateY(-1px);\n        }\n\n        .list-card.selected {\n            border-color: #25d366;\n            background: rgba(37, 211, 102, 0.1);\n            box-shadow: 0 0 0 1px rgba(37, 211, 102, 0.2);\n        }\n\n        .list-card.selected::before {\n            content: '✓';\n            position: absolute;\n            top: 8px;\n            right: 8px;\n            background: #25d366;\n            color: white;\n            width: 18px;\n            height: 18px;\n            border-radius: 50%;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            font-size: 0.7rem;\n            font-weight: bold;\n        }\n\n        .list-info {\n            display: flex;\n            align-items: center;\n            gap: 12px;\n        }\n\n        .list-icon {\n            width: 36px;\n            height: 36px;\n            border-radius: 50%;\n            background: #25d366;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            color: white;\n            font-weight: bold;\n            font-size: 1rem;\n            flex-shrink: 0;\n        }\n\n        .list-name {\n            color: #fff;\n            font-size: 0.95rem;\n            font-weight: 600;\n            line-height: 1.2;\n            overflow: hidden;\n            text-overflow: ellipsis;\n            white-space: nowrap;\n        }\n\n        .lists-selected {\n            background: rgba(37, 211, 102, 0.08);\n            border: 1px solid rgba(37, 211, 102, 0.2);\n            border-radius: 6px;\n            padding: 12px;\n            margin-top: 12px;\n            display: none;\n            font-size: 0.9rem;\n        }\n\n        .lists-selected.show {\n            display: block;\n        }\n\n        .no-lists {\n            text-align: center;\n            padding: 40px 20px;\n            color: #888;\n            border: 2px dashed rgba(255, 255, 255, 0.2);\n            border-radius: 12px;\n        }\n\n        /* Variables Section Styles */\n        .variables-section {\n            margin-bottom: 10px;\n        }\n\n        .variables-label {\n            color: #888;\n            font-size: 0.85rem;\n            font-weight: 500;\n            margin-bottom: 6px;\n        }\n\n        .variables-container {\n            display: flex;\n            flex-wrap: wrap;\n            gap: 8px;\n            margin-bottom: 8px;\n        }\n\n        .variable-btn {\n            background: rgba(37, 211, 102, 0.1);\n            border: 1px solid rgba(37, 211, 102, 0.3);\n            color: #25d366;\n            padding: 4px 10px;\n            border-radius: 20px;\n            cursor: pointer;\n            font-size: 0.8rem;\n            font-weight: 500;\n            transition: all 0.3s ease;\n            user-select: none;\n            display: flex;\n            align-items: center;\n            gap: 4px;\n        }\n\n        .variable-btn:hover {\n            background: rgba(37, 211, 102, 0.2);\n            border-color: #25d366;\n            transform: translateY(-1px);\n        }\n\n        .variable-btn:active {\n            transform: translateY(0);\n        }\n\n        .no-variables {\n            color: #666;\n            font-size: 0.85rem;\n            font-style: italic;\n        }\n\n        /* Advanced Settings Styles */\n        .advanced-settings-section {\n            margin: 20px 0 15px 0;\n            padding: 20px;\n            background: rgba(255, 255, 255, 0.02);\n            border: 1px solid rgba(255, 255, 255, 0.1);\n            border-radius: 12px;\n        }\n\n        .advanced-settings-label {\n            color: #888;\n            font-size: 0.85rem;\n            font-weight: 600;\n            margin-bottom: 12px;\n            display: flex;\n            align-items: center;\n            gap: 6px;\n        }\n\n        .advanced-settings-container {\n            display: flex;\n            flex-direction: column;\n            gap: 12px;\n        }\n\n        .setting-item {\n            display: flex;\n            align-items: center;\n            justify-content: space-between;\n            padding: 8px 0;\n        }\n\n        .setting-info {\n            flex: 1;\n            margin-right: 15px;\n        }\n\n        .setting-title {\n            color: #fff;\n            font-size: 0.9rem;\n            font-weight: 500;\n            margin-bottom: 2px;\n            display: flex;\n            align-items: center;\n            gap: 8px;\n        }\n\n        .chatgpt-icon {\n            width: 16px;\n            height: 16px;\n            color: #10a37f;\n            flex-shrink: 0;\n        }\n\n        /* AI Settings Styles */\n        .ai-settings-container {\n            margin-top: 15px;\n            padding: 15px;\n            background: rgba(16, 163, 127, 0.05);\n            border: 1px solid rgba(16, 163, 127, 0.2);\n            border-radius: 8px;\n            animation: fadeIn 0.3s ease;\n        }\n\n        .ai-settings-content {\n            display: flex;\n            flex-direction: column;\n            gap: 15px;\n        }\n\n        .ai-input-group {\n            display: flex;\n            flex-direction: column;\n            gap: 6px;\n        }\n\n        .ai-input-group label {\n            color: #fff;\n            font-size: 0.85rem;\n            font-weight: 500;\n        }\n\n        .ai-input {\n            background: rgba(255, 255, 255, 0.05);\n            border: 1px solid rgba(255, 255, 255, 0.1);\n            border-radius: 6px;\n            padding: 8px 12px;\n            color: #fff;\n            font-size: 0.9rem;\n            transition: all 0.3s ease;\n        }\n\n        .ai-input:focus {\n            outline: none;\n            border-color: #10a37f;\n            background: rgba(255, 255, 255, 0.08);\n        }\n\n        .ai-textarea {\n            background: rgba(255, 255, 255, 0.05);\n            border: 1px solid rgba(255, 255, 255, 0.1);\n            border-radius: 6px;\n            padding: 10px 12px;\n            color: #fff;\n            font-size: 0.9rem;\n            min-height: 80px;\n            resize: vertical;\n            font-family: inherit;\n            transition: all 0.3s ease;\n        }\n\n        .ai-textarea:focus {\n            outline: none;\n            border-color: #10a37f;\n            background: rgba(255, 255, 255, 0.08);\n        }\n\n        .ai-textarea::placeholder {\n            color: #888;\n        }\n\n        .ai-note {\n            display: flex;\n            align-items: flex-start;\n            gap: 8px;\n            padding: 10px;\n            background: rgba(16, 163, 127, 0.1);\n            border: 1px solid rgba(16, 163, 127, 0.2);\n            border-radius: 6px;\n            color: #10a37f;\n            font-size: 0.8rem;\n            line-height: 1.4;\n        }\n\n        .info-icon {\n            width: 14px;\n            height: 14px;\n            color: #10a37f;\n            flex-shrink: 0;\n            margin-top: 1px;\n        }\n\n        .generate-ai-btn {\n            background: linear-gradient(135deg, #10a37f 0%, #0d8a6b 100%);\n            border: 1px solid #10a37f;\n            border-radius: 8px;\n            padding: 12px 20px;\n            color: #fff;\n            font-size: 0.9rem;\n            font-weight: 600;\n            cursor: pointer;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            gap: 8px;\n            transition: all 0.3s ease;\n            width: 100%;\n            margin-top: 5px;\n        }\n\n        .generate-ai-btn:hover {\n            background: linear-gradient(135deg, #0d8a6b 0%, #0a6b52 100%);\n            border-color: #0d8a6b;\n            transform: translateY(-1px);\n            box-shadow: 0 4px 12px rgba(16, 163, 127, 0.3);\n        }\n\n        .generate-ai-btn:active {\n            transform: translateY(0);\n        }\n\n        .chatgpt-btn-icon {\n            width: 16px;\n            height: 16px;\n            color: #fff;\n            flex-shrink: 0;\n        }\n\n        @keyframes fadeIn {\n            from {\n                opacity: 0;\n                transform: translateY(-10px);\n            }\n            to {\n                opacity: 1;\n                transform: translateY(0);\n            }\n        }\n\n        .setting-description {\n            color: #888;\n            font-size: 0.8rem;\n            line-height: 1.3;\n        }\n\n        /* Toggle Switch Styles */\n        .toggle-switch {\n            position: relative;\n            display: inline-block;\n            width: 44px;\n            height: 24px;\n            flex-shrink: 0;\n        }\n\n        .toggle-switch input {\n            opacity: 0;\n            width: 0;\n            height: 0;\n        }\n\n        .toggle-slider {\n            position: absolute;\n            cursor: pointer;\n            top: 0;\n            left: 0;\n            right: 0;\n            bottom: 0;\n            background-color: rgba(255, 255, 255, 0.1);\n            transition: 0.3s;\n            border-radius: 24px;\n            border: 1px solid rgba(255, 255, 255, 0.2);\n        }\n\n        .toggle-slider:before {\n            position: absolute;\n            content: \"\";\n            height: 18px;\n            width: 18px;\n            left: 2px;\n            bottom: 2px;\n            background-color: #888;\n            transition: 0.3s;\n            border-radius: 50%;\n        }\n\n        .toggle-switch input:checked + .toggle-slider {\n            background-color: rgba(37, 211, 102, 0.3);\n            border-color: #25d366;\n        }\n\n        .toggle-switch input:checked + .toggle-slider:before {\n            transform: translateX(20px);\n            background-color: #25d366;\n        }\n\n        .toggle-switch:hover .toggle-slider {\n            border-color: rgba(37, 211, 102, 0.4);\n        }\n\n\n\n        /* Missed Call Indicator Styles */\n        .missed-call-indicator {\n            background: #808080;\n            border: 1px solid #666;\n            border-radius: 8px;\n            padding: 8px 12px;\n            margin: 8px 0;\n            display: flex;\n            align-items: center;\n            justify-content: flex-end;\n            animation: fadeInUp 0.3s ease;\n            width: auto;\n            max-width: 200px;\n            margin-left: auto;\n            margin-right: 0;\n            transition: all 0.3s ease;\n        }\n\n        .missed-call-content {\n            display: flex;\n            align-items: center;\n            gap: 8px;\n            color: #fff;\n        }\n\n        .missed-call-icon {\n            width: 16px;\n            height: 16px;\n            color: #fff;\n            flex-shrink: 0;\n        }\n\n        .missed-call-info {\n            text-align: center;\n        }\n\n        .missed-call-title {\n            font-size: 0.85rem;\n            font-weight: 500;\n            color: #fff;\n        }\n\n        @keyframes fadeInUp {\n            from {\n                opacity: 0;\n                transform: translateY(10px);\n            }\n            to {\n                opacity: 1;\n                transform: translateY(0);\n            }\n        }\n\n        /* Estilos para variáveis de tempo expansíveis */\n        .time-variables-container {\n            position: relative;\n            display: inline-block;\n        }\n\n        .time-toggle-btn {\n            background: rgba(37, 211, 102, 0.15) !important;\n            border-color: rgba(37, 211, 102, 0.4) !important;\n            color: #25d366 !important;\n            font-weight: 600;\n        }\n\n        .time-toggle-btn:hover {\n            background: rgba(37, 211, 102, 0.25) !important;\n            border-color: #25d366 !important;\n        }\n\n        .time-toggle-btn.expanded svg:last-child {\n            transform: rotate(180deg);\n        }\n\n        .time-variables-dropdown {\n            position: absolute;\n            top: 100%;\n            left: 0;\n            background: rgba(0, 0, 0, 0.95);\n            border: 1px solid rgba(37, 211, 102, 0.3);\n            border-radius: 8px;\n            padding: 8px;\n            margin-top: 4px;\n            z-index: 1000;\n            min-width: 200px;\n            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);\n            backdrop-filter: blur(10px);\n        }\n\n        .time-var-btn {\n            display: block;\n            width: 100%;\n            text-align: left;\n            margin-bottom: 4px;\n            padding: 8px 12px;\n            border-radius: 6px;\n            background: rgba(255, 255, 255, 0.05);\n            border: 1px solid rgba(255, 255, 255, 0.1);\n            color: #fff;\n            font-size: 0.85rem;\n            transition: all 0.2s ease;\n        }\n\n        .time-var-btn:hover {\n            background: rgba(37, 211, 102, 0.15);\n            border-color: rgba(37, 211, 102, 0.3);\n            color: #25d366;\n        }\n\n        .time-var-btn:last-child {\n            margin-bottom: 0;\n        }\n\n        /* Estilo para variáveis no textarea */\n        .form-group textarea {\n            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;\n            font-size: 0.85rem;\n        }\n\n        /* Botões de formatação */\n        .formatting-buttons {\n            display: flex;\n            gap: 8px;\n            margin-bottom: 10px;\n        }\n\n        .format-btn {\n            background: rgba(255, 255, 255, 0.05);\n            border: 1px solid rgba(255, 255, 255, 0.2);\n            color: #ccc;\n            padding: 8px 12px;\n            border-radius: 6px;\n            cursor: pointer;\n            font-size: 0.9rem;\n            font-weight: 600;\n            transition: all 0.3s ease;\n            min-width: 40px;\n            text-align: center;\n        }\n\n        .format-btn:hover {\n            background: rgba(37, 211, 102, 0.1);\n            border-color: #25d366;\n            color: #25d366;\n        }\n\n        .format-btn:active {\n            transform: translateY(1px);\n        }\n\n        .format-btn strong {\n            font-weight: 700;\n        }\n\n        .format-btn em {\n            font-style: italic;\n        }\n\n        .multiple-lists-warning {\n            background: rgba(255, 193, 7, 0.1);\n            border: 1px solid rgba(255, 193, 7, 0.3);\n            border-radius: 6px;\n            padding: 10px 12px;\n            margin-top: 10px;\n            font-size: 0.8rem;\n            color: #ffc107;\n            display: none;\n        }\n\n        .multiple-lists-warning.show {\n            display: block;\n        }\n\n        .multiple-lists-warning::before {\n            content: '⚠️ ';\n            margin-right: 5px;\n        }\n\n        .dispatch-btn.loading .loading-spinner {\n            display: block;\n        }\n\n        .success-message,\n        .error-message {\n            padding: 15px 20px;\n            border-radius: 8px;\n            margin: 20px 0;\n            display: none;\n        }\n\n        .success-message {\n            background: rgba(52, 199, 89, 0.1);\n            border: 1px solid rgba(52, 199, 89, 0.3);\n            color: #34c759;\n        }\n\n        .error-message {\n            background: rgba(255, 59, 48, 0.1);\n            border: 1px solid rgba(255, 59, 48, 0.3);\n            color: #ff3b30;\n        }\n\n        .success-message.show,\n        .error-message.show {\n            display: block;\n        }\n\n        .warning-messages ul {\n            margin: 0;\n            padding-left: 20px;\n        }\n\n        .warning-messages li {\n            margin-bottom: 5px;\n            font-size: 0.9rem;\n        }\n\n        .warning-messages li:last-child {\n            margin-bottom: 0;\n        }\n\n        .stats {\n            display: grid;\n            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));\n            gap: 20px;\n            margin-top: 30px;\n        }\n\n        .stat-card {\n            background: rgba(255, 255, 255, 0.02);\n            border: 1px solid rgba(255, 255, 255, 0.1);\n            border-radius: 12px;\n            padding: 20px;\n            text-align: center;\n        }\n\n        .stat-value {\n            font-size: 1.5rem;\n            font-weight: 600;\n            color: #25d366;\n            margin-bottom: 5px;\n        }\n\n        .stat-label {\n            color: #888;\n            font-size: 0.8rem;\n        }\n\n        /* Phone Preview */\n        .phone-preview {\n            position: sticky;\n            top: 20px;\n        }\n\n        .phone-container {\n            width: 350px;\n            height: 700px;\n            background: #000;\n            border-radius: 35px;\n            padding: 20px 15px;\n            position: relative;\n            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);\n        }\n\n        .phone-screen {\n            width: 100%;\n            height: 100%;\n            background: linear-gradient(135deg, #e5ddd5 0%, #d1c7b8 100%);\n            border-radius: 25px;\n            position: relative;\n            overflow: hidden;\n        }\n\n        .whatsapp-header {\n            background: #075e54;\n            height: 60px;\n            display: flex;\n            align-items: center;\n            padding: 0 16px;\n            gap: 12px;\n        }\n\n        .contact-avatar {\n            width: 40px;\n            height: 40px;\n            background: #25d366;\n            border-radius: 50%;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            color: white;\n            font-weight: bold;\n            font-size: 1.2rem;\n        }\n\n        .contact-info {\n            flex: 1;\n        }\n\n        .contact-name {\n            color: white;\n            font-size: 1rem;\n            font-weight: 500;\n        }\n\n        .contact-status {\n            color: rgba(255, 255, 255, 0.7);\n            font-size: 0.8rem;\n        }\n\n        .chat-area {\n            flex: 1;\n            padding: 20px 16px;\n            overflow-y: auto;\n            height: calc(100% - 60px);\n            display: flex;\n            flex-direction: column;\n        }\n\n        .no-messages {\n            flex: 1;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            color: #666;\n            font-style: italic;\n            text-align: center;\n        }\n\n        .message-bubble {\n            background: #dcf8c6;\n            border-radius: 8px;\n            padding: 8px 12px;\n            margin-bottom: 15px;\n            max-width: 80%;\n            margin-left: auto;\n            position: relative;\n            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);\n        }\n\n        .message-bubble:after {\n            content: '';\n            position: absolute;\n            top: 8px;\n            right: -8px;\n            width: 0;\n            height: 0;\n            border-left: 8px solid #dcf8c6;\n            border-top: 8px solid transparent;\n            border-bottom: 8px solid transparent;\n        }\n\n        .message-text {\n            color: #303030;\n            font-size: 0.9rem;\n            line-height: 1.4;\n            word-wrap: break-word;\n        }\n\n        .message-time {\n            color: #667781;\n            font-size: 0.7rem;\n            text-align: right;\n            margin-top: 4px;\n        }\n\n        .media-preview-whatsapp {\n            margin-bottom: 8px;\n            border-radius: 8px;\n            overflow: hidden;\n            max-width: 200px;\n        }\n\n        .image-preview-whatsapp {\n            width: 100%;\n            height: auto;\n            max-height: 150px;\n            object-fit: cover;\n            border-radius: 8px;\n        }\n\n        .video-preview-whatsapp {\n            width: 100%;\n            height: auto;\n            max-height: 150px;\n            border-radius: 8px;\n        }\n\n        .video-overlay {\n            position: relative;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            margin-top: -75px;\n            margin-bottom: 75px;\n            pointer-events: none;\n        }\n\n        .play-button {\n            background: rgba(0, 0, 0, 0.6);\n            color: white;\n            width: 40px;\n            height: 40px;\n            border-radius: 50%;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            font-size: 1.2rem;\n        }\n\n        .audio-preview-whatsapp {\n            background: rgba(0, 0, 0, 0.1);\n            padding: 12px;\n            border-radius: 8px;\n            display: flex;\n            align-items: center;\n            gap: 12px;\n            margin-bottom: 8px;\n            max-width: 250px;\n        }\n\n        .audio-icon {\n            font-size: 1.5rem;\n            color: #075e54;\n        }\n\n        .audio-info {\n            flex: 1;\n        }\n\n        .audio-name {\n            font-size: 0.9rem;\n            font-weight: 500;\n            color: #303030;\n            margin-bottom: 2px;\n        }\n\n        .audio-duration {\n            font-size: 0.8rem;\n            color: #667781;\n        }\n\n        .audio-controls {\n            display: none;\n        }\n\n        .document-preview-whatsapp {\n            background: rgba(0, 0, 0, 0.1);\n            padding: 12px;\n            border-radius: 8px;\n            display: flex;\n            align-items: center;\n            gap: 12px;\n            margin-bottom: 8px;\n            max-width: 250px;\n            cursor: pointer;\n            transition: background 0.2s ease;\n        }\n\n        .document-preview-whatsapp:hover {\n            background: rgba(0, 0, 0, 0.15);\n        }\n\n        .document-icon {\n            font-size: 1.5rem;\n            color: #075e54;\n        }\n\n        .document-info {\n            flex: 1;\n        }\n\n        .document-name {\n            font-size: 0.9rem;\n            font-weight: 500;\n            color: #303030;\n            margin-bottom: 2px;\n            word-break: break-word;\n        }\n\n        .document-size {\n            font-size: 0.8rem;\n            color: #667781;\n        }\n\n        /* Seleção de dias da semana */\n        .days-grid {\n            display: grid;\n            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));\n            gap: 12px;\n            margin-bottom: 15px;\n        }\n\n        .day-item {\n            background: rgba(255, 255, 255, 0.05);\n            border: 2px solid rgba(255, 255, 255, 0.2);\n            border-radius: 12px;\n            padding: 16px 12px;\n            text-align: center;\n            cursor: pointer;\n            transition: all 0.3s ease;\n            position: relative;\n            user-select: none;\n        }\n\n        .day-item:hover {\n            border-color: rgba(37, 211, 102, 0.5);\n            background: rgba(37, 211, 102, 0.08);\n        }\n\n        .day-item.selected {\n            border-color: #25d366;\n            background: rgba(37, 211, 102, 0.15);\n            box-shadow: 0 4px 15px rgba(37, 211, 102, 0.2);\n        }\n\n        .day-item.selected::before {\n            content: '✓';\n            position: absolute;\n            top: 8px;\n            right: 8px;\n            background: #25d366;\n            color: white;\n            width: 18px;\n            height: 18px;\n            border-radius: 50%;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            font-size: 0.7rem;\n            font-weight: bold;\n        }\n\n        .day-name {\n            display: block;\n            color: #fff;\n            font-size: 0.9rem;\n            font-weight: 600;\n            margin-bottom: 4px;\n        }\n\n        .day-short {\n            display: block;\n            color: #888;\n            font-size: 0.75rem;\n            font-weight: 500;\n            text-transform: uppercase;\n            letter-spacing: 0.5px;\n        }\n\n        .day-item.selected .day-name {\n            color: #25d366;\n        }\n\n        .day-item.selected .day-short {\n            color: #25d366;\n        }\n\n        .days-selected {\n            background: rgba(37, 211, 102, 0.1);\n            border: 1px solid rgba(37, 211, 102, 0.3);\n            border-radius: 8px;\n            padding: 12px 16px;\n            margin-top: 10px;\n        }\n\n        .selected-days-text {\n            color: #25d366;\n            font-weight: 600;\n            font-size: 0.9rem;\n        }\n\n        @media (max-width: 768px) {\n            .days-grid {\n                grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));\n                gap: 8px;\n            }\n            \n            .day-item {\n                padding: 12px 8px;\n            }\n            \n            .day-name {\n                font-size: 0.8rem;\n            }\n            \n            .day-short {\n                font-size: 0.7rem;\n            }\n        }\n\n        @keyframes spin {\n            0% { transform: rotate(0deg); }\n            100% { transform: rotate(360deg); }\n        }\n\n        /* Loading spinner para botões */\n        .loading-spinner-small {\n            width: 16px;\n            height: 16px;\n            border: 2px solid rgba(37, 211, 102, 0.3);\n            border-top: 2px solid #25d366;\n            border-radius: 50%;\n            animation: spin 1s linear infinite;\n            display: inline-block;\n            margin-left: 8px;\n        }\n\n        @media (max-width: 1200px) {\n            .main-content {\n                grid-template-columns: 1fr;\n                gap: 30px;\n            }\n\n            .phone-preview {\n                position: static;\n                display: flex;\n                justify-content: center;\n            }\n\n            .phone-container {\n                width: 300px;\n                height: 600px;\n            }\n\n            .sidebar {\n                width: 60px;\n            }\n\n            .sidebar:hover {\n                width: 200px;\n            }\n        }\n\n        @media (max-width: 768px) {\n            .form-grid {\n                grid-template-columns: 1fr;\n                gap: 20px;\n            }\n\n            .time-range {\n                flex-direction: column;\n                gap: 10px;\n            }\n\n            .time-separator {\n                display: none;\n            }\n\n            .header-info h1 {\n                font-size: 2rem;\n            }\n\n            .form-container {\n                padding: 25px;\n            }\n\n            .media-upload {\n                grid-template-columns: repeat(2, 1fr);\n            }\n\n            .sidebar {\n                width: 60px;\n            }\n\n            .sidebar:hover {\n                width: 180px;\n            }\n\n            .main-content-wrapper {\n                padding: 15px;\n            }\n        }\n\n        .interval-range {\n            display: flex;\n            align-items: center;\n            gap: 4px;\n        }\n        .time-range {\n            display: flex;\n            align-items: center;\n            gap: 8px;\n        }\n        .time-input input[type=\"time\"] {\n            min-width: 90px;\n        }\n\n        /* Bloco de intervalo e pausa automática customizado */\n        .interval-block {\n            background: rgba(255,255,255,0.01);\n            border-radius: 16px;\n            padding: 28px 24px 18px 24px;\n            margin-bottom: 28px;\n            border: 1px solid rgba(255,255,255,0.08);\n            box-shadow: 0 2px 8px 0 rgba(0,0,0,0.04);\n        }\n        .interval-title {\n            display: flex;\n            align-items: center;\n            font-size: 1.15rem;\n            font-weight: 700;\n            margin-bottom: 18px;\n            color: #fff;\n            gap: 10px;\n        }\n        .interval-title-bar {\n            width: 5px;\n            height: 22px;\n            border-radius: 3px;\n            background: linear-gradient(135deg, #25d366 0%, #128c7e 100%);\n            margin-right: 10px;\n        }\n        .interval-row {\n            display: flex;\n            align-items: center;\n            gap: 12px;\n            margin-bottom: 18px;\n        }\n        .interval-row:last-child { margin-bottom: 0; }\n        .interval-input {\n            background: #181f1b;\n            border: 1.5px solid #2e2e2e;\n            border-radius: 10px;\n            color: #fff;\n            font-size: 1.1rem;\n            padding: 8px 14px;\n            width: 90px;\n            outline: none;\n            transition: border 0.2s;\n        }\n        .interval-input:focus {\n            border: 1.5px solid #25d366;\n        }\n        .interval-label {\n            color: #b0b0b0;\n            font-size: 1rem;\n            font-weight: 500;\n        }\n        .interval-row .interval-label {\n            margin-right: 4px;\n        }\n\n        .main-schedule-container {\n            width: 100%;\n            margin: 20px 0 32px 0;\n            background: rgba(255,255,255,0.02);\n            border-radius: 16px;\n            box-shadow: 0 4px 32px 0 rgba(0,0,0,0.18);\n            border: 1px solid rgba(255,255,255,0.1);\n            padding: 40px 40px 32px 40px;\n            display: flex;\n            flex-direction: column;\n            gap: 12px;\n        }\n        @media (max-width: 900px) {\n            .main-schedule-container { padding: 18px 2vw; }\n        }\n        .schedule-section {\n            background: none;\n            border-radius: 14px;\n            padding: 0 0 0 0;\n            margin: 0 0 32px 0;\n            display: flex;\n            flex-direction: column;\n            gap: 12px;\n        }\n        .schedule-title {\n            display: flex;\n            align-items: center;\n            font-size: 1.13rem;\n            font-weight: 600;\n            color: #fff;\n            margin-bottom: 8px;\n            gap: 10px;\n            letter-spacing: 0.01em;\n        }\n        .schedule-title-bar {\n            width: 4px;\n            height: 22px;\n            border-radius: 3px;\n            background: linear-gradient(135deg, #25d366 0%, #128c7e 100%);\n            margin-right: 10px;\n        }\n        .interval-row, .pause-row, .time-row {\n            display: flex;\n            align-items: center;\n            gap: 10px;\n            flex-wrap: wrap;\n            justify-content: flex-start !important;\n        }\n        .interval-input, .pause-input, .time-input input[type=\"time\"] {\n            background: #181f1b;\n            border: 1.5px solid #2e2e2e;\n            border-radius: 10px;\n            color: #fff;\n            font-size: 1.08rem;\n            padding: 7px 0;\n            text-align: center;\n            outline: none;\n            transition: border 0.2s;\n            box-sizing: border-box;\n        }\n        .interval-input, .pause-input {\n            width: 60px;\n        }\n        .time-input input[type=\"time\"] {\n            width: 100px;\n            padding: 7px 0;\n            text-align: center;\n        }\n        .interval-input:focus, .pause-input:focus, .time-input input[type=\"time\"]:focus {\n            border: 1.5px solid #25d366;\n        }\n\n        /* Toggle Switch Styles */\n        .schedule-toggle-row {\n            display: flex;\n            align-items: center;\n            justify-content: space-between;\n            margin-bottom: 12px;\n        }\n\n        .toggle-label {\n            color: #b0b0b0;\n            font-size: 1rem;\n            font-weight: 500;\n        }\n\n        .toggle-switch {\n            position: relative;\n            display: inline-block;\n            width: 50px;\n            height: 24px;\n        }\n\n        .toggle-switch input {\n            opacity: 0;\n            width: 0;\n            height: 0;\n        }\n\n        .toggle-slider {\n            position: absolute;\n            cursor: pointer;\n            top: 0;\n            left: 0;\n            right: 0;\n            bottom: 0;\n            background-color: #2e2e2e;\n            transition: .4s;\n            border-radius: 24px;\n        }\n\n        .toggle-slider:before {\n            position: absolute;\n            content: \"\";\n            height: 18px;\n            width: 18px;\n            left: 3px;\n            bottom: 3px;\n            background-color: white;\n            transition: .4s;\n            border-radius: 50%;\n        }\n\n        input:checked + .toggle-slider {\n            background-color: #25d366;\n        }\n\n        input:checked + .toggle-slider:before {\n            transform: translateX(26px);\n        }\n\n        /* Schedule Input Styles */\n        .schedule-input-container {\n            margin-top: 8px;\n        }\n\n        .schedule-datetime-input {\n            background: rgba(255,255,255,0.05) !important;\n            border: 1.5px solid #2e2e2e;\n            border-radius: 10px;\n            color: #fff;\n            font-size: 1.08rem;\n            padding: 12px 16px;\n            width: 100%;\n            outline: none;\n            transition: border 0.2s;\n            box-sizing: border-box;\n        }\n\n        .schedule-datetime-input:focus {\n            border: 1.5px solid #25d366;\n        }\n        .interval-label, .pause-label, .time-label {\n            color: #b0b0b0;\n            font-size: 1rem;\n            font-weight: 500;\n            margin: 0 2px;\n        }\n        /* Dias da semana */\n        .days-section {\n            display: flex;\n            flex-direction: column;\n            gap: 10px;\n        }\n        .days-grid {\n            display: grid;\n            grid-template-columns: repeat(7, 1fr);\n            gap: 10px;\n            margin-bottom: 8px;\n        }\n        @media (max-width: 600px) {\n            .main-schedule-container { padding: 18px 4vw; }\n            .days-grid { grid-template-columns: repeat(4, 1fr); }\n        }\n        .day-btn {\n            background: rgba(255,255,255,0.05);\n            border: 2px solid #232b25;\n            border-radius: 12px;\n            padding: 10px 0 7px 0;\n            cursor: pointer;\n            transition: all 0.18s;\n            font-size: 0.98rem;\n            font-weight: 600;\n            color: #fff;\n            user-select: none;\n            outline: none;\n            min-width: 0;\n            display: flex;\n            flex-direction: column;\n            align-items: center;\n            justify-content: center;\n        }\n        .day-btn .day-full { font-size: 0.98rem; font-weight: 700; }\n        .day-btn .day-abbr { font-size: 0.82rem; color: #b0b0b0; font-weight: 500; letter-spacing: 0.04em; }\n        .day-btn.selected {\n            background: rgba(37, 211, 102, 0.18);\n            border: 2px solid #25d366;\n            color: #25d366;\n            box-shadow: 0 2px 8px 0 rgba(37,211,102,0.08);\n        }\n        .day-btn:hover:not(.selected) {\n            background: #232b25;\n            border: 2px solid #128c7e;\n            color: #25d366;\n        }\n        .days-feedback {\n            background: #181f1b;\n            border-radius: 8px;\n            padding: 10px 0;\n            text-align: center;\n            color: #b0b0b0;\n            font-size: 0.98rem;\n            font-weight: 500;\n            margin-top: 2px;\n            transition: background 0.2s, color 0.2s;\n        }\n        .days-feedback.selected {\n            background: rgba(37, 211, 102, 0.08);\n            color: #25d366;\n        }\n\n        .interval-input,\n        .pause-input,\n        .time-input input[type=\"time\"] {\n            background: rgba(255,255,255,0.05) !important;\n        }\n    </style>\n</head>\n<body>\n    <div class=\"app-layout\">\n        <!-- Sidebar -->\n        <div class=\"sidebar\">\n            <div class=\"sidebar-header\">\n                <div class=\"sidebar-logo\">EnviaZap</div>\n            </div>\n            <nav class=\"sidebar-menu\">\n                <a href=\"#\" class=\"menu-item\" onclick=\"navigateToPage('https://n8n.typebot.pro/webhook/dashboard')\">\n                    <span class=\"menu-icon\">📊</span>\n                    <span class=\"menu-text\">Dashboard</span>\n                </a>\n                <a href=\"#\" class=\"menu-item\" onclick=\"navigateToPage('https://n8n.typebot.pro/webhook/historico-disparos')\">\n                    <span class=\"menu-icon\">📋</span>\n                    <span class=\"menu-text\">Histórico de disparos</span>\n                </a>\n                <a href=\"#\" class=\"menu-item\" onclick=\"navigateToPage('https://n8n.typebot.pro/webhook/conectar')\">\n                    <span class=\"menu-icon\">🔗</span>\n                    <span class=\"menu-text\">Nova Conexão</span>\n                </a>\n                <a href=\"#\" class=\"menu-item\" onclick=\"navigateToPage('https://n8n.typebot.pro/webhook/conexoes')\">\n                    <span class=\"menu-icon\">🔌</span>\n                    <span class=\"menu-text\">Conexões</span>\n                </a>\n                <a href=\"#\" class=\"menu-item active\">\n                    <span class=\"menu-icon\">📱</span>\n                    <span class=\"menu-text\">Disparos individuais</span>\n                </a>\n                <a href=\"#\" class=\"menu-item\" onclick=\"navigateToPage('https://n8n.typebot.pro/webhook/disparos-grupos')\">\n                    <span class=\"menu-icon\">👥</span>\n                    <span class=\"menu-text\">Disparos em grupo</span>\n                </a>\n                <a href=\"#\" class=\"menu-item\" onclick=\"navigateToPage('https://n8n.typebot.pro/webhook/listas')\">\n                    <span class=\"menu-icon\">📝</span>\n                    <span class=\"menu-text\">Listas</span>\n                </a>\n            </nav>\n            <div class=\"sidebar-footer\">\n                <a href=\"#\" class=\"menu-item logout-item\" onclick=\"logout()\">\n                    <span class=\"menu-icon\">🚪</span>\n                    <span class=\"menu-text\">Sair</span>\n                </a>\n            </div>\n        </div>\n\n        <!-- Main Content -->\n        <div class=\"main-content-wrapper\">\n            <div class=\"container\">\n                <div class=\"header\">\n                    <div class=\"header-info\">\n                        <h1>Disparos de Mensagens</h1>\n                        <p>Configure e envie mensagens personalizadas para seus contatos</p>\n                    </div>\n                </div>\n\n                <div class=\"main-content\">\n                    <div class=\"form-container\">\n                        <form id=\"dispatchForm\">\n                            <div class=\"connections-section\">\n                                <div class=\"connections-header\">\n                                    <label>Conexões disponíveis *</label>\n                                    <div class=\"connections-header-buttons\">\n                                        <button type=\"button\" class=\"select-active-btn\" onclick=\"selectActiveConnections()\" title=\"Selecionar conexões ativas\">\n                                            ✅ Selecionar ativas\n                                        </button>\n                                        <button type=\"button\" class=\"refresh-connections-btn-small\" onclick=\"loadConnections()\" title=\"Atualizar conexões\">\n                                            🔄\n                                        </button>\n                                    </div>\n                                </div>\n                                <p style=\"color: #888; font-size: 0.9rem; margin-bottom: 15px;\">\n                                    Selecione uma ou mais conexões para o disparo. O sistema alternará entre as conexões selecionadas.\n                                </p>\n                                <div id=\"connectionsContainer\">\n                                    <div class=\"loading-connections\">\n                                        <div class=\"loading-spinner-large\"></div>\n                                        <p>Buscando conexões...</p>\n                                    </div>\n                                </div>\n                            </div>\n\n                            <div class=\"lists-section\">\n                                <div class=\"lists-header\">\n                                    <label>Listas de contatos disponíveis</label>\n                                    <button type=\"button\" class=\"refresh-lists-btn-small\" onclick=\"loadLists()\" title=\"Atualizar listas\">\n                                        🔄\n                                    </button>\n                                </div>\n                                <p style=\"color: #888; font-size: 0.9rem; margin-bottom: 15px;\">\n                                    Selecione uma ou mais listas de contatos para o disparo. Os contatos das listas selecionadas serão incluídos no envio.\n                                </p>\n                                <div id=\"listsContainer\">\n                                    <div class=\"loading-lists\">\n                                        <div class=\"loading-spinner-large\"></div>\n                                        <p>Buscando listas...</p>\n                                    </div>\n                                </div>\n                                <div class=\"multiple-lists-warning\" id=\"multipleListsWarning\">\n                                    Atenção: Caso uma linha não tenha as variáveis selecionadas, suas mensagens podem ser afetadas\n                                </div>\n                            </div>\n\n                            <div class=\"messages-section\">\n                                <label>Mensagens a serem enviadas *</label>\n                                <p style=\"color: #888; font-size: 0.9rem; margin-bottom: 15px;\">\n                                    Crie variações de mensagens. O sistema enviará apenas 1 mensagem por contato (escolhida aleatoriamente entre as variações).\n                                </p>\n                                <div id=\"messagesContainer\">\n                                    <!-- Mensagens serão adicionadas aqui dinamicamente -->\n                                </div>\n                                <button type=\"button\" class=\"add-message-btn\" id=\"addMessageBtn\">\n                                    ➕ Adicionar Mensagem\n                                </button>\n                                \n                                <!-- Advanced Settings Section -->\n                                <div class=\"advanced-settings-section\">\n                                    <div class=\"advanced-settings-label\">⚙️ Configurações avançadas:</div>\n                                                                    <div class=\"advanced-settings-container\">\n                                    <!-- <div class=\"setting-item\">\n                                        <div class=\"setting-info\">\n                                            <div class=\"setting-title\">📞 Chamada perdida</div>\n                                            <div class=\"setting-description\">Realiza uma chamada antes de enviar a mensagem para chamar atenção</div>\n                                        </div>\n                                        <label class=\"toggle-switch\">\n                                            <input type=\"checkbox\" id=\"missedCallToggle\" onchange=\"toggleMissedCall()\">\n                                            <span class=\"toggle-slider\"></span>\n                                        </label>\n                                    </div> -->\n                                    <div class=\"setting-item\">\n                                        <div class=\"setting-info\">\n                                            <div class=\"setting-title\">\n                                                <svg class=\"chatgpt-icon\" width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\n                                                    <path d=\"M22.2819 9.8211a5.9847 5.9847 0 0 0-.5157-4.9108 6.0462 6.0462 0 0 0-6.5098-2.9A6.0651 6.0651 0 0 0 4.9807 4.1818a5.9847 5.9847 0 0 0-3.9977 2.9 6.0462 6.0462 0 0 0 .7427 7.0966 5.98 5.98 0 0 0 .511 4.9107 6.051 6.051 0 0 0 6.5146 2.9001A5.9847 5.9847 0 0 0 13.2599 24a6.0557 6.0557 0 0 0 5.7718-4.2058 5.9894 5.9894 0 0 0 3.9977-2.9001 6.0557 6.0557 0 0 0-.7475-7.0729zm-9.022 12.6081a4.4755 4.4755 0 0 1-2.8764-1.0408l.1419-.0804 4.7783-2.7582a.7948.7948 0 0 0 .3927-.6813v-6.7369l2.02 1.1686a.071.071 0 0 1 .038.052v5.5826a4.504 4.504 0 0 1-4.4945 4.4944zm-9.6607-4.1254a4.4708 4.4708 0 0 1-.5346-3.0137l.142-.0852 4.783-2.7582a.7712.7712 0 0 0 .7806 0l5.8428 3.3685v2.3324a.0804.0804 0 0 1-.0332.0615L9.74 19.9502a4.4992 4.4992 0 0 1-6.1408-1.6464zM2.3408 7.8956a4.485 4.485 0 0 1 2.3655-1.9728V11.6a.7664.7664 0 0 0 .3879.6765l5.8144 3.3543-2.0201 1.1685a.0757.0757 0 0 1-.071 0l-4.8303-2.7865A4.504 4.504 0 0 1 2.3408 7.872zm16.5963 3.8558L13.1038 8.364 15.1192 7.2a.0757.0757 0 0 1 .071 0l4.8303 2.7913a4.4944 4.4944 0 0 1-.6765 8.1042v-5.6772a.79.79 0 0 0-.407-.667zm2.0107-3.0231l-.142-.0852-4.7735-2.7818a.7759.7759 0 0 0-.7854 0L9.409 9.2297V6.8974a.0662.0662 0 0 1 .0284-.0615l4.8303-2.7866a4.4992 4.4992 0 0 1 6.6802 4.66zM8.3065 12.863l-2.02-1.1638a.0804.0804 0 0 1-.038-.0567V6.0742a4.4992 4.4992 0 0 1 7.3757-3.4537l-.142.0805L8.704 5.459a.7948.7948 0 0 0-.3927.6813zm1.0976-2.3654l2.602-1.4998 2.6069 1.4998v2.9994l-2.5974 1.4997-2.6067-1.4997Z\"/>\n                                                </svg>\n                                                Gerar mensagens com IA\n                                            </div>\n                                            <div class=\"setting-description\">Utiliza inteligência artificial para criar mensagens personalizadas e persuasivas</div>\n                                        </div>\n                                        <label class=\"toggle-switch\">\n                                            <input type=\"checkbox\" id=\"aiMessagesToggle\" onchange=\"toggleAIMessages()\">\n                                            <span class=\"toggle-slider\"></span>\n                                        </label>\n                                    </div>\n                                    \n                                    <!-- Configurações de IA (aparece quando ativado) -->\n                                    <div id=\"aiSettingsContainer\" class=\"ai-settings-container\" style=\"display: none;\">\n                                        <div class=\"ai-settings-content\">\n                                            <div class=\"ai-input-group\">\n                                                <label for=\"aiVariationsCount\">Quantidade de variações de mensagens:</label>\n                                                <input type=\"number\" id=\"aiVariationsCount\" min=\"1\" max=\"10\" value=\"3\" class=\"ai-input\">\n                                            </div>\n                                            \n                                            <div class=\"ai-input-group\">\n                                                <label for=\"aiInstructions\">Instruções adicionais:</label>\n                                                <textarea id=\"aiInstructions\" placeholder=\"Ex: Torne a mensagem mais persuasiva, use tom profissional, inclua call-to-action...\" class=\"ai-textarea\"></textarea>\n                                            </div>\n                                            \n                                            <div class=\"ai-note\">\n                                                <svg class=\"info-icon\" width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\n                                                    <path d=\"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z\"/>\n                                                </svg>\n                                                <span>A mensagem será gerada a partir das mensagens já inseridas e dessas instruções adicionais.</span>\n                                            </div>\n                                            \n                                            <button type=\"button\" class=\"generate-ai-btn\" onclick=\"generateAIMessages()\">\n                                                <svg class=\"chatgpt-btn-icon\" width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\n                                                    <path d=\"M22.2819 9.8211a5.9847 5.9847 0 0 0-.5157-4.9108 6.0462 6.0462 0 0 0-6.5098-2.9A6.0651 6.0651 0 0 0 4.9807 4.1818a5.9847 5.9847 0 0 0-3.9977 2.9 6.0462 6.0462 0 0 0 .7427 7.0966 5.98 5.98 0 0 0 .511 4.9107 6.051 6.051 0 0 0 6.5146 2.9001A5.9847 5.9847 0 0 0 13.2599 24a6.0557 6.0557 0 0 0 5.7718-4.2058 5.9894 5.9894 0 0 0 3.9977-2.9001 6.0557 6.0557 0 0 0-.7475-7.0729zm-9.022 12.6081a4.4755 4.4755 0 0 1-2.8764-1.0408l.1419-.0804 4.7783-2.7582a.7948.7948 0 0 0 .3927-.6813v-6.7369l2.02 1.1686a.071.071 0 0 1 .038.052v5.5826a4.504 4.504 0 0 1-4.4945 4.4944zm-9.6607-4.1254a4.4708 4.4708 0 0 1-.5346-3.0137l.142-.0852 4.783-2.7582a.7712.7712 0 0 0 .7806 0l5.8428 3.3685v2.3324a.0804.0804 0 0 1-.0332.0615L9.74 19.9502a4.4992 4.4992 0 0 1-6.1408-1.6464zM2.3408 7.8956a4.485 4.485 0 0 1 2.3655-1.9728V11.6a.7664.7664 0 0 0 .3879.6765l5.8144 3.3543-2.0201 1.1685a.0757.0757 0 0 1-.071 0l-4.8303-2.7865A4.504 4.504 0 0 1 2.3408 7.872zm16.5963 3.8558L13.1038 8.364 15.1192 7.2a.0757.0757 0 0 1 .071 0l4.8303 2.7913a4.4944 4.4944 0 0 1-.6765 8.1042v-5.6772a.79.79 0 0 0-.407-.667zm2.0107-3.0231l-.142-.0852-4.7735-2.7818a.7759.7759 0 0 0-.7854 0L9.409 9.2297V6.8974a.0662.0662 0 0 1 .0284-.0615l4.8303-2.7866a4.4992 4.4992 0 0 1 6.6802 4.66zM8.3065 12.863l-2.02-1.1638a.0804.0804 0 0 1-.038-.0567V6.0742a4.4992 4.4992 0 0 1 7.3757-3.4537l-.142.0805L8.704 5.459a.7948.7948 0 0 0-.3927.6813zm1.0976-2.3654l2.602-1.4998 2.6069 1.4998v2.9994l-2.5974 1.4997-2.6067-1.4997Z\"/>\n                                                </svg>\n                                                <span>Gerar mensagens com IA</span>\n                                            </button>\n                                        </div>\n                                    </div>\n                                </div>\n                                </div>\n                            </div>\n\n                            <div class=\"main-schedule-container\">\n                                <!-- Seção 1: Agendar disparo -->\n                                <div class=\"schedule-section\">\n                                    <div class=\"schedule-title\"><span class=\"schedule-title-bar\"></span>Agendar disparo</div>\n                                    <div class=\"schedule-toggle-row\">\n                                        <label class=\"toggle-label\">Agendar para data específica</label>\n                                        <label class=\"toggle-switch\">\n                                            <input type=\"checkbox\" id=\"scheduleToggle\" onchange=\"toggleScheduleInput()\">\n                                            <span class=\"toggle-slider\"></span>\n                                        </label>\n                                    </div>\n                                    <div class=\"schedule-input-container\" id=\"scheduleInputContainer\" style=\"display: none;\">\n                                        <input type=\"datetime-local\" id=\"scheduleDateTime\" class=\"schedule-datetime-input\">\n                                    </div>\n                                </div>\n                                <!-- Seção 2: Intervalo -->\n                                <div class=\"schedule-section\">\n                                    <div class=\"schedule-title\"><span class=\"schedule-title-bar\"></span>Intervalo entre mensagens</div>\n                                    <div class=\"interval-row\">\n                                        <input type=\"number\" id=\"intervalMin\" name=\"intervalMin\" min=\"1\" max=\"300\" value=\"30\" required class=\"interval-input\">\n                                        <span class=\"interval-label\">e</span>\n                                        <input type=\"number\" id=\"intervalMax\" name=\"intervalMax\" min=\"1\" max=\"300\" value=\"60\" required class=\"interval-input\">\n                                        <span class=\"interval-label\">segundos</span>\n                                    </div>\n                                </div>\n                                <!-- Seção 2: Pausa automática -->\n                                <div class=\"schedule-section\">\n                                    <div class=\"schedule-title\"><span class=\"schedule-title-bar\"></span>Pausa automática</div>\n                                    <div class=\"pause-row\">\n                                        <span class=\"pause-label\">Após</span>\n                                        <input type=\"number\" id=\"pauseAfterMessages\" name=\"pauseAfterMessages\" min=\"1\" max=\"1000\" value=\"20\" required class=\"pause-input\">\n                                        <span class=\"pause-label\">mensagens, aguardar</span>\n                                        <input type=\"number\" id=\"pauseMinutes\" name=\"pauseMinutes\" min=\"1\" max=\"1440\" value=\"10\" required class=\"pause-input\">\n                                        <span class=\"pause-label\">minutos</span>\n                                    </div>\n                                </div>\n                                <!-- Seção 3: Horário de envio -->\n                                <div class=\"schedule-section\">\n                                    <div class=\"schedule-title\"><span class=\"schedule-title-bar\"></span>Horário de envio</div>\n                                    <div class=\"time-row\" style=\"justify-content: center;\">\n                                        <div class=\"time-input\"><input type=\"time\" id=\"startTime\" name=\"startTime\" value=\"08:00\" required></div>\n                                        <span class=\"time-label\">às</span>\n                                        <div class=\"time-input\"><input type=\"time\" id=\"endTime\" name=\"endTime\" value=\"18:00\" required></div>\n                                    </div>\n                                </div>\n                                <!-- Seção 4: Dias da semana -->\n                                <div class=\"schedule-section days-section\">\n                                    <div class=\"schedule-title\"><span class=\"schedule-title-bar\"></span>Dias da semana</div>\n                                    <div class=\"days-grid\" id=\"daysGrid\">\n                                        <div class=\"day-btn\" data-day=\"1\" onclick=\"toggleDayBtn(this)\"><span class=\"day-full\">SEGUNDA</span><span class=\"day-abbr\">SEG</span></div>\n                                        <div class=\"day-btn\" data-day=\"2\" onclick=\"toggleDayBtn(this)\"><span class=\"day-full\">TERÇA</span><span class=\"day-abbr\">TER</span></div>\n                                        <div class=\"day-btn\" data-day=\"3\" onclick=\"toggleDayBtn(this)\"><span class=\"day-full\">QUARTA</span><span class=\"day-abbr\">QUA</span></div>\n                                        <div class=\"day-btn\" data-day=\"4\" onclick=\"toggleDayBtn(this)\"><span class=\"day-full\">QUINTA</span><span class=\"day-abbr\">QUI</span></div>\n                                        <div class=\"day-btn\" data-day=\"5\" onclick=\"toggleDayBtn(this)\"><span class=\"day-full\">SEXTA</span><span class=\"day-abbr\">SEX</span></div>\n                                        <div class=\"day-btn\" data-day=\"6\" onclick=\"toggleDayBtn(this)\"><span class=\"day-full\">SÁBADO</span><span class=\"day-abbr\">SAB</span></div>\n                                        <div class=\"day-btn\" data-day=\"0\" onclick=\"toggleDayBtn(this)\"><span class=\"day-full\">DOMINGO</span><span class=\"day-abbr\">DOM</span></div>\n                                    </div>\n                                </div>\n                            </div>\n\n                            <!-- Área de avisos de validação -->\n                            <div class=\"error-message\" id=\"validationWarnings\">\n                                <div class=\"warning-messages\" id=\"warningMessages\"></div>\n                            </div>\n\n                            <button type=\"button\" class=\"dispatch-btn\" id=\"dispatchBtn\" onclick=\"handleSubmit();\">\n                                <div class=\"loading-spinner\"></div>\n                                <span id=\"btnText\">Iniciar Disparo</span>\n                            </button>\n                        </form>\n\n                        <div class=\"success-message\" id=\"successMessage\"></div>\n                        <div class=\"error-message\" id=\"errorMessage\"></div>\n\n                        <div class=\"stats\" id=\"stats\" style=\"display: none;\">\n                            <div class=\"stat-card\">\n                                <div class=\"stat-value\" id=\"totalMessages\">0</div>\n                                <div class=\"stat-label\">Variações de Mensagem</div>\n                            </div>\n                            <div class=\"stat-card\">\n                                <div class=\"stat-value\" id=\"totalConnections\">0</div>\n                                <div class=\"stat-label\">Conexões Selecionadas</div>\n                            </div>\n                            <div class=\"stat-card\">\n                                <div class=\"stat-value\" id=\"totalLists\">0</div>\n                                <div class=\"stat-label\">Listas Selecionadas</div>\n                            </div>\n                        </div>\n                    </div>\n\n                    <div class=\"phone-preview\">\n                        <div class=\"phone-container\">\n                            <div class=\"phone-screen\">\n                                <div class=\"whatsapp-header\">\n                                    <div class=\"contact-avatar\">C</div>\n                                    <div class=\"contact-info\">\n                                        <div class=\"contact-name\">Contato</div>\n                                        <div class=\"contact-status\">online</div>\n                                    </div>\n                                </div>\n                                <div class=\"chat-area\" id=\"chatArea\">\n                                    <div class=\"no-messages\">\n                                        Digite uma mensagem para ver o preview\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        </div>\n    </div>\n\n    <script>\n        // Função para ler cookies\n        function getCookie(name) {\n            const value = `; ${document.cookie}`;\n            const parts = value.split(`; ${name}=`);\n            if (parts.length === 2) return parts.pop().split(';').shift();\n            return null;\n        }\n\n        // Função para obter userId de forma segura via cookies\n        function getSecureUserId() {\n            const userId = getCookie('userId');\n            if (userId && /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(userId)) {\n                console.log('✅ UserId (UUID) obtido dos cookies:', userId);\n                return userId;\n            }\n            console.error('❌ UserId (UUID) não encontrado ou formato inválido nos cookies!');\n            return null;\n        }\n\n        // Autenticação obrigatória ao carregar a página\n        function checkAuth() {\n            const userId = getSecureUserId();\n            if (!userId) {\n                window.location.href = 'https://n8n.typebot.pro/webhook/login';\n            }\n        }\n\n        // Navegação simplificada (sem parâmetros de autenticação)\n        function navigateToPage(url) {\n            window.location.href = url;\n        }\n\n        // Verificar autenticação ao carregar a página\n        checkAuth();\n\n        // Get instance name from URL parameters - código legado mantido\n        const urlParams = new URLSearchParams(window.location.search);\n        const instanceName = urlParams.get('instanceName') || 'Não informado';\n        // Código do instanceName removido conforme solicitado\n\n        // Form elements\n        const form = document.getElementById('dispatchForm');\n        const messagesContainer = document.getElementById('messagesContainer');\n        const addMessageBtn = document.getElementById('addMessageBtn');\n        const fileUpload = document.getElementById('fileUpload');\n        const csvFile = document.getElementById('csvFile');\n        const fileInfo = document.getElementById('fileInfo');\n        const fileName = document.getElementById('fileName');\n        const contactCount = document.getElementById('contactCount');\n        const removeFile = document.getElementById('removeFile');\n        const dispatchBtn = document.getElementById('dispatchBtn');\n        const btnText = document.getElementById('btnText');\n        const successMessage = document.getElementById('successMessage');\n        const errorMessage = document.getElementById('errorMessage');\n        const stats = document.getElementById('stats');\n        const chatArea = document.getElementById('chatArea');\n\n        // Global variables\n        let messages = [];\n        let contacts = [];\n        let connections = [];\n        let selectedConnections = [];\n        let lists = [];\n        let selectedLists = [];\n        let selectedDays = [];\n        let messageCounter = 0;\n\n        // 🗓️ Função para alternar seleção de dias (GLOBAL)\n        function toggleDay(dayElement) {\n            const dayValue = parseInt(dayElement.getAttribute('data-day'));\n            \n            console.log('🗓️ Clicou no dia:', dayValue);\n            \n            if (dayElement.classList.contains('selected')) {\n                // Remove da seleção\n                dayElement.classList.remove('selected');\n                const index = selectedDays.indexOf(dayValue);\n                if (index > -1) {\n                    selectedDays.splice(index, 1);\n                }\n                console.log('❌ Dia removido:', dayValue, 'Lista atual:', selectedDays);\n            } else {\n                // Adiciona à seleção\n                dayElement.classList.add('selected');\n                selectedDays.push(dayValue);\n                console.log('✅ Dia adicionado:', dayValue, 'Lista atual:', selectedDays);\n            }\n            \n            updateSelectedDaysDisplay();\n            updateValidationWarnings();\n        }\n\n        // 📊 Atualiza exibição dos dias selecionados\n        function updateSelectedDaysDisplay() {\n            const selectedDaysDiv = document.getElementById('daysSelected');\n            const daysText = document.querySelector('.selected-days-text');\n            \n            if (!daysText) {\n                console.log('⚠️ Elemento selected-days-text não encontrado');\n                return;\n            }\n            \n            if (selectedDays.length === 0) {\n                daysText.textContent = 'Nenhum dia selecionado';\n                return;\n            }\n            \n            const dayNames = {\n                0: 'Domingo',\n                1: 'Segunda',\n                2: 'Terça', \n                3: 'Quarta',\n                4: 'Quinta',\n                5: 'Sexta',\n                6: 'Sábado'\n            };\n            \n            // Ordena os dias (Segunda a Domingo)\n            const sortedDays = [...selectedDays].sort((a, b) => {\n                const order = [1, 2, 3, 4, 5, 6, 0]; // Segunda a Domingo\n                return order.indexOf(a) - order.indexOf(b);\n            });\n            \n            const selectedNames = sortedDays.map(day => dayNames[day]);\n            \n            if (selectedDays.length === 7) {\n                daysText.textContent = 'Todos os dias da semana';\n            } else if (selectedDays.length === 5 && !selectedDays.includes(0) && !selectedDays.includes(6)) {\n                daysText.textContent = 'Dias úteis (Segunda a Sexta)';\n            } else if (selectedDays.length === 2 && selectedDays.includes(0) && selectedDays.includes(6)) {\n                daysText.textContent = 'Finais de semana';\n            } else {\n                daysText.textContent = selectedNames.join(', ');\n            }\n            \n            console.log('📊 Texto atualizado:', daysText.textContent);\n        }\n\n        // Initialize page\n        console.log('🚀 Iniciando inicialização da página...');\n        \n        // Aguarda o DOM estar pronto antes de inicializar\n        if (document.readyState === 'loading') {\n            document.addEventListener('DOMContentLoaded', init);\n        } else {\n            init();\n        }\n\n        async function init() {\n            console.log('🚀 Função init() chamada');\n            \n            try {\n                // Aguarda o DOM estar totalmente carregado\n                console.log('⏳ Aguardando DOM...');\n                await new Promise(resolve => {\n                    if (document.readyState === 'loading') {\n                        document.addEventListener('DOMContentLoaded', resolve);\n                    } else {\n                        resolve();\n                    }\n                });\n                console.log('✅ DOM carregado');\n                \n                // Initialize with one message FIRST (independente do carregamento)\n                console.log('📝 Adicionando primeira mensagem...');\n                addMessage();\n                console.log('✅ Primeira mensagem adicionada');\n                \n                // Atualiza preview imediatamente\n                console.log('👁️ Atualizando preview...');\n                updatePreview();\n                console.log('✅ Preview atualizado');\n                \n                // Load connections in background\n                console.log('📡 Chamando loadConnections()...');\n                loadConnections().then(() => {\n                    console.log('✅ loadConnections() finalizada');\n                    // Atualiza variáveis quando conexões carregam\n                    updateVariablesForAllMessages();\n                }).catch(error => {\n                    console.error('❌ Erro ao carregar conexões:', error);\n                });\n                \n                // Load lists in background\n                console.log('📋 Chamando loadLists()...');\n                loadLists().then(() => {\n                    console.log('✅ loadLists() finalizada');\n                    // Atualiza variáveis quando listas carregam\n                    updateVariablesForAllMessages();\n                }).catch(error => {\n                    console.error('❌ Erro ao carregar listas:', error);\n                });\n                \n                console.log('✅ Inicialização completa');\n                \n                // Inicializa validações\n                updateValidationWarnings();\n            } catch (error) {\n                console.error('❌ Erro na inicialização:', error);\n                console.error('❌ Stack trace:', error.stack);\n            }\n        }\n\n        // 🔗 Função para carregar conexões\n        async function loadConnections() {\n            console.log('📡 === INÍCIO loadConnections() ===');\n            \n            // Mostra loading\n            const container = document.getElementById('connectionsContainer');\n            if (!container) {\n                console.error('❌ Container connectionsContainer não encontrado!');\n                return;\n            }\n            \n            console.log('🔄 Definindo HTML de loading...');\n            container.innerHTML = `\n                <div class=\"loading-connections\">\n                    <div class=\"loading-spinner-large\"></div>\n                    <p>Buscando conexões...</p>\n                </div>\n            `;\n            \n            // Desabilita botão de refresh\n            const refreshBtn = document.querySelector('.refresh-connections-btn');\n            if (refreshBtn) {\n                refreshBtn.disabled = true;\n                console.log('🔄 Botão refresh desabilitado');\n            } else {\n                console.log('⚠️ Botão refresh não encontrado ainda');\n            }\n            \n            updateConnectionStatus('Carregando conexões...');\n            \n            try {\n                // Verifica se tem userId válido\n                const userId = getSecureUserId();\n\n                console.log('🔍 Verificando userId:', {\n                    userId: userId\n                });\n\n                if (!userId) {\n                    throw new Error('UserId não encontrado');\n                }\n\n                console.log('📊 Preparando requisição com userId:', userId);\n                \n                const requestBody = {\n                    userId: userId\n                };\n                \n                console.log('📤 Body da requisição:', requestBody);\n                console.log('📡 Fazendo fetch para:', 'https://n8n.typebot.pro/webhook/listarconexoes');\n                \n                // Faz requisição para listar conexões\n                const response = await fetch('https://n8n.typebot.pro/webhook/listarconexoes', {\n                    method: 'POST',\n                    headers: {\n                        'Content-Type': 'application/json',\n                    },\n                    body: JSON.stringify(requestBody)\n                });\n\n                console.log('📡 Resposta recebida - Status:', response.status);\n                console.log('📡 Resposta recebida - OK:', response.ok);\n\n                if (!response.ok) {\n                    const errorText = await response.text();\n                    console.error('❌ Erro na resposta:', errorText);\n                    throw new Error(`Erro na requisição: ${response.status} - ${errorText}`);\n                }\n\n                const data = await response.json();\n                console.log('✅ Dados recebidos (RAW):', data);\n                console.log('✅ Tipo dos dados:', typeof data);\n                console.log('✅ É array?', Array.isArray(data));\n\n                // Reset das conexões selecionadas\n                selectedConnections = [];\n\n                // Processa as conexões - estrutura corrigida baseada nos logs\n                console.log('🔍 Verificando estrutura dos dados...');\n                \n                let rawConnections = [];\n                \n                if (data && data.Conexoes && Array.isArray(data.Conexoes)) {\n                    // Estrutura: { Conexoes: [...] }\n                    rawConnections = data.Conexoes;\n                    console.log('✅ Estrutura tipo 1: data.Conexoes encontrada');\n                } else if (data && Array.isArray(data) && data.length > 0 && data[0].Conexoes && Array.isArray(data[0].Conexoes)) {\n                    // Estrutura: [{ Conexoes: [...] }]\n                    rawConnections = data[0].Conexoes;\n                    console.log('✅ Estrutura tipo 2: data[0].Conexoes encontrada');\n                } else if (Array.isArray(data)) {\n                    // Estrutura: [...]\n                    rawConnections = data;\n                    console.log('✅ Estrutura tipo 3: array direto encontrada');\n                } else {\n                    console.log('⚠️ Estrutura não reconhecida:', data);\n                    rawConnections = [];\n                }\n\n                console.log('📊 Conexões brutas encontradas:', rawConnections.length);\n\n                // 🔴 VALIDAÇÃO ROBUSTA - Filtra apenas conexões válidas\n                connections = rawConnections.filter(connection => {\n                    // Verifica se é um objeto válido\n                    if (!connection || typeof connection !== 'object') {\n                        console.log('❌ Conexão inválida (não é objeto):', connection);\n                        return false;\n                    }\n\n                    // Verifica se tem propriedades essenciais\n                    const hasValidName = connection.NomeConexao || connection.nomeConexao || connection.name;\n                    const hasValidInstance = connection.instanceName || connection.instance_name;\n                    const hasValidId = connection.id !== undefined && connection.id !== null;\n\n                    if (!hasValidName || !hasValidInstance || !hasValidId) {\n                        console.log('❌ Conexão sem propriedades essenciais:', {\n                            id: connection.id,\n                            name: hasValidName,\n                            instance: hasValidInstance,\n                            connection: connection\n                        });\n                        return false;\n                    }\n\n                    console.log('✅ Conexão válida encontrada:', {\n                        id: connection.id,\n                        name: connection.NomeConexao || connection.nomeConexao || connection.name,\n                        instance: connection.instanceName || connection.instance_name\n                    });\n\n                    return true;\n                });\n\n                console.log(`✅ Conexões válidas filtradas: ${connections.length} de ${rawConnections.length} conexões`);\n\n                if (connections.length > 0) {\n                    console.log('✅ Primeira conexão válida processada:', connections[0]);\n                    \n                    // Verifica status de cada conexão\n                    console.log('🔍 Verificando status das conexões...');\n                    await checkConnectionsStatus();\n                    \n                    renderConnections();\n                    updateConnectionStatus(`${connections.length} conexões encontradas`);\n                    updateValidationWarnings();\n                } else {\n                    console.log('⚠️ Nenhuma conexão válida encontrada após filtragem');\n                    renderNoConnections();\n                    updateConnectionStatus('Nenhuma conexão válida encontrada');\n                }\n\n            } catch (error) {\n                console.error('❌ ERRO COMPLETO:', error);\n                console.error('❌ Stack trace:', error.stack);\n                \n                // Verifica se é o erro específico de \"No item to return got found\"\n                if (error.message && error.message.includes('No item to return got found')) {\n                    console.log('📭 Resposta vazia - usuário não possui conexões');\n                    connections = [];\n                    renderNoConnections();\n                    updateConnectionStatus('Nenhuma conexão encontrada');\n                } else {\n                    showError(`Erro ao carregar conexões: ${error.message}`);\n                    renderConnectionError();\n                    updateConnectionStatus('Erro ao carregar conexões');\n                }\n            } finally {\n                // Reabilita botão de refresh\n                const refreshBtn = document.querySelector('.refresh-connections-btn');\n                if (refreshBtn) {\n                    refreshBtn.disabled = false;\n                    console.log('🔄 Botão refresh reabilitado');\n                }\n                console.log('📡 === FIM loadConnections() ===');\n            }\n        }\n\n        // 🔍 Verifica status de conexão de todas as instâncias com validação robusta\n        async function checkConnectionsStatus() {\n            console.log('🔍 === INÍCIO verificação de status ===');\n            \n            const baseUrl = 'https://whatsapi.typebot.pro';\n            const apiKey = 'b4d71f9c38e3ac12a6b08e4b6d53aa90';\n            \n            const promises = connections.map(async (connection, index) => {\n                try {\n                    // 🔴 VALIDAÇÃO ROBUSTA - Verifica se tem instanceName válido\n                    const instanceName = connection.instanceName || connection.instance_name;\n                    const connectionName = connection.NomeConexao || connection.nomeConexao || connection.name || `Conexão ${index + 1}`;\n                    \n                    if (!instanceName || typeof instanceName !== 'string' || instanceName.trim() === '') {\n                        console.log(`⚠️ Conexão ${connectionName} sem instanceName válido:`, instanceName);\n                        connection.connectionStatus = null;\n                        connection.isConnected = false;\n                        return;\n                    }\n                    \n                    console.log(`🔍 Verificando status da conexão ${index + 1}/${connections.length}: ${connectionName} (${instanceName})`);\n                    \n                    const response = await fetch(`${baseUrl}/instance/connectionState/${instanceName}`, {\n                        method: 'GET',\n                        headers: {\n                            'apikey': apiKey\n                        }\n                    });\n                    \n                    console.log(`📡 Status resposta para ${connectionName}:`, response.status);\n                    \n                    if (response.ok) {\n                        const statusData = await response.json();\n                        console.log(`✅ Status data para ${connectionName}:`, statusData);\n                        \n                        // Atualiza o status da conexão baseado na resposta\n                        connection.connectionStatus = statusData;\n                        \n                        // 🔴 VALIDAÇÃO ROBUSTA - Verifica múltiplos caminhos para o estado\n                        let actualState = null;\n                        \n                        if (statusData && typeof statusData === 'object') {\n                            // Tenta diferentes caminhos para encontrar o estado\n                            actualState = statusData.instance?.state || \n                                         statusData.state || \n                                         statusData.status || \n                                         statusData.connectionState;\n                        }\n                        \n                        connection.isConnected = actualState === 'open' || actualState === 'connected';\n                        \n                        console.log(`📊 Status interpretado para ${connectionName}:`, {\n                            fullResponse: statusData,\n                            instanceState: statusData?.instance?.state,\n                            directState: statusData?.state,\n                            actualState: actualState,\n                            isConnected: connection.isConnected\n                        });\n                        \n                    } else {\n                        console.log(`❌ Erro ao verificar ${connectionName}: ${response.status}`);\n                        connection.connectionStatus = null;\n                        connection.isConnected = false;\n                    }\n                    \n                } catch (error) {\n                    const connectionName = connection?.NomeConexao || connection?.nomeConexao || connection?.name || 'Conexão desconhecida';\n                    console.error(`❌ Erro na verificação de ${connectionName}:`, error);\n                    connection.connectionStatus = null;\n                    connection.isConnected = false;\n                }\n            });\n            \n            // Aguarda todas as verificações\n            await Promise.all(promises);\n            console.log('✅ Verificação de status concluída para todas as conexões');\n            console.log('🔍 === FIM verificação de status ===');\n            \n            // Atualiza validações após verificar status das conexões\n            updateValidationWarnings();\n        }\n\n        // 🎨 Renderiza as conexões com validação robusta\n        function renderConnections() {\n            const container = document.getElementById('connectionsContainer');\n            \n            if (connections.length === 0) {\n                renderNoConnections();\n                return;\n            }\n\n            let html = '<div class=\"connections-grid\">';\n            \n            connections.forEach(connection => {\n                // 🔴 VALIDAÇÃO ROBUSTA - Múltiplos fallbacks para propriedades\n                \n                // Nome da conexão com fallbacks\n                const connectionName = connection.NomeConexao || connection.nomeConexao || connection.name || 'Conexão sem nome';\n                \n                // Avatar com validação segura\n                let avatar;\n                if (connection.FotoPerfil && typeof connection.FotoPerfil === 'string') {\n                    avatar = `<img src=\"${connection.FotoPerfil}\" alt=\"${connectionName}\">`;\n                } else if (connectionName && typeof connectionName === 'string' && connectionName.length > 0) {\n                    avatar = connectionName.charAt(0).toUpperCase();\n                } else {\n                    avatar = '?'; // Fallback final\n                }\n                \n                // Telefone com fallback seguro\n                const phoneDisplay = connection.Telefone || connection.telefone || connection.phone || 'Indisponível';\n                \n                // Instance name com fallback\n                const instanceName = connection.instanceName || connection.instance_name || 'unknown';\n                \n                // ID com validação\n                const connectionId = connection.id !== undefined && connection.id !== null ? connection.id : 'unknown';\n                \n                // Status com validação robusta\n                let statusIcon, statusClass;\n                \n                console.log(`🔍 Determinando status para ${connectionName}:`, {\n                    isConnected: connection.isConnected,\n                    hasApikey: !!connection.Apikey,\n                    connectionStatus: connection.connectionStatus\n                });\n                \n                if (connection.isConnected === true) {\n                    statusIcon = '✓';\n                    statusClass = 'connected';\n                } else if (connection.isConnected === false) {\n                    statusIcon = '✗';\n                    statusClass = 'disconnected';\n                } else {\n                    // Fallback para o método antigo (Apikey)\n                    const hasApikey = connection.Apikey && typeof connection.Apikey === 'string' && connection.Apikey.length > 0;\n                    statusIcon = hasApikey ? '✓' : '✗';\n                    statusClass = hasApikey ? 'connected' : 'disconnected';\n                    console.log(`🔄 Usando fallback para ${connectionName}: ${statusClass}`);\n                }\n\n                // Só renderiza se tiver dados mínimos válidos\n                if (connectionId !== 'unknown' && connectionName !== 'Conexão sem nome') {\n                    html += `\n                        <div class=\"connection-card\" onclick=\"toggleConnection(${connectionId})\" data-connection-id=\"${connectionId}\">\n                            <div class=\"connection-header\">\n                                <div class=\"connection-avatar\">\n                                    ${avatar}\n                                </div>\n                                <div class=\"connection-info\">\n                                    <div class=\"connection-name\">${connectionName}</div>\n                                    <div class=\"connection-phone\">${phoneDisplay}</div>\n                                </div>\n                                <div class=\"connection-status-pill ${statusClass}\">${statusIcon}</div>\n                            </div>\n                        </div>\n                    `;\n                } else {\n                    console.log('⚠️ Conexão pulada por dados insuficientes:', {\n                        id: connectionId,\n                        name: connectionName,\n                        connection: connection\n                    });\n                }\n            });\n\n            html += '</div>';\n            html += `\n                <div class=\"connections-selected\" id=\"connectionsSelected\">\n                    <div class=\"selected-count\" id=\"selectedCount\">0 conexões selecionadas</div>\n                </div>\n            `;\n\n            // Verifica se alguma conexão foi realmente renderizada\n            const validConnectionsCount = html.split('connection-card').length - 1;\n            \n            if (validConnectionsCount === 0) {\n                console.log('⚠️ Nenhuma conexão válida para renderizar');\n                renderNoConnections();\n                return;\n            }\n\n            container.innerHTML = html;\n            console.log(`✅ ${validConnectionsCount} conexões renderizadas com sucesso`);\n        }\n\n        // 🚫 Renderiza quando não há conexões\n        function renderNoConnections() {\n            const container = document.getElementById('connectionsContainer');\n            container.innerHTML = `\n                <div class=\"no-connections\">\n                    <h3>Você não possui conexões.</h3>\n                    <p>Clique em conexões e crie sua primeira conexão</p>\n                    <br>\n                    <button type=\"button\" class=\"add-message-btn\" onclick=\"navigateToPage('https://n8n.typebot.pro/webhook/conectar')\">\n                        🔗 Criar Nova Conexão\n                    </button>\n                </div>\n            `;\n        }\n\n        // ⚠️ Renderiza erro de conexão\n        function renderConnectionError() {\n            const container = document.getElementById('connectionsContainer');\n            container.innerHTML = `\n                <div class=\"no-connections\">\n                    <h3>Erro ao carregar conexões</h3>\n                    <p>Não foi possível carregar suas conexões.</p>\n                </div>\n            `;\n        }\n\n        // 🔄 Alterna seleção de conexão\n        function toggleConnection(connectionId) {\n            const card = document.querySelector(`[data-connection-id=\"${connectionId}\"]`);\n            const index = selectedConnections.indexOf(connectionId);\n            \n            if (index === -1) {\n                // Adiciona à seleção\n                selectedConnections.push(connectionId);\n                card.classList.add('selected');\n            } else {\n                // Remove da seleção\n                selectedConnections.splice(index, 1);\n                card.classList.remove('selected');\n            }\n            \n            updateSelectedCount();\n            updateStats();\n            updateValidationWarnings();\n        }\n\n        // 📋 Função para carregar listas\n        async function loadLists() {\n            console.log('📋 === INÍCIO loadLists() ===');\n            \n            // Mostra loading\n            const container = document.getElementById('listsContainer');\n            if (!container) {\n                console.error('❌ Container listsContainer não encontrado!');\n                return;\n            }\n            \n            console.log('🔄 Definindo HTML de loading...');\n            container.innerHTML = `\n                <div class=\"loading-lists\">\n                    <div class=\"loading-spinner-large\"></div>\n                    <p>Buscando listas...</p>\n                </div>\n            `;\n            \n            // Desabilita botão de refresh\n            const refreshBtn = document.querySelector('.refresh-lists-btn-small');\n            if (refreshBtn) {\n                refreshBtn.disabled = true;\n                console.log('🔄 Botão refresh desabilitado');\n            }\n            \n            try {\n                // Verifica se tem userId válido\n                const userId = getSecureUserId();\n\n                console.log('🔍 Verificando userId:', {\n                    userId: userId\n                });\n\n                if (!userId) {\n                    throw new Error('UserId não encontrado');\n                }\n\n                console.log('📊 Preparando requisição com userId:', userId);\n                \n                const requestBody = {\n                    userId: userId\n                };\n                \n                console.log('📤 Body da requisição:', requestBody);\n                console.log('📡 Fazendo fetch para:', 'https://n8n.typebot.pro/webhook/puxar-lista');\n                \n                // Faz requisição para listar listas\n                const response = await fetch('https://n8n.typebot.pro/webhook/puxar-lista', {\n                    method: 'POST',\n                    headers: {\n                        'Content-Type': 'application/json',\n                    },\n                    body: JSON.stringify(requestBody)\n                });\n\n                console.log('📡 Resposta recebida - Status:', response.status);\n                console.log('📡 Resposta recebida - OK:', response.ok);\n\n                if (!response.ok) {\n                    const errorText = await response.text();\n                    console.error('❌ Erro na resposta:', errorText);\n                    throw new Error(`Erro na requisição: ${response.status} - ${errorText}`);\n                }\n\n                const data = await response.json();\n                console.log('✅ Dados recebidos (RAW):', data);\n                console.log('✅ Tipo dos dados:', typeof data);\n                console.log('✅ É array?', Array.isArray(data));\n\n                // Reset das listas selecionadas\n                selectedLists = [];\n\n                // Processa as listas - estrutura corrigida baseada nos logs\n                console.log('🔍 Verificando estrutura dos dados...');\n                \n                let rawLists = [];\n                \n                // Verifica se a resposta está vazia ou nula\n                if (!data || (Array.isArray(data) && data.length === 0) || \n                    (data.data && Array.isArray(data.data) && data.data.length === 0)) {\n                    console.log('📭 Resposta vazia - usuário não possui listas');\n                    lists = [];\n                    renderNoLists();\n                    return;\n                }\n                \n                if (data && data.data && Array.isArray(data.data)) {\n                    // Estrutura: { data: [...] }\n                    rawLists = data.data;\n                    console.log('✅ Estrutura tipo 1: data.data encontrada');\n                } else if (data && Array.isArray(data)) {\n                    // Estrutura: [...]\n                    rawLists = data;\n                    console.log('✅ Estrutura tipo 2: array direto encontrada');\n                } else {\n                    console.log('⚠️ Estrutura não reconhecida:', data);\n                    rawLists = [];\n                }\n\n                console.log('📊 Listas brutas encontradas:', rawLists.length);\n\n                // Filtra apenas listas do tipo \"contacts\"\n                lists = rawLists.filter(list => {\n                    if (!list || typeof list !== 'object') {\n                        console.log('❌ Lista inválida (não é objeto):', list);\n                        return false;\n                    }\n                    \n                    const isValid = list.tipo === 'contacts';\n                    if (isValid) {\n                        console.log('✅ Lista de contatos válida:', list.nome || 'Sem nome');\n                    }\n                    return isValid;\n                });\n\n                console.log(`✅ Listas de contatos filtradas: ${lists.length} de ${rawLists.length} listas`);\n\n                if (lists.length > 0) {\n                    console.log('✅ Primeira lista válida processada:', lists[0]);\n                    renderLists();\n                } else {\n                    console.log('⚠️ Nenhuma lista de contatos encontrada');\n                    renderNoLists();\n                }\n\n            } catch (error) {\n                console.error('❌ ERRO COMPLETO:', error);\n                console.error('❌ Stack trace:', error.stack);\n                \n                // Verifica se é o erro específico de \"No item to return got found\"\n                if (error.message && error.message.includes('No item to return got found')) {\n                    console.log('📭 Resposta vazia - usuário não possui listas');\n                    lists = [];\n                    renderNoLists();\n                } else {\n                    showError(`Erro ao carregar listas: ${error.message}`);\n                    renderListError();\n                }\n            } finally {\n                // Reabilita botão de refresh\n                const refreshBtn = document.querySelector('.refresh-lists-btn-small');\n                if (refreshBtn) {\n                    refreshBtn.disabled = false;\n                    console.log('🔄 Botão refresh reabilitado');\n                }\n                console.log('📋 === FIM loadLists() ===');\n            }\n        }\n\n        // 🎨 Renderiza as listas\n        function renderLists() {\n            const container = document.getElementById('listsContainer');\n            \n            if (lists.length === 0) {\n                renderNoLists();\n                return;\n            }\n\n            let html = '<div class=\"lists-grid\">';\n            \n            lists.forEach(list => {\n                const listName = list.nome || 'Lista sem nome';\n                const listId = list.id;\n                \n                html += `\n                    <div class=\"list-card\" onclick=\"toggleList(${listId})\" data-list-id=\"${listId}\">\n                        <div class=\"list-info\">\n                            <div class=\"list-icon\">📋</div>\n                            <div class=\"list-name\">${listName}</div>\n                        </div>\n                    </div>\n                `;\n            });\n\n            html += '</div>';\n            html += `\n                <div class=\"lists-selected\" id=\"listsSelected\">\n                    <div class=\"selected-lists-count\" id=\"selectedListsCount\">0 listas selecionadas</div>\n                </div>\n            `;\n\n            container.innerHTML = html;\n            console.log(`✅ ${lists.length} listas renderizadas com sucesso`);\n        }\n\n        // 🚫 Renderiza quando não há listas\n        function renderNoLists() {\n            const container = document.getElementById('listsContainer');\n            container.innerHTML = `\n                <div class=\"no-lists\">\n                    <h3>Você não possui listas.</h3>\n                    <p>Clique em listas e crie sua primeira lista</p>\n                    <br>\n                    <button type=\"button\" class=\"add-message-btn\" onclick=\"goToListas()\">\n                        📋 Criar Nova Lista\n                    </button>\n                </div>\n            `;\n        }\n\n        // ⚠️ Renderiza erro de listas\n        function renderListError() {\n            const container = document.getElementById('listsContainer');\n            container.innerHTML = `\n                <div class=\"no-lists\">\n                    <h3>Erro ao carregar listas</h3>\n                    <p>Não foi possível carregar suas listas.</p>\n                </div>\n            `;\n        }\n\n        // 🔄 Alterna seleção de lista\n        function toggleList(listId) {\n            const card = document.querySelector(`[data-list-id=\"${listId}\"]`);\n            const index = selectedLists.indexOf(listId);\n            \n            if (index === -1) {\n                // Adiciona à seleção\n                selectedLists.push(listId);\n                card.classList.add('selected');\n            } else {\n                // Remove da seleção\n                selectedLists.splice(index, 1);\n                card.classList.remove('selected');\n            }\n            \n            updateSelectedListsCount();\n            updateStats();\n            updateValidationWarnings();\n        }\n\n        // 📊 Atualiza contador de listas selecionadas\n        function updateSelectedListsCount() {\n            const selectedDiv = document.getElementById('listsSelected');\n            const countDiv = document.getElementById('selectedListsCount');\n            const warningDiv = document.getElementById('multipleListsWarning');\n            \n            if (selectedLists.length > 0) {\n                selectedDiv.classList.add('show');\n                countDiv.textContent = `${selectedLists.length} lista${selectedLists.length !== 1 ? 's' : ''} selecionada${selectedLists.length !== 1 ? 's' : ''}`;\n            } else {\n                selectedDiv.classList.remove('show');\n            }\n            \n            // Mostra aviso quando múltiplas listas são selecionadas\n            if (warningDiv) {\n                if (selectedLists.length > 1) {\n                    warningDiv.classList.add('show');\n                } else {\n                    warningDiv.classList.remove('show');\n                }\n            }\n            \n            // Atualiza variáveis quando listas são selecionadas/desselecionadas\n            updateVariablesForAllMessages();\n        }\n\n        // 🔤 Função para obter todas as variáveis únicas das listas selecionadas\n        function getAvailableVariables() {\n            const variables = new Set();\n            // Sempre inclui a variável \"nome\" como padrão\n            variables.add('nome');\n            // Variáveis padrão solicitadas\n            variables.add('saudacao');\n            variables.add('hora');\n            variables.add('data');\n            variables.add('diadasemana');\n            variables.add('mes');\n            selectedLists.forEach(listId => {\n                const list = lists.find(l => l.id === listId);\n                if (list && list.campos && Array.isArray(list.campos)) {\n                    list.campos.forEach(campo => {\n                        if (campo && typeof campo === 'string') {\n                            variables.add(campo);\n                        }\n                    });\n                }\n            });\n            // Converte para array e coloca \"nome\" sempre primeiro\n            const variablesArray = Array.from(variables);\n            const nomeIndex = variablesArray.indexOf('nome');\n            if (nomeIndex > -1) {\n                variablesArray.splice(nomeIndex, 1);\n                variablesArray.unshift('nome');\n            }\n            // Ordena o resto das variáveis alfabeticamente\n            const otherVariables = variablesArray.slice(1).sort();\n            return ['nome', ...otherVariables];\n        }\n\n        // 🔤 Função para atualizar variáveis em todas as mensagens\n        function updateVariablesForAllMessages() {\n            try {\n                console.log('🔤 updateVariablesForAllMessages() iniciada');\n                \n                const messageItems = messagesContainer.querySelectorAll('.message-item');\n                console.log('📝 Mensagens encontradas:', messageItems.length);\n                \n                if (messageItems.length === 0) {\n                    console.log('⚠️ Nenhuma mensagem encontrada para atualizar variáveis');\n                    return;\n                }\n                \n                const availableVariables = getAvailableVariables();\n                console.log('🔤 Variáveis disponíveis:', availableVariables);\n                \n                messageItems.forEach((item, index) => {\n                    const variablesContainer = item.querySelector('.variables-container');\n                    if (variablesContainer) {\n                        updateVariablesInContainer(variablesContainer, availableVariables);\n                        console.log(`✅ Variáveis atualizadas na mensagem ${index + 1}`);\n                    } else {\n                        console.log(`⚠️ Container de variáveis não encontrado na mensagem ${index + 1}`);\n                    }\n                });\n                \n                console.log('✅ updateVariablesForAllMessages() finalizada');\n            } catch (error) {\n                console.error('❌ Erro em updateVariablesForAllMessages:', error);\n            }\n        }\n\n        // 🔤 Função para atualizar variáveis em um container específico\n        function updateVariablesInContainer(container, variables) {\n            if (variables.length === 0) {\n                container.innerHTML = '<span class=\"no-variables\">A variável \"nome\" está sempre disponível</span>';\n                return;\n            }\n            \n            // Função para formatar nome bonitinho\n            function formatVarName(name) {\n                if (name === 'diadasemana') return 'Dia da semana';\n                return name.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');\n            }\n            \n            // Separa variáveis de tempo das outras\n            const tempoVars = ['saudacao','hora','data','diadasemana','mes'];\n            const timeVariables = variables.filter(v => tempoVars.includes(v));\n            const otherVariables = variables.filter(v => !tempoVars.includes(v));\n            \n            let html = '';\n            \n            // SVG do relógio com cor herdada\n            const clockSVG = `<svg width=\"16\" height=\"16\" viewBox=\"0 0 16 16\" fill=\"none\" style=\"vertical-align:middle;margin-right:4px;\" xmlns=\"http://www.w3.org/2000/svg\"><circle cx=\"8\" cy=\"8\" r=\"7\" stroke=\"currentColor\" stroke-width=\"2\" fill=\"none\"/><path d=\"M8 4.5V8L10.5 10\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\"/></svg>`;\n            // Ícone + para nome e variáveis de lista\n            const plusSVG = `<svg width=\"16\" height=\"16\" viewBox=\"0 0 16 16\" fill=\"none\" style=\"vertical-align:middle;margin-right:4px;\" xmlns=\"http://www.w3.org/2000/svg\"><path d=\"M8 3v10M3 8h10\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\"/></svg>`;\n            // Ícone de seta para expandir\n            const arrowSVG = `<svg width=\"12\" height=\"12\" viewBox=\"0 0 12 12\" fill=\"none\" style=\"vertical-align:middle;margin-left:4px;transition:transform 0.2s;\" xmlns=\"http://www.w3.org/2000/svg\"><path d=\"M3 4.5L6 7.5L9 4.5\" stroke=\"currentColor\" stroke-width=\"1.5\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/></svg>`;\n            \n            // Botão expansível para variáveis de tempo\n            if (timeVariables.length > 0) {\n                html += `\n                    <div class=\"time-variables-container\">\n                        <button type=\"button\" class=\"variable-btn time-toggle-btn\" onclick=\"toggleTimeVariables(this)\">\n                            ${clockSVG}Variáveis de tempo${arrowSVG}\n                        </button>\n                        <div class=\"time-variables-dropdown\" style=\"display: none;\">\n                `;\n                \n                timeVariables.forEach(variable => {\n                    const label = formatVarName(variable);\n                    html += `<button type=\"button\" class=\"variable-btn time-var-btn\" onclick=\"insertVariable(this, '${variable}')\">${clockSVG}${label}</button>`;\n                });\n                \n                html += '</div></div>';\n            }\n            \n            // Outras variáveis (não-tempo)\n            otherVariables.forEach(variable => {\n                const label = formatVarName(variable);\n                html += `<button type=\"button\" class=\"variable-btn\" onclick=\"insertVariable(this, '${variable}')\\\">${plusSVG}${label}</button>`;\n            });\n            \n            container.innerHTML = html;\n        }\n\n        // 🔤 Função para inserir variável no textarea\n        function insertVariable(button, variableName) {\n            const messageItem = button.closest('.message-item');\n            const textarea = messageItem.querySelector('textarea');\n            const variableText = `<${variableName}>`;\n            \n            // Obtém a posição atual do cursor\n            const start = textarea.selectionStart;\n            const end = textarea.selectionEnd;\n            const text = textarea.value;\n            \n            // Insere a variável na posição do cursor\n            const newText = text.substring(0, start) + variableText + text.substring(end);\n            textarea.value = newText;\n            \n            // Reposiciona o cursor após a variável inserida\n            const newCursorPos = start + variableText.length;\n            textarea.setSelectionRange(newCursorPos, newCursorPos);\n            \n            // Foca no textarea e atualiza o preview\n            textarea.focus();\n            updatePreview();\n            \n            // Fecha o dropdown de variáveis de tempo se estiver aberto\n            const timeContainer = button.closest('.time-variables-container');\n            if (timeContainer) {\n                const dropdown = timeContainer.querySelector('.time-variables-dropdown');\n                const toggleBtn = timeContainer.querySelector('.time-toggle-btn');\n                if (dropdown && dropdown.style.display === 'block') {\n                    dropdown.style.display = 'none';\n                    toggleBtn.classList.remove('expanded');\n                }\n            }\n            \n            // Feedback visual temporário\n            button.style.background = 'rgba(37, 211, 102, 0.3)';\n            setTimeout(() => {\n                button.style.background = '';\n            }, 200);\n        }\n\n        // 🔤 Função para aplicar formatação (negrito/itálico)\n        function formatText(button, type) {\n            const messageItem = button.closest('.message-item');\n            const textarea = messageItem.querySelector('textarea');\n            \n            // Obtém a seleção atual\n            const start = textarea.selectionStart;\n            const end = textarea.selectionEnd;\n            const selectedText = textarea.value.substring(start, end);\n            \n            if (selectedText.length === 0) {\n                // Se não há texto selecionado, mostra mensagem\n                showError('Selecione o texto que deseja formatar.');\n                return;\n            }\n            \n            // Define os delimitadores baseado no tipo\n            let prefix, suffix;\n            switch(type) {\n                case 'bold':\n                    prefix = '*';\n                    suffix = '*';\n                    break;\n                case 'italic':\n                    prefix = '_';\n                    suffix = '_';\n                    break;\n                default:\n                    return;\n            }\n            \n            // Aplica a formatação\n            const text = textarea.value;\n            const newText = text.substring(0, start) + prefix + selectedText + suffix + text.substring(end);\n            textarea.value = newText;\n            \n            // Reposiciona o cursor\n            const newCursorPos = end + prefix.length + suffix.length;\n            textarea.setSelectionRange(newCursorPos, newCursorPos);\n            \n            // Foca no textarea e atualiza o preview\n            textarea.focus();\n            updatePreview();\n            \n            // Feedback visual temporário\n            button.style.background = 'rgba(37, 211, 102, 0.3)';\n            setTimeout(() => {\n                button.style.background = '';\n            }, 200);\n        }\n\n        // 📊 Atualiza contador de selecionadas\n        function updateSelectedCount() {\n            const selectedDiv = document.getElementById('connectionsSelected');\n            const countDiv = document.getElementById('selectedCount');\n            \n            if (selectedConnections.length > 0) {\n                selectedDiv.classList.add('show');\n                countDiv.textContent = `${selectedConnections.length} conexão${selectedConnections.length !== 1 ? 'ões' : ''} selecionada${selectedConnections.length !== 1 ? 's' : ''}`;\n            } else {\n                selectedDiv.classList.remove('show');\n            }\n        }\n\n        // 🔄 Atualiza status das conexões\n        function updateConnectionStatus(status) {\n            // Status agora é mostrado apenas nos logs, não na interface\n            console.log('📊 Status das conexões:', status);\n        }\n\n        // Event listeners\n        addMessageBtn.addEventListener('click', addMessage);\n        csvFile.addEventListener('change', handleFileUpload);\n        removeFile.addEventListener('click', removeFileHandler);\n        \n        console.log('🔍 Verificando formulário:', form);\n        console.log('🔍 Verificando botão:', dispatchBtn);\n        \n        // Adiciona event listener diretamente\n        document.getElementById('dispatchBtn').addEventListener('click', function() {\n            handleSubmit();\n        });\n        \n        console.log('✅ Event listener adicionado ao botão');\n\n        // Drag and drop functionality\n        fileUpload.addEventListener('dragover', (e) => {\n            e.preventDefault();\n            fileUpload.classList.add('dragover');\n        });\n\n        fileUpload.addEventListener('dragleave', () => {\n            fileUpload.classList.remove('dragover');\n        });\n\n        fileUpload.addEventListener('drop', (e) => {\n            e.preventDefault();\n            fileUpload.classList.remove('dragover');\n            const files = e.dataTransfer.files;\n            if (files.length > 0 && files[0].type === 'text/csv') {\n                csvFile.files = files;\n                handleFileUpload();\n            }\n        });\n\n        // Functions\n        function addMessage() {\n            messageCounter++;\n            const messageDiv = document.createElement('div');\n            messageDiv.className = 'message-item';\n            messageDiv.innerHTML = `\n                <div class=\"message-header\">\n                    <span class=\"message-title\">Mensagem ${messageCounter}</span>\n                    <button type=\"button\" class=\"remove-message\" onclick=\"removeMessage(this)\">\n                        Remover\n                    </button>\n                </div>\n                <div class=\"form-group\">\n                    <label>Texto da mensagem *</label>\n                    <div class=\"variables-section\">\n                        <div class=\"variables-label\">Variáveis disponíveis:</div>\n                        <div class=\"variables-container\" id=\"variables-${messageCounter}\">\n                            <span class=\"no-variables\">A variável \"nome\" está sempre disponível</span>\n                        </div>\n                    </div>\n\n\n                    \n                    <div class=\"formatting-buttons\">\n                        <button type=\"button\" class=\"format-btn\" onclick=\"formatText(this, 'bold')\" title=\"Negrito\">\n                            <strong>B</strong>\n                        </button>\n                        <button type=\"button\" class=\"format-btn\" onclick=\"formatText(this, 'italic')\" title=\"Itálico\">\n                            <em>I</em>\n                        </button>\n                    </div>\n                    <textarea name=\"message\" placeholder=\"Digite sua mensagem aqui... Ex: Olá <nome>, você tem <idade> anos e trabalha como <cargo>.\" required oninput=\"updatePreview()\"></textarea>\n                </div>\n                <div class=\"media-upload\">\n                    <div class=\"media-btn\" onclick=\"selectMedia(this, 'image')\">\n                        <input type=\"file\" accept=\"image/*\" onchange=\"handleMediaUpload(this, 'image')\">\n                        📷 Imagem\n                        <div class=\"file-size-limit\">Máx: 16MB</div>\n                    </div>\n                    <div class=\"media-btn\" onclick=\"selectMedia(this, 'video')\">\n                        <input type=\"file\" accept=\"video/*\" onchange=\"handleMediaUpload(this, 'video')\">\n                        🎥 Vídeo\n                        <div class=\"file-size-limit\">Máx: 16MB</div>\n                    </div>\n                    <div class=\"media-btn\" onclick=\"selectMedia(this, 'audio')\">\n                        <input type=\"file\" accept=\"audio/*\" onchange=\"handleMediaUpload(this, 'audio')\">\n                        🎵 Áudio\n                        <div class=\"file-size-limit\">Máx: 16MB</div>\n                    </div>\n                    <div class=\"media-btn\" onclick=\"selectMedia(this, 'document')\">\n                        <input type=\"file\" accept=\".pdf,.doc,.docx,.txt\" onchange=\"handleMediaUpload(this, 'document')\">\n                        📄 Documento\n                        <div class=\"file-size-limit\">Máx: 16MB</div>\n                    </div>\n                </div>\n                <div class=\"media-preview-section\"></div>\n            `;\n            messagesContainer.appendChild(messageDiv);\n            \n            // Atualiza variáveis apenas se as listas já carregaram\n            if (lists.length > 0 || selectedLists.length > 0) {\n                updateVariablesForAllMessages();\n            }\n            \n            updateStats();\n            updatePreview();\n            updateValidationWarnings();\n        }\n\n        function removeMessage(button) {\n            if (messagesContainer.children.length > 1) {\n                button.closest('.message-item').remove();\n                updateVariablesForAllMessages();\n                updateStats();\n                updatePreview();\n                updateValidationWarnings();\n            } else {\n                showError('Deve haver pelo menos uma mensagem.');\n            }\n        }\n\n        function selectMedia(button, type) {\n            const input = button.querySelector('input[type=\"file\"]');\n            input.click();\n        }\n\n        function handleMediaUpload(input, type) {\n            const file = input.files[0];\n            if (!file) return;\n\n            // Verificar tamanho do arquivo (16MB = 16 * 1024 * 1024 bytes)\n            const maxSize = 16 * 1024 * 1024; // 16MB em bytes\n            if (file.size > maxSize) {\n                showError(`Arquivo muito grande! O tamanho máximo permitido é 16MB. Arquivo atual: ${formatFileSize(file.size)}`);\n                input.value = ''; // Limpa o input\n                return;\n            }\n\n            const messageItem = input.closest('.message-item');\n            const previewSection = messageItem.querySelector('.media-preview-section');\n            const mediaBtn = input.closest('.media-btn');\n\n            // Clear previous media\n            previewSection.innerHTML = '';\n            messageItem.querySelectorAll('.media-btn').forEach(btn => btn.classList.remove('active'));\n\n            // Mark button as active\n            mediaBtn.classList.add('active');\n\n            // Show media info\n            const mediaInfo = document.createElement('div');\n            mediaInfo.className = 'media-selected';\n            \n            let icon;\n            switch(type) {\n                case 'image': icon = '📷'; break;\n                case 'video': icon = '🎥'; break;\n                case 'audio': icon = '🎵'; break;\n                case 'document': icon = '📄'; break;\n            }\n\n            mediaInfo.innerHTML = `\n                <div class=\"media-info-display\">\n                    <span class=\"media-icon-display\">${icon}</span>\n                    <div>\n                        <div class=\"media-name-display\">${file.name}</div>\n                        <div class=\"media-size-display\">${formatFileSize(file.size)}</div>\n                    </div>\n                </div>\n                <button type=\"button\" class=\"remove-media-btn\" onclick=\"removeMedia(this)\">✕</button>\n            `;\n\n            previewSection.appendChild(mediaInfo);\n            updatePreview();\n        }\n\n        function removeMedia(button) {\n            const messageItem = button.closest('.message-item');\n            const previewSection = messageItem.querySelector('.media-preview-section');\n            previewSection.innerHTML = '';\n            messageItem.querySelectorAll('.media-btn').forEach(btn => btn.classList.remove('active'));\n            messageItem.querySelectorAll('input[type=\"file\"]').forEach(input => input.value = '');\n            updatePreview();\n        }\n\n        function formatFileSize(bytes) {\n            if (bytes === 0) return '0 Bytes';\n            const k = 1024;\n            const sizes = ['Bytes', 'KB', 'MB', 'GB'];\n            const i = Math.floor(Math.log(bytes) / Math.log(k));\n            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];\n        }\n\n        function handleFileUpload() {\n            const file = csvFile.files[0];\n            if (!file) return;\n\n            // Verificar tamanho do arquivo (16MB = 16 * 1024 * 1024 bytes)\n            const maxSize = 16 * 1024 * 1024; // 16MB em bytes\n            if (file.size > maxSize) {\n                showError(`Arquivo muito grande! O tamanho máximo permitido é 16MB. Arquivo atual: ${formatFileSize(file.size)}`);\n                csvFile.value = ''; // Limpa o input\n                return;\n            }\n\n            const reader = new FileReader();\n            reader.onload = function(e) {\n                try {\n                    const csv = e.target.result;\n                    const lines = csv.split('\\n').filter(line => line.trim());\n                    \n                    // Skip header row\n                    const phoneNumbers = lines.slice(1).map(line => {\n                        const phone = line.split(',')[0].trim();\n                        return phone.replace(/[^\\d]/g, ''); // Remove non-digits\n                    }).filter(phone => phone.length >= 10); // Basic validation\n\n                    contacts = phoneNumbers;\n                    \n                    fileName.textContent = file.name;\n                    contactCount.textContent = `${contacts.length} contatos`;\n                    fileInfo.classList.add('show');\n                    \n                    updateStats();\n                    showSuccess(`Arquivo carregado com sucesso! ${contacts.length} contatos encontrados.`);\n                } catch (error) {\n                    showError('Erro ao processar arquivo CSV. Verifique o formato.');\n                }\n            };\n            reader.readAsText(file);\n        }\n\n        function removeFileHandler() {\n            csvFile.value = '';\n            contacts = [];\n            fileInfo.classList.remove('show');\n            updateStats();\n        }\n\n        function updatePreview() {\n            // Atualiza validações quando o preview é atualizado\n            updateValidationWarnings();\n            try {\n                console.log('👁️ updatePreview() iniciada');\n                \n                const messageItems = messagesContainer.querySelectorAll('.message-item');\n                const chatArea = document.getElementById('chatArea');\n                \n                console.log('📝 Mensagens encontradas para preview:', messageItems.length);\n                \n                if (!chatArea) {\n                    console.error('❌ Chat area não encontrada');\n                    return;\n                }\n                \n                // Clear previous messages\n                chatArea.innerHTML = '';\n\n                // Adiciona indicador de chamada perdida no preview se ativado\n                // if (isMissedCallEnabled()) {\n                //     const missedCallDiv = document.createElement('div');\n                //     missedCallDiv.className = 'missed-call-indicator';\n                //     missedCallDiv.innerHTML = `\n                //         <div class=\"missed-call-content\">\n                //             <svg class=\"missed-call-icon\" width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n                //                 <path d=\"M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z\"/>\n                //                 <line x1=\"15\" y1=\"5\" x2=\"9\" y2=\"11\"/>\n                //                 <line x1=\"9\" y1=\"5\" x2=\"15\" y2=\"11\"/>\n                //             </svg>\n                //             <div class=\"missed-call-info\">\n                //                 <div class=\"missed-call-title\">Chamada perdida</div>\n                //             </div>\n                //         </div>\n                //     `;\n                //     chatArea.appendChild(missedCallDiv);\n                // }\n\n                if (messageItems.length === 0) {\n                    chatArea.innerHTML = '<div class=\"no-messages\">Digite uma mensagem para ver o preview</div>';\n                    console.log('✅ Preview atualizado com mensagem vazia');\n                    return;\n                }\n\n                // Gera valores dinâmicos atuais para variáveis de tempo\n                const now = new Date();\n                const hora = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });\n                const data = now.toLocaleDateString('pt-BR');\n                const diasSemana = ['Domingo', 'Segunda-feira', 'Terça-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira', 'Sábado'];\n                const diadasemana = diasSemana[now.getDay()];\n                const meses = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];\n                const mes = meses[now.getMonth()];\n                \n                // Calcula saudação baseada na hora\n                const currentHour = now.getHours();\n                let saudacao;\n                if (currentHour >= 5 && currentHour < 12) {\n                    saudacao = 'Bom dia';\n                } else if (currentHour >= 12 && currentHour < 18) {\n                    saudacao = 'Boa tarde';\n                } else {\n                    saudacao = 'Boa noite';\n                }\n                \n                const tempoVarsValues = {\n                    'saudacao': saudacao,\n                    'hora': hora,\n                    'data': data,\n                    'diadasemana': diadasemana,\n                    'mes': mes\n                };\n\n                // Show preview of each message variation\n                messageItems.forEach((item, index) => {\n                    try {\n                        const textarea = item.querySelector('textarea');\n                        const text = textarea ? textarea.value.trim() : '';\n                        const mediaInputs = item.querySelectorAll('input[type=\"file\"]');\n                        \n                        // Encontra mídia selecionada\n                        let selectedMedia = null;\n                        for (let input of mediaInputs) {\n                            if (input.files.length > 0) {\n                                const parentBtn = input.closest('.media-btn');\n                                if (parentBtn && parentBtn.classList.contains('active')) {\n                                    const file = input.files[0];\n                                    let mediaType = null;\n                                    \n                                    if (parentBtn.textContent.includes('Imagem')) mediaType = 'image';\n                                    else if (parentBtn.textContent.includes('Vídeo')) mediaType = 'video';\n                                    else if (parentBtn.textContent.includes('Áudio')) mediaType = 'audio';\n                                    else if (parentBtn.textContent.includes('Documento')) mediaType = 'document';\n                                    \n                                    selectedMedia = { file, type: mediaType };\n                                    break;\n                                }\n                            }\n                        }\n\n                        if (text || selectedMedia) {\n                            const messageDiv = document.createElement('div');\n                            messageDiv.className = 'message-bubble';\n                            \n                            let content = '';\n                            \n                            // Add media preview\n                            if (selectedMedia) {\n                                content += createMediaPreview(selectedMedia);\n                            }\n                            \n                            // Add text content\n                            if (text) {\n                                // Destaca as variáveis e aplica formatação no preview\n                                let previewText = text;\n                                const availableVariables = getAvailableVariables();\n                                // Ordena por tamanho decrescente para evitar conflitos\n                                const sortedVars = [...availableVariables].sort((a, b) => b.length - a.length);\n                                // Aplica formatação (negrito e itálico)\n                                previewText = previewText.replace(/\\*(.*?)\\*/g, '<strong>$1</strong>');\n                                previewText = previewText.replace(/_(.*?)_/g, '<em>$1</em>');\n                                // Destaca as variáveis\n                                sortedVars.forEach(variable => {\n                                    // Regex seguro para pegar exatamente <variavel>\n                                    const regex = new RegExp(`(<${variable}>)`, 'g');\n                                    if (tempoVarsValues[variable]) {\n                                        previewText = previewText.replace(regex, `<span style=\\\"background: rgba(37, 211, 102, 0.15); color: #25d366; font-weight: 600; padding: 2px 6px; border-radius: 4px; border: 1px solid rgba(37, 211, 102, 0.3); font-size: 0.85em;\\\">${tempoVarsValues[variable]}</span>`);\n                                    } else {\n                                        const label = variable.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');\n                                        previewText = previewText.replace(regex, `<span style=\\\"background: rgba(37, 211, 102, 0.15); color: #25d366; font-weight: 600; padding: 2px 6px; border-radius: 4px; border: 1px solid rgba(37, 211, 102, 0.3); font-size: 0.85em;\\\">&lt;${label}&gt;</span>`);\n                                    }\n                                });\n                                content += `<div class=\\\"message-text\\\">${previewText}</div>`;\n                            }\n                            \n                            content += `<div class=\\\"message-time\\\">${hora}</div>`;\n                            \n                            messageDiv.innerHTML = content;\n                            chatArea.appendChild(messageDiv);\n                        }\n                    } catch (error) {\n                        console.error(`❌ Erro ao processar mensagem ${index + 1}:`, error);\n                    }\n                });\n\n                if (chatArea.children.length === 0) {\n                    chatArea.innerHTML = '<div class=\"no-messages\">Digite uma mensagem para ver o preview</div>';\n                }\n                \n                console.log('✅ updatePreview() finalizada');\n            } catch (error) {\n                console.error('❌ Erro em updatePreview:', error);\n            }\n        }\n\n        function createMediaPreview(media) {\n            const { file, type } = media;\n            const fileName = file.name;\n            const fileSize = formatFileSize(file.size);\n            \n            switch (type) {\n                case 'image':\n                    const imageUrl = URL.createObjectURL(file);\n                    return `\n                        <div class=\"media-preview-whatsapp\">\n                            <img src=\"${imageUrl}\" alt=\"${fileName}\" class=\"image-preview-whatsapp\" onload=\"URL.revokeObjectURL(this.src)\">\n                        </div>\n                    `;\n                    \n                case 'video':\n                    const videoUrl = URL.createObjectURL(file);\n                    return `\n                        <div class=\"media-preview-whatsapp\">\n                            <video class=\"video-preview-whatsapp\" controls>\n                                <source src=\"${videoUrl}\" type=\"${file.type}\">\n                            </video>\n                            <div class=\"video-overlay\">\n                                <div class=\"play-button\">▶</div>\n                            </div>\n                        </div>\n                    `;\n                    \n                case 'audio':\n                    const audioUrl = URL.createObjectURL(file);\n                    return `\n                        <div class=\"audio-preview-whatsapp\">\n                            <div class=\"audio-icon\">🎵</div>\n                            <div class=\"audio-info\">\n                                <div class=\"audio-name\">${fileName}</div>\n                                <div class=\"audio-duration\">${fileSize}</div>\n                            </div>\n                            <audio controls class=\"audio-controls\">\n                                <source src=\"${audioUrl}\" type=\"${file.type}\">\n                            </audio>\n                        </div>\n                    `;\n                    \n                case 'document':\n                    return `\n                        <div class=\"document-preview-whatsapp\">\n                            <div class=\"document-icon\">📎</div>\n                            <div class=\"document-info\">\n                                <div class=\"document-name\">${fileName}</div>\n                                <div class=\"document-size\">${fileSize}</div>\n                            </div>\n                        </div>\n                    `;\n                    \n                default:\n                    return '';\n            }\n        }\n\n        function updateStats() {\n            const messageCount = messagesContainer.children.length;\n            const connectionsCount = selectedConnections.length;\n            const listsCount = selectedLists.length;\n\n            document.getElementById('totalMessages').textContent = messageCount;\n\n            // Atualiza estatísticas das conexões se existir o elemento\n            const connectionsStatElement = document.getElementById('totalConnections');\n            if (connectionsStatElement) {\n                connectionsStatElement.textContent = connectionsCount;\n            }\n\n            // Atualiza estatísticas das listas se existir o elemento\n            const listsStatElement = document.getElementById('totalLists');\n            if (listsStatElement) {\n                listsStatElement.textContent = listsCount;\n            }\n\n            if (messageCount > 0 || connectionsCount > 0 || listsCount > 0) {\n                stats.style.display = 'grid';\n            }\n        }\n\n        function showSuccess(message) {\n            successMessage.textContent = message;\n            successMessage.classList.add('show');\n            errorMessage.classList.remove('show');\n            \n            setTimeout(() => {\n                successMessage.classList.remove('show');\n            }, 5000);\n        }\n\n        function showError(message) {\n            errorMessage.textContent = message;\n            errorMessage.classList.add('show');\n            successMessage.classList.remove('show');\n            \n            setTimeout(() => {\n                errorMessage.classList.remove('show');\n            }, 5000);\n        }\n\n        function validateForm() {\n            console.log('🔍 Iniciando validação do formulário...');\n            \n            const messageItems = messagesContainer.querySelectorAll('.message-item');\n            let hasValidMessage = false;\n\n            console.log('📝 Verificando mensagens:', messageItems.length);\n\n            for (let item of messageItems) {\n                const textarea = item.querySelector('textarea');\n                const mediaSection = item.querySelector('.media-preview-section');\n                \n                const hasText = textarea.value.trim();\n                const hasMedia = mediaSection.children.length > 0;\n                \n                console.log('📝 Mensagem:', { hasText, hasMedia });\n                \n                if (hasText || hasMedia) {\n                    hasValidMessage = true;\n                    break;\n                }\n            }\n\n            if (!hasValidMessage) {\n                console.log('❌ Nenhuma mensagem válida encontrada');\n                showError('Adicione pelo menos uma mensagem com texto ou mídia.');\n                return false;\n            }\n\n            console.log('✅ Mensagens válidas:', hasValidMessage);\n\n            if (selectedConnections.length === 0) {\n                console.log('❌ Nenhuma conexão selecionada');\n                showError('Selecione pelo menos uma conexão para o disparo.');\n                return false;\n            }\n\n            console.log('✅ Conexões selecionadas:', selectedConnections.length);\n\n            // Verifica se tem contatos (CSV ou listas selecionadas)\n            if (contacts.length === 0 && selectedLists.length === 0) {\n                console.log('❌ Nenhum contato ou lista selecionada');\n                showError('Carregue um arquivo CSV com contatos ou selecione pelo menos uma lista de contatos.');\n                return false;\n            }\n\n            console.log('✅ Contatos/Listas válidos');\n\n            // Validação de dias é opcional - removida para permitir disparos sem restrição de dias\n            // if (selectedDays.length === 0) {\n            //     showError('Selecione pelo menos um dia da semana para envio.');\n            //     return false;\n            // }\n\n            const startTime = document.getElementById('startTime').value;\n            const endTime = document.getElementById('endTime').value;\n            \n            // Validação de horários é opcional - só valida se ambos estiverem preenchidos\n            if (startTime && endTime && startTime >= endTime) {\n                console.log('❌ Horários inválidos');\n                showError('O horário de início deve ser anterior ao horário de fim.');\n                return false;\n            }\n\n            console.log('✅ Validação completa - formulário válido');\n            return true;\n        }\n\n        // Função para validar o formulário antes do disparo\n        function validateForm() {\n            const warnings = [];\n            \n            // 1. Verificar se há conexões selecionadas\n            if (selectedConnections.length === 0) {\n                warnings.push('Selecione pelo menos uma conexão');\n            } else {\n                // Verificar se alguma conexão selecionada está desconectada\n                const disconnectedConnections = connections.filter(conn => \n                    selectedConnections.includes(conn.id) && conn.isConnected !== true\n                );\n                \n                if (disconnectedConnections.length > 0) {\n                    const connectionNames = disconnectedConnections.map(conn => conn.NomeConexao).join(', ');\n                    warnings.push(`Conexão(ões) desconectada(s): ${connectionNames}`);\n                }\n            }\n            \n            // 2. Verificar se há listas selecionadas\n            if (selectedLists.length === 0) {\n                warnings.push('Selecione pelo menos uma lista');\n            }\n            \n            // 3. Verificar se há mensagens\n            const messageItems = messagesContainer.querySelectorAll('.message-item');\n            let hasValidMessages = false;\n            \n            for (let item of messageItems) {\n                const textarea = item.querySelector('textarea');\n                const text = textarea.value.trim();\n                const mediaInputs = item.querySelectorAll('input[type=\"file\"]');\n                let hasMedia = false;\n                \n                for (let input of mediaInputs) {\n                    if (input.files.length > 0) {\n                        hasMedia = true;\n                        break;\n                    }\n                }\n                \n                if (text || hasMedia) {\n                    hasValidMessages = true;\n                    break;\n                }\n            }\n            \n            if (!hasValidMessages) {\n                warnings.push('Adicione pelo menos uma mensagem (texto ou mídia)');\n            }\n            \n            // 4. Verificar se há dias selecionados\n            if (selectedDays.length === 0) {\n                warnings.push('Selecione pelo menos um dia da semana');\n            }\n            \n            return warnings;\n        }\n\n        // Função para validar e mostrar avisos apenas quando necessário\n        function updateValidationWarnings() {\n            const warnings = validateForm();\n            const validationWarnings = document.getElementById('validationWarnings');\n            const warningMessages = document.getElementById('warningMessages');\n            const dispatchBtn = document.getElementById('dispatchBtn');\n            \n            // Sempre habilita o botão - os avisos só aparecem quando clicar\n            dispatchBtn.disabled = false;\n            \n            // Esconde avisos por padrão\n            validationWarnings.classList.remove('show');\n        }\n\n        async function handleSubmit(e) {\n            console.log('🚀 handleSubmit() chamado');\n            \n            // Bloqueia o botão imediatamente para evitar múltiplos cliques\n            const dispatchBtn = document.getElementById('dispatchBtn');\n            dispatchBtn.disabled = true;\n            dispatchBtn.classList.add('loading');\n            \n            // Validar formulário antes de prosseguir\n            const warnings = validateForm();\n            if (warnings.length > 0) {\n                console.log('❌ Validação falhou:', warnings);\n                \n                // Mostra avisos de validação\n                const validationWarnings = document.getElementById('validationWarnings');\n                const warningMessages = document.getElementById('warningMessages');\n                \n                warningMessages.innerHTML = `<ul>${warnings.map(warning => `<li>${warning}</li>`).join('')}</ul>`;\n                validationWarnings.classList.add('show');\n                \n                // Reabilita o botão se houver problemas de validação\n                dispatchBtn.disabled = false;\n                dispatchBtn.classList.remove('loading');\n                \n                return; // Impede o envio se houver problemas\n            }\n            \n            // Esconde avisos se não houver problemas\n            const validationWarnings = document.getElementById('validationWarnings');\n            validationWarnings.classList.remove('show');\n            \n            // Coleta dados reais das conexões selecionadas\n            const selectedConnectionsData = connections.filter(conn => \n                selectedConnections.includes(conn.id)\n            ).map(conn => ({\n                id: conn.id,\n                instanceName: conn.instanceName,\n                nomeConexao: conn.NomeConexao,\n                telefone: conn.Telefone,\n                apikey: conn.Apikey\n            }));\n\n            // Coleta mensagens reais\n            const messageItems = messagesContainer.querySelectorAll('.message-item');\n            const messagesData = [];\n\n            for (let i = 0; i < messageItems.length; i++) {\n                const item = messageItems[i];\n                const textarea = item.querySelector('textarea');\n                const text = textarea.value.trim();\n                \n                // Verifica se há arquivo de mídia anexado\n                const mediaInputs = item.querySelectorAll('input[type=\"file\"]');\n                let mediaFile = null;\n                let mediaType = null;\n                \n                for (let input of mediaInputs) {\n                    if (input.files.length > 0) {\n                        mediaFile = input.files[0];\n                        // Determina o tipo de mídia baseado no accept do input\n                        if (input.accept.includes('image/*')) mediaType = 'image';\n                        else if (input.accept.includes('video/*')) mediaType = 'video';\n                        else if (input.accept.includes('audio/*')) mediaType = 'audio';\n                        else if (input.accept.includes('.pdf,.doc,.docx,.txt')) mediaType = 'document';\n                        break;\n                    }\n                }\n                \n                // Se tem texto ou mídia, adiciona a mensagem\n                if (text || mediaFile) {\n                    const messageObj = {};\n                    \n                    if (text) {\n                        messageObj.text = text;\n                    }\n                    \n                    if (mediaFile) {\n                        // Converte arquivo para base64\n                        const base64 = await fileToBase64(mediaFile);\n                        messageObj.media = {\n                            type: mediaType,\n                            filename: mediaFile.name,\n                            base64: base64\n                        };\n                    }\n                    \n                    messagesData.push(messageObj);\n                }\n            }\n\n            // Coleta configurações reais\n            const intervalMin = parseInt(document.getElementById('intervalMin').value) || 30;\n            const intervalMax = parseInt(document.getElementById('intervalMax').value) || 60;\n            const pauseAfterMessages = parseInt(document.getElementById('pauseAfterMessages').value) || 20;\n            const pauseMinutes = parseInt(document.getElementById('pauseMinutes').value) || 10;\n            const startTime = document.getElementById('startTime').value;\n            const endTime = document.getElementById('endTime').value;\n\n            // Verifica se o agendamento está ativo\n            const scheduleToggle = document.getElementById('scheduleToggle');\n            const scheduleDateTime = document.getElementById('scheduleDateTime').value;\n            \n            // Monta payload com dados reais\n            const settings = {};\n            \n            // Adiciona scheduleData primeiro\n            if (scheduleToggle.checked && scheduleDateTime) {\n                settings.scheduleData = new Date(scheduleDateTime).toISOString();\n            }\n            \n            // Adiciona os outros campos\n            // settings.fakecall = isMissedCallEnabled();\n            settings.intervalMin = intervalMin;\n            settings.intervalMax = intervalMax;\n            settings.pauseAfterMessages = pauseAfterMessages;\n            settings.pauseMinutes = pauseMinutes;\n            settings.startTime = startTime;\n            settings.endTime = endTime;\n            settings.selectedDays = selectedDays;\n            \n            const userId = getSecureUserId();\n            console.log('🔍 UserId obtido para disparo:', userId);\n            \n            const payload = {\n                userId: userId,\n                connections: selectedConnectionsData,\n                idLista: selectedLists,\n                messages: messagesData,\n                contacts: contacts,\n                settings: settings\n            };\n            \n            console.log('📤 Enviando disparo:', payload);\n            \n            // Faz a requisição com dados reais\n            fetch('https://n8n.typebot.pro/webhook/db56b0fb-cc58-4d51-8755-d7e04ccaa120', {\n                method: 'POST',\n                headers: {\n                    'Content-Type': 'application/json',\n                },\n                body: JSON.stringify(payload)\n            })\n            .then(response => {\n                console.log('📡 Status da resposta:', response.status);\n                return response.json();\n            })\n            .then(result => {\n                console.log('✅ Resposta da API:', result);\n                \n                // Redireciona imediatamente\n                window.location.href = 'https://n8n.typebot.pro/webhook/historico-disparos';\n            })\n            .catch(error => {\n                console.error('❌ Erro no disparo:', error);\n                \n                // Reabilita o botão em caso de erro\n                const dispatchBtn = document.getElementById('dispatchBtn');\n                dispatchBtn.disabled = false;\n                dispatchBtn.classList.remove('loading');\n                \n                // Mostra erro para o usuário\n                showError('Erro ao enviar disparo: ' + error.message);\n            });\n        }\n\n\n\n        // Função para converter arquivo para base64\n        function fileToBase64(file) {\n            return new Promise((resolve, reject) => {\n                const reader = new FileReader();\n                reader.readAsDataURL(file);\n                reader.onload = () => {\n                    // Remove o prefixo 'data:tipo/subtype;base64,'\n                    const base64 = reader.result.split(',')[1];\n                    resolve(base64);\n                };\n                reader.onerror = error => reject(error);\n            });\n        }\n\n        // Update stats when interval changes\n        document.getElementById('intervalMin').addEventListener('input', updateStats);\n        document.getElementById('intervalMax').addEventListener('input', updateStats);\n        document.getElementById('pauseAfterMessages').addEventListener('input', updateStats);\n        document.getElementById('pauseMinutes').addEventListener('input', updateStats);\n\n        // Initialize preview\n        updatePreview();\n\n        // Função global para ir para Listas autenticado\n        function goToListas() {\n            navigateToPage('https://n8n.typebot.pro/webhook/listas');\n        }\n\n        // Substitua a função toggleDay para funcionar com os novos botões\n        function toggleDayBtn(btn) {\n            const dayValue = parseInt(btn.getAttribute('data-day'));\n            if (btn.classList.contains('selected')) {\n                btn.classList.remove('selected');\n                const idx = selectedDays.indexOf(dayValue);\n                if (idx > -1) selectedDays.splice(idx, 1);\n            } else {\n                btn.classList.add('selected');\n                selectedDays.push(dayValue);\n            }\n            updateDaysFeedback();\n        }\n        function updateDaysFeedback() {\n            const feedback = document.getElementById('daysFeedback');\n            if (selectedDays.length === 0) {\n                feedback.textContent = 'Selecione os dias da semana para envio das mensagens';\n                feedback.classList.remove('selected');\n                return;\n            }\n            const dayNames = ['Domingo','Segunda','Terça','Quarta','Quinta','Sexta','Sábado'];\n            const sorted = [...selectedDays].sort((a,b)=>a-b);\n            const names = sorted.map(d=>dayNames[d]);\n            feedback.textContent = names.join(', ');\n            feedback.classList.add('selected');\n        }\n\n        // Função para controlar o toggle de agendamento\n        function toggleScheduleInput() {\n            const toggle = document.getElementById('scheduleToggle');\n            const container = document.getElementById('scheduleInputContainer');\n            const btnText = document.getElementById('btnText');\n            \n            if (toggle.checked) {\n                container.style.display = 'block';\n                // Define data mínima como agora + 1 hora\n                const now = new Date();\n                now.setHours(now.getHours() + 1);\n                const minDateTime = now.toISOString().slice(0, 16);\n                document.getElementById('scheduleDateTime').min = minDateTime;\n                // Define valor padrão como agora + 2 horas\n                now.setHours(now.getHours() + 1);\n                const defaultDateTime = now.toISOString().slice(0, 16);\n                document.getElementById('scheduleDateTime').value = defaultDateTime;\n                // Altera texto do botão para \"Agendar Disparo\"\n                btnText.textContent = 'Agendar Disparo';\n            } else {\n                container.style.display = 'none';\n                document.getElementById('scheduleDateTime').value = '';\n                // Altera texto do botão para \"Iniciar Disparo\"\n                btnText.textContent = 'Iniciar Disparo';\n            }\n        }\n\n        // Função para controlar o toggle das variáveis de tempo\n        function toggleTimeVariables(button) {\n            const container = button.closest('.time-variables-container');\n            const dropdown = container.querySelector('.time-variables-dropdown');\n            const isExpanded = dropdown.style.display === 'block';\n            \n            // Fecha todos os outros dropdowns abertos\n            document.querySelectorAll('.time-variables-dropdown').forEach(dd => {\n                if (dd !== dropdown) {\n                    dd.style.display = 'none';\n                    dd.previousElementSibling.classList.remove('expanded');\n                }\n            });\n            \n            // Toggle do dropdown atual\n            if (isExpanded) {\n                dropdown.style.display = 'none';\n                button.classList.remove('expanded');\n            } else {\n                dropdown.style.display = 'block';\n                button.classList.add('expanded');\n            }\n        }\n\n        // Fecha dropdowns ao clicar fora\n        document.addEventListener('click', function(event) {\n            if (!event.target.closest('.time-variables-container')) {\n                document.querySelectorAll('.time-variables-dropdown').forEach(dropdown => {\n                    dropdown.style.display = 'none';\n                    dropdown.previousElementSibling.classList.remove('expanded');\n                });\n            }\n        });\n\n        // Função para selecionar todas as conexões ativas\n        function selectActiveConnections() {\n            console.log('🔍 Selecionando conexões ativas...');\n            \n            // Limpa seleção atual\n            selectedConnections = [];\n            \n            // Remove seleção visual de todas as conexões\n            document.querySelectorAll('.connection-card').forEach(card => {\n                card.classList.remove('selected');\n            });\n            \n            // Seleciona apenas conexões conectadas\n            let activeCount = 0;\n            connections.forEach(connection => {\n                if (connection.isConnected === true) {\n                    const card = document.querySelector(`[data-connection-id=\"${connection.id}\"]`);\n                    if (card) {\n                        card.classList.add('selected');\n                        selectedConnections.push(connection.id);\n                        activeCount++;\n                        console.log(`✅ Conexão ativa selecionada: ${connection.NomeConexao || connection.nomeConexao || connection.name}`);\n                    }\n                }\n            });\n            \n            // Atualiza contadores e estatísticas\n            updateSelectedCount();\n            updateStats();\n            \n            if (activeCount > 0) {\n                console.log(`✅ ${activeCount} conexões ativas selecionadas`);\n                showSuccess(`${activeCount} conexões ativas selecionadas automaticamente`);\n            } else {\n                console.log('⚠️ Nenhuma conexão ativa encontrada');\n                showError('Nenhuma conexão ativa encontrada. Verifique o status das suas conexões.');\n            }\n        }\n\n        // Função para controlar o toggle de chamada perdida\n        // function toggleMissedCall() {\n        //     updatePreview();\n        // }\n\n        // Função para verificar se chamada perdida está ativa\n        // function isMissedCallEnabled() {\n        //     const toggle = document.getElementById('missedCallToggle');\n        //     return toggle ? toggle.checked : false;\n        // }\n\n        // Função para controlar o toggle de mensagens com IA\n        function toggleAIMessages() {\n            const toggle = document.getElementById('aiMessagesToggle');\n            const aiSettingsContainer = document.getElementById('aiSettingsContainer');\n            const isEnabled = toggle.checked;\n            \n            console.log(`🤖 IA para mensagens ${isEnabled ? 'ativada' : 'desativada'}`);\n            \n            if (isEnabled) {\n                aiSettingsContainer.style.display = 'block';\n                showSuccess('IA ativada! Configure as opções abaixo para gerar mensagens personalizadas.');\n            } else {\n                aiSettingsContainer.style.display = 'none';\n            }\n        }\n\n        // Função para verificar se IA está ativa\n        function isAIEnabled() {\n            const toggle = document.getElementById('aiMessagesToggle');\n            return toggle ? toggle.checked : false;\n        }\n\n        // Função para gerar mensagens com IA\n        async function generateAIMessages() {\n            const variationsCount = document.getElementById('aiVariationsCount').value;\n            const instructions = document.getElementById('aiInstructions').value;\n            const button = document.querySelector('.generate-ai-btn');\n            \n            console.log('🤖 Gerando mensagens com IA...');\n            console.log('📊 Configurações:', { variationsCount, instructions });\n            \n            // Remove avisos de erro anteriores\n            const aiSettingsContainer = document.getElementById('aiSettingsContainer');\n            if (aiSettingsContainer) {\n                const existingAlert = aiSettingsContainer.querySelector('.ai-error-alert');\n                if (existingAlert) {\n                    existingAlert.remove();\n                }\n            }\n            \n            // Validações básicas\n            if (!variationsCount || variationsCount < 1 || variationsCount > 10) {\n                showError('Quantidade de variações deve ser entre 1 e 10.');\n                return;\n            }\n            \n            // Verifica se há mensagens existentes\n            const existingMessages = messagesContainer.querySelectorAll('.message-item');\n            if (existingMessages.length === 0) {\n                showError('Adicione pelo menos uma mensagem antes de gerar variações com IA.');\n                return;\n            }\n            \n            // Obtém o userId de forma segura\n            const userId = getSecureUserId();\n            \n            if (!userId) {\n                showError('Erro: usuário não identificado. Faça login novamente.');\n                return;\n            }\n            \n            // Coleta as mensagens existentes como variações\n            const existingVariations = [];\n            existingMessages.forEach(messageItem => {\n                const textarea = messageItem.querySelector('textarea');\n                if (textarea && textarea.value.trim()) {\n                    existingVariations.push(textarea.value.trim());\n                }\n            });\n            \n            // Desabilita o botão e mostra estado de carregamento com animação\n            button.disabled = true;\n            button.style.position = 'relative';\n            button.innerHTML = `\n                <svg class=\"chatgpt-btn-icon loading-icon\" width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" style=\"animation: spin 1s linear infinite;\">\n                    <circle cx=\"12\" cy=\"12\" r=\"10\"/>\n                    <path d=\"M16 12a4 4 0 0 0-8 0\"/>\n                </svg>\n                <span>Gerando mensagens...</span>\n                <style>\n                    @keyframes spin {\n                        from { transform: rotate(0deg); }\n                        to { transform: rotate(360deg); }\n                    }\n                </style>\n            `;\n            \n            try {\n                // Prepara o payload para a API\n                const payload = {\n                    userId: userId,\n                    variacoesMensagens: existingVariations,\n                    instrucoesAdicionais: instructions || '',\n                    quantidadeMensagens: parseInt(variationsCount)\n                };\n                \n                console.log('📤 Enviando requisição para API de IA:', payload);\n                \n                // Faz a requisição POST para a API\n                const response = await fetch('https://n8n.typebot.pro/webhook/gerarmensagem-ia', {\n                    method: 'POST',\n                    headers: {\n                        'Content-Type': 'application/json',\n                    },\n                    body: JSON.stringify(payload)\n                });\n                \n                console.log('📡 Status da resposta:', response.status);\n                \n                if (!response.ok) {\n                    const errorText = await response.text();\n                    console.error('❌ Erro na resposta:', errorText);\n                    throw new Error(`Erro na requisição: ${response.status} - ${errorText}`);\n                }\n                \n                const result = await response.json();\n                console.log('✅ Resposta da API:', result);\n                \n                // Processa a resposta correta da API (aninhada em result.mensagens.mensagens)\n                if (result && result.mensagens && result.mensagens.mensagens && Array.isArray(result.mensagens.mensagens)) {\n                    const generatedMessages = result.mensagens.mensagens;\n                    \n                    // Primeiro, encontra o primeiro textarea vazio existente\n                    const existingMessages = messagesContainer.querySelectorAll('.message-item');\n                    let firstEmptyTextarea = null;\n                    \n                    for (let messageItem of existingMessages) {\n                        const textarea = messageItem.querySelector('textarea');\n                        if (textarea && !textarea.value.trim()) {\n                            firstEmptyTextarea = textarea;\n                            break;\n                        }\n                    }\n                    \n                    // Se encontrou um textarea vazio, preenche com a primeira mensagem gerada\n                    if (firstEmptyTextarea && generatedMessages.length > 0) {\n                        const firstMessage = generatedMessages[0];\n                        if (firstMessage && firstMessage.trim()) {\n                            firstEmptyTextarea.value = firstMessage;\n                            firstEmptyTextarea.dispatchEvent(new Event('input'));\n                        }\n                        \n                        // Adiciona as mensagens restantes como novos blocos\n                        for (let i = 1; i < generatedMessages.length; i++) {\n                            const mensagem = generatedMessages[i];\n                            if (mensagem && mensagem.trim()) {\n                                addMessage();\n                                \n                                // Atualiza o texto da última mensagem adicionada\n                                const lastMessage = messagesContainer.lastElementChild;\n                                const textarea = lastMessage.querySelector('textarea');\n                                if (textarea) {\n                                    textarea.value = mensagem;\n                                    textarea.dispatchEvent(new Event('input'));\n                                }\n                            }\n                        }\n                    } else {\n                        // Se não encontrou textarea vazio, adiciona todas as mensagens como novos blocos\n                        generatedMessages.forEach(mensagem => {\n                            if (mensagem && mensagem.trim()) {\n                                addMessage();\n                                \n                                // Atualiza o texto da última mensagem adicionada\n                                const lastMessage = messagesContainer.lastElementChild;\n                                const textarea = lastMessage.querySelector('textarea');\n                                if (textarea) {\n                                    textarea.value = mensagem;\n                                    textarea.dispatchEvent(new Event('input'));\n                                }\n                            }\n                        });\n                    }\n                    \n                    updateStats();\n                    updatePreview();\n                    updateVariablesForAllMessages();\n                    \n                    // Remove avisos de erro anteriores se houver\n                    const aiSettingsContainer = document.getElementById('aiSettingsContainer');\n                    if (aiSettingsContainer) {\n                        const existingAlert = aiSettingsContainer.querySelector('.ai-error-alert');\n                        if (existingAlert) {\n                            existingAlert.remove();\n                        }\n                    }\n                    \n                    showSuccess(`${generatedMessages.length} mensagens geradas com IA com sucesso!`);\n                } else {\n                    console.error('❌ Estrutura de resposta inválida:', result);\n                    throw new Error('Resposta da API não contém mensagens válidas na estrutura esperada');\n                }\n                \n            } catch (error) {\n                console.error('❌ Erro ao gerar mensagens com IA:', error);\n                \n                // Função para mostrar erro específico da IA\n                function showAIError(message, type = 'error') {\n                    const aiSettingsContainer = document.getElementById('aiSettingsContainer');\n                    if (aiSettingsContainer) {\n                        // Remove avisos anteriores\n                        const existingAlert = aiSettingsContainer.querySelector('.ai-error-alert');\n                        if (existingAlert) {\n                            existingAlert.remove();\n                        }\n                        \n                        // Cria novo aviso\n                        const alertDiv = document.createElement('div');\n                        alertDiv.className = `ai-error-alert ${type}`;\n                        alertDiv.innerHTML = `\n                            <div class=\"ai-error-content\">\n                                <svg class=\"ai-error-icon\" width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\n                                    <path d=\"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z\"/>\n                                </svg>\n                                <span>${message}</span>\n                            </div>\n                        `;\n                        \n                        // Insere no início do container\n                        aiSettingsContainer.insertBefore(alertDiv, aiSettingsContainer.firstChild);\n                        \n                        // Adiciona estilos CSS dinamicamente\n                        if (!document.getElementById('ai-error-styles')) {\n                            const style = document.createElement('style');\n                            style.id = 'ai-error-styles';\n                            style.textContent = `\n                                .ai-error-alert {\n                                    padding: 12px 16px;\n                                    border-radius: 8px;\n                                    margin-bottom: 15px;\n                                    font-size: 0.9rem;\n                                    display: flex;\n                                    align-items: center;\n                                    gap: 8px;\n                                    animation: fadeIn 0.3s ease;\n                                }\n                                \n                                .ai-error-alert.error {\n                                    background: rgba(255, 59, 48, 0.1);\n                                    border: 1px solid rgba(255, 59, 48, 0.3);\n                                    color: #ff3b30;\n                                }\n                                \n                                .ai-error-alert.warning {\n                                    background: rgba(255, 193, 7, 0.1);\n                                    border: 1px solid rgba(255, 193, 7, 0.3);\n                                    color: #ffc107;\n                                }\n                                \n                                .ai-error-content {\n                                    display: flex;\n                                    align-items: center;\n                                    gap: 8px;\n                                }\n                                \n                                .ai-error-icon {\n                                    flex-shrink: 0;\n                                }\n                                \n                                @keyframes fadeIn {\n                                    from { opacity: 0; transform: translateY(-10px); }\n                                    to { opacity: 1; transform: translateY(0); }\n                                }\n                            `;\n                            document.head.appendChild(style);\n                        }\n                    }\n                }\n                \n                                // Mensagem de erro unificada para qualquer erro da IA\n                const errorMessage = '❌ Erro ao gerar mensagens: APIKEY vazia/inválida ou sem saldo. Caso não tenha informado sua APIKEY, clique na aba conexões e coloque sua APIKEY no canto superior direito.';\n                const errorType = 'error';\n                \n                // Log do erro original para debug\n                console.error('🔍 Erro original da IA:', error);\n                \n                // Mostra o erro específico dentro do bloco de IA\n                showAIError(errorMessage, errorType);\n                \n                // Também mostra no console para debug\n                console.error('🔍 Detalhes do erro:', {\n                    message: error.message,\n                    stack: error.stack,\n                    type: errorType\n                });\n                \n            } finally {\n                // Restaura o botão\n                button.disabled = false;\n                button.style.position = '';\n                button.innerHTML = `\n                    <svg class=\"chatgpt-btn-icon\" width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\n                        <path d=\"M22.2819 9.8211a5.9847 5.9847 0 0 0-.5157-4.9108 6.0462 6.0462 0 0 0-6.5098-2.9A6.0651 6.0651 0 0 0 4.9807 4.1818a5.9847 5.9847 0 0 0-3.9977 2.9 6.0462 6.0462 0 0 0 .7427 7.0966 5.98 5.98 0 0 0 .511 4.9107 6.051 6.051 0 0 0 6.5146 2.9001A5.9847 5.9847 0 0 0 13.2599 24a6.0557 6.0557 0 0 0 5.7718-4.2058 5.9894 5.9894 0 0 0 3.9977-2.9001 6.0557 6.0557 0 0 0-.7475-7.0729zm-9.022 12.6081a4.4755 4.4755 0 0 1-2.8764-1.0408l.1419-.0804 4.7783-2.7582a.7948.7948 0 0 0 .3927-.6813v-6.7369l2.02 1.1686a.071.071 0 0 1 .038.052v5.5826a4.504 4.504 0 0 1-4.4945 4.4944zm-9.6607-4.1254a4.4708 4.4708 0 0 1-.5346-3.0137l.142-.0852 4.783-2.7582a.7712.7712 0 0 0 .7806 0l5.8428 3.3685v2.3324a.0804.0804 0 0 1-.0332.0615L9.74 19.9502a4.4992 4.4992 0 0 1-6.1408-1.6464zM2.3408 7.8956a4.485 4.485 0 0 1 2.3655-1.9728V11.6a.7664.7664 0 0 0 .3879.6765l5.8144 3.3543-2.0201 1.1685a.0757.0757 0 0 1-.071 0l-4.8303-2.7865A4.504 4.504 0 0 1 2.3408 7.872zm16.5963 3.8558L13.1038 8.364 15.1192 7.2a.0757.0757 0 0 1 .071 0l4.8303 2.7913a4.4944 4.4944 0 0 1-.6765 8.1042v-5.6772a.79.79 0 0 0-.407-.667zm2.0107-3.0231l-.142-.0852-4.7735-2.7818a.7759.7759 0 0 0-.7854 0L9.409 9.2297V6.8974a.0662.0662 0 0 1 .0284-.0615l4.8303-2.7866a4.4992 4.4992 0 0 1 6.6802 4.66zM8.3065 12.863l-2.02-1.1638a.0804.0804 0 0 1-.038-.0567V6.0742a4.4992 4.4992 0 0 1 7.3757-3.4537l-.142.0805L8.704 5.459a.7948.7948 0 0 0-.3927.6813zm1.0976-2.3654l2.602-1.4998 2.6069 1.4998v2.9994l-2.5974 1.4997-2.6067-1.4997Z\"/>\n                    </svg>\n                    <span>Gerar mensagens com IA</span>\n                `;\n            }\n        }\n\n        // Função para simular geração de mensagens com IA\n        function simulateAIGeneration(count, instructions) {\n            const baseMessages = [\n                'Olá {nome}, como você está?',\n                'Oi {nome}, tudo bem?',\n                'Olá {nome}, espero que esteja bem!'\n            ];\n            \n            const aiVariations = [\n                'Olá {nome}! 👋 Como você está hoje?',\n                'Oi {nome}! 😊 Tudo bem com você?',\n                'Olá {nome}! 🌟 Espero que esteja tendo um ótimo dia!',\n                'Oi {nome}! ✨ Como vai a vida?',\n                'Olá {nome}! 🎉 Tudo tranquilo?',\n                'Oi {nome}! 💫 Como você está se sentindo?',\n                'Olá {nome}! 🚀 Tudo bem por aí?',\n                'Oi {nome}! ⭐ Como vai?'\n            ];\n            \n            // Primeiro, encontra o primeiro textarea vazio existente\n            const existingMessages = messagesContainer.querySelectorAll('.message-item');\n            let firstEmptyTextarea = null;\n            \n            for (let messageItem of existingMessages) {\n                const textarea = messageItem.querySelector('textarea');\n                if (textarea && !textarea.value.trim()) {\n                    firstEmptyTextarea = textarea;\n                    break;\n                }\n            }\n            \n            // Se encontrou um textarea vazio, preenche com a primeira mensagem gerada\n            if (firstEmptyTextarea && count > 0) {\n                const firstMessageText = aiVariations[0];\n                if (firstMessageText && firstMessageText.trim()) {\n                    firstEmptyTextarea.value = firstMessageText;\n                    firstEmptyTextarea.dispatchEvent(new Event('input'));\n                }\n                \n                // Adiciona as mensagens restantes como novos blocos\n                for (let i = 1; i < count; i++) {\n                    const messageText = aiVariations[i % aiVariations.length];\n                    addMessage();\n                    \n                    // Atualiza o texto da última mensagem adicionada\n                    const lastMessage = messagesContainer.lastElementChild;\n                    const textarea = lastMessage.querySelector('textarea');\n                    if (textarea) {\n                        textarea.value = messageText;\n                        textarea.dispatchEvent(new Event('input'));\n                    }\n                }\n            } else {\n                // Se não encontrou textarea vazio, adiciona todas as mensagens como novos blocos\n                for (let i = 0; i < count; i++) {\n                    const messageText = aiVariations[i % aiVariations.length];\n                    addMessage();\n                    \n                    // Atualiza o texto da última mensagem adicionada\n                    const lastMessage = messagesContainer.lastElementChild;\n                    const textarea = lastMessage.querySelector('textarea');\n                    if (textarea) {\n                        textarea.value = messageText;\n                        textarea.dispatchEvent(new Event('input'));\n                    }\n                }\n            }\n            \n            updateStats();\n            updatePreview();\n        }\n\n        // Função de logout\n        function logout() {\n            console.log('🚪 Iniciando logout...');\n            \n            // Limpar todos os cookies\n            document.cookie = 'userId=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';\n            document.cookie = 'idLista=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';\n            document.cookie = 'idConexao=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';\n            document.cookie = 'idDisparo=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';\n            \n            // Limpar sessionStorage\n            sessionStorage.clear();\n            \n            console.log('🧹 Cookies e sessionStorage limpos');\n            console.log('🔄 Redirecionando para login...');\n            \n            // Redirecionar para página de login\n            window.location.href = 'https://n8n.typebot.pro/webhook/login';\n        }\n    </script>\n</body>\n</html>"},"type":"n8n-nodes-base.html","typeVersion":1.2,"position":[-4240,-6816],"id":"bde6cfc6-239d-4e81-8b34-db1911ac7c6c","name":"HTML1"},{"parameters":{"respondWith":"text","responseBody":"={{ $json.html }}","options":{}},"type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-4016,-6816],"id":"9181a6c2-219d-4964-9259-7234796e04e1","name":"Respond to Webhook"},{"parameters":{"path":"conectar","responseMode":"responseNode","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-4432,-7104],"id":"36edceee-155f-4160-8cd2-5c1eeee24215","name":"CRIAR CONEXAO","webhookId":"bffe6be0-84a5-4250-8695-636b89e17afd"},{"parameters":{"content":"## Criar conexão","height":260,"width":760,"color":2},"type":"n8n-nodes-base.stickyNote","position":[-4512,-7216],"typeVersion":1,"id":"e1b50fa3-46fc-42e4-ae59-3d56ff71af0f","name":"Sticky Note"},{"parameters":{"content":"## Tela de disparo","height":260,"width":760,"color":2},"type":"n8n-nodes-base.stickyNote","position":[-4512,-6912],"typeVersion":1,"id":"4c81d589-c949-435a-9bf6-d2304e06abfd","name":"Sticky Note1"},{"parameters":{"httpMethod":"POST","path":"verificar-login","responseMode":"lastNode","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-3488,-7312],"id":"70909527-93e7-4a49-bbea-2c90913598be","name":"VERIFICAR LOGIN","webhookId":"76823ad5-23f1-41ef-9087-61bedea2556d"},{"parameters":{"content":"## Tela de login\n","height":260,"width":760,"color":2},"type":"n8n-nodes-base.stickyNote","position":[-4512,-7504],"typeVersion":1,"id":"f30200c4-7e17-4300-b342-ddbe826402a2","name":"Sticky Note5"},{"parameters":{"path":"login","responseMode":"responseNode","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-4448,-7408],"id":"712274d8-674b-4177-a20e-42900cbef096","name":"LOGIN","webhookId":"44ef5672-bb5e-47cb-8c16-50d5ffb78a8c"},{"parameters":{"html":"<!DOCTYPE html>\n<html lang=\"pt-BR\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>Login - EnviaZap</title>\n    <style>\n        * {\n            margin: 0;\n            padding: 0;\n            box-sizing: border-box;\n        }\n\n        body {\n            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);\n            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n            color: white;\n            min-height: 100vh;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            padding: 20px;\n        }\n\n        .login-container {\n            max-width: 450px;\n            width: 100%;\n        }\n\n        .header {\n            text-align: center;\n            margin-bottom: 40px;\n        }\n\n        .logo {\n            width: 80px;\n            height: 80px;\n            background: linear-gradient(135deg, #25d366 0%, #128c7e 100%);\n            border-radius: 20px;\n            display: none;\n            align-items: center;\n            justify-content: center;\n            margin: 0 auto 20px;\n            font-size: 2.5rem;\n        }\n\n        .header h1 {\n            font-size: 2.5rem;\n            font-weight: 600;\n            margin-bottom: 10px;\n            background: linear-gradient(135deg, #25d366 0%, #128c7e 100%);\n            -webkit-background-clip: text;\n            -webkit-text-fill-color: transparent;\n            background-clip: text;\n        }\n\n        .header p {\n            color: #888;\n            font-size: 1rem;\n            line-height: 1.5;\n        }\n\n        .login-form {\n            background: rgba(255, 255, 255, 0.02);\n            border: 1px solid rgba(255, 255, 255, 0.1);\n            border-radius: 16px;\n            padding: 40px;\n            backdrop-filter: blur(10px);\n            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);\n        }\n\n        .form-group {\n            margin-bottom: 25px;\n        }\n\n        .form-group label {\n            color: #fff;\n            font-weight: 500;\n            margin-bottom: 8px;\n            font-size: 0.95rem;\n            display: block;\n        }\n\n        .form-group input {\n            width: 100%;\n            padding: 15px;\n            background: rgba(255, 255, 255, 0.05);\n            border: 1px solid rgba(255, 255, 255, 0.2);\n            border-radius: 8px;\n            color: white;\n            font-size: 1rem;\n            outline: none;\n            transition: all 0.3s ease;\n        }\n\n        .form-group input::placeholder {\n            color: #888;\n        }\n\n        .form-group input:focus {\n            border-color: #25d366;\n            box-shadow: 0 0 0 2px rgba(37, 211, 102, 0.2);\n        }\n\n        .form-group input:invalid {\n            border-color: rgba(255, 59, 48, 0.5);\n        }\n\n        .password-container {\n            position: relative;\n        }\n\n        .toggle-password {\n            position: absolute;\n            right: 12px;\n            top: 50%;\n            transform: translateY(-50%);\n            background: none;\n            border: none;\n            color: #888;\n            cursor: pointer;\n            padding: 5px;\n            border-radius: 4px;\n            transition: all 0.3s ease;\n            font-size: 1.1rem;\n        }\n\n        .toggle-password:hover {\n            color: #25d366;\n            background: rgba(255, 255, 255, 0.05);\n        }\n\n        .eye-icon {\n            display: block;\n        }\n\n        .login-btn {\n            width: 100%;\n            padding: 18px;\n            background: linear-gradient(135deg, #25d366 0%, #128c7e 100%);\n            border: none;\n            border-radius: 12px;\n            color: white;\n            font-size: 1.1rem;\n            font-weight: 600;\n            cursor: pointer;\n            transition: all 0.3s ease;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            gap: 10px;\n            margin-bottom: 20px;\n        }\n\n        .login-btn:hover {\n            transform: translateY(-2px);\n            box-shadow: 0 12px 30px rgba(37, 211, 102, 0.4);\n        }\n\n        .login-btn:disabled {\n            background: #444;\n            cursor: not-allowed;\n            transform: none;\n            box-shadow: none;\n        }\n\n        .loading-spinner {\n            width: 20px;\n            height: 20px;\n            border: 2px solid rgba(255, 255, 255, 0.3);\n            border-top: 2px solid white;\n            border-radius: 50%;\n            animation: spin 1s linear infinite;\n            display: none;\n        }\n\n        .login-btn.loading .loading-spinner {\n            display: block;\n        }\n\n        .success-message,\n        .error-message {\n            padding: 15px 20px;\n            border-radius: 8px;\n            margin-bottom: 20px;\n            display: none;\n            text-align: center;\n        }\n\n        .success-message {\n            background: rgba(52, 199, 89, 0.1);\n            border: 1px solid rgba(52, 199, 89, 0.3);\n            color: #34c759;\n        }\n\n        .error-message {\n            background: rgba(255, 59, 48, 0.1);\n            border: 1px solid rgba(255, 59, 48, 0.3);\n            color: #ff3b30;\n        }\n\n        .success-message.show,\n        .error-message.show {\n            display: block;\n        }\n\n        .features {\n            margin-top: 30px;\n            text-align: center;\n        }\n\n        .features h3 {\n            color: #25d366;\n            margin-bottom: 15px;\n            font-size: 1.1rem;\n        }\n\n        .feature-list {\n            display: grid;\n            grid-template-columns: 1fr 1fr;\n            gap: 15px;\n            margin-top: 20px;\n        }\n\n        .feature-item {\n            background: rgba(255, 255, 255, 0.02);\n            border: 1px solid rgba(255, 255, 255, 0.1);\n            border-radius: 8px;\n            padding: 15px;\n            text-align: center;\n        }\n\n        .feature-icon {\n            font-size: 1.5rem;\n            margin-bottom: 8px;\n            display: block;\n        }\n\n        .feature-text {\n            color: #888;\n            font-size: 0.8rem;\n        }\n\n        .divider {\n            height: 1px;\n            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);\n            margin: 30px 0;\n        }\n\n        .footer {\n            text-align: center;\n            margin-top: 30px;\n            color: #666;\n            font-size: 0.8rem;\n        }\n\n        @keyframes spin {\n            0% { transform: rotate(0deg); }\n            100% { transform: rotate(360deg); }\n        }\n\n        @keyframes fadeIn {\n            from {\n                opacity: 0;\n                transform: translateY(20px);\n            }\n            to {\n                opacity: 1;\n                transform: translateY(0);\n            }\n        }\n\n        .login-container {\n            animation: fadeIn 0.6s ease-out;\n        }\n\n        /* Responsive */\n        @media (max-width: 768px) {\n            .header h1 {\n                font-size: 2rem;\n            }\n            \n            .login-form {\n                padding: 30px 25px;\n            }\n\n            .feature-list {\n                grid-template-columns: 1fr;\n                gap: 10px;\n            }\n        }\n\n        /* Security indicators */\n        .security-info {\n            background: rgba(37, 211, 102, 0.05);\n            border: 1px solid rgba(37, 211, 102, 0.2);\n            border-radius: 8px;\n            padding: 15px;\n            margin-top: 20px;\n            display: flex;\n            align-items: center;\n            gap: 10px;\n        }\n\n        .security-icon {\n            color: #25d366;\n            font-size: 1.2rem;\n        }\n\n        .security-text {\n            color: #888;\n            font-size: 0.85rem;\n            line-height: 1.4;\n        }\n    </style>\n</head>\n<body>\n    <div class=\"login-container\">\n        <div class=\"header\">\n            <h1>EnviaZap</h1>\n            <p>Acesse sua conta para gerenciar suas campanhas de mensagens</p>\n        </div>\n\n        <div class=\"login-form\">\n            <form id=\"loginForm\">\n                <div class=\"success-message\" id=\"successMessage\"></div>\n                <div class=\"error-message\" id=\"errorMessage\"></div>\n\n                <div class=\"form-group\">\n                    <label for=\"email\">E-mail *</label>\n                    <input \n                        type=\"email\" \n                        id=\"email\" \n                        name=\"email\" \n                        placeholder=\"seu@email.com\" \n                        required \n                        autocomplete=\"email\"\n                    >\n                </div>\n\n                <div class=\"form-group\">\n                    <label for=\"password\">Senha *</label>\n                    <div class=\"password-container\">\n                        <input \n                            type=\"password\" \n                            id=\"password\" \n                            name=\"password\" \n                            placeholder=\"Digite sua senha\" \n                            required \n                            autocomplete=\"current-password\"\n                        >\n                        <button type=\"button\" class=\"toggle-password\" id=\"togglePassword\">\n                            <span class=\"eye-icon\">👁️</span>\n                        </button>\n                    </div>\n                </div>\n\n                <button type=\"submit\" class=\"login-btn\" id=\"loginBtn\">\n                    <div class=\"loading-spinner\"></div>\n                    <span id=\"btnText\">🔐 Entrar</span>\n                </button>\n            </form>\n\n            <div class=\"security-info\">\n                <span class=\"security-icon\">🔒</span>\n                <div class=\"security-text\">\n                    Seus dados estão protegidos com criptografia de ponta a ponta\n                </div>\n            </div>\n        </div>\n\n        <div class=\"footer\">\n            <p>© 2025 EnviaZap • Plataforma segura e confiável</p>\n        </div>\n    </div>\n\n    <script>\n        // Elementos do DOM\n        const loginForm = document.getElementById('loginForm');\n        const emailInput = document.getElementById('email');\n        const passwordInput = document.getElementById('password');\n        const togglePassword = document.getElementById('togglePassword');\n        const loginBtn = document.getElementById('loginBtn');\n        const btnText = document.getElementById('btnText');\n        const successMessage = document.getElementById('successMessage');\n        const errorMessage = document.getElementById('errorMessage');\n\n        // 🍪 Função para salvar cookies\n        function setCookie(name, value, days = 7) {\n            const expires = new Date();\n            expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));\n            document.cookie = `${name}=${value};expires=${expires.toUTCString()};path=/;SameSite=Strict`;\n        }\n\n        // Funções de feedback\n        function showSuccess(message) {\n            successMessage.textContent = message;\n            successMessage.classList.add('show');\n            errorMessage.classList.remove('show');\n            setTimeout(() => {\n                successMessage.classList.remove('show');\n            }, 5000);\n        }\n\n        function showError(message) {\n            errorMessage.textContent = message;\n            errorMessage.classList.add('show');\n            successMessage.classList.remove('show');\n            \n            // Resetar campo de senha quando erro\n            passwordInput.value = '';\n            passwordInput.focus();\n            \n            setTimeout(() => {\n                errorMessage.classList.remove('show');\n            }, 5000);\n        }\n\n        function setLoading(loading) {\n            if (loading) {\n                loginBtn.classList.add('loading');\n                loginBtn.disabled = true;\n                btnText.textContent = 'Verificando...';\n            } else {\n                loginBtn.classList.remove('loading');\n                loginBtn.disabled = false;\n                btnText.textContent = '🔐 Entrar';\n            }\n        }\n\n        // Validação em tempo real\n        function validateEmail(email) {\n            const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n            return emailRegex.test(email);\n        }\n\n        function validateForm() {\n            const email = emailInput.value.trim();\n            const password = passwordInput.value.trim();\n            \n            if (!email) {\n                showError('Por favor, digite seu e-mail.');\n                emailInput.focus();\n                return false;\n            }\n            \n            if (!validateEmail(email)) {\n                showError('Por favor, digite um e-mail válido.');\n                emailInput.focus();\n                return false;\n            }\n            \n            if (!password) {\n                showError('Por favor, digite sua senha.');\n                passwordInput.focus();\n                return false;\n            }\n            \n            if (password.length < 6) {\n                showError('A senha deve ter pelo menos 6 caracteres.');\n                passwordInput.focus();\n                return false;\n            }\n            \n            return true;\n        }\n\n\n\n        // Submissão do formulário\n        loginForm.addEventListener('submit', async function(e) {\n            e.preventDefault();\n            \n            // Limpar mensagens anteriores\n            successMessage.classList.remove('show');\n            errorMessage.classList.remove('show');\n            \n            // Validar formulário\n            if (!validateForm()) {\n                return;\n            }\n            \n            const email = emailInput.value.trim();\n            const password = passwordInput.value.trim();\n            \n            setLoading(true);\n            \n            try {\n                console.log('Enviando requisição de login...');\n                \n                const response = await fetch('https://n8n.typebot.pro/webhook/verificar-login', {\n                    method: 'POST',\n                    headers: {\n                        'Content-Type': 'application/json',\n                    },\n                    body: JSON.stringify({\n                        email: email,\n                        senha: password\n                    })\n                });\n                \n                console.log('Status da resposta:', response.status);\n                \n                // Se for erro 500 (sem resposta), tratar como credenciais inválidas\n                if (response.status === 500) {\n                    showError('❌ E-mail ou senha incorretos. Tente novamente.');\n                    return;\n                }\n                \n                const data = await response.json();\n                console.log('Dados recebidos:', data);\n                \n                if (!response.ok) {\n                    throw new Error(data.message || `Erro ${response.status}: ${response.statusText}`);\n                }\n                \n                // Verificar se o acesso foi liberado (resposta vem em array)\n                let accessStatus = null;\n                let userId = null;\n                \n                if (Array.isArray(data) && data.length > 0) {\n                    // Se for array, verificar o primeiro item\n                    const userData = data[0];\n                    accessStatus = userData.acesso;\n                    userId = userData.userId || userData.id;\n                } else if (data.acesso) {\n                    // Se for objeto direto\n                    accessStatus = data.acesso;\n                    userId = data.userId || data.id;\n                }\n                \n                console.log('Status de acesso:', accessStatus);\n                console.log('UserId recebido:', userId);\n                \n                if (accessStatus === 'liberado' && userId) {\n                    showSuccess('✅ Login realizado com sucesso! Redirecionando...');\n                    \n                    // Salvar informações de login (opcional)\n                    localStorage.setItem('userEmail', email);\n                    localStorage.setItem('loginTime', new Date().toISOString());\n                    \n                    // Salvar userId nos cookies\n                    setCookie('userId', userId, 7); // 7 dias de duração\n                    \n                    // Redirecionar para o dashboard após 2 segundos\n                    setTimeout(() => {\n                        window.location.href = 'https://n8n.typebot.pro/webhook/dashboard';\n                    }, 2000);\n                    \n                } else if (accessStatus === 'liberado' && !userId) {\n                    showError('❌ Erro no sistema: UserId não recebido. Contate o suporte.');\n                } else if (accessStatus === 'negado') {\n                    // Usuário ou senha incorretos\n                    showError('❌ E-mail ou senha incorretos. Tente novamente.');\n                } else if (accessStatus === 'bloqueado') {\n                    // Acesso bloqueado - deve contatar suporte\n                    showError('🚫 Acesso bloqueado. Entre em contato com o suporte para liberação.');\n                } else {\n                    // Status não reconhecido ou não retornado\n                    showError('❌ Erro de autenticação. Tente novamente ou contate o suporte.');\n                }\n                \n            } catch (error) {\n                console.error('Erro no login:', error);\n                \n                // Se for erro de rede ou JSON inválido, tratar como credenciais inválidas\n                if (error.name === 'TypeError' || error.message.includes('JSON')) {\n                    showError('❌ E-mail ou senha incorretos. Tente novamente.');\n                } else {\n                    showError(`Erro ao fazer login: ${error.message}`);\n                }\n            } finally {\n                setLoading(false);\n            }\n        });\n\n        // Funcionalidade do botão de mostrar/ocultar senha\n        togglePassword.addEventListener('click', function() {\n            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';\n            passwordInput.setAttribute('type', type);\n            \n            // Trocar ícone\n            const eyeIcon = togglePassword.querySelector('.eye-icon');\n            eyeIcon.textContent = type === 'password' ? '👁️' : '🙈';\n        });\n\n        // Limpar mensagens quando o usuário começar a digitar\n        emailInput.addEventListener('input', function() {\n            if (errorMessage.classList.contains('show')) {\n                errorMessage.classList.remove('show');\n            }\n        });\n\n        passwordInput.addEventListener('input', function() {\n            if (errorMessage.classList.contains('show')) {\n                errorMessage.classList.remove('show');\n            }\n        });\n\n        // Enter para submeter\n        passwordInput.addEventListener('keypress', function(e) {\n            if (e.key === 'Enter') {\n                loginForm.dispatchEvent(new Event('submit'));\n            }\n        });\n\n        // Auto focus no email\n        emailInput.focus();\n\n        console.log('Script de login carregado com sucesso');\n\n\n    </script>\n</body>\n</html>"},"type":"n8n-nodes-base.html","typeVersion":1.2,"position":[-4240,-7408],"id":"d7557094-2999-455f-974a-5eae072f3d85","name":"HTML2"},{"parameters":{"respondWith":"text","responseBody":"={{ $json.html }}","options":{}},"type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-4016,-7408],"id":"2cc29983-d941-477a-b6c6-dd935cc57709","name":"Respond to Webhook2"},{"parameters":{"operation":"getAll","tableId":"SAAS_Usuarios","filters":{"conditions":[{"keyName":"Email","condition":"eq","keyValue":"={{ $json.body.email }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-3296,-7312],"id":"abf5f8b4-2447-45a2-956a-a87050e91d7f","name":"LOCALIZAR EMAIL","credentials":{"supabaseApi":{"id":"gSmzosOueGcVRiU6","name":"supabase enviazap"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"ec5237dd-e47c-4866-a485-3fbfd0fcd14a","leftValue":"={{ $json.senha }}","rightValue":"={{ $('VERIFICAR LOGIN').item.json.body.senha }}","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-3072,-7312],"id":"725c61f8-bbc0-4a86-9a19-978f09c98add","name":"If"},{"parameters":{"assignments":{"assignments":[{"id":"f8f7118b-6718-4985-bf2d-43d1e0ec2830","name":"acesso","value":"liberado","type":"string"},{"id":"29e00872-3b30-439b-b232-4ba2519bf4f7","name":"userId","value":"={{ $json.id }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-2496,-7472],"id":"93a5cf59-837b-4e2e-9f1e-1710f4a73d88","name":"LIBERADO"},{"parameters":{"assignments":{"assignments":[{"id":"f8f7118b-6718-4985-bf2d-43d1e0ec2830","name":"acesso","value":"negado","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-2496,-7152],"id":"42da9bc8-21f2-423d-9005-09d044acba82","name":"NEGADO"},{"parameters":{"content":"## Login","height":480,"width":1380,"color":4},"type":"n8n-nodes-base.stickyNote","position":[-3600,-7504],"typeVersion":1,"id":"b04c8f3e-b27f-45e8-baba-7cc5a2385c52","name":"Sticky Note6"},{"parameters":{"content":"## Gerenciar conexões\n","height":500,"width":1240,"color":4},"type":"n8n-nodes-base.stickyNote","position":[-3600,-6992],"typeVersion":1,"id":"fdddcc91-7a19-4d06-aa85-648f655db09b","name":"Sticky Note7"},{"parameters":{"method":"POST","url":"https://whatsapi.typebot.pro/instance/create","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apikey","value":"b4d71f9c38e3ac12a6b08e4b6d53aa90"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n\"instanceName\": \"{{ $json.body.instanceName }} - {{ Array.from({length: 6}, () => String.fromCharCode(65 + Math.floor(Math.random() * 26))).join('') }}\",\n\"qrcode\": true,\n\"integration\": \"WHATSAPP-BAILEYS\"\n}","options":{"redirect":{"redirect":{}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-3280,-6896],"id":"ecbedd80-e4f9-4a89-9a44-c69097f56278","name":"CRIAR INSTANCIA"},{"parameters":{"tableId":"SAAS_Conexões","fieldsUi":{"fieldValues":[{"fieldId":"instanceName","fieldValue":"={{ $json.instance.instanceName }}"},{"fieldId":"NomeConexao","fieldValue":"={{ $('CRIAR CONEXAO2').item.json.body.instanceName }}"},{"fieldId":"idUsuario","fieldValue":"={{ $('CRIAR CONEXAO2').item.json.body.userId }}"},{"fieldId":"Apikey","fieldValue":"={{ $json.hash }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-3056,-6896],"id":"45de430b-a60b-49cd-884e-5a6557cc8f1f","name":"CRIAR CONEXAO1","credentials":{"supabaseApi":{"id":"gSmzosOueGcVRiU6","name":"supabase enviazap"}}},{"parameters":{"assignments":{"assignments":[{"id":"c16002cb-6afa-4ec1-8cdf-f8b5108f3af8","name":"qrcode","value":"={{ $('CRIAR INSTANCIA').item.json.qrcode.base64 }}","type":"string"},{"id":"2ff275e6-f183-400c-a140-3ec2779f8147","name":"instanceName","value":"={{ $('CRIAR INSTANCIA').item.json.instance.instanceName }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-2848,-6896],"id":"75e2b178-d600-4c58-a16c-ee580ff02fcc","name":"RESPOSTA"},{"parameters":{"content":"## Salvar telefone e foto","height":400,"width":1200,"color":4},"type":"n8n-nodes-base.stickyNote","position":[-3600,-6448],"typeVersion":1,"id":"60176441-467e-41b2-9745-187ff56990ca","name":"Sticky Note8"},{"parameters":{"httpMethod":"POST","path":"salvarfoto","responseMode":"lastNode","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-3536,-6288],"id":"73123aa9-b47a-46d5-9770-9b14bc2e3810","name":"Webhook3","webhookId":"0d210c58-1258-4a4b-a3ff-c6b5d1e7b9fc"},{"parameters":{"assignments":{"assignments":[{"id":"c16002cb-6afa-4ec1-8cdf-f8b5108f3af8","name":"resposta","value":"=Foto salva com sucesso!","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-2672,-6288],"id":"a3eb5b5b-b38e-46cd-86ee-0e03a35c9d7c","name":"RESPOSTA1"},{"parameters":{"url":"https://whatsapi.typebot.pro/instance/fetchInstances","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apikey","value":"={{ $json.Apikey }}"}]},"options":{"redirect":{"redirect":{}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-3088,-6288],"id":"7f157e70-658b-456c-bd34-3e223d01a319","name":"BUSCAR FOTO PERFIL"},{"parameters":{"operation":"getAll","tableId":"SAAS_Conexões","matchType":"allFilters","filters":{"conditions":[{"keyName":"idUsuario","condition":"eq","keyValue":"={{ $json.body.userId }}"},{"keyName":"instanceName","condition":"eq","keyValue":"={{ $json.body.instanceName }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-3312,-6288],"id":"5c550a17-9866-4efa-ae7b-a21e97807783","name":"BUSCAR CONEXAO","credentials":{"supabaseApi":{"id":"gSmzosOueGcVRiU6","name":"supabase enviazap"}}},{"parameters":{"operation":"update","tableId":"SAAS_Conexões","matchType":"allFilters","filters":{"conditions":[{"keyName":"instanceName","condition":"eq","keyValue":"={{ $('Webhook3').item.json.body.instanceName }}"}]},"fieldsUi":{"fieldValues":[{"fieldId":"FotoPerfil","fieldValue":"={{ $json.profilePicUrl }}"},{"fieldId":"Telefone","fieldValue":"={{ $json.ownerJid.replaceAll('@s.whatsapp.net','') }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-2880,-6288],"id":"2bfed994-5bfd-427c-9c5d-c34f599e17b0","name":"SALVAR FOTO","credentials":{"supabaseApi":{"id":"gSmzosOueGcVRiU6","name":"supabase enviazap"}}},{"parameters":{"content":"## LISTAR CONEXOES\n","height":400,"width":1200,"color":4},"type":"n8n-nodes-base.stickyNote","position":[-3600,-6016],"typeVersion":1,"id":"a87e1a7e-2cde-4286-8fe5-52f95673c59a","name":"Sticky Note9"},{"parameters":{"httpMethod":"POST","path":"listarconexoes","responseMode":"lastNode","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-3536,-5856],"id":"76370e1a-28b2-4d13-8da7-3a7073b2e426","name":"Webhook4","webhookId":"0d210c58-1258-4a4b-a3ff-c6b5d1e7b9fc"},{"parameters":{"assignments":{"assignments":[{"id":"c16002cb-6afa-4ec1-8cdf-f8b5108f3af8","name":"Conexoes","value":"={{ $json.data }}","type":"array"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-2832,-5856],"id":"5d491bda-8fb6-4684-9a6b-001ad510c182","name":"RESPOSTA2"},{"parameters":{"operation":"getAll","tableId":"SAAS_Conexões","matchType":"allFilters","filters":{"conditions":[{"keyName":"idUsuario","condition":"eq","keyValue":"={{ $json.body.userId }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-3312,-5856],"id":"eccad02a-1087-43cc-ad63-189acc563225","name":"BUSCAR CONEXAO1","alwaysOutputData":true,"credentials":{"supabaseApi":{"id":"gSmzosOueGcVRiU6","name":"supabase enviazap"}}},{"parameters":{"aggregate":"aggregateAllItemData","options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[-3088,-5856],"id":"fc0b333b-8f7d-443e-a112-e194e7ad53db","name":"Aggregate"},{"parameters":{"content":"## Tela de Conexões","height":260,"width":760,"color":2},"type":"n8n-nodes-base.stickyNote","position":[-4512,-6608],"typeVersion":1,"id":"1f2bdca2-0024-446b-8b53-d3ead376a83a","name":"Sticky Note10"},{"parameters":{"path":"conexoes","responseMode":"responseNode","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-4448,-6512],"id":"fbb2e3d6-d866-4f4a-8ed2-ab9846dcf805","name":"LOGIN1","webhookId":"44ef5672-bb5e-47cb-8c16-50d5ffb78a8c"},{"parameters":{"html":"<!DOCTYPE html>\n<html lang=\"pt-BR\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>Conexões - EnviaZap</title>\n    <style>\n        * {\n            margin: 0;\n            padding: 0;\n            box-sizing: border-box;\n        }\n\n        body {\n            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);\n            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n            color: white;\n            min-height: 100vh;\n            margin: 0;\n            padding: 0;\n        }\n\n        .app-layout {\n            display: flex;\n            min-height: 100vh;\n        }\n\n        /* Sidebar */\n        .sidebar {\n            width: 70px;\n            background: rgba(0, 0, 0, 0.3);\n            backdrop-filter: blur(10px);\n            border-right: 1px solid rgba(255, 255, 255, 0.1);\n            transition: all 0.3s ease;\n            position: relative;\n            z-index: 1000;\n            display: flex;\n            flex-direction: column;\n            height: 100vh;\n        }\n\n        .sidebar:hover {\n            width: 250px;\n        }\n\n        .sidebar-header {\n            padding: 20px;\n            text-align: center;\n            border-bottom: 1px solid rgba(255, 255, 255, 0.1);\n        }\n\n        .sidebar-logo {\n            font-size: 1.5rem;\n            font-weight: 600;\n            background: linear-gradient(135deg, #25d366 0%, #128c7e 100%);\n            -webkit-background-clip: text;\n            -webkit-text-fill-color: transparent;\n            background-clip: text;\n            white-space: nowrap;\n            opacity: 0;\n            transition: opacity 0.3s ease;\n        }\n\n        .sidebar:hover .sidebar-logo {\n            opacity: 1;\n        }\n\n        .sidebar-menu {\n            padding: 20px 0;\n            flex: 1;\n        }\n\n        .menu-item {\n            display: flex;\n            align-items: center;\n            padding: 15px 20px;\n            color: #ccc;\n            text-decoration: none;\n            transition: all 0.3s ease;\n            position: relative;\n            white-space: nowrap;\n        }\n\n        .menu-item:hover {\n            background: rgba(37, 211, 102, 0.1);\n            color: #25d366;\n        }\n\n        .menu-item.active {\n            background: rgba(37, 211, 102, 0.2);\n            color: #25d366;\n            border-right: 3px solid #25d366;\n        }\n\n        .menu-icon {\n            font-size: 1.2rem;\n            width: 30px;\n            text-align: center;\n            flex-shrink: 0;\n        }\n\n        .menu-text {\n            margin-left: 15px;\n            opacity: 0;\n            transition: opacity 0.3s ease;\n        }\n\n        .sidebar:hover .menu-text {\n            opacity: 1;\n        }\n\n        .sidebar-footer {\n            margin-top: auto;\n            border-top: 1px solid rgba(255, 255, 255, 0.1);\n            padding: 10px 0;\n        }\n\n        .logout-item {\n            color: #ff6b6b !important;\n        }\n\n        .logout-item:hover {\n            background: rgba(255, 107, 107, 0.1) !important;\n            color: #ff6b6b !important;\n        }\n\n        /* Main content */\n        .main-content {\n            flex: 1;\n            padding: 30px;\n            overflow-x: auto;\n        }\n\n        .header {\n            margin-bottom: 40px;\n            display: flex;\n            justify-content: space-between;\n            align-items: flex-start;\n            gap: 20px;\n        }\n\n        .header-content h1 {\n            font-size: 2.5rem;\n            font-weight: 600;\n            margin-bottom: 10px;\n        }\n\n        .header-content p {\n            color: #888;\n            font-size: 1.1rem;\n        }\n\n        .header-actions {\n            display: flex;\n            align-items: center;\n            gap: 15px;\n        }\n\n\n\n\n\n        .btn-chatgpt {\n            padding: 12px 20px;\n            background: linear-gradient(135deg, #10a37f 0%, #0d8f6b 100%);\n            border: none;\n            border-radius: 8px;\n            color: white;\n            font-weight: 600;\n            cursor: pointer;\n            transition: all 0.3s ease;\n            display: flex;\n            align-items: center;\n            gap: 8px;\n            font-size: 0.9rem;\n            white-space: nowrap;\n        }\n\n        .btn-chatgpt:hover {\n            transform: translateY(-2px);\n            box-shadow: 0 8px 25px rgba(16, 163, 127, 0.3);\n        }\n\n        .chatgpt-icon {\n            width: 16px;\n            height: 16px;\n            fill: currentColor;\n        }\n\n        /* Loading state */\n        .loading-container {\n            display: flex;\n            flex-direction: column;\n            align-items: center;\n            justify-content: center;\n            min-height: 400px;\n            gap: 20px;\n        }\n\n        .loading-spinner {\n            width: 60px;\n            height: 60px;\n            border: 4px solid rgba(37, 211, 102, 0.3);\n            border-top: 4px solid #25d366;\n            border-radius: 50%;\n            animation: spin 1s linear infinite;\n        }\n\n        .loading-text {\n            color: #25d366;\n            font-size: 1.2rem;\n            font-weight: 500;\n        }\n\n        /* Conexões Grid */\n        .conexoes-grid {\n            display: grid;\n            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));\n            gap: 25px;\n            margin-top: 20px;\n        }\n\n        .conexao-card {\n            background: rgba(255, 255, 255, 0.02);\n            border: 1px solid rgba(255, 255, 255, 0.1);\n            border-radius: 16px;\n            padding: 25px;\n            backdrop-filter: blur(10px);\n            transition: all 0.3s ease;\n            position: relative;\n        }\n\n        .conexao-card:hover {\n            transform: translateY(-5px);\n            border-color: rgba(37, 211, 102, 0.3);\n            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);\n        }\n\n        .conexao-header {\n            display: flex;\n            align-items: center;\n            gap: 15px;\n            margin-bottom: 20px;\n        }\n\n        .profile-photo {\n            width: 60px;\n            height: 60px;\n            border-radius: 50%;\n            border: 2px solid rgba(37, 211, 102, 0.3);\n            object-fit: cover;\n            background: rgba(255, 255, 255, 0.1);\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            font-size: 1.5rem;\n        }\n\n        .conexao-info h3 {\n            font-size: 1.2rem;\n            font-weight: 600;\n            margin-bottom: 5px;\n            color: #fff;\n        }\n\n        .telefone {\n            color: #888;\n            font-size: 0.95rem;\n        }\n\n        .status-badge {\n            position: absolute;\n            top: 20px;\n            right: 20px;\n            padding: 6px 12px;\n            border-radius: 20px;\n            font-size: 0.8rem;\n            font-weight: 600;\n        }\n\n        .status-conectado {\n            background: rgba(52, 199, 89, 0.2);\n            color: #34c759;\n            border: 1px solid rgba(52, 199, 89, 0.3);\n        }\n\n        .status-desconectado {\n            background: rgba(255, 59, 48, 0.2);\n            color: #ff3b30;\n            border: 1px solid rgba(255, 59, 48, 0.3);\n        }\n\n        .status-verificando {\n            background: rgba(255, 193, 7, 0.2);\n            color: #ffc107;\n            border: 1px solid rgba(255, 193, 7, 0.3);\n        }\n\n        .conexao-actions {\n            display: flex;\n            gap: 10px;\n            margin-top: 20px;\n        }\n\n        .btn-verificar {\n            flex: 1;\n            padding: 12px;\n            background: linear-gradient(135deg, #25d366 0%, #128c7e 100%);\n            border: none;\n            border-radius: 8px;\n            color: white;\n            font-weight: 600;\n            cursor: pointer;\n            transition: all 0.3s ease;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            gap: 8px;\n        }\n\n        .btn-verificar:hover {\n            transform: translateY(-2px);\n            box-shadow: 0 8px 25px rgba(37, 211, 102, 0.3);\n        }\n\n        .btn-verificar:disabled {\n            background: #444;\n            cursor: not-allowed;\n            transform: none;\n        }\n\n        .btn-excluir {\n            padding: 12px;\n            background: rgba(255, 59, 48, 0.1);\n            border: 1px solid rgba(255, 59, 48, 0.3);\n            border-radius: 8px;\n            color: #ff3b30;\n            cursor: pointer;\n            transition: all 0.3s ease;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n        }\n\n        .btn-excluir:hover {\n            background: rgba(255, 59, 48, 0.2);\n            transform: translateY(-2px);\n        }\n\n        .btn-qrcode {\n            flex: 1;\n            padding: 12px;\n            background: rgba(37, 211, 102, 0.1);\n            border: 1px solid rgba(37, 211, 102, 0.3);\n            border-radius: 8px;\n            color: #25d366;\n            font-weight: 600;\n            cursor: pointer;\n            transition: all 0.3s ease;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            gap: 8px;\n        }\n\n        .btn-qrcode:hover {\n            background: rgba(37, 211, 102, 0.2);\n            transform: translateY(-2px);\n        }\n\n        /* QR Code Modal */\n        .qr-modal {\n            position: fixed;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n            background: rgba(0, 0, 0, 0.8);\n            backdrop-filter: blur(10px);\n            display: none;\n            align-items: center;\n            justify-content: center;\n            z-index: 10000;\n        }\n\n        .qr-modal.show {\n            display: flex;\n        }\n\n        .qr-modal-content {\n            background: rgba(255, 255, 255, 0.02);\n            border: 1px solid rgba(255, 255, 255, 0.1);\n            border-radius: 20px;\n            padding: 40px;\n            backdrop-filter: blur(20px);\n            text-align: center;\n            max-width: 400px;\n            width: 90%;\n        }\n\n        .qr-modal h3 {\n            color: #25d366;\n            margin-bottom: 20px;\n            font-size: 1.3rem;\n        }\n\n        .qr-code-container {\n            background: white;\n            padding: 20px;\n            border-radius: 16px;\n            margin: 20px 0;\n            display: inline-block;\n        }\n\n        .qr-code-container img {\n            width: 250px;\n            height: 250px;\n            object-fit: contain;\n        }\n\n        .qr-timer {\n            color: #25d366;\n            font-size: 0.9rem;\n            margin: 15px 0;\n        }\n\n        .qr-close {\n            background: rgba(255, 255, 255, 0.1);\n            border: 1px solid rgba(255, 255, 255, 0.2);\n            color: white;\n            padding: 12px 24px;\n            border-radius: 8px;\n            cursor: pointer;\n            transition: all 0.3s ease;\n        }\n\n        .qr-close:hover {\n            background: rgba(255, 255, 255, 0.2);\n        }\n\n        /* ChatGPT API Key Modal */\n        .chatgpt-modal {\n            position: fixed;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n            background: rgba(0, 0, 0, 0.8);\n            backdrop-filter: blur(10px);\n            display: none;\n            align-items: center;\n            justify-content: center;\n            z-index: 10000;\n        }\n\n        .chatgpt-modal.show {\n            display: flex;\n        }\n\n        .chatgpt-modal-content {\n            background: rgba(255, 255, 255, 0.02);\n            border: 1px solid rgba(255, 255, 255, 0.1);\n            border-radius: 20px;\n            padding: 40px;\n            backdrop-filter: blur(20px);\n            max-width: 500px;\n            width: 90%;\n        }\n\n        .chatgpt-modal h3 {\n            color: #10a37f;\n            margin-bottom: 20px;\n            font-size: 1.4rem;\n            display: flex;\n            align-items: center;\n            gap: 10px;\n        }\n\n        .chatgpt-modal-body {\n            margin: 20px 0;\n        }\n\n        .form-group-modal {\n            margin-bottom: 20px;\n        }\n\n        .form-group-modal label {\n            display: block;\n            color: #fff;\n            font-weight: 500;\n            margin-bottom: 8px;\n            font-size: 0.95rem;\n        }\n\n        .form-group-modal input {\n            width: 100%;\n            background: rgba(255, 255, 255, 0.05);\n            border: 1px solid rgba(255, 255, 255, 0.2);\n            border-radius: 8px;\n            padding: 12px 15px;\n            color: white;\n            font-size: 1rem;\n            outline: none;\n            transition: all 0.3s ease;\n        }\n\n        .form-group-modal input:focus {\n            border-color: #10a37f;\n            box-shadow: 0 0 0 2px rgba(16, 163, 127, 0.2);\n        }\n\n        .form-group-modal input::placeholder {\n            color: #888;\n        }\n\n        .chatgpt-modal-actions {\n            display: flex;\n            gap: 15px;\n            justify-content: flex-end;\n            margin-top: 30px;\n        }\n\n        .btn-modal-cancel {\n            background: rgba(255, 255, 255, 0.1);\n            border: 1px solid rgba(255, 255, 255, 0.2);\n            color: white;\n            padding: 12px 24px;\n            border-radius: 8px;\n            cursor: pointer;\n            transition: all 0.3s ease;\n            font-weight: 500;\n        }\n\n        .btn-modal-cancel:hover {\n            background: rgba(255, 255, 255, 0.2);\n        }\n\n        .btn-modal-save {\n            background: linear-gradient(135deg, #10a37f 0%, #0d8f6b 100%);\n            border: none;\n            color: white;\n            padding: 12px 24px;\n            border-radius: 8px;\n            cursor: pointer;\n            transition: all 0.3s ease;\n            font-weight: 600;\n            display: flex;\n            align-items: center;\n            gap: 8px;\n        }\n\n        .btn-modal-save:hover {\n            transform: translateY(-2px);\n            box-shadow: 0 8px 25px rgba(16, 163, 127, 0.3);\n        }\n\n        .btn-modal-save:disabled {\n            background: #444;\n            cursor: not-allowed;\n            transform: none;\n            box-shadow: none;\n        }\n\n        /* Empty state */\n        .empty-state {\n            text-align: center;\n            padding: 60px 20px;\n            color: #888;\n        }\n\n        .empty-icon {\n            font-size: 4rem;\n            margin-bottom: 20px;\n            opacity: 0.5;\n        }\n\n        .empty-state h3 {\n            font-size: 1.5rem;\n            margin-bottom: 10px;\n            color: #ccc;\n        }\n\n        .empty-state p {\n            font-size: 1rem;\n            line-height: 1.5;\n        }\n\n        /* Error/Success messages */\n        .error-message, .success-message {\n            padding: 20px;\n            border-radius: 12px;\n            margin: 20px 0;\n            text-align: center;\n        }\n\n        .error-message {\n            background: rgba(255, 59, 48, 0.1);\n            border: 1px solid rgba(255, 59, 48, 0.3);\n            color: #ff3b30;\n        }\n\n        .success-message {\n            background: rgba(52, 199, 89, 0.1);\n            border: 1px solid rgba(52, 199, 89, 0.3);\n            color: #34c759;\n        }\n\n        /* Animations */\n        @keyframes spin {\n            0% { transform: rotate(0deg); }\n            100% { transform: rotate(360deg); }\n        }\n\n        @keyframes fadeIn {\n            from { opacity: 0; transform: translateY(20px); }\n            to { opacity: 1; transform: translateY(0); }\n        }\n\n        .conexao-card {\n            animation: fadeIn 0.5s ease-out;\n        }\n\n\n        @media (max-width: 768px) {\n            .main-content {\n                padding: 20px;\n            }\n\n            .header {\n                flex-direction: column;\n                align-items: stretch;\n                gap: 20px;\n            }\n\n            .header-content h1 {\n                font-size: 2rem;\n            }\n\n            .header-actions {\n                justify-content: center;\n            }\n\n            .btn-chatgpt {\n                font-size: 0.85rem;\n                padding: 10px 16px;\n            }\n\n            .conexoes-grid {\n                grid-template-columns: 1fr;\n                gap: 20px;\n            }\n\n            .sidebar {\n                width: 60px;\n            }\n\n            .sidebar:hover {\n                width: 200px;\n            }\n\n            .chatgpt-modal-content {\n                padding: 30px 20px;\n                margin: 20px;\n            }\n        }\n    </style>\n</head>\n<body>\n    <div class=\"app-layout\">\n        <!-- Sidebar -->\n        <div class=\"sidebar\">\n            <div class=\"sidebar-header\">\n                <div class=\"sidebar-logo\">EnviaZap</div>\n            </div>\n            <nav class=\"sidebar-menu\">\n                <a href=\"#\" class=\"menu-item\" onclick=\"navigateToPage('https://n8n.typebot.pro/webhook/dashboard')\">\n                    <span class=\"menu-icon\">📊</span>\n                    <span class=\"menu-text\">Dashboard</span>\n                </a>\n                <a href=\"#\" class=\"menu-item\" onclick=\"navigateToPage('https://n8n.typebot.pro/webhook/historico-disparos')\">\n                    <span class=\"menu-icon\">📋</span>\n                    <span class=\"menu-text\">Histórico de disparos</span>\n                </a>\n                <a href=\"#\" class=\"menu-item\" onclick=\"navigateToPage('https://n8n.typebot.pro/webhook/conectar')\">\n                    <span class=\"menu-icon\">🔗</span>\n                    <span class=\"menu-text\">Nova Conexão</span>\n                </a>\n                <a href=\"#\" class=\"menu-item active\">\n                    <span class=\"menu-icon\">🔌</span>\n                    <span class=\"menu-text\">Conexões</span>\n                </a>\n                <a href=\"#\" class=\"menu-item\" onclick=\"navigateToPage('https://n8n.typebot.pro/webhook/disparos-individuais')\">\n                    <span class=\"menu-icon\">📱</span>\n                    <span class=\"menu-text\">Disparos individuais</span>\n                </a>\n                <a href=\"#\" class=\"menu-item\" onclick=\"navigateToPage('https://n8n.typebot.pro/webhook/disparos-grupos')\">\n                    <span class=\"menu-icon\">👥</span>\n                    <span class=\"menu-text\">Disparos em grupo</span>\n                </a>\n                <a href=\"#\" class=\"menu-item\" onclick=\"navigateToPage('https://n8n.typebot.pro/webhook/listas')\">\n                    <span class=\"menu-icon\">📝</span>\n                    <span class=\"menu-text\">Listas</span>\n                </a>\n            </nav>\n            <div class=\"sidebar-footer\">\n                <a href=\"#\" class=\"menu-item logout-item\" onclick=\"logout()\">\n                    <span class=\"menu-icon\">🚪</span>\n                    <span class=\"menu-text\">Sair</span>\n                </a>\n            </div>\n        </div>\n\n        <!-- Main Content -->\n        <div class=\"main-content\">\n            <div class=\"header\">\n                <div class=\"header-content\">\n                <h1>Conexões WhatsApp</h1>\n                <p>Gerencie todas as suas conexões do WhatsApp em um só lugar</p>\n                </div>\n                <div class=\"header-actions\">\n                    <button class=\"btn-chatgpt\" onclick=\"abrirModalChatGPT()\">\n                        <svg class=\"chatgpt-icon\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\n                            <path d=\"M22.2819 9.8211a5.9847 5.9847 0 0 0-.5157-4.9108 6.0462 6.0462 0 0 0-6.5098-2.9A6.0651 6.0651 0 0 0 4.9807 4.1818a5.9847 5.9847 0 0 0-3.9977 2.9 6.0462 6.0462 0 0 0 .7427 7.0966 5.98 5.98 0 0 0 .511 4.9107 6.051 6.051 0 0 0 6.5146 2.9001A5.9847 5.9847 0 0 0 13.2599 24a6.0557 6.0557 0 0 0 5.7718-4.2058 5.9894 5.9894 0 0 0 3.9977-2.9001 6.0557 6.0557 0 0 0-.7475-7.0729zm-9.022 12.6081a4.4755 4.4755 0 0 1-2.8764-1.0408l.1419-.0804 4.7783-2.7582a.7948.7948 0 0 0 .3927-.6813v-6.7369l2.02 1.1686a.071.071 0 0 1 .038.052v5.5826a4.504 4.504 0 0 1-4.4945 4.4944zm-9.6607-4.1254a4.4708 4.4708 0 0 1-.5346-3.0137l.142-.0852 4.783-2.7582a.7712.7712 0 0 0 .7806 0l5.8428 3.3685v2.3324a.0804.0804 0 0 1-.0332.0615L9.74 19.9502a4.4992 4.4992 0 0 1-6.1408-1.6464zM2.3408 7.8956a4.485 4.485 0 0 1 2.3655-1.9728V11.6a.7664.7664 0 0 0 .3879.6765l5.8144 3.3543-2.0201 1.1685a.0757.0757 0 0 1-.071 0l-4.8303-2.7865A4.504 4.504 0 0 1 2.3408 7.872zm16.5963 3.8558L13.1038 8.364 15.1192 7.2a.0757.0757 0 0 1 .071 0l4.8303 2.7913a4.4944 4.4944 0 0 1-.6765 8.1042v-5.6772a.79.79 0 0 0-.407-.667zm2.0107-3.0231l-.142-.0852-4.7735-2.7818a.7759.7759 0 0 0-.7854 0L9.409 9.2297V6.8974a.0662.0662 0 0 1 .0284-.0615l4.8303-2.7866a4.4992 4.4992 0 0 1 6.6802 4.66zM8.3065 12.863l-2.02-1.1638a.0804.0804 0 0 1-.038-.0567V6.0742a4.4992 4.4992 0 0 1 7.3757-3.4537l-.142.0805L8.704 5.459a.7948.7948 0 0 0-.3927.6813zm1.0976-2.3654l2.602-1.4998 2.6069 1.4998v2.9994l-2.5974 1.4997-2.6067-1.4997Z\"/>\n                        </svg>\n                        ApiKey ChatGPT\n                    </button>\n                </div>\n            </div>\n\n            <!-- Loading State -->\n            <div class=\"loading-container\" id=\"loadingContainer\">\n                <div class=\"loading-spinner\"></div>\n                <div class=\"loading-text\">Buscando conexões...</div>\n            </div>\n\n            <!-- Error Message -->\n            <div class=\"error-message\" id=\"errorMessage\" style=\"display: none;\"></div>\n\n            <!-- Success Message -->\n            <div class=\"success-message\" id=\"successMessage\" style=\"display: none;\"></div>\n\n            <!-- Conexões Grid -->\n            <div class=\"conexoes-grid\" id=\"conexoesGrid\" style=\"display: none;\"></div>\n\n            <!-- Empty State -->\n            <div class=\"empty-state\" id=\"emptyState\" style=\"display: none;\">\n                <div class=\"empty-icon\">📱</div>\n                <h3>Nenhuma conexão encontrada</h3>\n                <p>Você ainda não possui conexões WhatsApp.<br>Clique em \"Nova Conexão\" para começar.</p>\n            </div>\n        </div>\n    </div>\n\n    <!-- QR Code Modal -->\n    <div class=\"qr-modal\" id=\"qrModal\">\n        <div class=\"qr-modal-content\">\n            <h3>Escaneie o QR Code</h3>\n            <div class=\"qr-code-container\">\n                <img id=\"qrImage\" src=\"\" alt=\"QR Code\">\n            </div>\n            <div class=\"qr-timer\" id=\"qrTimer\">Expira em 29 segundos</div>\n            <button class=\"qr-close\" id=\"closeQrModal\">Fechar</button>\n        </div>\n    </div>\n\n    <!-- ChatGPT API Key Modal -->\n    <div class=\"chatgpt-modal\" id=\"chatgptModal\">\n        <div class=\"chatgpt-modal-content\">\n            <h3>\n                <svg class=\"chatgpt-icon\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\n                    <path d=\"M22.2819 9.8211a5.9847 5.9847 0 0 0-.5157-4.9108 6.0462 6.0462 0 0 0-6.5098-2.9A6.0651 6.0651 0 0 0 4.9807 4.1818a5.9847 5.9847 0 0 0-3.9977 2.9 6.0462 6.0462 0 0 0 .7427 7.0966 5.98 5.98 0 0 0 .511 4.9107 6.051 6.051 0 0 0 6.5146 2.9001A5.9847 5.9847 0 0 0 13.2599 24a6.0557 6.0557 0 0 0 5.7718-4.2058 5.9894 5.9894 0 0 0 3.9977-2.9001 6.0557 6.0557 0 0 0-.7475-7.0729zm-9.022 12.6081a4.4755 4.4755 0 0 1-2.8764-1.0408l.1419-.0804 4.7783-2.7582a.7948.7948 0 0 0 .3927-.6813v-6.7369l2.02 1.1686a.071.071 0 0 1 .038.052v5.5826a4.504 4.504 0 0 1-4.4945 4.4944zm-9.6607-4.1254a4.4708 4.4708 0 0 1-.5346-3.0137l.142-.0852 4.783-2.7582a.7712.7712 0 0 0 .7806 0l5.8428 3.3685v2.3324a.0804.0804 0 0 1-.0332.0615L9.74 19.9502a4.4992 4.4992 0 0 1-6.1408-1.6464zM2.3408 7.8956a4.485 4.485 0 0 1 2.3655-1.9728V11.6a.7664.7664 0 0 0 .3879.6765l5.8144 3.3543-2.0201 1.1685a.0757.0757 0 0 1-.071 0l-4.8303-2.7865A4.504 4.504 0 0 1 2.3408 7.872zm16.5963 3.8558L13.1038 8.364 15.1192 7.2a.0757.0757 0 0 1 .071 0l4.8303 2.7913a4.4944 4.4944 0 0 1-.6765 8.1042v-5.6772a.79.79 0 0 0-.407-.667zm2.0107-3.0231l-.142-.0852-4.7735-2.7818a.7759.7759 0 0 0-.7854 0L9.409 9.2297V6.8974a.0662.0662 0 0 1 .0284-.0615l4.8303-2.7866a4.4992 4.4992 0 0 1 6.6802 4.66zM8.3065 12.863l-2.02-1.1638a.0804.0804 0 0 1-.038-.0567V6.0742a4.4992 4.4992 0 0 1 7.3757-3.4537l-.142.0805L8.704 5.459a.7948.7948 0 0 0-.3927.6813zm1.0976-2.3654l2.602-1.4998 2.6069 1.4998v2.9994l-2.5974 1.4997-2.6067-1.4997Z\"/>\n                </svg>\n                Configurar API Key do ChatGPT\n            </h3>\n            <div class=\"chatgpt-modal-body\">\n                <div class=\"form-group-modal\">\n                    <label for=\"apiKeyInput\">API Key do ChatGPT:</label>\n                    <input \n                        type=\"password\" \n                        id=\"apiKeyInput\" \n                        placeholder=\"sk-...\" \n                        autocomplete=\"off\"\n                    >\n                </div>\n                <p style=\"color: #888; font-size: 0.9rem; margin-top: 10px;\">\n                    Esta chave será usada para gerar mensagens personalizadas com inteligência artificial.\n                </p>\n            </div>\n            <div class=\"chatgpt-modal-actions\">\n                <button class=\"btn-modal-cancel\" onclick=\"fecharModalChatGPT()\">\n                    Cancelar\n                </button>\n                <button class=\"btn-modal-save\" id=\"btnSalvarApiKey\" onclick=\"salvarApiKeyChatGPT()\">\n                    💾 Salvar\n                </button>\n            </div>\n        </div>\n    </div>\n\n    <script>\n        // 🍪 Funções para gerenciar cookies\n        function setCookie(name, value, days = 7) {\n            const expires = new Date();\n            expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));\n            document.cookie = `${name}=${value};expires=${expires.toUTCString()};path=/;SameSite=Strict`;\n        }\n\n        function getCookie(name) {\n            const nameEQ = name + \"=\";\n            const ca = document.cookie.split(';');\n            for(let i = 0; i < ca.length; i++) {\n                let c = ca[i];\n                while (c.charAt(0) === ' ') c = c.substring(1, c.length);\n                if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);\n            }\n            return null;\n        }\n\n        function deleteCookie(name) {\n            document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/;`;\n        }\n\n        // Função para obter userId de forma segura via cookies\n        function getSecureUserId() {\n            const userId = getCookie('userId');\n            if (userId && /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(userId)) {\n                console.log('✅ UserId (UUID) obtido dos cookies:', userId);\n                return userId;\n            }\n            console.error('❌ UserId (UUID) não encontrado ou formato inválido nos cookies!');\n            return null;\n        }\n\n        // Autenticação obrigatória ao carregar a página\n        function checkAuth() {\n            const userId = getSecureUserId();\n            if (!userId) {\n                window.location.href = 'https://n8n.typebot.pro/webhook/login';\n            }\n        }\n\n        // Navegação simplificada (sem parâmetros de autenticação)\n        function navigateToPage(url) {\n            window.location.href = url;\n        }\n\n        // Verificar autenticação ao carregar a página\n        checkAuth();\n\n        // Variáveis globais\n        let conexoesList = [];\n        let qrTimer = null;\n        let connectionChecker = null;\n        let currentReconnectInstance = null;\n\n        // Funções de UI\n        function showError(message) {\n            const errorEl = document.getElementById('errorMessage');\n            errorEl.textContent = message;\n            errorEl.style.display = 'block';\n            setTimeout(() => {\n                errorEl.style.display = 'none';\n            }, 5000);\n        }\n\n        function showSuccess(message) {\n            const successEl = document.getElementById('successMessage');\n            successEl.textContent = message;\n            successEl.style.display = 'block';\n            setTimeout(() => {\n                successEl.style.display = 'none';\n            }, 3000);\n        }\n\n        function hideLoading() {\n            document.getElementById('loadingContainer').style.display = 'none';\n        }\n\n        function showConexoes() {\n            document.getElementById('conexoesGrid').style.display = 'grid';\n        }\n\n        function showEmptyState() {\n            document.getElementById('emptyState').style.display = 'block';\n        }\n\n        // Simular dados para demonstração (apenas no ambiente Claude)\n        function setupDemoData() {\n            const isClaudeEnvironment = window.location.hostname.includes('claude.ai') || \n                                      window.location.hostname.includes('anthropic') ||\n                                      window.location.protocol === 'blob:';\n                                      \n            if (isClaudeEnvironment) {\n                console.log('Ambiente de demonstração detectado - configurando dados simulados');\n                \n                // Dados de exemplo\n                const demoConexoes = [\n                    {\n                        nome: 'WhatsApp Pessoal',\n                        telefone: '+55 11 99999-1234',\n                        instanceName: 'pessoal_ABC123',\n                        foto: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMzAiIGN5PSIzMCIgcj0iMzAiIGZpbGw9IiMyNWQzNjYiLz4KPHN2ZyB4PSIxNSIgeT0iMTUiIHdpZHRoPSIzMCIgaGVpZ2h0PSIzMCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJ3aGl0ZSI+CjxwYXRoIGQ9Ik0xMiAyQzYuNDggMiAyIDYuNDggMiAxMnM0LjQ4IDEwIDEwIDEwaDEwVjEyQzIyIDYuNDggMTcuNTIgMiAxMiAyem0wIDNjMS42NiAwIDMgMS4zNCAzIDNzLTEuMzQgMy0zIDMtMy0xLjM0LTMtMyAxLjM0LTMgMy0zem0wIDEyLjJjLTIuNSAwLTQuNzEtMS4yOC02LTMuMjJjLjAzLTEuOTkgNC0zLjA4IDYtMy4wOHM1Ljk3IDEuMDkgNiAzLjA4QzE2LjcxIDE1LjkyIDE0LjUgMTcuMiAxMiAxNy4yeiIvPgo8L3N2Zz4KPC9zdmc+'\n                    },\n                    {\n                        nome: 'WhatsApp Comercial',\n                        telefone: '+55 11 88888-5678',\n                        instanceName: 'comercial_DEF456',\n                        foto: null\n                    },\n                    {\n                        nome: 'Suporte Cliente',\n                        telefone: '+55 11 77777-9012',\n                        instanceName: 'suporte_GHI789',\n                        foto: null\n                    }\n                ];\n                \n                return demoConexoes;\n            }\n            \n            return null;\n        }\n\n        // Carregar conexões\n        async function carregarConexoes() {\n            console.log('=== INICIANDO CARREGAMENTO DE CONEXÕES ===');\n            \n            const userId = getSecureUserId();\n            console.log('UserId obtido:', userId);\n\n            try {\n                // Verificar se é ambiente de demo\n                const demoData = setupDemoData();\n                if (demoData) {\n                    console.log('=== MODO DEMONSTRAÇÃO ===');\n                    console.log('Simulando carregamento...');\n                    \n                    // Simular delay de loading\n                    await new Promise(resolve => setTimeout(resolve, 2000));\n                    \n                    console.log('Dados de demo carregados:', demoData);\n                    conexoesList = demoData;\n                    \n                    hideLoading();\n                    \n                    if (conexoesList.length === 0) {\n                        showEmptyState();\n                    } else {\n                        renderConexoes();\n                        showConexoes();\n                        verificarTodasConexoes();\n                    }\n                    return;\n                }\n                \n                console.log('=== MODO PRODUÇÃO ===');\n                console.log('Fazendo requisição para API...');\n                \n                // Fazer requisição real\n                const response = await fetch('https://n8n.typebot.pro/webhook/listarconexoes', {\n                    method: 'POST',\n                    headers: {\n                        'Content-Type': 'application/json'\n                    },\n                    body: JSON.stringify({\n                        userId: userId\n                    })\n                });\n\n                console.log('Status da resposta:', response.status);\n\n                if (!response.ok) {\n                    throw new Error(`Erro ${response.status}: ${response.statusText}`);\n                }\n\n                const data = await response.json();\n                console.log('Conexões recebidas da API:', data);\n\n                // Processar a estrutura da resposta: [{\"Conexoes\": [...]}]\n                let processedConexoes = [];\n                if (Array.isArray(data) && data.length > 0 && data[0].Conexoes) {\n                    // Estrutura: [{\"Conexoes\": [...]}]\n                    processedConexoes = data[0].Conexoes;\n                } else if (Array.isArray(data)) {\n                    // Estrutura: [...]\n                    processedConexoes = data;\n                } else if (data && data.Conexoes) {\n                    // Estrutura: {\"Conexoes\": [...]}\n                    processedConexoes = data.Conexoes;\n                }\n\n                console.log('Conexões brutas recebidas:', processedConexoes);\n\n                // Filtrar apenas objetos válidos com propriedades essenciais\n                const conexoesValidas = processedConexoes.filter(conexao => {\n                    // Verificar se é um objeto válido e não vazio\n                    if (!conexao || typeof conexao !== 'object') {\n                        return false;\n                    }\n                    \n                    // Verificar se tem pelo menos uma propriedade essencial\n                    const temNome = conexao.NomeConexao || conexao.nomeConexao || conexao.nome;\n                    const temInstance = conexao.instanceName || conexao.instance_name;\n                    \n                    return temNome || temInstance;\n                });\n\n                console.log(`${conexoesValidas.length} de ${processedConexoes.length} conexões são válidas`);\n\n                // Mapear os campos para o formato esperado\n                conexoesList = conexoesValidas.map(conexao => ({\n                    nome: conexao.NomeConexao || conexao.nomeConexao || conexao.nome || 'Conexão sem nome',\n                    telefone: conexao.Telefone || conexao.telefone || 'Telefone não disponível',\n                    instanceName: conexao.instanceName || conexao.instance_name,\n                    foto: conexao.FotoPerfil || conexao.foto || null,\n                    id: conexao.id\n                }));\n\n                console.log('Conexões processadas:', conexoesList);\n                \n                hideLoading();\n                \n                if (conexoesList.length === 0) {\n                    showEmptyState();\n                } else {\n                    renderConexoes();\n                    showConexoes();\n                    verificarTodasConexoes();\n                }\n\n            } catch (error) {\n                console.error('ERRO ao carregar conexões:', error);\n                hideLoading();\n                showError('Erro ao carregar conexões: ' + error.message);\n            }\n        }\n\n        // Renderizar conexões\n        function renderConexoes() {\n            const grid = document.getElementById('conexoesGrid');\n            grid.innerHTML = '';\n\n            conexoesList.forEach((conexao, index) => {\n                const card = createConexaoCard(conexao, index);\n                grid.appendChild(card);\n            });\n        }\n\n        // Criar card de conexão\n        function createConexaoCard(conexao, index) {\n            const card = document.createElement('div');\n            card.className = 'conexao-card';\n            card.dataset.index = index;\n\n            // Validar dados da conexão\n            const nomeSeguro = (conexao.nome && typeof conexao.nome === 'string') ? conexao.nome : 'Conexão sem nome';\n            const telefoneSeguro = (conexao.telefone && typeof conexao.telefone === 'string') ? conexao.telefone : 'Telefone não disponível';\n            const instanceNameSeguro = (conexao.instanceName && typeof conexao.instanceName === 'string') ? conexao.instanceName : 'instance_indefinida';\n            const fotoSegura = (conexao.foto && typeof conexao.foto === 'string') ? conexao.foto : null;\n\n            const photoElement = fotoSegura ? \n                `<img src=\"${fotoSegura}\" alt=\"Foto de perfil\" class=\"profile-photo\">` :\n                `<div class=\"profile-photo\">👤</div>`;\n\n            card.innerHTML = `\n                <div class=\"status-badge status-verificando\" id=\"status-${index}\">\n                    Verificando...\n                </div>\n                <div class=\"conexao-header\">\n                    ${photoElement}\n                    <div class=\"conexao-info\">\n                        <h3>${nomeSeguro}</h3>\n                        <div class=\"telefone\">${telefoneSeguro}</div>\n                    </div>\n                </div>\n                <div class=\"conexao-actions\">\n                    <button class=\"btn-verificar\" onclick=\"verificarConexao('${instanceNameSeguro}', ${index})\" id=\"btn-verificar-${index}\">\n                        🔄 Verificar\n                    </button>\n                    <button class=\"btn-qrcode\" onclick=\"gerarQRCode('${instanceNameSeguro}', ${index})\" id=\"btn-qrcode-${index}\" style=\"display: none;\">\n                        📱 Conectar\n                    </button>\n                    <button class=\"btn-excluir\" onclick=\"excluirConexao('${instanceNameSeguro}', ${index})\">\n                        🗑️\n                    </button>\n                </div>\n            `;\n\n            return card;\n        }\n\n        // Verificar todas as conexões em paralelo\n        async function verificarTodasConexoes() {\n            console.log('🚀 Iniciando verificação paralela de todas as conexões...');\n            \n            // Verificar se há conexões para verificar\n            const conexoesValidas = conexoesList.filter(conexao => conexao.instanceName);\n            if (conexoesValidas.length === 0) {\n                console.log('⚠️ Nenhuma conexão válida para verificar');\n                return;\n            }\n            \n\n            \n            // Marcar todos os status como \"Verificando...\"\n            conexoesList.forEach((conexao, index) => {\n                const statusEl = document.getElementById(`status-${index}`);\n                if (statusEl) {\n                    statusEl.textContent = 'Verificando...';\n                    statusEl.className = 'status-badge status-verificando';\n                }\n            });\n            \n            // Criar array de promessas para verificação paralela com timeout\n            const verificacoes = conexoesValidas.map((conexao, index) => {\n                const originalIndex = conexoesList.findIndex(c => c.instanceName === conexao.instanceName);\n                return verificarConexaoComTimeout(conexao.instanceName, originalIndex, true);\n            });\n            \n            // Executar todas as verificações em paralelo\n            try {\n                const resultados = await Promise.allSettled(verificacoes);\n                console.log('✅ Todas as verificações de conexão concluídas em paralelo');\n                \n                // Contar sucessos e falhas\n                const sucessos = resultados.filter(r => r.status === 'fulfilled').length;\n                const falhas = resultados.filter(r => r.status === 'rejected').length;\n                \n                console.log(`📊 Resultados: ${sucessos} sucessos, ${falhas} falhas`);\n                \n\n            } catch (error) {\n                console.error('❌ Erro durante verificação paralela:', error);\n                \n\n            }\n        }\n\n        // Verificar conexão individual com timeout\n        async function verificarConexaoComTimeout(instanceName, index, silent = false) {\n            const timeout = 10000; // 10 segundos de timeout\n            \n            try {\n                const resultado = await Promise.race([\n                    verificarConexao(instanceName, index, silent),\n                    new Promise((_, reject) => \n                        setTimeout(() => reject(new Error('Timeout')), timeout)\n                    )\n                ]);\n                return resultado;\n            } catch (error) {\n                console.error(`❌ Timeout ou erro na conexão ${instanceName}:`, error.message);\n                \n                // Atualizar status para erro\n                const statusEl = document.getElementById(`status-${index}`);\n                if (statusEl) {\n                    statusEl.textContent = 'Timeout';\n                    statusEl.className = 'status-badge status-desconectado';\n                }\n                \n                throw error;\n            }\n        }\n\n        // Verificar conexão individual\n        async function verificarConexao(instanceName, index, silent = false) {\n            const statusEl = document.getElementById(`status-${index}`);\n            const btnVerificar = document.getElementById(`btn-verificar-${index}`);\n            const btnQrcode = document.getElementById(`btn-qrcode-${index}`);\n\n            // Validar instanceName\n            if (!instanceName || instanceName === 'instance_indefinida') {\n                console.error('InstanceName inválido para verificação:', instanceName);\n                if (statusEl) {\n                    statusEl.textContent = 'Erro';\n                    statusEl.className = 'status-badge status-desconectado';\n                }\n                if (btnQrcode) {\n                    btnQrcode.style.display = 'none';\n                }\n                return;\n            }\n\n            if (!silent && statusEl && btnVerificar) {\n                statusEl.textContent = 'Verificando...';\n                statusEl.className = 'status-badge status-verificando';\n                btnVerificar.disabled = true;\n            }\n\n            try {\n                const response = await fetch(`https://whatsapi.typebot.pro/instance/connectionState/${instanceName}`, {\n                    method: 'GET',\n                    headers: {\n                        'apikey': 'b4d71f9c38e3ac12a6b08e4b6d53aa90'\n                    }\n                });\n\n                const data = await response.json();\n                console.log(`Status da conexão ${instanceName}:`, data);\n\n                if (data.instance && data.instance.state === 'open') {\n                    // Conectado\n                    if (statusEl) {\n                        statusEl.textContent = 'Conectado';\n                        statusEl.className = 'status-badge status-conectado';\n                    }\n                    if (btnQrcode) {\n                        btnQrcode.style.display = 'none';\n                    }\n                } else {\n                    // Desconectado\n                    if (statusEl) {\n                        statusEl.textContent = 'Desconectado';\n                        statusEl.className = 'status-badge status-desconectado';\n                    }\n                    if (btnQrcode) {\n                        btnQrcode.style.display = 'block';\n                    }\n                }\n\n            } catch (error) {\n                console.error('Erro ao verificar conexão:', error);\n                if (statusEl) {\n                    statusEl.textContent = 'Erro';\n                    statusEl.className = 'status-badge status-desconectado';\n                }\n                if (btnQrcode) {\n                    btnQrcode.style.display = 'block';\n                }\n            } finally {\n                if (btnVerificar) {\n                    btnVerificar.disabled = false;\n                }\n            }\n        }\n\n        // Gerar QR Code\n        async function gerarQRCode(instanceName, index) {\n            try {\n                console.log('Gerando QR Code para:', instanceName);\n                \n                const response = await fetch(`https://whatsapi.typebot.pro/instance/connect/${instanceName}`, {\n                    method: 'GET',\n                    headers: {\n                        'apikey': 'b4d71f9c38e3ac12a6b08e4b6d53aa90'\n                    }\n                });\n\n                const data = await response.json();\n                console.log('QR Code gerado:', data);\n\n                if (data.base64) {\n                    mostrarQRModal(data.base64, instanceName, index);\n                } else {\n                    throw new Error('QR Code não foi retornado pela API');\n                }\n\n            } catch (error) {\n                console.error('Erro ao gerar QR Code:', error);\n                showError('Erro ao gerar QR Code: ' + error.message);\n            }\n        }\n\n        // Mostrar modal do QR Code\n        function mostrarQRModal(qrCodeBase64, instanceName, index) {\n            const modal = document.getElementById('qrModal');\n            const qrImage = document.getElementById('qrImage');\n            const timerEl = document.getElementById('qrTimer');\n            \n            qrImage.src = qrCodeBase64;\n            modal.classList.add('show');\n            \n            currentReconnectInstance = { instanceName, index };\n            \n            // Iniciar timer\n            let timeLeft = 29;\n            timerEl.textContent = `Expira em ${timeLeft} segundos`;\n            \n            qrTimer = setInterval(() => {\n                timeLeft--;\n                timerEl.textContent = `Expira em ${timeLeft} segundos`;\n                \n                if (timeLeft <= 0) {\n                    clearInterval(qrTimer);\n                    qrTimer = null;\n                    timerEl.textContent = 'QR Code expirado';\n                    // Parar verificação quando QR expirar\n                    if (connectionChecker) {\n                        clearInterval(connectionChecker);\n                        connectionChecker = null;\n                    }\n                }\n            }, 1000);\n            \n            // Verificar conexão a cada 5 segundos\n            connectionChecker = setInterval(async () => {\n                console.log(`🔄 Verificando conexão ${instanceName}...`);\n                const isConnected = await verificarConexaoSilenciosa(instanceName);\n                if (isConnected) {\n                    console.log(`✅ Conexão ${instanceName} estabelecida!`);\n                    fecharQRModal();\n                    showSuccess('WhatsApp conectado com sucesso!');\n                    \n                    // Salvar foto do perfil após conexão bem-sucedida\n                    try {\n                        console.log('Salvando foto do perfil...');\n                        const userId = getSecureUserId();\n                        \n                        const savePhotoResponse = await fetch('https://n8n.typebot.pro/webhook/salvarfoto', {\n                            method: 'POST',\n                            headers: {\n                                'Content-Type': 'application/json'\n                            },\n                            body: JSON.stringify({\n                                userId: userId,\n                                instanceName: instanceName\n                            })\n                        });\n\n                        if (!savePhotoResponse.ok) {\n                            console.error('Erro ao salvar foto:', await savePhotoResponse.text());\n                            // Continua mesmo se falhar ao salvar a foto\n                        } else {\n                            console.log('Foto salva com sucesso');\n                        }\n                        \n                    } catch (photoError) {\n                        console.error('Erro na requisição para salvar foto:', photoError);\n                        // Continua mesmo se falhar ao salvar a foto\n                    }\n                    \n                    verificarConexao(instanceName, index);\n                }\n            }, 5000);\n            \n            console.log(`🔄 Iniciado verificação para ${instanceName} (a cada 5s)`);\n        }\n\n        // Verificar conexão silenciosa (para o modal)\n        async function verificarConexaoSilenciosa(instanceName) {\n            try {\n                const response = await fetch(`https://whatsapi.typebot.pro/instance/connectionState/${instanceName}`, {\n                    method: 'GET',\n                    headers: {\n                        'apikey': 'b4d71f9c38e3ac12a6b08e4b6d53aa90'\n                    }\n                });\n\n                const data = await response.json();\n                const isConnected = data.instance && data.instance.state === 'open';\n                console.log(`🔍 Status silencioso ${instanceName}: ${isConnected ? 'Conectado' : 'Desconectado'}`);\n                return isConnected;\n            } catch (error) {\n                console.error(`❌ Erro na verificação silenciosa ${instanceName}:`, error);\n                return false;\n            }\n        }\n\n        // Fechar modal do QR Code\n        function fecharQRModal() {\n            console.log('🔒 Fechando modal do QR Code...');\n            \n            const modal = document.getElementById('qrModal');\n            modal.classList.remove('show');\n            \n            if (qrTimer) {\n                console.log('⏹️ Parando timer do QR Code...');\n                clearInterval(qrTimer);\n                qrTimer = null;\n            }\n            \n            if (connectionChecker) {\n                console.log('⏹️ Parando verificação de conexão...');\n                clearInterval(connectionChecker);\n                connectionChecker = null;\n            }\n            \n            console.log('✅ Modal fechado e verificações paradas');\n        }\n\n        // Excluir conexão\n        async function excluirConexao(instanceName, index) {\n            if (!confirm('Tem certeza que deseja excluir esta conexão?')) {\n                return;\n            }\n\n            try {\n                console.log('Excluindo conexão:', instanceName);\n                \n                const userId = getSecureUserId();\n\n                // Fazer requisição para excluir no backend\n                const response = await fetch('https://n8n.typebot.pro/webhook/apagarconexaoback', {\n                    method: 'POST',\n                    headers: {\n                        'Content-Type': 'application/json'\n                    },\n                    body: JSON.stringify({\n                        userId: userId,\n                        instanceName: instanceName\n                    })\n                });\n\n                console.log('Status da resposta de exclusão:', response.status);\n\n                if (!response.ok) {\n                    throw new Error(`Erro ${response.status}: ${response.statusText}`);\n                }\n\n                const data = await response.json();\n                console.log('Resposta da exclusão:', data);\n\n                // Verificar se a exclusão foi bem-sucedida\n                if (data.resposta) {\n                    // Remover da lista local\n                    conexoesList.splice(index, 1);\n                    \n                    if (conexoesList.length === 0) {\n                        document.getElementById('conexoesGrid').style.display = 'none';\n                        showEmptyState();\n                    } else {\n                        renderConexoes();\n                        verificarTodasConexoes();\n                    }\n                    \n                    showSuccess('Conexão excluída com sucesso!');\n                } else {\n                    throw new Error('Falha ao excluir conexão no servidor');\n                }\n\n            } catch (error) {\n                console.error('Erro ao excluir conexão:', error);\n                showError('Erro ao excluir conexão: ' + error.message);\n            }\n        }\n\n\n\n        // Event listeners para modais e teclas\n        function setupNavigation() {\n            // Event listener para fechar modal\n            const closeQrModal = document.getElementById('closeQrModal');\n            if (closeQrModal) {\n                closeQrModal.addEventListener('click', fecharQRModal);\n            }\n            \n            // Fechar modal clicando fora dele\n            const qrModal = document.getElementById('qrModal');\n            if (qrModal) {\n                qrModal.addEventListener('click', (e) => {\n                    if (e.target === qrModal) {\n                        fecharQRModal();\n                    }\n                });\n            }\n            \n            // Fechar modal com ESC\n            document.addEventListener('keydown', (e) => {\n                if (e.key === 'Escape') {\n                    const modal = document.getElementById('qrModal');\n                    if (modal && modal.classList.contains('show')) {\n                        fecharQRModal();\n                    }\n                }\n            });\n            if (qrModal) {\n                qrModal.addEventListener('click', function(e) {\n                    if (e.target === qrModal) {\n                        fecharQRModal();\n                    }\n                });\n            }\n\n            // Event listeners para o modal do ChatGPT\n            const chatgptModal = document.getElementById('chatgptModal');\n            if (chatgptModal) {\n                chatgptModal.addEventListener('click', function(e) {\n                    if (e.target === chatgptModal) {\n                        fecharModalChatGPT();\n                    }\n                });\n            }\n\n            // Fechar modal com tecla ESC\n            document.addEventListener('keydown', function(e) {\n                if (e.key === 'Escape') {\n                    if (document.getElementById('chatgptModal').classList.contains('show')) {\n                        fecharModalChatGPT();\n                    }\n                    if (document.getElementById('qrModal').classList.contains('show')) {\n                        fecharQRModal();\n                    }\n                }\n            });\n            \n            // Enviar com Enter no input da API Key\n            const apiKeyInput = document.getElementById('apiKeyInput');\n            if (apiKeyInput) {\n                apiKeyInput.addEventListener('keydown', function(e) {\n                    if (e.key === 'Enter') {\n                        salvarApiKeyChatGPT();\n                    }\n                });\n            }\n        }\n\n        // Inicialização\n        async function inicializarPagina() {\n            console.log('Inicializando página de conexões');\n            \n            console.log('Configurando navegação e carregando conexões...');\n            setupNavigation();\n            \n            // Carregar conexões\n            await carregarConexoes();\n            \n\n        }\n\n        // Executar quando o DOM estiver pronto\n        if (document.readyState === 'loading') {\n            document.addEventListener('DOMContentLoaded', inicializarPagina);\n        } else {\n            inicializarPagina();\n        }\n\n        console.log('=== SCRIPT DA PÁGINA DE CONEXÕES CARREGADO ===');\n        console.log('🔐 Sistema de autenticação por cookies - navegação simplificada');\n\n        // Função de logout\n        function logout() {\n            console.log('🚪 Iniciando logout...');\n            \n            // Limpar todos os cookies\n            document.cookie = 'userId=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';\n            document.cookie = 'idLista=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';\n            document.cookie = 'idConexao=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';\n            document.cookie = 'idDisparo=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';\n            \n            // Limpar sessionStorage\n            sessionStorage.clear();\n            \n            console.log('🧹 Cookies e sessionStorage limpos');\n            console.log('🔄 Redirecionando para login...');\n            \n            // Redirecionar para página de login\n            window.location.href = 'https://n8n.typebot.pro/webhook/login';\n        }\n\n        // Funções para gerenciar o modal do ChatGPT\n        async function abrirModalChatGPT() {\n            const modal = document.getElementById('chatgptModal');\n            const input = document.getElementById('apiKeyInput');\n            \n            modal.classList.add('show');\n            \n            // Buscar API key existente\n            try {\n                const userId = getSecureUserId();\n                \n                const response = await fetch('https://n8n.typebot.pro/webhook/buscar-gpt', {\n                    method: 'POST',\n                    headers: {\n                        'Content-Type': 'application/json'\n                    },\n                    body: JSON.stringify({\n                        userId: userId\n                    })\n                });\n\n                if (response.ok) {\n                    const data = await response.json();\n                    console.log('API Key encontrada:', data);\n                    \n                    // Preencher o campo se existir API key\n                    if (data.apikey_gpt) {\n                        input.value = data.apikey_gpt;\n                    } else {\n                        input.value = '';\n                    }\n                } else {\n                    console.error('Erro ao buscar API key:', response.status);\n                    input.value = '';\n                }\n            } catch (error) {\n                console.error('Erro ao buscar API key:', error);\n                input.value = '';\n            }\n            \n            // Foco no input\n            setTimeout(() => {\n                input.focus();\n            }, 100);\n        }\n\n        function fecharModalChatGPT() {\n            const modal = document.getElementById('chatgptModal');\n            const input = document.getElementById('apiKeyInput');\n            \n            modal.classList.remove('show');\n            input.value = '';\n        }\n\n        // Função para salvar API Key do ChatGPT\n        async function salvarApiKeyChatGPT() {\n            const apiKeyInput = document.getElementById('apiKeyInput');\n            const btnSalvar = document.getElementById('btnSalvarApiKey');\n            const apiKey = apiKeyInput.value.trim();\n\n            // Validação básica\n            if (!apiKey) {\n                showError('Por favor, insira uma API Key válida.');\n                return;\n            }\n\n            if (!apiKey.startsWith('sk-')) {\n                showError('A API Key deve começar com \"sk-\".');\n                return;\n            }\n\n            // Obter userId (já validado na inicialização)\n            const userId = getSecureUserId();\n\n            // Desabilitar botão e mostrar loading\n            btnSalvar.disabled = true;\n            btnSalvar.innerHTML = `\n                <svg style=\"animation: spin 1s linear infinite;\" width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n                    <circle cx=\"12\" cy=\"12\" r=\"10\"/>\n                    <path d=\"M16 12a4 4 0 0 0-8 0\"/>\n                </svg>\n                Salvando...\n            `;\n\n            try {\n                console.log('Salvando API Key do ChatGPT...');\n\n                const response = await fetch('https://n8n.typebot.pro/webhook/salvar-gpt', {\n                    method: 'POST',\n                    headers: {\n                        'Content-Type': 'application/json'\n                    },\n                    body: JSON.stringify({\n                        userId: userId,\n                        apikeyGpt: apiKey\n                    })\n                });\n\n                console.log('Status da resposta:', response.status);\n\n                if (!response.ok) {\n                    const errorText = await response.text();\n                    console.error('Erro na resposta:', errorText);\n                    throw new Error(`Erro ${response.status}: ${response.statusText}`);\n                }\n\n                const result = await response.json();\n                console.log('Resposta da API:', result);\n\n                showSuccess('API Key do ChatGPT salva com sucesso!');\n                fecharModalChatGPT();\n\n            } catch (error) {\n                console.error('Erro ao salvar API Key:', error);\n                showError(`Erro ao salvar API Key: ${error.message}`);\n            } finally {\n                // Restaurar botão\n                btnSalvar.disabled = false;\n                btnSalvar.innerHTML = '💾 Salvar';\n            }\n        }\n    </script>\n</body>\n</html>"},"type":"n8n-nodes-base.html","typeVersion":1.2,"position":[-4240,-6512],"id":"80cd7a7d-9359-4cd6-b372-8ed6793cfd8e","name":"HTML4"},{"parameters":{"respondWith":"text","responseBody":"={{ $json.html }}","options":{}},"type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-4016,-6512],"id":"16b9f062-db31-4652-833f-b6d8fa1acd64","name":"Respond to Webhook3"},{"parameters":{"content":"## Tela de disparos de grupos","height":260,"width":760,"color":2},"type":"n8n-nodes-base.stickyNote","position":[-4512,-6288],"typeVersion":1,"id":"d8dcbda6-a83a-4bca-8054-94bd66e64c28","name":"Sticky Note11"},{"parameters":{"html":"<!DOCTYPE html>\n<html lang=\"pt-BR\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>Disparos em Grupos</title>\n    <style>\n        * {\n            margin: 0;\n            padding: 0;\n            box-sizing: border-box;\n        }\n\n        body {\n            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);\n            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n            color: white;\n            min-height: 100vh;\n        }\n\n        .app-layout {\n            display: flex;\n            min-height: 100vh;\n        }\n\n        /* Sidebar */\n        .sidebar {\n            width: 70px;\n            background: rgba(0, 0, 0, 0.3);\n            backdrop-filter: blur(10px);\n            border-right: 1px solid rgba(255, 255, 255, 0.1);\n            transition: all 0.3s ease;\n            position: relative;\n            z-index: 1000;\n            display: flex;\n            flex-direction: column;\n            height: 100vh;\n        }\n\n        .sidebar:hover {\n            width: 250px;\n        }\n\n        .sidebar-header {\n            padding: 20px;\n            text-align: center;\n            border-bottom: 1px solid rgba(255, 255, 255, 0.1);\n        }\n\n        .sidebar-logo {\n            font-size: 1.5rem;\n            font-weight: 600;\n            background: linear-gradient(135deg, #25d366 0%, #128c7e 100%);\n            -webkit-background-clip: text;\n            -webkit-text-fill-color: transparent;\n            background-clip: text;\n            white-space: nowrap;\n            opacity: 0;\n            transition: opacity 0.3s ease;\n        }\n\n        .sidebar:hover .sidebar-logo {\n            opacity: 1;\n        }\n\n        .sidebar-menu {\n            padding: 20px 0;\n            flex: 1;\n        }\n\n        .menu-item {\n            display: flex;\n            align-items: center;\n            padding: 15px 20px;\n            color: #ccc;\n            text-decoration: none;\n            transition: all 0.3s ease;\n            position: relative;\n            white-space: nowrap;\n        }\n\n        .menu-item:hover {\n            background: rgba(37, 211, 102, 0.1);\n            color: #25d366;\n        }\n\n        .menu-item.active {\n            background: rgba(37, 211, 102, 0.2);\n            color: #25d366;\n            border-right: 3px solid #25d366;\n        }\n\n        .menu-icon {\n            font-size: 1.2rem;\n            width: 30px;\n            text-align: center;\n            flex-shrink: 0;\n        }\n\n        .menu-text {\n            margin-left: 15px;\n            opacity: 0;\n            transition: opacity 0.3s ease;\n        }\n\n        .sidebar:hover .menu-text {\n            opacity: 1;\n        }\n\n        .sidebar-footer {\n            margin-top: auto;\n            border-top: 1px solid rgba(255, 255, 255, 0.1);\n            padding: 10px 0;\n        }\n\n        .logout-item {\n            color: #ff6b6b !important;\n        }\n\n        .logout-item:hover {\n            background: rgba(255, 107, 107, 0.1) !important;\n            color: #ff6b6b !important;\n        }\n\n        /* Main content */\n        .main-content-wrapper {\n            flex: 1;\n            padding: 20px;\n            overflow-x: auto;\n        }\n\n        .container {\n            max-width: 1400px;\n            margin: 0 auto;\n        }\n\n        .header {\n            text-align: left;\n            margin-bottom: 40px;\n        }\n\n        .header h1 {\n            font-size: 2.5rem;\n            font-weight: 600;\n            margin-bottom: 10px;\n            color: white;\n        }\n\n        .header p {\n            color: #888;\n            font-size: 1.1rem;\n        }\n\n        .instance-info {\n            background: rgba(37, 211, 102, 0.1);\n            border: 1px solid rgba(37, 211, 102, 0.3);\n            border-radius: 8px;\n            padding: 12px 20px;\n            display: inline-flex;\n            align-items: center;\n            gap: 10px;\n            margin-bottom: 20px;\n        }\n\n        .instance-info .icon {\n            width: 8px;\n            height: 8px;\n            background: #25d366;\n            border-radius: 50%;\n        }\n\n        .main-content {\n            display: grid;\n            grid-template-columns: 1fr 400px;\n            gap: 40px;\n        }\n\n        .form-container {\n            background: rgba(255, 255, 255, 0.02);\n            border: 1px solid rgba(255, 255, 255, 0.1);\n            border-radius: 16px;\n            padding: 40px;\n            backdrop-filter: blur(10px);\n        }\n\n        .form-grid {\n            display: grid;\n            grid-template-columns: 1fr 1fr;\n            gap: 30px;\n            margin-bottom: 30px;\n        }\n\n        .form-group {\n            display: flex;\n            flex-direction: column;\n        }\n\n        .form-group.full-width {\n            grid-column: 1 / -1;\n        }\n\n        .form-group label {\n            color: #fff;\n            font-weight: 500;\n            margin-bottom: 8px;\n            font-size: 0.95rem;\n        }\n\n        .form-group input,\n        .form-group textarea {\n            background: rgba(255, 255, 255, 0.05);\n            border: 1px solid rgba(255, 255, 255, 0.2);\n            border-radius: 8px;\n            padding: 12px 15px;\n            color: white;\n            font-size: 0.9rem;\n            outline: none;\n            transition: all 0.3s ease;\n        }\n\n        .form-group input:focus,\n        .form-group textarea:focus {\n            border-color: #25d366;\n            box-shadow: 0 0 0 2px rgba(37, 211, 102, 0.2);\n        }\n\n        .form-group input::placeholder,\n        .form-group textarea::placeholder {\n            color: #888;\n        }\n\n        .form-group textarea {\n            resize: vertical;\n            min-height: 100px;\n        }\n\n        /* Toggle Switch Styles */\n        .toggle-container {\n            display: flex;\n            align-items: center;\n            gap: 12px;\n            margin-top: 8px;\n        }\n\n        .toggle-switch {\n            position: relative;\n            width: 54px;\n            height: 30px;\n            background: #444;\n            border-radius: 15px;\n            cursor: pointer;\n            transition: all 0.3s ease;\n            border: 2px solid transparent;\n        }\n\n        .toggle-switch.disabled {\n            cursor: not-allowed;\n            opacity: 0.5;\n        }\n\n        .toggle-switch:not(.disabled):hover {\n            background: #555;\n        }\n\n        .toggle-switch.active {\n            background: #25d366;\n            border-color: #128c7e;\n            box-shadow: 0 0 10px rgba(37, 211, 102, 0.3);\n        }\n\n        .toggle-switch.active:hover {\n            background: #128c7e;\n        }\n\n        .toggle-slider {\n            position: absolute;\n            top: 2px;\n            left: 2px;\n            width: 22px;\n            height: 22px;\n            background: white;\n            border-radius: 50%;\n            transition: all 0.3s ease;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            font-size: 12px;\n            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);\n        }\n\n        .toggle-switch.active .toggle-slider {\n            transform: translateX(24px);\n            background: white;\n        }\n\n        .toggle-checkbox {\n            display: none;\n        }\n\n        .connections-section {\n            margin-bottom: 30px;\n        }\n\n        .connections-grid {\n            display: grid;\n            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));\n            gap: 12px;\n            margin-top: 15px;\n        }\n\n        .connection-card {\n            background: rgba(255, 255, 255, 0.03);\n            border: 1px solid rgba(255, 255, 255, 0.1);\n            border-radius: 8px;\n            padding: 16px;\n            cursor: pointer;\n            transition: all 0.3s ease;\n            position: relative;\n            min-height: 80px;\n        }\n\n        .connection-card:hover {\n            border-color: rgba(37, 211, 102, 0.4);\n            background: rgba(37, 211, 102, 0.05);\n            transform: translateY(-1px);\n        }\n\n        .connection-card.selected {\n            border-color: #25d366;\n            background: rgba(37, 211, 102, 0.1);\n            box-shadow: 0 0 0 1px rgba(37, 211, 102, 0.2);\n        }\n\n        .connection-card.selected::before {\n            content: '✓';\n            position: absolute;\n            top: 8px;\n            right: 8px;\n            background: #25d366;\n            color: white;\n            width: 18px;\n            height: 18px;\n            border-radius: 50%;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            font-size: 0.7rem;\n            font-weight: bold;\n        }\n\n        .connection-header {\n            display: flex;\n            align-items: center;\n            gap: 12px;\n            position: relative;\n            padding-right: 30px;\n        }\n\n        .connection-avatar {\n            width: 36px;\n            height: 36px;\n            border-radius: 50%;\n            background: #25d366;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            color: white;\n            font-weight: bold;\n            font-size: 1rem;\n            flex-shrink: 0;\n        }\n\n        .connection-avatar img {\n            width: 100%;\n            height: 100%;\n            border-radius: 50%;\n            object-fit: cover;\n        }\n\n        .connection-info {\n            flex: 1;\n            min-width: 0;\n        }\n\n        .connection-name {\n            color: #fff;\n            font-size: 0.95rem;\n            font-weight: 600;\n            margin-bottom: 4px;\n            line-height: 1.2;\n            overflow: hidden;\n            text-overflow: ellipsis;\n            white-space: nowrap;\n        }\n\n        .connection-phone {\n            color: #888;\n            font-size: 0.8rem;\n            font-weight: 400;\n            overflow: hidden;\n            text-overflow: ellipsis;\n            white-space: nowrap;\n        }\n\n        .connection-status-pill {\n            position: absolute;\n            top: 8px;\n            right: 8px;\n            padding: 2px 8px;\n            border-radius: 10px;\n            font-size: 0.65rem;\n            font-weight: 600;\n            text-transform: uppercase;\n            letter-spacing: 0.3px;\n            line-height: 1;\n        }\n\n        .connection-status-pill.connected {\n            background: rgba(52, 199, 89, 0.15);\n            color: #34c759;\n            border: 1px solid rgba(52, 199, 89, 0.3);\n        }\n\n        .connection-status-pill.disconnected {\n            background: rgba(255, 59, 48, 0.15);\n            color: #ff3b30;\n            border: 1px solid rgba(255, 59, 48, 0.3);\n        }\n\n        .connections-header {\n            display: flex;\n            align-items: center;\n            justify-content: space-between;\n            margin-bottom: 6px;\n        }\n\n        .refresh-connections-btn-small {\n            background: rgba(37, 211, 102, 0.1);\n            border: 1px solid rgba(37, 211, 102, 0.2);\n            color: #25d366;\n            padding: 4px 8px;\n            border-radius: 4px;\n            cursor: pointer;\n            font-size: 0.75rem;\n            transition: all 0.3s ease;\n        }\n\n        .refresh-connections-btn-small:hover {\n            background: rgba(37, 211, 102, 0.2);\n            transform: rotate(180deg);\n        }\n\n        .connections-selected {\n            background: rgba(37, 211, 102, 0.08);\n            border: 1px solid rgba(37, 211, 102, 0.2);\n            border-radius: 6px;\n            padding: 12px;\n            margin-top: 12px;\n            display: none;\n            font-size: 0.9rem;\n        }\n\n        .connections-selected.show {\n            display: block;\n        }\n\n        .no-connections {\n            text-align: center;\n            padding: 40px 20px;\n            color: #888;\n            border: 2px dashed rgba(255, 255, 255, 0.2);\n            border-radius: 12px;\n        }\n\n        .loading-connections {\n            text-align: center;\n            padding: 40px 20px;\n            color: #888;\n        }\n\n        .loading-spinner-large {\n            width: 40px;\n            height: 40px;\n            border: 3px solid rgba(37, 211, 102, 0.3);\n            border-top: 3px solid #25d366;\n            border-radius: 50%;\n            animation: spin 1s linear infinite;\n            margin: 0 auto 15px;\n        }\n\n        /* Animação de rotação corrigida */\n        @keyframes spin {\n            0% { transform: rotate(0deg); }\n            100% { transform: rotate(360deg); }\n        }\n\n        .messages-section {\n            margin-bottom: 30px;\n        }\n\n        .message-item {\n            background: rgba(255, 255, 255, 0.02);\n            border: 1px solid rgba(255, 255, 255, 0.1);\n            border-radius: 12px;\n            padding: 20px;\n            margin-bottom: 15px;\n        }\n\n        .message-header {\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            margin-bottom: 15px;\n        }\n\n        .message-title {\n            color: #25d366;\n            font-size: 0.9rem;\n            font-weight: 600;\n        }\n\n        .remove-message {\n            background: rgba(255, 59, 48, 0.1);\n            border: 1px solid rgba(255, 59, 48, 0.3);\n            color: #ff3b30;\n            padding: 5px 10px;\n            border-radius: 6px;\n            cursor: pointer;\n            font-size: 0.8rem;\n            transition: all 0.3s ease;\n        }\n\n        .remove-message:hover {\n            background: rgba(255, 59, 48, 0.2);\n        }\n\n        .add-message-btn {\n            width: 100%;\n            padding: 15px;\n            background: rgba(37, 211, 102, 0.1);\n            border: 2px dashed rgba(37, 211, 102, 0.3);\n            border-radius: 8px;\n            color: #25d366;\n            font-size: 1rem;\n            cursor: pointer;\n            transition: all 0.3s ease;\n            margin-bottom: 20px;\n        }\n\n        .add-message-btn:hover {\n            background: rgba(37, 211, 102, 0.2);\n            border-color: #25d366;\n        }\n\n        .groups-section {\n            margin-bottom: 30px;\n        }\n\n        .groups-selected {\n            background: rgba(37, 211, 102, 0.1);\n            border: 1px solid rgba(37, 211, 102, 0.3);\n            border-radius: 8px;\n            padding: 15px;\n            margin-top: 15px;\n            display: none;\n        }\n\n        .groups-selected.show {\n            display: block;\n        }\n\n        .selected-groups-count {\n            color: #25d366;\n            font-weight: 600;\n            font-size: 0.9rem;\n            margin-bottom: 10px;\n        }\n\n        .selected-groups-list {\n            display: flex;\n            flex-wrap: wrap;\n            gap: 8px;\n        }\n\n        .selected-group-tag {\n            background: rgba(37, 211, 102, 0.2);\n            border: 1px solid rgba(37, 211, 102, 0.4);\n            border-radius: 16px;\n            padding: 6px 12px;\n            font-size: 0.8rem;\n            color: #25d366;\n            display: flex;\n            align-items: center;\n            gap: 8px;\n        }\n\n        .remove-group-btn {\n            background: none;\n            border: none;\n            color: #25d366;\n            cursor: pointer;\n            font-size: 0.9rem;\n            padding: 0;\n            line-height: 1;\n        }\n\n        .remove-group-btn:hover {\n            color: #fff;\n        }\n\n\n\n        .media-upload {\n            display: grid;\n            grid-template-columns: repeat(4, 1fr);\n            gap: 10px;\n            margin-top: 15px;\n        }\n\n        .media-preview-section {\n            margin-top: 15px;\n        }\n\n        .media-selected {\n            background: rgba(37, 211, 102, 0.1);\n            border: 1px solid rgba(37, 211, 102, 0.3);\n            border-radius: 8px;\n            padding: 12px;\n            display: flex;\n            align-items: center;\n            justify-content: space-between;\n        }\n\n        .media-info-display {\n            display: flex;\n            align-items: center;\n            gap: 10px;\n        }\n\n        .media-icon-display {\n            font-size: 1.2rem;\n        }\n\n        .media-name-display {\n            color: #fff;\n            font-weight: 500;\n        }\n\n        .media-size-display {\n            color: #888;\n            font-size: 0.9rem;\n        }\n\n        .remove-media-btn {\n            background: rgba(255, 59, 48, 0.1);\n            border: 1px solid rgba(255, 59, 48, 0.3);\n            color: #ff3b30;\n            padding: 5px 8px;\n            border-radius: 4px;\n            cursor: pointer;\n            font-size: 0.9rem;\n            transition: all 0.3s ease;\n        }\n\n        .remove-media-btn:hover {\n            background: rgba(255, 59, 48, 0.2);\n        }\n\n        .media-btn {\n            background: rgba(255, 255, 255, 0.05);\n            border: 1px solid rgba(255, 255, 255, 0.2);\n            border-radius: 8px;\n            padding: 12px 8px;\n            color: white;\n            cursor: pointer;\n            text-align: center;\n            font-size: 0.8rem;\n            transition: all 0.3s ease;\n            position: relative;\n        }\n\n        .media-btn:hover {\n            background: rgba(37, 211, 102, 0.1);\n            border-color: #25d366;\n        }\n\n        .media-btn input[type=\"file\"] {\n            position: absolute;\n            opacity: 0;\n            width: 100%;\n            height: 100%;\n            cursor: pointer;\n        }\n\n        .media-btn.active {\n            background: rgba(37, 211, 102, 0.2);\n            border-color: #25d366;\n            color: #25d366;\n        }\n\n        .file-size-limit {\n            display: block;\n            font-size: 0.7rem;\n            color: #888;\n            margin-top: 4px;\n            font-weight: 400;\n        }\n\n        .media-preview-whatsapp {\n            margin-bottom: 8px;\n            border-radius: 8px;\n            overflow: hidden;\n            max-width: 200px;\n        }\n\n        .image-preview-whatsapp {\n            width: 100%;\n            height: auto;\n            max-height: 150px;\n            object-fit: cover;\n            border-radius: 8px;\n        }\n\n        .video-preview-whatsapp {\n            width: 100%;\n            height: auto;\n            max-height: 150px;\n            border-radius: 8px;\n        }\n\n        .video-overlay {\n            position: relative;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            margin-top: -75px;\n            margin-bottom: 75px;\n            pointer-events: none;\n        }\n\n        .play-button {\n            background: rgba(0, 0, 0, 0.6);\n            color: white;\n            width: 40px;\n            height: 40px;\n            border-radius: 50%;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            font-size: 1.2rem;\n        }\n\n        .audio-preview-whatsapp {\n            background: rgba(0, 0, 0, 0.1);\n            padding: 12px;\n            border-radius: 8px;\n            display: flex;\n            align-items: center;\n            gap: 12px;\n            margin-bottom: 8px;\n            max-width: 250px;\n        }\n\n        .audio-icon {\n            font-size: 1.5rem;\n            color: #075e54;\n        }\n\n        .audio-info {\n            flex: 1;\n        }\n\n        .audio-name {\n            font-size: 0.9rem;\n            font-weight: 500;\n            color: #303030;\n            margin-bottom: 2px;\n        }\n\n        .audio-duration {\n            font-size: 0.8rem;\n            color: #667781;\n        }\n\n        .audio-controls {\n            display: none;\n        }\n\n        .document-preview-whatsapp {\n            background: rgba(0, 0, 0, 0.1);\n            padding: 12px;\n            border-radius: 8px;\n            display: flex;\n            align-items: center;\n            gap: 12px;\n            margin-bottom: 8px;\n            max-width: 250px;\n            cursor: pointer;\n            transition: background 0.2s ease;\n        }\n\n        .document-preview-whatsapp:hover {\n            background: rgba(0, 0, 0, 0.15);\n        }\n\n        .document-icon {\n            font-size: 1.5rem;\n            color: #075e54;\n        }\n\n        .document-info {\n            flex: 1;\n        }\n\n        .document-name {\n            font-size: 0.9rem;\n            font-weight: 500;\n            color: #303030;\n            margin-bottom: 2px;\n            word-break: break-word;\n        }\n\n        .remove-group-btn:hover {\n            color: #fff;\n        }\n\n        .dispatch-btn {\n            width: 100%;\n            padding: 18px;\n            background: linear-gradient(135deg, #25d366 0%, #128c7e 100%);\n            border: none;\n            border-radius: 12px;\n            color: white;\n            font-size: 1.1rem;\n            font-weight: 600;\n            cursor: pointer;\n            transition: all 0.3s ease;\n            margin-top: 20px;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            gap: 10px;\n        }\n\n        .dispatch-btn:hover {\n            transform: translateY(-2px);\n            box-shadow: 0 12px 30px rgba(37, 211, 102, 0.4);\n        }\n\n        .dispatch-btn:disabled {\n            background: #444;\n            cursor: not-allowed;\n            transform: none;\n            box-shadow: none;\n        }\n\n        .success-message,\n        .error-message {\n            padding: 15px 20px;\n            border-radius: 8px;\n            margin: 20px 0;\n            display: none;\n        }\n\n        .success-message {\n            background: rgba(52, 199, 89, 0.1);\n            border: 1px solid rgba(52, 199, 89, 0.3);\n            color: #34c759;\n        }\n\n        .error-message {\n            background: rgba(255, 59, 48, 0.1);\n            border: 1px solid rgba(255, 59, 48, 0.3);\n            color: #ff3b30;\n        }\n\n        .success-message.show,\n        .error-message.show {\n            display: block;\n        }\n\n        .stats {\n            display: grid;\n            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));\n            gap: 20px;\n            margin-top: 30px;\n        }\n\n        .stat-card {\n            background: rgba(255, 255, 255, 0.02);\n            border: 1px solid rgba(255, 255, 255, 0.1);\n            border-radius: 12px;\n            padding: 20px;\n            text-align: center;\n        }\n\n        .stat-value {\n            font-size: 1.5rem;\n            font-weight: 600;\n            color: #25d366;\n            margin-bottom: 5px;\n        }\n\n        .stat-label {\n            color: #888;\n            font-size: 0.8rem;\n        }\n\n        /* Phone Preview */\n        .phone-preview {\n            position: sticky;\n            top: 20px;\n        }\n\n        .phone-container {\n            width: 350px;\n            height: 700px;\n            background: #000;\n            border-radius: 35px;\n            padding: 20px 15px;\n            position: relative;\n            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);\n        }\n\n        .phone-screen {\n            width: 100%;\n            height: 100%;\n            background: linear-gradient(135deg, #e5ddd5 0%, #d1c7b8 100%);\n            border-radius: 25px;\n            position: relative;\n            overflow: hidden;\n        }\n\n        .whatsapp-header {\n            background: #075e54;\n            height: 60px;\n            display: flex;\n            align-items: center;\n            padding: 0 16px;\n            gap: 12px;\n        }\n\n        .contact-avatar {\n            width: 40px;\n            height: 40px;\n            background: #25d366;\n            border-radius: 50%;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            color: white;\n            font-weight: bold;\n            font-size: 1.2rem;\n        }\n\n        .contact-info {\n            flex: 1;\n        }\n\n        .contact-name {\n            color: white;\n            font-size: 1rem;\n            font-weight: 500;\n        }\n\n        .contact-status {\n            color: rgba(255, 255, 255, 0.7);\n            font-size: 0.8rem;\n        }\n\n        .chat-area {\n            flex: 1;\n            padding: 20px 16px;\n            overflow-y: auto;\n            height: calc(100% - 60px);\n            display: flex;\n            flex-direction: column;\n        }\n\n        .no-messages {\n            flex: 1;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            color: #666;\n            font-style: italic;\n            text-align: center;\n        }\n\n        .message-bubble {\n            background: #dcf8c6;\n            border-radius: 8px;\n            padding: 8px 12px;\n            margin-bottom: 15px;\n            max-width: 80%;\n            margin-left: auto;\n            position: relative;\n            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);\n        }\n\n        .message-bubble:after {\n            content: '';\n            position: absolute;\n            top: 8px;\n            right: -8px;\n            width: 0;\n            height: 0;\n            border-left: 8px solid #dcf8c6;\n            border-top: 8px solid transparent;\n            border-bottom: 8px solid transparent;\n        }\n\n        .message-text {\n            color: #303030;\n            font-size: 0.9rem;\n            line-height: 1.4;\n            word-wrap: break-word;\n        }\n\n        .message-time {\n            color: #667781;\n            font-size: 0.7rem;\n            text-align: right;\n            margin-top: 4px;\n        }\n\n        /* Loading spinner para verificação de grupo */\n        .loading-spinner-small {\n            width: 16px;\n            height: 16px;\n            border: 2px solid rgba(37, 211, 102, 0.3);\n            border-top: 2px solid #25d366;\n            border-radius: 50%;\n            animation: spin 1s linear infinite;\n            display: inline-block;\n            margin-left: 8px;\n        }\n\n        .add-group-btn {\n            background: #25d366;\n            border: none;\n            border-radius: 8px;\n            padding: 12px 20px;\n            color: white;\n            font-weight: 600;\n            cursor: pointer;\n            transition: all 0.3s ease;\n            display: flex;\n            align-items: center;\n            gap: 8px;\n        }\n\n        .add-group-btn:hover {\n            background: #128c7e;\n            transform: translateY(-1px);\n        }\n\n        .add-group-btn:disabled {\n            background: #666;\n            cursor: not-allowed;\n            transform: none;\n        }\n\n        /* Lists Section Styles */\n        .lists-section {\n            margin-bottom: 30px;\n        }\n\n        .lists-header {\n            display: flex;\n            align-items: center;\n            justify-content: space-between;\n            margin-bottom: 6px;\n        }\n\n        .refresh-lists-btn-small {\n            background: rgba(37, 211, 102, 0.1);\n            border: 1px solid rgba(37, 211, 102, 0.2);\n            color: #25d366;\n            padding: 4px 8px;\n            border-radius: 4px;\n            cursor: pointer;\n            font-size: 0.75rem;\n            transition: all 0.3s ease;\n        }\n\n        .refresh-lists-btn-small:hover {\n            background: rgba(37, 211, 102, 0.2);\n            transform: rotate(180deg);\n        }\n\n        .loading-lists {\n            text-align: center;\n            padding: 40px 20px;\n            color: #888;\n        }\n\n        .lists-grid {\n            display: grid;\n            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));\n            gap: 12px;\n            margin-top: 15px;\n            max-height: 180px;\n            overflow-y: auto;\n            padding: 2px 5px 2px 2px;\n        }\n\n        .lists-grid::-webkit-scrollbar {\n            width: 6px;\n        }\n\n        .lists-grid::-webkit-scrollbar-track {\n            background: rgba(0, 0, 0, 0.05);\n            border-radius: 3px;\n        }\n\n        .lists-grid::-webkit-scrollbar-thumb {\n            background: rgba(0, 0, 0, 0.2);\n            border-radius: 3px;\n        }\n\n        .lists-grid::-webkit-scrollbar-thumb:hover {\n            background: rgba(0, 0, 0, 0.3);\n        }\n\n        .list-card {\n            background: rgba(255, 255, 255, 0.03);\n            border: 1px solid rgba(255, 255, 255, 0.1);\n            border-radius: 8px;\n            padding: 16px;\n            cursor: pointer;\n            transition: all 0.3s ease;\n            position: relative;\n            min-height: 60px;\n        }\n\n        .list-card:hover {\n            border-color: rgba(37, 211, 102, 0.4);\n            background: rgba(37, 211, 102, 0.05);\n            transform: translateY(-1px);\n        }\n\n        .list-card.selected {\n            border-color: #25d366;\n            background: rgba(37, 211, 102, 0.1);\n            box-shadow: 0 0 0 1px rgba(37, 211, 102, 0.2);\n        }\n\n        .list-card.selected::before {\n            content: '✓';\n            position: absolute;\n            top: 8px;\n            right: 8px;\n            background: #25d366;\n            color: white;\n            width: 18px;\n            height: 18px;\n            border-radius: 50%;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            font-size: 0.7rem;\n            font-weight: bold;\n        }\n\n        .list-info {\n            display: flex;\n            align-items: center;\n            gap: 12px;\n        }\n\n        .list-icon {\n            width: 36px;\n            height: 36px;\n            border-radius: 50%;\n            background: #25d366;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            color: white;\n            font-weight: bold;\n            font-size: 1rem;\n            flex-shrink: 0;\n        }\n\n        .list-name {\n            color: #fff;\n            font-size: 0.95rem;\n            font-weight: 600;\n            line-height: 1.2;\n            overflow: hidden;\n            text-overflow: ellipsis;\n            white-space: nowrap;\n        }\n\n        .lists-selected {\n            background: rgba(37, 211, 102, 0.08);\n            border: 1px solid rgba(37, 211, 102, 0.2);\n            border-radius: 6px;\n            padding: 12px;\n            margin-top: 12px;\n            display: none;\n            font-size: 0.9rem;\n        }\n\n        .lists-selected.show {\n            display: block;\n        }\n\n        .no-lists {\n            text-align: center;\n            padding: 40px 20px;\n            color: #888;\n            border: 2px dashed rgba(255, 255, 255, 0.2);\n            border-radius: 12px;\n        }\n\n        .multiple-lists-warning {\n            background: rgba(255, 193, 7, 0.1);\n            border: 1px solid rgba(255, 193, 7, 0.3);\n            border-radius: 6px;\n            padding: 10px 12px;\n            margin-top: 10px;\n            font-size: 0.8rem;\n            color: #ffc107;\n            display: none;\n        }\n\n        .multiple-lists-warning.show {\n            display: block;\n        }\n\n        .multiple-lists-warning::before {\n            content: '⚠️ ';\n            margin-right: 5px;\n        }\n\n        /* Aviso amarelo para verificação de WhatsApp nos grupos */\n        .whatsapp-warning {\n            background: rgba(255, 193, 7, 0.1);\n            border: 1px solid rgba(255, 193, 7, 0.3);\n            border-radius: 6px;\n            padding: 12px 15px;\n            margin-top: 15px;\n            font-size: 0.9rem;\n            color: #ffc107;\n            display: none;\n            line-height: 1.4;\n        }\n\n        .whatsapp-warning.show {\n            display: block;\n        }\n\n        .whatsapp-warning::before {\n            content: '⚠️ ';\n            margin-right: 8px;\n            font-size: 1.1rem;\n        }\n\n        /* Variables Section Styles */\n        .variables-section {\n            margin-bottom: 10px;\n        }\n\n        .variables-label {\n            color: #888;\n            font-size: 0.85rem;\n            font-weight: 500;\n            margin-bottom: 6px;\n        }\n\n        .variables-container {\n            display: flex;\n            flex-wrap: wrap;\n            gap: 8px;\n            margin-bottom: 8px;\n        }\n\n        .variable-btn {\n            background: rgba(37, 211, 102, 0.1);\n            border: 1px solid rgba(37, 211, 102, 0.3);\n            color: #25d366;\n            padding: 4px 10px;\n            border-radius: 20px;\n            cursor: pointer;\n            font-size: 0.8rem;\n            font-weight: 500;\n            transition: all 0.3s ease;\n            user-select: none;\n            display: flex;\n            align-items: center;\n            gap: 4px;\n        }\n\n        .variable-btn:hover {\n            background: rgba(37, 211, 102, 0.2);\n            border-color: #25d366;\n            transform: translateY(-1px);\n        }\n\n        .variable-btn:active {\n            transform: translateY(0);\n        }\n\n        .no-variables {\n            color: #888;\n            font-size: 0.8rem;\n            font-style: italic;\n        }\n\n        .time-variables-container {\n            position: relative;\n        }\n\n        .time-toggle-btn {\n            cursor: pointer;\n            position: relative;\n        }\n\n        .time-toggle-btn.expanded svg:last-child {\n            transform: rotate(180deg);\n        }\n\n        .time-variables-dropdown {\n            position: absolute;\n            top: 100%;\n            left: 0;\n            background: rgba(0, 0, 0, 0.95);\n            border: 1px solid rgba(37, 211, 102, 0.3);\n            border-radius: 8px;\n            padding: 8px;\n            margin-top: 4px;\n            z-index: 1000;\n            min-width: 200px;\n            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);\n            backdrop-filter: blur(10px);\n        }\n\n        .time-var-btn {\n            display: block;\n            width: 100%;\n            text-align: left;\n            margin-bottom: 4px;\n            padding: 8px 12px;\n            border-radius: 6px;\n            background: rgba(255, 255, 255, 0.05);\n            border: 1px solid rgba(255, 255, 255, 0.1);\n            color: #fff;\n            font-size: 0.85rem;\n            transition: all 0.2s ease;\n        }\n\n        .time-var-btn:hover {\n            background: rgba(37, 211, 102, 0.15);\n            border-color: rgba(37, 211, 102, 0.3);\n            color: #25d366;\n        }\n\n        .time-var-btn:last-child {\n            margin-bottom: 0;\n        }\n\n        /* Estilos para variáveis de tempo expansíveis */\n        .time-variables-container {\n            position: relative;\n            display: inline-block;\n        }\n\n        .time-toggle-btn {\n            background: rgba(37, 211, 102, 0.15) !important;\n            border-color: rgba(37, 211, 102, 0.4) !important;\n            color: #25d366 !important;\n            font-weight: 600;\n        }\n\n        .time-toggle-btn:hover {\n            background: rgba(37, 211, 102, 0.25) !important;\n            border-color: #25d366 !important;\n        }\n\n        .time-toggle-btn.expanded svg:last-child {\n            transform: rotate(180deg);\n        }\n\n        /* Botões de formatação */\n        .formatting-buttons {\n            display: flex;\n            gap: 8px;\n            margin-bottom: 10px;\n        }\n\n        .format-btn {\n            background: rgba(255, 255, 255, 0.05);\n            border: 1px solid rgba(255, 255, 255, 0.2);\n            color: #ccc;\n            padding: 8px 12px;\n            border-radius: 6px;\n            cursor: pointer;\n            font-size: 0.9rem;\n            font-weight: 600;\n            transition: all 0.3s ease;\n            min-width: 40px;\n            text-align: center;\n        }\n\n        .format-btn:hover {\n            background: rgba(37, 211, 102, 0.1);\n            border-color: #25d366;\n            color: #25d366;\n        }\n\n        .format-btn:active {\n            transform: translateY(1px);\n        }\n\n        .format-btn strong {\n            font-weight: 700;\n        }\n\n        .format-btn em {\n            font-style: italic;\n        }\n\n        /* Estilo para variáveis no textarea */\n        .form-group textarea {\n            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;\n            font-size: 0.85rem;\n        }\n\n        /* Advanced Settings Styles */\n        .advanced-settings-section {\n            margin: 20px 0 15px 0;\n            padding: 20px;\n            background: rgba(255, 255, 255, 0.02);\n            border: 1px solid rgba(255, 255, 255, 0.1);\n            border-radius: 12px;\n        }\n\n        .advanced-settings-label {\n            color: #888;\n            font-size: 0.85rem;\n            font-weight: 600;\n            margin-bottom: 12px;\n            display: flex;\n            align-items: center;\n            gap: 6px;\n        }\n\n        .advanced-settings-container {\n            display: flex;\n            flex-direction: column;\n            gap: 12px;\n        }\n\n        .setting-item {\n            display: flex;\n            align-items: center;\n            justify-content: space-between;\n            padding: 8px 0;\n        }\n\n        .setting-info {\n            flex: 1;\n            margin-right: 15px;\n        }\n\n        .setting-title {\n            color: #fff;\n            font-size: 0.9rem;\n            font-weight: 500;\n            margin-bottom: 2px;\n            display: flex;\n            align-items: center;\n            gap: 8px;\n        }\n\n        .chatgpt-icon {\n            width: 16px;\n            height: 16px;\n            color: #10a37f;\n            flex-shrink: 0;\n        }\n\n        /* AI Settings Styles */\n        .ai-settings-container {\n            margin-top: 15px;\n            padding: 15px;\n            background: rgba(16, 163, 127, 0.05);\n            border: 1px solid rgba(16, 163, 127, 0.2);\n            border-radius: 8px;\n            animation: fadeIn 0.3s ease;\n        }\n\n        .ai-settings-content {\n            display: flex;\n            flex-direction: column;\n            gap: 15px;\n        }\n\n        .ai-input-group {\n            display: flex;\n            flex-direction: column;\n            gap: 6px;\n        }\n\n        .ai-input-group label {\n            color: #fff;\n            font-size: 0.85rem;\n            font-weight: 500;\n        }\n\n        .ai-input {\n            background: rgba(255, 255, 255, 0.05);\n            border: 1px solid rgba(255, 255, 255, 0.1);\n            border-radius: 6px;\n            padding: 8px 12px;\n            color: #fff;\n            font-size: 0.9rem;\n            transition: all 0.3s ease;\n        }\n\n        .ai-input:focus {\n            outline: none;\n            border-color: #10a37f;\n            background: rgba(255, 255, 255, 0.08);\n        }\n\n        .ai-textarea {\n            background: rgba(255, 255, 255, 0.05);\n            border: 1px solid rgba(255, 255, 255, 0.1);\n            border-radius: 6px;\n            padding: 10px 12px;\n            color: #fff;\n            font-size: 0.9rem;\n            min-height: 80px;\n            resize: vertical;\n            font-family: inherit;\n            transition: all 0.3s ease;\n        }\n\n        .ai-textarea:focus {\n            outline: none;\n            border-color: #10a37f;\n            background: rgba(255, 255, 255, 0.08);\n        }\n\n        .ai-textarea::placeholder {\n            color: #888;\n        }\n\n        .ai-note {\n            display: flex;\n            align-items: flex-start;\n            gap: 8px;\n            padding: 10px;\n            background: rgba(16, 163, 127, 0.1);\n            border: 1px solid rgba(16, 163, 127, 0.2);\n            border-radius: 6px;\n            color: #10a37f;\n            font-size: 0.8rem;\n            line-height: 1.4;\n        }\n\n        .info-icon {\n            width: 14px;\n            height: 14px;\n            color: #10a37f;\n            flex-shrink: 0;\n            margin-top: 1px;\n        }\n\n        .generate-ai-btn {\n            background: linear-gradient(135deg, #10a37f 0%, #0d8a6b 100%);\n            border: 1px solid #10a37f;\n            border-radius: 8px;\n            padding: 12px 20px;\n            color: #fff;\n            font-size: 0.9rem;\n            font-weight: 600;\n            cursor: pointer;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            gap: 8px;\n            transition: all 0.3s ease;\n            width: 100%;\n            margin-top: 5px;\n        }\n\n        .generate-ai-btn:hover {\n            background: linear-gradient(135deg, #0d8a6b 0%, #0a6b52 100%);\n            border-color: #0d8a6b;\n            transform: translateY(-1px);\n            box-shadow: 0 4px 12px rgba(16, 163, 127, 0.3);\n        }\n\n        .generate-ai-btn:active {\n            transform: translateY(0);\n        }\n\n        .chatgpt-btn-icon {\n            width: 16px;\n            height: 16px;\n            color: #fff;\n            flex-shrink: 0;\n        }\n\n        @keyframes fadeIn {\n            from {\n                opacity: 0;\n                transform: translateY(-10px);\n            }\n            to {\n                opacity: 1;\n                transform: translateY(0);\n            }\n        }\n\n        .setting-description {\n            color: #888;\n            font-size: 0.8rem;\n            line-height: 1.3;\n        }\n\n        /* Toggle Switch Styles para advanced settings */\n        .ai-toggle-switch {\n            position: relative;\n            display: inline-block;\n            width: 44px;\n            height: 24px;\n            flex-shrink: 0;\n        }\n\n        .ai-toggle-switch input {\n            opacity: 0;\n            width: 0;\n            height: 0;\n        }\n\n        .ai-toggle-slider {\n            position: absolute;\n            cursor: pointer;\n            top: 0;\n            left: 0;\n            right: 0;\n            bottom: 0;\n            background-color: rgba(255, 255, 255, 0.1);\n            transition: 0.3s;\n            border-radius: 24px;\n            border: 1px solid rgba(255, 255, 255, 0.2);\n        }\n\n        .ai-toggle-slider:before {\n            position: absolute;\n            content: \"\";\n            height: 18px;\n            width: 18px;\n            left: 2px;\n            bottom: 2px;\n            background-color: #888;\n            transition: 0.3s;\n            border-radius: 50%;\n        }\n\n        .ai-toggle-switch input:checked + .ai-toggle-slider {\n            background-color: rgba(37, 211, 102, 0.3);\n            border-color: #25d366;\n        }\n\n        .ai-toggle-switch input:checked + .ai-toggle-slider:before {\n            transform: translateX(20px);\n            background-color: #25d366;\n        }\n\n        /* Antigo advanced settings simples */\n        .advanced-settings {\n            background: rgba(255, 255, 255, 0.02);\n            border: 1px solid rgba(255, 255, 255, 0.1);\n            border-radius: 12px;\n            padding: 20px;\n            margin-bottom: 20px;\n        }\n\n        .advanced-settings h3 {\n            color: #25d366;\n            font-size: 1.1rem;\n            margin-bottom: 15px;\n            display: flex;\n            align-items: center;\n            gap: 8px;\n        }\n\n\n\n        /* Responsividade */\n        @media (max-width: 1200px) {\n            .main-content {\n                grid-template-columns: 1fr;\n                gap: 30px;\n            }\n\n            .phone-preview {\n                position: static;\n                display: flex;\n                justify-content: center;\n            }\n\n            .phone-container {\n                width: 300px;\n                height: 600px;\n            }\n        }\n\n        @media (max-width: 768px) {\n            .form-grid {\n                grid-template-columns: 1fr;\n                gap: 20px;\n            }\n\n            .header h1 {\n                font-size: 2rem;\n            }\n\n            .form-container {\n                padding: 25px;\n            }\n\n            .sidebar {\n                width: 60px;\n            }\n\n            .sidebar:hover {\n                width: 180px;\n            }\n\n            .main-content-wrapper {\n                padding: 15px;\n            }\n\n            .toggle-container {\n                flex-wrap: wrap;\n                gap: 8px;\n            }\n        }\n    </style>\n</head>\n<body>\n    <div class=\"app-layout\">\n        <!-- Sidebar -->\n        <div class=\"sidebar\">\n            <div class=\"sidebar-header\">\n                <div class=\"sidebar-logo\">EnviaZap</div>\n            </div>\n            <nav class=\"sidebar-menu\">\n                <a href=\"#\" class=\"menu-item\" onclick=\"navigateToPage('https://n8n.typebot.pro/webhook/dashboard'); return false;\">\n                    <span class=\"menu-icon\">📊</span>\n                    <span class=\"menu-text\">Dashboard</span>\n                </a>\n                <a href=\"#\" class=\"menu-item\" onclick=\"navigateToPage('https://n8n.typebot.pro/webhook/historico-disparos'); return false;\">\n                    <span class=\"menu-icon\">📋</span>\n                    <span class=\"menu-text\">Histórico de disparos</span>\n                </a>\n                <a href=\"#\" class=\"menu-item\" onclick=\"navigateToPage('https://n8n.typebot.pro/webhook/conectar'); return false;\">\n                    <span class=\"menu-icon\">🔗</span>\n                    <span class=\"menu-text\">Nova Conexão</span>\n                </a>\n                <a href=\"#\" class=\"menu-item\" onclick=\"navigateToPage('https://n8n.typebot.pro/webhook/conexoes'); return false;\">\n                    <span class=\"menu-icon\">🔌</span>\n                    <span class=\"menu-text\">Conexões</span>\n                </a>\n                <a href=\"#\" class=\"menu-item\" onclick=\"navigateToPage('https://n8n.typebot.pro/webhook/disparos-individuais'); return false;\">\n                    <span class=\"menu-icon\">📱</span>\n                    <span class=\"menu-text\">Disparos individuais</span>\n                </a>\n                <a href=\"#\" class=\"menu-item active\">\n                    <span class=\"menu-icon\">👥</span>\n                    <span class=\"menu-text\">Disparos em grupo</span>\n                </a>\n                <a href=\"#\" class=\"menu-item\" onclick=\"navigateToPage('https://n8n.typebot.pro/webhook/listas'); return false;\">\n                    <span class=\"menu-icon\">📝</span>\n                    <span class=\"menu-text\">Listas</span>\n                </a>\n            </nav>\n            <div class=\"sidebar-footer\">\n                <a href=\"#\" class=\"menu-item logout-item\" onclick=\"logout()\">\n                    <span class=\"menu-icon\">🚪</span>\n                    <span class=\"menu-text\">Sair</span>\n                </a>\n            </div>\n        </div>\n\n        <!-- Main Content -->\n        <div class=\"main-content-wrapper\">\n            <div class=\"container\">\n                <div class=\"header\">\n                    <h1>Disparos em Grupos</h1>\n                    <p>Envie mensagens para múltiplos grupos do WhatsApp de forma automatizada</p>\n                </div>\n\n                <div class=\"main-content\">\n                    <div class=\"form-container\">\n                        <form id=\"dispatchForm\">\n                            <div class=\"connections-section\">\n                                <div class=\"connections-header\">\n                                    <label>Selecione uma conexão *</label>\n                                    <button type=\"button\" class=\"refresh-connections-btn-small\" onclick=\"loadConnections()\" title=\"Atualizar conexões\">\n                                        🔄\n                                    </button>\n                                </div>\n                                <p style=\"color: #888; font-size: 0.9rem; margin-bottom: 15px;\">\n                                    Selecione apenas uma conexão para fazer o disparo nos grupos.\n                                </p>\n                                <div id=\"connectionsContainer\">\n                                    <div class=\"loading-connections\">\n                                        <div class=\"loading-spinner-large\"></div>\n                                        <p>Buscando conexões...</p>\n                                    </div>\n                                </div>\n                            </div>\n\n                            <!-- Seção de Listas -->\n                            <div class=\"lists-section\">\n                                <div class=\"lists-header\">\n                                    <label>Listas de grupos disponíveis</label>\n                                    <button type=\"button\" class=\"refresh-lists-btn-small\" onclick=\"loadLists()\" title=\"Atualizar listas\">\n                                        🔄\n                                    </button>\n                                </div>\n                                <p style=\"color: #888; font-size: 0.9rem; margin-bottom: 15px;\">\n                                    Selecione uma ou mais listas de grupos para o disparo. Os grupos das listas selecionadas serão incluídos no envio.\n                                </p>\n                                <div id=\"listsContainer\">\n                                    <div class=\"loading-lists\">\n                                        <div class=\"loading-spinner-large\"></div>\n                                        <p>Buscando listas...</p>\n                                    </div>\n                                </div>\n                                <div class=\"multiple-lists-warning\" id=\"multipleListsWarning\">\n                                    Atenção: Caso um grupo não tenha as variáveis selecionadas, suas mensagens podem ser afetadas\n                                </div>\n                                <div class=\"whatsapp-warning\" id=\"whatsappWarning\">\n                                    <strong>Certifique-se que o WhatsApp selecionado está em todos os grupos da lista.</strong> Caso não estiver no grupo não é possível enviar a mensagem.\n                                </div>\n                            </div>\n\n                            <div class=\"messages-section\">\n                                <label>Mensagens a serem enviadas *</label>\n                                <p style=\"color: #888; font-size: 0.9rem; margin-bottom: 15px;\">\n                                    Crie variações de mensagens. O sistema enviará apenas 1 mensagem por grupo (escolhida aleatoriamente entre as variações).\n                                </p>\n                                <div id=\"messagesContainer\">\n                                    <!-- Mensagens serão adicionadas aqui dinamicamente -->\n                                </div>\n                                <button type=\"button\" class=\"add-message-btn\" id=\"addMessageBtn\">\n                                    ➕ Adicionar Mensagem\n                                </button>\n                            </div>\n\n                            <!-- Seção de Variáveis será adicionada dinamicamente em cada mensagem -->\n\n                            <!-- Configurações Avançadas -->\n                            <div class=\"advanced-settings-section\">\n                                <div class=\"advanced-settings-label\">⚙️ Configurações avançadas:</div>\n                                <div class=\"advanced-settings-container\">\n                                    <div class=\"setting-item\">\n                                        <div class=\"setting-info\">\n                                            <div class=\"setting-title\">\n                                                <svg class=\"chatgpt-icon\" width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\n                                                    <path d=\"M22.2819 9.8211a5.9847 5.9847 0 0 0-.5157-4.9108 6.0462 6.0462 0 0 0-6.5098-2.9A6.0651 6.0651 0 0 0 4.9807 4.1818a5.9847 5.9847 0 0 0-3.9977 2.9 6.0462 6.0462 0 0 0 .7427 7.0966 5.98 5.98 0 0 0 .511 4.9107 6.051 6.051 0 0 0 6.5146 2.9001A5.9847 5.9847 0 0 0 13.2599 24a6.0557 6.0557 0 0 0 5.7718-4.2058 5.9894 5.9894 0 0 0 3.9977-2.9001 6.0557 6.0557 0 0 0-.7475-7.0729zm-9.022 12.6081a4.4755 4.4755 0 0 1-2.8764-1.0408l.1419-.0804 4.7783-2.7582a.7948.7948 0 0 0 .3927-.6813v-6.7369l2.02 1.1686a.071.071 0 0 1 .038.052v5.5826a4.504 4.504 0 0 1-4.4945 4.4944zm-9.6607-4.1254a4.4708 4.4708 0 0 1-.5346-3.0137l.142-.0852 4.783-2.7582a.7712.7712 0 0 0 .7806 0l5.8428 3.3685v2.3324a.0804.0804 0 0 1-.0332.0615L9.74 19.9502a4.4992 4.4992 0 0 1-6.1408-1.6464zM2.3408 7.8956a4.485 4.485 0 0 1 2.3655-1.9728V11.6a.7664.7664 0 0 0 .3879.6765l5.8144 3.3543-2.0201 1.1685a.0757.0757 0 0 1-.071 0l-4.8303-2.7865A4.504 4.504 0 0 1 2.3408 7.872zm16.5963 3.8558L13.1038 8.364 15.1192 7.2a.0757.0757 0 0 1 .071 0l4.8303 2.7913a4.4944 4.4944 0 0 1-.6765 8.1042v-5.6772a.79.79 0 0 0-.407-.667zm2.0107-3.0231l-.142-.0852-4.7735-2.7818a.7759.7759 0 0 0-.7854 0L9.409 9.2297V6.8974a.0662.0662 0 0 1 .0284-.0615l4.8303-2.7866a4.4992 4.4992 0 0 1 6.6802 4.66zM8.3065 12.863l-2.02-1.1638a.0804.0804 0 0 1-.038-.0567V6.0742a4.4992 4.4992 0 0 1 7.3757-3.4537l-.142.0805L8.704 5.459a.7948.7948 0 0 0-.3927.6813zm1.0976-2.3654l2.602-1.4998 2.6069 1.4998v2.9994l-2.5974 1.4997-2.6067-1.4997Z\"/>\n                                                </svg>\n                                                Gerar mensagens com IA\n                                            </div>\n                                            <div class=\"setting-description\">Utiliza inteligência artificial para criar mensagens personalizadas e persuasivas</div>\n                                        </div>\n                                        <label class=\"ai-toggle-switch\">\n                                            <input type=\"checkbox\" id=\"aiMessagesToggle\" onchange=\"toggleAIMessages()\">\n                                            <span class=\"ai-toggle-slider\"></span>\n                                        </label>\n                                    </div>\n                                    \n                                    <!-- Configurações de IA (aparece quando ativado) -->\n                                    <div id=\"aiSettingsContainer\" class=\"ai-settings-container\" style=\"display: none;\">\n                                        <div class=\"ai-settings-content\">\n                                            <div class=\"ai-input-group\">\n                                                <label for=\"aiVariationsCount\">Quantidade de variações de mensagens:</label>\n                                                <input type=\"number\" id=\"aiVariationsCount\" min=\"1\" max=\"10\" value=\"3\" class=\"ai-input\">\n                                            </div>\n                                            \n                                            <div class=\"ai-input-group\">\n                                                <label for=\"aiInstructions\">Instruções adicionais:</label>\n                                                <textarea id=\"aiInstructions\" placeholder=\"Ex: Torne a mensagem mais persuasiva, use tom profissional, inclua call-to-action...\" class=\"ai-textarea\"></textarea>\n                                            </div>\n                                            \n                                            <div class=\"ai-note\">\n                                                <svg class=\"info-icon\" width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\n                                                    <path d=\"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z\"/>\n                                                </svg>\n                                                <span>A mensagem será gerada a partir das mensagens já inseridas e dessas instruções adicionais.</span>\n                                            </div>\n                                            \n                                            <button type=\"button\" class=\"generate-ai-btn\" onclick=\"generateAIMessagesForGroups()\">\n                                                <svg class=\"chatgpt-btn-icon\" width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\n                                                    <path d=\"M22.2819 9.8211a5.9847 5.9847 0 0 0-.5157-4.9108 6.0462 6.0462 0 0 0-6.5098-2.9A6.0651 6.0651 0 0 0 4.9807 4.1818a5.9847 5.9847 0 0 0-3.9977 2.9 6.0462 6.0462 0 0 0 .7427 7.0966 5.98 5.98 0 0 0 .511 4.9107 6.051 6.051 0 0 0 6.5146 2.9001A5.9847 5.9847 0 0 0 13.2599 24a6.0557 6.0557 0 0 0 5.7718-4.2058 5.9894 5.9894 0 0 0 3.9977-2.9001 6.0557 6.0557 0 0 0-.7475-7.0729zm-9.022 12.6081a4.4755 4.4755 0 0 1-2.8764-1.0408l.1419-.0804 4.7783-2.7582a.7948.7948 0 0 0 .3927-.6813v-6.7369l2.02 1.1686a.071.071 0 0 1 .038.052v5.5826a4.504 4.504 0 0 1-4.4945 4.4944zm-9.6607-4.1254a4.4708 4.4708 0 0 1-.5346-3.0137l.142-.0852 4.783-2.7582a.7712.7712 0 0 0 .7806 0l5.8428 3.3685v2.3324a.0804.0804 0 0 1-.0332.0615L9.74 19.9502a4.4992 4.4992 0 0 1-6.1408-1.6464zM2.3408 7.8956a4.485 4.485 0 0 1 2.3655-1.9728V11.6a.7664.7664 0 0 0 .3879.6765l5.8144 3.3543-2.0201 1.1685a.0757.0757 0 0 1-.071 0l-4.8303-2.7865A4.504 4.504 0 0 1 2.3408 7.872zm16.5963 3.8558L13.1038 8.364 15.1192 7.2a.0757.0757 0 0 1 .071 0l4.8303 2.7913a4.4944 4.4944 0 0 1-.6765 8.1042v-5.6772a.79.79 0 0 0-.407-.667zm2.0107-3.0231l-.142-.0852-4.7735-2.7818a.7759.7759 0 0 0-.7854 0L9.409 9.2297V6.8974a.0662.0662 0 0 1 .0284-.0615l4.8303-2.7866a4.4992 4.4992 0 0 1 6.6802 4.66zM8.3065 12.863l-2.02-1.1638a.0804.0804 0 0 1-.038-.0567V6.0742a4.4992 4.4992 0 0 1 7.3757-3.4537l-.142.0805L8.704 5.459a.7948.7948 0 0 0-.3927.6813zm1.0976-2.3654l2.602-1.4998 2.6069 1.4998v2.9994l-2.5974 1.4997-2.6067-1.4997Z\"/>\n                                                </svg>\n                                                <span>Gerar mensagens com IA</span>\n                                            </button>\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n\n                            <div class=\"form-grid\">\n                                <div class=\"form-group\">\n                                    <label for=\"sendDate\">Data para envio *</label>\n                                    <input type=\"datetime-local\" id=\"sendDate\" name=\"sendDate\" required>\n                                </div>\n                                \n                                <div class=\"form-group\">\n                                    <label for=\"selectAll\">Marcar todos do grupo</label>\n                                    <div class=\"toggle-container\">\n                                        <input type=\"checkbox\" id=\"selectAll\" class=\"toggle-checkbox\">\n                                        <div class=\"toggle-switch\" id=\"toggleSwitch\">\n                                            <div class=\"toggle-slider\">\n                                                <span id=\"toggleIcon\">✗</span>\n                                            </div>\n                                        </div>\n                                    </div>\n                                </div>\n\n                                \n                            </div>\n\n                            <button type=\"submit\" class=\"dispatch-btn\" id=\"dispatchBtn\">\n                                <span id=\"btnText\">🚀 Agendar Disparo</span>\n                            </button>\n                        </form>\n\n                        <div class=\"success-message\" id=\"successMessage\"></div>\n                        <div class=\"error-message\" id=\"errorMessage\"></div>\n\n                        <div class=\"stats\" id=\"stats\" style=\"display: none;\">\n                            <div class=\"stat-card\">\n                                <div class=\"stat-value\" id=\"totalLists\">0</div>\n                                <div class=\"stat-label\">Listas Selecionadas</div>\n                            </div>\n                            <div class=\"stat-card\">\n                                <div class=\"stat-value\" id=\"totalMessages\">0</div>\n                                <div class=\"stat-label\">Variações de Mensagem</div>\n                            </div>\n                            <div class=\"stat-card\">\n                                <div class=\"stat-value\" id=\"scheduledDate\">--</div>\n                                <div class=\"stat-label\">Data Agendada</div>\n                            </div>\n                        </div>\n                    </div>\n\n                    <div class=\"phone-preview\">\n                        <div class=\"phone-container\">\n                            <div class=\"phone-screen\">\n                                <div class=\"whatsapp-header\">\n                                    <div class=\"contact-avatar\">👥</div>\n                                    <div class=\"contact-info\">\n                                        <div class=\"contact-name\">Grupo Exemplo</div>\n                                        <div class=\"contact-status\">42 participantes</div>\n                                    </div>\n                                </div>\n                                <div class=\"chat-area\" id=\"chatArea\">\n                                    <div class=\"no-messages\">\n                                        Digite uma mensagem para ver o preview\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        </div>\n    </div>\n\n    <script>\n        // ===== VARIÁVEIS GLOBAIS =====\n        let messageCounter = 0;\n        let connections = [];\n        let selectedConnection = null;\n        let lists = [];\n        let selectedLists = [];\n\n        // ===== ELEMENTOS DOM =====\n        const form = document.getElementById('dispatchForm');\n        const messagesContainer = document.getElementById('messagesContainer');\n        const addMessageBtn = document.getElementById('addMessageBtn');\n        const dispatchBtn = document.getElementById('dispatchBtn');\n        const btnText = document.getElementById('btnText');\n        const successMessage = document.getElementById('successMessage');\n        const errorMessage = document.getElementById('errorMessage');\n        const stats = document.getElementById('stats');\n        const chatArea = document.getElementById('chatArea');\n\n        // ===== FUNÇÕES DE UTILITÁRIO =====\n        \n        // Função para obter cookie por nome\n        function getCookie(name) {\n            const value = `; ${document.cookie}`;\n            const parts = value.split(`; ${name}=`);\n            if (parts.length === 2) return parts.pop().split(';').shift();\n            return null;\n            }\n            \n        // Função para obter userId dos cookies\n        function getSecureUserId() {\n            const userId = getCookie('userId');\n            if (userId && /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(userId)) {\n                console.log('✅ UserId (UUID) obtido dos cookies:', userId);\n                return userId;\n            }\n            \n            console.error('❌ UserId (UUID) não encontrado ou formato inválido nos cookies!');\n            return null;\n        }\n\n        // Função para redirecionar ao histórico\n        function redirectToHistorico() {\n            console.log('🔄 Redirecionando para histórico de disparos...');\n            \n            const userId = getSecureUserId();\n            if (!userId) {\n                console.error('❌ Erro: UserId não encontrado para redirecionamento');\n                showError('Erro na autenticação. Faça login novamente.');\n                return;\n            }\n            \n            console.log('🚀 Redirecionando para histórico...');\n            window.location.href = 'https://n8n.typebot.pro/webhook/historico-disparos';\n        }\n\n        // ===== FUNÇÕES DE TOGGLE =====\n        function handleToggleClick() {\n            const checkbox = document.getElementById('selectAll');\n            const toggleSwitch = document.getElementById('toggleSwitch');\n            \n            // Sempre permite o clique no toggle\n            checkbox.checked = !checkbox.checked;\n            updateToggleVisual();\n            \n            // Mostra feedback visual para o usuário\n            if (checkbox.checked) {\n                showSuccess('Opção ativada: Todos os usuários do grupo serão marcados (@todos) na mensagem.');\n            } else {\n                showSuccess('Opção desativada: Mensagem será enviada normalmente sem marcar usuários.');\n            }\n        }\n\n        function updateToggleVisual() {\n            const checkbox = document.getElementById('selectAll');\n            const toggleSwitch = document.getElementById('toggleSwitch');\n            const toggleIcon = document.getElementById('toggleIcon');\n            \n            if (checkbox.checked) {\n                toggleSwitch.classList.add('active');\n                toggleIcon.textContent = '✓';\n            } else {\n                toggleSwitch.classList.remove('active');\n                toggleIcon.textContent = '✗';\n            }\n        }\n\n        function toggleAllGroups(checkbox) {\n            // Esta função não faz mais nada além de atualizar o visual\n            // O toggle agora é apenas para configurar se deve marcar @todos no WhatsApp\n            updateToggleVisual();\n        }\n\n        // ===== FUNÇÕES DE CONEXÕES =====\n        async function loadConnections() {\n            console.log('📡 === INÍCIO loadConnections() ===');\n            \n            // Mostra loading\n            const container = document.getElementById('connectionsContainer');\n            if (!container) {\n                console.error('❌ Container connectionsContainer não encontrado!');\n                return;\n            }\n            \n            console.log('🔄 Definindo HTML de loading...');\n            container.innerHTML = `\n                <div class=\"loading-connections\">\n                    <div class=\"loading-spinner-large\"></div>\n                    <p>Buscando conexões...</p>\n                </div>\n            `;\n            \n            // Desabilita botão de refresh\n            const refreshBtn = document.querySelector('.refresh-connections-btn-small');\n            if (refreshBtn) {\n                refreshBtn.disabled = true;\n                console.log('🔄 Botão refresh desabilitado');\n            }\n            \n            try {\n                // Verifica se tem userId válido nos cookies\n                const userId = getSecureUserId();\n\n                if (!userId) {\n                    throw new Error('UserId não encontrado nos cookies');\n                }\n\n                console.log('📊 Preparando requisição com userId:', userId);\n                \n                const requestBody = {\n                    userId: userId\n                };\n                \n                console.log('📤 Body da requisição:', requestBody);\n                console.log('📡 Fazendo fetch para:', 'https://n8n.typebot.pro/webhook/listarconexoes');\n                \n                // Faz requisição para listar conexões\n                const response = await fetch('https://n8n.typebot.pro/webhook/listarconexoes', {\n                    method: 'POST',\n                    headers: {\n                        'Content-Type': 'application/json',\n                    },\n                    body: JSON.stringify(requestBody)\n                });\n\n                console.log('📡 Resposta recebida - Status:', response.status);\n                console.log('📡 Resposta recebida - OK:', response.ok);\n\n                if (!response.ok) {\n                    const errorText = await response.text();\n                    console.error('❌ Erro na resposta:', errorText);\n                    throw new Error(`Erro na requisição: ${response.status} - ${errorText}`);\n                }\n\n                const data = await response.json();\n                console.log('✅ Dados recebidos (RAW):', data);\n\n                // Reset das conexões selecionadas\n                selectedConnection = null;\n\n                // Processa as conexões com validação mais robusta\n                console.log('🔍 Verificando estrutura dos dados...');\n                \n                // Inicializa connections como array vazio\n                connections = [];\n                \n                // Verifica se data existe e não é null/undefined\n                if (!data) {\n                    console.log('⚠️ Resposta vazia ou nula da API');\n                    renderNoConnections();\n                    return;\n                }\n                \n                // Caso 1: data.Conexoes (array)\n                if (data.Conexoes && Array.isArray(data.Conexoes)) {\n                    // Filtra conexões válidas (que tenham pelo menos uma propriedade essencial)\n                    connections = data.Conexoes.filter(conn => {\n                        if (!conn || typeof conn !== 'object') return false;\n                        // Verifica se tem pelo menos uma propriedade essencial de conexão\n                        return conn.instanceName || conn.NomeConexao || conn.id || conn.ID || conn.Telefone || conn.telefone;\n                    });\n                    console.log('✅ Estrutura tipo 1: data.Conexoes encontrada');\n                    console.log(`📊 Conexões válidas filtradas: ${connections.length} de ${data.Conexoes.length}`);\n                } \n                // Caso 2: data[0].Conexoes (array dentro de array)\n                else if (Array.isArray(data) && data.length > 0 && data[0] && data[0].Conexoes && Array.isArray(data[0].Conexoes)) {\n                    // Filtra conexões válidas\n                    connections = data[0].Conexoes.filter(conn => {\n                        if (!conn || typeof conn !== 'object') return false;\n                        return conn.instanceName || conn.NomeConexao || conn.id || conn.ID || conn.Telefone || conn.telefone;\n                    });\n                    console.log('✅ Estrutura tipo 2: data[0].Conexoes encontrada');\n                    console.log(`📊 Conexões válidas filtradas: ${connections.length} de ${data[0].Conexoes.length}`);\n                } \n                // Caso 3: data é array direto\n                else if (Array.isArray(data) && data.length > 0) {\n                    // Filtra conexões válidas\n                    connections = data.filter(conn => {\n                        if (!conn || typeof conn !== 'object') return false;\n                        return conn.instanceName || conn.NomeConexao || conn.id || conn.ID || conn.Telefone || conn.telefone;\n                    });\n                    \n                    if (connections.length > 0) {\n                        console.log('✅ Estrutura tipo 3: array direto de conexões');\n                        console.log(`📊 Conexões válidas filtradas: ${connections.length} de ${data.length}`);\n                    } else {\n                        console.log('⚠️ Array não contém conexões válidas');\n                    }\n                } \n                // Caso 4: Array vazio\n                else if (Array.isArray(data) && data.length === 0) {\n                    console.log('⚠️ Array de resposta vazio');\n                    connections = [];\n                }\n                // Caso 5: Objeto vazio ou estrutura desconhecida\n                else {\n                    console.log('⚠️ Estrutura não reconhecida ou dados vazios:', data);\n                    connections = [];\n                }\n\n                console.log('✅ Conexões finais processadas:', connections.length);\n                \n                // Log detalhado das conexões encontradas\n                if (connections.length > 0) {\n                    console.log('📋 Conexões processadas:');\n                    connections.forEach((conn, index) => {\n                        console.log(`  ${index + 1}:`, {\n                            id: conn.id || conn.ID,\n                            nome: conn.NomeConexao || conn.nomeConexao,\n                            instanceName: conn.instanceName,\n                            telefone: conn.Telefone || conn.telefone\n                        });\n                    });\n                } else {\n                    console.log('⚠️ Nenhuma conexão válida encontrada após filtragem');\n                }\n                \n                // Sempre renderiza algo\n                if (connections.length > 0) {\n                    console.log('✅ Primeira conexão processada:', connections[0]);\n                    \n                    // Verifica status de cada conexão\n                    console.log('🔍 Verificando status das conexões...');\n                    await checkConnectionsStatus();\n                    \n                    renderConnections();\n                } else {\n                    console.log('⚠️ Nenhuma conexão encontrada - renderizando mensagem');\n                    renderNoConnections();\n                }\n\n            } catch (error) {\n                console.error('❌ ERRO COMPLETO:', error);\n                console.error('❌ Stack trace:', error.stack);\n                showError(`Erro ao carregar conexões: ${error.message}`);\n                renderConnectionError();\n            } finally {\n                // Reabilita botão de refresh\n                const refreshBtn = document.querySelector('.refresh-connections-btn-small');\n                if (refreshBtn) {\n                    refreshBtn.disabled = false;\n                    console.log('🔄 Botão refresh reabilitado');\n                }\n                console.log('📡 === FIM loadConnections() ===');\n            }\n        }\n\n        // 🔍 Verifica status de conexão de todas as instâncias\n        async function checkConnectionsStatus() {\n            console.log('🔍 === INÍCIO verificação de status ===');\n            \n            // Verifica se há conexões para verificar\n            if (!connections || !Array.isArray(connections) || connections.length === 0) {\n                console.log('⚠️ Nenhuma conexão para verificar status');\n                return;\n            }\n            \n            const baseUrl = 'https://whatsapi.typebot.pro';\n            const apiKey = 'b4d71f9c38e3ac12a6b08e4b6d53aa90';\n            \n            const promises = connections.map(async (connection, index) => {\n                try {\n                    // Validação da conexão antes de verificar\n                    if (!connection || !connection.instanceName) {\n                        console.warn(`⚠️ Conexão ${index} inválida:`, connection);\n                        return;\n                    }\n                    \n                    console.log(`🔍 Verificando status da conexão ${index + 1}/${connections.length}: ${connection.instanceName}`);\n                    \n                    const response = await fetch(`${baseUrl}/instance/connectionState/${connection.instanceName}`, {\n                        method: 'GET',\n                        headers: {\n                            'apikey': apiKey\n                        }\n                    });\n                    \n                    console.log(`📡 Status resposta para ${connection.instanceName}:`, response.status);\n                    \n                    if (response.ok) {\n                        const statusData = await response.json();\n                        console.log(`✅ Status data para ${connection.instanceName}:`, statusData);\n                        \n                        // Atualiza o status da conexão baseado na resposta\n                        connection.connectionStatus = statusData;\n                        \n                        // Verifica se está conectado baseado na resposta da API\n                        const actualState = statusData.instance?.state || statusData.state;\n                        connection.isConnected = actualState === 'open';\n                        \n                        console.log(`📊 Status interpretado para ${connection.instanceName}:`, {\n                            fullResponse: statusData,\n                            instanceState: statusData.instance?.state,\n                            directState: statusData.state,\n                            actualState: actualState,\n                            isConnected: connection.isConnected\n                        });\n                        \n                    } else {\n                        console.log(`❌ Erro ao verificar ${connection.instanceName}: ${response.status}`);\n                        connection.connectionStatus = null;\n                        connection.isConnected = false;\n                    }\n                    \n                } catch (error) {\n                    console.error(`❌ Erro na verificação de ${connection?.instanceName || 'conexão inválida'}:`, error);\n                    if (connection) {\n                        connection.connectionStatus = null;\n                        connection.isConnected = false;\n                    }\n                }\n            });\n            \n            // Aguarda todas as verificações\n            await Promise.all(promises);\n            console.log('✅ Verificação de status concluída para todas as conexões');\n            console.log('🔍 === FIM verificação de status ===');\n        }\n\n        function renderConnections() {\n            const container = document.getElementById('connectionsContainer');\n            \n            if (!connections || connections.length === 0) {\n                console.log('⚠️ Nenhuma conexão para renderizar');\n                renderNoConnections();\n                return;\n            }\n\n            let html = '<div class=\"connections-grid\">';\n            \n            connections.forEach((connection, index) => {\n                // Validação robusta da conexão\n                if (!connection) {\n                    console.warn(`⚠️ Conexão ${index} é null/undefined`);\n                    return;\n                }\n                \n                // Validação e fallback para NomeConexao\n                const nomeConexao = connection.NomeConexao || connection.nomeConexao || connection.name || `Conexão ${index + 1}`;\n                \n                // Validação e fallback para avatar\n                let avatar;\n                if (connection.FotoPerfil) {\n                    avatar = `<img src=\"${connection.FotoPerfil}\" alt=\"${nomeConexao}\">`;\n                } else if (nomeConexao && typeof nomeConexao === 'string' && nomeConexao.length > 0) {\n                    avatar = nomeConexao.charAt(0).toUpperCase();\n                } else {\n                    avatar = '?'; // Fallback se não conseguir extrair inicial\n                }\n                \n                // Determina status baseado na verificação de conexão\n                let status, statusIcon, statusClass;\n                \n                if (connection.isConnected === true) {\n                    status = 'connected';\n                    statusIcon = '✓';\n                    statusClass = 'connected';\n                } else if (connection.isConnected === false) {\n                    status = 'disconnected';\n                    statusIcon = '✗';\n                    statusClass = 'disconnected';\n                } else {\n                    // Fallback para o método antigo (Apikey)\n                    const temApikey = connection.Apikey || connection.apikey;\n                    status = temApikey ? 'connected' : 'disconnected';\n                    statusIcon = temApikey ? '✓' : '✗';\n                    statusClass = temApikey ? 'connected' : 'disconnected';\n                }\n\n                // Validação e fallback para telefone\n                const telefone = connection.Telefone || connection.telefone || connection.phone;\n                const phoneDisplay = telefone || 'Indisponível';\n                \n                // Validação do ID da conexão\n                const connectionId = connection.id || connection.ID || index;\n\n                console.log(`📋 Renderizando conexão ${index}:`, {\n                    id: connectionId,\n                    nome: nomeConexao,\n                    telefone: phoneDisplay,\n                    status: statusClass,\n                    temAvatar: !!connection.FotoPerfil\n                });\n\n                html += `\n                    <div class=\"connection-card\" onclick=\"selectConnection(${connectionId})\" data-connection-id=\"${connectionId}\">\n                        <div class=\"connection-header\">\n                            <div class=\"connection-avatar\">\n                                ${avatar}\n                            </div>\n                            <div class=\"connection-info\">\n                                <div class=\"connection-name\">${nomeConexao}</div>\n                                <div class=\"connection-phone\">${phoneDisplay}</div>\n                            </div>\n                            <div class=\"connection-status-pill ${statusClass}\">${statusIcon}</div>\n                        </div>\n                    </div>\n                `;\n            });\n\n            html += '</div>';\n            html += `\n                <div class=\"connections-selected\" id=\"connectionsSelected\">\n                    <div class=\"selected-count\" id=\"selectedCount\">Nenhuma conexão selecionada</div>\n                </div>\n            `;\n\n            container.innerHTML = html;\n            console.log('✅ Conexões renderizadas com sucesso');\n        }\n\n        function renderNoConnections() {\n            const container = document.getElementById('connectionsContainer');\n            container.innerHTML = `\n                <div class=\"no-connections\">\n                    <h3>❌ Nenhuma conexão encontrada</h3>\n                    <p>Você não possui conexões configuradas no sistema.</p>\n                    <p>É necessário ter pelo menos uma conexão ativa para fazer disparos em grupos.</p>\n                    <br>\n                    <button type=\"button\" class=\"add-message-btn\" onclick=\"navigateToPage('https://n8n.typebot.pro/webhook/conectar')\">\n                        🔗 Criar Nova Conexão\n                    </button>\n                </div>\n            `;\n        }\n\n        function renderConnectionError() {\n            const container = document.getElementById('connectionsContainer');\n            container.innerHTML = `\n                <div class=\"no-connections\">\n                    <h3>Erro ao carregar conexões</h3>\n                    <p>Não foi possível carregar suas conexões. Tente novamente.</p>\n                    <br>\n                    <button type=\"button\" class=\"add-message-btn\" onclick=\"loadConnections()\">\n                        🔄 Tentar Novamente\n                    </button>\n                </div>\n            `;\n        }\n\n        function selectConnection(connectionId) {\n            // Validação do connectionId\n            if (connectionId === undefined || connectionId === null) {\n                console.error('❌ ConnectionId inválido:', connectionId);\n                showError('Erro ao selecionar conexão. ID inválido.');\n                return;\n            }\n            \n            // Remove seleção anterior\n            document.querySelectorAll('.connection-card').forEach(card => {\n                card.classList.remove('selected');\n            });\n            \n            // Seleciona nova conexão\n            const card = document.querySelector(`[data-connection-id=\"${connectionId}\"]`);\n            const connection = connections.find(conn => {\n                const connId = conn.id || conn.ID;\n                return connId == connectionId; // Usa == para comparar números e strings\n            });\n            \n            if (card && connection) {\n                card.classList.add('selected');\n                selectedConnection = connection;\n                \n                updateSelectedConnectionDisplay();\n                \n                updateStats();\n                \n                const nomeConexao = connection.NomeConexao || connection.nomeConexao || connection.name || 'Conexão';\n                showSuccess(`Conexão \"${nomeConexao}\" selecionada!`);\n            } else {\n                console.error('❌ Conexão não encontrada:', { connectionId, card: !!card, connection: !!connection });\n                showError('Erro ao selecionar conexão.');\n            }\n        }\n\n        function updateSelectedConnectionDisplay() {\n            const selectedDiv = document.getElementById('connectionsSelected');\n            const countDiv = document.getElementById('selectedCount');\n            \n            if (selectedConnection) {\n                selectedDiv.classList.add('show');\n                countDiv.textContent = `Conexão selecionada: ${selectedConnection.NomeConexao}`;\n            } else {\n                selectedDiv.classList.remove('show');\n                countDiv.textContent = 'Nenhuma conexão selecionada';\n            }\n            \n            // Verifica se deve mostrar o aviso do WhatsApp\n            checkWhatsAppWarning();\n        }\n\n        // ===== FUNÇÃO PARA VERIFICAR AVISO DO WHATSAPP =====\n        function checkWhatsAppWarning() {\n            const warningDiv = document.getElementById('whatsappWarning');\n            \n            if (!warningDiv) {\n                console.warn('⚠️ Elemento whatsappWarning não encontrado');\n                return;\n            }\n            \n            // Mostra o aviso se uma conexão E pelo menos uma lista estiverem selecionadas\n            if (selectedConnection && selectedLists.length > 0) {\n                warningDiv.classList.add('show');\n                console.log('⚠️ Aviso do WhatsApp mostrado - conexão e lista selecionadas');\n            } else {\n                warningDiv.classList.remove('show');\n                console.log('ℹ️ Aviso do WhatsApp oculto - conexão ou lista não selecionadas');\n            }\n        }\n\n        // ===== FUNÇÕES DE LISTAS =====\n        \n        // 📋 Função para carregar listas\n        async function loadLists() {\n            console.log('📋 === INÍCIO loadLists() ===');\n            \n            // Mostra loading\n            const container = document.getElementById('listsContainer');\n            if (!container) {\n                console.error('❌ Container listsContainer não encontrado!');\n                return;\n            }\n            \n            console.log('🔄 Definindo HTML de loading...');\n            container.innerHTML = `\n                <div class=\"loading-lists\">\n                    <div class=\"loading-spinner-large\"></div>\n                    <p>Buscando listas...</p>\n                </div>\n            `;\n            \n            // Desabilita botão de refresh\n            const refreshBtn = document.querySelector('.refresh-lists-btn-small');\n            if (refreshBtn) {\n                refreshBtn.disabled = true;\n                console.log('🔄 Botão refresh desabilitado');\n            }\n            \n            try {\n                // Verifica se tem userId válido nos cookies\n                const userId = getSecureUserId();\n\n            if (!userId) {\n                    throw new Error('UserId não encontrado nos cookies');\n                }\n\n                console.log('📊 Preparando requisição com userId:', userId);\n                \n                const requestBody = {\n                    userId: userId\n                };\n                \n                console.log('📤 Body da requisição:', requestBody);\n                console.log('📡 Fazendo fetch para:', 'https://n8n.typebot.pro/webhook/puxar-lista');\n                \n                // Faz requisição para listar listas\n                const response = await fetch('https://n8n.typebot.pro/webhook/puxar-lista', {\n                    method: 'POST',\n                    headers: {\n                        'Content-Type': 'application/json',\n                    },\n                    body: JSON.stringify(requestBody)\n                });\n\n                console.log('📡 Resposta recebida - Status:', response.status);\n                console.log('📡 Resposta recebida - OK:', response.ok);\n\n                if (!response.ok) {\n                    const errorText = await response.text();\n                    console.error('❌ Erro na resposta:', errorText);\n                    throw new Error(`Erro na requisição: ${response.status} - ${errorText}`);\n            }\n            \n                const data = await response.json();\n                console.log('✅ Dados recebidos (RAW):', data);\n\n                // Reset das listas selecionadas\n                selectedLists = [];\n            \n                // Processa as listas - filtra apenas listas de grupos\n                console.log('🔍 Verificando estrutura dos dados...');\n                \n                let rawLists = [];\n                \n                if (data && data.data && Array.isArray(data.data)) {\n                    rawLists = data.data;\n                    console.log('✅ Estrutura tipo 1: data.data encontrada');\n                } else if (data && Array.isArray(data)) {\n                    rawLists = data;\n                    console.log('✅ Estrutura tipo 2: array direto encontrada');\n                } else {\n                    console.log('⚠️ Estrutura não reconhecida:', data);\n                    rawLists = [];\n                }\n\n                console.log('📊 Listas brutas encontradas:', rawLists.length);\n            \n                // Filtra apenas listas do tipo \"groups\" para disparos em grupos\n                lists = rawLists.filter(list => {\n                    if (!list || typeof list !== 'object') {\n                        console.log('❌ Lista inválida (não é objeto):', list);\n            return false;\n        }\n\n                    const isValid = list.tipo === 'groups';\n                    if (isValid) {\n                        console.log('✅ Lista de grupos válida:', list.nome || 'Sem nome');\n                    }\n                    return isValid;\n                });\n\n                console.log(`✅ Listas de grupos filtradas: ${lists.length} de ${rawLists.length} listas`);\n\n                if (lists.length > 0) {\n                    console.log('✅ Primeira lista válida processada:', lists[0]);\n                    renderLists();\n                } else {\n                    console.log('⚠️ Nenhuma lista de grupos encontrada');\n                    renderNoLists();\n                }\n\n            } catch (error) {\n                console.error('❌ ERRO COMPLETO:', error);\n                console.error('❌ Stack trace:', error.stack);\n                showError(`Erro ao carregar listas: ${error.message}`);\n                renderListError();\n            } finally {\n                // Reabilita botão de refresh\n                const refreshBtn = document.querySelector('.refresh-lists-btn-small');\n                if (refreshBtn) {\n                    refreshBtn.disabled = false;\n                    console.log('🔄 Botão refresh reabilitado');\n                }\n                console.log('📋 === FIM loadLists() ===');\n            }\n        }\n\n        // 🎨 Renderiza as listas\n        function renderLists() {\n            const container = document.getElementById('listsContainer');\n            \n            if (lists.length === 0) {\n                renderNoLists();\n                return;\n            }\n\n            let html = '<div class=\"lists-grid\">';\n            \n            lists.forEach(list => {\n                const listName = list.nome || 'Lista sem nome';\n                const listId = list.id;\n                \n                html += `\n                    <div class=\"list-card\" onclick=\"toggleList(${listId})\" data-list-id=\"${listId}\">\n                        <div class=\"list-info\">\n                            <div class=\"list-icon\">👥</div>\n                            <div class=\"list-name\">${listName}</div>\n                        </div>\n                        </div>\n                    `;\n                });\n                \n            html += '</div>';\n            html += `\n                <div class=\"lists-selected\" id=\"listsSelected\">\n                    <div class=\"selected-lists-count\" id=\"selectedListsCount\">0 listas selecionadas</div>\n                </div>\n            `;\n\n            container.innerHTML = html;\n            console.log(`✅ ${lists.length} listas renderizadas com sucesso`);\n        }\n\n        // 🚫 Renderiza quando não há listas\n        function renderNoLists() {\n            const container = document.getElementById('listsContainer');\n            container.innerHTML = `\n                <div class=\"no-lists\">\n                    <h3>👥 Nenhuma lista de grupos encontrada</h3>\n                    <p>Você não possui listas de grupos configuradas no sistema.</p>\n                    <p>É necessário ter pelo menos uma lista de grupos para fazer disparos em listas.</p>\n                    <br>\n                    <button type=\"button\" class=\"add-message-btn\" onclick=\"goToListas()\">\n                        👥 Criar Nova Lista de Grupos\n                    </button>\n                </div>\n            `;\n        }\n\n        // ⚠️ Renderiza erro de listas\n        function renderListError() {\n            const container = document.getElementById('listsContainer');\n            container.innerHTML = `\n                <div class=\"no-lists\">\n                    <h3>Erro ao carregar listas</h3>\n                    <p>Não foi possível carregar suas listas. Tente novamente.</p>\n                    <br>\n                    <button type=\"button\" class=\"add-message-btn\" onclick=\"loadLists()\">\n                        🔄 Tentar Novamente\n                    </button>\n                </div>\n            `;\n        }\n\n        // 🔄 Alterna seleção de lista\n        function toggleList(listId) {\n            const card = document.querySelector(`[data-list-id=\"${listId}\"]`);\n            const index = selectedLists.indexOf(listId);\n            \n            if (index === -1) {\n                // Adiciona à seleção\n                selectedLists.push(listId);\n                card.classList.add('selected');\n            } else {\n                // Remove da seleção\n                selectedLists.splice(index, 1);\n                card.classList.remove('selected');\n            }\n            \n            updateSelectedListsCount();\n            updateStats();\n        }\n\n        // 📊 Atualiza contador de listas selecionadas\n        function updateSelectedListsCount() {\n            const selectedDiv = document.getElementById('listsSelected');\n            const countDiv = document.getElementById('selectedListsCount');\n            const warningDiv = document.getElementById('multipleListsWarning');\n            \n            if (selectedLists.length > 0) {\n                selectedDiv.classList.add('show');\n                countDiv.textContent = `${selectedLists.length} lista${selectedLists.length !== 1 ? 's' : ''} selecionada${selectedLists.length !== 1 ? 's' : ''}`;\n            } else {\n                selectedDiv.classList.remove('show');\n            }\n            \n            // Mostra aviso quando múltiplas listas são selecionadas\n            if (warningDiv) {\n                if (selectedLists.length > 1) {\n                    warningDiv.classList.add('show');\n                } else {\n                    warningDiv.classList.remove('show');\n                }\n            }\n            \n            // Verifica se deve mostrar o aviso do WhatsApp\n            checkWhatsAppWarning();\n        }\n\n        // Sistema de Navegação Simples\n        function navigateToPage(targetUrl) {\n            console.log('🔗 Navegando para:', targetUrl);\n            \n            // Verifica se existe userId nos cookies\n            const userId = getSecureUserId();\n            if (!userId) {\n                console.log('❌ Usuário não autenticado');\n                alert('Sessão inválida. Redirecionando para login...');\n                setTimeout(() => {\n                    window.location.href = 'https://n8n.typebot.pro/webhook/login';\n                }, 2000);\n                return false;\n        }\n            \n            console.log('🚀 Redirecionando...');\n            window.location.href = targetUrl;\n            return false;\n        }\n\n\n\n\n\n        // ===== FUNÇÕES DE MENSAGENS =====\n        function addMessage() {\n            messageCounter++;\n            const messageDiv = document.createElement('div');\n            messageDiv.className = 'message-item';\n            messageDiv.innerHTML = `\n                <div class=\"message-header\">\n                    <span class=\"message-title\">Mensagem ${messageCounter}</span>\n                    <button type=\"button\" class=\"remove-message\" onclick=\"removeMessage(this)\">\n                        Remover\n                    </button>\n                </div>\n                <div class=\"form-group\">\n                    <label>Texto da mensagem *</label>\n                    <div class=\"variables-section\">\n                        <div class=\"variables-label\">Variáveis disponíveis:</div>\n                        <div class=\"variables-container\" id=\"variables-${messageCounter}\">\n                            <span class=\"no-variables\">Apenas variáveis de tempo disponíveis</span>\n                        </div>\n                    </div>\n                    <div class=\"formatting-buttons\">\n                        <button type=\"button\" class=\"format-btn\" onclick=\"formatText(this, 'bold')\" title=\"Negrito\">\n                            <strong>B</strong>\n                        </button>\n                        <button type=\"button\" class=\"format-btn\" onclick=\"formatText(this, 'italic')\" title=\"Itálico\">\n                            <em>I</em>\n                        </button>\n                    </div>\n                    <textarea name=\"message\" placeholder=\"Digite sua mensagem aqui... Ex: <saudacao>! Enviado para o grupo em <data> às <hora>.\" required oninput=\"updatePreview()\"></textarea>\n                </div>\n                <div class=\"media-upload\">\n                    <div class=\"media-btn\" onclick=\"selectMedia(this, 'image')\">\n                        <input type=\"file\" accept=\"image/*\" onchange=\"handleMediaUpload(this, 'image')\">\n                        📷 Imagem\n                        <span class=\"file-size-limit\">Máx: 16MB</span>\n                    </div>\n                    <div class=\"media-btn\" onclick=\"selectMedia(this, 'video')\">\n                        <input type=\"file\" accept=\"video/*\" onchange=\"handleMediaUpload(this, 'video')\">\n                        🎥 Vídeo\n                        <span class=\"file-size-limit\">Máx: 16MB</span>\n                    </div>\n                    <div class=\"media-btn\" onclick=\"selectMedia(this, 'audio')\">\n                        <input type=\"file\" accept=\"audio/*\" onchange=\"handleMediaUpload(this, 'audio')\">\n                        🎵 Áudio\n                        <span class=\"file-size-limit\">Máx: 16MB</span>\n                    </div>\n                    <div class=\"media-btn\" onclick=\"selectMedia(this, 'document')\">\n                        <input type=\"file\" accept=\".pdf,.doc,.docx,.txt\" onchange=\"handleMediaUpload(this, 'document')\">\n                        📄 Documento\n                        <span class=\"file-size-limit\">Máx: 16MB</span>\n                    </div>\n                </div>\n                <div class=\"media-preview-section\"></div>\n            `;\n            messagesContainer.appendChild(messageDiv);\n            updateStats();\n            updatePreview();\n            \n            // Atualiza variáveis para a nova mensagem\n            updateVariablesForAllMessages();\n        }\n\n        function removeMessage(button) {\n            if (messagesContainer.children.length > 1) {\n                button.closest('.message-item').remove();\n                updateStats();\n                updatePreview();\n            } else {\n                showError('Deve haver pelo menos uma mensagem.');\n            }\n        }\n\n        function selectMedia(button, type) {\n            const input = button.querySelector('input[type=\"file\"]');\n            input.click();\n        }\n\n        function handleMediaUpload(input, type) {\n            const file = input.files[0];\n            if (!file) return;\n\n            // Validação de tamanho de arquivo (16MB = 16 * 1024 * 1024 bytes)\n            const maxSize = 16 * 1024 * 1024; // 16MB em bytes\n            if (file.size > maxSize) {\n                showError(`Arquivo muito grande! O tamanho máximo permitido é 16MB. Tamanho atual: ${formatFileSize(file.size)}`);\n                input.value = ''; // Limpa o input\n                return;\n            }\n\n            const messageItem = input.closest('.message-item');\n            const previewSection = messageItem.querySelector('.media-preview-section');\n            const mediaBtn = input.closest('.media-btn');\n\n            // Clear previous media\n            previewSection.innerHTML = '';\n            messageItem.querySelectorAll('.media-btn').forEach(btn => btn.classList.remove('active'));\n\n            // Mark button as active\n            mediaBtn.classList.add('active');\n\n            // Show media info\n            const mediaInfo = document.createElement('div');\n            mediaInfo.className = 'media-selected';\n            \n            let icon;\n            switch(type) {\n                case 'image': icon = '📷'; break;\n                case 'video': icon = '🎥'; break;\n                case 'audio': icon = '🎵'; break;\n                case 'document': icon = '📄'; break;\n            }\n\n            mediaInfo.innerHTML = `\n                <div class=\"media-info-display\">\n                    <span class=\"media-icon-display\">${icon}</span>\n                    <div>\n                        <div class=\"media-name-display\">${file.name}</div>\n                        <div class=\"media-size-display\">${formatFileSize(file.size)}</div>\n                    </div>\n                </div>\n                <button type=\"button\" class=\"remove-media-btn\" onclick=\"removeMedia(this)\">✕</button>\n            `;\n\n            previewSection.appendChild(mediaInfo);\n            updatePreview();\n        }\n\n        function removeMedia(button) {\n            const messageItem = button.closest('.message-item');\n            const previewSection = messageItem.querySelector('.media-preview-section');\n            previewSection.innerHTML = '';\n            messageItem.querySelectorAll('.media-btn').forEach(btn => btn.classList.remove('active'));\n            messageItem.querySelectorAll('input[type=\"file\"]').forEach(input => input.value = '');\n            updatePreview();\n        }\n\n        function formatFileSize(bytes) {\n            if (bytes === 0) return '0 Bytes';\n            const k = 1024;\n            const sizes = ['Bytes', 'KB', 'MB', 'GB'];\n            const i = Math.floor(Math.log(bytes) / Math.log(k));\n            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];\n        }\n\n        // ===== FUNÇÕES DE PREVIEW =====\n        function updatePreview() {\n            try {\n                console.log('👁️ updatePreview() iniciada');\n                \n            const messageItems = messagesContainer.querySelectorAll('.message-item');\n                const chatArea = document.getElementById('chatArea');\n                \n                console.log('📝 Mensagens encontradas para preview:', messageItems.length);\n                \n                if (!chatArea) {\n                    console.error('❌ Chat area não encontrada');\n                    return;\n                }\n                \n                // Clear previous messages\n            chatArea.innerHTML = '';\n\n            if (messageItems.length === 0) {\n                chatArea.innerHTML = '<div class=\"no-messages\">Digite uma mensagem para ver o preview</div>';\n                    console.log('✅ Preview atualizado com mensagem vazia');\n                return;\n            }\n\n                // Gera valores dinâmicos atuais para variáveis de tempo\n                const now = new Date();\n                const hora = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });\n                const data = now.toLocaleDateString('pt-BR');\n                const diasSemana = ['Domingo', 'Segunda-feira', 'Terça-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira', 'Sábado'];\n                const diadasemana = diasSemana[now.getDay()];\n                const meses = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];\n                const mes = meses[now.getMonth()];\n                \n                // Calcula saudação baseada na hora\n                const currentHour = now.getHours();\n                let saudacao;\n                if (currentHour >= 5 && currentHour < 12) {\n                    saudacao = 'Bom dia';\n                } else if (currentHour >= 12 && currentHour < 18) {\n                    saudacao = 'Boa tarde';\n                } else {\n                    saudacao = 'Boa noite';\n                }\n                \n                const tempoVarsValues = {\n                    'saudacao': saudacao,\n                    'hora': hora,\n                    'data': data,\n                    'diadasemana': diadasemana,\n                    'mes': mes\n                };\n\n            // Show preview of each message variation\n            messageItems.forEach((item, index) => {\n                    try {\n                const textarea = item.querySelector('textarea');\n                        const text = textarea ? textarea.value.trim() : '';\n                const mediaInputs = item.querySelectorAll('input[type=\"file\"]');\n                \n                // Encontra mídia selecionada\n                let selectedMedia = null;\n                for (let input of mediaInputs) {\n                    if (input.files.length > 0) {\n                        const parentBtn = input.closest('.media-btn');\n                                if (parentBtn && parentBtn.classList.contains('active')) {\n                            const file = input.files[0];\n                            let mediaType = null;\n                            \n                            if (parentBtn.textContent.includes('Imagem')) mediaType = 'image';\n                            else if (parentBtn.textContent.includes('Vídeo')) mediaType = 'video';\n                            else if (parentBtn.textContent.includes('Áudio')) mediaType = 'audio';\n                            else if (parentBtn.textContent.includes('Documento')) mediaType = 'document';\n                            \n                            selectedMedia = { file, type: mediaType };\n                            break;\n                        }\n                    }\n                }\n\n                if (text || selectedMedia) {\n                    const messageDiv = document.createElement('div');\n                    messageDiv.className = 'message-bubble';\n                    \n                    let content = '';\n                    \n                    // Add media preview\n                    if (selectedMedia) {\n                        content += createMediaPreview(selectedMedia);\n                    }\n                    \n                    // Add text content\n                    if (text) {\n                                // Destaca as variáveis e aplica formatação no preview\n                                let previewText = text;\n                                const availableVariables = getAvailableVariables();\n                                // Ordena por tamanho decrescente para evitar conflitos\n                                const sortedVars = [...availableVariables].sort((a, b) => b.length - a.length);\n                                // Aplica formatação (negrito e itálico)\n                                previewText = previewText.replace(/\\*(.*?)\\*/g, '<strong>$1</strong>');\n                                previewText = previewText.replace(/_(.*?)_/g, '<em>$1</em>');\n                                // Destaca as variáveis\n                                sortedVars.forEach(variable => {\n                                    // Regex seguro para pegar exatamente <variavel>\n                                    const regex = new RegExp(`(<${variable}>)`, 'g');\n                                    if (tempoVarsValues[variable]) {\n                                        previewText = previewText.replace(regex, `<span style=\"background: rgba(37, 211, 102, 0.15); color: #25d366; font-weight: 600; padding: 2px 6px; border-radius: 4px; border: 1px solid rgba(37, 211, 102, 0.3); font-size: 0.85em;\">${tempoVarsValues[variable]}</span>`);\n                                    } else {\n                                        const label = variable.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');\n                                        previewText = previewText.replace(regex, `<span style=\"background: rgba(37, 211, 102, 0.15); color: #25d366; font-weight: 600; padding: 2px 6px; border-radius: 4px; border: 1px solid rgba(37, 211, 102, 0.3); font-size: 0.85em;\">&lt;${label}&gt;</span>`);\n                                    }\n                                });\n                                content += `<div class=\"message-text\">${previewText}</div>`;\n                            }\n                            \n                            content += `<div class=\"message-time\">${hora}</div>`;\n                    \n                    messageDiv.innerHTML = content;\n                    chatArea.appendChild(messageDiv);\n                        }\n                    } catch (error) {\n                        console.error(`❌ Erro ao processar mensagem ${index + 1}:`, error);\n                }\n            });\n\n            if (chatArea.children.length === 0) {\n                chatArea.innerHTML = '<div class=\"no-messages\">Digite uma mensagem para ver o preview</div>';\n                }\n                \n                console.log('✅ updatePreview() finalizada');\n            } catch (error) {\n                console.error('❌ Erro em updatePreview:', error);\n            }\n        }\n\n        function createMediaPreview(media) {\n            const { file, type } = media;\n            const fileName = file.name;\n            const fileSize = formatFileSize(file.size);\n            \n            switch (type) {\n                case 'image':\n                    const imageUrl = URL.createObjectURL(file);\n                    return `\n                        <div class=\"media-preview-whatsapp\">\n                            <img src=\"${imageUrl}\" alt=\"${fileName}\" class=\"image-preview-whatsapp\" onload=\"URL.revokeObjectURL(this.src)\">\n                        </div>\n                    `;\n                    \n                case 'video':\n                    const videoUrl = URL.createObjectURL(file);\n                    return `\n                        <div class=\"media-preview-whatsapp\">\n                            <video class=\"video-preview-whatsapp\" controls>\n                                <source src=\"${videoUrl}\" type=\"${file.type}\">\n                            </video>\n                            <div class=\"video-overlay\">\n                                <div class=\"play-button\">▶</div>\n                            </div>\n                        </div>\n                    `;\n                    \n                case 'audio':\n                    const audioUrl = URL.createObjectURL(file);\n                    return `\n                        <div class=\"audio-preview-whatsapp\">\n                            <div class=\"audio-icon\">🎵</div>\n                            <div class=\"audio-info\">\n                                <div class=\"audio-name\">${fileName}</div>\n                                <div class=\"audio-duration\">${fileSize}</div>\n                            </div>\n                            <audio controls class=\"audio-controls\">\n                                <source src=\"${audioUrl}\" type=\"${file.type}\">\n                            </audio>\n                        </div>\n                    `;\n                    \n                case 'document':\n                    return `\n                        <div class=\"document-preview-whatsapp\">\n                            <div class=\"document-icon\">📎</div>\n                            <div class=\"document-info\">\n                                <div class=\"document-name\">${fileName}</div>\n                                <div class=\"document-size\">${fileSize}</div>\n                            </div>\n                        </div>\n                    `;\n                    \n                default:\n                    return '';\n            }\n        }\n\n        // ===== FUNÇÕES DE ESTATÍSTICAS =====\n        function updateStats() {\n            const messageCount = messagesContainer ? messagesContainer.children.length : 0;\n            const listsCount = selectedLists.length;\n            const sendDate = document.getElementById('sendDate')?.value;\n            \n            const totalMessagesEl = document.getElementById('totalMessages');\n            const totalListsEl = document.getElementById('totalLists');\n            const scheduledDateEl = document.getElementById('scheduledDate');\n            \n            if (totalMessagesEl) totalMessagesEl.textContent = messageCount;\n            if (totalListsEl) totalListsEl.textContent = listsCount;\n            \n            if (scheduledDateEl) {\n                if (sendDate) {\n                    const date = new Date(sendDate);\n                    scheduledDateEl.textContent = date.toLocaleDateString('pt-BR');\n                } else {\n                    scheduledDateEl.textContent = '--';\n                }\n            }\n\n            if (stats && (messageCount > 0 || listsCount > 0)) {\n                stats.style.display = 'grid';\n            }\n        }\n\n        // ===== FUNÇÕES DE MENSAGENS DE FEEDBACK =====\n        function showSuccess(message) {\n            if (successMessage) {\n                successMessage.textContent = message;\n                successMessage.classList.add('show');\n            }\n            if (errorMessage) {\n                errorMessage.classList.remove('show');\n            }\n            \n            setTimeout(() => {\n                if (successMessage) {\n                    successMessage.classList.remove('show');\n                }\n            }, 5000);\n        }\n\n        function showError(message) {\n            if (errorMessage) {\n                errorMessage.textContent = message;\n                errorMessage.classList.add('show');\n            }\n            if (successMessage) {\n                successMessage.classList.remove('show');\n            }\n            \n            setTimeout(() => {\n                if (errorMessage) {\n                    errorMessage.classList.remove('show');\n                }\n            }, 5000);\n        }\n\n\n\n        // ===== FUNÇÃO DE SUBMISSÃO =====\n        async function handleSubmit(e) {\n            e.preventDefault();\n            console.log('📤 === INÍCIO handleSubmit() ===');\n            \n            const dispatchBtn = document.getElementById('dispatchBtn');\n            const btnText = document.getElementById('btnText');\n            \n            // Validações básicas\n            if (!selectedConnection) {\n                showError('Por favor, selecione uma conexão.');\n                return;\n            }\n            \n            if (selectedLists.length === 0) {\n                showError('Por favor, selecione pelo menos uma lista de grupos.');\n                return;\n            }\n            \n            const messageItems = messagesContainer.querySelectorAll('.message-item');\n            if (messageItems.length === 0) {\n                showError('Por favor, adicione pelo menos uma mensagem.');\n                return;\n            }\n            \n            const sendDate = document.getElementById('sendDate').value;\n            if (!sendDate) {\n                showError('Por favor, selecione uma data para envio.');\n                return;\n            }\n            \n            // Verificar se todas as mensagens têm conteúdo\n            let hasValidMessage = false;\n            for (let item of messageItems) {\n                const textarea = item.querySelector('textarea');\n                if (textarea.value.trim()) {\n                    hasValidMessage = true;\n                    break;\n                }\n            }\n            \n            if (!hasValidMessage) {\n                showError('Por favor, digite pelo menos uma mensagem.');\n                return;\n            }\n            \n            // Desabilita botão e mostra loading\n            dispatchBtn.disabled = true;\n            btnText.innerHTML = '📤 Agendando... <span class=\"loading-spinner-small\"></span>';\n            \n            try {\n                console.log('📊 Coletando dados do formulário...');\n                \n                // Coleta informações das mensagens com mídias\n                const messages = [];\n                \n                for (let i = 0; i < messageItems.length; i++) {\n                    const item = messageItems[i];\n                    const textarea = item.querySelector('textarea');\n                    const messageText = textarea.value.trim();\n                    \n                    if (!messageText) continue; // Pula mensagens vazias\n                    \n                    let messageData = {\n                        text: messageText,\n                        type: 'text'\n                    };\n                    \n                    // Verifica se tem mídia anexada\n                    const mediaInputs = item.querySelectorAll('input[type=\"file\"]');\n                    for (let input of mediaInputs) {\n                        if (input.files.length > 0) {\n                            const parentBtn = input.closest('.media-btn');\n                            if (parentBtn.classList.contains('active')) {\n                                const file = input.files[0];\n                                \n                                console.log(`📎 Processando mídia: ${file.name}`);\n                                \n                                // Converte arquivo para base64\n                                const base64 = await fileToBase64(file);\n                                \n                                // Determina tipo de mídia\n                                let mediaType = 'document';\n                                if (parentBtn.textContent.includes('Imagem')) mediaType = 'image';\n                                else if (parentBtn.textContent.includes('Vídeo')) mediaType = 'video';\n                                else if (parentBtn.textContent.includes('Áudio')) mediaType = 'audio';\n                                \n                                messageData = {\n                                    text: messageText,\n                                    type: 'text',\n                                    media: {\n                                        filename: file.name,\n                                        mimetype: file.type,\n                                        type: mediaType,\n                                        base64: base64\n                                    }\n                                };\n                                \n                                console.log(`✅ Mídia processada: ${file.name} (${mediaType})`);\n                                break;\n                            }\n                        }\n                    }\n                    \n                    messages.push(messageData);\n                }\n                \n                // Pega configuração do toggle marcar usuários\n                const selectAllCheckbox = document.getElementById('selectAll');\n                const marcarTodos = selectAllCheckbox.checked;\n                \n                // Converte data para formato UTC correto\n                // sendDate vem do input datetime-local (fuso horário local do usuário)\n                const sendDateLocal = new Date(sendDate);\n                // Converte para UTC mantendo o horário local\n                const scheduleDataUTC = sendDateLocal.toISOString();\n                \n                console.log('📅 Data de envio processada:', {\n                    original: sendDate,\n                    local: sendDateLocal.toLocaleString('pt-BR'),\n                    utc: scheduleDataUTC,\n                    timezone: 'UTC'\n                });\n                \n                // Monta objeto da requisição\n                const requestData = {\n                    // ID do usuário\n                    userId: getSecureUserId(),\n                    \n                    // Conexões selecionadas (array)\n                    connections: [\n                        {\n                            id: selectedConnection.id,\n                            instanceName: selectedConnection.instanceName,\n                            nomeConexao: selectedConnection.NomeConexao,\n                            telefone: selectedConnection.Telefone,\n                            apikey: selectedConnection.Apikey || selectedConnection.apikey || null\n                        }\n                    ],\n                    \n                    // IDs das listas de grupos selecionadas\n                    idLista: selectedLists,\n                    \n                    // Mensagens com mídias\n                    messages: messages,\n                    \n                    // Contatos (vazio para disparos em grupos)\n                    contacts: [],\n                    \n                    // Configurações de envio\n                    settings: {\n                        scheduleData: scheduleDataUTC, // Data/hora agendada em UTC\n                        mencionarTodos: marcarTodos // Toggle mencionar todos\n                    }\n                };\n                \n                console.log('📋 Dados preparados para envio:', {\n                    userId: requestData.userId,\n                    conexao: requestData.connections[0].nomeConexao,\n                    apikey: requestData.connections[0].apikey ? 'PRESENTE' : 'AUSENTE',\n                    totalListas: requestData.idLista.length,\n                    totalMensagens: requestData.messages.length,\n                    dataEnvio: requestData.settings.scheduleData,\n                    mencionarTodos: requestData.settings.mencionarTodos\n                });\n                \n                // Faz requisição para agendar\n                console.log('📡 Enviando requisição para agendar...');\n                \n                const response = await fetch('https://n8n.typebot.pro/webhook/db56b0fb-cc58-4d51-8755-d7e04ccaa120123', {\n                    method: 'POST',\n                    headers: {\n                        'Content-Type': 'application/json',\n                    },\n                    body: JSON.stringify(requestData)\n                });\n                \n                console.log('📡 Resposta recebida - Status:', response.status);\n                \n                if (!response.ok) {\n                    const errorText = await response.text();\n                    console.error('❌ Erro na resposta:', errorText);\n                    throw new Error(`Erro ao agendar disparo: ${response.status} - ${errorText}`);\n                }\n                \n                const responseData = await response.json();\n                console.log('✅ Disparo agendado com sucesso:', responseData);\n                \n                // Mostra mensagem de sucesso\n                showSuccess(`🎉 Disparo agendado com sucesso! Será enviado para ${selectedLists.length} lista${selectedLists.length !== 1 ? 's' : ''} de grupos em ${new Date(sendDate).toLocaleString('pt-BR')}.`);\n                \n                // Aguarda 2 segundos para mostrar a mensagem de sucesso\n                setTimeout(() => {\n                    // Redireciona para histórico de disparos com autenticação\n                    redirectToHistorico();\n                }, 2000);\n                \n                // Opcionalmente, limpa o formulário\n                // resetForm();\n                \n            } catch (error) {\n                console.error('❌ ERRO ao agendar disparo:', error);\n                showError(`Erro ao agendar disparo: ${error.message}`);\n                \n            } finally {\n                // Reabilita botão\n                dispatchBtn.disabled = false;\n                btnText.innerHTML = '🚀 Agendar Disparo';\n                \n                console.log('📤 === FIM handleSubmit() ===');\n            }\n        }\n        \n        // ===== FUNÇÃO AUXILIAR PARA CONVERTER ARQUIVO PARA BASE64 =====\n        function fileToBase64(file) {\n            return new Promise((resolve, reject) => {\n                const reader = new FileReader();\n                reader.readAsDataURL(file);\n                reader.onload = () => {\n                    // Remove o prefixo \"data:image/jpeg;base64,\" e similares\n                    const base64 = reader.result.split(',')[1];\n                    resolve(base64);\n                };\n                reader.onerror = error => reject(error);\n            });\n        }\n        \n        // ===== FUNÇÃO PARA RESETAR FORMULÁRIO (OPCIONAL) =====\n        function resetForm() {\n            console.log('🔄 Resetando formulário...');\n            \n            // Limpa listas selecionadas\n            selectedLists = [];\n            updateSelectedListsCount();\n            \n            // Limpa mensagens (mantém apenas uma)\n            messagesContainer.innerHTML = '';\n            messageCounter = 0;\n            addMessage();\n            \n            // Limpa campos\n            document.getElementById('sendDate').value = '';\n            document.getElementById('selectAll').checked = false;\n            updateToggleVisual();\n            \n            // Limpa conexão selecionada\n            document.querySelectorAll('.connection-card').forEach(card => {\n                card.classList.remove('selected');\n            });\n            selectedConnection = null;\n            updateSelectedConnectionDisplay();\n            \n            updateStats();\n            updatePreview();\n            \n            console.log('✅ Formulário resetado');\n        }\n\n        // ===== FUNCTION TO TEST =====\n        function testFunction() {\n            console.log('🧪 FUNÇÃO DE TESTE CHAMADA!');\n            alert('Função de teste funcionando!');\n        }\n\n        // ===== INICIALIZAÇÃO =====\n        function init() {\n            console.log('🚀 === INIT FUNCTION ===');\n            \n            // Inicializar autenticação e limpar URL\n            initializeAuth();\n            \n            // Set minimum date to now\n            const now = new Date();\n            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());\n            const sendDateInput = document.getElementById('sendDate');\n            if (sendDateInput) {\n                sendDateInput.min = now.toISOString().slice(0,16);\n            }\n\n            // Load connections first\n            loadConnections();\n\n            // Load lists in background\n            console.log('📋 Chamando loadLists()...');\n            loadLists().then(() => {\n                console.log('✅ loadLists() finalizada');\n            }).catch(error => {\n                console.error('❌ Erro ao carregar listas:', error);\n            });\n\n            // Add first message\n            addMessage();\n\n            // Update initial preview\n            updatePreview();\n            updateStats();\n\n            // Habilita o toggle de marcar usuários (sempre habilitado)\n            const toggleSwitch = document.getElementById('toggleSwitch');\n            if (toggleSwitch) {\n                toggleSwitch.addEventListener('click', handleToggleClick);\n            }\n\n            // Event listener para fechar dropdowns de variáveis quando clicar fora\n            document.addEventListener('click', function(event) {\n                if (!event.target.closest('.time-variables-container')) {\n                    document.querySelectorAll('.time-variables-dropdown').forEach(dropdown => {\n                        dropdown.style.display = 'none';\n                        const toggleBtn = dropdown.closest('.time-variables-container')?.querySelector('.time-toggle-btn');\n                        if (toggleBtn) {\n                            toggleBtn.classList.remove('expanded');\n                        }\n                    });\n                }\n            });\n        }\n\n        // Função para inicializar autenticação via cookies\n        function initializeAuth() {\n            console.log('🔐 Verificando autenticação via cookies...');\n            \n            const userId = getSecureUserId();\n            \n            if (!userId) {\n                console.log('❌ Usuário não autenticado - Redirecionando');\n                alert('Sessão inválida. Redirecionando para login...');\n                window.location.href = 'https://n8n.typebot.pro/webhook/login';\n                return;\n            }\n            \n            console.log('✅ Usuário autenticado via cookies');\n        }\n\n        // ===== EVENT LISTENERS =====\n        document.addEventListener('DOMContentLoaded', function() {\n            console.log('🚀 === DOM CONTENT LOADED ===');\n            \n            // Lista todos os elementos para debug\n            console.log('📋 Elementos encontrados:');\n            console.log('- addMessageBtn:', !!document.getElementById('addMessageBtn'));\n            console.log('- form:', !!document.getElementById('dispatchForm'));\n\n            console.log('- sendDate:', !!document.getElementById('sendDate'));\n            \n            // Inicializa a página\n            init();\n\n            // Adiciona event listeners\n            const addMessageBtn = document.getElementById('addMessageBtn');\n            const form = document.getElementById('dispatchForm');\n            const sendDate = document.getElementById('sendDate');\n            \n            if (addMessageBtn) {\n                addMessageBtn.addEventListener('click', addMessage);\n                console.log('✅ Event listener adicionado ao botão de mensagem');\n            }\n\n            if (form) {\n                form.addEventListener('submit', handleSubmit);\n                console.log('✅ Event listener adicionado ao formulário');\n            }\n\n\n\n            // Date input change handler\n            if (sendDate) {\n                sendDate.addEventListener('change', updateStats);\n                console.log('✅ Event listener adicionado ao campo de data');\n            }\n\n            console.log('✅ === TODOS OS EVENT LISTENERS CONFIGURADOS ===');\n        });\n\n\n\n\n\n        // Função para controlar o toggle de mensagens com IA\n        function toggleAIMessages() {\n            const toggle = document.getElementById('aiMessagesToggle');\n            const aiSettingsContainer = document.getElementById('aiSettingsContainer');\n            const isEnabled = toggle.checked;\n            \n            console.log(`🤖 IA para mensagens ${isEnabled ? 'ativada' : 'desativada'}`);\n            \n            if (isEnabled) {\n                aiSettingsContainer.style.display = 'block';\n                showSuccess('IA ativada! Configure as opções abaixo para gerar mensagens personalizadas.');\n            } else {\n                aiSettingsContainer.style.display = 'none';\n            }\n        }\n\n        // Função para verificar se IA está ativa\n        function isAIEnabled() {\n            const toggle = document.getElementById('aiMessagesToggle');\n            return toggle ? toggle.checked : false;\n        }\n\n        // Função para gerar mensagens com IA para grupos\n        async function generateAIMessagesForGroups() {\n            const variationsCount = document.getElementById('aiVariationsCount').value;\n            const instructions = document.getElementById('aiInstructions').value;\n            const button = document.querySelector('.generate-ai-btn');\n            \n            console.log('🤖 Gerando mensagens com IA para grupos...');\n            console.log('📊 Configurações:', { variationsCount, instructions });\n            \n            // Validações básicas\n            if (!variationsCount || variationsCount < 1 || variationsCount > 10) {\n                showError('Quantidade de variações deve ser entre 1 e 10.');\n                return;\n            }\n            \n            // Verifica se há mensagens existentes\n            const existingMessages = messagesContainer.querySelectorAll('.message-item');\n            if (existingMessages.length === 0) {\n                showError('Adicione pelo menos uma mensagem antes de gerar variações com IA.');\n                return;\n            }\n            \n            // Obtém o userId dos cookies\n            const userId = getSecureUserId();\n            \n            if (!userId) {\n                showError('Erro: usuário não identificado. Faça login novamente.');\n                return;\n            }\n            \n            // Coleta as mensagens existentes como variações\n            const existingVariations = [];\n            existingMessages.forEach(messageItem => {\n                const textarea = messageItem.querySelector('textarea');\n                if (textarea && textarea.value.trim()) {\n                    existingVariations.push(textarea.value.trim());\n                }\n            });\n            \n            // Desabilita o botão e mostra estado de carregamento com animação\n            button.disabled = true;\n            button.style.position = 'relative';\n            button.innerHTML = `\n                <svg class=\"chatgpt-btn-icon loading-icon\" width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" style=\"animation: spin 1s linear infinite;\">\n                    <circle cx=\"12\" cy=\"12\" r=\"10\"/>\n                    <path d=\"M16 12a4 4 0 0 0-8 0\"/>\n                </svg>\n                <span>Gerando mensagens...</span>\n                <style>\n                    @keyframes spin {\n                        from { transform: rotate(0deg); }\n                        to { transform: rotate(360deg); }\n                    }\n                </style>\n            `;\n            \n            try {\n                // Prepara o payload para a API\n                const payload = {\n                    userId: userId,\n                    variacoesMensagens: existingVariations,\n                    instrucoesAdicionais: instructions || '',\n                    quantidadeMensagens: parseInt(variationsCount),\n                    tipo: 'grupos' // Identificador específico para grupos\n                };\n                \n                console.log('📤 Enviando requisição para API de IA:', payload);\n                \n                // Faz a requisição POST para a API\n                const response = await fetch('https://n8n.typebot.pro/webhook/gerarmensagem-ia', {\n                    method: 'POST',\n                    headers: {\n                        'Content-Type': 'application/json',\n                    },\n                    body: JSON.stringify(payload)\n                });\n                \n                console.log('📡 Status da resposta:', response.status);\n                \n                if (!response.ok) {\n                    const errorText = await response.text();\n                    console.error('❌ Erro na resposta:', errorText);\n                    throw new Error(`Erro na requisição: ${response.status} - ${errorText}`);\n                }\n                \n                const result = await response.json();\n                console.log('✅ Resposta da API:', result);\n                \n                // Processa a resposta correta da API (aninhada em result.mensagens.mensagens)\n                if (result && result.mensagens && result.mensagens.mensagens && Array.isArray(result.mensagens.mensagens)) {\n                    const generatedMessages = result.mensagens.mensagens;\n                    \n                    // Adiciona cada mensagem gerada como um novo bloco\n                    generatedMessages.forEach(mensagem => {\n                        addMessage();\n                        \n                        // Atualiza o texto da última mensagem adicionada\n                        const lastMessage = messagesContainer.lastElementChild;\n                        const textarea = lastMessage.querySelector('textarea');\n                        if (textarea && mensagem) {\n                            textarea.value = mensagem;\n                            textarea.dispatchEvent(new Event('input')); // Dispara o evento para atualizar o preview\n                        }\n                    });\n                    \n                    updateStats();\n                    updatePreview();\n                    updateVariablesForAllMessages();\n                    \n                    showSuccess(`${generatedMessages.length} mensagens geradas com IA com sucesso para grupos!`);\n                } else {\n                    console.error('❌ Estrutura de resposta inválida:', result);\n                    throw new Error('Resposta da API não contém mensagens válidas na estrutura esperada');\n                }\n                \n            } catch (error) {\n                console.error('❌ Erro ao gerar mensagens com IA:', error);\n                showError(`Erro ao gerar mensagens: ${error.message}`);\n            } finally {\n                // Restaura o botão\n                button.disabled = false;\n                button.style.position = '';\n                button.innerHTML = `\n                    <svg class=\"chatgpt-btn-icon\" width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\n                        <path d=\"M22.2819 9.8211a5.9847 5.9847 0 0 0-.5157-4.9108 6.0462 6.0462 0 0 0-6.5098-2.9A6.0651 6.0651 0 0 0 4.9807 4.1818a5.9847 5.9847 0 0 0-3.9977 2.9 6.0462 6.0462 0 0 0 .7427 7.0966 5.98 5.98 0 0 0 .511 4.9107 6.051 6.051 0 0 0 6.5146 2.9001A5.9847 5.9847 0 0 0 13.2599 24a6.0557 6.0557 0 0 0 5.7718-4.2058 5.9894 5.9894 0 0 0 3.9977-2.9001 6.0557 6.0557 0 0 0-.7475-7.0729zm-9.022 12.6081a4.4755 4.4755 0 0 1-2.8764-1.0408l.1419-.0804 4.7783-2.7582a.7948.7948 0 0 0 .3927-.6813v-6.7369l2.02 1.1686a.071.071 0 0 1 .038.052v5.5826a4.504 4.504 0 0 1-4.4945 4.4944zm-9.6607-4.1254a4.4708 4.4708 0 0 1-.5346-3.0137l.142-.0852 4.783-2.7582a.7712.7712 0 0 0 .7806 0l5.8428 3.3685v2.3324a.0804.0804 0 0 1-.0332.0615L9.74 19.9502a4.4992 4.4992 0 0 1-6.1408-1.6464zM2.3408 7.8956a4.485 4.485 0 0 1 2.3655-1.9728V11.6a.7664.7664 0 0 0 .3879.6765l5.8144 3.3543-2.0201 1.1685a.0757.0757 0 0 1-.071 0l-4.8303-2.7865A4.504 4.504 0 0 1 2.3408 7.872zm16.5963 3.8558L13.1038 8.364 15.1192 7.2a.0757.0757 0 0 1 .071 0l4.8303 2.7913a4.4944 4.4944 0 0 1-.6765 8.1042v-5.6772a.79.79 0 0 0-.407-.667zm2.0107-3.0231l-.142-.0852-4.7735-2.7818a.7759.7759 0 0 0-.7854 0L9.409 9.2297V6.8974a.0662.0662 0 0 1 .0284-.0615l4.8303-2.7866a4.4992 4.4992 0 0 1 6.6802 4.66zM8.3065 12.863l-2.02-1.1638a.0804.0804 0 0 1-.038-.0567V6.0742a4.4992 4.4992 0 0 1 7.3757-3.4537l-.142.0805L8.704 5.459a.7948.7948 0 0 0-.3927.6813zm1.0976-2.3654l2.602-1.4998 2.6069 1.4998v2.9994l-2.5974 1.4997-2.6067-1.4997Z\"/>\n                    </svg>\n                    <span>Gerar mensagens com IA</span>\n                `;\n            }\n            }\n            \n        // Sistema de variáveis avançado já implementado acima\n\n\n\n\n\n        // 🔤 Função para obter apenas as variáveis de tempo disponíveis\n        function getAvailableVariables() {\n            // Apenas variáveis de tempo para grupos\n            const variables = ['saudacao', 'hora', 'data', 'diadasemana', 'mes'];\n            console.log('🔤 Variáveis de tempo disponíveis:', variables);\n            return variables;\n        }\n\n        // 🔤 Função para atualizar variáveis em todas as mensagens\n        function updateVariablesForAllMessages() {\n            try {\n                console.log('🔤 updateVariablesForAllMessages() iniciada');\n                \n                const messageItems = messagesContainer.querySelectorAll('.message-item');\n                console.log('📝 Mensagens encontradas:', messageItems.length);\n                \n                if (messageItems.length === 0) {\n                    console.log('⚠️ Nenhuma mensagem encontrada para atualizar variáveis');\n                    return;\n                }\n                \n                const availableVariables = getAvailableVariables();\n                console.log('🔤 Variáveis disponíveis:', availableVariables);\n                \n                messageItems.forEach((item, index) => {\n                    const variablesContainer = item.querySelector('.variables-container');\n                    if (variablesContainer) {\n                        updateVariablesInContainer(variablesContainer, availableVariables);\n                        console.log(`✅ Variáveis atualizadas na mensagem ${index + 1}`);\n                } else {\n                        console.log(`⚠️ Container de variáveis não encontrado na mensagem ${index + 1}`);\n                }\n                });\n                \n                console.log('✅ updateVariablesForAllMessages() finalizada');\n            } catch (error) {\n                console.error('❌ Erro em updateVariablesForAllMessages:', error);\n            }\n        }\n\n        // 🔤 Função para atualizar variáveis em um container específico (apenas tempo)\n        function updateVariablesInContainer(container, variables) {\n            if (variables.length === 0) {\n                container.innerHTML = '<span class=\"no-variables\">Nenhuma variável de tempo disponível</span>';\n                return;\n            }\n            \n            // Função para formatar nome bonitinho\n            function formatVarName(name) {\n                if (name === 'diadasemana') return 'Dia da semana';\n                return name.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');\n            }\n            \n            // Todas são variáveis de tempo para grupos\n            const timeVariables = variables;\n            \n            let html = '';\n                \n            // SVG do relógio com cor herdada\n            const clockSVG = `<svg width=\"16\" height=\"16\" viewBox=\"0 0 16 16\" fill=\"none\" style=\"vertical-align:middle;margin-right:4px;\" xmlns=\"http://www.w3.org/2000/svg\"><circle cx=\"8\" cy=\"8\" r=\"7\" stroke=\"currentColor\" stroke-width=\"2\" fill=\"none\"/><path d=\"M8 4.5V8L10.5 10\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\"/></svg>`;\n            // Ícone de seta para expandir\n            const arrowSVG = `<svg width=\"12\" height=\"12\" viewBox=\"0 0 12 12\" fill=\"none\" style=\"vertical-align:middle;margin-left:4px;transition:transform 0.2s;\" xmlns=\"http://www.w3.org/2000/svg\"><path d=\"M3 4.5L6 7.5L9 4.5\" stroke=\"currentColor\" stroke-width=\"1.5\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/></svg>`;\n            \n            // Botão expansível para variáveis de tempo\n            if (timeVariables.length > 0) {\n                html += `\n                    <div class=\"time-variables-container\">\n                        <button type=\"button\" class=\"variable-btn time-toggle-btn\" onclick=\"toggleTimeVariables(this)\">\n                            ${clockSVG}Variáveis de tempo${arrowSVG}\n                        </button>\n                        <div class=\"time-variables-dropdown\" style=\"display: none;\">\n                `;\n                \n                timeVariables.forEach(variable => {\n                    const label = formatVarName(variable);\n                    html += `<button type=\"button\" class=\"variable-btn time-var-btn\" onclick=\"insertVariable(this, '${variable}')\">${clockSVG}${label}</button>`;\n                });\n                \n                html += '</div></div>';\n            }\n            \n            container.innerHTML = html;\n        }\n\n        // 🔤 Função para inserir variável no textarea\n        function insertVariable(button, variableName) {\n            const messageItem = button.closest('.message-item');\n            const textarea = messageItem.querySelector('textarea');\n            const variableText = `<${variableName}>`;\n            \n            // Obtém a posição atual do cursor\n            const start = textarea.selectionStart;\n            const end = textarea.selectionEnd;\n            const text = textarea.value;\n            \n            // Insere a variável na posição do cursor\n            const newText = text.substring(0, start) + variableText + text.substring(end);\n            textarea.value = newText;\n            \n            // Reposiciona o cursor após a variável inserida\n            const newCursorPos = start + variableText.length;\n            textarea.setSelectionRange(newCursorPos, newCursorPos);\n            \n            // Foca no textarea e atualiza o preview\n            textarea.focus();\n            updatePreview();\n            \n            // Fecha o dropdown de variáveis de tempo se estiver aberto\n            const timeContainer = button.closest('.time-variables-container');\n            if (timeContainer) {\n                const dropdown = timeContainer.querySelector('.time-variables-dropdown');\n                const toggleBtn = timeContainer.querySelector('.time-toggle-btn');\n                if (dropdown && dropdown.style.display === 'block') {\n                    dropdown.style.display = 'none';\n                    toggleBtn.classList.remove('expanded');\n            }\n            }\n            \n            // Feedback visual temporário\n            button.style.background = 'rgba(37, 211, 102, 0.3)';\n            setTimeout(() => {\n                button.style.background = '';\n            }, 200);\n        }\n\n        // 🔄 Função para toggle das variáveis de tempo\n        function toggleTimeVariables(button) {\n            const container = button.closest('.time-variables-container');\n            const dropdown = container.querySelector('.time-variables-dropdown');\n            const isExpanded = dropdown.style.display === 'block';\n            \n            // Fecha outros dropdowns abertos\n            document.querySelectorAll('.time-variables-dropdown').forEach(dd => {\n                if (dd !== dropdown) {\n                    dd.style.display = 'none';\n                    dd.closest('.time-variables-container').querySelector('.time-toggle-btn').classList.remove('expanded');\n                }\n            });\n            \n            // Toggle do dropdown atual\n            if (isExpanded) {\n                dropdown.style.display = 'none';\n                button.classList.remove('expanded');\n            } else {\n                dropdown.style.display = 'block';\n                button.classList.add('expanded');\n            }\n        }\n\n        // 🔤 Função para aplicar formatação (negrito/itálico)\n        function formatText(button, type) {\n            const messageItem = button.closest('.message-item');\n            const textarea = messageItem.querySelector('textarea');\n            \n            // Obtém a seleção atual\n            const start = textarea.selectionStart;\n            const end = textarea.selectionEnd;\n            const selectedText = textarea.value.substring(start, end);\n            \n            if (selectedText.length === 0) {\n                // Se não há texto selecionado, mostra mensagem\n                showError('Selecione o texto que deseja formatar.');\n                return;\n            }\n            \n            // Define os delimitadores baseado no tipo\n            let prefix, suffix;\n            switch(type) {\n                case 'bold':\n                    prefix = '*';\n                    suffix = '*';\n                    break;\n                case 'italic':\n                    prefix = '_';\n                    suffix = '_';\n                    break;\n                default:\n                    return;\n            }\n            \n            // Aplica a formatação\n            const text = textarea.value;\n            const newText = text.substring(0, start) + prefix + selectedText + suffix + text.substring(end);\n            textarea.value = newText;\n            \n            // Reposiciona o cursor\n            const newCursorPos = end + prefix.length + suffix.length;\n            textarea.setSelectionRange(newCursorPos, newCursorPos);\n            \n            // Foca no textarea e atualiza o preview\n            textarea.focus();\n            updatePreview();\n            \n            // Feedback visual temporário\n            button.style.background = 'rgba(37, 211, 102, 0.3)';\n            setTimeout(() => {\n                button.style.background = '';\n            }, 200);\n        }\n\n        // Função de logout\n        function logout() {\n            console.log('🚪 Iniciando logout...');\n            \n            // Limpar todos os cookies\n            document.cookie = 'userId=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';\n            document.cookie = 'idLista=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';\n            document.cookie = 'idConexao=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';\n            document.cookie = 'idDisparo=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';\n            \n            // Limpar sessionStorage\n            sessionStorage.clear();\n            \n            console.log('🧹 Cookies e sessionStorage limpos');\n            console.log('🔄 Redirecionando para login...');\n            \n            // Redirecionar para página de login\n            window.location.href = 'https://n8n.typebot.pro/webhook/login';\n        }\n    </script>\n</body>\n</html>"},"type":"n8n-nodes-base.html","typeVersion":1.2,"position":[-4240,-6192],"id":"eb853853-2381-4c9b-bef8-31ea3c7fb549","name":"HTML5"},{"parameters":{"respondWith":"text","responseBody":"={{ $json.html }}","options":{}},"type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-4016,-6192],"id":"159ff873-0a70-4747-b50f-4103ccebe8be","name":"Respond to Webhook4"},{"parameters":{"path":"disparos-grupos","responseMode":"responseNode","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-4448,-6192],"id":"939ed27e-9be9-45cc-b2a7-df9935e24499","name":"DISPAROS GRUPOS","webhookId":"44ef5672-bb5e-47cb-8c16-50d5ffb78a8c"},{"parameters":{"content":"## VERIFICAR GRUPO","height":440,"width":1220,"color":4},"type":"n8n-nodes-base.stickyNote","position":[-3600,-5568],"typeVersion":1,"id":"7bd5f6cf-f2b8-4996-bbb6-abcf91ca0312","name":"Sticky Note12"},{"parameters":{"httpMethod":"POST","path":"verificargrupo","responseMode":"lastNode","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-3536,-5408],"id":"44ea2089-0d10-444e-87f0-46ae35362f53","name":"Webhook5","webhookId":"0d210c58-1258-4a4b-a3ff-c6b5d1e7b9fc"},{"parameters":{"assignments":{"assignments":[{"id":"c16002cb-6afa-4ec1-8cdf-f8b5108f3af8","name":"admin","value":"=true","type":"boolean"},{"id":"fdbc636c-3c34-4cb1-bc32-ae1db878c77a","name":"nomeGrupo","value":"={{ $item(\"0\").$node[\"LISTAR GRUPO\"].json[\"subject\"] }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-3136,-5408],"id":"6758fc79-0fe9-4443-ad30-eee1832aa37f","name":"RESPOSTA3"},{"parameters":{"url":"=https://whatsapi.typebot.pro/group/inviteInfo/{{ $json.body.instanceName }}?inviteCode={{ $json.body.linkGrupo.replaceAll('https://chat.whatsapp.com/','') }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apikey","value":"=b4d71f9c38e3ac12a6b08e4b6d53aa90"}]},"options":{"redirect":{"redirect":{}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-3328,-5408],"id":"0178b613-62db-40bb-9bdb-b39d7b8ed18f","name":"LISTAR GRUPO"},{"parameters":{"content":"## Recebe mensagem disparo grupo\n","height":1360,"width":4160,"color":3},"type":"n8n-nodes-base.stickyNote","position":[-1776,-5328],"typeVersion":1,"id":"50382b7d-9feb-4813-9b62-2fdc9268b7c9","name":"Sticky Note4"},{"parameters":{"content":"## LISTAR DISPAROS\n","height":1240,"width":1200,"color":4},"type":"n8n-nodes-base.stickyNote","position":[-3600,-576],"typeVersion":1,"id":"ad592af4-879b-4db0-9968-4bc2323f1dbf","name":"Sticky Note13"},{"parameters":{"httpMethod":"POST","path":"listadisparos","responseMode":"lastNode","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-3520,-464],"id":"9a222049-83ce-4e38-a6ca-a42ab2ffffd9","name":"Webhook7","webhookId":"0d210c58-1258-4a4b-a3ff-c6b5d1e7b9fc"},{"parameters":{"assignments":{"assignments":[{"id":"c16002cb-6afa-4ec1-8cdf-f8b5108f3af8","name":"disparos","value":"={{ $json.data }}","type":"array"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-2832,-464],"id":"4ebccfa1-adce-4948-b844-09a32d26c5c1","name":"RESPOSTA5"},{"parameters":{"aggregate":"aggregateAllItemData","options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[-3072,-464],"id":"c2250ff2-8618-4ba7-ac6e-685c9c53821b","name":"Aggregate1"},{"parameters":{"operation":"getAll","tableId":"SAAS_Disparos","matchType":"allFilters","filters":{"conditions":[{"keyName":"userId","condition":"eq","keyValue":"={{ $json.body.userId }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-3296,-464],"id":"bf3a93fb-2fc4-4863-a777-9f5795bc2519","name":"BUSCAR DISPAROS","alwaysOutputData":true,"credentials":{"supabaseApi":{"id":"gSmzosOueGcVRiU6","name":"supabase enviazap"}}},{"parameters":{"content":"## Tela histórico de disparos","height":260,"width":760,"color":2},"type":"n8n-nodes-base.stickyNote","position":[-4512,-5968],"typeVersion":1,"id":"9f6bdb37-408c-4b7d-af29-4b8db1a571d6","name":"Sticky Note14"},{"parameters":{"html":"<!DOCTYPE html>\n<html lang=\"pt-BR\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>Histórico de Disparos - EnviaZap</title>\n    <style>\n        * {\n            margin: 0;\n            padding: 0;\n            box-sizing: border-box;\n        }\n\n        body {\n            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);\n            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n            color: white;\n            min-height: 100vh;\n            margin: 0;\n            padding: 0;\n        }\n\n        .app-layout {\n            display: flex;\n            min-height: 100vh;\n        }\n\n        /* Sidebar */\n        .sidebar {\n            width: 70px;\n            background: rgba(0, 0, 0, 0.3);\n            backdrop-filter: blur(10px);\n            border-right: 1px solid rgba(255, 255, 255, 0.1);\n            transition: all 0.3s ease;\n            position: relative;\n            z-index: 1000;\n            display: flex;\n            flex-direction: column;\n            height: 100vh;\n        }\n\n        .sidebar:hover {\n            width: 250px;\n        }\n\n        .sidebar-header {\n            padding: 20px;\n            text-align: center;\n            border-bottom: 1px solid rgba(255, 255, 255, 0.1);\n        }\n\n        .sidebar-logo {\n            font-size: 1.5rem;\n            font-weight: 600;\n            background: linear-gradient(135deg, #25d366 0%, #128c7e 100%);\n            -webkit-background-clip: text;\n            -webkit-text-fill-color: transparent;\n            background-clip: text;\n            white-space: nowrap;\n            opacity: 0;\n            transition: opacity 0.3s ease;\n        }\n\n        .sidebar:hover .sidebar-logo {\n            opacity: 1;\n        }\n\n        .sidebar-menu {\n            padding: 20px 0;\n            flex: 1;\n        }\n\n        .menu-item {\n            display: flex;\n            align-items: center;\n            padding: 15px 20px;\n            color: #ccc;\n            text-decoration: none;\n            transition: all 0.3s ease;\n            position: relative;\n            white-space: nowrap;\n        }\n\n        .menu-item:hover {\n            background: rgba(37, 211, 102, 0.1);\n            color: #25d366;\n        }\n\n        .menu-item.active {\n            background: rgba(37, 211, 102, 0.2);\n            color: #25d366;\n            border-right: 3px solid #25d366;\n        }\n\n        .menu-icon {\n            font-size: 1.2rem;\n            width: 30px;\n            text-align: center;\n            flex-shrink: 0;\n        }\n\n        .menu-text {\n            margin-left: 15px;\n            opacity: 0;\n            transition: opacity 0.3s ease;\n        }\n\n        .sidebar:hover .menu-text {\n            opacity: 1;\n        }\n\n        .sidebar-footer {\n            margin-top: auto;\n            border-top: 1px solid rgba(255, 255, 255, 0.1);\n            padding: 10px 0;\n        }\n\n        .logout-item {\n            color: #ff6b6b !important;\n        }\n\n        .logout-item:hover {\n            background: rgba(255, 107, 107, 0.1) !important;\n            color: #ff6b6b !important;\n        }\n\n        /* Main content */\n        .main-content {\n            flex: 1;\n            padding: 30px;\n            overflow-x: auto;\n        }\n\n        .header {\n            margin-bottom: 40px;\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n        }\n\n        .header-info h1 {\n            font-size: 2.5rem;\n            font-weight: 600;\n            margin-bottom: 10px;\n        }\n\n        .header-info p {\n            color: #888;\n            font-size: 1.1rem;\n        }\n\n        .header-actions {\n            display: flex;\n            gap: 15px;\n        }\n\n        .btn-refresh {\n            padding: 12px 20px;\n            background: linear-gradient(135deg, #25d366 0%, #128c7e 100%);\n            border: none;\n            border-radius: 8px;\n            color: white;\n            font-weight: 600;\n            cursor: pointer;\n            transition: all 0.3s ease;\n            display: flex;\n            align-items: center;\n            gap: 8px;\n            font-size: 0.9rem;\n        }\n\n        .btn-refresh:hover {\n            transform: translateY(-2px);\n            box-shadow: 0 8px 25px rgba(37, 211, 102, 0.3);\n        }\n\n        .btn-refresh:disabled {\n            background: #444;\n            cursor: not-allowed;\n            transform: none;\n        }\n\n        /* Loading state */\n        .loading-container {\n            display: flex;\n            flex-direction: column;\n            align-items: center;\n            justify-content: center;\n            min-height: 400px;\n            gap: 20px;\n        }\n\n        .loading-spinner {\n            width: 60px;\n            height: 60px;\n            border: 4px solid rgba(37, 211, 102, 0.3);\n            border-top: 4px solid #25d366;\n            border-radius: 50%;\n            animation: spin 1s linear infinite;\n        }\n\n        .loading-text {\n            color: #25d366;\n            font-size: 1.2rem;\n            font-weight: 500;\n        }\n\n        /* Table styles */\n        .table-container {\n            background: rgba(255, 255, 255, 0.02);\n            border: 1px solid rgba(255, 255, 255, 0.1);\n            border-radius: 16px;\n            backdrop-filter: blur(10px);\n            overflow: hidden;\n            min-height: 400px;\n        }\n\n\n\n        .disparos-table {\n            width: 100%;\n            border-collapse: collapse;\n        }\n\n        .disparos-table th {\n            background: rgba(255, 255, 255, 0.05);\n            padding: 20px 16px;\n            text-align: left;\n            font-weight: 600;\n            color: #fff;\n            border-bottom: 1px solid rgba(255, 255, 255, 0.1);\n            font-size: 0.9rem;\n            text-transform: uppercase;\n            letter-spacing: 0.5px;\n        }\n\n        .disparos-table td {\n            padding: 20px 16px;\n            border-bottom: 1px solid rgba(255, 255, 255, 0.05);\n            vertical-align: middle;\n        }\n\n        .disparos-table tr:hover {\n            background: rgba(255, 255, 255, 0.02);\n        }\n\n        .disparos-table tr:last-child td {\n            border-bottom: none;\n        }\n\n        /* Pills */\n        .pill {\n            padding: 6px 12px;\n            border-radius: 20px;\n            font-size: 0.8rem;\n            font-weight: 600;\n            display: inline-block;\n            white-space: nowrap;\n        }\n\n        .pill-individual {\n            background: rgba(52, 199, 89, 0.2);\n            color: #34c759;\n            border: 1px solid rgba(52, 199, 89, 0.3);\n        }\n\n        .pill-grupos {\n            background: rgba(0, 122, 255, 0.2);\n            color: #007aff;\n            border: 1px solid rgba(0, 122, 255, 0.3);\n        }\n\n        .pill-em-andamento {\n            background: rgba(255, 193, 7, 0.2);\n            color: #ffc107;\n            border: 1px solid rgba(255, 193, 7, 0.3);\n        }\n\n        .pill-agendado {\n            background: rgba(175, 82, 222, 0.2);\n            color: #af52de;\n            border: 1px solid rgba(175, 82, 222, 0.3);\n        }\n\n        .pill-enviado {\n            background: rgba(52, 199, 89, 0.2);\n            color: #34c759;\n            border: 1px solid rgba(52, 199, 89, 0.3);\n        }\n\n        .pill-finalizado {\n            background: rgba(52, 199, 89, 0.2);\n            color: #34c759;\n            border: 1px solid rgba(52, 199, 89, 0.3);\n        }\n\n        .pill-cancelado {\n            background: rgba(255, 59, 48, 0.2);\n            color: #ff3b30;\n            border: 1px solid rgba(255, 59, 48, 0.3);\n        }\n\n        .pill-pausado {\n            background: rgba(255, 193, 7, 0.2);\n            color: #ffc107;\n            border: 1px solid rgba(255, 193, 7, 0.3);\n        }\n\n        /* Progress bar */\n        .progress-container {\n            width: 120px;\n            height: 8px;\n            background: rgba(255, 255, 255, 0.1);\n            border-radius: 4px;\n            overflow: hidden;\n        }\n\n        .progress-bar {\n            height: 100%;\n            background: linear-gradient(135deg, #25d366 0%, #128c7e 100%);\n            border-radius: 4px;\n            transition: width 0.3s ease;\n        }\n\n        .progress-text {\n            font-size: 0.8rem;\n            color: #888;\n            margin-top: 4px;\n        }\n\n        /* Date formatting */\n        .date-cell {\n            color: #ccc;\n            font-size: 0.9rem;\n        }\n\n        .date-time {\n            display: block;\n            color: #888;\n            font-size: 0.8rem;\n            margin-top: 2px;\n        }\n\n        /* Count formatting */\n        .count-cell {\n            text-align: center;\n            color: #25d366;\n            font-weight: 600;\n        }\n\n        /* Empty state */\n        .empty-state {\n            text-align: center;\n            padding: 60px 20px;\n            color: #888;\n        }\n\n        .empty-icon {\n            font-size: 4rem;\n            margin-bottom: 20px;\n            opacity: 0.5;\n        }\n\n        .empty-state h3 {\n            font-size: 1.5rem;\n            margin-bottom: 10px;\n            color: #ccc;\n        }\n\n        .empty-state p {\n            font-size: 1rem;\n            line-height: 1.5;\n        }\n\n        /* Error/Success messages */\n        .error-message, .success-message {\n            padding: 20px;\n            border-radius: 12px;\n            margin: 20px 0;\n            text-align: center;\n        }\n\n        .error-message {\n            background: rgba(255, 59, 48, 0.1);\n            border: 1px solid rgba(255, 59, 48, 0.3);\n            color: #ff3b30;\n        }\n\n        .success-message {\n            background: rgba(52, 199, 89, 0.1);\n            border: 1px solid rgba(52, 199, 89, 0.3);\n            color: #34c759;\n        }\n\n        /* Action button */\n        .btn-pausar {\n            padding: 6px 12px;\n            background: rgba(255, 193, 7, 0.1);\n            border: 1px solid rgba(255, 193, 7, 0.3);\n            border-radius: 6px;\n            color: #ffc107;\n            font-size: 0.8rem;\n            font-weight: 600;\n            cursor: pointer;\n            transition: all 0.3s ease;\n            white-space: nowrap;\n        }\n\n        .btn-pausar:hover {\n            background: rgba(255, 193, 7, 0.2);\n            transform: translateY(-1px);\n        }\n\n        .btn-pausar:disabled {\n            background: #444;\n            color: #888;\n            cursor: not-allowed;\n            transform: none;\n        }\n\n        .btn-excluir {\n            padding: 6px 12px;\n            background: rgba(255, 59, 48, 0.1);\n            border: 1px solid rgba(255, 59, 48, 0.3);\n            border-radius: 6px;\n            color: #ff3b30;\n            font-size: 0.8rem;\n            font-weight: 600;\n            cursor: pointer;\n            transition: all 0.3s ease;\n            white-space: nowrap;\n        }\n\n        .btn-excluir:hover {\n            background: rgba(255, 59, 48, 0.2);\n            transform: translateY(-1px);\n        }\n\n        .btn-excluir:disabled {\n            background: #444;\n            color: #888;\n            cursor: not-allowed;\n            transform: none;\n        }\n\n        .btn-retomar {\n            padding: 6px 12px;\n            background: rgba(52, 199, 89, 0.1);\n            border: 1px solid rgba(52, 199, 89, 0.3);\n            border-radius: 6px;\n            color: #34c759;\n            font-size: 0.8rem;\n            font-weight: 600;\n            cursor: pointer;\n            transition: all 0.3s ease;\n            white-space: nowrap;\n        }\n\n        .btn-retomar:hover {\n            background: rgba(52, 199, 89, 0.2);\n            transform: translateY(-1px);\n        }\n\n        .btn-retomar:disabled {\n            background: #444;\n            color: #888;\n            cursor: not-allowed;\n            transform: none;\n        }\n\n        /* Menu dropdown de ações */\n        .actions-menu {\n            position: relative;\n            display: inline-block;\n        }\n\n        .actions-trigger {\n            background: none;\n            border: none;\n            color: #888;\n            font-size: 1.2rem;\n            cursor: pointer;\n            padding: 8px;\n            border-radius: 4px;\n            transition: all 0.3s ease;\n        }\n\n        .actions-trigger:hover {\n            background: rgba(255, 255, 255, 0.1);\n            color: #25d366;\n        }\n\n        .actions-dropdown {\n            position: absolute;\n            right: 0;\n            top: 100%;\n            background: rgba(26, 26, 26, 0.95);\n            border: 1px solid rgba(255, 255, 255, 0.1);\n            border-radius: 8px;\n            backdrop-filter: blur(10px);\n            min-width: 150px;\n            z-index: 1000;\n            opacity: 0;\n            visibility: hidden;\n            transform: translateY(-10px);\n            transition: all 0.3s ease;\n            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);\n        }\n\n        .actions-dropdown.show {\n            opacity: 1;\n            visibility: visible;\n            transform: translateY(0);\n        }\n\n        .actions-item {\n            display: block;\n            width: 100%;\n            padding: 12px 16px;\n            color: #ccc;\n            text-decoration: none;\n            border: none;\n            background: none;\n            text-align: left;\n            cursor: pointer;\n            transition: all 0.3s ease;\n            font-size: 0.9rem;\n            border-bottom: 1px solid rgba(255, 255, 255, 0.05);\n        }\n\n        .actions-item:last-child {\n            border-bottom: none;\n        }\n\n        .actions-item:hover {\n            background: rgba(37, 211, 102, 0.1);\n            color: #25d366;\n        }\n\n        .actions-item.danger {\n            color: #ff3b30;\n        }\n\n        .actions-item.danger:hover {\n            background: rgba(255, 59, 48, 0.1);\n            color: #ff3b30;\n        }\n\n        .actions-item.warning {\n            color: #ffc107;\n        }\n\n        .actions-item.warning:hover {\n            background: rgba(255, 193, 7, 0.1);\n            color: #ffc107;\n        }\n\n        .actions-item.success {\n            color: #34c759;\n        }\n\n        .actions-item.success:hover {\n            background: rgba(52, 199, 89, 0.1);\n            color: #34c759;\n        }\n\n        /* Filters */\n        .filters-container {\n            display: flex;\n            gap: 15px;\n            margin-bottom: 25px;\n            flex-wrap: wrap;\n            align-items: center;\n        }\n\n        .filter-group {\n            display: flex;\n            flex-direction: column;\n            gap: 5px;\n        }\n\n        .filter-label {\n            font-size: 0.9rem;\n            color: #888;\n            font-weight: 500;\n        }\n\n        .filter-select {\n            padding: 10px 15px;\n            background: rgba(255, 255, 255, 0.05);\n            border: 1px solid rgba(255, 255, 255, 0.1);\n            border-radius: 8px;\n            color: white;\n            font-size: 0.9rem;\n            min-width: 150px;\n            transition: all 0.3s ease;\n        }\n\n        .filter-select:focus {\n            outline: none;\n            border-color: rgba(37, 211, 102, 0.5);\n            box-shadow: 0 0 0 3px rgba(37, 211, 102, 0.1);\n        }\n\n        .filter-select option {\n            background: #1a1a1a;\n            color: white;\n        }\n\n        .btn-limpar-filtros {\n            padding: 10px 15px;\n            background: rgba(255, 255, 255, 0.05);\n            border: 1px solid rgba(255, 255, 255, 0.1);\n            border-radius: 8px;\n            color: #888;\n            font-size: 0.9rem;\n            cursor: pointer;\n            transition: all 0.3s ease;\n            align-self: flex-end;\n        }\n\n        /* Animations */\n        @keyframes spin {\n            0% { transform: rotate(0deg); }\n            100% { transform: rotate(360deg); }\n        }\n\n        @keyframes fadeIn {\n            from { opacity: 0; transform: translateY(20px); }\n            to { opacity: 1; transform: translateY(0); }\n        }\n\n        .table-container {\n            animation: fadeIn 0.5s ease-out;\n        }\n\n        /* Responsive */\n        @media (max-width: 768px) {\n            .main-content {\n                padding: 20px;\n            }\n\n            .header {\n                flex-direction: column;\n                align-items: flex-start;\n                gap: 20px;\n            }\n\n            .header-info h1 {\n                font-size: 2rem;\n            }\n\n            .sidebar {\n                width: 60px;\n            }\n\n            .sidebar:hover {\n                width: 200px;\n            }\n\n            .table-container {\n                min-height: 400px;\n            }\n\n            .disparos-table {\n                font-size: 0.8rem;\n            }\n\n            .disparos-table th,\n            .disparos-table td {\n                padding: 12px 8px;\n            }\n\n            .progress-container {\n                width: 80px;\n            }\n        }\n\n\n    </style>\n</head>\n<body>\n    <div class=\"app-layout\">\n        <!-- Sidebar -->\n        <div class=\"sidebar\">\n            <div class=\"sidebar-header\">\n                <div class=\"sidebar-logo\">EnviaZap</div>\n            </div>\n            <nav class=\"sidebar-menu\">\n                <a href=\"#\" class=\"menu-item\" onclick=\"navigateToPage('https://n8n.typebot.pro/webhook/dashboard')\">\n                    <span class=\"menu-icon\">📊</span>\n                    <span class=\"menu-text\">Dashboard</span>\n                </a>\n                <a href=\"#\" class=\"menu-item active\">\n                    <span class=\"menu-icon\">📋</span>\n                    <span class=\"menu-text\">Histórico de disparos</span>\n                </a>\n                <a href=\"#\" class=\"menu-item\" onclick=\"navigateToPage('https://n8n.typebot.pro/webhook/conectar')\">\n                    <span class=\"menu-icon\">🔗</span>\n                    <span class=\"menu-text\">Nova Conexão</span>\n                </a>\n                <a href=\"#\" class=\"menu-item\" onclick=\"navigateToPage('https://n8n.typebot.pro/webhook/conexoes')\">\n                    <span class=\"menu-icon\">🔌</span>\n                    <span class=\"menu-text\">Conexões</span>\n                </a>\n                <a href=\"#\" class=\"menu-item\" onclick=\"navigateToPage('https://n8n.typebot.pro/webhook/disparos-individuais')\">\n                    <span class=\"menu-icon\">📱</span>\n                    <span class=\"menu-text\">Disparos individuais</span>\n                </a>\n                <a href=\"#\" class=\"menu-item\" onclick=\"navigateToPage('https://n8n.typebot.pro/webhook/disparos-grupos')\">\n                    <span class=\"menu-icon\">👥</span>\n                    <span class=\"menu-text\">Disparos em grupo</span>\n                </a>\n                <a href=\"#\" class=\"menu-item\" onclick=\"navigateToPage('https://n8n.typebot.pro/webhook/listas')\">\n                    <span class=\"menu-icon\">📝</span>\n                    <span class=\"menu-text\">Listas</span>\n                </a>\n            </nav>\n            <div class=\"sidebar-footer\">\n                <a href=\"#\" class=\"menu-item logout-item\" onclick=\"logout()\">\n                    <span class=\"menu-icon\">🚪</span>\n                    <span class=\"menu-text\">Sair</span>\n                </a>\n            </div>\n        </div>\n\n        <!-- Main Content -->\n        <div class=\"main-content\">\n            <div class=\"header\">\n                <div class=\"header-info\">\n                    <h1>Histórico de Disparos</h1>\n                    <p>Visualize e acompanhe todos os seus disparos em tempo real</p>\n                </div>\n                <div class=\"header-actions\">\n                    <button class=\"btn-refresh\" id=\"btnAtualizar\">\n                        🔄 Atualizar\n                    </button>\n                </div>\n            </div>\n\n            <!-- Loading State -->\n            <div class=\"loading-container\" id=\"loadingContainer\">\n                <div class=\"loading-spinner\"></div>\n                <div class=\"loading-text\">Carregando histórico...</div>\n            </div>\n\n            <!-- Error Message -->\n            <div class=\"error-message\" id=\"errorMessage\" style=\"display: none;\"></div>\n\n            <!-- Success Message -->\n            <div class=\"success-message\" id=\"successMessage\" style=\"display: none;\"></div>\n\n            <!-- Filters -->\n            <div class=\"filters-container\" id=\"filtersContainer\" style=\"display: none;\">\n                <div class=\"filter-group\">\n                    <label class=\"filter-label\">Tipo de Disparo</label>\n                    <select class=\"filter-select\" id=\"filtroTipo\">\n                        <option value=\"\">Todos os tipos</option>\n                        <option value=\"Individual\">Individual</option>\n                        <option value=\"Grupos\">Grupos</option>\n                    </select>\n                </div>\n                <div class=\"filter-group\">\n                    <label class=\"filter-label\">Status</label>\n                    <select class=\"filter-select\" id=\"filtroStatus\">\n                        <option value=\"\">Todos os status</option>\n                        <option value=\"Aguardando\">Aguardando</option>\n                        <option value=\"Em andamento\">Em andamento</option>\n                        <option value=\"Agendado\">Agendado</option>\n                        <option value=\"Enviado\">Enviado</option>\n                        <option value=\"Finalizado\">Finalizado</option>\n                        <option value=\"Pausado\">Pausado</option>\n                        <option value=\"Cancelado\">Cancelado</option>\n                    </select>\n                </div>\n                <button class=\"btn-limpar-filtros\" id=\"btnLimparFiltros\">\n                    🗑️ Limpar Filtros\n                </button>\n            </div>\n\n            <!-- Table Container -->\n            <div class=\"table-container\" id=\"tableContainer\" style=\"display: none;\">\n                <table class=\"disparos-table\">\n                    <thead>\n                        <tr>\n                            <th>Data / Hora</th>\n                            <th>Tipo</th>\n                            <th>Total</th>\n                            <th>Enviados</th>\n                            <th>Progresso</th>\n                            <th>Status</th>\n                            <th>Ações</th>\n                        </tr>\n                    </thead>\n                    <tbody id=\"disparosTableBody\">\n                    </tbody>\n                </table>\n            </div>\n\n            <!-- Empty State -->\n            <div class=\"empty-state\" id=\"emptyState\" style=\"display: none;\">\n                <div class=\"empty-icon\">📋</div>\n                <h3>Nenhum disparo encontrado</h3>\n                <p>Você ainda não realizou disparos.<br>Comece criando um novo disparo individual ou em grupo.</p>\n            </div>\n        </div>\n    </div>\n\n    <script>\n        // Variáveis globais\n        let secureUserId = null;\n        let disparosList = [];\n        let disparosOriginais = []; // Para manter os dados originais para filtragem\n\n        // 🍪 Funções para gerenciar cookies\n        function setCookie(name, value, days = 7) {\n            const expires = new Date();\n            expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));\n            document.cookie = `${name}=${value};expires=${expires.toUTCString()};path=/;SameSite=Strict`;\n        }\n\n        function getCookie(name) {\n            const nameEQ = name + \"=\";\n            const ca = document.cookie.split(';');\n            for(let i = 0; i < ca.length; i++) {\n                let c = ca[i];\n                while (c.charAt(0) === ' ') c = c.substring(1, c.length);\n                if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);\n            }\n            return null;\n        }\n\n        function deleteCookie(name) {\n            document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 UTC;path=/;`;\n        }\n\n        // Função para obter userId de forma segura via cookies\n        function getSecureUserId() {\n            const userId = getCookie('userId');\n            if (userId && /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(userId)) {\n                console.log('✅ UserId (UUID) obtido dos cookies:', userId);\n                return userId;\n            }\n            console.error('❌ UserId (UUID) não encontrado ou formato inválido nos cookies!');\n            return null;\n        }\n\n        // Autenticação obrigatória ao carregar a página\n        function checkAuth() {\n            const userId = getSecureUserId();\n            if (!userId) {\n                window.location.href = 'https://n8n.typebot.pro/webhook/login';\n            }\n        }\n\n        // Navegação simplificada (sem parâmetros de autenticação)\n        function navigateToPage(url) {\n            window.location.href = url;\n        }\n\n        // Verificar autenticação ao carregar a página\n        checkAuth();\n\n        // Funções de UI\n        function showError(message) {\n            const errorEl = document.getElementById('errorMessage');\n            errorEl.textContent = message;\n            errorEl.style.display = 'block';\n            setTimeout(() => {\n                errorEl.style.display = 'none';\n            }, 5000);\n        }\n\n        function showSuccess(message) {\n            const successEl = document.getElementById('successMessage');\n            successEl.textContent = message;\n            successEl.style.display = 'block';\n            setTimeout(() => {\n                successEl.style.display = 'none';\n            }, 3000);\n        }\n\n        function hideLoading() {\n            document.getElementById('loadingContainer').style.display = 'none';\n        }\n\n        function showTable() {\n            document.getElementById('tableContainer').style.display = 'block';\n        }\n\n        function showEmptyState() {\n            document.getElementById('emptyState').style.display = 'block';\n        }\n\n        function hideEmptyState() {\n            document.getElementById('emptyState').style.display = 'none';\n        }\n\n        function showFilters() {\n            document.getElementById('filtersContainer').style.display = 'flex';\n        }\n\n        function hideTable() {\n            document.getElementById('tableContainer').style.display = 'none';\n        }\n\n        // Simular dados para demonstração (apenas no ambiente Claude)\n        function setupDemoData() {\n            const isClaudeEnvironment = window.location.hostname.includes('claude.ai') || \n                                      window.location.hostname.includes('anthropic') ||\n                                      window.location.protocol === 'blob:';\n                                      \n            if (isClaudeEnvironment) {\n                console.log('Ambiente de demonstração detectado - configurando dados simulados');\n                \n                // Dados de exemplo válidos (sem objetos vazios)\n                const demoDisparos = [\n                    {\n                        id: 1,\n                        data: '2025-06-20T14:30:00Z',\n                        tipo: 'Individual',\n                        totalContatos: 150,\n                        enviados: 150,\n                        status: 'Finalizado'\n                    },\n                    {\n                        id: 2,\n                        data: '2025-06-20T10:15:00Z',\n                        tipo: 'Grupos',\n                        totalContatos: 50,\n                        enviados: 32,\n                        status: 'Em andamento'\n                    },\n                    {\n                        id: 3,\n                        data: '2025-06-19T16:45:00Z',\n                        tipo: 'Individual',\n                        totalContatos: 80,\n                        enviados: 80,\n                        status: 'Enviado'\n                    },\n                    {\n                        id: 4,\n                        data: '2025-06-21T09:00:00Z',\n                        tipo: 'Grupos',\n                        totalContatos: 25,\n                        enviados: 0,\n                        status: 'Aguardando'\n                    },\n                    {\n                        id: 5,\n                        data: '2025-06-18T13:20:00Z',\n                        tipo: 'Individual',\n                        totalContatos: 200,\n                        enviados: 45,\n                        status: 'Pausado'\n                    }\n                ];\n                \n                return demoDisparos;\n            }\n            \n            return null;\n        }\n\n        // Carregar disparos\n        async function carregarDisparos() {\n            console.log('=== INICIANDO CARREGAMENTO DE DISPAROS ===');\n            \n            const userId = getSecureUserId();\n            if (!userId) {\n                console.log('ERRO: UserId não encontrado');\n                hideLoading();\n                showError('Sessão inválida. Faça login novamente.');\n                return;\n            }\n\n            console.log('UserId obtido:', userId);\n\n            try {\n                // Verificar se é ambiente de demo\n                const demoData = setupDemoData();\n                if (demoData) {\n                    console.log('=== MODO DEMONSTRAÇÃO ===');\n                    console.log('Simulando carregamento...');\n                    \n                    // Simular delay de loading\n                    await new Promise(resolve => setTimeout(resolve, 1500));\n                    \n                    console.log('Dados de demo carregados:', demoData);\n                    \n                    // CRÍTICO: Salvar dados originais IMEDIATAMENTE  \n                    disparosOriginais = [...demoData];\n                    \n                    // Ordenar dados demo por data (mais recente primeiro)\n                    disparosList = [...demoData].sort((a, b) => {\n                        const dataA = new Date(a.data);\n                        const dataB = new Date(b.data);\n                        return dataB - dataA;\n                    });\n                    \n                    console.log('Dados originais salvos (demo):', disparosOriginais.length, disparosOriginais);\n                    \n                    hideLoading();\n                    \n                    if (disparosList.length === 0) {\n                        hideTable();\n                        hideFilters();\n                        showEmptyState();\n                    } else {\n                        hideEmptyState();\n                        showFilters();\n                        renderDisparos();\n                        showTable();\n                        // CONFIGURAR FILTROS APÓS CARREGAR DADOS\n                        setupFiltros();\n                    }\n                    return;\n                }\n                \n                console.log('=== MODO PRODUÇÃO ===');\n                console.log('Fazendo requisição para API...');\n                \n                // Fazer requisição real\n                const response = await fetch('https://n8n.typebot.pro/webhook/listadisparos', {\n                    method: 'POST',\n                    headers: {\n                        'Content-Type': 'application/json'\n                    },\n                    body: JSON.stringify({\n                        userId: userId\n                    })\n                });\n\n                console.log('Status da resposta:', response.status);\n\n                if (!response.ok) {\n                    throw new Error(`Erro ${response.status}: ${response.statusText}`);\n                }\n\n                const data = await response.json();\n                console.log('Disparos recebidos da API:', data);\n\n                // Processar a estrutura da resposta: [{\"disparos\": [...]}]\n                let processedDisparos = [];\n                if (Array.isArray(data) && data.length > 0 && data[0].disparos) {\n                    // Estrutura: [{\"disparos\": [...]}]\n                    processedDisparos = data[0].disparos;\n                } else if (Array.isArray(data)) {\n                    // Estrutura: [...]\n                    processedDisparos = data;\n                } else if (data && data.disparos) {\n                    // Estrutura: {\"disparos\": [...]}\n                    processedDisparos = data.disparos;\n                }\n\n                // Mapear os campos para o formato esperado\n                disparosList = processedDisparos.map(disparo => ({\n                    id: disparo.id,\n                    data: disparo.created_at,\n                    tipo: disparo.TipoDisparo || 'Individual',\n                    totalContatos: disparo.TotalDisparos || 0,\n                    enviados: disparo.MensagensDisparadas || 0,\n                    status: disparo.StatusDisparo || 'Em andamento',\n                    userId: disparo.userId\n                }));\n                \n                console.log('Disparos processados:', disparosList);\n                \n                hideLoading();\n                \n                if (disparosList.length === 0) {\n                    hideTable();\n                    hideFilters();\n                    showEmptyState();\n                } else {\n                    hideEmptyState();\n                    showFilters();\n                    renderDisparos();\n                    showTable();\n                    // CONFIGURAR FILTROS APÓS CARREGAR DADOS\n                    setupFiltros();\n                }\n\n            } catch (error) {\n                console.error('ERRO ao carregar disparos:', error);\n                hideLoading();\n                showError('Erro ao carregar disparos: ' + error.message);\n            }\n        }\n\n        // Renderizar disparos na tabela\n        function renderDisparos() {\n            console.log('=== RENDERIZANDO DISPAROS ===');\n            console.log('Disparos para renderizar:', disparosList.length, disparosList);\n            \n            const tableBody = document.getElementById('disparosTableBody');\n            tableBody.innerHTML = '';\n\n            // Validação antes de renderizar\n            if (!disparosList || disparosList.length === 0) {\n                console.log('Lista de disparos vazia - não renderizando nada');\n                return;\n            }\n\n            // Ordenar por data (mais recente primeiro)\n            const disparosOrdenados = [...disparosList].sort((a, b) => {\n                const dataA = new Date(a.data);\n                const dataB = new Date(b.data);\n                return dataB - dataA; // Ordem decrescente (mais recente primeiro)\n            });\n\n            console.log('Renderizando disparos ordenados por data (mais recente primeiro):', disparosOrdenados.length);\n\n            let linhasRenderizadas = 0;\n            disparosOrdenados.forEach((disparo, index) => {\n                const row = createDisparoRow(disparo);\n                if (row) { // Só adiciona se a linha foi criada com sucesso\n                    tableBody.appendChild(row);\n                    linhasRenderizadas++;\n                } else {\n                    console.warn(`Linha ${index} não foi criada (disparo inválido):`, disparo);\n                }\n            });\n            \n            console.log(`Renderização concluída: ${linhasRenderizadas} linhas criadas de ${disparosOrdenados.length} disparos`);\n            \n            // Se nenhuma linha foi criada, algo está errado\n            if (linhasRenderizadas === 0) {\n                console.error('ERRO: Nenhuma linha foi renderizada mesmo tendo disparos na lista!');\n                console.log('Forçando empty state...');\n                document.getElementById('tableContainer').style.display = 'none';\n                document.getElementById('emptyState').style.display = 'block';\n            }\n        }\n\n        // Criar linha da tabela\n        function createDisparoRow(disparo) {\n            console.log('Criando linha para disparo:', disparo);\n            \n            // VALIDAÇÃO CRÍTICA: Verificar se disparo tem dados válidos\n            if (!disparo || !disparo.id || disparo.id === 0 || disparo.id === undefined) {\n                console.error('ERRO: Tentativa de criar linha com disparo inválido:', disparo);\n                return null; // Não criar linha para dados inválidos\n            }\n            \n            const row = document.createElement('tr');\n            \n            // Formatar data com validação\n            let dataFormatada = 'Data inválida';\n            let horaFormatada = '';\n            \n            try {\n                const data = new Date(disparo.data);\n                if (!isNaN(data.getTime())) {\n                    dataFormatada = data.toLocaleDateString('pt-BR', {\n                        day: '2-digit',\n                        month: '2-digit',\n                        year: 'numeric'\n                    });\n                    horaFormatada = data.toLocaleTimeString('pt-BR', {\n                        hour: '2-digit',\n                        minute: '2-digit'\n                    });\n                }\n            } catch (error) {\n                console.warn('Erro ao formatar data:', disparo.data, error);\n            }\n\n            // Determinar classe do tipo\n            const tipo = disparo.tipo || 'Individual';\n            const tipoClass = tipo.toLowerCase() === 'individual' ? 'pill-individual' : 'pill-grupos';\n\n            // Calcular progresso com validação\n            const total = parseInt(disparo.totalContatos) || 0;\n            const enviados = parseInt(disparo.enviados) || 0;\n            const progresso = total > 0 ? Math.round((enviados / total) * 100) : 0;\n\n            // Determinar classe do status\n            const status = disparo.status || 'Desconhecido';\n            const statusClass = getStatusClass(status);\n\n            // Determinar ações disponíveis baseado no status\n            let actions = [];\n            \n            // Sempre incluir \"Ver detalhes\" como primeira opção\n            actions.push({\n                text: 'Ver detalhes',\n                action: `verDetalhes(${disparo.id})`,\n                class: ''\n            });\n            \n            // Adicionar ações específicas baseado no status\n            if (status === 'Aguardando' || status === 'Em andamento') {\n                actions.push({\n                    text: 'Pausar',\n                    action: `pausarDisparo(${disparo.id})`,\n                    class: 'warning'\n                });\n            } else if (status === 'Pausado') {\n                actions.push({\n                    text: 'Retomar',\n                    action: `retomarDisparo(${disparo.id})`,\n                    class: 'success'\n                });\n                actions.push({\n                    text: 'Excluir',\n                    action: `excluirDisparo(${disparo.id})`,\n                    class: 'danger'\n                });\n            } else if (status === 'Cancelado' || status === 'Finalizado') {\n                actions.push({\n                    text: 'Excluir',\n                    action: `excluirDisparo(${disparo.id})`,\n                    class: 'danger'\n                });\n            }\n            \n            // Gerar HTML do menu dropdown\n            const actionsHtml = actions.map(action => \n                `<button class=\"actions-item ${action.class}\" onclick=\"${action.action}\">${action.text}</button>`\n            ).join('');\n            \n            const acaoHtml = `\n                <div class=\"actions-menu\">\n                    <button class=\"actions-trigger\" onclick=\"toggleActionsMenu(this)\">⋯</button>\n                    <div class=\"actions-dropdown\">\n                        ${actionsHtml}\n                    </div>\n                </div>\n            `;\n\n            row.innerHTML = `\n                <td class=\"date-cell\">\n                    ${dataFormatada}\n                    <span class=\"date-time\">${horaFormatada}</span>\n                </td>\n                <td>\n                    <span class=\"pill ${tipoClass}\">${tipo}</span>\n                </td>\n                <td class=\"count-cell\">${total.toLocaleString('pt-BR')}</td>\n                <td class=\"count-cell\">${enviados.toLocaleString('pt-BR')}</td>\n                <td>\n                    <div class=\"progress-container\">\n                        <div class=\"progress-bar\" style=\"width: ${progresso}%\"></div>\n                    </div>\n                    <div class=\"progress-text\">${progresso}%</div>\n                </td>\n                <td>\n                    <span class=\"pill ${statusClass}\">${status}</span>\n                </td>\n                <td>\n                    ${acaoHtml}\n                </td>\n            `;\n\n            return row;\n        }\n\n        // Determinar classe CSS para o status\n        function getStatusClass(status) {\n            const statusLower = status.toLowerCase();\n            \n            if (statusLower.includes('aguardando')) return 'pill-em-andamento';\n            if (statusLower.includes('andamento')) return 'pill-em-andamento';\n            if (statusLower.includes('agendado')) return 'pill-agendado';\n            if (statusLower.includes('enviado')) return 'pill-enviado';\n            if (statusLower.includes('finalizado') || statusLower.includes('concluído')) return 'pill-finalizado';\n            if (statusLower.includes('cancelado')) return 'pill-cancelado';\n            if (statusLower.includes('pausado')) return 'pill-pausado';\n            \n            return 'pill-em-andamento'; // Default\n        }\n\n        // Pausar disparo\n        async function pausarDisparo(idDisparo) {\n            if (!confirm('Tem certeza que deseja pausar este disparo?')) {\n                return;\n            }\n\n            const userId = getSecureUserId();\n            if (!userId) {\n                showError('Sessão inválida. Faça login novamente.');\n                return;\n            }\n\n            try {\n                console.log('Pausando disparo:', idDisparo);\n                \n                const response = await fetch('https://n8n.typebot.pro/webhook/pausar-disparo', {\n                    method: 'POST',\n                    headers: {\n                        'Content-Type': 'application/json'\n                    },\n                    body: JSON.stringify({\n                        userId: userId,\n                        idDisparo: idDisparo\n                    })\n                });\n\n                if (!response.ok) {\n                    throw new Error(`Erro ${response.status}: ${response.statusText}`);\n                }\n\n                showSuccess('Disparo pausado com sucesso!');\n                \n                // Atualizar o status localmente nos dados originais e na lista atual\n                disparosOriginais = disparosOriginais.map(disparo => \n                    disparo.id === idDisparo ? { ...disparo, status: 'Pausado' } : disparo\n                );\n                \n                disparosList = disparosList.map(disparo => \n                    disparo.id === idDisparo ? { ...disparo, status: 'Pausado' } : disparo\n                );\n                \n                console.log('Status atualizado localmente para Pausado');\n                \n                // Re-renderizar a tabela para mostrar as mudanças\n                renderDisparos();\n\n            } catch (error) {\n                console.error('Erro ao pausar disparo:', error);\n                showError('Erro ao pausar disparo: ' + error.message);\n            }\n        }\n\n        // Excluir disparo\n        async function excluirDisparo(idDisparo) {\n            if (!confirm('Tem certeza que deseja excluir este disparo? Esta ação não pode ser desfeita.')) {\n                return;\n            }\n\n            const userId = getSecureUserId();\n            if (!userId) {\n                showError('Sessão inválida. Faça login novamente.');\n                return;\n            }\n\n            try {\n                console.log('Excluindo disparo:', idDisparo);\n                \n                const response = await fetch('https://n8n.typebot.pro/webhook/excluir-disparo', {\n                    method: 'POST',\n                    headers: {\n                        'Content-Type': 'application/json'\n                    },\n                    body: JSON.stringify({\n                        userId: userId,\n                        idDisparo: idDisparo\n                    })\n                });\n\n                if (!response.ok) {\n                    throw new Error(`Erro ${response.status}: ${response.statusText}`);\n                }\n\n                showSuccess('Disparo excluído com sucesso!');\n                \n                // Remover o disparo dos dados originais e da lista atual\n                disparosOriginais = disparosOriginais.filter(disparo => disparo.id !== idDisparo);\n                disparosList = disparosList.filter(disparo => disparo.id !== idDisparo);\n                \n                console.log('Disparo removido localmente');\n                \n                // Re-renderizar a tabela para mostrar as mudanças\n                renderDisparos();\n\n            } catch (error) {\n                console.error('Erro ao excluir disparo:', error);\n                showError('Erro ao excluir disparo: ' + error.message);\n            }\n        }\n\n        // Retomar disparo\n        async function retomarDisparo(idDisparo) {\n            if (!confirm('Tem certeza que deseja retomar este disparo?')) {\n                return;\n            }\n\n            const userId = getSecureUserId();\n            if (!userId) {\n                showError('Sessão inválida. Faça login novamente.');\n                return;\n            }\n\n            try {\n                console.log('Retomando disparo:', idDisparo);\n                \n                const response = await fetch('https://n8n.typebot.pro/webhook/retomar-disparo', {\n                    method: 'POST',\n                    headers: {\n                        'Content-Type': 'application/json'\n                    },\n                    body: JSON.stringify({\n                        userId: userId,\n                        idDisparo: idDisparo\n                    })\n                });\n\n                if (!response.ok) {\n                    throw new Error(`Erro ${response.status}: ${response.statusText}`);\n                }\n\n                showSuccess('Disparo retomado com sucesso!');\n                \n                // Atualizar o status localmente nos dados originais e na lista atual\n                disparosOriginais = disparosOriginais.map(disparo => \n                    disparo.id === idDisparo ? { ...disparo, status: 'Em andamento' } : disparo\n                );\n                \n                disparosList = disparosList.map(disparo => \n                    disparo.id === idDisparo ? { ...disparo, status: 'Em andamento' } : disparo\n                );\n                \n                console.log('Status atualizado localmente para Em andamento');\n                \n                // Re-renderizar a tabela para mostrar as mudanças\n                renderDisparos();\n\n            } catch (error) {\n                console.error('Erro ao retomar disparo:', error);\n                showError('Erro ao retomar disparo: ' + error.message);\n            }\n        }\n\n        // Ver detalhes do disparo\n        function verDetalhes(idDisparo) {\n            console.log('Ver detalhes do disparo:', idDisparo);\n            \n            // Salvar idDisparo nos cookies\n            setCookie('idDisparo', idDisparo, 7);\n            console.log('idDisparo salvo nos cookies:', idDisparo);\n            \n            // Redirecionar para página de detalhes\n            window.location.href = 'https://n8n.typebot.pro/webhook/detalhes-disparo';\n        }\n\n        // Toggle menu de ações\n        function toggleActionsMenu(trigger) {\n            // Fechar todos os outros menus primeiro\n            const allDropdowns = document.querySelectorAll('.actions-dropdown');\n            allDropdowns.forEach(dropdown => {\n                if (dropdown !== trigger.nextElementSibling) {\n                    dropdown.classList.remove('show');\n                }\n            });\n            \n            // Toggle do menu atual\n            const dropdown = trigger.nextElementSibling;\n            dropdown.classList.toggle('show');\n        }\n\n        // Fechar menus quando clicar fora\n        document.addEventListener('click', function(event) {\n            if (!event.target.closest('.actions-menu')) {\n                const allDropdowns = document.querySelectorAll('.actions-dropdown');\n                allDropdowns.forEach(dropdown => {\n                    dropdown.classList.remove('show');\n                });\n            }\n        });\n\n        // Aplicar filtros\n        function aplicarFiltros() {\n            console.log('=== APLICANDO FILTROS - INÍCIO ===');\n            console.log('Função aplicarFiltros foi chamada!');\n            \n            // VERIFICAÇÃO CRÍTICA: Se não há dados originais, não pode filtrar\n            if (!disparosOriginais || disparosOriginais.length === 0) {\n                console.error('ERRO: Não há dados originais para filtrar!');\n                console.log('disparosOriginais:', disparosOriginais);\n                console.log('disparosList length:', disparosList ? disparosList.length : 'undefined');\n                \n                if (disparosList && disparosList.length > 0) {\n                    console.log('Usando disparosList como backup...');\n                    disparosOriginais = [...disparosList];\n                    console.log('Backup realizado. Dados originais agora:', disparosOriginais.length);\n                } else {\n                    console.error('ERRO CRÍTICO: Nem disparosList nem disparosOriginais têm dados!');\n                    return;\n                }\n            }\n\n            const filtroTipo = document.getElementById('filtroTipo').value;\n            const filtroStatus = document.getElementById('filtroStatus').value;\n\n            console.log('Valores dos filtros:', {\n                tipo: filtroTipo,\n                status: filtroStatus\n            });\n            console.log('Dados originais para filtrar:', disparosOriginais.length);\n\n            // Sempre começar com uma cópia limpa dos dados originais\n            let disparosFiltrados = [...disparosOriginais];\n            console.log('Cópia inicial criada:', disparosFiltrados.length);\n\n            // Filtrar por tipo se selecionado\n            if (filtroTipo && filtroTipo !== '') {\n                console.log('Aplicando filtro de tipo:', filtroTipo);\n                const antesLength = disparosFiltrados.length;\n                disparosFiltrados = disparosFiltrados.filter(disparo => {\n                    const match = disparo.tipo === filtroTipo;\n                    if (match) console.log(`✓ Mantendo: ${disparo.tipo}`);\n                    return match;\n                });\n                console.log(`Filtro tipo: ${antesLength} → ${disparosFiltrados.length}`);\n            }\n\n            // Filtrar por status se selecionado\n            if (filtroStatus && filtroStatus !== '') {\n                console.log('Aplicando filtro de status:', filtroStatus);\n                const antesLength = disparosFiltrados.length;\n                disparosFiltrados = disparosFiltrados.filter(disparo => {\n                    const match = disparo.status === filtroStatus;\n                    if (match) console.log(`✓ Mantendo: ${disparo.status}`);\n                    return match;\n                });\n                console.log(`Filtro status: ${antesLength} → ${disparosFiltrados.length}`);\n            }\n\n            console.log('Resultado final dos filtros:', disparosFiltrados.length);\n\n            // Atualizar a lista de exibição\n            disparosList = disparosFiltrados;\n            console.log('disparosList atualizado');\n            \n            // Renderizar a tabela\n            console.log('Chamando renderDisparos...');\n            renderDisparos();\n\n            // Controlar visibilidade da tabela e empty state\n            const tableContainer = document.getElementById('tableContainer');\n            const emptyState = document.getElementById('emptyState');\n            \n            if (disparosList.length === 0) {\n                console.log('Nenhum resultado - mostrando empty state');\n                tableContainer.style.display = 'none';\n                emptyState.style.display = 'block';\n            } else {\n                console.log('Resultados encontrados - mostrando tabela');\n                emptyState.style.display = 'none';\n                tableContainer.style.display = 'block';\n            }\n            \n            console.log('=== APLICANDO FILTROS - FIM ===');\n        }\n\n        // Limpar filtros\n        function limparFiltros() {\n            console.log('=== LIMPANDO FILTROS ===');\n            console.log('Dados originais antes de limpar:', disparosOriginais.length);\n            \n            // Limpar os selects\n            const filtroTipo = document.getElementById('filtroTipo');\n            const filtroStatus = document.getElementById('filtroStatus');\n            \n            if (filtroTipo) filtroTipo.value = '';\n            if (filtroStatus) filtroStatus.value = '';\n            \n            // Restaurar todos os dados originais\n            disparosList = [...disparosOriginais];\n            console.log('Dados restaurados:', disparosList.length, disparosList);\n            \n            // Renderizar tudo novamente\n            renderDisparos();\n            \n            // Mostrar a tabela\n            const tableContainer = document.getElementById('tableContainer');\n            const emptyState = document.getElementById('emptyState');\n            \n            if (disparosList.length === 0) {\n                console.log('Nenhum dado original - mostrando empty state');\n                tableContainer.style.display = 'none';\n                emptyState.style.display = 'block';\n            } else {\n                console.log('Dados restaurados - mostrando tabela');\n                emptyState.style.display = 'none';\n                tableContainer.style.display = 'block';\n            }\n        }\n\n        // Atualizar dados\n        async function atualizarDisparos() {\n            const btnAtualizar = document.getElementById('btnAtualizar');\n            btnAtualizar.disabled = true;\n            btnAtualizar.innerHTML = '🔄 Atualizando...';\n\n            try {\n                // Limpar filtros antes de atualizar\n                document.getElementById('filtroTipo').value = '';\n                document.getElementById('filtroStatus').value = '';\n                \n                await carregarDisparos();\n                showSuccess('Dados atualizados com sucesso!');\n            } catch (error) {\n                showError('Erro ao atualizar dados: ' + error.message);\n            } finally {\n                btnAtualizar.disabled = false;\n                btnAtualizar.innerHTML = '🔄 Atualizar';\n            }\n        }\n\n        // Event listeners para botões\n        function setupNavigation() {\n            // Event listener para botão atualizar\n            const btnAtualizar = document.getElementById('btnAtualizar');\n            if (btnAtualizar) {\n                btnAtualizar.addEventListener('click', atualizarDisparos);\n            }\n        }\n\n        // Configurar filtros (chamado APÓS carregar dados)\n        function setupFiltros() {\n            console.log('=== CONFIGURANDO FILTROS ===');\n            console.log('Dados originais disponíveis para filtros:', disparosOriginais.length);\n            \n            // Event listeners para filtros com bind direto\n            const filtroTipo = document.getElementById('filtroTipo');\n            const filtroStatus = document.getElementById('filtroStatus');\n            const btnLimparFiltros = document.getElementById('btnLimparFiltros');\n\n            console.log('Elementos encontrados:', {\n                filtroTipo: !!filtroTipo,\n                filtroStatus: !!filtroStatus,\n                btnLimparFiltros: !!btnLimparFiltros\n            });\n\n            if (filtroTipo) {\n                filtroTipo.onchange = function() {\n                    console.log('EVENTO: Filtro tipo mudou para:', this.value);\n                    console.log('Dados originais no momento:', disparosOriginais.length);\n                    aplicarFiltros();\n                };\n                console.log('Event listener adicionado ao filtroTipo');\n            }\n\n            if (filtroStatus) {\n                filtroStatus.onchange = function() {\n                    console.log('EVENTO: Filtro status mudou para:', this.value);\n                    console.log('Dados originais no momento:', disparosOriginais.length);\n                    aplicarFiltros();\n                };\n                console.log('Event listener adicionado ao filtroStatus');\n            }\n\n            if (btnLimparFiltros) {\n                btnLimparFiltros.onclick = function() {\n                    console.log('EVENTO: Botão limpar clicado');\n                    console.log('Dados originais no momento:', disparosOriginais.length);\n                    limparFiltros();\n                };\n                console.log('Event listener adicionado ao btnLimparFiltros');\n            }\n\n            console.log('=== FILTROS CONFIGURADOS ===');\n        }\n\n        // Inicialização\n        async function inicializarPagina() {\n            console.log('Inicializando página de histórico de disparos');\n            \n            console.log('Configurando navegação e carregando disparos');\n            setupNavigation();\n            \n            // Carregar disparos (filtros serão configurados APÓS o carregamento)\n            await carregarDisparos();\n        }\n\n        // Executar quando o DOM estiver pronto\n        if (document.readyState === 'loading') {\n            document.addEventListener('DOMContentLoaded', inicializarPagina);\n        } else {\n            inicializarPagina();\n        }\n\n        console.log('=== SCRIPT DA PÁGINA DE HISTÓRICO DE DISPAROS CARREGADO ===');\n\n        // Função de logout\n        function logout() {\n            console.log('🚪 Iniciando logout...');\n            \n            // Limpar todos os cookies\n            document.cookie = 'userId=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';\n            document.cookie = 'idLista=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';\n            document.cookie = 'idConexao=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';\n            document.cookie = 'idDisparo=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';\n            \n            // Limpar sessionStorage\n            sessionStorage.clear();\n            \n            console.log('🧹 Cookies e sessionStorage limpos');\n            console.log('🔄 Redirecionando para login...');\n            \n            // Redirecionar para página de login\n            window.location.href = 'https://n8n.typebot.pro/webhook/login';\n        }\n    </script>\n</body>\n</html>"},"type":"n8n-nodes-base.html","typeVersion":1.2,"position":[-4240,-5872],"id":"d9b873ba-6bac-4741-a1cf-2a9ece79b898","name":"HTML6"},{"parameters":{"respondWith":"text","responseBody":"={{ $json.html }}","options":{}},"type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-4016,-5872],"id":"14af9d4d-8042-4df8-b463-4539391a7101","name":"Respond to Webhook5"},{"parameters":{"path":"historico-disparos","responseMode":"responseNode","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-4448,-5872],"id":"b1e8d4e2-9f28-4faa-a62f-f2108f2a53bb","name":"HISTORICO DISPAROS","webhookId":"44ef5672-bb5e-47cb-8c16-50d5ffb78a8c"},{"parameters":{"content":"## Tela Dashboard","height":260,"width":760,"color":2},"type":"n8n-nodes-base.stickyNote","position":[-4512,-5648],"typeVersion":1,"id":"1efe7eef-2d37-4ba2-95d7-0f839a1fd58f","name":"Sticky Note16"},{"parameters":{"html":"<!DOCTYPE html>\n<html lang=\"pt-BR\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>Dashboard - EnviaZap</title>\n    <style>\n        * {\n            margin: 0;\n            padding: 0;\n            box-sizing: border-box;\n        }\n\n        body {\n            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);\n            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n            color: white;\n            min-height: 100vh;\n            margin: 0;\n            padding: 0;\n        }\n\n        .app-layout {\n            display: flex;\n            min-height: 100vh;\n        }\n\n        /* Sidebar */\n        .sidebar {\n            width: 70px;\n            background: rgba(0, 0, 0, 0.3);\n            backdrop-filter: blur(10px);\n            border-right: 1px solid rgba(255, 255, 255, 0.1);\n            transition: all 0.3s ease;\n            position: relative;\n            z-index: 1000;\n            display: flex;\n            flex-direction: column;\n            height: 100vh;\n        }\n\n        .sidebar:hover {\n            width: 250px;\n        }\n\n        .sidebar-header {\n            padding: 20px;\n            text-align: center;\n            border-bottom: 1px solid rgba(255, 255, 255, 0.1);\n        }\n\n        .sidebar-logo {\n            font-size: 1.5rem;\n            font-weight: 600;\n            background: linear-gradient(135deg, #25d366 0%, #128c7e 100%);\n            -webkit-background-clip: text;\n            -webkit-text-fill-color: transparent;\n            background-clip: text;\n            white-space: nowrap;\n            opacity: 0;\n            transition: opacity 0.3s ease;\n        }\n\n        .sidebar:hover .sidebar-logo {\n            opacity: 1;\n        }\n\n        .sidebar-menu {\n            padding: 20px 0;\n            flex: 1;\n        }\n\n        .menu-item {\n            display: flex;\n            align-items: center;\n            padding: 15px 20px;\n            color: #ccc;\n            text-decoration: none;\n            transition: all 0.3s ease;\n            position: relative;\n            white-space: nowrap;\n        }\n\n        .menu-item:hover {\n            background: rgba(37, 211, 102, 0.1);\n            color: #25d366;\n        }\n\n        .menu-item.active {\n            background: rgba(37, 211, 102, 0.2);\n            color: #25d366;\n            border-right: 3px solid #25d366;\n        }\n\n        .menu-icon {\n            font-size: 1.2rem;\n            width: 30px;\n            text-align: center;\n            flex-shrink: 0;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n        }\n\n        .menu-icon svg {\n            transition: all 0.3s ease;\n        }\n\n        .menu-item:hover .menu-icon svg {\n            transform: scale(1.1);\n        }\n\n        .menu-text {\n            margin-left: 15px;\n            opacity: 0;\n            transition: opacity 0.3s ease;\n        }\n\n        .sidebar:hover .menu-text {\n            opacity: 1;\n        }\n\n        .sidebar-footer {\n            margin-top: auto;\n            border-top: 1px solid rgba(255, 255, 255, 0.1);\n            padding: 10px 0;\n        }\n\n        .logout-item {\n            color: #ff6b6b !important;\n        }\n\n        .logout-item:hover {\n            background: rgba(255, 107, 107, 0.1) !important;\n            color: #ff6b6b !important;\n        }\n\n        /* Main content */\n        .main-content {\n            flex: 1;\n            padding: 30px;\n            overflow-x: auto;\n        }\n\n        .header {\n            margin-bottom: 40px;\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n        }\n\n        .header-info h1 {\n            font-size: 2.5rem;\n            font-weight: 600;\n            margin-bottom: 10px;\n        }\n\n        .header-info p {\n            color: #888;\n            font-size: 1.1rem;\n        }\n\n        .header-actions {\n            display: flex;\n            gap: 15px;\n            align-items: center;\n        }\n\n        .version-text {\n            color: #888;\n            font-size: 0.85rem;\n            font-weight: 500;\n            padding: 8px 12px;\n            background: rgba(255, 255, 255, 0.05);\n            border: 1px solid rgba(255, 255, 255, 0.1);\n            border-radius: 6px;\n            white-space: nowrap;\n        }\n\n        .btn-refresh {\n            padding: 12px 20px;\n            background: linear-gradient(135deg, #25d366 0%, #128c7e 100%);\n            border: none;\n            border-radius: 8px;\n            color: white;\n            font-weight: 600;\n            cursor: pointer;\n            transition: all 0.3s ease;\n            display: flex;\n            align-items: center;\n            gap: 8px;\n            font-size: 0.9rem;\n        }\n\n        .btn-refresh:hover {\n            transform: translateY(-2px);\n            box-shadow: 0 8px 25px rgba(37, 211, 102, 0.3);\n        }\n\n        .btn-refresh:disabled {\n            background: #444;\n            cursor: not-allowed;\n            transform: none;\n        }\n\n        /* Filters */\n        .filters-container {\n            display: flex;\n            gap: 15px;\n            margin-bottom: 30px;\n            flex-wrap: wrap;\n            align-items: center;\n            background: rgba(255, 255, 255, 0.02);\n            border: 1px solid rgba(255, 255, 255, 0.1);\n            border-radius: 12px;\n            padding: 20px;\n            backdrop-filter: blur(10px);\n        }\n\n        .filter-group {\n            display: flex;\n            flex-direction: column;\n            gap: 5px;\n        }\n\n        .filter-label {\n            font-size: 0.9rem;\n            color: #888;\n            font-weight: 500;\n        }\n\n        .filter-select, .filter-input {\n            padding: 10px 15px;\n            background: rgba(255, 255, 255, 0.05);\n            border: 1px solid rgba(255, 255, 255, 0.1);\n            border-radius: 8px;\n            color: white;\n            font-size: 0.9rem;\n            min-width: 120px;\n            transition: all 0.3s ease;\n        }\n\n        .filter-select:focus, .filter-input:focus {\n            outline: none;\n            border-color: rgba(37, 211, 102, 0.5);\n            box-shadow: 0 0 0 3px rgba(37, 211, 102, 0.1);\n        }\n\n        .filter-select option {\n            background: #1a1a1a;\n            color: white;\n        }\n\n        .date-range-buttons {\n            display: flex;\n            gap: 8px;\n        }\n\n        .btn-date-range {\n            padding: 8px 16px;\n            background: rgba(255, 255, 255, 0.05);\n            border: 1px solid rgba(255, 255, 255, 0.1);\n            border-radius: 6px;\n            color: #888;\n            font-size: 0.8rem;\n            cursor: pointer;\n            transition: all 0.3s ease;\n            white-space: nowrap;\n        }\n\n        .btn-date-range:hover {\n            background: rgba(37, 211, 102, 0.1);\n            color: #25d366;\n        }\n\n        .btn-date-range.active {\n            background: rgba(37, 211, 102, 0.2);\n            color: #25d366;\n            border-color: rgba(37, 211, 102, 0.3);\n        }\n\n        /* Stats Cards */\n        .stats-grid {\n            display: grid;\n            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));\n            gap: 20px;\n            margin-bottom: 30px;\n        }\n\n        .stat-card {\n            background: rgba(255, 255, 255, 0.02);\n            border: 1px solid rgba(255, 255, 255, 0.1);\n            border-radius: 16px;\n            backdrop-filter: blur(10px);\n            padding: 25px;\n            transition: all 0.3s ease;\n            position: relative;\n            overflow: hidden;\n        }\n\n        .stat-card:hover {\n            transform: translateY(-2px);\n            box-shadow: 0 8px 25px rgba(37, 211, 102, 0.1);\n        }\n\n        .stat-card::before {\n            content: '';\n            position: absolute;\n            top: 0;\n            left: 0;\n            right: 0;\n            height: 3px;\n            background: linear-gradient(135deg, #25d366 0%, #128c7e 100%);\n        }\n\n        .stat-header {\n            display: flex;\n            align-items: center;\n            justify-content: space-between;\n            margin-bottom: 15px;\n        }\n\n        .stat-title {\n            font-size: 0.9rem;\n            color: #888;\n            font-weight: 500;\n            text-transform: uppercase;\n            letter-spacing: 0.5px;\n        }\n\n        .stat-icon {\n            font-size: 1.5rem;\n            opacity: 0.7;\n        }\n\n        .stat-value {\n            font-size: 2.5rem;\n            font-weight: 700;\n            margin-bottom: 10px;\n            background: linear-gradient(135deg, #25d366 0%, #128c7e 100%);\n            -webkit-background-clip: text;\n            -webkit-text-fill-color: transparent;\n            background-clip: text;\n        }\n\n        .stat-change {\n            font-size: 0.8rem;\n            display: flex;\n            align-items: center;\n            gap: 5px;\n        }\n\n        .stat-change.positive {\n            color: #34c759;\n        }\n\n        .stat-change.negative {\n            color: #ff3b30;\n        }\n\n        .stat-change.neutral {\n            color: #888;\n        }\n\n        /* Chart Container */\n        .chart-container {\n            background: rgba(255, 255, 255, 0.02);\n            border: 1px solid rgba(255, 255, 255, 0.1);\n            border-radius: 16px;\n            backdrop-filter: blur(10px);\n            padding: 30px;\n            margin-bottom: 30px;\n        }\n\n        .chart-header {\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            margin-bottom: 30px;\n        }\n\n        .chart-title {\n            font-size: 1.5rem;\n            font-weight: 600;\n            color: #fff;\n        }\n\n        .chart-subtitle {\n            font-size: 0.9rem;\n            color: #888;\n            margin-top: 5px;\n        }\n\n        #chartCanvas {\n            width: 100%;\n            max-height: 400px;\n        }\n\n        /* Loading state */\n        .loading-container {\n            display: flex;\n            flex-direction: column;\n            align-items: center;\n            justify-content: center;\n            min-height: 400px;\n            gap: 20px;\n        }\n\n        .loading-spinner {\n            width: 60px;\n            height: 60px;\n            border: 4px solid rgba(37, 211, 102, 0.3);\n            border-top: 4px solid #25d366;\n            border-radius: 50%;\n            animation: spin 1s linear infinite;\n        }\n\n        .loading-text {\n            color: #25d366;\n            font-size: 1.2rem;\n            font-weight: 500;\n        }\n\n        /* Error/Success messages */\n        .error-message, .success-message {\n            padding: 20px;\n            border-radius: 12px;\n            margin: 20px 0;\n            text-align: center;\n        }\n\n        .error-message {\n            background: rgba(255, 59, 48, 0.1);\n            border: 1px solid rgba(255, 59, 48, 0.3);\n            color: #ff3b30;\n        }\n\n        .success-message {\n            background: rgba(52, 199, 89, 0.1);\n            border: 1px solid rgba(52, 199, 89, 0.3);\n            color: #34c759;\n        }\n\n        /* Animations */\n        @keyframes spin {\n            0% { transform: rotate(0deg); }\n            100% { transform: rotate(360deg); }\n        }\n\n        @keyframes fadeIn {\n            from { opacity: 0; transform: translateY(20px); }\n            to { opacity: 1; transform: translateY(0); }\n        }\n\n        .stats-grid, .chart-container {\n            animation: fadeIn 0.5s ease-out;\n        }\n\n        /* Responsive */\n        @media (max-width: 768px) {\n            .main-content {\n                padding: 20px;\n            }\n\n            .header {\n                flex-direction: column;\n                align-items: flex-start;\n                gap: 20px;\n            }\n\n            .header-info h1 {\n                font-size: 2rem;\n            }\n\n            .sidebar {\n                width: 60px;\n            }\n\n            .sidebar:hover {\n                width: 200px;\n            }\n\n            .stats-grid {\n                grid-template-columns: 1fr;\n            }\n\n            .filters-container {\n                flex-direction: column;\n                align-items: stretch;\n            }\n\n            .date-range-buttons {\n                justify-content: center;\n            }\n        }\n    </style>\n    <script src=\"https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js\"></script>\n</head>\n<body>\n    <div class=\"app-layout\">\n        <!-- Sidebar -->\n        <div class=\"sidebar\">\n            <div class=\"sidebar-header\">\n                <div class=\"sidebar-logo\">EnviaZap</div>\n            </div>\n            <nav class=\"sidebar-menu\">\n                <a href=\"#\" class=\"menu-item active\">\n                    <span class=\"menu-icon\">📊</span>\n                    <span class=\"menu-text\">Dashboard</span>\n                </a>\n                <a href=\"#\" class=\"menu-item\" onclick=\"navigateToPage('https://n8n.typebot.pro/webhook/historico-disparos')\">\n                    <span class=\"menu-icon\">📋</span>\n                    <span class=\"menu-text\">Histórico de disparos</span>\n                </a>\n                <a href=\"#\" class=\"menu-item\" onclick=\"navigateToPage('https://n8n.typebot.pro/webhook/conectar')\">\n                    <span class=\"menu-icon\">🔗</span>\n                    <span class=\"menu-text\">Nova Conexão</span>\n                </a>\n                <a href=\"#\" class=\"menu-item\" onclick=\"navigateToPage('https://n8n.typebot.pro/webhook/conexoes')\">\n                    <span class=\"menu-icon\">🔌</span>\n                    <span class=\"menu-text\">Conexões</span>\n                </a>\n                <a href=\"#\" class=\"menu-item\" onclick=\"navigateToPage('https://n8n.typebot.pro/webhook/disparos-individuais')\">\n                    <span class=\"menu-icon\">📱</span>\n                    <span class=\"menu-text\">Disparos individuais</span>\n                </a>\n                <a href=\"#\" class=\"menu-item\" onclick=\"navigateToPage('https://n8n.typebot.pro/webhook/disparos-grupos')\">\n                    <span class=\"menu-icon\">👥</span>\n                    <span class=\"menu-text\">Disparos em grupo</span>\n                </a>\n                <a href=\"#\" class=\"menu-item\" onclick=\"navigateToPage('https://n8n.typebot.pro/webhook/listas')\">\n                    <span class=\"menu-icon\">📝</span>\n                    <span class=\"menu-text\">Listas</span>\n                </a>\n            </nav>\n            <div class=\"sidebar-footer\">\n                <a href=\"#\" class=\"menu-item logout-item\" onclick=\"logout()\">\n                    <span class=\"menu-icon\">🚪</span>\n                    <span class=\"menu-text\">Sair</span>\n                </a>\n            </div>\n        </div>\n\n        <!-- Main Content -->\n        <div class=\"main-content\">\n            <div class=\"header\">\n                <div class=\"header-info\">\n                    <h1>Dashboard</h1>\n                    <p>Acompanhe suas métricas e performance em tempo real</p>\n                </div>\n                <div class=\"header-actions\">\n                    <button class=\"btn-refresh\" id=\"btnAtualizar\">\n                        🔄 Atualizar\n                    </button>\n                    <span class=\"version-text\">Versão atual: V3.1</span>\n                </div>\n            </div>\n\n            <!-- Loading State -->\n            <div class=\"loading-container\" id=\"loadingContainer\">\n                <div class=\"loading-spinner\"></div>\n                <div class=\"loading-text\">Carregando dashboard...</div>\n            </div>\n\n            <!-- Error Message -->\n            <div class=\"error-message\" id=\"errorMessage\" style=\"display: none;\"></div>\n\n            <!-- Success Message -->\n            <div class=\"success-message\" id=\"successMessage\" style=\"display: none;\"></div>\n\n            <!-- Filters -->\n            <div class=\"filters-container\" id=\"filtersContainer\" style=\"display: none;\">\n                <div class=\"filter-group\">\n                    <label class=\"filter-label\">Período</label>\n                    <div class=\"date-range-buttons\">\n                        <button class=\"btn-date-range active\" data-days=\"7\">7 dias</button>\n                        <button class=\"btn-date-range\" data-days=\"14\">14 dias</button>\n                        <button class=\"btn-date-range\" data-days=\"30\">30 dias</button>\n                    </div>\n                </div>\n                <div class=\"filter-group\">\n                    <label class=\"filter-label\">Data Inicial</label>\n                    <input type=\"date\" class=\"filter-input\" id=\"dataInicial\">\n                </div>\n                <div class=\"filter-group\">\n                    <label class=\"filter-label\">Data Final</label>\n                    <input type=\"date\" class=\"filter-input\" id=\"dataFinal\">\n                </div>\n            </div>\n\n            <!-- Stats Cards -->\n            <div class=\"stats-grid\" id=\"statsGrid\" style=\"display: none;\">\n                <div class=\"stat-card\">\n                    <div class=\"stat-header\">\n                        <div class=\"stat-title\">Total de Disparos</div>\n                        <div class=\"stat-icon\">📤</div>\n                    </div>\n                    <div class=\"stat-value\" id=\"totalDisparos\">0</div>\n                    <div class=\"stat-change\" id=\"changeDisparos\">\n                        <span>+0%</span> vs período anterior\n                    </div>\n                </div>\n\n                <div class=\"stat-card\">\n                    <div class=\"stat-header\">\n                        <div class=\"stat-title\">Conexões Ativas</div>\n                        <div class=\"stat-icon\">🟢</div>\n                    </div>\n                    <div class=\"stat-value\" id=\"conexoesAtivas\">0</div>\n                    <div class=\"stat-change\" id=\"changeConexoesAtivas\">\n                        <span>+0%</span> vs período anterior\n                    </div>\n                </div>\n\n                <div class=\"stat-card\">\n                    <div class=\"stat-header\">\n                        <div class=\"stat-title\">Total de Conexões</div>\n                        <div class=\"stat-icon\">📱</div>\n                    </div>\n                    <div class=\"stat-value\" id=\"totalConexoes\">0</div>\n                    <div class=\"stat-change\" id=\"changeTotalConexoes\">\n                        <span>+0%</span> vs período anterior\n                    </div>\n                </div>\n\n                <div class=\"stat-card\">\n                    <div class=\"stat-header\">\n                        <div class=\"stat-title\">Média por Conexão</div>\n                        <div class=\"stat-icon\">📊</div>\n                    </div>\n                    <div class=\"stat-value\" id=\"mediaPorConexao\">0</div>\n                    <div class=\"stat-change\" id=\"changeMediaConexao\">\n                        <span>+0%</span> vs período anterior\n                    </div>\n                </div>\n            </div>\n\n            <!-- Chart -->\n            <div class=\"chart-container\" id=\"chartContainer\" style=\"display: none;\">\n                <div class=\"chart-header\">\n                    <div>\n                        <div class=\"chart-title\">Disparos por Dia</div>\n                        <div class=\"chart-subtitle\">Acompanhe a evolução dos seus disparos ao longo do tempo</div>\n                    </div>\n                </div>\n                <canvas id=\"chartCanvas\"></canvas>\n            </div>\n        </div>\n    </div>\n\n    <script>\n        // Variáveis globais\n        let secureUserId = null;\n        let dashboardData = {};\n        let chart = null;\n        let currentPeriod = 7; // Padrão: 7 dias\n\n        // Função para ler cookies\n        function getCookie(name) {\n            const value = `; ${document.cookie}`;\n            const parts = value.split(`; ${name}=`);\n            if (parts.length === 2) return parts.pop().split(';').shift();\n            return null;\n        }\n\n        // Função para obter userId de forma segura via cookies\n        function getSecureUserId() {\n            const userId = getCookie('userId');\n            if (userId && /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(userId)) {\n                console.log('✅ UserId (UUID) obtido dos cookies:', userId);\n                return userId;\n            }\n            console.error('❌ UserId (UUID) não encontrado ou formato inválido nos cookies!');\n            return null;\n        }\n\n        // Autenticação obrigatória ao carregar a página\n        function checkAuth() {\n            const userId = getSecureUserId();\n            if (!userId) {\n                window.location.href = 'https://n8n.typebot.pro/webhook/login';\n            }\n        }\n\n        // Navegação simplificada (sem parâmetros de autenticação)\n        function navigateToPage(url) {\n            window.location.href = url;\n        }\n\n        // Verificar autenticação ao carregar a página\n        checkAuth();\n\n        // Funções de UI\n        function showError(message) {\n            const errorEl = document.getElementById('errorMessage');\n            errorEl.textContent = message;\n            errorEl.style.display = 'block';\n            setTimeout(() => {\n                errorEl.style.display = 'none';\n            }, 5000);\n        }\n\n        function showSuccess(message) {\n            const successEl = document.getElementById('successMessage');\n            successEl.textContent = message;\n            successEl.style.display = 'block';\n            setTimeout(() => {\n                successEl.style.display = 'none';\n            }, 3000);\n        }\n\n        function hideLoading() {\n            document.getElementById('loadingContainer').style.display = 'none';\n        }\n\n        function showDashboard() {\n            document.getElementById('filtersContainer').style.display = 'flex';\n            document.getElementById('statsGrid').style.display = 'grid';\n            document.getElementById('chartContainer').style.display = 'block';\n        }\n\n        // Gerar dados fictícios para demonstração\n        function generateDemoData(days) {\n            const isClaudeEnvironment = window.location.hostname.includes('claude.ai') || \n                                      window.location.hostname.includes('anthropic') ||\n                                      window.location.protocol === 'blob:';\n                                      \n            if (!isClaudeEnvironment) {\n                return null;\n            }\n\n            console.log(`Gerando dados demo para ${days} dias`);\n            \n            const data = {\n                totalDisparos: 0,\n                conexoesAtivas: Math.floor(Math.random() * 8) + 3, // 3-10\n                totalConexoes: Math.floor(Math.random() * 5) + 8, // 8-12\n                mediaDisparosPorConexao: 0,\n                disparosPorDia: [],\n                estatisticas: {\n                    changeDisparos: (Math.random() * 40 - 20).toFixed(1), // -20% a +20%\n                    changeConexoesAtivas: (Math.random() * 30 - 15).toFixed(1),\n                    changeTotalConexoes: (Math.random() * 20 - 10).toFixed(1),\n                    changeMediaConexao: (Math.random() * 35 - 17.5).toFixed(1)\n                }\n            };\n\n            // Gerar dados por dia\n            const today = new Date();\n            for (let i = days - 1; i >= 0; i--) {\n                const date = new Date(today);\n                date.setDate(date.getDate() - i);\n                \n                const disparosNoDia = Math.floor(Math.random() * 200) + 50; // 50-250 disparos por dia\n                data.totalDisparos += disparosNoDia;\n                \n                data.disparosPorDia.push({\n                    data: date.toISOString().split('T')[0],\n                    dataFormatada: date.toLocaleDateString('pt-BR'),\n                    disparos: disparosNoDia\n                });\n            }\n\n            // Calcular média por conexão\n            data.mediaDisparosPorConexao = data.totalConexoes > 0 ? \n                Math.round(data.totalDisparos / data.totalConexoes) : 0;\n\n            console.log('Dados demo gerados:', data);\n            return data;\n        }\n\n        // Verificar status de conexão de uma instância\n        async function verificarStatusConexao(instanceName, apikey) {\n            try {\n                const response = await fetch(`https://whatsapi.typebot.pro/instance/connectionState/${instanceName}`, {\n                    method: 'GET',\n                    headers: {\n                        'apikey': apikey\n                    }\n                });\n\n                if (!response.ok) {\n                    console.log(`Erro ao verificar status da instância ${instanceName}:`, response.status);\n                    return false;\n                }\n\n                const data = await response.json();\n                console.log(`Status da instância ${instanceName}:`, data);\n                \n                // Consideramos conectada se o estado é 'open' ou similar\n                return data.state === 'open' || data.instance?.state === 'open';\n            } catch (error) {\n                console.error(`Erro ao verificar conexão ${instanceName}:`, error);\n                return false;\n            }\n        }\n\n\n\n        // Processar dados da API\n        async function processarDadosAPI(apiData) {\n            console.log('Processando dados da API:', apiData);\n            console.log('Tipo da resposta:', typeof apiData);\n            console.log('É array?', Array.isArray(apiData));\n            \n            // Verificar e extrair dados de forma segura\n            let dados = {};\n            let disparos = [];\n            let conexoes = [];\n            \n            try {\n                // Caso 1: Resposta é array com objeto dentro: [{\"disparos\": [...], \"conexoes\": [...]}]\n                if (Array.isArray(apiData) && apiData.length > 0 && apiData[0]) {\n                    dados = apiData[0];\n                }\n                // Caso 2: Resposta é objeto direto: {\"disparos\": [...], \"conexoes\": [...]}\n                else if (apiData && typeof apiData === 'object' && !Array.isArray(apiData)) {\n                    dados = apiData;\n                }\n                // Caso 3: Resposta tem estrutura diferente\n                else {\n                    console.error('Estrutura de resposta não reconhecida:', apiData);\n                    throw new Error('Formato de resposta da API não reconhecido');\n                }\n                \n                // Extrair disparos e conexões de forma segura\n                disparos = dados.disparos || [];\n                conexoes = dados.conexoes || [];\n                \n                if (!Array.isArray(disparos)) {\n                    console.warn('Disparos não é array, convertendo:', disparos);\n                    disparos = [];\n                }\n                \n                if (!Array.isArray(conexoes)) {\n                    console.warn('Conexões não é array, convertendo:', conexoes);\n                    conexoes = [];\n                }\n                \n                // Filtrar conexões válidas (não vazias)\n                const conexoesValidas = conexoes.filter(conexao => {\n                    return conexao && \n                           typeof conexao === 'object' && \n                           Object.keys(conexao).length > 0 &&\n                           conexao.Apikey && \n                           conexao.instanceName;\n                });\n                \n                console.log('Conexões válidas filtradas:', conexoesValidas.length);\n                console.log('Conexões originais:', conexoes);\n                console.log('Conexões válidas:', conexoesValidas);\n                \n                // Usar apenas conexões válidas\n                conexoes = conexoesValidas;\n                \n                // Filtrar disparos válidos (não vazios)\n                const disparosValidos = disparos.filter(disparo => {\n                    return disparo && \n                           (typeof disparo === 'string' || \n                            (typeof disparo === 'object' && Object.keys(disparo).length > 0));\n                });\n                \n                console.log('Disparos válidos filtrados:', disparosValidos.length);\n                console.log('Disparos originais:', disparos);\n                console.log('Disparos válidos:', disparosValidos);\n                \n                // Usar apenas disparos válidos\n                disparos = disparosValidos;\n                \n            } catch (error) {\n                console.error('Erro ao processar estrutura da API:', error);\n                console.log('Dados recebidos completos:', JSON.stringify(apiData, null, 2));\n                throw new Error('Erro ao processar dados da API: ' + error.message);\n            }\n\n            // Calcular datas do período atual\n            let hoje = new Date();\n            let dataInicial = new Date();\n            dataInicial.setDate(hoje.getDate() - currentPeriod);\n            \n\n            \n            // Ajustar período baseado nos dados reais\n            if (disparos.length > 0) {\n                const primeiroDisparo = new Date(disparos[0]);\n                const ultimoDisparo = new Date(disparos[disparos.length - 1]);\n                \n                // Se os disparos são de 2025, usar o período real dos dados\n                if (primeiroDisparo.getFullYear() === 2025 || ultimoDisparo.getFullYear() === 2025) {\n                    // Usar o período real dos dados em vez de um período fixo\n                    dataInicial = new Date(primeiroDisparo);\n                    dataInicial.setDate(dataInicial.getDate() - currentPeriod); // Pegar X dias antes do primeiro disparo\n                    hoje = new Date(ultimoDisparo);\n                    hoje.setDate(hoje.getDate() + 1); // Incluir o dia do último disparo\n                }\n            }\n\n            console.log(`Período selecionado: ${currentPeriod} dias`);\n            console.log(`Data inicial: ${dataInicial.toISOString().split('T')[0]}`);\n            console.log(`Data final: ${hoje.toISOString().split('T')[0]}`);\n            console.log(`Data atual: ${hoje.toISOString()}`);\n            console.log(`Total de disparos recebidos: ${disparos.length}`);\n            if (disparos.length > 0) {\n                console.log(`Primeiro disparo: ${disparos[0]}`);\n                console.log(`Último disparo: ${disparos[disparos.length - 1]}`);\n            }\n\n            // Usar todos os disparos disponíveis (já estão no período correto)\n            const disparosPeriodo = disparos.filter((disparo, index) => {\n                if (!disparo) {\n                    return false;\n                }\n                \n                // Verificar se disparo é string (timestamp) ou objeto\n                let dataDisparo;\n                if (typeof disparo === 'string') {\n                    // Se é string, é o timestamp direto\n                    dataDisparo = new Date(disparo);\n                } else if (disparo && disparo.created_at) {\n                    // Se é objeto, pegar a propriedade created_at\n                    dataDisparo = new Date(disparo.created_at);\n                } else {\n                    return false;\n                }\n                \n                // Verificar se a data é válida\n                if (isNaN(dataDisparo.getTime())) {\n                    return false;\n                }\n                \n                return true; // Usar todos os disparos válidos\n            });\n\n\n\n            // Verificar conexões ativas (com tratamento de erro)\n            let conexoesAtivas = 0;\n            \n            // Se não há conexões, retornar 0\n            if (!conexoes || conexoes.length === 0) {\n                console.log('Nenhuma conexão encontrada, conexões ativas = 0');\n                conexoesAtivas = 0;\n            } else {\n                const verificacoes = conexoes.map(async (conexao) => {\n                    try {\n                        if (conexao && conexao.Apikey && conexao.instanceName) {\n                            const ativa = await verificarStatusConexao(conexao.instanceName, conexao.Apikey);\n                            if (ativa) conexoesAtivas++;\n                            return ativa;\n                        }\n                        return false;\n                    } catch (error) {\n                        console.warn(`Erro ao verificar conexão ${conexao?.instanceName}:`, error);\n                        return false;\n                    }\n                });\n\n                try {\n                    // Aguardar todas as verificações com timeout\n                    await Promise.race([\n                        Promise.all(verificacoes),\n                        new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout')), 10000))\n                    ]);\n                } catch (error) {\n                    console.warn('Erro ou timeout na verificação de conexões:', error);\n                    // Em caso de erro, não considerar nenhuma conexão como ativa\n                    conexoesAtivas = 0;\n                }\n            }\n\n            console.log('Conexões ativas encontradas:', conexoesAtivas);\n\n            // Calcular totais - cada disparo conta como 1 mensagem\n            const totalDisparos = disparosPeriodo.length;\n\n            const totalConexoes = conexoes.length;\n            const mediaDisparosPorConexao = totalConexoes > 0 ? Math.round(totalDisparos / totalConexoes) : 0;\n\n            console.log('Métricas calculadas:', {\n                totalDisparos,\n                conexoesAtivas,\n                totalConexoes,\n                mediaDisparosPorConexao\n            });\n\n            // Agrupar disparos por dia\n            let disparosPorDia = {};\n            \n            // Inicializar todos os dias do período com 0\n            const dataAtual = new Date(dataInicial);\n            \n            while (dataAtual <= hoje) {\n                const dataStr = dataAtual.toISOString().split('T')[0];\n                disparosPorDia[dataStr] = 0;\n                dataAtual.setDate(dataAtual.getDate() + 1);\n            }\n\n            // Contar disparos por dia\n            disparosPeriodo.forEach((disparo, index) => {\n                try {\n                    let dataDisparo;\n                    if (typeof disparo === 'string') {\n                        // Se é string, é o timestamp direto\n                        dataDisparo = new Date(disparo);\n                    } else if (disparo && disparo.created_at) {\n                        // Se é objeto, pegar a propriedade created_at\n                        dataDisparo = new Date(disparo.created_at);\n                    } else {\n                        return;\n                    }\n                    \n                    // Verificar se a data é válida\n                    if (isNaN(dataDisparo.getTime())) {\n                        return;\n                    }\n                    \n                    const dataStr = dataDisparo.toISOString().split('T')[0];\n                    \n                    // Sempre contar o disparo, independente do período\n                    if (disparosPorDia.hasOwnProperty(dataStr)) {\n                        // Cada disparo conta como 1 mensagem\n                        disparosPorDia[dataStr] += 1;\n                    } else {\n                        // Se a data não existe no objeto, criar\n                        disparosPorDia[dataStr] = 1;\n                    }\n                } catch (error) {\n                    // Silenciar erros de processamento\n                }\n            });\n\n            // Converter para array ordenado\n            const disparosPorDiaArray = Object.keys(disparosPorDia)\n                .sort()\n                .map(data => {\n                    try {\n                        return {\n                            data: data,\n                            dataFormatada: new Date(data + 'T00:00:00').toLocaleDateString('pt-BR'),\n                            disparos: disparosPorDia[data]\n                        };\n                    } catch (error) {\n                        console.warn('Erro ao formatar data:', data, error);\n                        return {\n                            data: data,\n                            dataFormatada: data,\n                            disparos: disparosPorDia[data]\n                        };\n                    }\n                })\n                .filter(item => item.disparos > 0); // Mostrar apenas dias com disparos\n                \n\n\n            // Calcular período anterior para comparação (usar período fixo para comparação)\n            const dataInicialAnterior = new Date(dataInicial);\n            dataInicialAnterior.setDate(dataInicialAnterior.getDate() - currentPeriod);\n            const dataFinalAnterior = new Date(dataInicial);\n            dataFinalAnterior.setDate(dataFinalAnterior.getDate() - 1);\n\n            const disparosPeriodoAnterior = disparos.filter(disparo => {\n                if (!disparo) return false;\n                \n                try {\n                    let dataDisparo;\n                    if (typeof disparo === 'string') {\n                        // Se é string, é o timestamp direto\n                        dataDisparo = new Date(disparo);\n                    } else if (disparo && disparo.created_at) {\n                        // Se é objeto, pegar a propriedade created_at\n                        dataDisparo = new Date(disparo.created_at);\n                    } else {\n                        return false;\n                    }\n                    \n                    // Verificar se a data é válida\n                    if (isNaN(dataDisparo.getTime())) {\n                        console.warn('Data inválida do disparo para período anterior:', disparo);\n                        return false;\n                    }\n                    \n                    return dataDisparo >= dataInicialAnterior && dataDisparo <= dataFinalAnterior;\n                } catch (error) {\n                    console.warn('Erro ao processar data para período anterior:', disparo);\n                    return false;\n                }\n            });\n            \n\n\n            // Cada disparo conta como 1 mensagem\n            const totalDisparosAnterior = disparosPeriodoAnterior.length;\n\n            // Calcular mudanças percentuais\n            const calcularMudancaPercentual = (atual, anterior) => {\n                if (anterior === 0) return atual > 0 ? 100 : 0;\n                return ((atual - anterior) / anterior * 100).toFixed(1);\n            };\n\n            const estatisticas = {\n                changeDisparos: calcularMudancaPercentual(totalDisparos, totalDisparosAnterior),\n                changeConexoesAtivas: '0.0', // Para conexões ativas, seria necessário histórico\n                changeTotalConexoes: '0.0', // Para total de conexões, seria necessário histórico\n                changeMediaConexao: calcularMudancaPercentual(mediaDisparosPorConexao, \n                    totalConexoes > 0 ? Math.round(totalDisparosAnterior / totalConexoes) : 0)\n            };\n\n\n\n            const resultado = {\n                totalDisparos,\n                conexoesAtivas,\n                totalConexoes,\n                mediaDisparosPorConexao,\n                disparosPorDia: disparosPorDiaArray,\n                estatisticas\n            };\n\n\n            return resultado;\n        }\n\n        // Carregar dados do dashboard\n        async function carregarDashboard() {\n            console.log('=== CARREGANDO DASHBOARD ===');\n            \n            const userId = getSecureUserId();\n            if (!userId) {\n                console.log('ERRO: UserId não encontrado nos cookies');\n                hideLoading();\n                showError('Sessão inválida. Faça login novamente.');\n                return;\n            }\n\n            console.log('UserId obtido dos cookies:', userId);\n\n            try {\n                // Verificar se é ambiente de demo\n                const isClaudeEnvironment = window.location.hostname.includes('claude.ai') || \n                                          window.location.hostname.includes('anthropic') ||\n                                          window.location.protocol === 'blob:';\n\n                if (isClaudeEnvironment) {\n                    console.log('=== MODO DEMONSTRAÇÃO ===');\n                    \n                    const demoData = generateDemoData(currentPeriod);\n                    \n                    // Simular delay de loading\n                    await new Promise(resolve => setTimeout(resolve, 1500));\n                    \n                    dashboardData = demoData;\n                    console.log('Dados demo carregados:', dashboardData);\n                    \n                    hideLoading();\n                    showDashboard();\n                    renderDashboard();\n                    return;\n                }\n                \n                console.log('Fazendo requisição para API...');\n                \n                // Fazer requisição real para a API\n                const response = await fetch('https://n8n.typebot.pro/webhook/dados-dashboard', {\n                    method: 'POST',\n                    headers: {\n                        'Content-Type': 'application/json'\n                    },\n                    body: JSON.stringify({\n                        userId: userId\n                    })\n                });\n\n\n\n                if (!response.ok) {\n                    const errorText = await response.text();\n                    console.error('Erro na resposta:', errorText);\n                    throw new Error(`Erro ${response.status}: ${response.statusText}`);\n                }\n\n                const apiData = await response.json();\n                console.log('Dados recebidos da API:', JSON.stringify(apiData, null, 2));\n                \n                \n\n                // Processar dados da API\n                dashboardData = await processarDadosAPI(apiData);\n                \n                hideLoading();\n                showDashboard();\n                renderDashboard();\n\n            } catch (error) {\n                console.error('ERRO ao carregar dashboard:', error);\n                hideLoading();\n                showError('Erro ao carregar dashboard: ' + error.message);\n            }\n        }\n\n        // Renderizar dados no dashboard\n        function renderDashboard() {\n            \n            // Atualizar cards de estatísticas\n            document.getElementById('totalDisparos').textContent = dashboardData.totalDisparos.toLocaleString('pt-BR');\n            document.getElementById('conexoesAtivas').textContent = dashboardData.conexoesAtivas.toLocaleString('pt-BR');\n            document.getElementById('totalConexoes').textContent = dashboardData.totalConexoes.toLocaleString('pt-BR');\n            document.getElementById('mediaPorConexao').textContent = dashboardData.mediaDisparosPorConexao.toLocaleString('pt-BR');\n\n            // Atualizar mudanças percentuais\n            if (dashboardData.estatisticas) {\n                updateChangeIndicator('changeDisparos', dashboardData.estatisticas.changeDisparos);\n                updateChangeIndicator('changeConexoesAtivas', dashboardData.estatisticas.changeConexoesAtivas);\n                updateChangeIndicator('changeTotalConexoes', dashboardData.estatisticas.changeTotalConexoes);\n                updateChangeIndicator('changeMediaConexao', dashboardData.estatisticas.changeMediaConexao);\n            }\n\n            // Renderizar gráfico\n            renderChart();\n        }\n\n        // Atualizar indicadores de mudança\n        function updateChangeIndicator(elementId, change) {\n            const element = document.getElementById(elementId);\n            const changeValue = parseFloat(change);\n            const span = element.querySelector('span');\n            \n            span.textContent = `${changeValue >= 0 ? '+' : ''}${changeValue}%`;\n            \n            // Remover classes existentes\n            element.classList.remove('positive', 'negative', 'neutral');\n            \n            // Adicionar classe apropriada\n            if (changeValue > 0) {\n                element.classList.add('positive');\n            } else if (changeValue < 0) {\n                element.classList.add('negative');\n            } else {\n                element.classList.add('neutral');\n            }\n        }\n\n        // Renderizar gráfico de linha\n        function renderChart() {\n            const ctx = document.getElementById('chartCanvas').getContext('2d');\n            \n            // Destruir gráfico anterior se existir\n            if (chart) {\n                chart.destroy();\n            }\n\n            // Verificar se os dados existem\n            if (!dashboardData.disparosPorDia || !Array.isArray(dashboardData.disparosPorDia)) {\n                console.error('disparosPorDia não é um array válido:', dashboardData.disparosPorDia);\n                return;\n            }\n            \n            const labels = dashboardData.disparosPorDia.map(item => item.dataFormatada);\n            const data = dashboardData.disparosPorDia.map(item => item.disparos);\n\n            chart = new Chart(ctx, {\n                type: 'line',\n                data: {\n                    labels: labels,\n                    datasets: [{\n                        label: 'Disparos por Dia',\n                        data: data,\n                        borderColor: '#25d366',\n                        backgroundColor: 'rgba(37, 211, 102, 0.1)',\n                        borderWidth: 3,\n                        fill: true,\n                        tension: 0.4,\n                        pointBackgroundColor: '#25d366',\n                        pointBorderColor: '#ffffff',\n                        pointBorderWidth: 2,\n                        pointRadius: 6,\n                        pointHoverRadius: 8,\n                        pointHoverBackgroundColor: '#25d366',\n                        pointHoverBorderColor: '#ffffff',\n                        pointHoverBorderWidth: 3\n                    }]\n                },\n                options: {\n                    responsive: true,\n                    maintainAspectRatio: false,\n                    plugins: {\n                        legend: {\n                            display: false\n                        },\n                        tooltip: {\n                            backgroundColor: 'rgba(0, 0, 0, 0.8)',\n                            titleColor: '#ffffff',\n                            bodyColor: '#ffffff',\n                            borderColor: '#25d366',\n                            borderWidth: 1,\n                            cornerRadius: 8,\n                            displayColors: false,\n                            callbacks: {\n                                label: function(context) {\n                                    return `${context.parsed.y.toLocaleString('pt-BR')} disparos`;\n                                }\n                            }\n                        }\n                    },\n                    scales: {\n                        x: {\n                            grid: {\n                                color: 'rgba(255, 255, 255, 0.1)',\n                                borderColor: 'rgba(255, 255, 255, 0.2)'\n                            },\n                            ticks: {\n                                color: '#888',\n                                font: {\n                                    size: 12\n                                }\n                            }\n                        },\n                        y: {\n                            beginAtZero: true,\n                            grid: {\n                                color: 'rgba(255, 255, 255, 0.1)',\n                                borderColor: 'rgba(255, 255, 255, 0.2)'\n                            },\n                            ticks: {\n                                color: '#888',\n                                font: {\n                                    size: 12\n                                },\n                                callback: function(value) {\n                                    return value.toLocaleString('pt-BR');\n                                }\n                            }\n                        }\n                    },\n                    interaction: {\n                        intersect: false,\n                        mode: 'index'\n                    },\n                    elements: {\n                        point: {\n                            hoverRadius: 8\n                        }\n                    }\n                }\n            });\n        }\n\n        // Configurar filtros de data\n        function setupDateFilters() {\n            // Configurar datas padrão (últimos 7 dias)\n            const hoje = new Date();\n            const dataInicial = new Date();\n            dataInicial.setDate(hoje.getDate() - 7);\n\n            document.getElementById('dataInicial').value = dataInicial.toISOString().split('T')[0];\n            document.getElementById('dataFinal').value = hoje.toISOString().split('T')[0];\n\n            // Event listeners para botões de período pré-definido\n            const dateRangeButtons = document.querySelectorAll('.btn-date-range');\n            dateRangeButtons.forEach(button => {\n                button.addEventListener('click', function() {\n                    // Remover active de todos os botões\n                    dateRangeButtons.forEach(btn => btn.classList.remove('active'));\n                    // Adicionar active ao botão clicado\n                    this.classList.add('active');\n                    \n                    const days = parseInt(this.dataset.days);\n                    currentPeriod = days;\n                    \n                    // Atualizar campos de data\n                    const hoje = new Date();\n                    const dataInicial = new Date();\n                    dataInicial.setDate(hoje.getDate() - days);\n                    \n                    document.getElementById('dataInicial').value = dataInicial.toISOString().split('T')[0];\n                    document.getElementById('dataFinal').value = hoje.toISOString().split('T')[0];\n                    \n                    // Recarregar dados\n                    recarregarDashboard();\n                });\n            });\n\n            // Event listeners para campos de data personalizados\n            document.getElementById('dataInicial').addEventListener('change', function() {\n                // Remover active de todos os botões quando usar data personalizada\n                dateRangeButtons.forEach(btn => btn.classList.remove('active'));\n                \n                const dataInicial = new Date(this.value);\n                const dataFinal = new Date(document.getElementById('dataFinal').value);\n                const diffTime = Math.abs(dataFinal - dataInicial);\n                currentPeriod = Math.ceil(diffTime / (1000 * 60 * 60 * 24));\n                \n                recarregarDashboard();\n            });\n\n            document.getElementById('dataFinal').addEventListener('change', function() {\n                // Remover active de todos os botões quando usar data personalizada\n                dateRangeButtons.forEach(btn => btn.classList.remove('active'));\n                \n                const dataInicial = new Date(document.getElementById('dataInicial').value);\n                const dataFinal = new Date(this.value);\n                const diffTime = Math.abs(dataFinal - dataInicial);\n                currentPeriod = Math.ceil(diffTime / (1000 * 60 * 60 * 24));\n                \n                recarregarDashboard();\n            });\n        }\n\n        // Recarregar dashboard\n        async function recarregarDashboard() {\n            console.log('Recarregando dashboard...');\n            \n            // Mostrar loading nos cards\n            document.getElementById('totalDisparos').textContent = '...';\n            document.getElementById('conexoesAtivas').textContent = '...';\n            document.getElementById('totalConexoes').textContent = '...';\n            document.getElementById('mediaPorConexao').textContent = '...';\n            \n            await carregarDashboard();\n        }\n\n        // Atualizar dashboard\n        async function atualizarDashboard() {\n            const btnAtualizar = document.getElementById('btnAtualizar');\n            btnAtualizar.disabled = true;\n            btnAtualizar.innerHTML = '🔄 Atualizando...';\n\n            try {\n                await carregarDashboard();\n                showSuccess('Dashboard atualizado com sucesso!');\n            } catch (error) {\n                showError('Erro ao atualizar dashboard: ' + error.message);\n            } finally {\n                btnAtualizar.disabled = false;\n                btnAtualizar.innerHTML = '🔄 Atualizar';\n            }\n        }\n\n        // Event listeners para navegação\n        function setupNavigation() {\n            // Event listener para botão atualizar\n            const btnAtualizar = document.getElementById('btnAtualizar');\n            if (btnAtualizar) {\n                btnAtualizar.addEventListener('click', atualizarDashboard);\n            }\n        }\n\n        // Inicialização\n        async function inicializarPagina() {\n            console.log('Inicializando página do dashboard');\n            \n            // Verificar autenticação\n            checkAuth();\n            \n            console.log('Autenticação verificada, configurando dashboard');\n            setupNavigation();\n            setupDateFilters();\n            \n            // Carregar dashboard\n            await carregarDashboard();\n        }\n\n        // Executar quando o DOM estiver pronto\n        if (document.readyState === 'loading') {\n            document.addEventListener('DOMContentLoaded', inicializarPagina);\n        } else {\n            inicializarPagina();\n        }\n\n\n\n        // Função de logout\n        function logout() {\n            console.log('🚪 Iniciando logout...');\n            \n            // Limpar todos os cookies\n            document.cookie = 'userId=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';\n            document.cookie = 'idLista=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';\n            document.cookie = 'idConexao=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';\n            document.cookie = 'idDisparo=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';\n            \n            // Limpar sessionStorage\n            sessionStorage.clear();\n            \n            console.log('🧹 Cookies e sessionStorage limpos');\n            console.log('🔄 Redirecionando para login...');\n            \n            // Redirecionar para página de login\n            window.location.href = 'https://n8n.typebot.pro/webhook/login';\n        }\n\n\n    </script>\n</body>\n</html>"},"type":"n8n-nodes-base.html","typeVersion":1.2,"position":[-4240,-5552],"id":"1fcb065f-a7f4-4f00-97c2-1157c58f58a0","name":"HTML7"},{"parameters":{"respondWith":"text","responseBody":"={{ $json.html }}","options":{}},"type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-4016,-5552],"id":"20be9460-a8d8-4c30-9b54-29c12153e170","name":"Respond to Webhook6"},{"parameters":{"path":"dashboard","responseMode":"responseNode","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-4448,-5552],"id":"e310f54e-5f71-48c2-b441-6467b53031c4","name":"DASHBOARD","webhookId":"44ef5672-bb5e-47cb-8c16-50d5ffb78a8c"},{"parameters":{"content":"## DADOS DASHBOARD\n\n","height":420,"width":1420,"color":4},"type":"n8n-nodes-base.stickyNote","position":[-3600,-5024],"typeVersion":1,"id":"a896d85d-ada4-43d6-a568-fbd43be322bd","name":"Sticky Note17"},{"parameters":{"httpMethod":"POST","path":"dados-dashboard","responseMode":"lastNode","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-3488,-4864],"id":"a13b5b03-4541-4c41-a303-11d22edfcb1a","name":"Webhook9","webhookId":"0d210c58-1258-4a4b-a3ff-c6b5d1e7b9fc"},{"parameters":{"operation":"getAll","tableId":"vw_Detalhes_Completo","matchType":"allFilters","filters":{"conditions":[{"keyName":"UserId","condition":"eq","keyValue":"={{ $json.body.userId }}"},{"keyName":"Status","condition":"neq","keyValue":"pending"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-3280,-4864],"id":"7a16b940-ad31-43d0-bff7-fc9222f0ffc5","name":"BUSCAR DISPAROS2","alwaysOutputData":true,"credentials":{"supabaseApi":{"id":"gSmzosOueGcVRiU6","name":"supabase enviazap"}}},{"parameters":{"operation":"getAll","tableId":"SAAS_Conexões","matchType":"allFilters","filters":{"conditions":[{"keyName":"idUsuario","condition":"eq","keyValue":"={{ $('Webhook9').item.json.body.userId }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-2832,-4864],"id":"dad9a7ed-466e-46a9-9aad-40f6a18c9fca","name":"BUSCAR CONEXOES","alwaysOutputData":true,"credentials":{"supabaseApi":{"id":"gSmzosOueGcVRiU6","name":"supabase enviazap"}}},{"parameters":{"fieldsToAggregate":{"fieldToAggregate":[{"fieldToAggregate":"dataEnvio"}]},"options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[-3056,-4864],"id":"b3f6cc75-6aa4-4971-bd23-0f6771037290","name":"Aggregate2"},{"parameters":{"aggregate":"aggregateAllItemData","options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[-2608,-4864],"id":"44dd0982-94a9-449b-825a-695e431a5f91","name":"Aggregate3"},{"parameters":{"assignments":{"assignments":[{"id":"e61d1316-a6c0-4175-afd1-f76a369e588d","name":"disparos","value":"={{ $('Aggregate2').item.json.dataEnvio }}","type":"array"},{"id":"97a44da0-c114-4878-9197-236af14905b4","name":"conexoes","value":"={{ $json.data }}","type":"array"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-2400,-4864],"id":"36554317-6957-497d-9d23-e63c80fd0249","name":"RESPOSTA6"},{"parameters":{"httpMethod":"POST","path":"criarconexaoback","responseMode":"lastNode","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-3488,-6896],"id":"c8ecc285-2a34-4f38-90d9-410f3e867d6c","name":"CRIAR CONEXAO2","webhookId":"0d210c58-1258-4a4b-a3ff-c6b5d1e7b9fc"},{"parameters":{"assignments":{"assignments":[{"id":"c16002cb-6afa-4ec1-8cdf-f8b5108f3af8","name":"resposta","value":"=deletada","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-2576,-6688],"id":"fbf94b94-d63a-428e-bc3d-22c2beac45ba","name":"RESPOSTA7"},{"parameters":{"httpMethod":"POST","path":"apagarconexaoback","responseMode":"lastNode","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-3488,-6688],"id":"581ff3bc-8410-42ff-ad0c-474d72f4e9c9","name":"APAGAR CONEXAO","webhookId":"0d210c58-1258-4a4b-a3ff-c6b5d1e7b9fc"},{"parameters":{"method":"DELETE","url":"=https://whatsapi.typebot.pro/instance/delete/{{ $('APAGAR CONEXAO').item.json.body.instanceName }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apikey","value":"b4d71f9c38e3ac12a6b08e4b6d53aa90"}]},"options":{"redirect":{"redirect":{}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-3056,-6688],"id":"fcdb3ba1-31be-4691-bca7-80678f69e9c1","name":"DELETAR INSTANCIA","onError":"continueRegularOutput"},{"parameters":{"method":"DELETE","url":"=https://whatsapi.typebot.pro/instance/logout/{{ $json.body.instanceName }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apikey","value":"b4d71f9c38e3ac12a6b08e4b6d53aa90"}]},"options":{"redirect":{"redirect":{}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-3280,-6688],"id":"b0f0459d-5aa9-42d8-a118-0cfd9cd34076","name":"DESLOGAR INSTANCIA","onError":"continueRegularOutput"},{"parameters":{"operation":"delete","tableId":"SAAS_Conexões","filters":{"conditions":[{"keyName":"instanceName","condition":"eq","keyValue":"={{ $('APAGAR CONEXAO').item.json.body.instanceName }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-2816,-6688],"id":"0096af5b-a597-49b1-82ff-09a5032d5941","name":"DELETAR CONEXAO","alwaysOutputData":true,"credentials":{"supabaseApi":{"id":"gSmzosOueGcVRiU6","name":"supabase enviazap"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"79557408-7865-45c4-bcdd-1b60d23fcf14","leftValue":"={{ $('LOCALIZAR EMAIL').item.json.status }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-2832,-7376],"id":"317bf44e-0289-4163-91cb-dcdc4621ef94","name":"If1"},{"parameters":{"assignments":{"assignments":[{"id":"f8f7118b-6718-4985-bf2d-43d1e0ec2830","name":"acesso","value":"bloqueado","type":"string"},{"id":"29e00872-3b30-439b-b232-4ba2519bf4f7","name":"userId","value":"={{ $json.id }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-2496,-7312],"id":"f9bfbacf-c73b-484d-b38c-45b374c8d532","name":"BLOQUEADO"},{"parameters":{"content":"## LISTAS\n\n","height":720,"width":1040,"color":4},"type":"n8n-nodes-base.stickyNote","position":[-3600,-4544],"typeVersion":1,"id":"90d57fed-ae62-41f9-b6d7-2a9ec6012c0e","name":"Sticky Note18"},{"parameters":{"tableId":"SAAS_Listas","fieldsUi":{"fieldValues":[{"fieldId":"nome","fieldValue":"={{ $json.body.nome }}"},{"fieldId":"descricao","fieldValue":"={{ $json.body.descricao }}"},{"fieldId":"idUsuario","fieldValue":"={{ $json.body.userId }}"},{"fieldId":"tipo","fieldValue":"={{ $json.body.tipo }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-3280,-4448],"id":"73bdbe86-9f76-4f86-94bc-4d744c06df70","name":"CRIAR LISTA","credentials":{"supabaseApi":{"id":"gSmzosOueGcVRiU6","name":"supabase enviazap"}}},{"parameters":{"httpMethod":"POST","path":"criar-lista","responseMode":"lastNode","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-3488,-4448],"id":"0e160f21-1431-4dea-ba3d-5e5502c1cbf8","name":"CRIAR LISTA2","webhookId":"0d210c58-1258-4a4b-a3ff-c6b5d1e7b9fc"},{"parameters":{"httpMethod":"POST","path":"puxar-lista","responseMode":"lastNode","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-3488,-4224],"id":"9908ae9b-f8c5-4807-bb6d-3b8b2ee9d3be","name":"PUXAR LISTAS","webhookId":"0d210c58-1258-4a4b-a3ff-c6b5d1e7b9fc"},{"parameters":{"operation":"getAll","tableId":"SAAS_Listas","filters":{"conditions":[{"keyName":"idUsuario","condition":"eq","keyValue":"={{ $json.body.userId }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-3280,-4224],"id":"ff4c31fc-887a-4339-a5a3-61c1cc032b8e","name":"PUXAR LISTAS1","credentials":{"supabaseApi":{"id":"gSmzosOueGcVRiU6","name":"supabase enviazap"}}},{"parameters":{"aggregate":"aggregateAllItemData","options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[-3056,-4224],"id":"cad44188-c51e-45a3-b268-79ab79814464","name":"Aggregate4"},{"parameters":{"httpMethod":"POST","path":"excluir-lista","responseMode":"lastNode","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-3488,-4016],"id":"be6f5e05-7aec-44a2-a8fe-68154824c91e","name":"EXCLUIR LISTA","webhookId":"0d210c58-1258-4a4b-a3ff-c6b5d1e7b9fc"},{"parameters":{"operation":"delete","tableId":"SAAS_Listas","filters":{"conditions":[{"keyName":"id","condition":"eq","keyValue":"={{ $json.body.idLista }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-3280,-4016],"id":"818e8253-f176-4a76-afda-43be475656f9","name":"EXCLUIR LISTA1","credentials":{"supabaseApi":{"id":"gSmzosOueGcVRiU6","name":"supabase enviazap"}}},{"parameters":{"content":"## LISTAS-CONTATOS\n\n","height":940,"width":1560,"color":4},"type":"n8n-nodes-base.stickyNote","position":[-3600,-3776],"typeVersion":1,"id":"74fb2cce-cb86-400b-99e8-98020b76fac6","name":"Sticky Note19"},{"parameters":{"aggregate":"aggregateAllItemData","options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[-3072,-3664],"id":"019da031-5ffa-4bea-ac24-38d0c7577015","name":"Aggregate5"},{"parameters":{"httpMethod":"POST","path":"criar-contatos","responseMode":"lastNode","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-3520,-3328],"id":"f04a766e-d9c5-4466-ad83-618656794e36","name":"CRIAR CONTATOS","webhookId":"0d210c58-1258-4a4b-a3ff-c6b5d1e7b9fc"},{"parameters":{"tableId":"SAAS_Contatos","fieldsUi":{"fieldValues":[{"fieldId":"nome","fieldValue":"={{ $json.nome }}"},{"fieldId":"telefone","fieldValue":"={{ $json.telefone }}"},{"fieldId":"idUsuario","fieldValue":"={{ $json.userId }}"},{"fieldId":"idLista","fieldValue":"={{ $json.idLista }}"},{"fieldId":"atributos","fieldValue":"={{ $json.variaveis }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-3072,-3328],"id":"8b43e8b3-b081-4ad2-808b-61f1d02d9afe","name":"CRIAR CONTATOS1","credentials":{"supabaseApi":{"id":"gSmzosOueGcVRiU6","name":"supabase enviazap"}}},{"parameters":{"httpMethod":"POST","path":"criar-variaveis","responseMode":"lastNode","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-3520,-3152],"id":"de92ce31-61ca-4857-a529-3befac6d8ca0","name":"CRIAR VARIAVEIS","webhookId":"0d210c58-1258-4a4b-a3ff-c6b5d1e7b9fc"},{"parameters":{"operation":"update","tableId":"SAAS_Listas","filters":{"conditions":[{"keyName":"id","condition":"eq","keyValue":"={{ $json.body.idLista }}"}]},"fieldsUi":{"fieldValues":[{"fieldId":"campos","fieldValue":"={{ $json.body.variaveis }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-3296,-3152],"id":"3756be88-a48d-489c-9a29-2f4632b5231a","name":"CRIAR VARIAVEIS1","credentials":{"supabaseApi":{"id":"gSmzosOueGcVRiU6","name":"supabase enviazap"}}},{"parameters":{"httpMethod":"POST","path":"puxar-lista-contatos","responseMode":"lastNode","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-3520,-3664],"id":"c0935ca3-b7d7-4047-b92c-872fc8e07a7b","name":"PUXAR CONTATOS1","webhookId":"0d210c58-1258-4a4b-a3ff-c6b5d1e7b9fc"},{"parameters":{"aggregate":"aggregateAllItemData","options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[-3072,-3504],"id":"43d6243d-e01a-41c7-a06b-46de924b8c10","name":"Aggregate6"},{"parameters":{"httpMethod":"POST","path":"puxar-variaveis","responseMode":"lastNode","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-3520,-3504],"id":"b32062ca-c839-4602-96ec-ee2b43cd32e3","name":"PUXAR VARIAVEIS","webhookId":"0d210c58-1258-4a4b-a3ff-c6b5d1e7b9fc"},{"parameters":{"operation":"getAll","tableId":"SAAS_Listas","limit":null,"filters":{"conditions":[{"keyName":"id","condition":"eq","keyValue":"={{ $json.body.idLista }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-3296,-3504],"id":"a9c6ae78-c412-4d58-9b9c-ae4fb3e4a119","name":"PUXAR VARIAVEIS1","credentials":{"supabaseApi":{"id":"gSmzosOueGcVRiU6","name":"supabase enviazap"}}},{"parameters":{"fieldToSplitOut":"body","options":{}},"type":"n8n-nodes-base.splitOut","typeVersion":1,"position":[-3296,-3328],"id":"4831615b-9250-46dd-8611-c32a267aac2d","name":"Split Out"},{"parameters":{"content":"## Tela Listas","height":260,"width":760,"color":2},"type":"n8n-nodes-base.stickyNote","position":[-4512,-5344],"typeVersion":1,"id":"98ca95e8-8a24-432f-b9c0-3eb8fb176dd0","name":"Sticky Note20"},{"parameters":{"html":"<!DOCTYPE html>\n<html lang=\"pt-BR\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>Listas - EnviaZap</title>\n    <style>\n        * {\n            margin: 0;\n            padding: 0;\n            box-sizing: border-box;\n        }\n\n        body {\n            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);\n            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n            color: white;\n            min-height: 100vh;\n            margin: 0;\n            padding: 0;\n        }\n\n        .app-layout {\n            display: flex;\n            min-height: 100vh;\n        }\n\n        /* Sidebar */\n        .sidebar {\n            width: 70px;\n            background: rgba(0, 0, 0, 0.3);\n            backdrop-filter: blur(10px);\n            border-right: 1px solid rgba(255, 255, 255, 0.1);\n            transition: all 0.3s ease;\n            position: relative;\n            z-index: 1000;\n            display: flex;\n            flex-direction: column;\n            height: 100vh;\n        }\n\n        .sidebar:hover {\n            width: 250px;\n        }\n\n        /* Ajustar o hover para ser mais preciso */\n        .sidebar {\n            width: 70px;\n            background: rgba(0, 0, 0, 0.3);\n            backdrop-filter: blur(10px);\n            border-right: 1px solid rgba(255, 255, 255, 0.1);\n            transition: all 0.3s ease;\n            position: relative;\n            z-index: 1000;\n        }\n\n        .sidebar:hover {\n            width: 250px;\n        }\n\n\n\n        .sidebar-header {\n            padding: 20px;\n            text-align: center;\n            border-bottom: 1px solid rgba(255, 255, 255, 0.1);\n        }\n\n        .sidebar-logo {\n            font-size: 1.5rem;\n            font-weight: 600;\n            background: linear-gradient(135deg, #25d366 0%, #128c7e 100%);\n            -webkit-background-clip: text;\n            -webkit-text-fill-color: transparent;\n            background-clip: text;\n            white-space: nowrap;\n            opacity: 0;\n            transition: opacity 0.3s ease;\n        }\n\n        .sidebar:hover .sidebar-logo {\n            opacity: 1;\n        }\n\n        .sidebar-menu {\n            padding: 20px 0;\n            flex: 1;\n        }\n\n        .menu-item {\n            display: flex;\n            align-items: center;\n            padding: 15px 20px;\n            color: #ccc;\n            text-decoration: none;\n            transition: all 0.3s ease;\n            position: relative;\n            white-space: nowrap;\n        }\n\n        .menu-item:hover {\n            background: rgba(37, 211, 102, 0.1);\n            color: #25d366;\n        }\n\n        .menu-item.active {\n            background: rgba(37, 211, 102, 0.2);\n            color: #25d366;\n            border-right: 3px solid #25d366;\n        }\n\n        .menu-icon {\n            font-size: 1.2rem;\n            width: 30px;\n            text-align: center;\n            flex-shrink: 0;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n        }\n\n        .menu-icon svg {\n            transition: all 0.3s ease;\n        }\n\n        .menu-item:hover .menu-icon svg {\n            transform: scale(1.1);\n        }\n\n        .menu-text {\n            margin-left: 15px;\n            opacity: 0;\n            transition: opacity 0.3s ease;\n        }\n\n        .sidebar:hover .menu-text {\n            opacity: 1;\n        }\n\n        .sidebar-footer {\n            margin-top: auto;\n            border-top: 1px solid rgba(255, 255, 255, 0.1);\n            padding: 10px 0;\n        }\n\n        .logout-item {\n            color: #ff6b6b !important;\n        }\n\n        .logout-item:hover {\n            background: rgba(255, 107, 107, 0.1) !important;\n            color: #ff6b6b !important;\n        }\n\n        /* Main content */\n        .main-content-wrapper {\n            flex: 1;\n            padding: 32px 0 0 0;\n            overflow-x: auto;\n        }\n\n        .container {\n            width: 100%;\n            margin: 0;\n            padding: 0 32px;\n        }\n\n        .header {\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            margin-bottom: 40px;\n        }\n\n        .header-info {\n            display: flex;\n            flex-direction: column;\n            gap: 4px;\n        }\n\n        .header-info h1 {\n            font-size: 2.5rem;\n            font-weight: 600;\n            margin-bottom: 10px;\n            color: white;\n        }\n\n        .header-info p {\n            color: #888;\n            font-size: 1.1rem;\n        }\n\n        .main-content {\n            display: flex;\n            flex-direction: column;\n            gap: 30px;\n        }\n\n        .section {\n            background: rgba(255, 255, 255, 0.02);\n            border: 1px solid rgba(255, 255, 255, 0.1);\n            border-radius: 16px;\n            padding: 40px;\n            backdrop-filter: blur(10px);\n            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);\n        }\n\n        .section-header {\n            display: flex;\n            align-items: center;\n            gap: 12px;\n            margin-bottom: 25px;\n            padding-bottom: 15px;\n            border-bottom: 1px solid rgba(255, 255, 255, 0.1);\n        }\n\n        .section-icon {\n            font-size: 1.5rem;\n        }\n\n        .section-title {\n            font-size: 1.4rem;\n            font-weight: 600;\n            color: #25d366;\n        }\n\n        .section-subtitle {\n            color: #888;\n            font-size: 0.9rem;\n            margin-bottom: 20px;\n            line-height: 1.4;\n        }\n\n        /* Header com ações */\n        .header-actions {\n            display: flex;\n            gap: 15px;\n            align-items: center;\n        }\n\n        .btn-refresh {\n            padding: 12px 20px;\n            background: linear-gradient(135deg, #25d366 0%, #128c7e 100%);\n            border: none;\n            border-radius: 8px;\n            color: white;\n            font-weight: 600;\n            cursor: pointer;\n            transition: all 0.3s ease;\n            display: flex;\n            align-items: center;\n            gap: 8px;\n            font-size: 0.9rem;\n        }\n\n        .btn-refresh:hover {\n            transform: translateY(-2px);\n            box-shadow: 0 8px 25px rgba(37, 211, 102, 0.3);\n        }\n\n        .btn-refresh:disabled {\n            background: #444;\n            cursor: not-allowed;\n            transform: none;\n        }\n\n        /* Filtros */\n        .filters-container {\n            display: flex;\n            gap: 15px;\n            margin-bottom: 30px;\n            flex-wrap: wrap;\n            align-items: center;\n            background: rgba(255, 255, 255, 0.02);\n            border: 1px solid rgba(255, 255, 255, 0.1);\n            border-radius: 12px;\n            padding: 20px;\n            backdrop-filter: blur(10px);\n        }\n\n        .filter-group {\n            display: flex;\n            flex-direction: column;\n            gap: 5px;\n        }\n\n        .filter-label {\n            font-size: 0.9rem;\n            color: #888;\n            font-weight: 500;\n        }\n\n        .filter-select, .filter-input {\n            padding: 10px 15px;\n            background: rgba(255, 255, 255, 0.05);\n            border: 1px solid rgba(255, 255, 255, 0.1);\n            border-radius: 8px;\n            color: white;\n            font-size: 0.9rem;\n            min-width: 120px;\n            transition: all 0.3s ease;\n        }\n\n        .filter-select:focus, .filter-input:focus {\n            border-color: #25d366;\n            outline: none;\n        }\n\n        /* Tabela de listas */\n        .lists-table-container {\n            background: rgba(255, 255, 255, 0.02);\n            border: 1px solid rgba(255, 255, 255, 0.1);\n            border-radius: 16px;\n            overflow: hidden;\n            backdrop-filter: blur(10px);\n        }\n\n        .lists-table {\n            width: 100%;\n            border-collapse: collapse;\n        }\n\n        .lists-table th {\n            background: rgba(255, 255, 255, 0.05);\n            padding: 15px 20px;\n            text-align: left;\n            font-weight: 600;\n            color: #25d366;\n            font-size: 0.9rem;\n            border-bottom: 1px solid rgba(255, 255, 255, 0.1);\n        }\n\n        .lists-table td {\n            padding: 15px 20px;\n            border-bottom: 1px solid rgba(255, 255, 255, 0.05);\n            font-size: 0.9rem;\n        }\n\n        .lists-table tr:hover {\n            background: rgba(37, 211, 102, 0.05);\n        }\n\n        .list-row {\n            transition: all 0.3s ease;\n        }\n\n        .list-row:hover {\n            background: rgba(37, 211, 102, 0.08) !important;\n            transform: translateX(2px);\n        }\n\n        .list-type svg {\n            margin-right: 6px;\n            vertical-align: middle;\n        }\n\n        .action-btn svg {\n            transition: all 0.3s ease;\n        }\n\n        .action-btn:hover svg {\n            transform: scale(1.1);\n        }\n\n        .lists-table tr:last-child td {\n            border-bottom: none;\n        }\n\n        .list-name {\n            font-weight: 600;\n            color: #fff;\n        }\n\n        .list-type {\n            display: inline-flex;\n            align-items: center;\n            gap: 6px;\n            padding: 4px 12px;\n            border-radius: 20px;\n            font-size: 0.8rem;\n            font-weight: 500;\n        }\n\n        .list-type.contacts {\n            background: rgba(37, 211, 102, 0.1);\n            color: #25d366;\n            border: 1px solid rgba(37, 211, 102, 0.3);\n        }\n\n        .list-type.groups {\n            background: rgba(255, 193, 7, 0.1);\n            color: #ffc107;\n            border: 1px solid rgba(255, 193, 7, 0.3);\n        }\n\n        .list-date {\n            color: #888;\n            font-size: 0.85rem;\n        }\n\n        .list-actions {\n            display: flex;\n            gap: 8px;\n        }\n\n        .action-btn {\n            background: none;\n            border: none;\n            color: #888;\n            cursor: pointer;\n            padding: 6px;\n            border-radius: 4px;\n            transition: all 0.3s ease;\n            font-size: 0.9rem;\n        }\n\n        .action-btn:hover {\n            background: rgba(255, 255, 255, 0.1);\n            color: white;\n        }\n\n        .action-btn.edit:hover {\n            color: #25d366;\n        }\n\n        .action-btn.delete:hover {\n            color: #ff4444;\n        }\n\n        /* Loading state */\n        .loading-container {\n            display: flex;\n            flex-direction: column;\n            align-items: center;\n            justify-content: center;\n            min-height: 400px;\n            gap: 20px;\n        }\n\n        .loading-spinner {\n            width: 60px;\n            height: 60px;\n            border: 4px solid rgba(37, 211, 102, 0.3);\n            border-top: 4px solid #25d366;\n            border-radius: 50%;\n            animation: spin 1s linear infinite;\n        }\n\n        .loading-text {\n            color: #25d366;\n            font-size: 1.2rem;\n            font-weight: 500;\n        }\n\n        /* Botões principais */\n        .action-buttons {\n            display: grid;\n            grid-template-columns: 1fr 1fr;\n            gap: 15px;\n            margin-bottom: 25px;\n        }\n\n        .btn {\n            padding: 15px 20px;\n            border: none;\n            border-radius: 12px;\n            color: white;\n            font-size: 0.95rem;\n            font-weight: 600;\n            cursor: pointer;\n            transition: all 0.3s ease;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            gap: 8px;\n            text-decoration: none;\n        }\n\n        .btn-primary {\n            background: linear-gradient(135deg, #25d366 0%, #128c7e 100%);\n        }\n\n        .btn-primary:hover {\n            transform: translateY(-2px);\n            box-shadow: 0 12px 30px rgba(37, 211, 102, 0.4);\n        }\n\n        .btn-secondary {\n            background: rgba(255, 255, 255, 0.05);\n            border: 1px solid rgba(255, 255, 255, 0.2);\n        }\n\n        .btn-secondary:hover {\n            background: rgba(255, 255, 255, 0.1);\n            transform: translateY(-2px);\n        }\n\n        .btn-whatsapp {\n            background: linear-gradient(135deg, #25d366 0%, #128c7e 100%);\n            width: 100%;\n            grid-column: 1 / -1;\n        }\n\n        .btn-whatsapp:hover {\n            transform: translateY(-2px);\n            box-shadow: 0 12px 30px rgba(37, 211, 102, 0.4);\n        }\n\n        /* Mensagens */\n        .message {\n            padding: 15px;\n            border-radius: 8px;\n            margin-bottom: 15px;\n            font-size: 0.9rem;\n            display: none;\n        }\n\n        .message.show {\n            display: block;\n            animation: fadeIn 0.3s ease;\n        }\n\n        .message.success {\n            background: rgba(37, 211, 102, 0.1);\n            border: 1px solid rgba(37, 211, 102, 0.3);\n            color: #25d366;\n        }\n\n        .message.error {\n            background: rgba(255, 68, 68, 0.1);\n            border: 1px solid rgba(255, 68, 68, 0.3);\n            color: #ff4444;\n        }\n\n        .message.info {\n            background: rgba(0, 123, 255, 0.1);\n            border: 1px solid rgba(0, 123, 255, 0.3);\n            color: #007bff;\n        }\n\n        .message.warning {\n            background: rgba(255, 193, 7, 0.1);\n            border: 1px solid rgba(255, 193, 7, 0.3);\n            color: #ffc107;\n        }\n\n        /* Loading spinner */\n        .loading-spinner {\n            width: 20px;\n            height: 20px;\n            border: 2px solid rgba(255, 255, 255, 0.3);\n            border-top: 2px solid white;\n            border-radius: 50%;\n            animation: spin 1s linear infinite;\n            display: none;\n        }\n\n        .btn.loading .loading-spinner {\n            display: block;\n        }\n\n        @keyframes spin {\n            0% { transform: rotate(0deg); }\n            100% { transform: rotate(360deg); }\n        }\n\n        @keyframes fadeIn {\n            from {\n                opacity: 0;\n                transform: translateY(20px);\n            }\n            to {\n                opacity: 1;\n                transform: translateY(0);\n            }\n        }\n\n        /* Scrollbar customization */\n        .lists-table-container::-webkit-scrollbar {\n            width: 6px;\n        }\n\n        .lists-table-container::-webkit-scrollbar-track {\n            background: rgba(255, 255, 255, 0.05);\n            border-radius: 3px;\n        }\n\n        .lists-table-container::-webkit-scrollbar-thumb {\n            background: rgba(37, 211, 102, 0.5);\n            border-radius: 3px;\n        }\n\n        .lists-table-container::-webkit-scrollbar-thumb:hover {\n            background: rgba(37, 211, 102, 0.7);\n        }\n\n        /* Responsive */\n        @media (max-width: 768px) {\n            .main-content {\n                gap: 20px;\n            }\n            \n            .filters-container {\n                flex-direction: column;\n                align-items: stretch;\n            }\n            \n            .filter-group {\n                width: 100%;\n            }\n            \n            .header {\n                flex-direction: column;\n                align-items: stretch;\n                gap: 15px;\n            }\n            \n            .header-actions {\n                justify-content: flex-start;\n                gap: 10px;\n            }\n\n            .main-content-wrapper {\n                padding: 16px 0 0 0;\n            }\n            \n            .container {\n                padding: 0 8px;\n            }\n            \n            .lists-table {\n                font-size: 0.8rem;\n            }\n            \n            .lists-table th,\n            .lists-table td {\n                padding: 10px 12px;\n            }\n        }\n\n        /* Modal */\n        .modal {\n            display: none;\n            position: fixed;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n            background: rgba(0, 0, 0, 0.8);\n            z-index: 1000;\n            backdrop-filter: blur(5px);\n        }\n        .modal.show {\n            display: flex;\n            align-items: center;\n            justify-content: center;\n        }\n        .modal-content {\n            background: rgba(26, 26, 26, 0.95);\n            border: 1px solid rgba(255, 255, 255, 0.1);\n            border-radius: 16px;\n            padding: 30px;\n            max-width: 400px;\n            width: 90%;\n            backdrop-filter: blur(10px);\n            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);\n        }\n        .modal-header {\n            display: flex;\n            align-items: center;\n            justify-content: space-between;\n            margin-bottom: 20px;\n        }\n        .modal-title {\n            font-size: 1.3rem;\n            font-weight: 600;\n            color: #25d366;\n        }\n        .modal-close {\n            background: none;\n            border: none;\n            color: #888;\n            font-size: 1.5rem;\n            cursor: pointer;\n            padding: 5px;\n            border-radius: 4px;\n            transition: all 0.3s ease;\n        }\n        .modal-close:hover {\n            background: rgba(255, 255, 255, 0.1);\n            color: white;\n        }\n        .modal .form-group {\n            margin-bottom: 22px;\n        }\n        .modal .form-group label {\n            color: #fff;\n            font-weight: 500;\n            margin-bottom: 8px;\n            font-size: 0.95rem;\n            display: block;\n        }\n        .modal .form-group input,\n        .modal .form-group select {\n            width: 100%;\n            padding: 12px 15px;\n            background: rgba(255, 255, 255, 0.05);\n            border: 1px solid rgba(255, 255, 255, 0.2);\n            border-radius: 8px;\n            color: white;\n            font-size: 1rem;\n            outline: none;\n            transition: all 0.3s ease;\n        }\n        .modal .form-group input:focus,\n        .modal .form-group select:focus {\n            border-color: #25d366;\n            box-shadow: 0 0 0 2px rgba(37, 211, 102, 0.2);\n        }\n        .modal .form-group input::placeholder {\n            color: #888;\n        }\n\n        /* Custom Dropdown Styles */\n        .custom-dropdown {\n            position: relative;\n            width: 100%;\n        }\n\n        .dropdown-header {\n            width: 100%;\n            padding: 12px 15px;\n            background: rgba(255, 255, 255, 0.05);\n            border: 1px solid rgba(255, 255, 255, 0.2);\n            border-radius: 8px;\n            color: white;\n            font-size: 1rem;\n            cursor: pointer;\n            display: flex;\n            align-items: center;\n            justify-content: space-between;\n            transition: all 0.3s ease;\n            user-select: none;\n        }\n\n        .dropdown-header:hover {\n            border-color: rgba(37, 211, 102, 0.5);\n            background: rgba(255, 255, 255, 0.08);\n        }\n\n        .dropdown-header.active {\n            border-color: #25d366;\n            box-shadow: 0 0 0 2px rgba(37, 211, 102, 0.2);\n        }\n\n        .dropdown-selected {\n            color: white;\n        }\n\n        .dropdown-arrow {\n            color: #888;\n            transition: transform 0.3s ease;\n        }\n\n        .dropdown-header.active .dropdown-arrow {\n            transform: rotate(180deg);\n            color: #25d366;\n        }\n\n        .dropdown-options {\n            position: absolute;\n            top: 100%;\n            left: 0;\n            right: 0;\n            background: rgba(0, 0, 0, 0.95);\n            border: 1px solid rgba(255, 255, 255, 0.2);\n            border-radius: 8px;\n            margin-top: 4px;\n            max-height: 200px;\n            overflow-y: auto;\n            z-index: 1000;\n            opacity: 0;\n            visibility: hidden;\n            transform: translateY(-10px);\n            transition: all 0.3s ease;\n            backdrop-filter: blur(10px);\n        }\n\n        .dropdown-options.show {\n            opacity: 1;\n            visibility: visible;\n            transform: translateY(0);\n        }\n\n        .dropdown-option {\n            padding: 12px 15px;\n            color: white;\n            cursor: pointer;\n            transition: all 0.2s ease;\n            border-bottom: 1px solid rgba(255, 255, 255, 0.1);\n        }\n\n        .dropdown-option:last-child {\n            border-bottom: none;\n        }\n\n        .dropdown-option:hover {\n            background: rgba(37, 211, 102, 0.1);\n            color: #25d366;\n        }\n\n        .dropdown-option.selected {\n            background: rgba(37, 211, 102, 0.2);\n            color: #25d366;\n        }\n\n        /* Scrollbar para o dropdown */\n        .dropdown-options::-webkit-scrollbar {\n            width: 6px;\n        }\n\n        .dropdown-options::-webkit-scrollbar-track {\n            background: rgba(255, 255, 255, 0.1);\n            border-radius: 3px;\n        }\n\n        .dropdown-options::-webkit-scrollbar-thumb {\n            background: rgba(255, 255, 255, 0.3);\n            border-radius: 3px;\n        }\n\n        .dropdown-options::-webkit-scrollbar-thumb:hover {\n            background: rgba(255, 255, 255, 0.5);\n        }\n    </style>\n</head>\n<body>\n    <div class=\"app-layout\">\n        <!-- Sidebar -->\n        <div class=\"sidebar\">\n            <div class=\"sidebar-header\">\n                <div class=\"sidebar-logo\">EnviaZap</div>\n            </div>\n            <nav class=\"sidebar-menu\">\n                <a href=\"#\" class=\"menu-item\" onclick=\"navigateToPage('https://n8n.typebot.pro/webhook/dashboard')\">\n                    <span class=\"menu-icon\">📊</span>\n                    <span class=\"menu-text\">Dashboard</span>\n                </a>\n                <a href=\"#\" class=\"menu-item\" onclick=\"navigateToPage('https://n8n.typebot.pro/webhook/historico-disparos')\">\n                    <span class=\"menu-icon\">📋</span>\n                    <span class=\"menu-text\">Histórico de disparos</span>\n                </a>\n                <a href=\"#\" class=\"menu-item\" onclick=\"navigateToPage('https://n8n.typebot.pro/webhook/conectar')\">\n                    <span class=\"menu-icon\">🔗</span>\n                    <span class=\"menu-text\">Nova Conexão</span>\n                </a>\n                <a href=\"#\" class=\"menu-item\" onclick=\"navigateToPage('https://n8n.typebot.pro/webhook/conexoes')\">\n                    <span class=\"menu-icon\">🔌</span>\n                    <span class=\"menu-text\">Conexões</span>\n                </a>\n                <a href=\"#\" class=\"menu-item\" onclick=\"navigateToPage('https://n8n.typebot.pro/webhook/disparos-individuais')\">\n                    <span class=\"menu-icon\">💬</span>\n                    <span class=\"menu-text\">Disparos individuais</span>\n                </a>\n                <a href=\"#\" class=\"menu-item\" onclick=\"navigateToPage('https://n8n.typebot.pro/webhook/disparos-grupos')\">\n                    <span class=\"menu-icon\">👥</span>\n                    <span class=\"menu-text\">Disparos em grupo</span>\n                </a>\n                <a href=\"#\" class=\"menu-item active\">\n                    <span class=\"menu-icon\">📋</span>\n                    <span class=\"menu-text\">Listas</span>\n                </a>\n            </nav>\n            <div class=\"sidebar-footer\">\n                <a href=\"#\" class=\"menu-item logout-item\" onclick=\"logout()\">\n                    <span class=\"menu-icon\">🚪</span>\n                    <span class=\"menu-text\">Sair</span>\n                </a>\n            </div>\n        </div>\n\n        <!-- Main Content -->\n        <div class=\"main-content-wrapper\">\n            <div class=\"container\">\n                <div class=\"header\">\n                    <div class=\"header-info\">\n                        <h1>📋 Listas</h1>\n                        <p>Gerencie suas listas de contatos e grupos do WhatsApp</p>\n                    </div>\n                    <div class=\"header-actions\">\n                        <button class=\"btn-refresh\" id=\"refreshBtn\" onclick=\"loadLists()\">\n                            <span>\n                                <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\n                                    <path d=\"M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z\"/>\n                                </svg>\n                            </span>\n                            Atualizar\n                        </button>\n                        <button class=\"btn-refresh\" id=\"createListBtn\" onclick=\"openCreateModal()\">\n                            <span>\n                                <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\n                                    <path d=\"M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z\"/>\n                                </svg>\n                            </span>\n                            Criar Lista\n                        </button>\n                    </div>\n                </div>\n\n                <!-- Loading State -->\n                <div class=\"loading-container\" id=\"loadingContainer\" style=\"display: none;\">\n                    <div class=\"loading-spinner\"></div>\n                    <div class=\"loading-text\">Carregando listas...</div>\n                </div>\n\n                <div class=\"main-content\" id=\"mainContent\">\n                    <!-- Filtros -->\n                    <div class=\"filters-container\">\n                        <div class=\"filter-group\">\n                            <label class=\"filter-label\">Tipo de Lista</label>\n                            <select class=\"filter-select\" id=\"typeFilter\">\n                                <option value=\"\">Todos os tipos</option>\n                                <option value=\"contacts\">Contatos</option>\n                                <option value=\"groups\">Grupos</option>\n                            </select>\n                        </div>\n                        \n                        <div class=\"filter-group\">\n                            <label class=\"filter-label\">Data de Criação</label>\n                            <select class=\"filter-select\" id=\"dateFilter\">\n                                <option value=\"\">Todas as datas</option>\n                                <option value=\"today\">Hoje</option>\n                                <option value=\"week\">Última semana</option>\n                                <option value=\"month\">Último mês</option>\n                                <option value=\"year\">Último ano</option>\n                            </select>\n                        </div>\n                        \n                        <div class=\"filter-group\">\n                            <label class=\"filter-label\">Buscar</label>\n                            <input type=\"text\" class=\"filter-input\" id=\"searchFilter\" placeholder=\"Nome da lista...\">\n                        </div>\n                    </div>\n\n                    <!-- Tabela de Listas -->\n                    <!-- Mensagens -->\n                    <div class=\"message\" id=\"listsMessage\"></div>\n\n                    <div class=\"lists-table-container\">\n                        <table class=\"lists-table\">\n                            <thead>\n                                <tr>\n                                    <th>Nome da Lista</th>\n                                    <th>Tipo</th>\n                                    <th>Data de Criação</th>\n                                    <th>Ações</th>\n                                </tr>\n                            </thead>\n                            <tbody id=\"listsTableBody\">\n                                <tr>\n                                    <td colspan=\"5\" style=\"text-align: center; color: #888; padding: 40px 20px;\">\n                                        <div class=\"loading-spinner\" style=\"margin: 0 auto 15px auto;\"></div>\n                                        <p>Carregando listas...</p>\n                                    </td>\n                                </tr>\n                            </tbody>\n                        </table>\n                    </div>\n                </div>\n            </div>\n        </div>\n    </div>\n\n    <!-- Modal para criar nova lista -->\n    <div class=\"modal\" id=\"createListModal\">\n        <div class=\"modal-content\">\n            <div class=\"modal-header\">\n                <h3 class=\"modal-title\">📋 Nova Lista</h3>\n                <button class=\"modal-close\" id=\"closeModal\">&times;</button>\n            </div>\n            <form id=\"createListForm\">\n                <div class=\"form-group\">\n                    <label for=\"listName\">Nome da Lista *</label>\n                    <input \n                        type=\"text\" \n                        id=\"listName\" \n                        name=\"listName\" \n                        placeholder=\"Ex: Clientes VIP, Grupos Marketing, etc.\" \n                        required\n                    >\n                </div>\n                <div class=\"form-group\">\n                    <label for=\"listType\">Tipo de Lista *</label>\n                    <div class=\"custom-dropdown\" id=\"listTypeDropdown\">\n                        <div class=\"dropdown-header\" onclick=\"toggleDropdown('listTypeDropdown')\">\n                            <span class=\"dropdown-selected\" id=\"listTypeSelected\">Selecione o tipo</span>\n                            <svg class=\"dropdown-arrow\" width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\n                                <path d=\"M7 10l5 5 5-5z\"/>\n                            </svg>\n                        </div>\n                        <div class=\"dropdown-options\" id=\"listTypeOptions\">\n                            <div class=\"dropdown-option\" data-value=\"contacts\" onclick=\"selectDropdownOption('listTypeDropdown', 'contacts', 'Contatos')\">\n                                <span>👥 Contatos</span>\n                            </div>\n                            <div class=\"dropdown-option\" data-value=\"groups\" onclick=\"selectDropdownOption('listTypeDropdown', 'groups', 'Grupos')\">\n                                <span>👥 Grupos</span>\n                            </div>\n                        </div>\n                        <input type=\"hidden\" id=\"listType\" name=\"listType\" required>\n                    </div>\n                </div>\n                <div class=\"form-group\">\n                    <label for=\"listDescription\">Descrição (opcional)</label>\n                    <input \n                        type=\"text\" \n                        id=\"listDescription\" \n                        name=\"listDescription\" \n                        placeholder=\"Descreva o objetivo desta lista...\"\n                    >\n                </div>\n                <button type=\"submit\" class=\"btn btn-primary\" style=\"width: 100%;\">\n                    <div class=\"loading-spinner\"></div>\n                    <span>\n                        <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"currentColor\" style=\"margin-right: 8px;\">\n                            <path d=\"M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z\"/>\n                        </svg>\n                        Criar Lista\n                    </span>\n                </button>\n            </form>\n        </div>\n    </div>\n\n    <script>\n        // Elementos do DOM\n        const listsTableBody = document.getElementById('listsTableBody');\n        const listsMessage = document.getElementById('listsMessage');\n        const refreshBtn = document.getElementById('refreshBtn');\n        \n        // Filtros\n        const typeFilter = document.getElementById('typeFilter');\n        const dateFilter = document.getElementById('dateFilter');\n        const searchFilter = document.getElementById('searchFilter');\n        \n        // Modal criar lista\n        const createListModal = document.getElementById('createListModal');\n        const createListBtn = document.getElementById('createListBtn');\n        const closeModal = document.getElementById('closeModal');\n        const createListForm = document.getElementById('createListForm');\n        const listNameInput = document.getElementById('listName');\n        const listTypeInput = document.getElementById('listType');\n        const listDescriptionInput = document.getElementById('listDescription');\n\n        // Funções do dropdown personalizado\n        function toggleDropdown(dropdownId) {\n            const dropdown = document.getElementById(dropdownId);\n            const header = dropdown.querySelector('.dropdown-header');\n            const options = dropdown.querySelector('.dropdown-options');\n            \n            // Fecha todos os outros dropdowns\n            document.querySelectorAll('.dropdown-options').forEach(opt => {\n                if (opt !== options) {\n                    opt.classList.remove('show');\n                    opt.closest('.custom-dropdown').querySelector('.dropdown-header').classList.remove('active');\n                }\n            });\n            \n            // Toggle do dropdown atual\n            const isOpen = options.classList.contains('show');\n            if (isOpen) {\n                options.classList.remove('show');\n                header.classList.remove('active');\n            } else {\n                options.classList.add('show');\n                header.classList.add('active');\n            }\n        }\n\n        function selectDropdownOption(dropdownId, value, text) {\n            const dropdown = document.getElementById(dropdownId);\n            const header = dropdown.querySelector('.dropdown-header');\n            const options = dropdown.querySelector('.dropdown-options');\n            const selectedSpan = dropdown.querySelector('.dropdown-selected');\n            const hiddenInput = dropdown.querySelector('input[type=\"hidden\"]');\n            \n            // Atualiza o texto selecionado\n            selectedSpan.textContent = text;\n            \n            // Atualiza o input hidden\n            hiddenInput.value = value;\n            \n            // Remove seleção anterior\n            options.querySelectorAll('.dropdown-option').forEach(option => {\n                option.classList.remove('selected');\n            });\n            \n            // Adiciona seleção ao item clicado\n            const selectedOption = options.querySelector(`[data-value=\"${value}\"]`);\n            if (selectedOption) {\n                selectedOption.classList.add('selected');\n            }\n            \n            // Fecha o dropdown\n            options.classList.remove('show');\n            header.classList.remove('active');\n            \n            // Dispara evento de change para validação\n            hiddenInput.dispatchEvent(new Event('change'));\n        }\n\n        // Fecha dropdowns ao clicar fora\n        document.addEventListener('click', function(event) {\n            if (!event.target.closest('.custom-dropdown')) {\n                document.querySelectorAll('.dropdown-options').forEach(options => {\n                    options.classList.remove('show');\n                    options.closest('.custom-dropdown').querySelector('.dropdown-header').classList.remove('active');\n                });\n            }\n        });\n\n        // Dados das listas\n        let lists = [];\n        let filteredLists = [];\n        let currentPage = 1;\n        const pageSize = 20;\n\n        // Funções de mensagens\n        function showMessage(element, message, type = 'info') {\n            element.textContent = message;\n            element.className = `message ${type} show`;\n            setTimeout(() => {\n                element.classList.remove('show');\n            }, 8000); // Aumentado para 8 segundos\n        }\n\n        function setButtonLoading(button, loading) {\n            const spinner = button.querySelector('.loading-spinner');\n            const span = button.querySelector('span');\n            \n            if (loading) {\n                button.classList.add('loading');\n                button.disabled = true;\n                if (spinner) spinner.style.display = 'block';\n            } else {\n                button.classList.remove('loading');\n                button.disabled = false;\n                if (spinner) spinner.style.display = 'none';\n            }\n        }\n\n        // Função para ler cookies\n        function getCookie(name) {\n            const value = `; ${document.cookie}`;\n            const parts = value.split(`; ${name}=`);\n            if (parts.length === 2) return parts.pop().split(';').shift();\n            return null;\n        }\n\n        // Função para obter userId de forma segura via cookies\n        function getSecureUserId() {\n            const userId = getCookie('userId');\n            if (userId && /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(userId)) {\n                console.log('✅ UserId (UUID) obtido dos cookies:', userId);\n                return userId;\n            }\n            console.error('❌ UserId (UUID) não encontrado ou formato inválido nos cookies!');\n            return null;\n        }\n\n        // Autenticação obrigatória ao carregar a página\n        function checkAuth() {\n            const userId = getSecureUserId();\n            if (!userId) {\n                console.error('❌ Usuário não autenticado, redirecionando para login');\n                window.location.href = 'https://n8n.typebot.pro/webhook/login';\n                return false;\n            }\n            console.log('✅ Usuário autenticado:', userId);\n            return true;\n        }\n\n        // Navegação simplificada (sem parâmetros de autenticação)\n        function navigateToPage(url) {\n            window.location.href = url;\n        }\n\n        // Redirecionar para lista de contatos ou grupos ao clicar no nome\n        function goToListaContatos(idLista) {\n            const userId = getSecureUserId();\n            if (!userId) {\n                window.location.href = 'https://n8n.typebot.pro/webhook/login';\n                return;\n            }\n            // Buscar a lista pelo id para saber o tipo\n            const list = lists.find(l => l.id === idLista);\n            if (!list) {\n                window.location.href = 'https://n8n.typebot.pro/webhook/listas';\n                return;\n            }\n            // Definir cookies para a lista\n            document.cookie = `userId=${userId}; path=/`;\n            document.cookie = `idLista=${idLista}; path=/`;\n            \n            if (list.type === 'groups') {\n                window.location.href = 'https://n8n.typebot.pro/webhook/listas-grupos';\n            } else {\n                window.location.href = 'https://n8n.typebot.pro/webhook/listas-contatos';\n            }\n        }\n\n        // Renderizar tabela de listas\n        function renderListsTable() {\n            const total = filteredLists.length;\n            const totalPages = Math.ceil(total / pageSize) || 1;\n            if (currentPage > totalPages) currentPage = totalPages;\n            if (currentPage < 1) currentPage = 1;\n            const start = (currentPage - 1) * pageSize;\n            const end = start + pageSize;\n            const pageLists = filteredLists.slice(start, end);\n\n            if (total === 0) {\n                listsTableBody.innerHTML = `\n                    <tr>\n                        <td colspan=\"5\" style=\"text-align: center; color: #888; padding: 40px 20px;\">\n                            <div style=\"margin-bottom: 15px; font-size: 3rem;\">📋</div>\n                            <p style=\"font-size: 1.1rem; margin-bottom: 8px;\">Você não tem nenhuma lista</p>\n                            <p style=\"font-size: 0.9rem; color: #aaa;\">Clique no botão \"Criar Lista\" acima para criar sua primeira lista.</p>\n                        </td>\n                    </tr>\n                `;\n            } else {\n                listsTableBody.innerHTML = pageLists.map(list => `\n                    <tr class=\"list-row\" onclick=\"goToListaContatos(${list.id})\" style=\"cursor: pointer;\">\n                        <td>\n                            <div class=\"list-name\">${list.name}</div>\n                            <div style=\"color: #888; font-size: 0.8rem; margin-top: 4px;\">${list.description}</div>\n                        </td>\n                        <td>\n                            <span class=\"list-type ${list.type}\">\n                                ${list.type === 'contacts' ? 'Contatos' : 'Grupos'}\n                            </span>\n                        </td>\n                        <td class=\"list-date\">${formatDate(list.created)}</td>\n                        <td>\n                            <div class=\"list-actions\" onclick=\"event.stopPropagation();\">\n                                <button class=\"action-btn\" onclick=\"goToDisparo(${list.id}, '${list.type}')\" title=\"Disparar\">\n                                    <svg width=\"18\" height=\"18\" viewBox=\"0 0 32 32\" fill=\"currentColor\" style=\"vertical-align:middle;\"><path d=\"M16 3C9.373 3 4 8.373 4 15c0 2.637.86 5.08 2.48 7.13L4 29l7.13-2.48A11.94 11.94 0 0 0 16 27c6.627 0 12-5.373 12-12S22.627 3 16 3zm0 22c-1.98 0-3.89-.58-5.51-1.67l-.39-.25-4.23 1.47 1.47-4.23-.25-.39A9.94 9.94 0 0 1 6 15c0-5.514 4.486-10 10-10s10 4.486 10 10-4.486 10-10 10zm5.07-7.75c-.28-.14-1.65-.81-1.9-.9-.26-.1-.45-.14-.64.14-.19.28-.74.9-.91 1.08-.17.19-.34.21-.62.07-.28-.14-1.18-.44-2.25-1.41-.83-.74-1.39-1.65-1.55-1.93-.16-.28-.02-.43.12-.57.13-.13.28-.34.42-.51.14-.17.19-.28.28-.47.09-.19.05-.36-.02-.5-.07-.14-.64-1.54-.88-2.11-.23-.56-.47-.48-.64-.49-.16-.01-.36-.01-.56-.01-.19 0-.5.07-.76.36-.26.28-1 1-.99 2.43.01 1.43 1.03 2.81 1.18 3.01.15.2 2.03 3.1 4.93 4.23.69.28 1.23.45 1.65.58.69.22 1.32.19 1.81.12.55-.08 1.65-.67 1.89-1.32.23-.65.23-1.2.16-1.32-.07-.12-.25-.19-.53-.33z\"/></svg>\n                                </button>\n                                <button class=\"action-btn delete\" onclick=\"deleteList(${list.id})\" title=\"Excluir\">\n                                    <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"currentColor\"><path d=\"M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z\"/></svg>\n                                </button>\n                            </div>\n                        </td>\n                    </tr>\n                `).join('');\n            }\n\n            // Paginação\n            renderPagination(totalPages);\n        }\n\n        function renderPagination(totalPages) {\n            let paginationHtml = '';\n            if (totalPages > 1) {\n                paginationHtml += `<tr><td colspan=\"5\" style=\"text-align:center; padding: 20px 0;\">\n                    <div class=\"pagination-controls\">\n                        <button class=\"btn\" onclick=\"goToPage(${currentPage - 1})\" ${currentPage === 1 ? 'disabled' : ''}>Anterior</button>\n                        <span style=\"margin: 0 12px;\">Página ${currentPage} de ${totalPages}</span>\n                        <button class=\"btn\" onclick=\"goToPage(${currentPage + 1})\" ${currentPage === totalPages ? 'disabled' : ''}>Próxima</button>\n                    </div>\n                </td></tr>`;\n            }\n            // Adiciona a paginação ao final da tabela\n            listsTableBody.innerHTML += paginationHtml;\n        }\n\n        window.goToPage = function(page) {\n            const totalPages = Math.ceil(filteredLists.length / pageSize) || 1;\n            if (page < 1 || page > totalPages) return;\n            currentPage = page;\n            renderListsTable();\n        }\n\n        // Aplicar filtros\n        function applyFilters() {\n            let filtered = [...lists];\n            \n            // Filtro por tipo\n            const typeValue = typeFilter.value;\n            if (typeValue) {\n                filtered = filtered.filter(list => list.type === typeValue);\n            }\n            \n            // Filtro por data\n            const dateValue = dateFilter.value;\n            if (dateValue) {\n                const today = new Date();\n                const todayStr = today.toISOString().split('T')[0];\n                \n                filtered = filtered.filter(list => {\n                    const listDate = new Date(list.created);\n                    \n                    switch (dateValue) {\n                        case 'today':\n                            return list.created === todayStr;\n                        case 'week':\n                            const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);\n                            return listDate >= weekAgo;\n                        case 'month':\n                            const monthAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);\n                            return listDate >= monthAgo;\n                        case 'year':\n                            const yearAgo = new Date(today.getTime() - 365 * 24 * 60 * 60 * 1000);\n                            return listDate >= yearAgo;\n                        default:\n                            return true;\n                    }\n                });\n            }\n            \n            // Filtro por busca\n            const searchValue = searchFilter.value.toLowerCase();\n            if (searchValue) {\n                filtered = filtered.filter(list => \n                    list.name.toLowerCase().includes(searchValue) ||\n                    list.description.toLowerCase().includes(searchValue)\n                );\n            }\n            \n            filteredLists = filtered;\n            currentPage = 1;\n            renderListsTable();\n        }\n\n        // Carregar listas\n        async function loadLists() {\n            console.log('📋 Iniciando carregamento das listas...');\n            \n            // Mostrar loading\n            document.getElementById('loadingContainer').style.display = 'flex';\n            document.getElementById('mainContent').style.display = 'none';\n            setButtonLoading(refreshBtn, true);\n            \n            try {\n                const userId = getSecureUserId();\n                if (!userId) {\n                    throw new Error('ID do usuário não encontrado');\n                }\n                \n                console.log('🔍 Buscando listas para o usuário:', userId);\n                \n                const response = await fetch('https://n8n.typebot.pro/webhook/puxar-lista', {\n                    method: 'POST',\n                    headers: {\n                        'Content-Type': 'application/json',\n                    },\n                    body: JSON.stringify({ userId: userId })\n                });\n                \n                if (!response.ok) {\n                    const errorText = await response.text();\n                    throw new Error(`Erro ao carregar listas: ${response.status} - ${errorText}`);\n                }\n                \n                const responseData = await response.json();\n                console.log('📊 Resposta da API:', responseData);\n                \n                // Verificar se a resposta tem a estrutura esperada\n                if (responseData && responseData.data && Array.isArray(responseData.data)) {\n                    lists = responseData.data.map(list => ({\n                        id: list.id,\n                        name: list.nome,\n                        type: list.tipo,\n                        size: 0,\n                        created: list.created_at ? list.created_at.split('T')[0] : new Date().toISOString().split('T')[0],\n                        description: list.descricao || ''\n                    }));\n                } else if (responseData && Array.isArray(responseData)) {\n                    let allLists = [];\n                    responseData.forEach(item => {\n                        if (item.data && Array.isArray(item.data)) {\n                            const processedLists = item.data.map(list => ({\n                                id: list.id,\n                                name: list.nome,\n                                type: list.tipo,\n                                size: 0,\n                                created: list.created_at ? list.created_at.split('T')[0] : new Date().toISOString().split('T')[0],\n                                description: list.descricao || ''\n                            }));\n                            allLists = allLists.concat(processedLists);\n                        }\n                    });\n                    lists = allLists;\n                } else {\n                    lists = [];\n                }\n                \n                filteredLists = [...lists];\n                renderListsTable();\n                \n                console.log(`✅ ${lists.length} lista(s) processada(s) com sucesso`);\n                \n                if (lists.length === 0) {\n                    showMessage(listsMessage, '📭 Você não tem nenhuma lista', 'info');\n                } else {\n                    showMessage(listsMessage, `✅ ${lists.length} lista(s) carregada(s) com sucesso!`, 'success');\n                }\n            } catch (error) {\n                console.error('❌ Erro ao carregar listas:', error);\n                \n                // Verifica se é o erro específico de \"No item to return got found\"\n                if (error.message && error.message.includes('No item to return got found')) {\n                    console.log('📭 Resposta vazia - usuário não possui listas');\n                    lists = [];\n                    filteredLists = [];\n                    renderListsTable();\n                    showMessage(listsMessage, '📭 Você não tem nenhuma lista', 'info');\n                } else {\n                    showMessage(listsMessage, `❌ ${error.message}`, 'error');\n                    lists = [];\n                    filteredLists = [];\n                    renderListsTable();\n                }\n            } finally {\n                // Esconder loading\n                document.getElementById('loadingContainer').style.display = 'none';\n                document.getElementById('mainContent').style.display = 'flex';\n                setButtonLoading(refreshBtn, false);\n            }\n        }\n\n        // Funções utilitárias\n        function formatDate(dateString) {\n            const date = new Date(dateString);\n            return date.toLocaleDateString('pt-BR');\n        }\n\n        // Event Listeners\n\n        // Funções de ação das listas\n        window.editList = function(id) {\n            const list = lists.find(l => l.id === id);\n            if (list) {\n                showMessage(listsMessage, `✏️ Editando lista: ${list.name}`, 'info');\n                // Aqui você implementaria a edição\n            }\n            renderListsTable();\n        };\n\n        window.exportList = function(id) {\n            const list = lists.find(l => l.id === id);\n            if (list) {\n                showMessage(listsMessage, `📤 Exportando lista: ${list.name}`, 'info');\n                // Aqui você implementaria a exportação\n            }\n        };\n\n        window.deleteList = async function(id) {\n            const list = lists.find(l => l.id === id);\n            if (!list) {\n                showMessage(listsMessage, '❌ Lista não encontrada!', 'error');\n                return;\n            }\n            \n            if (!confirm(`Tem certeza que deseja excluir a lista \"${list.name}\"?\\n\\n⚠️ Esta ação não pode ser desfeita!`)) {\n                return;\n            }\n            \n            console.log('🗑️ Excluindo lista:', list);\n            \n            // Encontrar o botão de exclusão para mostrar loading\n            const deleteButton = document.querySelector(`button[onclick=\"deleteList(${id})\"]`);\n            const originalText = deleteButton ? deleteButton.innerHTML : '🗑️';\n            \n            if (deleteButton) {\n                deleteButton.innerHTML = '⏳';\n                deleteButton.disabled = true;\n            }\n            \n            try {\n                const response = await fetch('https://n8n.typebot.pro/webhook/excluir-lista', {\n                    method: 'POST',\n                    headers: {\n                        'Content-Type': 'application/json',\n                    },\n                    body: JSON.stringify({ idLista: id })\n                });\n\n                if (response.ok) {\n                    console.log('✅ Lista excluída com sucesso:', list.name);\n                    \n                    // Remove a lista do array local\n                    lists = lists.filter(l => l.id !== id);\n                    filteredLists = [...lists];\n                    currentPage = 1;\n                    renderListsTable();\n                    showMessage(listsMessage, `🗑️ Lista \"${list.name}\" excluída com sucesso!`, 'success');\n                } else {\n                    // Tratar erro específico\n                    const errorText = await response.text();\n                    console.error('❌ Erro ao excluir lista:', response.status, errorText);\n                    \n                    // Sempre mostrar a mensagem específica, independente do status\n                    showMessage(listsMessage, '⚠️ Não é possível excluir uma lista que tenha um disparo', 'warning');\n                }\n                \n            } catch (error) {\n                console.error('❌ Erro ao excluir lista:', error);\n                showMessage(listsMessage, '⚠️ Não é possível excluir uma lista que tenha um disparo', 'warning');\n            } finally {\n                // Restaurar o botão\n                if (deleteButton) {\n                    deleteButton.innerHTML = originalText;\n                    deleteButton.disabled = false;\n                }\n            }\n        };\n\n        // Event listeners para filtros\n        typeFilter.addEventListener('change', applyFilters);\n        dateFilter.addEventListener('change', applyFilters);\n        searchFilter.addEventListener('input', applyFilters);\n\n        // Inicialização\n        document.addEventListener('DOMContentLoaded', () => {\n            console.log('🚀 Iniciando carregamento da página de Listas...');\n            \n            if (!checkAuth()) {\n                return; // checkAuth já redireciona se necessário\n            }\n            \n            loadLists();\n            console.log('✅ Tela de Listas carregada com sucesso');\n        });\n\n\n\n        function openCreateModal() {\n            createListModal.classList.add('show');\n            setTimeout(() => listNameInput.focus(), 100);\n        }\n        function closeCreateModal() {\n            createListModal.classList.remove('show');\n            createListForm.reset();\n            \n            // Reset do dropdown personalizado\n            const dropdown = document.getElementById('listTypeDropdown');\n            if (dropdown) {\n                const selectedSpan = dropdown.querySelector('.dropdown-selected');\n                const hiddenInput = dropdown.querySelector('input[type=\"hidden\"]');\n                const options = dropdown.querySelector('.dropdown-options');\n                const header = dropdown.querySelector('.dropdown-header');\n                \n                selectedSpan.textContent = 'Selecione o tipo';\n                hiddenInput.value = '';\n                options.classList.remove('show');\n                header.classList.remove('active');\n                \n                // Remove seleção das opções\n                options.querySelectorAll('.dropdown-option').forEach(option => {\n                    option.classList.remove('selected');\n                });\n            }\n        }\n        closeModal.addEventListener('click', closeCreateModal);\n        createListModal.addEventListener('click', (e) => {\n            if (e.target === createListModal) closeCreateModal();\n        });\n        createListForm.addEventListener('submit', async (e) => {\n            e.preventDefault();\n            const name = listNameInput.value.trim();\n            const type = listTypeInput.value;\n            const description = listDescriptionInput.value.trim();\n            \n            if (!name || !type) {\n                showMessage(listsMessage, '❌ Por favor, preencha todos os campos obrigatórios!', 'error');\n                return;\n            }\n            \n            console.log('📝 Criando nova lista:', { name, type, description });\n            setButtonLoading(createListForm.querySelector('button'), true);\n            \n            try {\n                const userId = getSecureUserId();\n                if (!userId) {\n                    throw new Error('Usuário não autenticado');\n                }\n                \n                const requestBody = {\n                    nome: name,\n                    tipo: type,\n                    descricao: description || '',\n                    userId: userId\n                };\n                \n                console.log('📤 Enviando requisição para criar lista:', requestBody);\n                \n                const response = await fetch('https://n8n.typebot.pro/webhook/criar-lista', {\n                    method: 'POST',\n                    headers: {\n                        'Content-Type': 'application/json',\n                    },\n                    body: JSON.stringify(requestBody)\n                });\n                \n                if (!response.ok) {\n                    const errorText = await response.text();\n                    throw new Error(`Erro ao criar lista: ${response.status} - ${errorText}`);\n                }\n                \n                const responseData = await response.json();\n                console.log('✅ Lista criada com sucesso:', responseData);\n                \n                const newList = {\n                    id: responseData.id || Date.now(),\n                    name,\n                    type,\n                    size: 0,\n                    created: new Date().toISOString().split('T')[0],\n                    description\n                };\n                \n                lists.unshift(newList);\n                filteredLists = [...lists];\n                renderListsTable();\n                showMessage(listsMessage, `✅ Lista \"${name}\" criada com sucesso!`, 'success');\n                closeCreateModal();\n                \n            } catch (error) {\n                console.error('❌ Erro ao criar lista:', error);\n                showMessage(listsMessage, `❌ ${error.message}`, 'error');\n            } finally {\n                setButtonLoading(createListForm.querySelector('button'), false);\n            }\n        });\n\n        window.goToDisparo = function(idLista, listType) {\n            const userId = getSecureUserId();\n            if (!userId) {\n                window.location.href = 'https://n8n.typebot.pro/webhook/login';\n                return;\n            }\n            // Definir cookies para o disparo\n            document.cookie = `userId=${userId}; path=/`;\n            document.cookie = `idLista=${idLista}; path=/`;\n            \n            // Direcionar para a página correta baseado no tipo da lista\n            if (listType === 'groups') {\n                window.location.href = 'https://n8n.typebot.pro/webhook/disparos-grupos';\n            } else {\n                window.location.href = 'https://n8n.typebot.pro/webhook/disparos-individuais';\n            }\n        }\n\n        // Função de logout\n        function logout() {\n            console.log('🚪 Iniciando logout...');\n            \n            // Limpar todos os cookies\n            document.cookie = 'userId=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';\n            document.cookie = 'idLista=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';\n            document.cookie = 'idConexao=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';\n            document.cookie = 'idDisparo=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';\n            \n            // Limpar sessionStorage\n            sessionStorage.clear();\n            \n            console.log('🧹 Cookies e sessionStorage limpos');\n            console.log('🔄 Redirecionando para login...');\n            \n            // Redirecionar para página de login\n            window.location.href = 'https://n8n.typebot.pro/webhook/login';\n        }\n    </script>\n</body>\n</html>"},"type":"n8n-nodes-base.html","typeVersion":1.2,"position":[-4240,-5248],"id":"47f606fb-0860-4ca7-9126-9d218d0aa572","name":"HTML8"},{"parameters":{"respondWith":"text","responseBody":"={{ $json.html }}","options":{}},"type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-4016,-5248],"id":"f951222e-726c-430a-b7fc-7545a42e5dcc","name":"Respond to Webhook7"},{"parameters":{"path":"listas","responseMode":"responseNode","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-4448,-5248],"id":"c89b270e-6321-41ab-a319-d9737b90e639","name":"LISTAS","webhookId":"44ef5672-bb5e-47cb-8c16-50d5ffb78a8c"},{"parameters":{"content":"## Tela Listas-Contatos","height":260,"width":760,"color":2},"type":"n8n-nodes-base.stickyNote","position":[-4512,-5056],"typeVersion":1,"id":"47bee860-0cc5-43c4-a39b-949a313c6a4f","name":"Sticky Note21"},{"parameters":{"html":"<!DOCTYPE html>\n<html lang=\"pt-BR\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>Lista de Contatos - EnviaZap</title>\n    <style>\n        * {\n            margin: 0;\n            padding: 0;\n            box-sizing: border-box;\n        }\n\n        body {\n            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);\n            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n            color: white;\n            min-height: 100vh;\n            margin: 0;\n            padding: 0;\n        }\n\n        .app-layout {\n            display: flex;\n            min-height: 100vh;\n        }\n\n        /* Sidebar */\n        .sidebar {\n            width: 70px;\n            background: rgba(0, 0, 0, 0.3);\n            backdrop-filter: blur(10px);\n            border-right: 1px solid rgba(255, 255, 255, 0.1);\n            transition: all 0.3s ease;\n            position: relative;\n            z-index: 1000;\n            display: flex;\n            flex-direction: column;\n            height: 100vh;\n            overflow: hidden;\n        }\n\n        /* Hover controlado via JavaScript */\n        /* .sidebar:hover {\n            width: 250px;\n        } */\n\n        .sidebar-header {\n            padding: 20px;\n            text-align: center;\n            border-bottom: 1px solid rgba(255, 255, 255, 0.1);\n        }\n\n        .sidebar-logo {\n            font-size: 1.5rem;\n            font-weight: 600;\n            background: linear-gradient(135deg, #25d366 0%, #128c7e 100%);\n            -webkit-background-clip: text;\n            -webkit-text-fill-color: transparent;\n            background-clip: text;\n            white-space: nowrap;\n            opacity: 0;\n            transition: opacity 0.3s ease;\n        }\n\n        /* Controlado via JavaScript */\n        /* .sidebar:hover .sidebar-logo {\n            opacity: 1;\n        } */\n\n        .sidebar-menu {\n            padding: 20px 0;\n            flex: 1;\n        }\n\n        .menu-item {\n            display: flex;\n            align-items: center;\n            padding: 15px 20px;\n            color: #ccc;\n            text-decoration: none;\n            transition: all 0.3s ease;\n            position: relative;\n            white-space: nowrap;\n        }\n\n        .menu-item:hover {\n            background: rgba(37, 211, 102, 0.1);\n            color: #25d366;\n        }\n\n        .menu-item.active {\n            background: rgba(37, 211, 102, 0.2);\n            color: #25d366;\n            border-right: 3px solid #25d366;\n        }\n\n        .menu-icon {\n            font-size: 1.2rem;\n            width: 30px;\n            text-align: center;\n            flex-shrink: 0;\n        }\n\n        .menu-text {\n            margin-left: 15px;\n            opacity: 0;\n            transition: opacity 0.3s ease;\n        }\n\n        /* Controlado via JavaScript */\n        /* .sidebar:hover .menu-text {\n            opacity: 1;\n        } */\n\n        .sidebar-footer {\n            margin-top: auto;\n            border-top: 1px solid rgba(255, 255, 255, 0.1);\n            padding: 10px 0;\n        }\n\n        .logout-item {\n            color: #ff6b6b !important;\n        }\n\n        .logout-item:hover {\n            background: rgba(255, 107, 107, 0.1) !important;\n            color: #ff6b6b !important;\n        }\n\n        /* Main content */\n        .main-content-wrapper {\n            flex: 1;\n            padding: 30px 0 30px 0;\n            overflow-x: auto;\n        }\n\n        .container {\n            width: 100%;\n            max-width: 100vw;\n            margin: 0;\n            padding: 0 30px;\n        }\n\n        .header {\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            margin-bottom: 40px;\n        }\n\n        .header-info {\n            display: flex;\n            flex-direction: column;\n            gap: 4px;\n        }\n\n        .header-info h1 {\n            font-size: 2.5rem;\n            font-weight: 600;\n            margin-bottom: 10px;\n            color: white;\n        }\n\n\n\n        .list-name-display {\n            color: white;\n            font-size: 2.2rem;\n            font-weight: 700;\n            background: linear-gradient(135deg, rgba(37,211,102,0.15) 0%, rgba(18,140,126,0.15) 100%);\n            border: 1px solid rgba(37,211,102,0.3);\n            border-radius: 12px;\n            padding: 12px 20px;\n            display: inline-block;\n            letter-spacing: 0.5px;\n            min-width: 200px;\n            transition: all 0.3s ease, opacity 0.3s ease, visibility 0.3s ease;\n            margin-top: 8px;\n        }\n\n        .list-name-display:hover {\n            border-color: rgba(37,211,102,0.5);\n            background: linear-gradient(135deg, rgba(37,211,102,0.2) 0%, rgba(18,140,126,0.2) 100%);\n        }\n\n        .header-info p {\n            color: #888;\n            font-size: 1.1rem;\n        }\n\n        /* Melhorar design dos botões */\n        .btn {\n            padding: 10px 16px;\n            background: linear-gradient(135deg, #25d366 0%, #128c7e 100%);\n            border: none;\n            border-radius: 10px;\n            color: white;\n            font-weight: 600;\n            cursor: pointer;\n            transition: all 0.3s ease;\n            display: flex;\n            align-items: center;\n            gap: 8px;\n            font-size: 0.9rem;\n            text-decoration: none;\n            box-shadow: 0 2px 8px rgba(37, 211, 102, 0.2);\n        }\n\n        .btn:hover {\n            transform: translateY(-2px);\n            box-shadow: 0 6px 20px rgba(37, 211, 102, 0.3);\n        }\n\n        .btn-danger:hover {\n            transform: translateY(-2px);\n            box-shadow: 0 6px 20px rgba(220, 38, 38, 0.4);\n        }\n\n        .btn-success {\n            background: linear-gradient(135deg, #10b981 0%, #059669 100%);\n            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.2);\n        }\n\n        .btn-success:hover {\n            transform: translateY(-2px);\n            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);\n        }\n\n        .btn-secondary {\n            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08) 0%, rgba(255, 255, 255, 0.12) 100%);\n            border: 1px solid rgba(255, 255, 255, 0.2);\n            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);\n        }\n\n        .btn-secondary:hover {\n            background: linear-gradient(135deg, rgba(255, 255, 255, 0.12) 0%, rgba(255, 255, 255, 0.16) 100%);\n            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);\n        }\n\n        .btn:disabled {\n            background: linear-gradient(135deg, #444 0%, #555 100%);\n            cursor: not-allowed;\n            transform: none;\n            box-shadow: none;\n        }\n\n        .btn-icon {\n            width: 16px;\n            height: 16px;\n            fill: currentColor;\n            flex-shrink: 0;\n        }\n\n        /* Ícones para seções */\n        .section-icon svg {\n            width: 20px;\n            height: 20px;\n            fill: #25d366;\n        }\n\n        .main-content {\n            display: flex;\n            flex-direction: column;\n            gap: 30px;\n        }\n        \n        /* Garantir que a paginação não seja afetada pela tabela */\n        .section:has(.contacts-table-container) {\n            position: relative;\n            overflow: visible;\n        }\n\n        .section {\n            background: rgba(255, 255, 255, 0.02);\n            border: 1px solid rgba(255, 255, 255, 0.1);\n            border-radius: 16px;\n            padding: 40px;\n            backdrop-filter: blur(10px);\n            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);\n            overflow: visible;\n        }\n\n        .section-header {\n            display: flex;\n            align-items: center;\n            gap: 12px;\n            margin-bottom: 25px;\n            padding-bottom: 15px;\n            border-bottom: 1px solid rgba(255, 255, 255, 0.1);\n        }\n\n        .section-icon {\n            font-size: 1.5rem;\n        }\n\n        .section-title {\n            font-size: 1.4rem;\n            font-weight: 600;\n            color: #25d366;\n        }\n\n        .section-subtitle {\n            color: #888;\n            font-size: 0.9rem;\n            margin-bottom: 20px;\n            line-height: 1.4;\n        }\n\n        /* Header com ações */\n        .header-actions {\n            display: flex;\n            gap: 15px;\n            align-items: center;\n            flex-wrap: wrap;\n        }\n\n        .btn {\n            padding: 12px 20px;\n            background: linear-gradient(135deg, #25d366 0%, #128c7e 100%);\n            border: none;\n            border-radius: 8px;\n            color: white;\n            font-weight: 600;\n            cursor: pointer;\n            transition: all 0.3s ease;\n            display: flex;\n            align-items: center;\n            gap: 8px;\n            font-size: 0.9rem;\n            text-decoration: none;\n        }\n\n        .btn:hover {\n            transform: translateY(-2px);\n            box-shadow: 0 8px 25px rgba(37, 211, 102, 0.3);\n        }\n\n        .btn-secondary {\n            background: rgba(255, 255, 255, 0.05);\n            border: 1px solid rgba(255, 255, 255, 0.2);\n        }\n\n        .btn-secondary:hover {\n            background: rgba(255, 255, 255, 0.1);\n        }\n\n        .btn:disabled {\n            background: #444;\n            cursor: not-allowed;\n            transform: none;\n        }\n\n        /* Tabela de contatos */\n        .contacts-table-container {\n            background: rgba(255, 255, 255, 0.02);\n            border: 1px solid rgba(255, 255, 255, 0.1);\n            border-radius: 16px;\n            overflow: hidden;\n            backdrop-filter: blur(10px);\n            overflow-x: auto;\n            margin-bottom: 0;\n        }\n\n        .contacts-table {\n            width: 100%;\n            border-collapse: collapse;\n            table-layout: fixed;\n            min-width: 800px;\n        }\n\n        .contacts-table th {\n            background: rgba(255, 255, 255, 0.05);\n            padding: 15px 20px;\n            text-align: left;\n            font-weight: 600;\n            color: #25d366;\n            font-size: 0.9rem;\n            border-bottom: 1px solid rgba(255, 255, 255, 0.1);\n            white-space: nowrap;\n        }\n\n        .contacts-table td {\n            padding: 15px 20px;\n            border-bottom: 1px solid rgba(255, 255, 255, 0.05);\n            font-size: 0.9rem;\n            word-wrap: break-word;\n            overflow: hidden;\n            text-overflow: ellipsis;\n        }\n\n        .contacts-table tr:hover {\n            background: rgba(37, 211, 102, 0.05);\n        }\n\n        .contacts-table tr:last-child td {\n            border-bottom: none;\n        }\n\n        .contact-name {\n            font-weight: 600;\n            color: #fff;\n        }\n\n        .contact-phone {\n            color: #25d366;\n            font-family: monospace;\n        }\n\n        .contact-date {\n            color: #888;\n            font-size: 0.85rem;\n        }\n\n        .contact-actions {\n            display: flex;\n            gap: 8px;\n        }\n\n        .action-btn {\n            background: none;\n            border: none;\n            color: #888;\n            cursor: pointer;\n            padding: 6px;\n            border-radius: 4px;\n            transition: all 0.3s ease;\n            font-size: 0.9rem;\n        }\n\n        .action-btn:hover {\n            background: rgba(255, 255, 255, 0.1);\n            color: white;\n        }\n\n        .action-btn.edit:hover {\n            color: #25d366;\n        }\n\n        .action-btn.delete:hover {\n            color: #ff4444;\n        }\n\n        /* Loading state */\n        .loading-container {\n            display: flex;\n            flex-direction: column;\n            align-items: center;\n            justify-content: center;\n            min-height: 400px;\n            gap: 20px;\n        }\n\n        .loading-spinner {\n            width: 60px;\n            height: 60px;\n            border: 4px solid rgba(37, 211, 102, 0.3);\n            border-top: 4px solid #25d366;\n            border-radius: 50%;\n            animation: spin 1s linear infinite;\n        }\n\n        .loading-text {\n            color: #25d366;\n            font-size: 1.2rem;\n            font-weight: 500;\n        }\n\n        /* Mensagens */\n        .message {\n            padding: 15px;\n            border-radius: 8px;\n            margin-bottom: 15px;\n            font-size: 0.9rem;\n            display: none;\n        }\n\n        .message.show {\n            display: block;\n            animation: fadeIn 0.3s ease;\n        }\n\n        .message.success {\n            background: rgba(37, 211, 102, 0.1);\n            border: 1px solid rgba(37, 211, 102, 0.3);\n            color: #25d366;\n        }\n\n        .message.error {\n            background: rgba(255, 68, 68, 0.1);\n            border: 1px solid rgba(255, 68, 68, 0.3);\n            color: #ff4444;\n        }\n\n        .message.info {\n            background: rgba(255, 193, 7, 0.1);\n            border: 1px solid rgba(255, 193, 7, 0.3);\n            color: #ffc107;\n        }\n\n        /* Loading spinner */\n        .loading-spinner {\n            width: 20px;\n            height: 20px;\n            border: 2px solid rgba(255, 255, 255, 0.3);\n            border-top: 2px solid white;\n            border-radius: 50%;\n            animation: spin 1s linear infinite;\n            display: none;\n        }\n\n        .btn.loading .loading-spinner {\n            display: block;\n        }\n\n        @keyframes spin {\n            0% { transform: rotate(0deg); }\n            100% { transform: rotate(360deg); }\n        }\n\n        @keyframes fadeIn {\n            from {\n                opacity: 0;\n                transform: translateY(20px);\n            }\n            to {\n                opacity: 1;\n                transform: translateY(0);\n            }\n        }\n\n        /* Scrollbar customization */\n        .contacts-table-container::-webkit-scrollbar {\n            width: 6px;\n        }\n\n        .contacts-table-container::-webkit-scrollbar-track {\n            background: rgba(255, 255, 255, 0.05);\n            border-radius: 3px;\n        }\n\n        .contacts-table-container::-webkit-scrollbar-thumb {\n            background: rgba(37, 211, 102, 0.5);\n            border-radius: 3px;\n        }\n\n        .contacts-table-container::-webkit-scrollbar-thumb:hover {\n            background: rgba(37, 211, 102, 0.7);\n        }\n\n        /* Paginação */\n        #contactsPagination {\n            display: flex !important;\n            justify-content: center !important;\n            align-items: center !important;\n            gap: 8px !important;\n            margin: 20px auto 0 auto !important;\n            flex-wrap: wrap !important;\n            width: 100% !important;\n            max-width: 100% !important;\n            clear: both !important;\n            position: relative !important;\n            z-index: 1 !important;\n            background: transparent !important;\n            box-sizing: border-box !important;\n            padding: 0 !important;\n        }\n\n        #contactsPagination button {\n            margin: 0 !important;\n            flex-shrink: 0 !important;\n            position: relative !important;\n            z-index: 1 !important;\n            white-space: nowrap !important;\n        }\n\n        /* Responsive */\n        @media (max-width: 768px) {\n            .main-content {\n                gap: 20px;\n            }\n            \n            .header {\n                flex-direction: column;\n                align-items: stretch;\n                gap: 15px;\n            }\n\n            .header-info h1 {\n                font-size: 2rem;\n                margin-bottom: 8px;\n            }\n            \n            .header-actions {\n                gap: 8px;\n                width: 100%;\n                justify-content: flex-start;\n            }\n\n            .header-actions .btn {\n                font-size: 0.8rem;\n                padding: 8px 12px;\n            }\n\n            .list-name-display {\n                font-size: 1.6rem;\n                padding: 8px 14px;\n                min-width: 150px;\n                transition: all 0.3s ease, opacity 0.3s ease, visibility 0.3s ease;\n            }\n\n            .main-content-wrapper {\n                padding: 15px;\n            }\n            \n            .contacts-table {\n                font-size: 0.8rem;\n            }\n            \n            .contacts-table th,\n            .contacts-table td {\n                padding: 10px 12px;\n            }\n            \n            #contactsPagination {\n                gap: 4px !important;\n                margin: 15px auto 0 auto !important;\n            }\n            \n            #contactsPagination button {\n                padding: 4px 8px !important;\n                font-size: 0.75rem !important;\n                min-width: 28px !important;\n            }\n        }\n\n        /* Modal */\n        .modal {\n            display: none;\n            position: fixed;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n            background: rgba(0, 0, 0, 0.8);\n            z-index: 1000;\n            backdrop-filter: blur(5px);\n        }\n        .modal.show {\n            display: flex;\n            align-items: center;\n            justify-content: center;\n        }\n        .modal-content {\n            background: rgba(26, 26, 26, 0.95);\n            border: 1px solid rgba(255, 255, 255, 0.1);\n            border-radius: 16px;\n            padding: 30px;\n            max-width: 500px;\n            width: 90%;\n            max-height: 90vh;\n            overflow-y: auto;\n            backdrop-filter: blur(10px);\n            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);\n        }\n        \n        .modal-content.with-invalid-table {\n            max-width: 800px;\n            width: 95%;\n        }\n        .modal-header {\n            display: flex;\n            align-items: center;\n            justify-content: space-between;\n            margin-bottom: 20px;\n        }\n        .modal-title {\n            font-size: 1.3rem;\n            font-weight: 600;\n            color: #25d366;\n        }\n        .modal-close {\n            background: none;\n            border: none;\n            color: #888;\n            font-size: 1.5rem;\n            cursor: pointer;\n            padding: 5px;\n            border-radius: 4px;\n            transition: all 0.3s ease;\n        }\n        .modal-close:hover {\n            background: rgba(255, 255, 255, 0.1);\n            color: white;\n        }\n        .modal .form-group {\n            margin-bottom: 22px;\n        }\n        .modal .form-group label {\n            color: #fff;\n            font-weight: 500;\n            margin-bottom: 8px;\n            font-size: 0.95rem;\n            display: block;\n        }\n        .modal .form-group input,\n        .modal .form-group select {\n            width: 100%;\n            padding: 12px 15px;\n            background: rgba(255, 255, 255, 0.05);\n            border: 1px solid rgba(255, 255, 255, 0.2);\n            border-radius: 8px;\n            color: white;\n            font-size: 1rem;\n            outline: none;\n            transition: all 0.3s ease;\n        }\n        .modal .form-group input:focus,\n        .modal .form-group select:focus {\n            border-color: #25d366;\n            box-shadow: 0 0 0 2px rgba(37, 211, 102, 0.2);\n        }\n        .modal .form-group input::placeholder {\n            color: #888;\n        }\n\n        /* Variáveis */\n        .variables-container {\n            display: flex;\n            flex-wrap: wrap;\n            gap: 10px;\n            margin-bottom: 20px;\n        }\n\n        .variable-tag {\n            background: rgba(37, 211, 102, 0.1);\n            color: #25d366;\n            padding: 6px 12px;\n            border-radius: 20px;\n            font-size: 0.85rem;\n            border: 1px solid rgba(37, 211, 102, 0.3);\n            display: flex;\n            align-items: center;\n            gap: 8px;\n        }\n\n        .variable-remove {\n            background: none;\n            border: none;\n            color: #25d366;\n            cursor: pointer;\n            font-size: 0.8rem;\n            padding: 0;\n            width: 16px;\n            height: 16px;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            border-radius: 50%;\n        }\n\n        .variable-remove:hover {\n            background: rgba(255, 68, 68, 0.2);\n            color: #ff4444;\n        }\n\n        /* File upload */\n        .file-upload {\n            border: 2px dashed rgba(37, 211, 102, 0.3);\n            border-radius: 8px;\n            padding: 30px;\n            text-align: center;\n            transition: all 0.3s ease;\n            cursor: pointer;\n            position: relative;\n        }\n\n        .file-upload:hover {\n            border-color: #25d366;\n            background: rgba(37, 211, 102, 0.05);\n        }\n\n        .file-upload.has-file {\n            border-color: #25d366;\n            background: rgba(37, 211, 102, 0.1);\n        }\n\n        .file-upload input[type=\"file\"] {\n            display: none;\n        }\n\n        .file-upload-icon {\n            font-size: 2rem;\n            color: #25d366;\n            margin-bottom: 10px;\n        }\n\n        .file-upload.has-file .file-upload-icon {\n            color: #25d366;\n        }\n\n        .file-name {\n            color: #25d366;\n            font-weight: 600;\n            font-size: 1rem;\n            margin-top: 10px;\n            word-break: break-all;\n        }\n\n        .file-upload-text {\n            transition: all 0.3s ease;\n        }\n\n        .file-upload.has-file .file-upload-text {\n            display: none;\n        }\n\n        .download-example {\n            color: #25d366;\n            text-decoration: none;\n            font-size: 0.9rem;\n            margin-top: 15px;\n            display: inline-block;\n        }\n\n        .download-example:hover {\n            text-decoration: underline;\n        }\n\n        /* Modal WhatsApp */\n        .connection-dropdown {\n            width: 100%;\n            padding: 12px 15px;\n            background: rgba(255, 255, 255, 0.05);\n            border: 1px solid rgba(255, 255, 255, 0.2);\n            border-radius: 8px;\n            color: white;\n            font-size: 1rem;\n            outline: none;\n            transition: all 0.3s ease;\n            appearance: none;\n            background-image: url(\"data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e\");\n            background-position: right 12px center;\n            background-repeat: no-repeat;\n            background-size: 16px;\n            padding-right: 40px;\n        }\n\n        .connection-dropdown:focus {\n            border-color: #25d366;\n            box-shadow: 0 0 0 2px rgba(37, 211, 102, 0.2);\n        }\n\n        .connection-dropdown option { \n            background: rgba(26, 26, 26, 0.95); \n            color: white; \n            padding: 8px 12px; \n            border: none;\n        }\n        .connection-dropdown option[data-connected=\"1\"] {\n            color: #25d366 !important;\n            background: rgba(37, 211, 102, 0.1) !important;\n            font-weight: 600;\n        }\n        .connection-dropdown option[data-connected=\"0\"] {\n            color: #ff4444 !important;\n            background: rgba(255, 68, 68, 0.1) !important;\n            font-weight: 400;\n        }\n        .connection-dropdown option[data-connected=\"checking\"] {\n            color: #888 !important;\n            background: rgba(136, 136, 136, 0.1) !important;\n            font-weight: 400;\n        }\n\n        .connection-option {\n            background: #2a2a2a;\n            color: white;\n            padding: 8px;\n        }\n\n        .connection-status {\n            display: inline-block;\n            width: 8px;\n            height: 8px;\n            border-radius: 50%;\n            margin-right: 8px;\n        }\n\n        .connection-status.connected {\n            background-color: #22c55e;\n            box-shadow: 0 0 4px rgba(34, 197, 94, 0.5);\n        }\n\n        .connection-status.disconnected {\n            background-color: #ef4444;\n            box-shadow: 0 0 4px rgba(239, 68, 68, 0.5);\n        }\n\n        .whatsapp-loading {\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            padding: 20px;\n            color: #25d366;\n        }\n\n        .whatsapp-loading .loading-spinner {\n            width: 30px;\n            height: 30px;\n            margin-right: 10px;\n        }\n\n        /* Lista de contatos do WhatsApp */\n        .whatsapp-contacts-container {\n            margin-top: 20px;\n            display: none;\n        }\n\n        .whatsapp-contacts-list {\n            max-height: 300px;\n            overflow-y: auto;\n            border: 1px solid rgba(255, 255, 255, 0.1);\n            border-radius: 8px;\n            background: rgba(255, 255, 255, 0.02);\n        }\n\n        .whatsapp-contact-item {\n            display: flex;\n            align-items: center;\n            gap: 12px;\n            padding: 12px 15px;\n            border-bottom: 1px solid rgba(255, 255, 255, 0.05);\n            transition: background 0.2s ease;\n            position: relative;\n        }\n\n        .whatsapp-contact-item:last-child {\n            border-bottom: none;\n        }\n\n        .whatsapp-contact-item:hover {\n            background: rgba(37, 211, 102, 0.05);\n        }\n\n        .whatsapp-contact-item.duplicate {\n            background: rgba(255, 193, 7, 0.08);\n            border-left: 3px solid #ffc107;\n        }\n\n        .whatsapp-contact-item.duplicate:hover {\n            background: rgba(255, 193, 7, 0.12);\n        }\n\n        .whatsapp-contact-item.duplicate .whatsapp-contact-name {\n            color: #ffc107;\n        }\n\n        .whatsapp-contact-item.duplicate .whatsapp-contact-phone {\n            color: #e0a800;\n        }\n\n        .whatsapp-contact-checkbox {\n            width: 16px;\n            height: 16px;\n            margin: 0;\n        }\n\n        .whatsapp-contact-info {\n            flex: 1;\n        }\n\n        .whatsapp-contact-name {\n            font-weight: 600;\n            color: #fff;\n            margin-bottom: 2px;\n        }\n\n        .whatsapp-contact-phone {\n            font-size: 0.85rem;\n            color: #888;\n            font-family: monospace;\n        }\n\n        .whatsapp-contacts-header {\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            margin-bottom: 10px;\n            padding: 0 2px;\n        }\n\n        .whatsapp-contacts-count {\n            color: #25d366;\n            font-weight: 600;\n            font-size: 0.9rem;\n        }\n\n        .whatsapp-contacts-actions {\n            display: flex;\n            gap: 8px;\n        }\n\n        .btn-link {\n            background: none;\n            border: none;\n            color: #25d366;\n            font-size: 0.85rem;\n            cursor: pointer;\n            text-decoration: underline;\n            padding: 0;\n        }\n\n        .btn-link:hover {\n            color: #1da851;\n        }\n\n        .duplicate-badge {\n            position: absolute;\n            top: 8px;\n            right: 8px;\n            background: #ffc107;\n            color: #000;\n            font-size: 0.7rem;\n            padding: 2px 6px;\n            border-radius: 10px;\n            font-weight: 600;\n        }\n\n        /* Tabela de números inválidos */\n        .invalid-numbers-table {\n            background: rgba(255, 68, 68, 0.05);\n            border: 1px solid rgba(255, 68, 68, 0.3);\n            border-radius: 12px;\n            padding: 20px;\n            margin: 20px 0;\n        }\n\n        .invalid-numbers-header {\n            display: flex;\n            align-items: center;\n            gap: 10px;\n            margin-bottom: 15px;\n            color: #ff4444;\n            font-weight: 600;\n        }\n\n        .invalid-numbers-table table {\n            width: 100%;\n            border-collapse: collapse;\n            font-size: 0.9rem;\n        }\n\n        .invalid-numbers-table th {\n            background: rgba(255, 68, 68, 0.1);\n            padding: 12px;\n            text-align: left;\n            color: #ff4444;\n            font-weight: 600;\n            border-bottom: 1px solid rgba(255, 68, 68, 0.2);\n        }\n\n        .invalid-numbers-table td {\n            padding: 12px;\n            border-bottom: 1px solid rgba(255, 68, 68, 0.1);\n            vertical-align: middle;\n        }\n\n        .invalid-numbers-table tr:hover {\n            background: rgba(255, 68, 68, 0.05);\n        }\n\n        .invalid-number-row {\n            background: rgba(255, 68, 68, 0.02);\n        }\n\n        .fixable-number-row {\n            background: rgba(255, 193, 7, 0.05);\n        }\n\n        .fixable-number-row:hover {\n            background: rgba(255, 193, 7, 0.08);\n        }\n\n        .whatsapp-invalid-number-row {\n            background: rgba(255, 68, 68, 0.03);\n            border-left: 3px solid #ff4444;\n        }\n\n        .whatsapp-invalid-number-row:hover {\n            background: rgba(255, 68, 68, 0.06);\n        }\n\n        .number-original {\n            font-family: monospace;\n            color: #ff4444;\n            font-weight: 500;\n        }\n\n        .number-corrected {\n            font-family: monospace;\n            color: #ffc107;\n            font-weight: 600;\n        }\n\n        .number-status {\n            display: flex;\n            align-items: center;\n            gap: 8px;\n        }\n\n        .status-icon {\n            width: 16px;\n            height: 16px;\n        }\n\n        .edit-number-btn {\n            background: none;\n            border: none;\n            color: #25d366;\n            cursor: pointer;\n            padding: 4px;\n            border-radius: 4px;\n            transition: all 0.2s ease;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n        }\n\n        .edit-number-btn:hover {\n            background: rgba(37, 211, 102, 0.1);\n            transform: scale(1.1);\n        }\n\n        .edit-number-input {\n            background: rgba(255, 255, 255, 0.1);\n            border: 1px solid rgba(37, 211, 102, 0.3);\n            border-radius: 4px;\n            padding: 6px 8px;\n            color: white;\n            font-family: monospace;\n            font-size: 0.9rem;\n            width: 120px;\n            outline: none;\n        }\n\n        .edit-number-input:focus {\n            border-color: #25d366;\n            box-shadow: 0 0 0 2px rgba(37, 211, 102, 0.2);\n        }\n\n        .save-number-btn {\n            background: #25d366;\n            border: none;\n            color: white;\n            padding: 4px 8px;\n            border-radius: 4px;\n            font-size: 0.8rem;\n            cursor: pointer;\n            margin-left: 4px;\n        }\n\n        .save-number-btn:hover {\n            background: #1da851;\n        }\n\n        .cancel-number-btn {\n            background: #ff4444;\n            border: none;\n            color: white;\n            padding: 4px 8px;\n            border-radius: 4px;\n            font-size: 0.8rem;\n            cursor: pointer;\n            margin-left: 4px;\n        }\n\n        .cancel-number-btn:hover {\n            background: #dc2626;\n        }\n\n    </style>\n</head>\n<body>\n    <div class=\"app-layout\">\n        <!-- Sidebar -->\n        <div class=\"sidebar\">\n            <div class=\"sidebar-header\">\n                <div class=\"sidebar-logo\">EnviaZap</div>\n            </div>\n            <nav class=\"sidebar-menu\">\n                <a href=\"#\" class=\"menu-item\" onclick=\"navigateToPage('https://n8n.typebot.pro/webhook/dashboard'); return false;\">\n                    <span class=\"menu-icon\">📊</span>\n                    <span class=\"menu-text\">Dashboard</span>\n                </a>\n                <a href=\"#\" class=\"menu-item\" onclick=\"navigateToPage('https://n8n.typebot.pro/webhook/historico-disparos'); return false;\">\n                    <span class=\"menu-icon\">📋</span>\n                    <span class=\"menu-text\">Histórico de disparos</span>\n                </a>\n                <a href=\"#\" class=\"menu-item\" onclick=\"navigateToPage('https://n8n.typebot.pro/webhook/conectar'); return false;\">\n                    <span class=\"menu-icon\">🔗</span>\n                    <span class=\"menu-text\">Nova Conexão</span>\n                </a>\n                <a href=\"#\" class=\"menu-item\" onclick=\"navigateToPage('https://n8n.typebot.pro/webhook/conexoes'); return false;\">\n                    <span class=\"menu-icon\">📱</span>\n                    <span class=\"menu-text\">Conexões</span>\n                </a>\n                <a href=\"#\" class=\"menu-item\" onclick=\"navigateToPage('https://n8n.typebot.pro/webhook/disparos-individuais'); return false;\">\n                    <span class=\"menu-icon\">💬</span>\n                    <span class=\"menu-text\">Disparos individuais</span>\n                </a>\n                <a href=\"#\" class=\"menu-item\" onclick=\"navigateToPage('https://n8n.typebot.pro/webhook/disparos-grupos'); return false;\">\n                    <span class=\"menu-icon\">👥</span>\n                    <span class=\"menu-text\">Disparos em grupo</span>\n                </a>\n                <a href=\"#\" class=\"menu-item active\">\n                    <span class=\"menu-icon\">🗂️</span>\n                    <span class=\"menu-text\">Listas</span>\n                </a>\n            </nav>\n            <div class=\"sidebar-footer\">\n                <a href=\"#\" class=\"menu-item logout-item\" onclick=\"logout()\">\n                    <span class=\"menu-icon\">🚪</span>\n                    <span class=\"menu-text\">Sair</span>\n                </a>\n            </div>\n        </div>\n\n        <!-- Main Content -->\n        <div class=\"main-content-wrapper\">\n            <div class=\"container\">\n                <div class=\"header\">\n                    <div class=\"header-info\">\n                        <h1>👥 Lista de Contatos</h1>\n                        <span id=\"listNameDisplay\" class=\"list-name-display\">Carregando...</span>\n                    </div>\n                    <div class=\"header-actions\">\n                        <button class=\"btn btn-secondary\" id=\"pullWhatsAppBtn\" onclick=\"openPullWhatsAppModal()\">\n                            <svg class=\"btn-icon\" viewBox=\"0 0 24 24\">\n                                <path d=\"M19.05 4.91A9.816 9.816 0 0 0 12.04 2c-5.46 0-9.91 4.45-9.91 9.91 0 1.75.46 3.45 1.32 4.95L2.05 22l5.25-1.38c1.45.79 3.08 1.21 4.74 1.21 5.46 0 9.91-4.45 9.91-9.91 0-2.65-1.03-5.14-2.9-7.01zM12.04 20.15c-1.48 0-2.93-.4-4.2-1.15l-.3-.18-3.12.82.83-3.04-.2-.31a8.264 8.264 0 0 1-1.26-4.38c0-4.54 3.7-8.24 8.24-8.24 2.2 0 4.27.86 5.82 2.42a8.183 8.183 0 0 1 2.41 5.83c.02 4.54-3.68 8.23-8.22 8.23zm4.52-6.16c-.25-.12-1.47-.72-1.69-.81-.23-.08-.39-.12-.56.12-.17.25-.64.81-.78.97-.14.17-.29.19-.54.06-.25-.12-1.05-.39-1.99-1.23-.74-.66-1.23-1.47-1.38-1.72-.14-.25-.02-.38.11-.51.11-.11.25-.29.37-.43.12-.14.16-.25.25-.41.08-.17.04-.31-.02-.43-.06-.12-.56-1.34-.76-1.84-.2-.48-.4-.42-.56-.43-.14-.01-.3-.01-.46-.01a.87.87 0 0 0-.64.3c-.22.25-.84.82-.84 2s.86 2.32.98 2.48c.12.17 1.75 2.67 4.23 3.74.59.26 1.05.41 1.41.53.59.19 1.13.16 1.56.1.48-.07 1.47-.6 1.67-1.18.21-.58.21-1.07.14-1.18s-.22-.16-.47-.28z\"/>\n                            </svg>\n                            Puxar do WhatsApp\n                        </button>\n                        <button class=\"btn btn-secondary\" id=\"importBtn\" onclick=\"openImportModal()\">\n                            <svg class=\"btn-icon\" viewBox=\"0 0 24 24\">\n                                <path d=\"M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z\"/>\n                                <path d=\"M12,11L16,15H13V19H11V15H8L12,11Z\"/>\n                            </svg>\n                            Importar CSV\n                        </button>\n                        <a href=\"#\" class=\"btn btn-secondary\" onclick=\"goBack()\">\n                            <svg class=\"btn-icon\" viewBox=\"0 0 24 24\">\n                                <path d=\"M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z\"/>\n                            </svg>\n                            Voltar\n                        </a>\n                    </div>\n                </div>\n\n                <div class=\"main-content\">\n                    <!-- Variáveis da Lista -->\n                    <div class=\"section\">\n                        <div class=\"section-header\" style=\"display: flex; align-items: center; gap: 12px;\">\n                            <span class=\"section-icon\">\n                                <svg viewBox=\"0 0 24 24\">\n                                    <path d=\"M9.4,16.6L4.8,12L3.4,13.4L9.4,19.4L20.6,8.2L19.2,6.8L9.4,16.6Z\"/>\n                                </svg>\n                            </span>\n                            <h3 class=\"section-title\" style=\"margin-right: 12px;\">Variáveis da Lista</h3>\n                            <button class=\"btn\" id=\"addVariableBtn\" onclick=\"openVariableModal()\">\n                                <svg class=\"btn-icon\" viewBox=\"0 0 24 24\">\n                                    <path d=\"M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z\"/>\n                                </svg>\n                                Criar Variável\n                            </button>\n                        </div>\n                        <div class=\"variables-container\" id=\"variablesContainer\">\n                            <!-- Variáveis serão carregadas aqui -->\n                        </div>\n                        <p class=\"section-subtitle\">As variáveis permitem personalizar as mensagens para cada contato.</p>\n                    </div>\n\n                    <!-- Tabela de Contatos -->\n                    <div class=\"section\">\n                        <div class=\"section-header\" style=\"display: flex; align-items: center; gap: 12px; justify-content: space-between;\">\n                            <div style=\"display: flex; align-items: center; gap: 12px;\">\n                                <span class=\"section-icon\">\n                                    <svg viewBox=\"0 0 24 24\">\n                                        <path d=\"M16,4C16.88,4 17.67,4.38 18.18,5H20C21.11,5 22,5.89 22,7V19C22,20.11 21.11,21 20,21H4C2.89,21 2,20.11 2,19V7C2,5.89 2.89,5 4,5H5.82C6.33,4.38 7.12,4 8,4H16M4,7V19H20V7H4M8,6A1,1 0 0,0 7,7A1,1 0 0,0 8,8A1,1 0 0,0 9,7A1,1 0 0,0 8,6M16,6A1,1 0 0,0 15,7A1,1 0 0,0 16,8A1,1 0 0,0 17,7A1,1 0 0,0 16,6Z\"/>\n                                    </svg>\n                                </span>\n                                <h3 class=\"section-title\" style=\"margin-right: 12px;\">Contatos</h3>\n                                <button class=\"btn\" id=\"addContactBtn\" onclick=\"openContactModal()\">\n                                    <svg class=\"btn-icon\" viewBox=\"0 0 24 24\">\n                                        <path d=\"M15,14C12.33,14 7,15.33 7,18V20H23V18C23,15.33 17.67,14 15,14M6,10V7H4V10H1V12H4V15H6V12H9V10M15,12A4,4 0 0,0 19,8A4,4 0 0,0 15,4A4,4 0 0,0 11,8A4,4 0 0,0 15,12Z\"/>\n                                    </svg>\n                                    Criar Contato\n                                </button>\n                                <button class=\"btn btn-secondary\" id=\"verifyNumbersBtn\" onclick=\"openVerifyNumbersModal()\">\n                                    <svg class=\"btn-icon\" viewBox=\"0 0 24 24\">\n                                        <path d=\"M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4M11,16.5L6.5,12L7.91,10.59L11,13.67L16.59,8.09L18,9.5L11,16.5Z\"/>\n                                    </svg>\n                                    Verificar números\n                                </button>\n                            </div>\n                            <span id=\"totalContatos\" style=\"color: #25d366; font-weight: 600; font-size: 1.1rem;\"></span>\n                        </div>\n                        <div class=\"contacts-table-container\">\n                            <table class=\"contacts-table\">\n                                <thead>\n                                    <tr>\n                                        <th style=\"width: 25%;\">Nome</th>\n                                        <th style=\"width: 20%;\">Telefone</th>\n                                        <th style=\"width: 18%;\">Data de Adição</th>\n                                        <th id=\"variablesHeader\" style=\"width: 22%;\">Variáveis</th>\n                                        <th style=\"width: 15%;\">Ações</th>\n                                    </tr>\n                                </thead>\n                                <tbody id=\"contactsTableBody\">\n                                    <tr>\n                                        <td colspan=\"5\" style=\"text-align: center; color: #888; padding: 40px 20px;\">\n                                            <div class=\"loading-spinner\" style=\"margin: 0 auto 15px auto;\"></div>\n                                            <p>Carregando contatos da lista...</p>\n                                        </td>\n                                    </tr>\n                                </tbody>\n                            </table>\n                        </div>\n                    </div>\n\n                    <!-- Mensagens -->\n                    <div class=\"message\" id=\"contactsMessage\"></div>\n                </div>\n            </div>\n        </div>\n    </div>\n\n    <!-- Modal para criar variável -->\n    <div class=\"modal\" id=\"variableModal\">\n        <div class=\"modal-content\">\n            <div class=\"modal-header\">\n                <h3 class=\"modal-title\">\n                    <svg style=\"width: 20px; height: 20px; fill: #25d366; margin-right: 8px;\" viewBox=\"0 0 24 24\">\n                        <path d=\"M9.4,16.6L4.8,12L3.4,13.4L9.4,19.4L20.6,8.2L19.2,6.8L9.4,16.6Z\"/>\n                    </svg>\n                    Nova Variável\n                </h3>\n                <button class=\"modal-close\" id=\"closeVariableModal\">&times;</button>\n            </div>\n            <form id=\"variableForm\">\n                <div class=\"form-group\">\n                    <label for=\"variableName\">Nome da Variável *</label>\n                    <input \n                        type=\"text\" \n                        id=\"variableName\" \n                        name=\"variableName\" \n                        placeholder=\"Ex: empresa, cargo, cidade...\" \n                        required\n                    >\n                </div>\n                <div class=\"message\" id=\"variableModalMessage\"></div>\n                <button type=\"submit\" class=\"btn\" style=\"width: 100%;\">\n                    <div class=\"loading-spinner\"></div>\n                    <svg class=\"btn-icon\" viewBox=\"0 0 24 24\">\n                        <path d=\"M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z\"/>\n                    </svg>\n                    <span>Criar Variável</span>\n                </button>\n            </form>\n        </div>\n    </div>\n\n    <!-- Modal para adicionar contato -->\n    <div class=\"modal\" id=\"contactModal\">\n        <div class=\"modal-content\">\n            <div class=\"modal-header\">\n                <h3 class=\"modal-title\">\n                    <svg style=\"width: 20px; height: 20px; fill: #25d366; margin-right: 8px;\" viewBox=\"0 0 24 24\">\n                        <path d=\"M15,14C12.33,14 7,15.33 7,18V20H23V18C23,15.33 17.67,14 15,14M6,10V7H4V10H1V12H4V15H6V12H9V10M15,12A4,4 0 0,0 19,8A4,4 0 0,0 15,4A4,4 0 0,0 11,8A4,4 0 0,0 15,12Z\"/>\n                    </svg>\n                    Novo Contato\n                </h3>\n                <button class=\"modal-close\" id=\"closeContactModal\">&times;</button>\n            </div>\n            <form id=\"contactForm\">\n                <div class=\"form-group\">\n                    <label for=\"contactName\">Nome *</label>\n                    <input \n                        type=\"text\" \n                        id=\"contactName\" \n                        name=\"contactName\" \n                        placeholder=\"Nome completo do contato\" \n                        required\n                    >\n                </div>\n                <div class=\"form-group\">\n                    <label for=\"contactPhone\">Telefone *</label>\n                    <input \n                        type=\"text\" \n                        id=\"contactPhone\" \n                        name=\"contactPhone\" \n                        placeholder=\"55(11)93423-2334\" \n                        required\n                    >\n                </div>\n                <div id=\"variablesFields\">\n                    <!-- Campos de variáveis serão adicionados dinamicamente -->\n                </div>\n                <div class=\"message\" id=\"contactModalMessage\"></div>\n                <button type=\"submit\" class=\"btn\" style=\"width: 100%;\">\n                    <div class=\"loading-spinner\"></div>\n                    <svg class=\"btn-icon\" viewBox=\"0 0 24 24\">\n                        <path d=\"M15,14C12.33,14 7,15.33 7,18V20H23V18C23,15.33 17.67,14 15,14M6,10V7H4V10H1V12H4V15H6V12H9V10M15,12A4,4 0 0,0 19,8A4,4 0 0,0 15,4A4,4 0 0,0 11,8A4,4 0 0,0 15,12Z\"/>\n                    </svg>\n                    <span>Adicionar Contato</span>\n                </button>\n            </form>\n        </div>\n    </div>\n\n    <!-- Modal para importar CSV -->\n    <div class=\"modal\" id=\"importModal\">\n        <div class=\"modal-content\">\n            <div class=\"modal-header\">\n                <h3 class=\"modal-title\">\n                    <svg style=\"width: 20px; height: 20px; fill: #25d366; margin-right: 8px;\" viewBox=\"0 0 24 24\">\n                        <path d=\"M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z\"/>\n                        <path d=\"M12,11L16,15H13V19H11V15H8L12,11Z\"/>\n                    </svg>\n                    Importar Contatos\n                </h3>\n                <button class=\"modal-close\" id=\"closeImportModal\">&times;</button>\n            </div>\n            <form id=\"importForm\">\n                <div class=\"form-group\">\n                    <label for=\"connectionSelectImport\">Selecione uma Conexão *</label>\n                    <div id=\"importConnectionsLoading\" class=\"whatsapp-loading\">\n                        <div class=\"loading-spinner\"></div>\n                        <span>Carregando conexões...</span>\n                    </div>\n                    <select id=\"connectionSelectImport\" class=\"connection-dropdown\" style=\"display: none;\" required>\n                        <option value=\"\">Selecione uma conexão...</option>\n                    </select>\n                </div>\n                \n                <div class=\"form-group\">\n                    <label>Arquivo CSV</label>\n                    <div class=\"file-upload\" id=\"fileUpload\" onclick=\"document.getElementById('csvFile').click()\">\n                        <div class=\"file-upload-icon\">\n                            <svg style=\"width: 48px; height: 48px; fill: #25d366;\" viewBox=\"0 0 24 24\">\n                                <path d=\"M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z\"/>\n                            </svg>\n                        </div>\n                        <div class=\"file-upload-text\">\n                            <p>Clique para selecionar um arquivo CSV</p>\n                            <p style=\"font-size: 0.8rem; color: #888; margin-top: 10px;\">\n                                Ou arraste e solte o arquivo aqui\n                            </p>\n                        </div>\n                        <div class=\"file-name\" id=\"fileName\" style=\"display: none;\"></div>\n                        <input type=\"file\" id=\"csvFile\" accept=\".csv\" required>\n                    </div>\n                </div>\n                <div class=\"form-group\">\n                    <a href=\"#\" class=\"download-example\" onclick=\"downloadExampleCSV()\">\n                        <svg style=\"width: 16px; height: 16px; fill: currentColor; margin-right: 6px; vertical-align: middle;\" viewBox=\"0 0 24 24\">\n                            <path d=\"M5,20H19V18H5M19,9H15V3H9V9H5L12,16L19,9Z\"/>\n                        </svg>\n                        Baixar arquivo de exemplo\n                    </a>\n                </div>\n                \n                <div class=\"form-group\">\n                    <div style=\"color: #888; font-size: 0.9rem; line-height: 1.4;\">\n                        <p>📋 Após selecionar o arquivo, os números serão verificados automaticamente</p>\n                        <p>🔍 A verificação inclui validação de números no WhatsApp e detecção de duplicados</p>\n                        <p>✅ Apenas números válidos e sem duplicações serão salvos</p>\n                        <p>📱 <strong>Formato do telefone:</strong> DDIDDDTELEFONE (ex: 5548984549300)</p>\n                    </div>\n                </div>\n                \n                <!-- Container para números inválidos -->\n                <div class=\"invalid-numbers-container\" id=\"invalidNumbersContainer\" style=\"display: none;\">\n                    <!-- Tabela será inserida aqui -->\n                </div>\n                \n                <!-- Container para resultados da verificação de importação -->\n                <div class=\"import-verification-results\" id=\"importVerificationResults\" style=\"display: none;\">\n                    <div style=\"margin-bottom: 15px;\">\n                        <div style=\"display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;\">\n                            <span style=\"color: #25d366; font-weight: 600;\">Resultados da Verificação</span>\n                            <span id=\"importVerificationProgress\" style=\"color: #888; font-size: 0.85rem;\">0%</span>\n                        </div>\n                        <div style=\"background: rgba(255, 255, 255, 0.05); border-radius: 4px; height: 6px; overflow: hidden;\">\n                            <div id=\"importVerificationProgressBar\" style=\"background: #25d366; height: 100%; width: 0%; transition: width 0.3s ease;\"></div>\n                        </div>\n                    </div>\n                    \n                    <div class=\"import-verification-summary\" id=\"importVerificationSummary\" style=\"display: none;\">\n                        <div style=\"display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;\">\n                            <div style=\"background: rgba(37, 211, 102, 0.1); border: 1px solid rgba(37, 211, 102, 0.3); border-radius: 8px; padding: 15px; text-align: center;\">\n                                <div style=\"color: #25d366; font-size: 1.8rem; font-weight: 700;\" id=\"importValidCount\">0</div>\n                                <div style=\"color: #25d366; font-size: 0.9rem;\">Números válidos</div>\n                            </div>\n                            <div style=\"background: rgba(255, 68, 68, 0.1); border: 1px solid rgba(255, 68, 68, 0.3); border-radius: 8px; padding: 15px; text-align: center;\">\n                                <div style=\"color: #ff4444; font-size: 1.8rem; font-weight: 700;\" id=\"importInvalidCount\">0</div>\n                                <div style=\"color: #ff4444; font-size: 0.9rem;\">Números inválidos</div>\n                            </div>\n                            <div style=\"background: rgba(255, 193, 7, 0.1); border: 1px solid rgba(255, 193, 7, 0.3); border-radius: 8px; padding: 15px; text-align: center;\">\n                                <div style=\"color: #ffc107; font-size: 1.8rem; font-weight: 700;\" id=\"importDuplicateCount\">0</div>\n                                <div style=\"color: #ffc107; font-size: 0.9rem;\">Números duplicados</div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n                \n                <div class=\"message\" id=\"importModalMessage\"></div>\n                <button type=\"submit\" class=\"btn\" style=\"width: 100%;\" id=\"importSubmitBtn\">\n                    <div class=\"loading-spinner\"></div>\n                    <svg class=\"btn-icon\" viewBox=\"0 0 24 24\">\n                        <path d=\"M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z\"/>\n                        <path d=\"M12,11L16,15H13V19H11V15H8L12,11Z\"/>\n                    </svg>\n                    <span>Importar Contatos</span>\n                </button>\n                \n                <!-- Botão para salvar apenas números válidos (inicialmente oculto) -->\n                <button type=\"button\" class=\"btn btn-success\" id=\"saveValidContactsBtn\" style=\"width: 100%; margin-top: 10px; display: none;\" onclick=\"saveValidContacts()\">\n                    <div class=\"loading-spinner\"></div>\n                    <svg class=\"btn-icon\" viewBox=\"0 0 24 24\">\n                        <path d=\"M15,9H5V5H15M12,19A3,3 0 0,1 9,16A3,3 0 0,1 12,13A3,3 0 0,1 15,16A3,3 0 0,1 12,19M17,3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V7L17,3Z\"/>\n                    </svg>\n                    <span>Salvar apenas números válidos</span>\n                </button>\n            </form>\n        </div>\n    </div>\n\n    <!-- Modal para puxar contatos do WhatsApp -->\n    <div class=\"modal\" id=\"pullWhatsAppModal\">\n        <div class=\"modal-content\">\n            <div class=\"modal-header\">\n                <h3 class=\"modal-title\">\n                    <svg style=\"width: 20px; height: 20px; fill: #25d366; margin-right: 8px;\" viewBox=\"0 0 24 24\">\n                        <path d=\"M19.05 4.91A9.816 9.816 0 0 0 12.04 2c-5.46 0-9.91 4.45-9.91 9.91 0 1.75.46 3.45 1.32 4.95L2.05 22l5.25-1.38c1.45.79 3.08 1.21 4.74 1.21 5.46 0 9.91-4.45 9.91-9.91 0-2.65-1.03-5.14-2.9-7.01zM12.04 20.15c-1.48 0-2.93-.4-4.2-1.15l-.3-.18-3.12.82.83-3.04-.2-.31a8.264 8.264 0 0 1-1.26-4.38c0-4.54 3.7-8.24 8.24-8.24 2.2 0 4.27.86 5.82 2.42a8.183 8.183 0 0 1 2.41 5.83c.02 4.54-3.68 8.23-8.22 8.23zm4.52-6.16c-.25-.12-1.47-.72-1.69-.81-.23-.08-.39-.12-.56.12-.17.25-.64.81-.78.97-.14.17-.29.19-.54.06-.25-.12-1.05-.39-1.99-1.23-.74-.66-1.23-1.47-1.38-1.72-.14-.25-.02-.38.11-.51.11-.11.25-.29.37-.43.12-.14.16-.25.25-.41.08-.17.04-.31-.02-.43-.06-.12-.56-1.34-.76-1.84-.2-.48-.4-.42-.56-.43-.14-.01-.3-.01-.46-.01a.87.87 0 0 0-.64.3c-.22.25-.84.82-.84 2s.86 2.32.98 2.48c.12.17 1.75 2.67 4.23 3.74.59.26 1.05.41 1.41.53.59.19 1.13.16 1.56.1.48-.07 1.47-.6 1.67-1.18.21-.58.21-1.07.14-1.18s-.22-.16-.47-.28z\"/>\n                    </svg>\n                    Puxar Contatos do WhatsApp\n                </h3>\n                <button class=\"modal-close\" id=\"closePullWhatsAppModal\">&times;</button>\n            </div>\n            <form id=\"pullWhatsAppForm\">\n                <div class=\"form-group\">\n                    <label for=\"connectionSelect\">Selecione uma Conexão *</label>\n                    <div id=\"connectionsLoading\" class=\"whatsapp-loading\">\n                        <div class=\"loading-spinner\"></div>\n                        <span>Carregando conexões...</span>\n                    </div>\n                    <select id=\"connectionSelect\" class=\"connection-dropdown\" style=\"display: none;\" required>\n                        <option value=\"\">Selecione uma conexão...</option>\n                    </select>\n                </div>\n                \n                <!-- Container para lista de contatos puxados -->\n                <div class=\"whatsapp-contacts-container\" id=\"whatsappContactsContainer\">\n                    <div class=\"whatsapp-contacts-header\">\n                        <span class=\"whatsapp-contacts-count\" id=\"whatsappContactsCount\">0 contatos encontrados</span>\n                        <div class=\"whatsapp-contacts-actions\">\n                            <button type=\"button\" class=\"btn-link\" onclick=\"selectAllWhatsAppContacts(true)\">Selecionar todos</button>\n                            <button type=\"button\" class=\"btn-link\" onclick=\"selectAllWhatsAppContacts(false)\">Desmarcar todos</button>\n                        </div>\n                    </div>\n                    <div class=\"whatsapp-contacts-list\" id=\"whatsappContactsList\">\n                        <!-- Contatos serão carregados aqui -->\n                    </div>\n                </div>\n                \n                <div class=\"message\" id=\"pullWhatsAppModalMessage\"></div>\n                \n                <button type=\"submit\" class=\"btn\" style=\"width: 100%;\" disabled>\n                    <div class=\"loading-spinner\"></div>\n                    <svg class=\"btn-icon\" viewBox=\"0 0 24 24\">\n                        <path d=\"M19.05 4.91A9.816 9.816 0 0 0 12.04 2c-5.46 0-9.91 4.45-9.91 9.91 0 1.75.46 3.45 1.32 4.95L2.05 22l5.25-1.38c1.45.79 3.08 1.21 4.74 1.21 5.46 0 9.91-4.45 9.91-9.91 0-2.65-1.03-5.14-2.9-7.01zM12.04 20.15c-1.48 0-2.93-.4-4.2-1.15l-.3-.18-3.12.82.83-3.04-.2-.31a8.264 8.264 0 0 1-1.26-4.38c0-4.54 3.7-8.24 8.24-8.24 2.2 0 4.27.86 5.82 2.42a8.183 8.183 0 0 1 2.41 5.83c.02 4.54-3.68 8.23-8.22 8.23zm4.52-6.16c-.25-.12-1.47-.72-1.69-.81-.23-.08-.39-.12-.56.12-.17.25-.64.81-.78.97-.14.17-.29.19-.54.06-.25-.12-1.05-.39-1.99-1.23-.74-.66-1.23-1.47-1.38-1.72-.14-.25-.02-.38.11-.51.11-.11.25-.29.37-.43.12-.14.16-.25.25-.41.08-.17.04-.31-.02-.43-.06-.12-.56-1.34-.76-1.84-.2-.48-.4-.42-.56-.43-.14-.01-.3-.01-.46-.01a.87.87 0 0 0-.64.3c-.22.25-.84.82-.84 2s.86 2.32.98 2.48c.12.17 1.75 2.67 4.23 3.74.59.26 1.05.41 1.41.53.59.19 1.13.16 1.56.1.48-.07 1.47-.6 1.67-1.18.21-.58.21-1.07.14-1.18s-.22-.16-.47-.28z\"/>\n                    </svg>\n                    <span id=\"pullWhatsAppBtnText\">Puxar Contatos</span>\n                </button>\n                \n                <!-- Botão para salvar contatos (inicialmente oculto) -->\n                <button type=\"button\" class=\"btn\" id=\"saveWhatsAppContactsBtn\" style=\"width: 100%; margin-top: 10px; display: none;\" onclick=\"saveSelectedWhatsAppContacts()\">\n                    <div class=\"loading-spinner\"></div>\n                    <svg class=\"btn-icon\" viewBox=\"0 0 24 24\">\n                        <path d=\"M15,9H5V5H15M12,19A3,3 0 0,1 9,16A3,3 0 0,1 12,13A3,3 0 0,1 15,16A3,3 0 0,1 12,19M17,3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V7L17,3Z\"/>\n                    </svg>\n                    <span>Salvar contatos</span>\n                </button>\n            </form>\n        </div>\n    </div>\n\n    <!-- Modal para verificar números -->\n    <div class=\"modal\" id=\"verifyNumbersModal\">\n        <div class=\"modal-content\" style=\"max-width: 600px;\">\n            <div class=\"modal-header\">\n                <h3 class=\"modal-title\">\n                    <svg style=\"width: 20px; height: 20px; fill: #25d366; margin-right: 8px;\" viewBox=\"0 0 24 24\">\n                        <path d=\"M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4M11,16.5L6.5,12L7.91,10.59L11,13.67L16.59,8.09L18,9.5L11,16.5Z\"/>\n                    </svg>\n                    Verificar números no WhatsApp\n                </h3>\n                <button class=\"modal-close\" id=\"closeVerifyNumbersModal\">&times;</button>\n            </div>\n            <form id=\"verifyNumbersForm\">\n                <div class=\"form-group\">\n                    <label for=\"verifyConnectionSelect\">Selecione uma Conexão *</label>\n                    <div id=\"verifyConnectionsLoading\" class=\"whatsapp-loading\">\n                        <div class=\"loading-spinner\"></div>\n                        <span>Carregando conexões...</span>\n                    </div>\n                    <select id=\"verifyConnectionSelect\" class=\"connection-dropdown\" style=\"display: none;\" required>\n                        <option value=\"\">Selecione uma conexão...</option>\n                    </select>\n                </div>\n                \n                <div class=\"form-group\">\n                    <div id=\"verifyNumbersInfo\" style=\"color: #888; font-size: 0.9rem; line-height: 1.4;\">\n                        <p>📋 <strong>0 números</strong> serão verificados nesta lista</p>\n                        <p>🔍 A verificação inclui validação de números no WhatsApp e detecção de duplicados</p>\n                        <p>⏱️ Esta operação pode levar alguns minutos dependendo da quantidade de números</p>\n                    </div>\n                </div>\n                \n                <!-- Container para resultados da verificação -->\n                <div class=\"verification-results-container\" id=\"verificationResultsContainer\" style=\"display: none;\">\n                    <div style=\"margin-bottom: 15px;\">\n                        <div style=\"display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;\">\n                            <span style=\"color: #25d366; font-weight: 600;\">Resultados da Verificação</span>\n                            <span id=\"verificationProgress\" style=\"color: #888; font-size: 0.85rem;\">0%</span>\n                        </div>\n                        <div style=\"background: rgba(255, 255, 255, 0.05); border-radius: 4px; height: 6px; overflow: hidden;\">\n                            <div id=\"verificationProgressBar\" style=\"background: #25d366; height: 100%; width: 0%; transition: width 0.3s ease;\"></div>\n                        </div>\n                    </div>\n                    \n                    <div class=\"verification-summary\" id=\"verificationSummary\" style=\"display: none;\">\n                        <div style=\"display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;\">\n                            <div style=\"background: rgba(37, 211, 102, 0.1); border: 1px solid rgba(37, 211, 102, 0.3); border-radius: 8px; padding: 15px; text-align: center;\">\n                                <div style=\"color: #25d366; font-size: 1.8rem; font-weight: 700;\" id=\"validCount\">0</div>\n                                <div style=\"color: #25d366; font-size: 0.9rem;\">Números válidos</div>\n                            </div>\n                            <div style=\"background: rgba(255, 68, 68, 0.1); border: 1px solid rgba(255, 68, 68, 0.3); border-radius: 8px; padding: 15px; text-align: center;\">\n                                <div style=\"color: #ff4444; font-size: 1.8rem; font-weight: 700;\" id=\"invalidCount\">0</div>\n                                <div style=\"color: #ff4444; font-size: 0.9rem;\">Números inválidos</div>\n                            </div>\n                            <div style=\"background: rgba(255, 193, 7, 0.1); border: 1px solid rgba(255, 193, 7, 0.3); border-radius: 8px; padding: 15px; text-align: center;\">\n                                <div style=\"color: #ffc107; font-size: 1.8rem; font-weight: 700;\" id=\"duplicateCount\">0</div>\n                                <div style=\"color: #ffc107; font-size: 0.9rem;\">Números duplicados</div>\n                            </div>\n                        </div>\n                    </div>\n                    \n                    <div class=\"verification-details\" id=\"verificationDetails\" style=\"display: none;\">\n                        <div style=\"margin-bottom: 15px;\">\n                            <div style=\"display: flex; gap: 10px; margin-bottom: 10px;\">\n                                <button type=\"button\" class=\"btn-link\" id=\"showValidNumbers\" onclick=\"toggleVerificationView('valid')\">Ver válidos</button>\n                                <button type=\"button\" class=\"btn-link\" id=\"showInvalidNumbers\" onclick=\"toggleVerificationView('invalid')\">Ver inválidos</button>\n                                <button type=\"button\" class=\"btn-link\" id=\"showDuplicateNumbers\" onclick=\"toggleVerificationView('duplicate')\">Ver duplicados</button>\n                                <button type=\"button\" class=\"btn-link\" onclick=\"toggleVerificationView('all')\">Ver todos</button>\n                            </div>\n                        </div>\n                        \n                        <div class=\"verification-list\" id=\"verificationList\" style=\"max-height: 300px; overflow-y: auto; border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; background: rgba(255, 255, 255, 0.02);\">\n                            <!-- Resultados serão carregados aqui -->\n                        </div>\n                    </div>\n                </div>\n                \n                <div class=\"message\" id=\"verifyNumbersModalMessage\"></div>\n                \n                <button type=\"submit\" class=\"btn\" style=\"width: 100%;\" disabled id=\"verifyNumbersSubmitBtn\">\n                    <div class=\"loading-spinner\"></div>\n                    <svg class=\"btn-icon\" viewBox=\"0 0 24 24\">\n                        <path d=\"M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4M11,16.5L6.5,12L7.91,10.59L11,13.67L16.59,8.09L18,9.5L11,16.5Z\"/>\n                    </svg>\n                    <span>Verificar números</span>\n                </button>\n                \n                <button type=\"button\" class=\"btn btn-danger\" style=\"display: none; width: 100%; background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); border: 1px solid rgba(220, 38, 38, 0.3); margin-top: 10px;\" id=\"deleteInvalidModalBtn\" onclick=\"deleteInvalidNumbers()\">\n                    <div class=\"loading-spinner\"></div>\n                    <svg class=\"btn-icon\" viewBox=\"0 0 24 24\">\n                        <path d=\"M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z\"/>\n                    </svg>\n                    <span>Excluir números inválidos e duplicados</span>\n                </button>\n            </form>\n        </div>\n    </div>\n\n    <script>\n        // Elementos do DOM\n        const contactsTableBody = document.getElementById('contactsTableBody');\n        const contactsMessage = document.getElementById('contactsMessage');\n        const variablesContainer = document.getElementById('variablesContainer');\n        const variablesHeader = document.getElementById('variablesHeader');\n        const variablesFields = document.getElementById('variablesFields');\n        \n        // Modais\n        const variableModal = document.getElementById('variableModal');\n        const contactModal = document.getElementById('contactModal');\n        const importModal = document.getElementById('importModal');\n        const pullWhatsAppModal = document.getElementById('pullWhatsAppModal');\n        const verifyNumbersModal = document.getElementById('verifyNumbersModal');\n        \n        // Formulários\n        const variableForm = document.getElementById('variableForm');\n        const contactForm = document.getElementById('contactForm');\n        const importForm = document.getElementById('importForm');\n        const pullWhatsAppForm = document.getElementById('pullWhatsAppForm');\n        const verifyNumbersForm = document.getElementById('verifyNumbersForm');\n        \n        // Inputs\n        const variableNameInput = document.getElementById('variableName');\n        const contactNameInput = document.getElementById('contactName');\n        const contactPhoneInput = document.getElementById('contactPhone');\n        const csvFileInput = document.getElementById('csvFile');\n        const fileUpload = document.getElementById('fileUpload');\n        const fileName = document.getElementById('fileName');\n        \n        // WhatsApp modal elements\n        const connectionSelect = document.getElementById('connectionSelect');\n        const connectionsLoading = document.getElementById('connectionsLoading');\n        const pullWhatsAppModalMessage = document.getElementById('pullWhatsAppModalMessage');\n        const whatsappContactsContainer = document.getElementById('whatsappContactsContainer');\n        const whatsappContactsList = document.getElementById('whatsappContactsList');\n        const whatsappContactsCount = document.getElementById('whatsappContactsCount');\n        const saveWhatsAppContactsBtn = document.getElementById('saveWhatsAppContactsBtn');\n        const pullWhatsAppBtnText = document.getElementById('pullWhatsAppBtnText');\n\n        // Verify Numbers modal elements\n        const verifyConnectionSelect = document.getElementById('verifyConnectionSelect');\n        const verifyConnectionsLoading = document.getElementById('verifyConnectionsLoading');\n        const verifyNumbersModalMessage = document.getElementById('verifyNumbersModalMessage');\n        const verificationResultsContainer = document.getElementById('verificationResultsContainer');\n        const verificationSummary = document.getElementById('verificationSummary');\n        const verificationDetails = document.getElementById('verificationDetails');\n        const verificationList = document.getElementById('verificationList');\n        const verificationProgress = document.getElementById('verificationProgress');\n        const verificationProgressBar = document.getElementById('verificationProgressBar');\n        const validCount = document.getElementById('validCount');\n        const invalidCount = document.getElementById('invalidCount');\n        const duplicateCount = document.getElementById('duplicateCount');\n\n        // Import verification elements\n        const importConnectionSelect = document.getElementById('connectionSelectImport');\n        const importConnectionsLoading = document.getElementById('importConnectionsLoading');\n        const importModalMessage = document.getElementById('importModalMessage');\n        \n        // Verificar se os elementos foram encontrados\n        console.log('🔍 Elementos do modal de importação:', {\n            importConnectionSelect: !!importConnectionSelect,\n            importConnectionsLoading: !!importConnectionsLoading,\n            importModalMessage: !!importModalMessage\n        });\n        const importVerificationResults = document.getElementById('importVerificationResults');\n        const importVerificationSummary = document.getElementById('importVerificationSummary');\n        const importVerificationProgress = document.getElementById('importVerificationProgress');\n        const importVerificationProgressBar = document.getElementById('importVerificationProgressBar');\n        const importValidCount = document.getElementById('importValidCount');\n        const importInvalidCount = document.getElementById('importInvalidCount');\n        const importDuplicateCount = document.getElementById('importDuplicateCount');\n        const importSubmitBtn = document.getElementById('importSubmitBtn');\n        const saveValidContactsBtn = document.getElementById('saveValidContactsBtn');\n\n        // Dados da lista e contatos\n        let currentList = null;\n        let contacts = [];\n        let variables = [];\n        let connections = []; // Para armazenar conexões do WhatsApp\n        let whatsappContacts = []; // Para armazenar contatos puxados do WhatsApp\n        let verificationResults = []; // Para armazenar resultados da verificação\n        let currentVerificationView = 'all'; // 'all', 'valid', 'invalid'\n        \n        // Dados de importação\n        let importContacts = []; // Contatos válidos do CSV\n        let invalidNumbersData = []; // Números inválidos (formato + WhatsApp)\n\n        // Paginação de contatos\n        let currentPage = 1;\n        const contactsPerPage = 10;\n\n        // Funções de mensagens\n        function showMessage(element, message, type = 'info') {\n            element.textContent = message;\n            element.className = `message ${type} show`;\n            setTimeout(() => {\n                element.classList.remove('show');\n            }, 5000);\n        }\n\n        function setButtonLoading(button, loading) {\n            const spinner = button.querySelector('.loading-spinner');\n            const span = button.querySelector('span');\n            \n            if (loading) {\n                button.classList.add('loading');\n                button.disabled = true;\n                if (spinner) spinner.style.display = 'block';\n            } else {\n                button.classList.remove('loading');\n                button.disabled = false;\n                if (spinner) spinner.style.display = 'none';\n            }\n        }\n\n        // Função para ler cookies\n        function getCookie(name) {\n            const value = `; ${document.cookie}`;\n            const parts = value.split(`; ${name}=`);\n            if (parts.length === 2) return parts.pop().split(';').shift();\n            return null;\n        }\n\n        // Função para obter userId de forma segura via cookies\n        function getSecureUserId() {\n            const userId = getCookie('userId');\n            if (userId && /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(userId)) {\n                console.log('✅ UserId (UUID) obtido dos cookies:', userId);\n                return userId;\n            }\n            console.error('❌ UserId (UUID) não encontrado ou formato inválido nos cookies!');\n            return null;\n        }\n\n        // Função global para ir para Listas\n        function goToListas() {\n            const userId = getSecureUserId();\n            if (userId) {\n                window.location.href = 'https://n8n.typebot.pro/webhook/listas';\n            } else {\n                window.location.href = 'https://n8n.typebot.pro/webhook/login';\n            }\n        }\n\n        // Função para obter dados da lista dos cookies\n        function getListFromCookies() {\n            const idLista = getCookie('idLista');\n            if (idLista && /^\\d+$/.test(idLista)) {\n                console.log('✅ idLista obtido dos cookies:', idLista);\n                return {\n                    id: parseInt(idLista),\n                    name: null // Nome será atualizado após requisição da API\n                };\n            }\n            console.error('❌ idLista não encontrado nos cookies!');\n            return null;\n        }\n\n        // Autenticação obrigatória ao carregar a página\n        function checkAuth() {\n            const userId = getSecureUserId();\n            if (!userId) {\n                window.location.href = 'https://n8n.typebot.pro/webhook/login';\n            }\n        }\n\n        // Botão voltar: redireciona para listas com userId\n        function goBack() {\n            goToListas();\n        }\n\n        // Carregar dados da lista\n        async function loadListData() {\n            console.log('Iniciando carregamento dos dados da lista...');\n            \n            currentList = getListFromCookies();\n            console.log('Dados da lista extraídos dos cookies:', currentList);\n            \n            if (!currentList) {\n                console.error('ID da lista não encontrado nos cookies');\n                showMessage(contactsMessage, '❌ ID da lista não encontrado nos cookies', 'error');\n                return;\n            }\n\n            // Ocultar o nome da lista enquanto busca\n            const listNameDisplay = document.getElementById('listNameDisplay');\n            if (listNameDisplay) {\n                listNameDisplay.style.opacity = '0';\n                listNameDisplay.style.visibility = 'hidden';\n            }\n\n            // Carregar variáveis da lista pela API\n            try {\n                const idLista = getCookie('idLista');\n                if (!idLista) {\n                    console.error('❌ idLista não encontrado nos cookies para carregar variáveis');\n                    // Mesmo sem idLista, usar fallback para nome e mostrar\n                    currentList.name = `Lista ${currentList.id}`;\n                    variables = [];\n                    renderVariables();\n                    renderHeaderInfo();\n                    return;\n                }\n\n                const response = await fetch('https://n8n.typebot.pro/webhook/puxar-variaveis', {\n                    method: 'POST',\n                    headers: {\n                        'Content-Type': 'application/json',\n                    },\n                    body: JSON.stringify({ idLista: parseInt(idLista) })\n                });\n                if (!response.ok) {\n                    const errorText = await response.text();\n                    throw new Error(`Erro ao puxar variáveis: ${response.status} - ${errorText}`);\n                }\n                const responseData = await response.json();\n                console.log('Variáveis recebidas da API:', responseData);\n                \n                // Novo formato: objeto com propriedade 'data'\n                if (responseData && responseData.data && Array.isArray(responseData.data) && responseData.data.length > 0) {\n                    const listData = responseData.data[0];\n                    \n                    // Extrair nome da lista\n                    if (listData.nome) {\n                        currentList.name = listData.nome;\n                        console.log('Nome da lista extraído:', listData.nome);\n                    }\n                    \n                    if (listData.campos && Array.isArray(listData.campos)) {\n                        variables = listData.campos;\n                        console.log('Variáveis extraídas:', variables);\n                    } else {\n                        variables = [];\n                    }\n                } else if (responseData && Array.isArray(responseData)) {\n                    // Formato antigo: array de objetos com propriedade 'data'\n                    for (const item of responseData) {\n                        if (item.data && Array.isArray(item.data) && item.data.length > 0) {\n                            const listData = item.data[0];\n                            \n                            // Extrair nome da lista\n                            if (listData.nome) {\n                                currentList.name = listData.nome;\n                                console.log('Nome da lista extraído:', listData.nome);\n                            }\n                            \n                            if (listData.campos && Array.isArray(listData.campos)) {\n                                variables = listData.campos;\n                                console.log('Variáveis extraídas:', variables);\n                                break;\n                            }\n                        }\n                    }\n                } else {\n                    variables = [];\n                    // Se resposta vazia/inválida, usar fallback para nome\n                    if (!currentList.name) {\n                        currentList.name = `Lista ${currentList.id}`;\n                        console.log('Resposta da API vazia/inválida, usando fallback para nome da lista');\n                    }\n                }\n                \n                if (!variables || variables.length === 0) {\n                    console.log('Nenhuma variável encontrada na resposta');\n                    variables = [];\n                }\n                \n                // Se não conseguiu extrair o nome da lista, usar fallback\n                if (!currentList.name) {\n                    currentList.name = `Lista ${currentList.id}`;\n                    console.log('Nome da lista não encontrado na API de variáveis, usando fallback');\n                }\n                \n                renderVariables();\n                // Atualizar o header com o nome real da lista (ou fallback)\n                renderHeaderInfo();\n            } catch (error) {\n                console.error('Erro ao puxar variáveis:', error);\n                // Em caso de erro, garantir que o nome seja mostrado com fallback\n                if (!currentList.name) {\n                    currentList.name = `Lista ${currentList.id}`;\n                }\n                variables = [];\n                renderVariables();\n                // Mesmo em caso de erro, tentar atualizar o header\n                renderHeaderInfo();\n            }\n            \n            // Carregar contatos\n            console.log('Iniciando carregamento de contatos...');\n            await loadContacts();\n        }\n\n        // Inicializar variáveis vazias (serão gerenciadas localmente)\n        function initializeVariables() {\n            variables = [];\n            renderVariables();\n        }\n\n        // Carregar contatos da lista\n        async function loadContacts() {\n            console.log('Função loadContacts iniciada');\n            console.log('currentList:', currentList);\n            \n            try {\n                const idLista = getCookie('idLista');\n                if (!idLista) {\n                    console.error('❌ idLista não encontrado nos cookies para carregar contatos');\n                    throw new Error('idLista não encontrado nos cookies');\n                }\n\n                console.log('Fazendo requisição para API com idLista:', idLista);\n                \n                const response = await fetch('https://n8n.typebot.pro/webhook/puxar-lista-contatos', {\n                    method: 'POST',\n                    headers: {\n                        'Content-Type': 'application/json',\n                    },\n                    body: JSON.stringify({ idLista: parseInt(idLista) })\n                });\n\n                console.log('Resposta recebida:', response.status, response.statusText);\n\n                // Se a resposta for 500, apenas mostra lista vazia, sem erro para o usuário\n                if (response.status === 500) {\n                    contacts = [];\n                    renderContactsTable();\n                    showMessage(contactsMessage, 'ℹ️ Nenhum contato encontrado nesta lista. Adicione seu primeiro contato!', 'info');\n                    return;\n                }\n\n                if (!response.ok) {\n                    const errorText = await response.text();\n                    console.error('Erro na resposta:', errorText);\n                    throw new Error(`Erro ao carregar contatos: ${response.status} - ${errorText}`);\n                }\n\n                const responseData = await response.json();\n                console.log('Resposta da API de contatos:', responseData);\n                \n                // Verificar se a resposta tem a estrutura esperada\n                if (responseData && responseData.data && Array.isArray(responseData.data)) {\n                    // Estrutura: objeto com propriedade 'data' contendo array\n                    contacts = responseData.data.map(contact => ({\n                        id: contact.id,\n                        name: contact.nome || contact.name,\n                        phone: contact.telefone || contact.phone,\n                        added_at: contact.data_adicao || contact.added_at || contact.created_at || new Date().toISOString().split('T')[0],\n                        variables: contact.atributos || contact.variaveis || contact.variables || {}\n                    }));\n                } else if (responseData && Array.isArray(responseData)) {\n                    // Estrutura alternativa: array direto\n                    contacts = responseData.map(contact => ({\n                        id: contact.id,\n                        name: contact.nome || contact.name,\n                        phone: contact.telefone || contact.phone,\n                        added_at: contact.data_adicao || contact.added_at || contact.created_at || new Date().toISOString().split('T')[0],\n                        variables: contact.atributos || contact.variaveis || contact.variables || {}\n                    }));\n                } else {\n                    console.log('Resposta não tem estrutura válida, definindo contatos como vazio');\n                    contacts = [];\n                }\n                \n                console.log('Contatos processados:', contacts);\n                console.log('📋 IDs dos contatos carregados:', contacts.map(c => ({ id: c.id, tipo: typeof c.id, name: c.name })));\n                renderContactsTable();\n                \n                if (contacts.length === 0) {\n                    showMessage(contactsMessage, 'ℹ️ Nenhum contato encontrado nesta lista. Adicione seu primeiro contato!', 'info');\n                } else {\n                    showMessage(contactsMessage, `✅ ${contacts.length} contato(s) carregado(s) com sucesso!`, 'success');\n                }\n                \n            } catch (error) {\n                console.error('Erro ao carregar contatos:', error);\n                showMessage(contactsMessage, `❌ ${error.message}`, 'error');\n                contacts = [];\n                renderContactsTable();\n            }\n        }\n\n        // Renderizar variáveis\n        function renderVariables() {\n            variablesContainer.innerHTML = variables.map(variable => `\n                <div class=\"variable-tag\">\n                    <span>${variable}</span>\n                    <button class=\"variable-remove\" onclick=\"removeVariable('${variable}')\">&times;</button>\n                </div>\n            `).join('');\n            \n            // Atualizar cabeçalho da tabela\n            if (variables.length > 0) {\n                variablesHeader.textContent = 'Variáveis';\n            } else {\n                variablesHeader.textContent = 'Variáveis';\n            }\n            \n            // Atualizar campos do formulário de contato\n            renderVariablesFields();\n        }\n\n        // Renderizar campos de variáveis no formulário\n        function renderVariablesFields() {\n            variablesFields.innerHTML = variables.map(variable => `\n                <div class=\"form-group\">\n                    <label for=\"var_${variable}\">${variable}</label>\n                    <input \n                        type=\"text\" \n                        id=\"var_${variable}\" \n                        name=\"var_${variable}\" \n                        placeholder=\"Valor para ${variable}\"\n                    >\n                </div>\n            `).join('');\n        }\n\n        // Renderizar tabela de contatos com paginação\n        function renderContactsTable() {\n            if (contacts.length === 0) {\n                contactsTableBody.innerHTML = `\n                    <tr>\n                        <td colspan=\"5\" style=\"text-align: center; color: #888; padding: 40px 20px;\">\n                            <div style=\"font-size: 3rem; margin-bottom: 15px;\">\n                                <svg style=\"width: 48px; height: 48px; fill: #888;\" viewBox=\"0 0 24 24\">\n                                    <path d=\"M16,4C16.88,4 17.67,4.38 18.18,5H20C21.11,5 22,5.89 22,7V19C22,20.11 21.11,21 20,21H4C2.89,21 2,20.11 2,19V7C2,5.89 2.89,5 4,5H5.82C6.33,4.38 7.12,4 8,4H16M4,7V19H20V7H4M8,6A1,1 0 0,0 7,7A1,1 0 0,0 8,8A1,1 0 0,0 9,7A1,1 0 0,0 8,6M16,6A1,1 0 0,0 15,7A1,1 0 0,0 16,8A1,1 0 0,0 17,7A1,1 0 0,0 16,6Z\"/>\n                                </svg>\n                            </div>\n                            <p>Nenhum contato encontrado.</p>\n                            <p style=\"font-size: 0.85rem;\">Adicione seu primeiro contato ou importe um arquivo CSV.</p>\n                        </td>\n                    </tr>\n                `;\n                renderPagination();\n                return;\n            }\n            // Atualiza o total de contatos no topo\n            const totalContatosDiv = document.getElementById('totalContatos');\n            if (totalContatosDiv) {\n                totalContatosDiv.textContent = `Total de contatos: ${contacts.length}`;\n            }\n            // Paginação\n            const startIdx = (currentPage - 1) * contactsPerPage;\n            const endIdx = startIdx + contactsPerPage;\n            const pageContacts = contacts.slice(startIdx, endIdx);\n\n            console.log('📋 Renderizando tabela com contatos:', pageContacts.map(c => ({ id: c.id, tipo: typeof c.id, name: c.name })));\n            \n            contactsTableBody.innerHTML = pageContacts.map(contact => `\n                <tr>\n                    <td>\n                        <div class=\"contact-name\">${contact.name}</div>\n                    </td>\n                    <td class=\"contact-phone\">${contact.phone}</td>\n                    <td class=\"contact-date\">${formatDate(contact.added_at)}</td>\n                    <td>\n                        ${variables.map(variable => \n                            contact.variables[variable] ? \n                            `<div style=\"font-size: 0.8rem; color: #888; margin-bottom: 2px;\">\n                                <strong>${variable}:</strong> ${contact.variables[variable]}\n                            </div>` : ''\n                        ).join('')}\n                    </td>\n                    <td>\n                        <div class=\"contact-actions\">\n                            <button class=\"action-btn delete\" onclick=\"deleteContact(${contact.id})\" title=\"Excluir\" data-contact-id=\"${contact.id}\">\n                                <svg style=\"width: 14px; height: 14px; fill: currentColor;\" viewBox=\"0 0 24 24\">\n                                    <path d=\"M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z\"/>\n                                </svg>\n                            </button>\n                        </div>\n                    </td>\n                </tr>\n            `).join('');\n            renderPagination();\n            \n            // Event listeners duplos removidos para evitar confirmação dupla\n            // O onclick no HTML já é suficiente\n        }\n\n        // Funções utilitárias\n        function formatDate(dateString) {\n            const date = new Date(dateString);\n            return date.toLocaleDateString('pt-BR');\n        }\n\n        // Funções globais para WhatsApp\n        window.toggleWhatsAppContact = toggleWhatsAppContact;\n        window.selectAllWhatsAppContacts = selectAllWhatsAppContacts;\n        window.saveSelectedWhatsAppContacts = saveSelectedWhatsAppContacts;\n\n        // Funções globais para verificação de números\n        window.toggleVerificationView = toggleVerificationView;\n\n        // Funções de ação das variáveis\n        window.removeVariable = async function(variableName) {\n            if (confirm(`Tem certeza que deseja remover a variável \"${variableName}\"?`)) {\n                try {\n                    const idLista = getCookie('idLista');\n                    if (!idLista) {\n                        console.error('❌ idLista não encontrado nos cookies para remover variável');\n                        showMessage(contactsMessage, '❌ Erro: ID da lista não encontrado', 'error');\n                        return;\n                    }\n\n                    // Remover a variável do array local\n                    const updatedVariables = variables.filter(v => v !== variableName);\n                    \n                    const requestBody = {\n                        idLista: parseInt(idLista),\n                        variaveis: updatedVariables\n                    };\n\n                    console.log('Enviando variáveis atualizadas para API:', requestBody);\n\n                    const response = await fetch('https://n8n.typebot.pro/webhook/criar-variaveis', {\n                        method: 'POST',\n                        headers: {\n                            'Content-Type': 'application/json',\n                        },\n                        body: JSON.stringify(requestBody)\n                    });\n\n                    if (!response.ok) {\n                        const errorText = await response.text();\n                        throw new Error(`Erro ao remover variável: ${response.status} - ${errorText}`);\n                    }\n\n                    const responseData = await response.json();\n                    console.log('Resposta da API:', responseData);\n\n                    // Atualizar o array local\n                    variables = updatedVariables;\n                    renderVariables();\n                    showMessage(contactsMessage, `✅ Variável \"${variableName}\" removida com sucesso!`, 'success');\n\n                } catch (error) {\n                    console.error('Erro ao remover variável:', error);\n                    showMessage(contactsMessage, `❌ ${error.message}`, 'error');\n                }\n            }\n        };\n\n        // Funções de ação dos contatos\n        window.deleteContact = async function(id) {\n            console.log('🗑️ Função deleteContact chamada com ID:', id, 'tipo:', typeof id);\n            console.log('📋 Contatos disponíveis:', contacts.map(c => ({ id: c.id, tipo: typeof c.id, name: c.name })));\n            \n            // Tentar encontrar o contato com diferentes tipos de comparação\n            let contact = contacts.find(c => c.id === id);\n            \n            if (!contact) {\n                // Tentar com conversão de tipo\n                const idNumber = parseInt(id);\n                const idString = String(id);\n                \n                console.log('🔍 Tentando encontrar com conversão de tipo...');\n                console.log('ID como número:', idNumber, 'tipo:', typeof idNumber);\n                console.log('ID como string:', idString, 'tipo:', typeof idString);\n                \n                contact = contacts.find(c => c.id === idNumber) || \n                         contacts.find(c => c.id === idString) ||\n                         contacts.find(c => String(c.id) === String(id));\n                \n                console.log('👤 Contato encontrado após conversão:', contact);\n            }\n            \n            if (!contact) {\n                console.error('❌ Contato não encontrado com ID:', id);\n                console.error('❌ IDs disponíveis:', contacts.map(c => c.id));\n                showMessage(contactsMessage, '❌ Contato não encontrado', 'error');\n                return;\n            }\n            \n            if (confirm(`Tem certeza que deseja excluir o contato \"${contact.name}\"?`)) {\n                console.log('✅ Usuário confirmou exclusão do contato:', contact.name);\n                \n                try {\n                    console.log('📡 Enviando requisição para API de exclusão...');\n                    \n                    // Requisição para API de exclusão\n                    const response = await fetch('https://n8n.typebot.pro/webhook/excluir-contato', {\n                        method: 'POST',\n                        headers: {\n                            'Content-Type': 'application/json',\n                        },\n                        body: JSON.stringify({ idContato: id })\n                    });\n                    \n                    console.log('📡 Resposta da API:', response.status, response.statusText);\n                    \n                    // Tratar resposta vazia como sucesso (comum em operações de exclusão)\n                    if (response.status === 204 || response.status === 200) {\n                        console.log('✅ API retornou sucesso (resposta vazia é normal para exclusão)');\n                    } else if (!response.ok) {\n                        const errorText = await response.text();\n                        console.error('❌ Erro na API:', errorText);\n                        \n                        // Verificar se é o erro específico de contato vinculado a disparo\n                        if (errorText.includes('\"message\":\"Error in workflow\"') || errorText.includes('Error in workflow')) {\n                            showMessage(contactsMessage, '❌ Não é possível excluir um contato que esteja vinculado a um disparo. Remova o contato do disparo primeiro.', 'error');\n                        } else {\n                            showMessage(contactsMessage, `❌ Erro ao excluir contato: ${response.status} - ${errorText}`, 'error');\n                        }\n                        return;\n                    }\n                    \n                    console.log('✅ API retornou sucesso, removendo contato localmente...');\n                    \n                    // Remover contato localmente (API retornou sucesso)\n                    contacts = contacts.filter(c => c.id !== id);\n                    console.log('📋 Contatos após remoção:', contacts);\n                    \n                    resetPagination();\n                    renderContactsTable();\n                    showMessage(contactsMessage, `✅ Contato \"${contact.name}\" excluído com sucesso!`, 'success');\n                    \n                    console.log('✅ Exclusão concluída com sucesso');\n                    \n                } catch (error) {\n                    console.error('❌ Erro ao excluir contato:', error);\n                    showMessage(contactsMessage, `❌ ${error.message}`, 'error');\n                }\n            } else {\n                console.log('❌ Usuário cancelou a exclusão');\n            }\n        };\n\n\n\n        // Função para excluir números inválidos e duplicados\n        window.deleteInvalidNumbers = async function() {\n            // Verificar se há resultados da verificação\n            if (!verificationResults || verificationResults.length === 0) {\n                showMessage(verifyNumbersModalMessage, '❌ Nenhuma verificação foi realizada', 'error');\n                return;\n            }\n            \n            // Filtrar números inválidos\n            const invalidNumbers = verificationResults.filter(r => !r.isValid);\n            \n            // Identificar contatos duplicados (mesmo número aparece mais de uma vez)\n            const phoneOccurrences = {};\n            const duplicateContacts = [];\n            \n            // Contar ocorrências de cada número\n            contacts.forEach(contact => {\n                const phoneNumber = contact.phone.replace(/\\D/g, '');\n                if (phoneOccurrences[phoneNumber]) {\n                    phoneOccurrences[phoneNumber].push(contact);\n                } else {\n                    phoneOccurrences[phoneNumber] = [contact];\n                }\n            });\n            \n            // Identificar duplicados (manter apenas o primeiro, marcar os demais para exclusão)\n            Object.values(phoneOccurrences).forEach(contactsWithSamePhone => {\n                if (contactsWithSamePhone.length > 1) {\n                    // Pular o primeiro contato (mantê-lo), marcar os demais para exclusão\n                    duplicateContacts.push(...contactsWithSamePhone.slice(1));\n                }\n            });\n            \n            // Coletar IDs dos contatos que devem ser excluídos\n            const contactsToDelete = [];\n            \n            // Adicionar contatos com números inválidos\n            invalidNumbers.forEach(invalid => {\n                // Encontrar o contato correspondente pelo número\n                const contact = contacts.find(c => {\n                    const contactNumber = c.phone.replace(/\\D/g, '');\n                    return contactNumber === invalid.number;\n                });\n                if (contact && !contactsToDelete.includes(contact)) {\n                    contactsToDelete.push(contact);\n                }\n            });\n            \n            // Adicionar contatos duplicados\n            duplicateContacts.forEach(duplicate => {\n                if (!contactsToDelete.includes(duplicate)) {\n                    contactsToDelete.push(duplicate);\n                }\n            });\n            \n            // Verificar se há contatos para excluir\n            if (contactsToDelete.length === 0) {\n                showMessage(verifyNumbersModalMessage, '✅ Não há números inválidos ou duplicados para excluir', 'success');\n                return;\n            }\n            \n            // Separar contatos inválidos e duplicados para mensagem mais clara\n            const invalidContactsToDelete = [];\n            const duplicateContactsToDelete = [];\n            \n            contactsToDelete.forEach(contact => {\n                const contactNumber = contact.phone.replace(/\\D/g, '');\n                const isInvalid = invalidNumbers.some(invalid => invalid.number === contactNumber);\n                const isDuplicate = duplicateContacts.includes(contact);\n                \n                if (isInvalid) {\n                    invalidContactsToDelete.push(contact);\n                } else if (isDuplicate) {\n                    duplicateContactsToDelete.push(contact);\n                }\n            });\n            \n            // Mostrar estatísticas antes da confirmação\n            const totalInvalid = invalidContactsToDelete.length;\n            const totalDuplicate = duplicateContactsToDelete.length;\n            const totalToDelete = contactsToDelete.length;\n            \n            console.log(`📊 Estatísticas de exclusão: ${totalInvalid} inválidos, ${totalDuplicate} duplicados, ${totalToDelete} total`);\n            \n            // Construir mensagem de confirmação detalhada\n            let confirmMessage = `Tem certeza que deseja excluir ${contactsToDelete.length} contato(s)?\\n\\n`;\n            \n            if (invalidContactsToDelete.length > 0) {\n                confirmMessage += `📱 NÚMEROS INVÁLIDOS (${invalidContactsToDelete.length}):\\n`;\n                confirmMessage += invalidContactsToDelete.map(c => `- ${c.name} (${c.phone})`).join('\\n');\n                confirmMessage += '\\n\\n';\n            }\n            \n            if (duplicateContactsToDelete.length > 0) {\n                confirmMessage += `🔄 NÚMEROS DUPLICADOS (${duplicateContactsToDelete.length}):\\n`;\n                confirmMessage += duplicateContactsToDelete.map(c => `- ${c.name} (${c.phone})`).join('\\n');\n                confirmMessage += '\\n\\n';\n            }\n            \n            confirmMessage += 'Esta ação não pode ser desfeita.';\n            \n            if (!confirm(confirmMessage)) {\n                return;\n            }\n            \n            // Desabilitar botão durante a exclusão\n            const deleteBtn = document.getElementById('deleteInvalidModalBtn');\n            setButtonLoading(deleteBtn, true);\n            \n            try {\n                let successCount = 0;\n                let errorCount = 0;\n                const errors = [];\n                \n                // Excluir cada contato usando a mesma API da tabela\n                for (const contact of contactsToDelete) {\n                    try {\n                        const response = await fetch('https://n8n.typebot.pro/webhook/excluir-contato', {\n                            method: 'POST',\n                            headers: {\n                                'Content-Type': 'application/json',\n                            },\n                            body: JSON.stringify({ idContato: contact.id })\n                        });\n                        \n                        if (!response.ok) {\n                            const errorText = await response.text();\n                            throw new Error(`Erro ao excluir ${contact.name}: ${response.status} - ${errorText}`);\n                        }\n                        \n                        successCount++;\n                        \n                        // Remover do array local\n                        const index = contacts.findIndex(c => c.id === contact.id);\n                        if (index > -1) {\n                            contacts.splice(index, 1);\n                        }\n                        \n                    } catch (error) {\n                        console.error(`Erro ao excluir contato ${contact.name}:`, error);\n                        errors.push(`${contact.name}: ${error.message}`);\n                        errorCount++;\n                    }\n                }\n                \n                // Atualizar interface\n                resetPagination();\n                renderContactsTable();\n                \n                // Mostrar resultado detalhado\n                if (successCount > 0 && errorCount === 0) {\n                    let successMsg = `✅ ${successCount} contato(s) excluído(s) com sucesso`;\n                    if (invalidContactsToDelete.length > 0 && duplicateContactsToDelete.length > 0) {\n                        successMsg += ` (${invalidContactsToDelete.length} inválidos + ${duplicateContactsToDelete.length} duplicados)`;\n                    } else if (invalidContactsToDelete.length > 0) {\n                        successMsg += ` (${invalidContactsToDelete.length} números inválidos)`;\n                    } else if (duplicateContactsToDelete.length > 0) {\n                        successMsg += ` (${duplicateContactsToDelete.length} números duplicados)`;\n                    }\n                    showMessage(verifyNumbersModalMessage, successMsg, 'success');\n                } else if (successCount > 0 && errorCount > 0) {\n                    showMessage(verifyNumbersModalMessage, `⚠️ ${successCount} contato(s) excluído(s), ${errorCount} erro(s): ${errors.join(', ')}`, 'warning');\n                } else {\n                    showMessage(verifyNumbersModalMessage, `❌ Erro ao excluir contatos: ${errors.join(', ')}`, 'error');\n                }\n                \n                // Fechar modal após exclusão bem-sucedida\n                if (successCount > 0) {\n                    // Aguardar um pouco para mostrar a mensagem de sucesso antes de fechar\n                    setTimeout(() => {\n                        closeVerifyNumbersModal();\n                    }, 2000);\n                }\n                \n            } catch (error) {\n                console.error('Erro geral ao excluir contatos:', error);\n                showMessage(verifyNumbersModalMessage, `❌ Erro ao excluir contatos: ${error.message}`, 'error');\n            } finally {\n                // Restaurar botão\n                setButtonLoading(deleteBtn, false);\n            }\n        };\n\n        // Funções dos modais\n        function openVariableModal() {\n            variableModal.classList.add('show');\n            setTimeout(() => variableNameInput.focus(), 100);\n        }\n\n        function closeVariableModal() {\n            variableModal.classList.remove('show');\n            variableForm.reset();\n        }\n\n        function openContactModal() {\n            contactModal.classList.add('show');\n            setTimeout(() => contactNameInput.focus(), 100);\n        }\n\n        function closeContactModal() {\n            contactModal.classList.remove('show');\n            contactForm.reset();\n        }\n\n        function openImportModal() {\n            console.log('🚀 Abrindo modal de importação...');\n            importModal.classList.add('show');\n            // Carregar conexões quando o modal for aberto\n            console.log('📞 Chamando loadImportConnections...');\n            loadImportConnections();\n        }\n\n        function closeImportModal() {\n            importModal.classList.remove('show');\n            importForm.reset();\n            \n            // Resetar estado completo usando a função centralizada\n            resetImportState();\n        }\n\n        function openPullWhatsAppModal() {\n            pullWhatsAppModal.classList.add('show');\n            loadConnections();\n        }\n\n        function closePullWhatsAppModal() {\n            pullWhatsAppModal.classList.remove('show');\n            pullWhatsAppForm.reset();\n            connectionSelect.style.display = 'none';\n            connectionsLoading.style.display = 'flex';\n            pullWhatsAppForm.querySelector('button[type=\"submit\"]').disabled = true;\n            \n            // Limpar lista de contatos do WhatsApp\n            whatsappContacts = [];\n            whatsappContactsContainer.style.display = 'none';\n            whatsappContactsList.innerHTML = '';\n            whatsappContactsCount.textContent = '0 contatos encontrados';\n            saveWhatsAppContactsBtn.style.display = 'none';\n            pullWhatsAppBtnText.textContent = '📱 Puxar Contatos';\n            pullWhatsAppForm.querySelector('button[type=\"submit\"]').style.display = 'block';\n            \n            // Limpar indicador de progresso\n            hideVerificationProgress();\n        }\n\n        function openVerifyNumbersModal() {\n            // Verificar se há contatos na lista\n            if (contacts.length === 0) {\n                showMessage(contactsMessage, '❌ Não há contatos na lista para verificar', 'error');\n                return;\n            }\n            \n            verifyNumbersModal.classList.add('show');\n            \n            // Atualizar informação de quantidade de números\n            const infoDiv = document.getElementById('verifyNumbersInfo');\n            if (infoDiv) {\n                infoDiv.innerHTML = `\n                    <p>📋 <strong>${contacts.length} números</strong> serão verificados nesta lista</p>\n                    <p>🔍 A verificação inclui validação de números no WhatsApp e detecção de duplicados</p>\n                    <p>⏱️ Esta operação pode levar alguns minutos dependendo da quantidade de números</p>\n                `;\n            }\n            \n            loadVerifyConnections();\n        }\n\n        function closeVerifyNumbersModal() {\n            verifyNumbersModal.classList.remove('show');\n            verifyNumbersForm.reset();\n            verifyConnectionSelect.style.display = 'none';\n            verifyConnectionsLoading.style.display = 'flex';\n            verifyNumbersForm.querySelector('button[type=\"submit\"]').disabled = true;\n            \n            // Parar animação de progresso\n            if (progressAnimationId) {\n                cancelAnimationFrame(progressAnimationId);\n                progressAnimationId = null;\n            }\n            \n            // Limpar resultados\n            verificationResults = [];\n            verificationResultsContainer.style.display = 'none';\n            verificationSummary.style.display = 'none';\n            verificationDetails.style.display = 'none';\n            verificationList.innerHTML = '';\n            verificationProgress.textContent = '0%';\n            verificationProgressBar.style.width = '0%';\n            validCount.textContent = '0';\n            invalidCount.textContent = '0';\n            currentVerificationView = 'all';\n            \n            // Resetar botões: mostrar \"Verificar números\" e ocultar \"Excluir números inválidos\"\n            const verifyBtn = document.getElementById('verifyNumbersBtn');\n            const verifySubmitBtn = document.getElementById('verifyNumbersSubmitBtn');\n            const deleteInvalidModalBtn = document.getElementById('deleteInvalidModalBtn');\n            \n            if (verifyBtn) verifyBtn.style.display = 'flex';\n            if (verifySubmitBtn) verifySubmitBtn.style.display = 'block';\n            if (deleteInvalidModalBtn) deleteInvalidModalBtn.style.display = 'none';\n        }\n\n        // Função para atualizar interface do arquivo\n        function updateFileInterface() {\n            const file = csvFileInput.files[0];\n            if (file) {\n                fileUpload.classList.add('has-file');\n                fileName.style.display = 'block';\n                fileName.textContent = file.name;\n                \n                // Resetar estado de importação quando novo arquivo for selecionado\n                resetImportState();\n            } else {\n                fileUpload.classList.remove('has-file');\n                fileName.style.display = 'none';\n                fileName.textContent = '';\n                \n                // Resetar estado quando arquivo for removido\n                resetImportState();\n            }\n        }\n\n        // Função para resetar estado de importação\n        function resetImportState() {\n            console.log('🔄 Resetando estado de importação...');\n            \n            // Resetar dados de importação\n            importContacts = [];\n            invalidNumbersData = [];\n            \n            // Resetar interface de verificação\n            const importVerificationResults = document.getElementById('importVerificationResults');\n            const importVerificationSummary = document.getElementById('importVerificationSummary');\n            const importVerificationProgress = document.getElementById('importVerificationProgress');\n            const importVerificationProgressBar = document.getElementById('importVerificationProgressBar');\n            const importValidCount = document.getElementById('importValidCount');\n            const importInvalidCount = document.getElementById('importInvalidCount');\n            const importDuplicateCount = document.getElementById('importDuplicateCount');\n            const invalidNumbersContainer = document.getElementById('invalidNumbersContainer');\n            const importSubmitBtn = document.getElementById('importSubmitBtn');\n            const saveValidContactsBtn = document.getElementById('saveValidContactsBtn');\n            \n            if (importVerificationResults) importVerificationResults.style.display = 'none';\n            if (importVerificationSummary) importVerificationSummary.style.display = 'none';\n            if (importVerificationProgress) importVerificationProgress.textContent = '0%';\n            if (importVerificationProgressBar) importVerificationProgressBar.style.width = '0%';\n            if (importValidCount) importValidCount.textContent = '0';\n            if (importInvalidCount) importInvalidCount.textContent = '0';\n            if (importDuplicateCount) importDuplicateCount.textContent = '0';\n            if (invalidNumbersContainer) invalidNumbersContainer.style.display = 'none';\n            \n            // Resetar botões\n            if (importSubmitBtn) importSubmitBtn.style.display = 'block';\n            if (saveValidContactsBtn) saveValidContactsBtn.style.display = 'none';\n            \n            // Remover classe de tamanho do modal\n            const modalContent = document.querySelector('#importModal .modal-content');\n            if (modalContent) modalContent.classList.remove('with-invalid-table');\n            \n            // Limpar mensagens\n            const importModalMessage = document.getElementById('importModalMessage');\n            if (importModalMessage) {\n                importModalMessage.textContent = '';\n                importModalMessage.className = 'message';\n            }\n            \n            console.log('✅ Estado de importação resetado');\n        }\n\n        // Download do arquivo de exemplo\n        function downloadExampleCSV() {\n            const headers = ['nome', 'telefone', ...variables];\n            \n            // Criar dados de exemplo baseados nas variáveis\n            const exampleData = [\n                ['João Silva', '5548984549300'],\n                ['Maria Santos', '5511987654321'],\n                ['Pedro Costa', '5511976543210']\n            ];\n            \n            // Adicionar valores de exemplo para cada variável\n            exampleData.forEach((row, index) => {\n                variables.forEach(variable => {\n                    row.push(`${variable}${index + 1}`);\n                });\n            });\n            \n            let csvContent = headers.join(',') + '\\n';\n            exampleData.forEach(row => {\n                csvContent += row.join(',') + '\\n';\n            });\n            \n            const blob = new Blob([csvContent], { type: 'text/csv' });\n            const url = window.URL.createObjectURL(blob);\n            const a = document.createElement('a');\n            a.href = url;\n            a.download = 'exemplo-contatos.csv';\n            document.body.appendChild(a);\n            a.click();\n            document.body.removeChild(a);\n            window.URL.revokeObjectURL(url);\n        }\n\n        // Navegação simplificada (sem parâmetros de autenticação)\n        function navigateToPage(url) {\n            window.location.href = url;\n        }\n\n        // ===== FUNÇÕES WHATSAPP MODAL =====\n\n        // Renderizar lista de contatos do WhatsApp\n        function renderWhatsAppContactsList() {\n            if (whatsappContacts.length === 0) {\n                whatsappContactsList.innerHTML = '<div style=\"padding: 20px; text-align: center; color: #888;\">Nenhum contato encontrado</div>';\n                whatsappContactsCount.textContent = '0 contatos encontrados';\n                return;\n            }\n\n            // Obter telefones existentes na lista atual (apenas números)\n            const existingPhones = contacts.map(contact => {\n                return contact.phone.replace(/\\D/g, '');\n            });\n\n            // Verificar duplicatas e marcar contatos\n            whatsappContacts.forEach(contact => {\n                const whatsappPhone = contact.phone.split('@')[0].replace(/\\D/g, '');\n                contact.isDuplicate = existingPhones.includes(whatsappPhone);\n            });\n\n            whatsappContactsList.innerHTML = whatsappContacts.map((contact, index) => {\n                const duplicateClass = contact.isDuplicate ? 'duplicate' : '';\n                const duplicateBadge = contact.isDuplicate ? '<span class=\"duplicate-badge\">JÁ EXISTE</span>' : '';\n                \n                return `\n                    <div class=\"whatsapp-contact-item ${duplicateClass}\">\n                        <input type=\"checkbox\" class=\"whatsapp-contact-checkbox\" id=\"whatsapp-contact-${index}\" \n                               ${contact.selected ? 'checked' : ''} \n                               onchange=\"toggleWhatsAppContact(${index})\">\n                        <div class=\"whatsapp-contact-info\">\n                            <div class=\"whatsapp-contact-name\">${contact.name}</div>\n                            <div class=\"whatsapp-contact-phone\">${formatWhatsAppPhone(contact.phone)}</div>\n                        </div>\n                        ${duplicateBadge}\n                    </div>\n                `;\n            }).join('');\n\n            updateWhatsAppContactsCount();\n        }\n\n        // Alternar seleção de um contato\n        function toggleWhatsAppContact(index) {\n            if (whatsappContacts[index]) {\n                whatsappContacts[index].selected = !whatsappContacts[index].selected;\n                updateWhatsAppContactsCount();\n            }\n        }\n\n        // Selecionar/desmarcar todos os contatos\n        function selectAllWhatsAppContacts(selectAll) {\n            whatsappContacts.forEach(contact => {\n                contact.selected = selectAll;\n            });\n            \n            // Atualizar checkboxes na interface\n            const checkboxes = whatsappContactsList.querySelectorAll('.whatsapp-contact-checkbox');\n            checkboxes.forEach(checkbox => {\n                checkbox.checked = selectAll;\n            });\n            \n            updateWhatsAppContactsCount();\n        }\n\n        // Atualizar contador de contatos selecionados\n        function updateWhatsAppContactsCount() {\n            const selectedCount = whatsappContacts.filter(contact => contact.selected).length;\n            const totalCount = whatsappContacts.length;\n            const newContactsCount = whatsappContacts.filter(contact => contact.selected && !contact.isDuplicate).length;\n            const duplicateSelectedCount = whatsappContacts.filter(contact => contact.selected && contact.isDuplicate).length;\n            \n            let countText = `${selectedCount} de ${totalCount} contatos selecionados`;\n            \n            if (duplicateSelectedCount > 0) {\n                countText += ` (${newContactsCount} novos, ${duplicateSelectedCount} já existem)`;\n            }\n            \n            whatsappContactsCount.textContent = countText;\n            \n            // Habilitar/desabilitar botão de salvar baseado na seleção de contatos novos\n            saveWhatsAppContactsBtn.disabled = newContactsCount === 0;\n        }\n\n        // Formatar telefone do WhatsApp para exibição\n        function formatWhatsAppPhone(remoteJid) {\n            if (!remoteJid) return '';\n            \n            // Extrair número do remoteJid (ex: \"5519987553228@s.whatsapp.net\" -> \"5519987553228\")\n            const phone = remoteJid.split('@')[0];\n            \n            // Formatar número individual\n            if (phone.length >= 10) {\n                // Assumir formato brasileiro: 55(XX)XXXXX-XXXX\n                if (phone.length === 13 && phone.startsWith('55')) {\n                    const ddd = phone.substring(2, 4);\n                    const numero = phone.substring(4);\n                    const parte1 = numero.substring(0, numero.length - 4);\n                    const parte2 = numero.substring(numero.length - 4);\n                    return `55(${ddd})${parte1}-${parte2}`;\n                }\n            }\n            \n            return phone;\n        }\n\n        // Salvar contatos selecionados do WhatsApp\n        async function saveSelectedWhatsAppContacts() {\n            const selectedContacts = whatsappContacts.filter(contact => contact.selected);\n            \n            if (selectedContacts.length === 0) {\n                showMessage(pullWhatsAppModalMessage, 'ℹ️ Selecione pelo menos um contato para salvar.', 'info');\n                return;\n            }\n\n            setButtonLoading(saveWhatsAppContactsBtn, true);\n\n            try {\n            const userId = getSecureUserId();\n                const idLista = getCookie('idLista');\n                \n                if (!userId) {\n                    throw new Error('ID do usuário não encontrado');\n                }\n\n                if (!idLista) {\n                    throw new Error('ID da lista não encontrado');\n                }\n\n                // Obter telefones existentes na lista atual (apenas números)\n                const existingPhones = contacts.map(contact => {\n                    // Extrair apenas números do telefone\n                    return contact.phone.replace(/\\D/g, '');\n                });\n\n                console.log('📋 Telefones existentes na lista:', existingPhones);\n\n                // Filtrar contatos que NÃO existem na lista\n                const newContactsOnly = selectedContacts.filter(contact => {\n                    // Extrair apenas números do telefone do WhatsApp\n                    const whatsappPhone = contact.phone.split('@')[0].replace(/\\D/g, '');\n                    const phoneExists = existingPhones.includes(whatsappPhone);\n                    \n                    if (phoneExists) {\n                        console.log(`📞 Telefone ${whatsappPhone} já existe na lista, pulando...`);\n                    }\n                    \n                    return !phoneExists;\n                });\n\n                console.log(`📊 Contatos selecionados: ${selectedContacts.length}`);\n                console.log(`📊 Contatos novos (não duplicados): ${newContactsOnly.length}`);\n                console.log(`📊 Contatos filtrados (já existentes): ${selectedContacts.length - newContactsOnly.length}`);\n\n                // Se não há contatos novos, mostrar mensagem\n                if (newContactsOnly.length === 0) {\n                    showMessage(pullWhatsAppModalMessage, `ℹ️ Todos os ${selectedContacts.length} contato(s) selecionado(s) já existem na lista.`, 'info');\n                    setButtonLoading(saveWhatsAppContactsBtn, false);\n                    return;\n                }\n\n                // Se alguns contatos foram filtrados, mostrar aviso\n                if (newContactsOnly.length < selectedContacts.length) {\n                    const filteredCount = selectedContacts.length - newContactsOnly.length;\n                    showMessage(pullWhatsAppModalMessage, `ℹ️ ${filteredCount} contato(s) já existem na lista e foram ignorados. Salvando ${newContactsOnly.length} contato(s) novo(s)...`, 'info');\n                }\n\n                // Preparar contatos para envio (formato da API de criar-contatos)\n                const contactsToSave = newContactsOnly.map(contact => ({\n                    nome: contact.name,\n                    telefone: contact.phone.split('@')[0], // Remover @s.whatsapp.net\n                    userId: userId,\n                    idLista: parseInt(idLista)\n                }));\n\n                console.log('💾 Salvando contatos novos:', contactsToSave);\n\n                const response = await fetch('https://n8n.typebot.pro/webhook/criar-contatos', {\n                    method: 'POST',\n                    headers: {\n                        'Content-Type': 'application/json',\n                    },\n                    body: JSON.stringify(contactsToSave)\n                });\n\n                if (!response.ok) {\n                    const errorText = await response.text();\n                    throw new Error(`Erro ao salvar contatos: ${response.status} - ${errorText}`);\n                }\n\n                const responseData = await response.json();\n                console.log('✅ Contatos salvos:', responseData);\n\n                const successMessage = newContactsOnly.length < selectedContacts.length \n                    ? `✅ ${newContactsOnly.length} contato(s) novo(s) salvos com sucesso! (${selectedContacts.length - newContactsOnly.length} contato(s) já existiam na lista)`\n                    : `✅ ${newContactsOnly.length} contato(s) salvos com sucesso!`;\n\n                showMessage(pullWhatsAppModalMessage, successMessage, 'success');\n                \n                // Fechar modal após sucesso\n                setTimeout(() => {\n                    closePullWhatsAppModal();\n                    // Recarregar contatos da lista para mostrar os novos\n                    loadContacts();\n                }, 2000);\n\n            } catch (error) {\n                console.error('❌ Erro ao salvar contatos:', error);\n                showMessage(pullWhatsAppModalMessage, `❌ ${error.message}`, 'error');\n            } finally {\n                setButtonLoading(saveWhatsAppContactsBtn, false);\n            }\n        }\n\n        // Carregar conexões para o modal WhatsApp\n        async function loadConnections() {\n            console.log('🔄 Carregando conexões...');\n            \n            try {\n                const userId = getSecureUserId();\n                if (!userId) {\n                    throw new Error('ID do usuário não encontrado');\n                }\n\n                const response = await fetch('https://n8n.typebot.pro/webhook/listarconexoes', {\n                    method: 'POST',\n                    headers: {\n                        'Content-Type': 'application/json',\n                    },\n                    body: JSON.stringify({ userId: userId })\n                });\n\n                if (!response.ok) {\n                    const errorText = await response.text();\n                    throw new Error(`Erro ao carregar conexões: ${response.status} - ${errorText}`);\n                }\n\n                const responseData = await response.json();\n                console.log('✅ Conexões carregadas:', responseData);\n                \n                // Carregar também para o modal de importação\n                await loadImportConnections();\n\n                // Processar conexões da resposta (igual lista-grupos.html)\n                let rawConnections = [];\n                if (responseData && responseData.Conexoes && Array.isArray(responseData.Conexoes)) {\n                    rawConnections = responseData.Conexoes;\n                    console.log('✅ Conexões extraídas do campo \"Conexoes\":', rawConnections);\n                } else if (Array.isArray(responseData) && responseData.length > 0 && responseData[0].Conexoes && Array.isArray(responseData[0].Conexoes)) {\n                    rawConnections = responseData[0].Conexoes;\n                    console.log('✅ Conexões extraídas do campo \"Conexoes\" (array aninhado):', rawConnections);\n                } else if (responseData && responseData.data && Array.isArray(responseData.data)) {\n                    rawConnections = responseData.data;\n                    console.log('✅ Conexões extraídas do campo \"data\":', rawConnections);\n                } else if (Array.isArray(responseData)) {\n                    rawConnections = responseData;\n                    console.log('✅ Conexões extraídas como array direto:', rawConnections);\n                } else {\n                    rawConnections = [];\n                    console.log('⚠️ Nenhuma estrutura de conexões reconhecida');\n                }\n\n                // Filtrar conexões válidas\n                connections = rawConnections.filter(conn => (conn.instanceName || conn.instance_name) && (conn.NomeConexao || conn.nomeConexao || conn.name));\n                \n                // Inicializar todas as conexões como \"verificando\" status\n                connections.forEach(conn => {\n                    conn.isConnected = null; // null = verificando\n                    conn.isVerifying = true;\n                });\n\n                // Renderizar dropdown imediatamente com status \"verificando\"\n                renderConnectionsDropdown();\n\n                // Adicionar indicador de progresso\n                let verificationsCompleted = 0;\n                const totalConnections = connections.length;\n                updateVerificationProgress(verificationsCompleted, totalConnections);\n\n                // Verificar status real de cada conexão em background (paralelo)\n                const statusPromises = connections.map(async (conn, index) => {\n                    try {\n                        const instanceName = conn.instanceName || conn.instance_name;\n                        if (!instanceName) { \n                            conn.isConnected = false;\n                            conn.isVerifying = false;\n                            updateConnectionOption(index, conn, false);\n                            verificationsCompleted++;\n                            updateVerificationProgress(verificationsCompleted, totalConnections);\n                            return; \n                        }\n                        \n                        console.log(`🔍 Verificando status da conexão ${instanceName}...`);\n                        \n                        const statusResp = await fetch(`https://whatsapi.typebot.pro/instance/connectionState/${instanceName}`, {\n                            method: 'GET',\n                            headers: { 'apikey': 'b4d71f9c38e3ac12a6b08e4b6d53aa90' }\n                        });\n                        \n                        if (!statusResp.ok) { \n                            conn.isConnected = false;\n                            conn.isVerifying = false;\n                            updateConnectionOption(index, conn, false);\n                            verificationsCompleted++;\n                            updateVerificationProgress(verificationsCompleted, totalConnections);\n                            return; \n                        }\n                        \n                        const statusData = await statusResp.json();\n                        const state = statusData?.instance?.state || statusData?.state || statusData?.status || statusData?.connectionState;\n                        const isConnected = (state === 'open' || state === 'connected');\n                        conn.isConnected = isConnected;\n                        conn.isVerifying = false;\n                        \n                        console.log(`✅ Status da conexão ${instanceName}:`, {\n                            state,\n                            isConnected: conn.isConnected\n                        });\n                        \n                        // Atualizar a opção específica no dropdown\n                        updateConnectionOption(index, conn, isConnected);\n                        verificationsCompleted++;\n                        updateVerificationProgress(verificationsCompleted, totalConnections);\n                        \n                    } catch (error) { \n                        console.error(`❌ Erro ao verificar status da conexão ${conn.instanceName}:`, error);\n                        conn.isConnected = false; \n                        conn.isVerifying = false;\n                        updateConnectionOption(index, conn, false);\n                        verificationsCompleted++;\n                        updateVerificationProgress(verificationsCompleted, totalConnections);\n                    }\n                });\n\n                // Aguardar todas as verificações em paralelo (não bloqueia a interface)\n                await Promise.all(statusPromises);\n                console.log('✅ Todas as verificações de status concluídas');\n                hideVerificationProgress();\n\n            } catch (error) {\n                console.error('❌ Erro ao carregar conexões:', error);\n                showMessage(pullWhatsAppModalMessage, `❌ ${error.message}`, 'error');\n                connectionsLoading.style.display = 'none';\n                connectionSelect.style.display = 'block';\n            }\n        }\n\n        // Carregar conexões para o modal de importação\n        async function loadImportConnections() {\n            console.log('🔄 Carregando conexões para modal de importação...');\n            \n            try {\n                // Verificar se os elementos existem\n                if (!importConnectionsLoading || !importConnectionSelect) {\n                    console.error('❌ Elementos do modal de importação não encontrados');\n                    return;\n                }\n                \n                // Mostrar loading\n                importConnectionsLoading.style.display = 'flex';\n                importConnectionSelect.style.display = 'none';\n                \n                const userId = getSecureUserId();\n                if (!userId) {\n                    throw new Error('ID do usuário não encontrado');\n                }\n\n                console.log('🔍 Fazendo requisição para carregar conexões...');\n                const response = await fetch('https://n8n.typebot.pro/webhook/listarconexoes', {\n                    method: 'POST',\n                    headers: {\n                        'Content-Type': 'application/json',\n                    },\n                    body: JSON.stringify({ userId: userId })\n                });\n\n                if (!response.ok) {\n                    const errorText = await response.text();\n                    throw new Error(`Erro ao carregar conexões: ${response.status} - ${errorText}`);\n                }\n\n                const responseData = await response.json();\n                console.log('✅ Conexões carregadas para importação:', responseData);\n\n                // Processar conexões da resposta\n                let rawConnections = [];\n                if (responseData && responseData.Conexoes && Array.isArray(responseData.Conexoes)) {\n                    rawConnections = responseData.Conexoes;\n                    console.log('✅ Conexões extraídas do campo \"Conexoes\":', rawConnections);\n                } else if (Array.isArray(responseData) && responseData.length > 0 && responseData[0].Conexoes && Array.isArray(responseData[0].Conexoes)) {\n                    rawConnections = responseData[0].Conexoes;\n                    console.log('✅ Conexões extraídas do campo \"Conexoes\" (array aninhado):', rawConnections);\n                } else if (responseData && responseData.data && Array.isArray(responseData.data)) {\n                    rawConnections = responseData.data;\n                    console.log('✅ Conexões extraídas do campo \"data\":', rawConnections);\n                } else if (Array.isArray(responseData)) {\n                    rawConnections = responseData;\n                    console.log('✅ Conexões extraídas como array direto:', rawConnections);\n                } else {\n                    rawConnections = [];\n                    console.log('⚠️ Nenhuma estrutura de conexões reconhecida');\n                }\n\n                // Filtrar conexões válidas\n                const importConnections = rawConnections.filter(conn => (conn.instanceName || conn.instance_name) && (conn.NomeConexao || conn.nomeConexao || conn.name));\n                console.log('✅ Conexões filtradas para importação:', importConnections);\n                \n                // Inicializar todas as conexões como \"verificando\" status\n                importConnections.forEach(conn => {\n                    conn.isConnected = null;\n                    conn.isVerifying = true;\n                });\n\n                // Renderizar dropdown imediatamente\n                console.log('🎨 Renderizando dropdown de importação...');\n                renderImportConnectionsDropdown(importConnections);\n\n                // Verificar status em background\n                console.log('🔍 Iniciando verificação de status das conexões...');\n                const statusPromises = importConnections.map(async (conn, index) => {\n                    try {\n                        const instanceName = conn.instanceName || conn.instance_name;\n                        if (!instanceName) { \n                            console.log(`⚠️ Conexão sem instanceName:`, conn);\n                            conn.isConnected = false;\n                            conn.isVerifying = false;\n                            updateImportConnectionOption(index, conn, false);\n                            return; \n                        }\n                        \n                        console.log(`🔍 Verificando status da conexão ${instanceName}...`);\n                        const statusResp = await fetch(`https://whatsapi.typebot.pro/instance/connectionState/${instanceName}`, {\n                            method: 'GET',\n                            headers: { 'apikey': 'b4d71f9c38e3ac12a6b08e4b6d53aa90' }\n                        });\n                        \n                        if (!statusResp.ok) { \n                            console.log(`❌ Status da conexão ${instanceName}: ${statusResp.status}`);\n                            conn.isConnected = false;\n                            conn.isVerifying = false;\n                            updateImportConnectionOption(index, conn, false);\n                            return; \n                        }\n                        \n                        const statusData = await statusResp.json();\n                        const state = statusData?.instance?.state || statusData?.state || statusData?.status || statusData?.connectionState;\n                        const isConnected = (state === 'open' || state === 'connected');\n                        conn.isConnected = isConnected;\n                        conn.isVerifying = false;\n                        \n                        console.log(`✅ Status da conexão ${instanceName}: ${state} (conectada: ${isConnected})`);\n                        updateImportConnectionOption(index, conn, isConnected);\n                        \n                    } catch (error) { \n                        console.error(`❌ Erro ao verificar status da conexão ${conn.instanceName}:`, error);\n                        conn.isConnected = false; \n                        conn.isVerifying = false;\n                        updateImportConnectionOption(index, conn, false);\n                    }\n                });\n\n                await Promise.all(statusPromises);\n                console.log('✅ Verificações de status concluídas para modal de importação');\n\n            } catch (error) {\n                console.error('❌ Erro ao carregar conexões para importação:', error);\n                showMessage(importModalMessage, `❌ ${error.message}`, 'error');\n                importConnectionsLoading.style.display = 'none';\n                importConnectionSelect.style.display = 'block';\n            }\n        }\n\n        // Renderizar dropdown de conexões para importação\n        function renderImportConnectionsDropdown(importConnections) {\n            console.log('🎨 Renderizando dropdown de importação com', importConnections.length, 'conexões');\n            \n            if (importConnections.length === 0) {\n                console.log('⚠️ Nenhuma conexão encontrada para importação');\n                importConnectionSelect.innerHTML = '<option value=\"\">Nenhuma conexão encontrada</option>';\n            } else {\n                // Renderizar com status inicial \"verificando\" usando innerHTML para melhor styling\n                const optionsHtml = importConnections.map(conn => {\n                    const nome = conn.NomeConexao || conn.nomeConexao || conn.name;\n                    const instance = conn.instanceName || conn.instance_name;\n                    console.log(`📝 Adicionando opção: ${nome} (${instance})`);\n                    return `<option value=\"${instance}\" data-connected=\"checking\" style=\"color: #888; background-color: rgba(136, 136, 136, 0.1);\">🔄 ${nome} (verificando...)</option>`;\n                }).join('');\n                \n                importConnectionSelect.innerHTML = '<option value=\"\">Selecione...</option>' + optionsHtml;\n                console.log('✅ Dropdown de importação renderizado com', importConnections.length, 'opções');\n            }\n\n            console.log('🔄 Ocultando loading e mostrando dropdown...');\n            importConnectionsLoading.style.display = 'none';\n            importConnectionSelect.style.display = 'block';\n            console.log('✅ Dropdown de importação exibido');\n        }\n\n        // Atualizar opção específica do dropdown de importação\n        function updateImportConnectionOption(index, conn, isConnected) {\n            const nome = conn.NomeConexao || conn.nomeConexao || conn.name;\n            const instance = conn.instanceName || conn.instance_name;\n            const status = isConnected ? '✅ ' : '❌ ';\n            const statusText = isConnected ? 'Conectada' : 'Desconectada';\n            const textColor = isConnected ? '#25d366' : '#ff4444';\n            const backgroundColor = isConnected ? 'rgba(37, 211, 102, 0.1)' : 'rgba(255, 68, 68, 0.1)';\n            \n            // Encontrar a opção correta no select (index + 1 porque a primeira é \"Selecione...\")\n            const option = importConnectionSelect.options[index + 1];\n            if (option) {\n                option.innerHTML = `${status}${nome} (${statusText})`;\n                option.style.color = textColor;\n                option.style.backgroundColor = backgroundColor;\n                option.style.fontWeight = isConnected ? '600' : '400';\n                option.setAttribute('data-connected', isConnected ? '1' : '0');\n                option.disabled = !isConnected; // Só permite selecionar se conectada\n            }\n            \n            console.log(`🔄 Opção de importação atualizada: ${nome} - ${isConnected ? 'Conectada' : 'Desconectada'}`);\n        }\n\n        // Renderizar dropdown de conexões (com status \"verificando\" inicial)\n        function renderConnectionsDropdown() {\n            console.log('🎨 Renderizando dropdown de conexões...');\n            \n            // Limpar opções existentes (manter apenas a primeira)\n            connectionSelect.innerHTML = '<option value=\"\">Selecione uma conexão...</option>';\n\n            if (connections.length === 0) {\n                connectionSelect.innerHTML += '<option value=\"\" disabled>Nenhuma conexão encontrada</option>';\n            } else {\n                // Renderizar com status inicial \"verificando\" usando innerHTML para melhor styling\n                connectionSelect.innerHTML = '<option value=\"\">Selecione...</option>' +\n                    connections.map(conn => {\n                        const nome = conn.NomeConexao || conn.nomeConexao || conn.name;\n                        const instance = conn.instanceName || conn.instance_name;\n                        return `<option value=\"${instance}\" data-connected=\"checking\" style=\"color: #888; background-color: rgba(136, 136, 136, 0.1);\">🔄 ${nome} (verificando...)</option>`;\n                    }).join('');\n            }\n\n            // Esconder loading e mostrar dropdown\n            connectionsLoading.style.display = 'none';\n            connectionSelect.style.display = 'block';\n        }\n\n        // Atualizar uma opção específica do dropdown após verificar status\n        function updateConnectionOption(index, conn, isConnected) {\n            const nome = conn.NomeConexao || conn.nomeConexao || conn.name;\n            const instance = conn.instanceName || conn.instance_name;\n            const status = isConnected ? '✅ ' : '❌ ';\n            const statusText = isConnected ? 'Conectada' : 'Desconectada';\n            const textColor = isConnected ? '#25d366' : '#ff4444';\n            const backgroundColor = isConnected ? 'rgba(37, 211, 102, 0.1)' : 'rgba(255, 68, 68, 0.1)';\n            \n            // Encontrar a opção correta no select (index + 1 porque a primeira é \"Selecione...\")\n            const option = connectionSelect.options[index + 1];\n            if (option) {\n                option.innerHTML = `${status}${nome} (${statusText})`;\n                option.style.color = textColor;\n                option.style.backgroundColor = backgroundColor;\n                option.style.fontWeight = isConnected ? '600' : '400';\n                option.setAttribute('data-connected', isConnected ? '1' : '0');\n                option.disabled = !isConnected; // Só permite selecionar se conectada\n            }\n            \n            console.log(`🔄 Opção atualizada: ${nome} - ${isConnected ? 'Conectada' : 'Desconectada'}`);\n        }\n\n        // Validar conexão selecionada para importação\n        function onImportConnectionSelect() {\n            const selectedValue = importConnectionSelect.value;\n            const selectedOption = importConnectionSelect.options[importConnectionSelect.selectedIndex];\n            const submitButton = importForm.querySelector('button[type=\"submit\"]');\n            const connectionStatus = selectedOption && selectedOption.getAttribute('data-connected');\n            const isConnected = connectionStatus === '1';\n            const isChecking = connectionStatus === 'checking';\n            \n            // Atualizar cor do select baseado no status da conexão selecionada (igual outros dropdowns)\n            if (isConnected) {\n                importConnectionSelect.style.color = '#25d366';\n                importConnectionSelect.style.backgroundColor = 'rgba(37, 211, 102, 0.08)';\n                importConnectionSelect.style.borderColor = 'rgba(37, 211, 102, 0.3)';\n            } else if (isChecking) {\n                importConnectionSelect.style.color = '#888';\n                importConnectionSelect.style.backgroundColor = 'rgba(136, 136, 136, 0.08)';\n                importConnectionSelect.style.borderColor = 'rgba(136, 136, 136, 0.3)';\n            } else if (connectionStatus === '0') {\n                importConnectionSelect.style.color = '#ff4444';\n                importConnectionSelect.style.backgroundColor = 'rgba(255, 68, 68, 0.08)';\n                importConnectionSelect.style.borderColor = 'rgba(255, 68, 68, 0.3)';\n            } else {\n                // Reset para padrão quando seleciona \"Selecione...\"\n                importConnectionSelect.style.color = 'white';\n                importConnectionSelect.style.backgroundColor = 'rgba(255, 255, 255, 0.05)';\n                importConnectionSelect.style.borderColor = 'rgba(255, 255, 255, 0.2)';\n            }\n            \n            if (selectedValue) {\n                if (isConnected) {\n                    submitButton.disabled = false;\n                    showMessage(importModalMessage, '', ''); // Limpar mensagens\n                } else if (isChecking) {\n                    submitButton.disabled = true;\n                    showMessage(importModalMessage, 'Verificando status da conexão...', 'info');\n                } else if (!isConnected) {\n                    // Resetar seleção se conexão desconectada\n                    importConnectionSelect.value = '';\n                    submitButton.disabled = true;\n                    // Reset cor quando deseleciona\n                    importConnectionSelect.style.color = 'white';\n                    importConnectionSelect.style.backgroundColor = 'rgba(255, 255, 255, 0.05)';\n                    importConnectionSelect.style.borderColor = 'rgba(255, 255, 255, 0.2)';\n                    showMessage(importModalMessage, 'Conexão desconectada. Conecte o WhatsApp antes de importar contatos.', 'error');\n                } else {\n                    submitButton.disabled = true;\n                    showMessage(importModalMessage, '', ''); // Limpar mensagens\n                }\n            } else {\n                submitButton.disabled = true;\n                showMessage(importModalMessage, '', ''); // Limpar mensagens\n            }\n        }\n\n        // Verificar se conexão selecionada está conectada e ativar botão (igual lista-grupos.html)\n        function onConnectionSelect() {\n            const selectedValue = connectionSelect.value;\n            const selectedOption = connectionSelect.options[connectionSelect.selectedIndex];\n            const submitButton = pullWhatsAppForm.querySelector('button[type=\"submit\"]');\n            const connectionStatus = selectedOption && selectedOption.getAttribute('data-connected');\n            const isConnected = connectionStatus === '1';\n            const isChecking = connectionStatus === 'checking';\n            \n            // Atualizar cor do select baseado no status da conexão selecionada (igual lista-grupos.html)\n            if (isConnected) {\n                connectionSelect.style.color = '#25d366';\n                connectionSelect.style.backgroundColor = 'rgba(37, 211, 102, 0.08)';\n                connectionSelect.style.borderColor = 'rgba(37, 211, 102, 0.3)';\n            } else if (isChecking) {\n                connectionSelect.style.color = '#888';\n                connectionSelect.style.backgroundColor = 'rgba(136, 136, 136, 0.08)';\n                connectionSelect.style.borderColor = 'rgba(136, 136, 136, 0.3)';\n            } else if (connectionStatus === '0') {\n                connectionSelect.style.color = '#ff4444';\n                connectionSelect.style.backgroundColor = 'rgba(255, 68, 68, 0.08)';\n                connectionSelect.style.borderColor = 'rgba(255, 68, 68, 0.3)';\n            } else {\n                // Reset para padrão quando seleciona \"Selecione...\"\n                connectionSelect.style.color = 'white';\n                connectionSelect.style.backgroundColor = 'rgba(255, 255, 255, 0.05)';\n                connectionSelect.style.borderColor = 'rgba(255, 255, 255, 0.2)';\n            }\n            \n            if (selectedValue) {\n                const selectedConnection = connections.find(conn => \n                    (conn.instanceName || conn.instance_name) === selectedValue\n                );\n                \n                if (selectedConnection && isConnected) {\n                    submitButton.disabled = false;\n                    showMessage(pullWhatsAppModalMessage, '', ''); // Limpar mensagens\n                    console.log('✅ Conexão conectada selecionada:', selectedValue);\n                } else if (selectedConnection && isChecking) {\n                    submitButton.disabled = true;\n                    showMessage(pullWhatsAppModalMessage, 'Verificando status da conexão...', 'info');\n                    console.log('🔄 Conexão ainda sendo verificada:', selectedValue);\n                } else if (selectedConnection && !isConnected) {\n                    // Resetar seleção se conexão desconectada (igual lista-grupos.html)\n                    connectionSelect.value = '';\n                    submitButton.disabled = true;\n                    // Reset cor quando deseleciona\n                    connectionSelect.style.color = 'white';\n                    connectionSelect.style.backgroundColor = 'rgba(255, 255, 255, 0.05)';\n                    connectionSelect.style.borderColor = 'rgba(255, 255, 255, 0.2)';\n                    showMessage(pullWhatsAppModalMessage, 'Conexão desconectada. Conecte o WhatsApp antes de puxar contatos.', 'error');\n                    console.log('❌ Conexão desconectada selecionada, resetando seleção:', selectedValue);\n                } else {\n                    submitButton.disabled = true;\n                    showMessage(pullWhatsAppModalMessage, '', ''); // Limpar mensagens\n                    console.log('⚠️ Conexão não encontrada:', selectedValue);\n                }\n                \n                console.log('🔍 Validação da conexão selecionada:', {\n                    selectedValue,\n                    isConnected,\n                    dataConnected: selectedOption?.getAttribute('data-connected'),\n                    hasConnection: !!selectedConnection\n                });\n            } else {\n                submitButton.disabled = true;\n                showMessage(pullWhatsAppModalMessage, '', ''); // Limpar mensagens\n            }\n        }\n\n        // Event listeners\n        document.getElementById('closeVariableModal').addEventListener('click', closeVariableModal);\n        document.getElementById('closeContactModal').addEventListener('click', closeContactModal);\n        document.getElementById('closeImportModal').addEventListener('click', closeImportModal);\n        document.getElementById('closePullWhatsAppModal').addEventListener('click', closePullWhatsAppModal);\n        document.getElementById('closeVerifyNumbersModal').addEventListener('click', closeVerifyNumbersModal);\n        \n        // Prevenir propagação de eventos na tabela de números inválidos\n        document.addEventListener('click', function(e) {\n            if (e.target.closest('.invalid-numbers-table')) {\n                e.stopPropagation();\n            }\n        });\n        \n        // Event listener para mudança na seleção de conexão\n        connectionSelect.addEventListener('change', onConnectionSelect);\n        verifyConnectionSelect.addEventListener('change', onVerifyConnectionSelect);\n        importConnectionSelect.addEventListener('change', onImportConnectionSelect);\n        \n        // Event listener para arquivo selecionado\n        csvFileInput.addEventListener('change', updateFileInterface);\n        \n        // Event listener adicional para reset quando arquivo for limpo\n        csvFileInput.addEventListener('input', function() {\n            if (!this.files || this.files.length === 0) {\n                resetImportState();\n            }\n        });\n        \n        // Suporte para drag and drop\n        fileUpload.addEventListener('dragover', (e) => {\n            e.preventDefault();\n            fileUpload.style.borderColor = '#25d366';\n            fileUpload.style.background = 'rgba(37, 211, 102, 0.1)';\n        });\n        \n        fileUpload.addEventListener('dragleave', (e) => {\n            e.preventDefault();\n            if (!fileUpload.classList.contains('has-file')) {\n                fileUpload.style.borderColor = 'rgba(37, 211, 102, 0.3)';\n                fileUpload.style.background = 'transparent';\n            }\n        });\n        \n        fileUpload.addEventListener('drop', (e) => {\n            e.preventDefault();\n            fileUpload.style.borderColor = 'rgba(37, 211, 102, 0.3)';\n            fileUpload.style.background = 'transparent';\n            \n            const files = e.dataTransfer.files;\n            if (files.length > 0) {\n                const file = files[0];\n                if (file.type === 'text/csv' || file.name.endsWith('.csv')) {\n                    csvFileInput.files = files;\n                    updateFileInterface();\n                } else {\n                    showMessage(contactsMessage, '❌ Por favor, selecione um arquivo CSV válido', 'error');\n                }\n            }\n        });\n\n        variableModal.addEventListener('click', (e) => {\n            if (e.target === variableModal) closeVariableModal();\n        });\n\n        contactModal.addEventListener('click', (e) => {\n            if (e.target === contactModal) closeContactModal();\n        });\n\n        importModal.addEventListener('click', (e) => {\n            if (e.target === importModal) closeImportModal();\n        });\n\n        pullWhatsAppModal.addEventListener('click', (e) => {\n            if (e.target === pullWhatsAppModal) closePullWhatsAppModal();\n        });\n\n        verifyNumbersModal.addEventListener('click', (e) => {\n            if (e.target === verifyNumbersModal) closeVerifyNumbersModal();\n        });\n\n        // Formulário de variável\n        variableForm.addEventListener('submit', async (e) => {\n            e.preventDefault();\n            const name = variableNameInput.value.trim();\n            if (!name) return;\n\n            if (variables.includes(name)) {\n                showMessage(variableModalMessage, '❌ Esta variável já existe', 'error');\n                return;\n            }\n\n            // Mostrar loading no botão\n            const submitButton = variableForm.querySelector('button[type=\"submit\"]');\n            setButtonLoading(submitButton, true);\n\n            try {\n                const idLista = getCookie('idLista');\n                if (!idLista) {\n                    console.error('❌ idLista não encontrado nos cookies para criar variável');\n                    showMessage(variableModalMessage, '❌ Erro: ID da lista não encontrado', 'error');\n                    setButtonLoading(submitButton, false);\n                    return;\n                }\n\n                // Adicionar a nova variável ao array local\n                const updatedVariables = [...variables, name];\n                \n                const requestBody = {\n                    idLista: parseInt(idLista),\n                    variaveis: updatedVariables\n                };\n\n                console.log('Enviando variáveis para API:', requestBody);\n\n                const response = await fetch('https://n8n.typebot.pro/webhook/criar-variaveis', {\n                    method: 'POST',\n                    headers: {\n                        'Content-Type': 'application/json',\n                    },\n                    body: JSON.stringify(requestBody)\n                });\n\n                if (!response.ok) {\n                    const errorText = await response.text();\n                    showMessage(variableModalMessage, `❌ Erro ao criar variável: ${response.status} - ${errorText}`, 'error');\n                    setButtonLoading(submitButton, false);\n                    return;\n                }\n\n                const responseData = await response.json();\n                console.log('Resposta da API:', responseData);\n\n                // Atualizar o array local com todas as variáveis\n                variables = updatedVariables;\n                renderVariables();\n                showMessage(contactsMessage, `✅ Variável \"${name}\" criada com sucesso!`, 'success');\n                closeVariableModal();\n\n            } catch (error) {\n                console.error('Erro ao criar variável:', error);\n                showMessage(variableModalMessage, `❌ ${error.message}`, 'error');\n            } finally {\n                setButtonLoading(submitButton, false);\n            }\n        });\n\n\n\n\n\n        // Formulário de contato\n        contactForm.addEventListener('submit', async (e) => {\n            e.preventDefault();\n            const name = contactNameInput.value.trim();\n            // Limpar apenas caracteres não numéricos\n            const phone = contactPhoneInput.value.replace(/\\D/g, '');\n            \n            if (!name || !phone) return;\n\n            // Verificar se tem pelo menos alguns dígitos\n            if (phone.length < 8) {\n                showMessage(contactModalMessage, '❌ Telefone deve ter pelo menos 8 dígitos', 'error');\n                return;\n            }\n\n            // Coletar valores das variáveis\n            const contactVariables = {};\n            variables.forEach(variable => {\n                const value = document.getElementById(`var_${variable}`).value.trim();\n                if (value) {\n                    contactVariables[variable] = value;\n                }\n            });\n\n            // Mostrar loading no botão\n            const submitButton = contactForm.querySelector('button[type=\"submit\"]');\n            setButtonLoading(submitButton, true);\n\n            try {\n                const userId = getSecureUserId();\n                const idLista = getCookie('idLista');\n                \n                if (!userId) {\n                    showMessage(contactModalMessage, '❌ ID do usuário não encontrado', 'error');\n                    setButtonLoading(submitButton, false);\n                    return;\n                }\n\n                if (!idLista) {\n                    showMessage(contactModalMessage, '❌ ID da lista não encontrado', 'error');\n                    setButtonLoading(submitButton, false);\n                    return;\n                }\n\n                const requestBody = [{\n                    nome: name,\n                    telefone: phone,\n                    userId: userId,\n                    idLista: parseInt(idLista),\n                    variaveis: contactVariables\n                }];\n\n                console.log('Enviando contato para API:', requestBody);\n\n                const response = await fetch('https://n8n.typebot.pro/webhook/criar-contatos', {\n                    method: 'POST',\n                    headers: {\n                        'Content-Type': 'application/json',\n                    },\n                    body: JSON.stringify(requestBody)\n                });\n\n                if (!response.ok) {\n                    const errorText = await response.text();\n                    showMessage(contactModalMessage, `❌ Erro ao criar contato: ${response.status} - ${errorText}`, 'error');\n                    setButtonLoading(submitButton, false);\n                    return;\n                }\n\n                const responseData = await response.json();\n                console.log('Resposta da API:', responseData);\n\n                // Adicionar o novo contato localmente\n                const newContact = {\n                    id: (responseData && responseData.ids && responseData.ids[0]) || responseData.id || Date.now(),\n                    name,\n                    phone,\n                    added_at: new Date().toISOString().split('T')[0],\n                    variables: contactVariables\n                };\n\n                contacts.unshift(newContact);\n                renderContactsTable();\n                showMessage(contactsMessage, `✅ Contato \"${name}\" criado com sucesso!`, 'success');\n                closeContactModal();\n\n            } catch (error) {\n                console.error('Erro ao criar contato:', error);\n                showMessage(contactModalMessage, `❌ ${error.message}`, 'error');\n            } finally {\n                setButtonLoading(submitButton, false);\n            }\n        });\n\n        // Formulário de importação\n        importForm.addEventListener('submit', async (e) => {\n            e.preventDefault();\n            const file = csvFileInput.files[0];\n            if (!file) return;\n\n            // Mostrar loading no botão\n            const submitButton = importForm.querySelector('button[type=\"submit\"]');\n            setButtonLoading(submitButton, true);\n\n            try {\n                const userId = getSecureUserId();\n                const idLista = getCookie('idLista');\n                \n                if (!userId) {\n                    throw new Error('ID do usuário não encontrado');\n                }\n\n                if (!idLista) {\n                    throw new Error('ID da lista não encontrado');\n                }\n\n                const reader = new FileReader();\n                reader.onload = async function(e) {\n                    try {\n                        const csv = e.target.result;\n                        console.log('📄 CSV bruto:', csv.substring(0, 200) + '...');\n                        \n                        const lines = csv.split('\\n');\n                        console.log('📊 Total de linhas:', lines.length);\n                        console.log('📋 Primeira linha (cabeçalhos):', lines[0]);\n                        \n                        const headers = lines[0].split(',');\n                        console.log('🏷️ Cabeçalhos encontrados:', headers);\n                        console.log('🔍 Procurando por \"nome\":', headers.includes('nome'));\n                        console.log('🔍 Procurando por \"telefone\":', headers.includes('telefone'));\n                        \n                        // Limpar cabeçalhos de espaços e caracteres especiais\n                        const cleanHeaders = headers.map(header => header.trim().replace(/[\"\\r]/g, ''));\n                        console.log('🧹 Cabeçalhos limpos:', cleanHeaders);\n                        console.log('🔍 Procurando por \"nome\" (limpo):', cleanHeaders.includes('nome'));\n                        console.log('🔍 Procurando por \"telefone\" (limpo):', cleanHeaders.includes('telefone'));\n                        \n                        // Validar cabeçalhos\n                        if (!cleanHeaders.includes('nome') || !cleanHeaders.includes('telefone')) {\n                            console.error('❌ Cabeçalhos inválidos. Esperado: nome, telefone. Encontrado:', cleanHeaders);\n                            throw new Error(`CSV deve ter colunas \"nome\" e \"telefone\". Cabeçalhos encontrados: ${cleanHeaders.join(', ')}`);\n                        }\n\n                        // Processar linhas do CSV\n                        importContacts = [];\n                        console.log('📝 Processando linhas do CSV...');\n                        \n                        for (let i = 1; i < lines.length; i++) {\n                            if (lines[i].trim()) {\n                                const values = lines[i].split(',');\n                                console.log(`📋 Linha ${i}:`, values);\n                                \n                                // Limpar valores de espaços e caracteres especiais\n                                const cleanValues = values.map(value => value.trim().replace(/[\"\\r]/g, ''));\n                                console.log(`🧹 Linha ${i} limpa:`, cleanValues);\n                                \n                                // Encontrar índices das colunas nome e telefone\n                                const nomeIndex = cleanHeaders.indexOf('nome');\n                                const telefoneIndex = cleanHeaders.indexOf('telefone');\n                                \n                                console.log(`📍 Índices - nome: ${nomeIndex}, telefone: ${telefoneIndex}`);\n                                \n                                if (nomeIndex === -1 || telefoneIndex === -1) {\n                                    console.error(`❌ Não foi possível encontrar colunas nome ou telefone na linha ${i}`);\n                                    continue;\n                                }\n                                \n                                const nome = cleanValues[nomeIndex];\n                                let phoneNumber = cleanValues[telefoneIndex];\n                                \n                                console.log(`👤 Nome: ${nome}, 📱 Telefone original: ${phoneNumber}`);\n                                \n                                // Remover caracteres especiais e espaços, manter apenas números\n                                phoneNumber = phoneNumber.replace(/[^\\d]/g, '');\n                                console.log(`📱 Telefone limpo: ${phoneNumber}`);\n                                \n                                // Verificar se tem pelo menos alguns dígitos (filtro básico)\n                                if (phoneNumber.length >= 8) {\n                                    const contactVariables = {};\n                                    \n                                    // Adicionar variáveis (permitir CSV sem colunas de variáveis)\n                                    variables.forEach((variable, index) => {\n                                        const variableIndex = cleanHeaders.indexOf(variable);\n                                        if (variableIndex !== -1 && cleanValues[variableIndex] && cleanValues[variableIndex].trim()) {\n                                            contactVariables[variable] = cleanValues[variableIndex].trim();\n                                            console.log(`📊 Variável ${variable}: ${cleanValues[variableIndex].trim()}`);\n                                        }\n                                        // Se não existir a coluna, a variável fica vazia (não é obrigatória)\n                                    });\n\n                                    importContacts.push({\n                                        nome: nome,\n                                        telefone: phoneNumber,\n                                        userId: userId,\n                                        idLista: parseInt(idLista),\n                                        variaveis: contactVariables\n                                    });\n                                    \n                                    console.log(`✅ Contato adicionado: ${nome} - ${phoneNumber}`);\n                                } else {\n                                    console.log(`❌ Telefone inválido na linha ${i}: ${phoneNumber} (muito curto)`);\n                                }\n                            }\n                        }\n\n                        console.log('📋 Contatos do CSV processados:', importContacts.length);\n                        console.log('📊 Resumo do processamento:');\n                        console.log('   - Total de linhas no CSV:', lines.length);\n                        console.log('   - Cabeçalhos encontrados:', cleanHeaders);\n                        console.log('   - Variáveis da lista:', variables);\n                        console.log('   - Contatos válidos processados:', importContacts.length);\n\n                        // Sempre verificar números válidos via API do WhatsApp\n                        if (importContacts.length > 0) {\n                            // Verificar se uma conexão está selecionada\n                            const connectionSelect = document.getElementById('connectionSelectImport');\n                            const selectedInstanceName = connectionSelect.value;\n                            \n                            if (!selectedInstanceName) {\n                                showMessage(importModalMessage, '❌ Selecione uma conexão antes de verificar os números', 'error');\n                                return;\n                            }\n                            \n                            // Mostrar container de verificação\n                            importVerificationResults.style.display = 'block';\n                            importVerificationProgress.textContent = '0%';\n                            importVerificationProgressBar.style.width = '0%';\n\n                            showMessage(importModalMessage, `🔍 Verificando ${importContacts.length} números via WhatsApp...`, 'info');\n                            \n                            await verifyImportedNumbersViaAPI();\n\n                            showMessage(importModalMessage, '✅ Verificação concluída! Verifique os resultados abaixo.', 'success');\n                        } else {\n                            showMessage(importModalMessage, '❌ Nenhum número válido encontrado para verificar.', 'error');\n                        }\n                        \n                        // Ocultar botão de importar e mostrar botão de salvar\n                        importSubmitBtn.style.display = 'none';\n                        saveValidContactsBtn.style.display = 'block';\n\n                    } catch (error) {\n                        console.error('Erro ao processar CSV:', error);\n                        showMessage(importModalMessage, `❌ ${error.message}`, 'error');\n                    } finally {\n                        setButtonLoading(submitButton, false);\n                    }\n                };\n                reader.readAsText(file);\n\n            } catch (error) {\n                console.error('Erro ao importar contatos:', error);\n                showMessage(importModalMessage, `❌ ${error.message}`, 'error');\n                setButtonLoading(submitButton, false);\n            }\n        });\n\n        // Formulário de puxar contatos do WhatsApp\n        pullWhatsAppForm.addEventListener('submit', async (e) => {\n            e.preventDefault();\n            \n            const selectedInstanceName = connectionSelect.value;\n            if (!selectedInstanceName) {\n                showMessage(pullWhatsAppModalMessage, '❌ Por favor, selecione uma conexão', 'error');\n                return;\n            }\n\n            // Mostrar loading no botão\n            const submitButton = pullWhatsAppForm.querySelector('button[type=\"submit\"]');\n            setButtonLoading(submitButton, true);\n\n            try {\n                const userId = getSecureUserId();\n                if (!userId) {\n                    throw new Error('ID do usuário não encontrado');\n                }\n\n                console.log('📱 Puxando contatos do WhatsApp...');\n                console.log('instanceName:', selectedInstanceName);\n                console.log('userId:', userId);\n\n                const response = await fetch('https://n8n.typebot.pro/webhook/puxarcontato-wpp', {\n                            method: 'POST',\n                            headers: {\n                                'Content-Type': 'application/json',\n                            },\n                    body: JSON.stringify({\n                        userId: userId,\n                        instanceName: selectedInstanceName\n                    })\n                        });\n\n                        if (!response.ok) {\n                            const errorText = await response.text();\n                            throw new Error(`Erro ao puxar contatos: ${response.status} - ${errorText}`);\n                        }\n\n                        const responseData = await response.json();\n                        console.log('✅ Resposta da API:', responseData);\n\n                        // Processar resposta (formato: {data: Array})\n                        let contactsArray = [];\n                        if (responseData && responseData.data && Array.isArray(responseData.data)) {\n                            contactsArray = responseData.data;\n                        } else if (Array.isArray(responseData)) {\n                            contactsArray = responseData;\n                        }\n\n                        console.log('📋 Array de contatos extraído:', contactsArray);\n\n                        if (contactsArray.length > 0) {\n                            // Processar array de contatos (armazenar apenas pushName e remoteJid)\n                            // Filtrar apenas contatos individuais (@s.whatsapp.net), não grupos (@g.us)\n                            whatsappContacts = contactsArray\n                                .filter(contact => contact.remoteJid && contact.remoteJid.includes('@s.whatsapp.net'))\n                                .map(contact => ({\n                                    name: contact.pushName || 'Sem nome',\n                                    phone: contact.remoteJid || '',\n                                    selected: true // Por padrão, marcar todos como selecionados\n                                }));\n                            \n                            console.log('📋 Contatos processados:', whatsappContacts);\n                            \n                            if (whatsappContacts.length > 0) {\n                                renderWhatsAppContactsList();\n                                whatsappContactsContainer.style.display = 'block';\n                                saveWhatsAppContactsBtn.style.display = 'block';\n                                \n                                // Esconder botão \"Puxar Contatos\" e mostrar apenas \"Salvar contatos\"\n                                pullWhatsAppForm.querySelector('button[type=\"submit\"]').style.display = 'none';\n                                \n                                showMessage(pullWhatsAppModalMessage, `✅ ${whatsappContacts.length} contato(s) encontrado(s) no WhatsApp!`, 'success');\n                            } else {\n                                showMessage(pullWhatsAppModalMessage, 'ℹ️ Nenhum contato individual encontrado no WhatsApp.', 'info');\n                            }\n                        } else {\n                            // Tratar resposta vazia como informação, não erro\n                            console.log('ℹ️ Nenhum contato retornado pela API - resposta vazia');\n                            showMessage(pullWhatsAppModalMessage, 'ℹ️ Nenhum contato encontrado no WhatsApp. Isso pode acontecer se a conexão for recente ou se não houver contatos salvos.', 'info');\n                            \n                            // Limpar lista de contatos\n                            whatsappContacts = [];\n                            whatsappContactsContainer.style.display = 'none';\n                            whatsappContactsList.innerHTML = '<div style=\"padding: 20px; text-align: center; color: #888;\">Nenhum contato encontrado</div>';\n                            whatsappContactsCount.textContent = '0 contatos encontrados';\n                            saveWhatsAppContactsBtn.style.display = 'none';\n                        }\n\n                    } catch (error) {\n                console.error('❌ Erro ao puxar contatos:', error);\n                showMessage(pullWhatsAppModalMessage, `❌ ${error.message}`, 'error');\n                    } finally {\n                        setButtonLoading(submitButton, false);\n                    }\n        });\n\n        // Formulário de verificação de números\n        verifyNumbersForm.addEventListener('submit', async (e) => {\n            e.preventDefault();\n            \n            const selectedInstanceName = verifyConnectionSelect.value;\n            if (!selectedInstanceName) {\n                showMessage(verifyNumbersModalMessage, '❌ Por favor, selecione uma conexão', 'error');\n                return;\n            }\n\n            if (contacts.length === 0) {\n                showMessage(verifyNumbersModalMessage, '❌ Não há contatos na lista para verificar', 'error');\n                return;\n            }\n\n            // Mostrar loading no botão\n            const submitButton = verifyNumbersForm.querySelector('button[type=\"submit\"]');\n            setButtonLoading(submitButton, true);\n\n            // Mostrar container de resultados e progresso\n            verificationResultsContainer.style.display = 'block';\n            verificationProgress.textContent = '0%';\n            verificationProgressBar.style.width = '0%';\n\n            try {\n                console.log('🔍 Iniciando verificação de números...');\n                console.log('instanceName:', selectedInstanceName);\n                console.log('Contatos na lista:', contacts.length);\n\n                showMessage(verifyNumbersModalMessage, `🔍 Verificando ${contacts.length} números no WhatsApp e detectando duplicados...`, 'info');\n\n                await verifyNumbers(selectedInstanceName);\n\n                // Calcular estatísticas para mostrar na mensagem\n                const validCount = verificationResults.filter(r => r.isValid).length;\n                const invalidCount = verificationResults.filter(r => !r.isValid).length;\n                const duplicateCount = verificationResults.filter(r => r.isDuplicate).length;\n                \n                showMessage(verifyNumbersModalMessage, `✅ Verificação concluída! ${validCount} válidos, ${invalidCount} inválidos, ${duplicateCount} duplicados`, 'success');\n                \n                // Ocultar o botão \"Verificar números\" do modal\n                const verifySubmitBtn = document.getElementById('verifyNumbersSubmitBtn');\n                if (verifySubmitBtn) {\n                    verifySubmitBtn.style.display = 'none';\n                }\n                \n                // Mostrar o botão \"Excluir números inválidos e duplicados\" no modal\n                const deleteInvalidModalBtn = document.getElementById('deleteInvalidModalBtn');\n                if (deleteInvalidModalBtn) {\n                    deleteInvalidModalBtn.style.display = 'block';\n                }\n                \n                // Ocultar o botão \"Verificar números\" da página principal\n                const verifyBtn = document.getElementById('verifyNumbersBtn');\n                if (verifyBtn) {\n                    verifyBtn.style.display = 'none';\n                }\n\n            } catch (error) {\n                console.error('❌ Erro ao verificar números:', error);\n                showMessage(verifyNumbersModalMessage, `❌ ${error.message}`, 'error');\n                \n                // Parar animação e esconder resultados em caso de erro\n                if (progressAnimationId) {\n                    cancelAnimationFrame(progressAnimationId);\n                    progressAnimationId = null;\n                }\n                verificationResultsContainer.style.display = 'none';\n            } finally {\n                setButtonLoading(submitButton, false);\n            }\n        });\n\n        // Paginação de contatos\n        function renderPagination() {\n            const totalPages = Math.ceil(contacts.length / contactsPerPage);\n            const paginationContainerId = 'contactsPagination';\n            let paginationContainer = document.getElementById(paginationContainerId);\n            if (!paginationContainer) {\n                paginationContainer = document.createElement('div');\n                paginationContainer.id = paginationContainerId;\n                paginationContainer.style.display = 'flex';\n                paginationContainer.style.justifyContent = 'center';\n                paginationContainer.style.gap = '8px';\n                paginationContainer.style.margin = '20px auto 0 auto';\n                paginationContainer.style.flexWrap = 'wrap';\n                paginationContainer.style.width = '100%';\n                paginationContainer.style.maxWidth = '100%';\n                paginationContainer.style.clear = 'both';\n                paginationContainer.style.position = 'relative';\n                paginationContainer.style.zIndex = '1';\n                paginationContainer.style.boxSizing = 'border-box';\n                \n                // Inserir após a tabela, não dentro dela\n                if (!document.getElementById(paginationContainerId)) {\n                    const tableSection = document.querySelector('.contacts-table-container').closest('.section');\n                    if (tableSection) {\n                        tableSection.appendChild(paginationContainer);\n                    }\n                }\n            }\n            paginationContainer.innerHTML = '';\n            if (totalPages <= 1) {\n                paginationContainer.style.display = 'none';\n                return;\n            } else {\n                paginationContainer.style.display = 'flex';\n            }\n\n            // Lógica de paginação inteligente (máximo 10 páginas visíveis)\n            const maxVisiblePages = 10;\n            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));\n            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);\n            \n            // Ajustar se não tiver páginas suficientes no início\n            if (endPage - startPage + 1 < maxVisiblePages) {\n                startPage = Math.max(1, endPage - maxVisiblePages + 1);\n            }\n\n            // Botão \"Primeira página\" (se não estiver no início)\n            if (startPage > 1) {\n                const firstBtn = document.createElement('button');\n                firstBtn.textContent = '« Primeira';\n                firstBtn.className = 'btn btn-secondary';\n                firstBtn.style.padding = '6px 12px';\n                firstBtn.style.fontSize = '0.85rem';\n                firstBtn.onclick = () => {\n                    currentPage = 1;\n                    renderContactsTable();\n                };\n                paginationContainer.appendChild(firstBtn);\n            }\n\n            // Botão \"Anterior\"\n            if (currentPage > 1) {\n                const prevBtn = document.createElement('button');\n                prevBtn.textContent = '‹ Anterior';\n                prevBtn.className = 'btn btn-secondary';\n                prevBtn.style.padding = '6px 12px';\n                prevBtn.style.fontSize = '0.85rem';\n                prevBtn.onclick = () => {\n                    currentPage = Math.max(1, currentPage - 1);\n                    renderContactsTable();\n                };\n                paginationContainer.appendChild(prevBtn);\n            }\n\n            // Páginas numeradas\n            for (let i = startPage; i <= endPage; i++) {\n                const btn = document.createElement('button');\n                btn.textContent = i;\n                btn.className = 'btn btn-secondary';\n                btn.style.minWidth = '36px';\n                btn.style.padding = '6px 12px';\n                btn.style.fontWeight = i === currentPage ? '700' : '500';\n                btn.style.background = i === currentPage ? 'linear-gradient(135deg, #25d366 0%, #128c7e 100%)' : '';\n                btn.style.color = i === currentPage ? 'white' : '';\n                btn.disabled = i === currentPage;\n                btn.onclick = () => {\n                    currentPage = i;\n                    renderContactsTable();\n                };\n                paginationContainer.appendChild(btn);\n            }\n\n            // Botão \"Próxima\"\n            if (currentPage < totalPages) {\n                const nextBtn = document.createElement('button');\n                nextBtn.textContent = 'Próxima ›';\n                nextBtn.className = 'btn btn-secondary';\n                nextBtn.style.padding = '6px 12px';\n                nextBtn.style.fontSize = '0.85rem';\n                nextBtn.onclick = () => {\n                    currentPage = Math.min(totalPages, currentPage + 1);\n                    renderContactsTable();\n                };\n                paginationContainer.appendChild(nextBtn);\n            }\n\n            // Botão \"Última página\" (se não estiver no final)\n            if (endPage < totalPages) {\n                const lastBtn = document.createElement('button');\n                lastBtn.textContent = 'Última »';\n                lastBtn.className = 'btn btn-secondary';\n                lastBtn.style.padding = '6px 12px';\n                lastBtn.style.fontSize = '0.85rem';\n                lastBtn.onclick = () => {\n                    currentPage = totalPages;\n                    renderContactsTable();\n                };\n                paginationContainer.appendChild(lastBtn);\n            }\n        }\n\n        // Sempre que adicionar, remover ou importar contatos, resetar para página 1\n        function resetPagination() {\n            currentPage = 1;\n        }\n\n        // Inicialização\n        document.addEventListener('DOMContentLoaded', () => {\n            checkAuth();\n            // Inicializar com nome oculto - será mostrado após carregar da API\n            const listNameDisplay = document.getElementById('listNameDisplay');\n            if (listNameDisplay) {\n                listNameDisplay.style.opacity = '0';\n                listNameDisplay.style.visibility = 'hidden';\n                listNameDisplay.textContent = 'Carregando...';\n            }\n            loadListData();\n            console.log('Tela de Lista de Contatos carregada com sucesso');\n        });\n\n        // No JS, garantir que o nome da lista seja preenchido no span listNameDisplay\n        function renderHeaderInfo() {\n            const listNameDisplay = document.getElementById('listNameDisplay');\n            if (listNameDisplay && currentList) {\n                // Usar o nome real da API ou fallback para o ID\n                const displayName = currentList.name || `Lista ${currentList.id}`;\n                listNameDisplay.textContent = displayName;\n                // Mostrar o elemento quando renderizar (após obter nome da API)\n                listNameDisplay.style.opacity = '1';\n                listNameDisplay.style.visibility = 'visible';\n                listNameDisplay.style.transition = 'opacity 0.3s ease, visibility 0.3s ease';\n                console.log('Nome exibido no header:', displayName);\n            }\n            const totalContatosDiv = document.getElementById('totalContatos');\n            if (totalContatosDiv) {\n                totalContatosDiv.textContent = `Total de contatos: ${contacts.length}`;\n            }\n        }\n\n        // Mostrar progresso das verificações de status\n        function updateVerificationProgress(completed, total) {\n            if (total === 0) return;\n            \n            // Criar ou atualizar indicador de progresso\n            let progressIndicator = document.getElementById('verificationProgress');\n            if (!progressIndicator) {\n                progressIndicator = document.createElement('div');\n                progressIndicator.id = 'verificationProgress';\n                progressIndicator.style.cssText = `\n                    margin-top: 8px;\n                    padding: 8px 12px;\n                    background: rgba(37, 211, 102, 0.1);\n                    border: 1px solid rgba(37, 211, 102, 0.3);\n                    border-radius: 6px;\n                    color: #25d366;\n                    font-size: 0.85rem;\n                    text-align: center;\n                `;\n                connectionSelect.parentNode.appendChild(progressIndicator);\n            }\n            \n            const percentage = Math.round((completed / total) * 100);\n            progressIndicator.textContent = `Verificando status das conexões... ${completed}/${total} (${percentage}%)`;\n            \n            if (completed === total) {\n                progressIndicator.textContent = `✅ Status verificado para todas as ${total} conexão(ões)`;\n                // Esconder após 2 segundos\n                setTimeout(() => {\n                    hideVerificationProgress();\n                }, 2000);\n            }\n        }\n\n        // Esconder progresso das verificações\n        function hideVerificationProgress() {\n            const progressIndicator = document.getElementById('verificationProgress');\n            if (progressIndicator) {\n                progressIndicator.remove();\n            }\n        }\n\n        // ===== FUNÇÕES VERIFY NUMBERS MODAL =====\n\n        // Carregar conexões para o modal de verificação de números\n        async function loadVerifyConnections() {\n            console.log('🔄 Carregando conexões para verificação...');\n            \n            try {\n                const userId = getSecureUserId();\n                if (!userId) {\n                    throw new Error('ID do usuário não encontrado');\n                }\n\n                const response = await fetch('https://n8n.typebot.pro/webhook/listarconexoes', {\n                    method: 'POST',\n                    headers: {\n                        'Content-Type': 'application/json',\n                    },\n                    body: JSON.stringify({ userId: userId })\n                });\n\n                if (!response.ok) {\n                    const errorText = await response.text();\n                    throw new Error(`Erro ao carregar conexões: ${response.status} - ${errorText}`);\n                }\n\n                const responseData = await response.json();\n                console.log('✅ Conexões carregadas para verificação:', responseData);\n\n                // Processar conexões da resposta (mesmo código do outro modal)\n                let rawConnections = [];\n                if (responseData && responseData.Conexoes && Array.isArray(responseData.Conexoes)) {\n                    rawConnections = responseData.Conexoes;\n                } else if (Array.isArray(responseData) && responseData.length > 0 && responseData[0].Conexoes && Array.isArray(responseData[0].Conexoes)) {\n                    rawConnections = responseData[0].Conexoes;\n                } else if (responseData && responseData.data && Array.isArray(responseData.data)) {\n                    rawConnections = responseData.data;\n                } else if (Array.isArray(responseData)) {\n                    rawConnections = responseData;\n                } else {\n                    rawConnections = [];\n                }\n\n                // Filtrar conexões válidas\n                const verifyConnections = rawConnections.filter(conn => (conn.instanceName || conn.instance_name) && (conn.NomeConexao || conn.nomeConexao || conn.name));\n                \n                // Inicializar todas as conexões como \"verificando\" status\n                verifyConnections.forEach(conn => {\n                    conn.isConnected = null;\n                    conn.isVerifying = true;\n                });\n\n                // Renderizar dropdown imediatamente\n                renderVerifyConnectionsDropdown(verifyConnections);\n\n                // Verificar status em background\n                const statusPromises = verifyConnections.map(async (conn, index) => {\n                    try {\n                        const instanceName = conn.instanceName || conn.instance_name;\n                        if (!instanceName) { \n                            conn.isConnected = false;\n                            conn.isVerifying = false;\n                            updateVerifyConnectionOption(index, conn, false);\n                            return; \n                        }\n                        \n                        const statusResp = await fetch(`https://whatsapi.typebot.pro/instance/connectionState/${instanceName}`, {\n                            method: 'GET',\n                            headers: { 'apikey': 'b4d71f9c38e3ac12a6b08e4b6d53aa90' }\n                        });\n                        \n                        if (!statusResp.ok) { \n                            conn.isConnected = false;\n                            conn.isVerifying = false;\n                            updateVerifyConnectionOption(index, conn, false);\n                            return; \n                        }\n                        \n                        const statusData = await statusResp.json();\n                        const state = statusData?.instance?.state || statusData?.state || statusData?.status || statusData?.connectionState;\n                        const isConnected = (state === 'open' || state === 'connected');\n                        conn.isConnected = isConnected;\n                        conn.isVerifying = false;\n                        \n                        updateVerifyConnectionOption(index, conn, isConnected);\n                        \n                    } catch (error) { \n                        console.error(`❌ Erro ao verificar status da conexão ${conn.instanceName}:`, error);\n                        conn.isConnected = false; \n                        conn.isVerifying = false;\n                        updateVerifyConnectionOption(index, conn, false);\n                    }\n                });\n\n                await Promise.all(statusPromises);\n                console.log('✅ Verificações de status concluídas para modal de verificação');\n\n            } catch (error) {\n                console.error('❌ Erro ao carregar conexões para verificação:', error);\n                showMessage(verifyNumbersModalMessage, `❌ ${error.message}`, 'error');\n                verifyConnectionsLoading.style.display = 'none';\n                verifyConnectionSelect.style.display = 'block';\n            }\n        }\n\n        // Renderizar dropdown de conexões para verificação\n        function renderVerifyConnectionsDropdown(verifyConnections) {\n            if (verifyConnections.length === 0) {\n                verifyConnectionSelect.innerHTML = '<option value=\"\">Nenhuma conexão encontrada</option>';\n            } else {\n                // Renderizar com status inicial \"verificando\" usando innerHTML para melhor styling\n                verifyConnectionSelect.innerHTML = '<option value=\"\">Selecione...</option>' +\n                    verifyConnections.map(conn => {\n                        const nome = conn.NomeConexao || conn.nomeConexao || conn.name;\n                        const instance = conn.instanceName || conn.instance_name;\n                        return `<option value=\"${instance}\" data-connected=\"checking\" style=\"color: #888; background-color: rgba(136, 136, 136, 0.1);\">🔄 ${nome} (verificando...)</option>`;\n                    }).join('');\n            }\n\n            verifyConnectionsLoading.style.display = 'none';\n            verifyConnectionSelect.style.display = 'block';\n        }\n\n        // Atualizar opção específica do dropdown de verificação\n        function updateVerifyConnectionOption(index, conn, isConnected) {\n            const nome = conn.NomeConexao || conn.nomeConexao || conn.name;\n            const instance = conn.instanceName || conn.instance_name;\n            const status = isConnected ? '✅ ' : '❌ ';\n            const statusText = isConnected ? 'Conectada' : 'Desconectada';\n            const textColor = isConnected ? '#25d366' : '#ff4444';\n            const backgroundColor = isConnected ? 'rgba(37, 211, 102, 0.1)' : 'rgba(255, 68, 68, 0.1)';\n            \n            // Encontrar a opção correta no select (index + 1 porque a primeira é \"Selecione...\")\n            const option = verifyConnectionSelect.options[index + 1];\n            if (option) {\n                option.innerHTML = `${status}${nome} (${statusText})`;\n                option.style.color = textColor;\n                option.style.backgroundColor = backgroundColor;\n                option.style.fontWeight = isConnected ? '600' : '400';\n                option.setAttribute('data-connected', isConnected ? '1' : '0');\n                option.disabled = !isConnected; // Só permite selecionar se conectada\n            }\n            \n            console.log(`🔄 Opção de verificação atualizada: ${nome} - ${isConnected ? 'Conectada' : 'Desconectada'}`);\n        }\n\n        // Verificar números no WhatsApp\n        async function verifyNumbers(instanceName) {\n            console.log('🔍 Verificando números no WhatsApp...');\n            \n            // Extrair números dos contatos (remover formatação)\n            const allNumbers = contacts.map(contact => contact.phone.replace(/\\D/g, ''));\n            \n            // Remover duplicatas mantendo ordem original\n            const numbersToVerify = [...new Set(allNumbers)];\n            \n            console.log('📋 Números originais:', allNumbers.length);\n            console.log('📋 Números únicos a verificar:', numbersToVerify.length, numbersToVerify);\n            \n            // Iniciar animação da barra de progresso (30 segundos)\n            startProgressAnimation();\n            \n            try {\n                const response = await fetch(`https://whatsapi.typebot.pro/chat/whatsappNumbers/${instanceName}`, {\n                    method: 'POST',\n                    headers: {\n                        'Content-Type': 'application/json',\n                        'apikey': 'b4d71f9c38e3ac12a6b08e4b6d53aa90'\n                    },\n                    body: JSON.stringify({\n                        numbers: numbersToVerify\n                    })\n                });\n\n                if (!response.ok) {\n                    const errorText = await response.text();\n                    throw new Error(`Erro ao verificar números: ${response.status} - ${errorText}`);\n                }\n\n                const responseData = await response.json();\n                console.log('✅ Resposta da verificação:', responseData);\n\n                // Processar resultados usando TODOS os números originais (incluindo duplicatas)\n                processVerificationResults(responseData, allNumbers);\n\n            } catch (error) {\n                console.error('❌ Erro ao verificar números:', error);\n                throw error;\n            }\n        }\n\n        // Variável para controlar a animação\n        let progressAnimationId = null;\n\n        // Animar barra de progresso por 30 segundos\n        function startProgressAnimation() {\n            const duration = 30000; // 30 segundos\n            const startTime = Date.now();\n            \n            function updateProgress() {\n                const elapsed = Date.now() - startTime;\n                const progress = Math.min((elapsed / duration) * 100, 100);\n                \n                verificationProgress.textContent = `${Math.round(progress)}%`;\n                verificationProgressBar.style.width = `${progress}%`;\n                \n                if (progress < 100) {\n                    progressAnimationId = requestAnimationFrame(updateProgress);\n                } else {\n                    progressAnimationId = null;\n                }\n            }\n            \n            // Iniciar animação\n            progressAnimationId = requestAnimationFrame(updateProgress);\n        }\n\n        // Parar animação e forçar 100%\n        function completeProgress() {\n            if (progressAnimationId) {\n                cancelAnimationFrame(progressAnimationId);\n                progressAnimationId = null;\n            }\n            \n            verificationProgress.textContent = '100%';\n            verificationProgressBar.style.width = '100%';\n        }\n\n        // Processar resultados da verificação\n        function processVerificationResults(apiResponse, originalNumbers) {\n            console.log('📊 Processando resultados da verificação...');\n            console.log('📋 Resposta da API:', apiResponse);\n            \n            verificationResults = [];\n            \n            // Identificar números duplicados primeiro\n            const phoneOccurrences = {};\n            originalNumbers.forEach(number => {\n                if (phoneOccurrences[number]) {\n                    phoneOccurrences[number]++;\n                } else {\n                    phoneOccurrences[number] = 1;\n                }\n            });\n            \n            // A API retorna um array de objetos com { exists: boolean, jid: string, number: string }\n            if (apiResponse && Array.isArray(apiResponse)) {\n                console.log('✅ Processando resposta da API...');\n                \n                // Criar estrutura de resultados baseada na resposta da API\n                originalNumbers.forEach(number => {\n                    const contact = contacts.find(c => c.phone.replace(/\\D/g, '') === number);\n                    \n                    // Encontrar o resultado correspondente na resposta da API\n                    const apiResult = apiResponse.find(item => {\n                        if (item.number) {\n                            return item.number.replace(/\\D/g, '') === number;\n                        }\n                        if (item.jid) {\n                            return item.jid.split('@')[0].replace(/\\D/g, '') === number;\n                        }\n                        return false;\n                    });\n                    \n                    // Determinar se o número é válido baseado na propriedade 'exists'\n                    const isValid = apiResult ? apiResult.exists === true : false;\n                    \n                    // Determinar se o número é duplicado\n                    const isDuplicate = phoneOccurrences[number] > 1;\n                    \n                    verificationResults.push({\n                        number: number,\n                        contact: contact,\n                        isValid: isValid,\n                        isDuplicate: isDuplicate,\n                        displayPhone: contact ? contact.phone : number,\n                        name: contact ? contact.name : 'Contato não encontrado',\n                        apiResult: apiResult // Manter referência para debug\n                    });\n                    \n                    console.log(`📱 Número ${number}: ${isValid ? 'VÁLIDO' : 'INVÁLIDO'} ${isDuplicate ? 'DUPLICADO' : ''} (exists: ${apiResult ? apiResult.exists : 'não encontrado'})`);\n                });\n            } else {\n                console.error('❌ Formato de resposta da API não reconhecido:', apiResponse);\n                throw new Error('Formato de resposta da API não reconhecido');\n            }\n            \n            console.log('📋 Resultados processados:', verificationResults);\n            \n            // Atualizar interface\n            renderVerificationResults();\n        }\n\n        // Renderizar resultados da verificação\n        function renderVerificationResults() {\n            // Completar progresso\n            completeProgress();\n            \n            // Mostrar container de resultados\n            verificationResultsContainer.style.display = 'block';\n            verificationSummary.style.display = 'block';\n            verificationDetails.style.display = 'block';\n            \n            // Calcular estatísticas\n            const valid = verificationResults.filter(r => r.isValid);\n            const invalid = verificationResults.filter(r => !r.isValid);\n            const duplicates = verificationResults.filter(r => r.isDuplicate);\n            \n            // Atualizar contadores\n            validCount.textContent = valid.length;\n            invalidCount.textContent = invalid.length;\n            duplicateCount.textContent = duplicates.length;\n            \n            // Renderizar lista baseada na visualização atual\n            renderVerificationList();\n            \n            console.log(`📊 Resultados: ${valid.length} válidos, ${invalid.length} inválidos, ${duplicates.length} duplicados`);\n        }\n\n        // Renderizar lista de verificação baseada no filtro atual\n        function renderVerificationList() {\n            let filteredResults = verificationResults;\n            \n            if (currentVerificationView === 'valid') {\n                filteredResults = verificationResults.filter(r => r.isValid);\n            } else if (currentVerificationView === 'invalid') {\n                filteredResults = verificationResults.filter(r => !r.isValid);\n            } else if (currentVerificationView === 'duplicate') {\n                filteredResults = verificationResults.filter(r => r.isDuplicate);\n            }\n            \n            if (filteredResults.length === 0) {\n                verificationList.innerHTML = '<div style=\"padding: 20px; text-align: center; color: #888;\">Nenhum resultado encontrado</div>';\n                return;\n            }\n            \n            verificationList.innerHTML = filteredResults.map(result => {\n                let statusIcon, statusColor, statusText;\n                \n                if (currentVerificationView === 'duplicate') {\n                    statusIcon = '🔄';\n                    statusColor = '#ffc107';\n                    statusText = 'Duplicado';\n                } else {\n                    statusIcon = result.isValid ? '✅' : '❌';\n                    statusColor = result.isValid ? '#25d366' : '#ff4444';\n                    statusText = result.isValid ? 'Válido' : 'Inválido';\n                }\n                \n                return `\n                    <div style=\"display: flex; align-items: center; padding: 12px 15px; border-bottom: 1px solid rgba(255, 255, 255, 0.05);\">\n                        <div style=\"margin-right: 12px; font-size: 1.2rem;\">${statusIcon}</div>\n                        <div style=\"flex: 1;\">\n                            <div style=\"font-weight: 600; color: #fff; margin-bottom: 2px;\">${result.name}</div>\n                            <div style=\"font-size: 0.85rem; color: #888; font-family: monospace;\">${result.displayPhone}</div>\n                        </div>\n                        <div style=\"color: ${statusColor}; font-size: 0.85rem; font-weight: 600;\">${statusText}</div>\n                    </div>\n                `;\n            }).join('');\n        }\n\n        // Alternar visualização dos resultados\n        function toggleVerificationView(view) {\n            currentVerificationView = view;\n            \n            // Atualizar botões ativos\n            document.getElementById('showValidNumbers').style.fontWeight = view === 'valid' ? '700' : '500';\n            document.getElementById('showInvalidNumbers').style.fontWeight = view === 'invalid' ? '700' : '500';\n            document.getElementById('showDuplicateNumbers').style.fontWeight = view === 'duplicate' ? '700' : '500';\n            \n            // Renderizar lista filtrada\n            renderVerificationList();\n            \n            console.log(`🔄 Visualização alterada para: ${view}`);\n        }\n\n\n\n        // Verificar números via API do WhatsApp\n        async function verifyImportedNumbersViaAPI() {\n            console.log('📊 Verificando números via API do WhatsApp...');\n            \n            // Extrair números dos contatos\n            const validContactNumbers = importContacts.map(contact => contact.telefone);\n            \n            // Identificar números duplicados\n            const phoneOccurrences = {};\n            validContactNumbers.forEach(number => {\n                if (phoneOccurrences[number]) {\n                    phoneOccurrences[number]++;\n                } else {\n                    phoneOccurrences[number] = 1;\n                }\n            });\n            \n            // Remover duplicatas mantendo ordem original para verificação\n            const numbersToVerify = [...new Set(validContactNumbers)];\n            \n            console.log('📋 Números únicos a verificar:', numbersToVerify.length, numbersToVerify);\n            \n            try {\n                // Obter nome da instância selecionada\n                const connectionSelect = document.getElementById('connectionSelectImport');\n                const selectedInstanceName = connectionSelect.value;\n                \n                if (!selectedInstanceName) {\n                    throw new Error('Nenhuma conexão selecionada');\n                }\n                \n                // Fazer requisição para a API real\n                const response = await fetch(`https://whatsapi.typebot.pro/chat/whatsappNumbers/${selectedInstanceName}`, {\n                    method: 'POST',\n                    headers: {\n                        'Content-Type': 'application/json',\n                        'apikey': 'b4d71f9c38e3ac12a6b08e4b6d53aa90'\n                    },\n                    body: JSON.stringify({\n                        numbers: numbersToVerify\n                    })\n                });\n\n                if (!response.ok) {\n                    const errorText = await response.text();\n                    throw new Error(`Erro ao verificar números: ${response.status} - ${errorText}`);\n                }\n\n                const responseData = await response.json();\n                console.log('✅ Resposta da verificação:', responseData);\n\n                // Processar resultados da API\n                const apiInvalidNumbers = [];\n                const apiValidNumbers = [];\n                \n                // A API retorna um array de objetos com { exists: boolean, jid: string, number: string }\n                if (responseData && Array.isArray(responseData)) {\n                    console.log('✅ Processando resposta da API...');\n                    \n                    // Processar cada número único verificado\n                    numbersToVerify.forEach(number => {\n                        // Encontrar o resultado correspondente na resposta da API\n                        const apiResult = responseData.find(item => {\n                            if (item.number) {\n                                return item.number.replace(/\\D/g, '') === number;\n                            }\n                            if (item.jid) {\n                                return item.jid.split('@')[0].replace(/\\D/g, '') === number;\n                            }\n                            return false;\n                        });\n                        \n                        // Determinar se o número é válido baseado na propriedade 'exists'\n                        const isValid = apiResult ? apiResult.exists === true : false;\n                        \n                        if (isValid) {\n                            apiValidNumbers.push(number);\n                        } else {\n                            // Encontrar o contato correspondente\n                            const contact = importContacts.find(c => c.telefone === number);\n                            if (contact) {\n                                apiInvalidNumbers.push({\n                                    line: apiInvalidNumbers.length + 1,\n                                    original: contact.telefone,\n                                    name: contact.nome,\n                                    reason: 'Número não existe no WhatsApp',\n                                    variables: contact.variaveis,\n                                    canBeFixed: false\n                                });\n                            }\n                        }\n                        \n                        console.log(`📱 Número ${number}: ${isValid ? 'VÁLIDO' : 'INVÁLIDO'} (exists: ${apiResult ? apiResult.exists : 'não encontrado'})`);\n                    });\n                } else {\n                    console.error('❌ Formato de resposta da API não reconhecido:', responseData);\n                    throw new Error('Formato de resposta da API não reconhecido');\n                }\n                \n                // Atualizar dados globais\n                invalidNumbersData = apiInvalidNumbers;\n                \n                // Filtrar apenas contatos válidos (válidos no WhatsApp)\n                importContacts = importContacts.filter(contact => {\n                    const isValidInWhatsApp = apiValidNumbers.includes(contact.telefone);\n                    return isValidInWhatsApp;\n                });\n                \n                // Remover duplicatas mantendo apenas a primeira ocorrência de cada número\n                const seenNumbers = new Set();\n                importContacts = importContacts.filter(contact => {\n                    if (seenNumbers.has(contact.telefone)) {\n                        return false; // Já vimos este número, remover\n                    } else {\n                        seenNumbers.add(contact.telefone);\n                        return true; // Primeira vez vendo este número, manter\n                    }\n                });\n                \n                // Mostrar tabela de números inválidos (retornados pela API)\n                if (apiInvalidNumbers.length > 0) {\n                    showInvalidNumbersTable(apiInvalidNumbers);\n                }\n                \n                // Atualizar estatísticas\n                updateImportStatistics(apiValidNumbers.length, apiInvalidNumbers.length, phoneOccurrences);\n                \n                console.log(`📊 Verificação concluída: ${apiValidNumbers.length} válidos, ${apiInvalidNumbers.length} inválidos`);\n                \n            } catch (error) {\n                console.error('❌ Erro ao verificar números:', error);\n                throw error;\n            }\n        }\n\n        // Atualizar estatísticas de importação\n        function updateImportStatistics(validCount, invalidCount, phoneOccurrences) {\n            // Calcular duplicados (números que aparecem mais de uma vez)\n            const duplicateCount = Object.values(phoneOccurrences).reduce((sum, count) => {\n                return sum + (count > 1 ? count - 1 : 0);\n            }, 0);\n            \n            // Mostrar container de verificação com estatísticas\n            importVerificationResults.style.display = 'block';\n            importVerificationSummary.style.display = 'block';\n            \n            // Atualizar contadores\n            importValidCount.textContent = validCount;\n            importInvalidCount.textContent = invalidCount;\n            importDuplicateCount.textContent = duplicateCount;\n            \n            // Completar progresso\n            importVerificationProgress.textContent = '100%';\n            importVerificationProgressBar.style.width = '100%';\n            \n            console.log(`📊 Estatísticas finais: ${validCount} válidos, ${invalidCount} inválidos, ${duplicateCount} duplicados`);\n        }\n\n\n\n\n\n        // Salvar apenas números válidos da importação\n        window.saveValidContacts = async function() {\n            if (!importContacts || importContacts.length === 0) {\n                showMessage(importModalMessage, '❌ Não há números válidos para salvar', 'error');\n                return;\n            }\n            \n            // Desabilitar botão durante a salvamento\n            const saveBtn = document.getElementById('saveValidContactsBtn');\n            setButtonLoading(saveBtn, true);\n            \n            try {\n                console.log('💾 Salvando contatos válidos:', importContacts.length);\n                \n                const response = await fetch('https://n8n.typebot.pro/webhook/criar-contatos', {\n                    method: 'POST',\n                    headers: {\n                        'Content-Type': 'application/json',\n                    },\n                    body: JSON.stringify(importContacts)\n                });\n\n                if (!response.ok) {\n                    const errorText = await response.text();\n                    throw new Error(`Erro ao salvar contatos: ${response.status} - ${errorText}`);\n                }\n\n                const responseData = await response.json();\n                console.log('✅ Contatos salvos:', responseData);\n\n                // Adicionar os novos contatos localmente\n                const newContacts = importContacts.map((contact, index) => ({\n                    id: responseData.ids ? responseData.ids[index] : Date.now() + index,\n                    name: contact.nome,\n                    phone: contact.telefone,\n                    added_at: new Date().toISOString().split('T')[0],\n                    variables: contact.variaveis || {}\n                }));\n\n                contacts = contacts.concat(newContacts);\n                resetPagination();\n                renderContactsTable();\n                \n                const invalidCount = invalidNumbersData.length;\n                \n                // Calcular quantos duplicados foram removidos (baseado nas estatísticas)\n                const duplicateCount = parseInt(importDuplicateCount.textContent) || 0;\n                \n                let message = `✅ ${importContacts.length} contato(s) válido(s) salvos com sucesso!`;\n                if (invalidCount > 0) {\n                    message += ` (${invalidCount} números inválidos filtrados)`;\n                }\n                if (duplicateCount > 0) {\n                    message += ` (${duplicateCount} duplicatas removidas)`;\n                }\n                \n                showMessage(contactsMessage, message, 'success');\n                \n                // Fechar modal após sucesso\n                setTimeout(() => {\n                    closeImportModal();\n                }, 2000);\n\n            } catch (error) {\n                console.error('❌ Erro ao salvar contatos válidos:', error);\n                showMessage(importModalMessage, `❌ ${error.message}`, 'error');\n            } finally {\n                setButtonLoading(saveBtn, false);\n            }\n        };\n\n        // Validar conexão selecionada para verificação\n        function onVerifyConnectionSelect() {\n            const selectedValue = verifyConnectionSelect.value;\n            const selectedOption = verifyConnectionSelect.options[verifyConnectionSelect.selectedIndex];\n            const submitButton = verifyNumbersForm.querySelector('button[type=\"submit\"]');\n            const connectionStatus = selectedOption && selectedOption.getAttribute('data-connected');\n            const isConnected = connectionStatus === '1';\n            const isChecking = connectionStatus === 'checking';\n            \n            // Atualizar cor do select baseado no status da conexão selecionada (igual outros dropdowns)\n            if (isConnected) {\n                verifyConnectionSelect.style.color = '#25d366';\n                verifyConnectionSelect.style.backgroundColor = 'rgba(37, 211, 102, 0.08)';\n                verifyConnectionSelect.style.borderColor = 'rgba(37, 211, 102, 0.3)';\n            } else if (isChecking) {\n                verifyConnectionSelect.style.color = '#888';\n                verifyConnectionSelect.style.backgroundColor = 'rgba(136, 136, 136, 0.08)';\n                verifyConnectionSelect.style.borderColor = 'rgba(136, 136, 136, 0.3)';\n            } else if (connectionStatus === '0') {\n                verifyConnectionSelect.style.color = '#ff4444';\n                verifyConnectionSelect.style.backgroundColor = 'rgba(255, 68, 68, 0.08)';\n                verifyConnectionSelect.style.borderColor = 'rgba(255, 68, 68, 0.3)';\n            } else {\n                // Reset para padrão quando seleciona \"Selecione...\"\n                verifyConnectionSelect.style.color = 'white';\n                verifyConnectionSelect.style.backgroundColor = 'rgba(255, 255, 255, 0.05)';\n                verifyConnectionSelect.style.borderColor = 'rgba(255, 255, 255, 0.2)';\n            }\n            \n            if (selectedValue) {\n                if (isConnected) {\n                    submitButton.disabled = false;\n                    showMessage(verifyNumbersModalMessage, '', ''); // Limpar mensagens\n                } else if (isChecking) {\n                    submitButton.disabled = true;\n                    showMessage(verifyNumbersModalMessage, 'Verificando status da conexão...', 'info');\n                } else if (!isConnected) {\n                    // Resetar seleção se conexão desconectada\n                    verifyConnectionSelect.value = '';\n                    submitButton.disabled = true;\n                    // Reset cor quando deseleciona\n                    verifyConnectionSelect.style.color = 'white';\n                    verifyConnectionSelect.style.backgroundColor = 'rgba(255, 255, 255, 0.05)';\n                    verifyConnectionSelect.style.borderColor = 'rgba(255, 255, 255, 0.2)';\n                    showMessage(verifyNumbersModalMessage, 'Conexão desconectada. Conecte o WhatsApp antes de verificar números.', 'error');\n                } else {\n                    submitButton.disabled = true;\n                    showMessage(verifyNumbersModalMessage, '', ''); // Limpar mensagens\n                }\n            } else {\n                submitButton.disabled = true;\n                showMessage(verifyNumbersModalMessage, '', ''); // Limpar mensagens\n            }\n        }\n\n        // Função para mostrar tabela de números inválidos\n        function showInvalidNumbersTable(invalidNumbers) {\n            console.log('📋 Mostrando tabela de números inválidos:', invalidNumbers);\n            \n            // Todos os números são inválidos no WhatsApp e não podem ser editados\n            const unfixableNumbers = invalidNumbers;\n            \n            // Armazenar dados para uso posterior\n            invalidNumbersData = [...unfixableNumbers];\n            \n            // Criar tabela HTML\n            const container = document.getElementById('invalidNumbersContainer');\n            container.innerHTML = `\n                <div class=\"invalid-numbers-table\">\n                    <div class=\"invalid-numbers-header\">\n                        <svg class=\"status-icon\" viewBox=\"0 0 24 24\" fill=\"#ff4444\">\n                            <path d=\"M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4M11,16.5L6.5,12L7.91,10.59L11,13.67L16.59,8.09L18,9.5L11,16.5Z\"/>\n                        </svg>\n                        <span>${invalidNumbers.length} número(s) inválido(s)</span>\n                    </div>\n                    <table>\n                        <thead>\n                            <tr>\n                                <th>Linha</th>\n                                <th>Nome</th>\n                                <th>Número Original</th>\n                                <th>Status</th>\n                            </tr>\n                        </thead>\n                        <tbody>\n                            ${unfixableNumbers.map(number => `\n                                <tr class=\"whatsapp-invalid-number-row\" data-line=\"${number.line}\" onclick=\"event.stopPropagation();\">\n                                    <td>${number.line}</td>\n                                    <td>${number.name}</td>\n                                    <td class=\"number-original\">${number.original}</td>\n                                    <td>\n                                        <div class=\"number-status\">\n                                            <svg class=\"status-icon\" viewBox=\"0 0 24 24\" fill=\"#ff4444\">\n                                                <path d=\"M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4M11,16.5L6.5,12L7.91,10.59L11,13.67L16.59,8.09L18,9.5L11,16.5Z\"/>\n                                            </svg>\n                                            <span style=\"color: #ff4444;\">${number.reason}</span>\n                                        </div>\n                                    </td>\n                                </tr>\n                            `).join('')}\n                        </tbody>\n                    </table>\n                    <div style=\"margin-top: 15px; text-align: center;\">\n                        <p style=\"color: #ff4444; font-size: 0.9rem;\">\n                            ⚠️ Estes números não existem no WhatsApp e não podem ser salvos.\n                        </p>\n                    </div>\n                </div>\n            `;\n            \n            // Mostrar container\n            container.style.display = 'block';\n            \n            // Ajustar tamanho do modal para acomodar a tabela\n            const modalContent = document.querySelector('#importModal .modal-content');\n            modalContent.classList.add('with-invalid-table');\n            \n            // Ocultar botão de importar\n            importSubmitBtn.style.display = 'none';\n            \n            showMessage(importModalMessage, `❌ ${invalidNumbers.length} número(s) inválidos no WhatsApp.`, 'error');\n        }\n\n\n\n\n\n\n\n        // Função para atualizar a tabela de números inválidos\n        function updateInvalidNumbersTable() {\n            if (invalidNumbersData.length === 0) {\n                // Se não há mais números inválidos, ocultar a tabela\n                document.getElementById('invalidNumbersContainer').style.display = 'none';\n                \n                // Remover classe de tamanho do modal\n                const modalContent = document.querySelector('#importModal .modal-content');\n                modalContent.classList.remove('with-invalid-table');\n                \n                return;\n            }\n            \n            // Re-renderizar a tabela com os números restantes\n            showInvalidNumbersTable(invalidNumbersData);\n        }\n\n\n\n        // Função para mostrar botão de salvar números válidos\n        function showSaveValidNumbersButton() {\n            // Mostrar botão de salvar números válidos (que já existe)\n            saveValidContactsBtn.style.display = 'block';\n            \n            showMessage(importModalMessage, '✅ Todos os números estão válidos! Clique em \"Salvar apenas números válidos\" para continuar.', 'success');\n        }\n\n        // Função de logout\n        function logout() {\n            console.log('🚪 Iniciando logout...');\n            \n            // Limpar todos os cookies\n            document.cookie = 'userId=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';\n            document.cookie = 'idConexao=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';\n            document.cookie = 'idDisparo=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';\n            \n            // Limpar sessionStorage\n            sessionStorage.clear();\n            \n            console.log('🧹 Cookies e sessionStorage limpos');\n            console.log('🔄 Redirecionando para login...');\n            \n            // Redirecionar para página de login\n            window.location.href = 'https://n8n.typebot.pro/webhook/login';\n        }\n\n        // Controle de hover do sidebar\n        function initializeSidebarHover() {\n            const sidebar = document.querySelector('.sidebar');\n            const sidebarLogo = document.querySelector('.sidebar-logo');\n            const menuTexts = document.querySelectorAll('.menu-text');\n            let hoverTimeout;\n            let isExpanded = false;\n\n            // Função para expandir o sidebar\n            function expandSidebar() {\n                if (!isExpanded) {\n                    sidebar.style.width = '250px';\n                    if (sidebarLogo) sidebarLogo.style.opacity = '1';\n                    menuTexts.forEach(text => text.style.opacity = '1');\n                    isExpanded = true;\n                }\n            }\n\n            // Função para recolher o sidebar\n            function collapseSidebar() {\n                if (isExpanded) {\n                    sidebar.style.width = '70px';\n                    if (sidebarLogo) sidebarLogo.style.opacity = '0';\n                    menuTexts.forEach(text => text.style.opacity = '0');\n                    isExpanded = false;\n                }\n            }\n\n            // Event listeners para mouse\n            sidebar.addEventListener('mouseenter', () => {\n                clearTimeout(hoverTimeout);\n                expandSidebar();\n            });\n\n            sidebar.addEventListener('mouseleave', () => {\n                hoverTimeout = setTimeout(() => {\n                    collapseSidebar();\n                }, 300); // Pequeno delay para evitar flickering\n            });\n\n            // Event listeners para touch (mobile)\n            let touchStartX = 0;\n            let touchEndX = 0;\n\n            sidebar.addEventListener('touchstart', (e) => {\n                touchStartX = e.changedTouches[0].screenX;\n            });\n\n            sidebar.addEventListener('touchend', (e) => {\n                touchEndX = e.changedTouches[0].screenX;\n                const swipeDistance = touchEndX - touchStartX;\n                \n                if (swipeDistance > 50 && !isExpanded) {\n                    // Swipe para direita - expandir\n                    expandSidebar();\n                } else if (swipeDistance < -50 && isExpanded) {\n                    // Swipe para esquerda - recolher\n                    collapseSidebar();\n                }\n            });\n        }\n\n        // Inicializar controle de hover do sidebar quando a página carregar\n        document.addEventListener('DOMContentLoaded', function() {\n            initializeSidebarHover();\n        });\n\n    </script>\n</body>\n</html> "},"type":"n8n-nodes-base.html","typeVersion":1.2,"position":[-4240,-4944],"id":"290b31a1-7146-44b4-bc32-1b62259fe024","name":"HTML9"},{"parameters":{"respondWith":"text","responseBody":"={{ $json.html }}","options":{}},"type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-4016,-4944],"id":"37dc5aaa-b174-4f05-8c64-d8e938d6f9e6","name":"Respond to Webhook8"},{"parameters":{"path":"listas-contatos","responseMode":"responseNode","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-4448,-4944],"id":"b514b5d6-185e-46e1-a2e8-eee0e7d52882","name":"LISTAS1","webhookId":"44ef5672-bb5e-47cb-8c16-50d5ffb78a8c"},{"parameters":{"httpMethod":"POST","path":"excluir-contato","responseMode":"lastNode","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-3520,-2976],"id":"d8b9643d-6f8b-4674-ba53-badc85311c7a","name":"EXCLUIR CONTATO","webhookId":"0d210c58-1258-4a4b-a3ff-c6b5d1e7b9fc"},{"parameters":{"operation":"delete","tableId":"SAAS_Contatos","filters":{"conditions":[{"keyName":"id","condition":"eq","keyValue":"={{ $json.body.idContato }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-3296,-2976],"id":"e7f438c7-60d3-4785-b25c-9d21e868f92b","name":"EXCLUIR CONTATO1","credentials":{"supabaseApi":{"id":"gSmzosOueGcVRiU6","name":"supabase enviazap"}}},{"parameters":{"content":"## LISTA-GRUPOS","height":1620,"width":1400,"color":4},"type":"n8n-nodes-base.stickyNote","position":[-3600,-2784],"typeVersion":1,"id":"22bf1d37-bf7b-4e86-ae4b-f9eb7ab99fa9","name":"Sticky Note23"},{"parameters":{"url":"=https://whatsapi.typebot.pro/group/fetchAllGroups/{{ $json.body.instanceName }}?getParticipants=false","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apikey","value":"=b4d71f9c38e3ac12a6b08e4b6d53aa90"}]},"options":{"redirect":{"redirect":{}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-3312,-2688],"id":"17426b20-a8c4-444e-96a5-e281b7bd1dda","name":"LISTAR GRUPO3"},{"parameters":{"aggregate":"aggregateAllItemData","include":"specifiedFields","fieldsToInclude":"id, subject","options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[-3088,-2688],"id":"c9f15025-1f7b-4cad-8a3f-fa4b89448fe0","name":"Aggregate8"},{"parameters":{"httpMethod":"POST","path":"listar-grupos","responseMode":"lastNode","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-3536,-2688],"id":"7f0fa457-d590-409d-aee5-87a3e756270e","name":"LISTAR GRUPOS","webhookId":"0d210c58-1258-4a4b-a3ff-c6b5d1e7b9fc"},{"parameters":{"aggregate":"aggregateAllItemData","options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[-3088,-2496],"id":"adc9af11-80da-4cbc-9d9d-98b1d2cc9278","name":"Aggregate9"},{"parameters":{"httpMethod":"POST","path":"puxar-lista-grupos","responseMode":"lastNode","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-3536,-2496],"id":"603b31b1-702b-48f3-b172-798b93ddda1b","name":"PUXAR GRUPOS","webhookId":"0d210c58-1258-4a4b-a3ff-c6b5d1e7b9fc"},{"parameters":{"fieldToSplitOut":"body.grupos","options":{}},"type":"n8n-nodes-base.splitOut","typeVersion":1,"position":[-3312,-2288],"id":"a85b5571-8448-4840-b577-77526ea75c3e","name":"Split Out3"},{"parameters":{"httpMethod":"POST","path":"salvar-grupos","responseMode":"lastNode","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-3536,-2288],"id":"fcdea2f7-7b2a-4594-a38c-21f03a74aba0","name":"SALVAR GRUPOS","webhookId":"0d210c58-1258-4a4b-a3ff-c6b5d1e7b9fc"},{"parameters":{"tableId":"SAAS_Grupos","fieldsUi":{"fieldValues":[{"fieldId":"nome","fieldValue":"={{ $json.nome }}"},{"fieldId":"WhatsAppId","fieldValue":"={{ $json.id }}"},{"fieldId":"idUsuario","fieldValue":"={{ $('SALVAR GRUPOS').item.json.body.userId }}"},{"fieldId":"idLista","fieldValue":"={{ $('SALVAR GRUPOS').item.json.body.idLista }}"},{"fieldId":"idConexao","fieldValue":"={{ $('SALVAR GRUPOS').item.json.body.idConexao }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-3088,-2288],"id":"c89e605b-8882-458d-a470-306aed0e923a","name":"SALVAR GRUPOS1","credentials":{"supabaseApi":{"id":"gSmzosOueGcVRiU6","name":"supabase enviazap"}}},{"parameters":{"aggregate":"aggregateAllItemData","options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[-2880,-2288],"id":"b00e2151-dd33-44e5-b73c-5f9506ca7d6d","name":"Aggregate10"},{"parameters":{"url":"=https://whatsapi.typebot.pro/group/participants/{{ $json.instanceName }}?groupJid={{ $('CONTAR PARTICIPANTES').item.json.body.WhatsAppId }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apikey","value":"=b4d71f9c38e3ac12a6b08e4b6d53aa90"}]},"options":{"redirect":{"redirect":{}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-3088,-2096],"id":"9e35c139-4f72-41f5-a988-8fe7b206a130","name":"LISTAR GRUPO4"},{"parameters":{"httpMethod":"POST","path":"contar-participantes","responseMode":"lastNode","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-3536,-2096],"id":"e5df9d0b-25ef-4ed2-b469-f36039ae48ea","name":"CONTAR PARTICIPANTES","webhookId":"0d210c58-1258-4a4b-a3ff-c6b5d1e7b9fc"},{"parameters":{"fieldToSplitOut":"participants","options":{}},"type":"n8n-nodes-base.splitOut","typeVersion":1,"position":[-2880,-2096],"id":"4f927cc5-447f-46b2-9e80-3728cea38fa3","name":"Split Out4"},{"parameters":{"fieldsToSummarize":{"values":[{"field":"id"}]},"options":{}},"type":"n8n-nodes-base.summarize","typeVersion":1.1,"position":[-2656,-2096],"id":"5f2beb8e-7a5e-4dd0-bd63-130fa6d0438b","name":"Summarize"},{"parameters":{"operation":"update","tableId":"SAAS_Grupos","filters":{"conditions":[{"keyName":"WhatsAppId","condition":"eq","keyValue":"={{ $('CONTAR PARTICIPANTES').item.json.body.WhatsAppId }}"}]},"fieldsUi":{"fieldValues":[{"fieldId":"participantes","fieldValue":"={{ $json.count_id }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-2432,-2096],"id":"4be87871-8695-42d4-ae32-1ac6292e3975","name":"SALVAR CONTAGEM","credentials":{"supabaseApi":{"id":"gSmzosOueGcVRiU6","name":"supabase enviazap"}}},{"parameters":{"operation":"getAll","tableId":"SAAS_Conexões","filters":{"conditions":[{"keyName":"id","condition":"eq","keyValue":"={{ $json.body.idConexao }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-3312,-2096],"id":"b1ecb565-a41b-434c-bc9c-53e775e1d53c","name":"PUXAR CONEXAO","credentials":{"supabaseApi":{"id":"gSmzosOueGcVRiU6","name":"supabase enviazap"}}},{"parameters":{"httpMethod":"POST","path":"vincular-conexao","responseMode":"lastNode","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-3536,-1904],"id":"a0b73422-18a4-4aba-9cac-f6e00bab7c44","name":"VINCULAR CONEXAO","webhookId":"0d210c58-1258-4a4b-a3ff-c6b5d1e7b9fc"},{"parameters":{"operation":"update","tableId":"SAAS_Listas","filters":{"conditions":[{"keyName":"id","condition":"eq","keyValue":"={{ $json.body.idLista }}"}]},"fieldsUi":{"fieldValues":[{"fieldId":"idConexao","fieldValue":"={{ $json.body.idConexao }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-3312,-1904],"id":"17bdc2b3-d5ca-4060-9810-31e49d7d0097","name":"VINCULAR CONEXAO LISTA","credentials":{"supabaseApi":{"id":"gSmzosOueGcVRiU6","name":"supabase enviazap"}}},{"parameters":{"httpMethod":"POST","path":"puxar-listagrupo","responseMode":"lastNode","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-3536,-1728],"id":"c9f7c22c-5c47-48cf-b46b-e5a2eee6df86","name":"PUXAR LISTAS2","webhookId":"0d210c58-1258-4a4b-a3ff-c6b5d1e7b9fc"},{"parameters":{"operation":"getAll","tableId":"SAAS_Listas","filters":{"conditions":[{"keyName":"id","condition":"eq","keyValue":"={{ $json.body.idLista }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-3312,-1728],"id":"d2468682-25d9-419f-842d-c78f51dec238","name":"PUXAR LISTAS3","credentials":{"supabaseApi":{"id":"gSmzosOueGcVRiU6","name":"supabase enviazap"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"56c2c610-c69a-4235-80ce-559c891b9063","leftValue":"={{ $json.idConexao }}","rightValue":"","operator":{"type":"number","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-3088,-1728],"id":"e308f591-fad9-4f58-b66f-a2163c951d6b","name":"If2"},{"parameters":{"operation":"getAll","tableId":"SAAS_Conexões","filters":{"conditions":[{"keyName":"id","condition":"eq","keyValue":"={{ $json.idConexao }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-2832,-1792],"id":"063c380d-dce3-4e20-827f-788eb35a93c4","name":"PUXAR CONEXAO1","credentials":{"supabaseApi":{"id":"gSmzosOueGcVRiU6","name":"supabase enviazap"}}},{"parameters":{"includeOtherFields":true,"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-2832,-1616],"id":"60b90c94-8794-4053-8188-5abc5ed381a1","name":"Edit Fields"},{"parameters":{"url":"=https://whatsapi.typebot.pro/group/participants/{{ $json.instanceName }}?groupJid={{ $('EXPORTAR PARTICIPANTES').item.json.body.WhatsAppId }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apikey","value":"=b4d71f9c38e3ac12a6b08e4b6d53aa90"}]},"options":{"redirect":{"redirect":{}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-3072,-1376],"id":"5a442344-420c-4415-9dc5-6a56beb2b4ed","name":"LISTAR GRUPO5"},{"parameters":{"operation":"getAll","tableId":"SAAS_Conexões","filters":{"conditions":[{"keyName":"id","condition":"eq","keyValue":"={{ $json.body.idConexao }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-3312,-1376],"id":"d14bf0b1-74f5-4bc6-b334-e9c27c5aabc0","name":"PUXAR CONEXAO2","credentials":{"supabaseApi":{"id":"gSmzosOueGcVRiU6","name":"supabase enviazap"}}},{"parameters":{"httpMethod":"POST","path":"exportar-participantes","responseMode":"lastNode","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-3536,-1376],"id":"6d317bd8-90c5-4b86-8f4e-fa38aadf54e7","name":"EXPORTAR PARTICIPANTES","webhookId":"0d210c58-1258-4a4b-a3ff-c6b5d1e7b9fc"},{"parameters":{"httpMethod":"POST","path":"excluir-grupo","responseMode":"lastNode","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-3536,-1552],"id":"2063b130-fd9f-472a-a14a-93e661211a26","name":"EXCLUIR GRUPO","webhookId":"0d210c58-1258-4a4b-a3ff-c6b5d1e7b9fc"},{"parameters":{"operation":"delete","tableId":"SAAS_Grupos","filters":{"conditions":[{"keyName":"id","condition":"eq","keyValue":"={{ $json.body.idGrupo }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-3312,-1552],"id":"2c5d7d34-7e5b-42ae-a426-1ccbd31a512f","name":"EXCLUIR GRUPO1","credentials":{"supabaseApi":{"id":"gSmzosOueGcVRiU6","name":"supabase enviazap"}}},{"parameters":{"content":"## Tela Listas-Grupos","height":260,"width":760,"color":2},"type":"n8n-nodes-base.stickyNote","position":[-4512,-4752],"typeVersion":1,"id":"76bf319e-5a00-4ea1-8a09-b534293dcd3f","name":"Sticky Note24"},{"parameters":{"html":"<!DOCTYPE html>\n<html lang=\"pt-BR\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>Lista de Grupos - EnviaZap</title>\n    <style>\n        * { margin: 0; padding: 0; box-sizing: border-box; }\n        body {\n            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);\n            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n            color: white;\n            min-height: 100vh;\n            margin: 0;\n            padding: 0;\n        }\n        .app-layout { display: flex; min-height: 100vh; }\n        .sidebar { width: 70px; background: rgba(0, 0, 0, 0.3); backdrop-filter: blur(10px); border-right: 1px solid rgba(255, 255, 255, 0.1); transition: all 0.3s ease; position: relative; z-index: 1000; display: flex; flex-direction: column; height: 100vh; }\n        .sidebar:hover { width: 250px; }\n        .sidebar-header { padding: 20px; text-align: center; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }\n        .sidebar-logo { font-size: 1.5rem; font-weight: 600; background: linear-gradient(135deg, #25d366 0%, #128c7e 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; white-space: nowrap; opacity: 0; transition: opacity 0.3s ease; }\n        .sidebar:hover .sidebar-logo { opacity: 1; }\n        .sidebar-menu { padding: 20px 0; flex: 1; }\n        .menu-item { display: flex; align-items: center; padding: 15px 20px; color: #ccc; text-decoration: none; transition: all 0.3s ease; position: relative; white-space: nowrap; }\n        .menu-item:hover { background: rgba(37, 211, 102, 0.1); color: #25d366; }\n        .menu-item.active { background: rgba(37, 211, 102, 0.2); color: #25d366; border-right: 3px solid #25d366; }\n        .menu-icon { font-size: 1.2rem; width: 30px; text-align: center; flex-shrink: 0; }\n        .menu-text { margin-left: 15px; opacity: 0; transition: opacity 0.3s ease; }\n        .sidebar:hover .menu-text { opacity: 1; }\n\n        .sidebar-footer {\n            margin-top: auto;\n            border-top: 1px solid rgba(255, 255, 255, 0.1);\n            padding: 10px 0;\n        }\n\n        .logout-item {\n            color: #ff6b6b !important;\n        }\n\n        .logout-item:hover {\n            background: rgba(255, 107, 107, 0.1) !important;\n            color: #ff6b6b !important;\n        }\n        .main-content-wrapper {\n            flex: 1;\n            padding: 30px 0 30px 0;\n            overflow-x: auto;\n        }\n        .container {\n            width: 100%;\n            max-width: 100vw;\n            margin: 0;\n            padding: 0 30px;\n        }\n        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; }\n        .header-info { display: flex; flex-direction: column; gap: 4px; }\n        .header-info h1 { font-size: 2.5rem; font-weight: 600; margin-bottom: 10px; color: white; display: flex; align-items: center; gap: 12px; }\n        .header-info p { color: #888; font-size: 1.1rem; }\n        .header-icon { width: 32px; height: 32px; fill: #25d366; }\n        .list-name-display {\n            color: white;\n            font-size: 2.2rem;\n            font-weight: 700;\n            background: linear-gradient(135deg, rgba(37,211,102,0.15) 0%, rgba(18,140,126,0.15) 100%);\n            border: 1px solid rgba(37,211,102,0.3);\n            border-radius: 12px;\n            padding: 12px 20px;\n            display: inline-block;\n            letter-spacing: 0.5px;\n            min-width: 200px;\n            transition: all 0.3s ease, opacity 0.3s ease, visibility 0.3s ease;\n            margin-top: 8px;\n        }\n        .list-name-display:hover {\n            border-color: rgba(37,211,102,0.5);\n            background: linear-gradient(135deg, rgba(37,211,102,0.2) 0%, rgba(18,140,126,0.2) 100%);\n        }\n        .main-content { display: flex; flex-direction: column; gap: 30px; }\n        .section { background: rgba(255, 255, 255, 0.02); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 16px; padding: 40px; backdrop-filter: blur(10px); box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); }\n        .section-header { display: flex; align-items: center; gap: 12px; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }\n        .section-icon { font-size: 1.5rem; }\n        .section-icon svg { width: 20px; height: 20px; fill: #25d366; }\n        .section-title { font-size: 1.4rem; font-weight: 600; color: #25d366; }\n        .section-subtitle { color: #888; font-size: 0.9rem; margin-bottom: 20px; line-height: 1.4; }\n        .header-actions { display: flex; gap: 15px; align-items: center; }\n        .btn {\n            padding: 10px 16px;\n            background: linear-gradient(135deg, #25d366 0%, #128c7e 100%);\n            border: none;\n            border-radius: 10px;\n            color: white;\n            font-weight: 600;\n            cursor: pointer;\n            transition: all 0.3s ease;\n            display: flex;\n            align-items: center;\n            gap: 8px;\n            font-size: 0.9rem;\n            text-decoration: none;\n            box-shadow: 0 2px 8px rgba(37, 211, 102, 0.2);\n        }\n        .btn:hover {\n            transform: translateY(-2px);\n            box-shadow: 0 6px 20px rgba(37, 211, 102, 0.3);\n        }\n        .btn-secondary {\n            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08) 0%, rgba(255, 255, 255, 0.12) 100%);\n            border: 1px solid rgba(255, 255, 255, 0.2);\n            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);\n        }\n        .btn-secondary:hover {\n            background: linear-gradient(135deg, rgba(255, 255, 255, 0.12) 0%, rgba(255, 255, 255, 0.16) 100%);\n            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);\n        }\n        .btn:disabled {\n            background: linear-gradient(135deg, #444 0%, #555 100%);\n            cursor: not-allowed;\n            transform: none;\n            box-shadow: none;\n        }\n        .btn-icon {\n            width: 16px;\n            height: 16px;\n            fill: currentColor;\n            flex-shrink: 0;\n        }\n        .btn.loading .loading-spinner {\n            display: block;\n        }\n        /* Tabela de grupos */\n        .groups-table-container { background: rgba(255, 255, 255, 0.02); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 16px; overflow: hidden; backdrop-filter: blur(10px); }\n        .groups-table { width: 100%; border-collapse: collapse; }\n        .groups-table th { background: rgba(255, 255, 255, 0.05); padding: 15px 20px; text-align: left; font-weight: 600; color: #25d366; font-size: 0.9rem; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }\n        .groups-table td { padding: 15px 20px; border-bottom: 1px solid rgba(255, 255, 255, 0.05); font-size: 0.9rem; }\n        .groups-table tr:hover { background: rgba(37, 211, 102, 0.05); }\n        .groups-table tr:last-child td { border-bottom: none; }\n        .group-name { font-weight: 600; color: #fff; }\n        .group-participants { color: #25d366; font-family: monospace; }\n        .group-date { color: #888; font-size: 0.85rem; }\n        .group-actions { display: flex; gap: 8px; }\n        .action-btn { background: none; border: none; color: #888; cursor: pointer; padding: 6px; border-radius: 4px; transition: all 0.3s ease; font-size: 0.9rem; }\n        .action-btn:hover { background: rgba(255, 255, 255, 0.1); color: white; }\n        .action-btn.delete:hover { color: #ff4444; }\n        /* Modal */\n        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 1000; backdrop-filter: blur(5px); }\n        .modal.show { display: flex; align-items: center; justify-content: center; }\n        .modal-content { background: rgba(26, 26, 26, 0.95); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 16px; padding: 30px; max-width: 500px; width: 90%; backdrop-filter: blur(10px); box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5); }\n        .modal-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }\n        .modal-title { font-size: 1.3rem; font-weight: 600; color: #25d366; }\n        .modal-close { background: none; border: none; color: #888; font-size: 1.5rem; cursor: pointer; padding: 5px; border-radius: 4px; transition: all 0.3s ease; }\n        .modal-close:hover { background: rgba(255, 255, 255, 0.1); color: white; }\n        .modal .form-group { margin-bottom: 22px; }\n        .modal .form-group label { color: #fff; font-weight: 500; margin-bottom: 8px; font-size: 0.95rem; display: block; }\n        .modal .form-group select { width: 100%; padding: 12px 15px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; color: white; font-size: 1rem; outline: none; transition: all 0.3s ease; }\n        .modal .form-group select:focus { border-color: #25d366; box-shadow: 0 0 0 2px rgba(37, 211, 102, 0.2); }\n        .modal .form-group select::placeholder { color: #888; }\n        .modal .form-group select option { \n            background: rgba(26, 26, 26, 0.95); \n            color: white; \n            padding: 8px 12px; \n            border: none;\n        }\n        .modal .form-group select option[data-connected=\"1\"] {\n            color: #25d366 !important;\n            background: rgba(37, 211, 102, 0.1) !important;\n            font-weight: 600;\n        }\n        .modal .form-group select option[data-connected=\"0\"] {\n            color: #ff4444 !important;\n            background: rgba(255, 68, 68, 0.1) !important;\n            font-weight: 400;\n        }\n        .modal .form-group select option[data-connected=\"checking\"] {\n            color: #888 !important;\n            background: rgba(136, 136, 136, 0.1) !important;\n            font-weight: 400;\n        }\n        .modal .message { padding: 15px; border-radius: 8px; margin-bottom: 15px; font-size: 0.9rem; display: none; }\n        .modal .message.show { display: block; animation: fadeIn 0.3s ease; }\n        .modal .message.success { background: rgba(37, 211, 102, 0.1); border: 1px solid rgba(37, 211, 102, 0.3); color: #25d366; }\n        .modal .message.error { background: rgba(255, 68, 68, 0.1); border: 1px solid rgba(255, 68, 68, 0.3); color: #ff4444; }\n        .modal .message.info { background: rgba(255, 193, 7, 0.1); border: 1px solid rgba(255, 193, 7, 0.3); color: #ffc107; }\n        /* Pesquisa de grupos */\n        .groups-search {\n            padding: 0;\n            border-bottom: none;\n            background: none;\n        }\n        .groups-search input { \n            width: 100%; \n            background: rgba(255, 255, 255, 0.05); \n            border: 1px solid rgba(255, 255, 255, 0.2); \n            border-radius: 6px; \n            padding: 10px 36px 10px 12px; \n            color: white; \n            font-size: 0.9rem; \n            outline: none; \n            transition: all 0.3s ease; \n            background-image: url(\"data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23888'%3e%3cpath d='M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z'/%3e%3c/svg%3e\");\n            background-repeat: no-repeat;\n            background-position: right 12px center;\n            background-size: 16px 16px;\n        }\n        .groups-search input:focus { border-color: #25d366; box-shadow: 0 0 0 2px rgba(37, 211, 102, 0.2); }\n        .groups-search input::placeholder { color: #888; }\n        .groups-list {\n            max-height: 300px;\n            overflow-y: auto;\n            border-radius: 12px;\n            border: 1px solid rgba(255,255,255,0.10);\n            margin-bottom: 8px;\n            background: none;\n        }\n        .groups-list-count {\n            color: #25d366;\n            font-weight: 600;\n            font-size: 0.9rem;\n        }\n        .progress-bar-container {\n            width: 100%;\n            background: rgba(255,255,255,0.08);\n            border-radius: 8px;\n            margin-bottom: 12px;\n            margin-top: 8px;\n            height: 28px;\n            display: flex;\n            align-items: center;\n            position: relative;\n        }\n        .progress-bar {\n            height: 100%;\n            border-radius: 8px;\n            background: linear-gradient(90deg, #25d366 0%, #128c7e 100%);\n            transition: width 0.3s linear;\n        }\n        .progress-bar-text {\n            position: absolute;\n            left: 0; right: 0; top: 0; bottom: 0;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            color: #fff;\n            font-size: 0.98rem;\n            font-weight: 500;\n            letter-spacing: 0.5px;\n            z-index: 2;\n            text-shadow: 0 1px 4px rgba(0,0,0,0.18);\n        }\n        .group-item { \n            display: flex; \n            align-items: center; \n            padding: 12px 15px; \n            border-bottom: 1px solid rgba(255, 255, 255, 0.05); \n            cursor: pointer; \n            transition: all 0.3s ease; \n            position: relative;\n        }\n        .group-item:last-child { border-bottom: none; }\n        .group-item:hover { background: rgba(37, 211, 102, 0.05); }\n        .group-item.selected { background: rgba(37, 211, 102, 0.1); border-left: 3px solid #25d366; }\n        .group-item.duplicate {\n            background: rgba(255, 193, 7, 0.08);\n            border-left: 3px solid #ffc107;\n        }\n        .group-item.duplicate:hover {\n            background: rgba(255, 193, 7, 0.12);\n        }\n        .group-item.duplicate .group-name {\n            color: #ffc107;\n        }\n        .group-item.duplicate .group-details {\n            color: #e0a800;\n        }\n        .group-checkbox { \n            width: 18px; \n            height: 18px; \n            accent-color: #25d366; \n            margin-right: 12px; \n            flex-shrink: 0; \n            cursor: pointer;\n        }\n        .group-info { flex: 1; min-width: 0; }\n        .group-name { color: #fff; font-weight: 500; font-size: 0.9rem; margin-bottom: 4px; line-height: 1.3; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }\n        .group-details { color: #888; font-size: 0.8rem; display: flex; gap: 15px; }\n        .group-type { display: flex; align-items: center; gap: 4px; }\n        .group-type.community { color: #25d366; }\n        .group-type.announce { color: #ffc107; }\n        .duplicate-badge {\n            position: absolute;\n            top: 8px;\n            right: 8px;\n            background: #ffc107;\n            color: #000;\n            font-size: 0.7rem;\n            padding: 2px 6px;\n            border-radius: 10px;\n            font-weight: 600;\n        }\n        .groups-list-header {\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            margin-bottom: 10px;\n            padding: 0 2px;\n        }\n        .groups-list-actions {\n            display: flex;\n            gap: 8px;\n        }\n        .btn-link {\n            background: none;\n            border: none;\n            color: #25d366;\n            font-size: 0.85rem;\n            cursor: pointer;\n            text-decoration: underline;\n            padding: 0;\n        }\n        .btn-link:hover {\n            color: #1da851;\n        }\n        /* Scrollbar para a lista de grupos */\n        .groups-list::-webkit-scrollbar { width: 6px; }\n        .groups-list::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); border-radius: 3px; }\n        .groups-list::-webkit-scrollbar-thumb { background: rgba(37, 211, 102, 0.5); border-radius: 3px; }\n        .groups-list::-webkit-scrollbar-thumb:hover { background: rgba(37, 211, 102, 0.7); }\n        \n        /* Paginação */\n        #groupsPagination {\n            display: flex !important;\n            justify-content: center !important;\n            align-items: center !important;\n            gap: 8px !important;\n            margin: 20px auto 0 auto !important;\n            flex-wrap: wrap !important;\n            width: 100% !important;\n            max-width: 100% !important;\n            clear: both !important;\n            position: relative !important;\n            z-index: 1 !important;\n            background: transparent !important;\n            box-sizing: border-box !important;\n            padding: 0 !important;\n        }\n\n        #groupsPagination button {\n            margin: 0 !important;\n            flex-shrink: 0 !important;\n            position: relative !important;\n            z-index: 1 !important;\n            white-space: nowrap !important;\n        }\n\n        /* Responsive para paginação */\n        @media (max-width: 768px) {\n            #groupsPagination {\n                gap: 4px !important;\n                margin: 15px auto 0 auto !important;\n            }\n            \n            #groupsPagination button {\n                padding: 4px 8px !important;\n                font-size: 0.75rem !important;\n                min-width: 28px !important;\n            }\n        }\n        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }\n        \n        /* Loading state */\n        .loading-container {\n            display: flex;\n            flex-direction: column;\n            align-items: center;\n            justify-content: center;\n            min-height: 400px;\n            gap: 20px;\n        }\n\n        .loading-spinner {\n            width: 60px;\n            height: 60px;\n            border: 4px solid rgba(37, 211, 102, 0.3);\n            border-top: 4px solid #25d366;\n            border-radius: 50%;\n            animation: spin 1s linear infinite;\n        }\n\n        .loading-text {\n            color: #25d366;\n            font-size: 1.2rem;\n            font-weight: 500;\n        }\n\n        @keyframes spin {\n            0% { transform: rotate(0deg); }\n            100% { transform: rotate(360deg); }\n        }\n        \n        /* Garantir que a animação funcione desde o carregamento */\n        .loading-spinner {\n            animation: spin 1s linear infinite !important;\n        }\n        /* Avisos/Mensagens */\n        .message {\n            padding: 15px;\n            border-radius: 8px;\n            margin-bottom: 15px;\n            font-size: 0.9rem;\n            display: none;\n        }\n        .message.show {\n            display: block;\n            animation: fadeIn 0.3s ease;\n        }\n        .message.success {\n            background: rgba(37, 211, 102, 0.1);\n            border: 1px solid rgba(37, 211, 102, 0.3);\n            color: #25d366;\n        }\n        .message.error {\n            background: rgba(255, 68, 68, 0.1);\n            border: 1px solid rgba(255, 68, 68, 0.3);\n            color: #ff4444;\n        }\n        .message.info {\n            background: rgba(255, 193, 7, 0.1);\n            border: 1px solid rgba(255, 193, 7, 0.3);\n            color: #ffc107;\n        }\n        /* Exportar mensagem */\n        #exportMessage {\n            display: none;\n            position: fixed;\n            top: 24px;\n            left: 50%;\n            transform: translateX(-50%);\n            min-width: 320px;\n            max-width: 90vw;\n            z-index: 2000;\n            text-align: center;\n            padding: 16px 32px;\n            font-size: 1.05rem;\n            font-weight: 600;\n            background: rgba(255, 193, 7, 0.1);\n            color: #ffc107;\n            border: 1.5px solid rgba(255,193,7,0.3);\n            border-radius: 12px;\n            box-shadow: 0 4px 24px rgba(0,0,0,0.10);\n            transition: opacity 0.3s, top 0.3s;\n            opacity: 0.98;\n            animation: fadeIn 0.3s ease;\n            pointer-events: none;\n        }\n    </style>\n</head>\n<body>\n    <div class=\"app-layout\">\n        <!-- Sidebar -->\n        <div class=\"sidebar\">\n            <div class=\"sidebar-header\">\n                <div class=\"sidebar-logo\">EnviaZap</div>\n            </div>\n            <nav class=\"sidebar-menu\">\n                <a href=\"#\" class=\"menu-item\" onclick=\"navigateToPage('https://n8n.typebot.pro/webhook/dashboard')\">\n                    <span class=\"menu-icon\">📊</span>\n                    <span class=\"menu-text\">Dashboard</span>\n                </a>\n                <a href=\"#\" class=\"menu-item\" onclick=\"navigateToPage('https://n8n.typebot.pro/webhook/historico-disparos')\">\n                    <span class=\"menu-icon\">📋</span>\n                    <span class=\"menu-text\">Histórico de disparos</span>\n                </a>\n                <a href=\"#\" class=\"menu-item\" onclick=\"navigateToPage('https://n8n.typebot.pro/webhook/conectar')\">\n                    <span class=\"menu-icon\">🔗</span>\n                    <span class=\"menu-text\">Nova Conexão</span>\n                </a>\n                <a href=\"#\" class=\"menu-item\" onclick=\"navigateToPage('https://n8n.typebot.pro/webhook/conexoes')\">\n                    <span class=\"menu-icon\">🔌</span>\n                    <span class=\"menu-text\">Conexões</span>\n                </a>\n                <a href=\"#\" class=\"menu-item\" onclick=\"navigateToPage('https://n8n.typebot.pro/webhook/disparos-individuais')\">\n                    <span class=\"menu-icon\">💬</span>\n                    <span class=\"menu-text\">Disparos individuais</span>\n                </a>\n                <a href=\"#\" class=\"menu-item\" onclick=\"navigateToPage('https://n8n.typebot.pro/webhook/disparos-grupos')\">\n                    <span class=\"menu-icon\">👥</span>\n                    <span class=\"menu-text\">Disparos em grupo</span>\n                </a>\n                <a href=\"#\" class=\"menu-item\" onclick=\"navigateToPage('https://n8n.typebot.pro/webhook/listas')\">\n                    <span class=\"menu-icon\">📋</span>\n                    <span class=\"menu-text\">Listas</span>\n                </a>\n            </nav>\n            <div class=\"sidebar-footer\">\n                <a href=\"#\" class=\"menu-item logout-item\" onclick=\"logout()\">\n                    <span class=\"menu-icon\">🚪</span>\n                    <span class=\"menu-text\">Sair</span>\n                </a>\n            </div>\n        </div>\n        <!-- Main Content -->\n        <div class=\"main-content-wrapper\">\n            <div class=\"container\">\n                <div class=\"header\">\n                    <div class=\"header-info\">\n                        <h1>\n                            <svg class=\"header-icon\" viewBox=\"0 0 24 24\">\n                                <path d=\"M12,5.5A3.5,3.5 0 0,1 15.5,9A3.5,3.5 0 0,1 12,12.5A3.5,3.5 0 0,1 8.5,9A3.5,3.5 0 0,1 12,5.5M5,8C5.56,8 6.08,8.15 6.53,8.42C6.38,9.85 6.8,11.27 7.66,12.38C7.16,13.34 6.16,14 5,14A3,3 0 0,1 2,11A3,3 0 0,1 5,8M19,8A3,3 0 0,1 22,11A3,3 0 0,1 19,14C17.84,14 16.84,13.34 16.34,12.38C17.2,11.27 17.62,9.85 17.47,8.42C17.92,8.15 18.44,8 19,8M5.5,18.25C5.5,16.18 8.41,14.5 12,14.5C15.59,14.5 18.5,16.18 18.5,18.25V20H5.5V18.25M0,20V18.5C0,17.11 1.89,15.94 4.45,15.6C3.86,16.28 3.5,17.22 3.5,18.25V20H0M24,20H20.5V18.25C20.5,17.22 20.14,16.28 19.55,15.6C22.11,15.94 24,17.11 24,18.5V20Z\"/>\n                            </svg>\n                            Lista de Grupos\n                        </h1>\n                        <span id=\"listNameHighlight\" class=\"list-name-display\">Carregando...</span>\n                    </div>\n                    <div class=\"header-actions\">\n                        <button class=\"btn btn-secondary\" id=\"refreshGroupsBtn\" title=\"Atualizar grupos\">\n                            <svg class=\"btn-icon\" viewBox=\"0 0 24 24\">\n                                <path d=\"M17.65,6.35C16.2,4.9 14.21,4 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20C15.73,20 18.84,17.45 19.73,14H17.65C16.83,16.33 14.61,18 12,18A6,6 0 0,1 6,12A6,6 0 0,1 12,6C13.66,6 15.14,6.69 16.22,7.78L13,11H20V4L17.65,6.35Z\"/>\n                            </svg>\n                        </button>\n                        <button class=\"btn btn-secondary\" id=\"countParticipantsBtn\" title=\"Contar participantes\">\n                            <svg class=\"btn-icon\" viewBox=\"0 0 24 24\">\n                                <path d=\"M12,5.5A3.5,3.5 0 0,1 15.5,9A3.5,3.5 0 0,1 12,12.5A3.5,3.5 0 0,1 8.5,9A3.5,3.5 0 0,1 12,5.5M5,8C5.56,8 6.08,8.15 6.53,8.42C6.38,9.85 6.8,11.27 7.66,12.38C7.16,13.34 6.16,14 5,14A3,3 0 0,1 2,11A3,3 0 0,1 5,8M19,8A3,3 0 0,1 22,11A3,3 0 0,1 19,14C17.84,14 16.84,13.34 16.34,12.38C17.2,11.27 17.62,9.85 17.47,8.42C17.92,8.15 18.44,8 19,8M5.5,18.25C5.5,16.18 8.41,14.5 12,14.5C15.59,14.5 18.5,16.18 18.5,18.25V20H5.5V18.25M0,20V18.5C0,17.11 1.89,15.94 4.45,15.6C3.86,16.28 3.5,17.22 3.5,18.25V20H0M24,20H20.5V18.25C20.5,17.22 20.14,16.28 19.55,15.6C22.11,15.94 24,17.11 24,18.5V20Z\"/>\n                            </svg>\n                            Contar Participantes\n                        </button>\n                        <button class=\"btn btn-secondary\" id=\"syncGroupsBtn\" onclick=\"openSyncModal()\">\n                            <svg class=\"btn-icon\" viewBox=\"0 0 24 24\">\n                                <path d=\"M12,18A6,6 0 0,1 6,12C6,11 6.25,10.03 6.7,9.2L5.24,7.74C4.46,8.97 4,10.43 4,12A8,8 0 0,0 12,20V23L16,19L12,15M12,4V1L8,5L12,9V6A6,6 0 0,1 18,12C18,13 17.75,13.97 17.3,14.8L18.76,16.26C19.54,15.03 20,13.57 20,12A8,8 0 0,0 12,4Z\"/>\n                            </svg>\n                            Sincronizar Grupos\n                        </button>\n                        <a href=\"#\" class=\"btn btn-secondary\" onclick=\"goBack(); return false;\">\n                            <svg class=\"btn-icon\" viewBox=\"0 0 24 24\">\n                                <path d=\"M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z\"/>\n                            </svg>\n                            Voltar\n                        </a>\n                    </div>\n                </div>\n                <!-- Caixinha de conexão vinculada logo abaixo do header -->\n                <div id=\"conexaoVinculadaBox\" style=\"display:none; margin-bottom:18px;\"></div>\n                \n                <!-- Mensagens na parte superior -->\n                <div class=\"message\" id=\"groupsMessage\" style=\"margin-bottom: 20px;\"></div>\n                \n                <div class=\"main-content\">\n                    <!-- Tabela de Grupos -->\n                    <div class=\"section\">\n                        <div class=\"section-header\" style=\"display: flex; align-items: center; gap: 12px; justify-content: space-between;\">\n                            <div style=\"display: flex; align-items: center; gap: 12px;\">\n                            <span class=\"section-icon\">\n                                <svg viewBox=\"0 0 24 24\">\n                                    <path d=\"M12,5.5A3.5,3.5 0 0,1 15.5,9A3.5,3.5 0 0,1 12,12.5A3.5,3.5 0 0,1 8.5,9A3.5,3.5 0 0,1 12,5.5M5,8C5.56,8 6.08,8.15 6.53,8.42C6.38,9.85 6.8,11.27 7.66,12.38C7.16,13.34 6.16,14 5,14A3,3 0 0,1 2,11A3,3 0 0,1 5,8M19,8A3,3 0 0,1 22,11A3,3 0 0,1 19,14C17.84,14 16.84,13.34 16.34,12.38C17.2,11.27 17.62,9.85 17.47,8.42C17.92,8.15 18.44,8 19,8M5.5,18.25C5.5,16.18 8.41,14.5 12,14.5C15.59,14.5 18.5,16.18 18.5,18.25V20H5.5V18.25M0,20V18.5C0,17.11 1.89,15.94 4.45,15.6C3.86,16.28 3.5,17.22 3.5,18.25V20H0M24,20H20.5V18.25C20.5,17.22 20.14,16.28 19.55,15.6C22.11,15.94 24,17.11 24,18.5V20Z\"/>\n                                </svg>\n                            </span>\n                                <h3 class=\"section-title\" style=\"margin-right: 12px;\">Grupos</h3>\n                            </div>\n                        <div style=\"display: flex; flex-direction: column; gap: 4px; align-items: flex-end;\">\n                            <span id=\"totalGrupos\" style=\"color: #25d366; font-weight: 600; font-size: 1.1rem;\"></span>\n                            <span id=\"paginationInfo\" style=\"color: #888; font-size: 0.9rem;\"></span>\n                        </div>\n                        </div>\n                        <div class=\"groups-table-container\">\n                            <table class=\"groups-table\">\n                                <thead>\n                                    <tr>\n                                        <th>Nome</th>\n                                        <th>Participantes</th>\n                                        <th>Data de Adição</th>\n                                        <th>Ações</th>\n                                    </tr>\n                                </thead>\n                                <tbody id=\"groupsTableBody\">\n                                    <tr>\n                                        <td colspan=\"4\" style=\"text-align: center; color: #888; padding: 40px 20px;\">\n                                            <div class=\"loading-spinner\" style=\"margin: 0 auto 15px auto; width: 60px; height: 60px; border: 4px solid rgba(37, 211, 102, 0.3); border-top: 4px solid #25d366; border-radius: 50%; animation: spin 1s linear infinite;\"></div>\n                                            <p>Carregando grupos...</p>\n                                        </td>\n                                    </tr>\n                                </tbody>\n                            </table>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        </div>\n    </div>\n    <!-- Modal de Sincronizar Grupos -->\n    <div class=\"modal\" id=\"syncModal\">\n        <div class=\"modal-content\">\n            <div class=\"modal-header\">\n                <h3 class=\"modal-title\">\n                    <svg style=\"width: 20px; height: 20px; fill: #25d366; margin-right: 8px;\" viewBox=\"0 0 24 24\">\n                        <path d=\"M12,18A6,6 0 0,1 6,12C6,11 6.25,10.03 6.7,9.2L5.24,7.74C4.46,8.97 4,10.43 4,12A8,8 0 0,0 12,20V23L16,19L12,15M12,4V1L8,5L12,9V6A6,6 0 0,1 18,12C18,13 17.75,13.97 17.3,14.8L18.76,16.26C19.54,15.03 20,13.57 20,12A8,8 0 0,0 12,4Z\"/>\n                    </svg>\n                    Sincronizar Grupos\n                </h3>\n                <button class=\"modal-close\" id=\"closeSyncModal\">&times;</button>\n            </div>\n            <form id=\"syncForm\">\n                <div class=\"form-group\">\n                    <label for=\"connectionSelect\">Escolha uma conexão *</label>\n                    <select id=\"connectionSelect\" name=\"connectionSelect\" required>\n                        <option value=\"\">Selecione...</option>\n                    </select>\n                </div>\n                <div class=\"form-group\" id=\"connectionWarning\" style=\"display:none; color:#888; font-size:0.95rem; margin-top:1px; margin-bottom:28px;\">\n                    Após sincronizar, esta conexão não poderá ser alterada nesta lista.\n                </div>\n                <div class=\"form-group\">\n                    <button type=\"button\" class=\"btn\" id=\"fetchGroupsBtn\" disabled>Puxar grupos</button>\n                </div>\n                <div class=\"form-group\" id=\"groupsSearchContainer\" style=\"display:none;\">\n                    <div class=\"groups-search\">\n                        <input type=\"text\" id=\"groupsSearchInput\" placeholder=\"Pesquisar grupos...\">\n                    </div>\n                    <div class=\"groups-list-header\">\n                        <span class=\"groups-list-count\" id=\"groupsListCount\">0 grupos encontrados</span>\n                        <div class=\"groups-list-actions\">\n                            <button type=\"button\" class=\"btn-link\" onclick=\"selectAllGroups(true)\">Selecionar todos</button>\n                            <button type=\"button\" class=\"btn-link\" onclick=\"selectAllGroups(false)\">Desmarcar todos</button>\n                        </div>\n                    </div>\n                    <div class=\"groups-list\" id=\"groupsList\"></div>\n                </div>\n                <div class=\"form-group\" id=\"saveGroupsContainer\" style=\"display:none;\">\n                    <button type=\"submit\" class=\"btn\" id=\"saveGroupsBtn\">Salvar Grupos Selecionados</button>\n                </div>\n                <div class=\"message\" id=\"syncModalMessage\"></div>\n            </form>\n        </div>\n    </div>\n    <!-- Adicionar div de aviso de exportação no topo da tela -->\n    <div id=\"exportMessage\"></div>\n    <script>\n    // Função para definir cookies\n    function setCookie(name, value, days = 30) {\n        const expires = new Date();\n        expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));\n        document.cookie = `${name}=${value};expires=${expires.toUTCString()};path=/`;\n    }\n\n    // Capturar parâmetros da URL e armazenar em cookies\n    (function capturarEArmazenarParametrosURL() {\n        const urlParams = new URLSearchParams(window.location.search);\n        \n        // Capturar userId e idLista da URL\n        const userId = urlParams.get('userId');\n        const idLista = urlParams.get('idLista');\n        \n        // Armazenar em cookies se existirem\n        if (userId && /^\\d+$/.test(userId)) {\n            setCookie('userId', userId);\n            console.log('✅ UserId armazenado nos cookies:', userId);\n        }\n        if (idLista && /^\\d+$/.test(idLista)) {\n            setCookie('idLista', idLista);\n            console.log('✅ idLista armazenado nos cookies:', idLista);\n        }\n        \n        // Limpar URL se houver parâmetros\n        if (userId || idLista || urlParams.toString()) {\n            const newUrl = window.location.pathname;\n            window.history.replaceState({}, '', newUrl);\n        }\n    })();\n\n    // Elementos do DOM\n    const syncModal = document.getElementById('syncModal');\n    const closeSyncModal = document.getElementById('closeSyncModal');\n    const syncGroupsBtn = document.getElementById('syncGroupsBtn');\n    const connectionSelect = document.getElementById('connectionSelect');\n    const connectionWarning = document.getElementById('connectionWarning');\n    const fetchGroupsBtn = document.getElementById('fetchGroupsBtn');\n    const groupsSearchContainer = document.getElementById('groupsSearchContainer');\n    const groupsSearchInput = document.getElementById('groupsSearchInput');\n    const groupsList = document.getElementById('groupsList');\n    const saveGroupsContainer = document.getElementById('saveGroupsContainer');\n    const saveGroupsBtn = document.getElementById('saveGroupsBtn');\n    const syncModalMessage = document.getElementById('syncModalMessage');\n    const syncForm = document.getElementById('syncForm');\n    const groupsTableBody = document.getElementById('groupsTableBody');\n    const groupsMessage = document.getElementById('groupsMessage');\n\n    // Dados globais\n    let connections = [];\n    let selectedConnection = null;\n    let allGroups = [];\n    let filteredGroups = [];\n    let selectedGroups = [];\n    let gruposSalvos = [];\n    let nomeLista = '';\n    let nomeConexaoVinculada = '';\n    let instanceNameVinculada = '';\n    let conexaoVinculadaInfo = null;\n    \n    // Variáveis para paginação\n    let currentPage = 1;\n    const groupsPerPage = 10;\n\n    // Funções utilitárias\n    function showMessage(element, message, type = 'info') {\n        console.log('📢 showMessage chamada:', { element: !!element, message, type });\n        if (!element) {\n            console.error('❌ Elemento não encontrado para showMessage');\n            return;\n        }\n        element.textContent = message;\n        element.className = `message ${type} show`;\n        if (type === 'success') {\n            element.style.background = 'rgba(37, 211, 102, 0.1)';\n            element.style.border = '1px solid rgba(37, 211, 102, 0.3)';\n            element.style.color = '#25d366';\n        } else if (type === 'error') {\n            element.style.background = 'rgba(255, 68, 68, 0.1)';\n            element.style.border = '1px solid rgba(255, 68, 68, 0.3)';\n            element.style.color = '#ff4444';\n        } else if (type === 'info') {\n            element.style.background = 'rgba(255, 193, 7, 0.1)';\n            element.style.border = '1px solid rgba(255, 193, 7, 0.3)';\n            element.style.color = '#ffc107';\n        } else {\n            element.style.background = '';\n            element.style.border = '';\n            element.style.color = '';\n        }\n        console.log('✅ Mensagem exibida com sucesso');\n        setTimeout(() => {\n            element.classList.remove('show');\n        }, 5000);\n    }\n    function setButtonLoading(button, loading) {\n        if (!button) return;\n        if (loading) {\n            button.disabled = true;\n            button.innerHTML = 'Carregando... <span class=\"loading-spinner\"></span>';\n        } else {\n            button.disabled = false;\n            button.innerHTML = button.id === 'fetchGroupsBtn' ? 'Puxar grupos' : 'Salvar Grupos Selecionados';\n        }\n    }\n    function formatDate(dateString) {\n        const date = new Date(dateString);\n        return date.toLocaleDateString('pt-BR');\n    }\n\n    // Função para ler cookies\n    function getCookie(name) {\n        const value = `; ${document.cookie}`;\n        const parts = value.split(`; ${name}=`);\n        if (parts.length === 2) return parts.pop().split(';').shift();\n        return null;\n    }\n\n    // Função para obter userId de forma segura via cookies\n    function getSecureUserId() {\n        const userId = getCookie('userId');\n        if (userId && /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(userId)) {\n            console.log('✅ UserId (UUID) obtido dos cookies:', userId);\n            return userId;\n        }\n        console.error('❌ UserId (UUID) não encontrado ou formato inválido nos cookies!');\n        return null;\n    }\n\n    // Função para obter dados da lista dos cookies\n    function getListFromCookies() {\n        const idLista = getCookie('idLista');\n        if (idLista && /^\\d+$/.test(idLista)) {\n            console.log('✅ idLista obtido dos cookies:', idLista);\n            return {\n                id: parseInt(idLista),\n                name: null // Nome será atualizado após requisição da API\n            };\n        }\n        console.error('❌ idLista não encontrado nos cookies!');\n        return null;\n    }\n\n    // Autenticação obrigatória ao carregar a página\n    function checkAuth() {\n        const userId = getSecureUserId();\n        if (!userId) {\n            console.error('❌ Usuário não autenticado, redirecionando para login');\n            window.location.href = 'https://n8n.typebot.pro/webhook/login';\n            return false;\n        }\n        console.log('✅ Usuário autenticado:', userId);\n        return true;\n    }\n\n    // Função para redirecionar para outras páginas (sem parâmetros)\n    function navigateToPage(url) {\n        window.location.href = url;\n    }\n\n\n\n    // Buscar nome da lista especificamente\n    async function buscarNomeLista() {\n        const currentList = getListFromCookies();\n        if (!currentList) return;\n        const idLista = currentList.id;\n        \n        // Ocultar o nome da lista enquanto busca\n        const listNameDisplay = document.getElementById('listNameHighlight');\n        if (listNameDisplay) {\n            listNameDisplay.style.opacity = '0';\n            listNameDisplay.style.visibility = 'hidden';\n        }\n        \n        try {\n            const response = await fetch('https://n8n.typebot.pro/webhook/puxar-variaveis', {\n                method: 'POST',\n                headers: { 'Content-Type': 'application/json' },\n                body: JSON.stringify({ idLista })\n            });\n            \n            if (!response.ok) {\n                console.warn('Falha ao puxar nome da lista:', response.status);\n                // Em caso de erro, mostrar fallback\n                nomeLista = `Lista ${idLista}`;\n                renderHeaderInfo();\n                return;\n            }\n            \n            const responseData = await response.json();\n            console.log('Resposta puxar-variaveis para nome da lista:', responseData);\n            \n            let nomeEncontrado = false;\n            \n            // Extrair nome da lista da resposta\n            if (responseData && responseData.data && Array.isArray(responseData.data) && responseData.data.length > 0) {\n                const listData = responseData.data[0];\n                if (listData.nome) {\n                    nomeLista = listData.nome;\n                    nomeEncontrado = true;\n                    console.log('Nome da lista extraído:', listData.nome);\n                }\n            } else if (responseData && Array.isArray(responseData)) {\n                // Formato alternativo: array de objetos com propriedade 'data'\n                for (const item of responseData) {\n                    if (item.data && Array.isArray(item.data) && item.data.length > 0) {\n                        const listData = item.data[0];\n                        if (listData.nome) {\n                            nomeLista = listData.nome;\n                            nomeEncontrado = true;\n                            console.log('Nome da lista extraído:', listData.nome);\n                            break;\n                        }\n                    }\n                }\n            }\n            \n            // Se não encontrou nome na API, usar fallback\n            if (!nomeEncontrado) {\n                nomeLista = `Lista ${idLista}`;\n                console.log('Nome da lista não encontrado na API, usando fallback:', nomeLista);\n            }\n            \n            // Atualizar nome na tela e mostrar\n            renderHeaderInfo();\n            \n        } catch (e) {\n            console.warn('Falha ao buscar nome da lista:', e);\n            // Em caso de erro, mostrar fallback\n            nomeLista = `Lista ${idLista}`;\n            renderHeaderInfo();\n        }\n    }\n\n    // Ao carregar a página, requisitar puxar-listagrupo antes de carregar grupos sincronizados\n    async function puxarListaGrupoAntes() {\n        const currentList = getListFromCookies();\n        if (!currentList) return;\n        const idLista = currentList.id;\n        try {\n            const resp = await fetch('https://n8n.typebot.pro/webhook/puxar-listagrupo', {\n                method: 'POST',\n                headers: { 'Content-Type': 'application/json' },\n                body: JSON.stringify({ idLista })\n            });\n            if (!resp.ok) {\n                const text = await resp.text();\n                console.warn('Falha ao puxar listagrupo:', resp.status, text);\n                conexaoVinculadaInfo = null;\n            } else {\n                const data = await resp.json();\n                console.log('Resposta puxar-listagrupo:', data);\n                // Se vier instanceName/NomeConexao, já tem conexão vinculada\n                if (data && (data.instanceName || data.NomeConexao)) {\n                    conexaoVinculadaInfo = data;\n                } else {\n                    conexaoVinculadaInfo = null;\n                }\n            }\n        } catch (e) {\n            console.warn('Falha ao puxar listagrupo:', e);\n            conexaoVinculadaInfo = null;\n        }\n        renderConexaoVinculadaBox();\n    }\n\n    // Carregar grupos sincronizados ao abrir a página\n    async function loadGruposSincronizados() {\n        const currentList = getListFromCookies();\n        if (!currentList) {\n            showMessage(groupsMessage, '❌ ID da lista não encontrado nos cookies', 'error');\n            return;\n        }\n        const idLista = currentList.id;\n        \n        try {\n            // O loading já está sendo exibido desde o carregamento da página\n            // Não precisa alterar o HTML aqui\n            const response = await fetch('https://n8n.typebot.pro/webhook/puxar-lista-grupos', {\n                method: 'POST',\n                headers: { 'Content-Type': 'application/json' },\n                body: JSON.stringify({ idLista })\n            });\n            if (!response.ok) throw new Error('Erro ao buscar grupos sincronizados');\n            const data = await response.json();\n            console.log('[API] Resposta puxar-lista-grupos:', data);\n            let grupos = [];\n            if (data && data.data && Array.isArray(data.data)) grupos = data.data;\n            else if (Array.isArray(data)) grupos = data;\n            gruposSalvos = grupos.map(g => ({\n                id: g.id,\n                name: g.name || g.nome || g.subject,\n                participants: (g.participantes !== undefined ? g.participantes : (g.size || 0)),\n                added_at: g.added_at || g.data_adicao || g.createdAt || g.created_at || new Date().toISOString(),\n                WhatsAppId: g.WhatsAppId || g.whatsappid || g.whatsappId || '',\n                idConexao: g.idConexao || g.id_conexao || ''\n            }));\n            console.log('[API] Grupos processados para tabela:', gruposSalvos);\n            // Pega nome da lista, conexão vinculada e instanceName se vier na resposta (mas não sobrescreve se já temos nome da API específica)\n            if (!nomeLista || nomeLista.startsWith('Lista ')) {\n                nomeLista = (data && data.nomeLista) || (data && data.data && data.data[0] && data.data[0].nomeLista) || nomeLista;\n            }\n            nomeConexaoVinculada = (data && data.nomeConexao) || (data && data.data && data.data[0] && data.data[0].nomeConexao) || '';\n            instanceNameVinculada = (data && data.instanceName) || (data && data.data && data.data[0] && data.data[0].instanceName) || '';\n            renderHeaderInfo();\n            resetPagination();\n            renderGroupsTable();\n            if (gruposSalvos.length) {\n                showMessage(groupsMessage, `✅ ${gruposSalvos.length} grupo(s) sincronizado(s) carregado(s)!`, 'success');\n            } else {\n                showMessage(groupsMessage, 'Nenhum grupo sincronizado encontrado.', 'info');\n            }\n        } catch (e) {\n            renderHeaderInfo();\n            renderGroupsTable();\n            if (e.message && e.message.includes('Erro ao buscar grupos sincronizados')) {\n                showMessage(groupsMessage, 'Nenhum grupo sincronizado encontrado.', 'info');\n            } else {\n                showMessage(groupsMessage, e.message, 'error');\n            }\n        }\n    }\n\n    // Renderizar informações do topo (nome da lista, total, conexão)\n    function renderHeaderInfo() {\n        const listNameDisplay = document.getElementById('listNameHighlight');\n        if (listNameDisplay) {\n            const currentList = getListFromCookies();\n            const displayName = nomeLista || (currentList ? `Lista ${currentList.id}` : 'Lista de Grupos');\n            listNameDisplay.textContent = displayName;\n            // Mostrar o elemento quando renderizar (após obter nome da API)\n            listNameDisplay.style.opacity = '1';\n            listNameDisplay.style.visibility = 'visible';\n            listNameDisplay.style.transition = 'opacity 0.3s ease, visibility 0.3s ease';\n            console.log('Nome exibido no header:', displayName);\n        }\n        const totalGruposDiv = document.getElementById('totalGrupos');\n        if (totalGruposDiv) {\n            totalGruposDiv.textContent = `Total de grupos: ${gruposSalvos.length}`;\n        }\n            \n            const paginationInfoDiv = document.getElementById('paginationInfo');\n            if (paginationInfoDiv) {\n                if (gruposSalvos.length > 0) {\n                    const startIdx = (currentPage - 1) * groupsPerPage;\n                    const endIdx = Math.min(startIdx + groupsPerPage, gruposSalvos.length);\n                    paginationInfoDiv.textContent = `Exibindo ${startIdx + 1}-${endIdx} de ${gruposSalvos.length}`;\n                } else {\n                    paginationInfoDiv.textContent = '';\n                }\n            }\n    }\n\n    // Modal\n    function openSyncModal() {\n        syncModal.classList.add('show');\n        syncModalMessage.textContent = '';\n        groupsSearchContainer.style.display = 'none';\n        saveGroupsContainer.style.display = 'none';\n        groupsList.innerHTML = '';\n        selectedConnection = null;\n        allGroups = [];\n        filteredGroups = [];\n        selectedGroups = [];\n        // Se já tem conexão vinculada, mostra info fixa, senão mostra select\n        if (conexaoVinculadaInfo && (conexaoVinculadaInfo.instanceName || conexaoVinculadaInfo.NomeConexao)) {\n            // Esconde select e label\n            connectionSelect.style.display = 'none';\n            connectionWarning.style.display = 'none';\n            var label = connectionSelect.parentElement.querySelector('label');\n            if (label) label.style.display = 'none';\n            // Monta info da conexão vinculada\n            let nome = conexaoVinculadaInfo.NomeConexao || conexaoVinculadaInfo.instanceName;\n            let instance = conexaoVinculadaInfo.instanceName;\n            // Checar status de conexão\n            let statusSpan = document.createElement('span');\n            statusSpan.textContent = 'Verificando...';\n            statusSpan.style.marginLeft = '10px';\n            statusSpan.style.fontWeight = 'bold';\n            statusSpan.style.fontSize = '1rem';\n            statusSpan.id = 'statusConexaoVinculada';\n            // Adiciona info no lugar do select\n            let infoDiv = document.getElementById('conexaoVinculadaInfo');\n            if (!infoDiv) {\n                infoDiv = document.createElement('div');\n                infoDiv.id = 'conexaoVinculadaInfo';\n                infoDiv.style.marginBottom = '18px';\n                infoDiv.style.fontSize = '1.05rem';\n                connectionSelect.parentElement.insertAdjacentElement('beforebegin', infoDiv);\n            }\n            infoDiv.innerHTML = `<b>Conexão vinculada:</b> <span style='color:#25d366;'>${nome}</span>`;\n            infoDiv.appendChild(statusSpan);\n            // Checa status\n            if (instance) {\n                fetch(`https://whatsapi.typebot.pro/instance/connectionState/${instance}`, {\n                    method: 'GET',\n                    headers: { 'apikey': 'b4d71f9c38e3ac12a6b08e4b6d53aa90' }\n                }).then(r => r.json()).then(statusData => {\n                    const state = statusData?.instance?.state || statusData?.state || statusData?.status || statusData?.connectionState;\n                    if (state === 'open' || state === 'connected') {\n                            statusSpan.innerHTML = '<svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"currentColor\" style=\"margin-right:4px;\"><circle cx=\"12\" cy=\"12\" r=\"10\" fill=\"#25d366\"/></svg> Conectada';\n                        statusSpan.style.color = '#25d366';\n                        fetchGroupsBtn.disabled = false;\n                        // Seleciona a conexão vinculada como selectedConnection\n                        selectedConnection = {\n                            instanceName: conexaoVinculadaInfo.instanceName,\n                            idConexao: conexaoVinculadaInfo.idConexao || conexaoVinculadaInfo.id_conexao || conexaoVinculadaInfo.id,\n                            NomeConexao: conexaoVinculadaInfo.NomeConexao || conexaoVinculadaInfo.instanceName,\n                            isConnected: true\n                        };\n                    } else {\n                            statusSpan.innerHTML = '<svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"currentColor\" style=\"margin-right:4px;\"><circle cx=\"12\" cy=\"12\" r=\"10\" fill=\"#ff4444\"/></svg> Desconectada';\n                        statusSpan.style.color = '#ff4444';\n                        fetchGroupsBtn.disabled = true;\n                        selectedConnection = null;\n                        showMessage(syncModalMessage, 'A conexão vinculada está desconectada. Conecte o WhatsApp antes de puxar grupos.', 'error');\n                    }\n                }).catch(() => {\n                    statusSpan.textContent = '🔴 Desconhecido';\n                    statusSpan.style.color = '#ff4444';\n                    fetchGroupsBtn.disabled = true;\n                    selectedConnection = null;\n                    showMessage(syncModalMessage, 'Não foi possível verificar o status da conexão vinculada.', 'error');\n                });\n            } else {\n                    statusSpan.innerHTML = '<svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"currentColor\" style=\"margin-right:4px;\"><circle cx=\"12\" cy=\"12\" r=\"10\" fill=\"#ff4444\"/></svg> Desconhecido';\n                statusSpan.style.color = '#ff4444';\n                fetchGroupsBtn.disabled = true;\n                selectedConnection = null;\n                showMessage(syncModalMessage, 'Não foi possível identificar a conexão vinculada.', 'error');\n            }\n        } else {\n            // Mostra loading no lugar do select e depois carrega as conexões\n            showConnectionsLoading();\n            fetchGroupsBtn.disabled = true;\n            loadConnections();\n        }\n    }\n    function closeSyncModalFn() {\n        syncModal.classList.remove('show');\n        syncForm.reset();\n    }\n    syncGroupsBtn.addEventListener('click', openSyncModal);\n    closeSyncModal.addEventListener('click', closeSyncModalFn);\n    syncModal.addEventListener('click', (e) => { if (e.target === syncModal) closeSyncModalFn(); });\n\n    // Mostrar loading das conexões\n    function showConnectionsLoading() {\n        // Esconder select e label\n        connectionSelect.style.display = 'none';\n        connectionWarning.style.display = 'none';\n        var label = connectionSelect.parentElement.querySelector('label');\n        if (label) label.style.display = 'none';\n        \n        // Remover info div se existir\n        let infoDiv = document.getElementById('conexaoVinculadaInfo');\n        if (infoDiv) infoDiv.remove();\n        \n        // Criar div de loading\n        let loadingDiv = document.getElementById('connectionsLoading');\n        if (!loadingDiv) {\n            loadingDiv = document.createElement('div');\n            loadingDiv.id = 'connectionsLoading';\n            loadingDiv.style.marginBottom = '18px';\n            loadingDiv.style.fontSize = '1.05rem';\n            loadingDiv.style.display = 'flex';\n            loadingDiv.style.alignItems = 'center';\n            loadingDiv.style.gap = '12px';\n            loadingDiv.style.padding = '15px';\n            loadingDiv.style.background = 'rgba(255, 255, 255, 0.05)';\n            loadingDiv.style.border = '1px solid rgba(255, 255, 255, 0.1)';\n            loadingDiv.style.borderRadius = '8px';\n            connectionSelect.parentElement.insertAdjacentElement('beforebegin', loadingDiv);\n        }\n        \n        loadingDiv.innerHTML = `\n            <div style=\"\n                width: 20px; \n                height: 20px; \n                border: 2px solid rgba(37, 211, 102, 0.3); \n                border-top: 2px solid #25d366; \n                border-radius: 50%; \n                animation: spin 1s linear infinite;\n            \"></div>\n            <span style=\"color: #888;\">Carregando conexões...</span>\n        `;\n        \n        // Adicionar CSS da animação se não existir\n        if (!document.getElementById('loadingSpinCSS')) {\n            const style = document.createElement('style');\n            style.id = 'loadingSpinCSS';\n            style.textContent = `\n                @keyframes spin {\n                    0% { transform: rotate(0deg); }\n                    100% { transform: rotate(360deg); }\n                }\n            `;\n            document.head.appendChild(style);\n        }\n    }\n    \n    // Esconder loading das conexões e mostrar select\n    function hideConnectionsLoading() {\n        const loadingDiv = document.getElementById('connectionsLoading');\n        if (loadingDiv) loadingDiv.remove();\n        \n        // Mostrar select e label\n        connectionSelect.style.display = '';\n        var label = connectionSelect.parentElement.querySelector('label');\n        if (label) label.style.display = '';\n    }\n\n    // Carregar conexões\n    async function loadConnections() {\n        try {\n            const userId = getSecureUserId();\n            if (!userId) throw new Error('ID do usuário não encontrado');\n            const response = await fetch('https://n8n.typebot.pro/webhook/listarconexoes', {\n                method: 'POST',\n                headers: { 'Content-Type': 'application/json' },\n                body: JSON.stringify({ userId: userId })\n            });\n            if (!response.ok) throw new Error('Erro ao buscar conexões');\n            const data = await response.json();\n            let rawConnections = [];\n            if (data && data.Conexoes && Array.isArray(data.Conexoes)) rawConnections = data.Conexoes;\n            else if (Array.isArray(data) && data.length > 0 && data[0].Conexoes && Array.isArray(data[0].Conexoes)) rawConnections = data[0].Conexoes;\n            else if (Array.isArray(data)) rawConnections = data;\n            \n            // Filtrar conexões válidas\n            connections = rawConnections.filter(conn => (conn.instanceName || conn.instance_name) && (conn.NomeConexao || conn.nomeConexao || conn.name));\n            \n            if (connections.length === 0) {\n                hideConnectionsLoading();\n                connectionSelect.innerHTML = '<option value=\"\">Nenhuma conexão encontrada</option>';\n                showMessage(syncModalMessage, 'Nenhuma conexão encontrada.', 'info');\n                return;\n            }\n            \n            // Mostrar dropdown com conexões (sem status ainda)\n            hideConnectionsLoading();\n            connectionSelect.innerHTML = '<option value=\"\">Selecione...</option>' +\n                connections.map(conn => {\n                    const nome = conn.NomeConexao || conn.nomeConexao || conn.name;\n                    const instance = conn.instanceName || conn.instance_name;\n                    return `<option value=\"${instance}\" data-connected=\"checking\" style=\"color: #888; background-color: rgba(136, 136, 136, 0.1);\">🔄 ${nome} (verificando...)</option>`;\n                }).join('');\n            \n            // Verificar status de cada conexão em paralelo e atualizar dinamicamente\n            let checkedConnections = 0;\n            connections.forEach(async (conn, index) => {\n                try {\n                    const instanceName = conn.instanceName || conn.instance_name;\n                    if (!instanceName) { \n                        conn.isConnected = false; \n                        updateConnectionOption(index, conn, false);\n                        checkedConnections++;\n                        if (checkedConnections === connections.length) {\n                            showConnectionsStatusComplete();\n                        }\n                        return; \n                    }\n                    \n                    const statusResp = await fetch(`https://whatsapi.typebot.pro/instance/connectionState/${instanceName}`, {\n                        method: 'GET',\n                        headers: { 'apikey': 'b4d71f9c38e3ac12a6b08e4b6d53aa90' }\n                    });\n                    \n                    if (!statusResp.ok) { \n                        conn.isConnected = false; \n                        updateConnectionOption(index, conn, false);\n                        checkedConnections++;\n                        if (checkedConnections === connections.length) {\n                            showConnectionsStatusComplete();\n                        }\n                        return; \n                    }\n                    \n                    const statusData = await statusResp.json();\n                    const state = statusData?.instance?.state || statusData?.state || statusData?.status || statusData?.connectionState;\n                    const isConnected = (state === 'open' || state === 'connected');\n                    conn.isConnected = isConnected;\n                    updateConnectionOption(index, conn, isConnected);\n                    checkedConnections++;\n                    if (checkedConnections === connections.length) {\n                        showConnectionsStatusComplete();\n                    }\n                } catch { \n                    conn.isConnected = false; \n                    updateConnectionOption(index, conn, false);\n                    checkedConnections++;\n                    if (checkedConnections === connections.length) {\n                        showConnectionsStatusComplete();\n                    }\n                }\n            });\n            \n        } catch (e) {\n            hideConnectionsLoading();\n            connectionSelect.innerHTML = '<option value=\"\">Erro ao carregar conexões</option>';\n            showMessage(syncModalMessage, e.message, 'error');\n        }\n    }\n    \n    // Atualizar opção de conexão no dropdown\n    function updateConnectionOption(index, conn, isConnected) {\n        const nome = conn.NomeConexao || conn.nomeConexao || conn.name;\n        const instance = conn.instanceName || conn.instance_name;\n        const status = isConnected ? '✅ ' : '❌ ';\n        const statusText = isConnected ? 'Conectada' : 'Desconectada';\n        const textColor = isConnected ? '#25d366' : '#ff4444';\n        const backgroundColor = isConnected ? 'rgba(37, 211, 102, 0.1)' : 'rgba(255, 68, 68, 0.1)';\n        \n        // Encontrar a opção correta no select (index + 1 porque a primeira é \"Selecione...\")\n        const option = connectionSelect.options[index + 1];\n        if (option) {\n            option.innerHTML = `${status}${nome} (${statusText})`;\n            option.style.color = textColor;\n            option.style.backgroundColor = backgroundColor;\n            option.style.fontWeight = isConnected ? '600' : '400';\n            option.setAttribute('data-connected', isConnected ? '1' : '0');\n        }\n        \n        // Se esta conexão está atualmente selecionada, atualizar os controles\n        if (selectedConnection && (selectedConnection.instanceName === instance || selectedConnection.instance_name === instance)) {\n            if (isConnected) {\n                connectionWarning.style.display = 'block';\n                fetchGroupsBtn.disabled = false;\n                // Atualizar cor do select para conectado\n                connectionSelect.style.color = '#25d366';\n                connectionSelect.style.backgroundColor = 'rgba(37, 211, 102, 0.08)';\n                connectionSelect.style.borderColor = 'rgba(37, 211, 102, 0.3)';\n                showMessage(syncModalMessage, '', ''); // Limpar mensagens\n            } else {\n                connectionWarning.style.display = 'none';\n                fetchGroupsBtn.disabled = true;\n                // Atualizar cor do select para desconectado\n                connectionSelect.style.color = '#ff4444';\n                connectionSelect.style.backgroundColor = 'rgba(255, 68, 68, 0.08)';\n                connectionSelect.style.borderColor = 'rgba(255, 68, 68, 0.3)';\n                showMessage(syncModalMessage, 'Conexão desconectada. Conecte o WhatsApp antes de sincronizar grupos.', 'error');\n            }\n        }\n    }\n    \n    // Mostrar resumo quando todas as conexões forem verificadas\n    function showConnectionsStatusComplete() {\n        const connectedCount = connections.filter(conn => conn.isConnected).length;\n        const totalCount = connections.length;\n        \n        if (connectedCount === 0) {\n            showMessage(syncModalMessage, `Nenhuma das ${totalCount} conexão(ões) está conectada. Conecte pelo menos uma no WhatsApp.`, 'error');\n        } else if (connectedCount === totalCount) {\n            showMessage(syncModalMessage, `✅ Todas as ${totalCount} conexão(ões) estão conectadas!`, 'success');\n        } else {\n            showMessage(syncModalMessage, `${connectedCount} de ${totalCount} conexão(ões) conectada(s). Escolha uma conectada para sincronizar.`, 'info');\n        }\n    }\n\n    // Ao selecionar conexão\n    connectionSelect.addEventListener('change', function() {\n        const val = connectionSelect.value;\n        const selectedOption = connectionSelect.options[connectionSelect.selectedIndex];\n        const connectionStatus = selectedOption && selectedOption.getAttribute('data-connected');\n        const isConnected = connectionStatus === '1';\n        const isChecking = connectionStatus === 'checking';\n        \n        // Atualizar cor do select baseado no status da conexão selecionada\n        if (isConnected) {\n            connectionSelect.style.color = '#25d366';\n            connectionSelect.style.backgroundColor = 'rgba(37, 211, 102, 0.08)';\n            connectionSelect.style.borderColor = 'rgba(37, 211, 102, 0.3)';\n        } else if (isChecking) {\n            connectionSelect.style.color = '#888';\n            connectionSelect.style.backgroundColor = 'rgba(136, 136, 136, 0.08)';\n            connectionSelect.style.borderColor = 'rgba(136, 136, 136, 0.3)';\n        } else if (connectionStatus === '0') {\n            connectionSelect.style.color = '#ff4444';\n            connectionSelect.style.backgroundColor = 'rgba(255, 68, 68, 0.08)';\n            connectionSelect.style.borderColor = 'rgba(255, 68, 68, 0.3)';\n        } else {\n            // Reset para padrão quando seleciona \"Selecione...\"\n            connectionSelect.style.color = 'white';\n            connectionSelect.style.backgroundColor = 'rgba(255, 255, 255, 0.05)';\n            connectionSelect.style.borderColor = 'rgba(255, 255, 255, 0.2)';\n        }\n        \n        selectedConnection = connections.find(conn => (conn.instanceName || conn.instance_name) === val) || null;\n        \n        if (selectedConnection && isConnected) {\n            connectionWarning.style.display = 'block';\n            fetchGroupsBtn.disabled = false;\n            showMessage(syncModalMessage, '', ''); // Limpar mensagens\n        } else if (selectedConnection && isChecking) {\n            connectionWarning.style.display = 'none';\n            fetchGroupsBtn.disabled = true;\n            showMessage(syncModalMessage, 'Verificando status da conexão...', 'info');\n        } else if (selectedConnection && !isConnected) {\n            connectionSelect.value = '';\n            selectedConnection = null;\n            connectionWarning.style.display = 'none';\n            fetchGroupsBtn.disabled = true;\n            showMessage(syncModalMessage, 'Conexão desconectada. Conecte o WhatsApp antes de sincronizar grupos.', 'error');\n            // Reset cor quando deseleciona\n            connectionSelect.style.color = 'white';\n            connectionSelect.style.backgroundColor = 'rgba(255, 255, 255, 0.05)';\n            connectionSelect.style.borderColor = 'rgba(255, 255, 255, 0.2)';\n        } else {\n            connectionWarning.style.display = 'none';\n            fetchGroupsBtn.disabled = true;\n            showMessage(syncModalMessage, '', ''); // Limpar mensagens\n        }\n        \n        groupsSearchContainer.style.display = 'none';\n        saveGroupsContainer.style.display = 'none';\n        groupsList.innerHTML = '';\n        allGroups = [];\n        filteredGroups = [];\n        selectedGroups = [];\n        \n        // Resetar contador\n        const countDiv = document.getElementById('groupsListCount');\n        if (countDiv) {\n            countDiv.textContent = '0 grupos encontrados';\n            countDiv.style.color = '#25d366';\n        }\n        \n        // Limpar campo de pesquisa\n        groupsSearchInput.value = '';\n    });\n\n    // Puxar grupos\n    fetchGroupsBtn.addEventListener('click', async function(e) {\n        e.preventDefault();\n        if (!selectedConnection) return;\n        setButtonLoading(fetchGroupsBtn, true);\n        groupsSearchContainer.style.display = 'none';\n        saveGroupsContainer.style.display = 'none';\n        groupsList.innerHTML = '';\n        showMessage(syncModalMessage, '', '');\n        // Barra de progresso\n        let progressDiv = document.getElementById('progressBarContainer');\n        if (!progressDiv) {\n            progressDiv = document.createElement('div');\n            progressDiv.id = 'progressBarContainer';\n            progressDiv.className = 'progress-bar-container';\n            progressDiv.innerHTML = `\n                <div class=\"progress-bar\" id=\"progressBar\" style=\"width:0%\"></div>\n                <div class=\"progress-bar-text\" id=\"progressBarText\">Puxando grupos... 0%</div>\n            `;\n            fetchGroupsBtn.parentElement.insertAdjacentElement('afterend', progressDiv);\n        } else {\n            progressDiv.style.display = 'flex';\n        }\n        let percent = 0;\n        const progressBar = document.getElementById('progressBar');\n        const progressBarText = document.getElementById('progressBarText');\n        let elapsed = 0;\n        const interval = setInterval(() => {\n            if (percent < 100) {\n                percent += 100/60;\n                if (percent > 100) percent = 100;\n                progressBar.style.width = percent + '%';\n                progressBarText.textContent = `Puxando grupos... ${Math.floor(percent)}%`;\n            } else {\n                // Não cancela, só mantém a barra cheia\n                progressBar.style.width = '100%';\n                progressBarText.textContent = 'Puxando grupos... 100%';\n            }\n            elapsed++;\n        }, 1000);\n        try {\n            const response = await fetch('https://n8n.typebot.pro/webhook/listar-grupos', {\n                method: 'POST',\n                headers: { 'Content-Type': 'application/json' },\n                body: JSON.stringify({ instanceName: selectedConnection.instanceName || selectedConnection.instance_name })\n            });\n            clearInterval(interval);\n            progressBar.style.width = '100%';\n            progressBarText.textContent = 'Puxando grupos... 100%';\n            setTimeout(() => { if(progressDiv) progressDiv.style.display = 'none'; }, 600);\n            if (!response.ok) throw new Error('Erro ao puxar grupos');\n            const data = await response.json();\n            let groupsData = [];\n            if (Array.isArray(data) && data.length > 0 && data[0].data && Array.isArray(data[0].data)) groupsData = data[0].data;\n            else if (data && data.data && Array.isArray(data.data)) groupsData = data.data;\n            else if (Array.isArray(data)) groupsData = data;\n            // Marcar como selecionados os grupos já salvos\n            const whatsIdsSalvos = new Set(gruposSalvos.map(g => String(g.WhatsAppId || g.WhatsappId || g.whatsappid || g.whatsappId || '')));\n            allGroups = groupsData.map(g => {\n                const idStr = String(g.id);\n                return {\n                    id: g.id,\n                    name: g.subject,\n                    participants: g.size || 0,\n                    added_at: g.createdAt || new Date().toISOString(),\n                    selected: !whatsIdsSalvos.has(idStr), // Selecionar apenas grupos novos por padrão\n                    WhatsappId: g.WhatsappId || g.whatsappid || g.whatsappId || '',\n                    idConexao: g.idConexao || g.id_conexao || ''\n                };\n            });\n            filteredGroups = [...allGroups];\n            renderGroupsList();\n            groupsSearchContainer.style.display = 'block';\n            showMessage(syncModalMessage, `✅ ${allGroups.length} grupos carregados!`, 'success');\n        } catch (e) {\n            clearInterval(interval);\n            if(progressDiv) progressDiv.style.display = 'none';\n            showMessage(syncModalMessage, e.message, 'error');\n            allGroups = [];\n            filteredGroups = [];\n            renderGroupsList();\n        } finally {\n            setButtonLoading(fetchGroupsBtn, false);\n        }\n    });\n\n    // Busca por nome\n    groupsSearchInput.addEventListener('input', function() {\n        const term = groupsSearchInput.value.toLowerCase().trim();\n        filteredGroups = allGroups.filter(g => g.name.toLowerCase().includes(term));\n        renderGroupsList();\n    });\n\n    // Renderizar lista de grupos no popup (com detecção de duplicatas)\n    function renderGroupsList() {\n        groupsList.innerHTML = '';\n        if (filteredGroups.length === 0) {\n            groupsList.innerHTML = `<div style=\"color:#888;text-align:center;padding:30px 0;\">Nenhum grupo encontrado.</div>`;\n            const countDiv = document.getElementById('groupsListCount');\n            if (countDiv) {\n                countDiv.textContent = '0 grupos encontrados';\n                countDiv.style.color = '#25d366';\n            }\n            if (saveGroupsContainer) {\n                saveGroupsContainer.style.display = 'none';\n            }\n            return;\n        }\n\n        // Obter IDs dos grupos já existentes na lista\n        const existingGroupIds = new Set(gruposSalvos.map(g => String(g.WhatsAppId || g.WhatsappId || g.whatsappid || g.whatsappId || '')));\n\n        // Verificar duplicatas e marcar grupos\n        filteredGroups.forEach(group => {\n            const groupIdStr = String(group.id);\n            group.isDuplicate = existingGroupIds.has(groupIdStr);\n        });\n\n        filteredGroups.forEach(group => {\n            const duplicateClass = group.isDuplicate ? 'duplicate' : '';\n            const duplicateBadge = group.isDuplicate ? '<span class=\"duplicate-badge\">JÁ EXISTE</span>' : '';\n            \n            const groupDiv = document.createElement('div');\n            groupDiv.className = `group-item ${duplicateClass}`;\n            groupDiv.innerHTML = `\n                <input type=\"checkbox\" class=\"group-checkbox\" ${group.selected ? 'checked' : ''} onchange=\"toggleGroupSelection('${group.id}')\">\n                <div class=\"group-info\">\n                    <div class=\"group-name\">${group.name}</div>\n                    <div class=\"group-details\">\n                        <span>${group.participants} participantes</span>\n                    </div>\n                </div>\n                ${duplicateBadge}\n            `;\n            groupsList.appendChild(groupDiv);\n        });\n        updateSelectedGroupsCounter();\n    }\n\n    // Selecionar grupo\n    function toggleGroupSelection(groupId) {\n        const group = allGroups.find(g => g.id === groupId);\n        if (group) {\n            group.selected = !group.selected;\n            renderGroupsList(); // re-renderiza para atualizar o checkbox e contador\n        }\n    }\n    // Torna global para funcionar no onchange do checkbox\n    window.toggleGroupSelection = toggleGroupSelection;\n\n    // Selecionar/desmarcar todos os grupos\n    function selectAllGroups(selectAll) {\n        allGroups.forEach(group => {\n            group.selected = selectAll;\n        });\n        renderGroupsList();\n    }\n    // Torna global para funcionar no onclick\n    window.selectAllGroups = selectAllGroups;\n\n    // Salvar grupos selecionados\n    saveGroupsBtn.addEventListener('click', async function(e) {\n        e.preventDefault();\n        if (!selectedConnection) return;\n        \n        const selectedGroups = allGroups.filter(g => g.selected);\n        \n        if (selectedGroups.length === 0) {\n            showMessage(syncModalMessage, 'Selecione pelo menos um grupo para salvar.', 'info');\n            return;\n        }\n\n        // Filtrar apenas grupos novos (não duplicados)\n        const newGroupsOnly = selectedGroups.filter(g => !g.isDuplicate);\n        \n        if (newGroupsOnly.length === 0) {\n            showMessage(syncModalMessage, `Todos os ${selectedGroups.length} grupo(s) selecionado(s) já existem na lista.`, 'info');\n            setButtonLoading(saveGroupsBtn, false);\n            return;\n        }\n\n        // Se alguns grupos foram filtrados, mostrar aviso\n        if (newGroupsOnly.length < selectedGroups.length) {\n            const filteredCount = selectedGroups.length - newGroupsOnly.length;\n            showMessage(syncModalMessage, `${filteredCount} grupo(s) já existem na lista e foram ignorados. Salvando ${newGroupsOnly.length} grupo(s) novo(s)...`, 'info');\n        }\n\n        // Preparar grupos para salvar\n        const groupsToSave = newGroupsOnly.map(g => ({ \n            nome: g.name, \n            id: g.id, \n            WhatsappId: g.WhatsappId, \n            idConexao: g.idConexao \n        }));\n        \n        setButtonLoading(saveGroupsBtn, true);\n        try {\n            // Obter userId dos cookies\n            const userId = getSecureUserId();\n            if (!userId) {\n                showMessage(syncModalMessage, '❌ Não foi possível identificar o usuário (userId).', 'error');\n                setButtonLoading(saveGroupsBtn, false);\n                return;\n            }\n            // Obter idLista dos cookies\n            const currentList = getListFromCookies();\n            if (!currentList) {\n                showMessage(syncModalMessage, '❌ Não foi possível identificar a lista (idLista).', 'error');\n                setButtonLoading(saveGroupsBtn, false);\n                return;\n            }\n            const idLista = currentList.id;\n            // Enviar idConexao ao invés de instanceName\n            const idConexao = selectedConnection.idConexao || selectedConnection.id || selectedConnection.id_conexao;\n            const instanceName = selectedConnection.instanceName || selectedConnection.instance_name;\n            const body = {\n                userId,\n                idLista, // sempre enviar idLista\n                idConexao,\n                grupos: groupsToSave\n            };\n            const response = await fetch('https://n8n.typebot.pro/webhook/salvar-grupos', {\n                method: 'POST',\n                headers: { 'Content-Type': 'application/json' },\n                body: JSON.stringify(body)\n            });\n            if (!response.ok) throw new Error('Erro ao salvar grupos');\n            const respData = await response.json().catch(() => null);\n            console.log('[API] Resposta salvar-grupos:', respData);\n            // Vincular conexão à lista\n            await fetch('https://n8n.typebot.pro/webhook/vincular-conexao', {\n                method: 'POST',\n                headers: { 'Content-Type': 'application/json' },\n                body: JSON.stringify({ idLista, idConexao })\n            });\n            \n            const successMessage = newGroupsOnly.length < selectedGroups.length \n                ? `✅ ${newGroupsOnly.length} grupo(s) novo(s) salvos com sucesso! (${selectedGroups.length - newGroupsOnly.length} grupo(s) já existiam na lista)`\n                : `✅ ${newGroupsOnly.length} grupo(s) salvos com sucesso!`;\n            \n            showMessage(syncModalMessage, successMessage, 'success');\n            // Fechar popup\n            closeSyncModalFn();\n            // Aviso de contagem\n            showMessage(groupsMessage, '⏳ Contando participantes dos grupos salvos... Isso pode levar alguns minutos. ⚠️ Observação: Alguns grupos podem não trazer todos os participantes.', 'info');\n            // Para cada grupo salvo, faz POST para contar-participantes (não espera resposta)\n            groupsToSave.forEach(g => {\n                const whatsappId = g.WhatsappId || g.WhatsAppId || g.whatsappid || g.whatsappId || '';\n                const idConexao = g.idConexao || g.id_conexao || g.id || '';\n                if (whatsappId && idConexao) {\n                    fetch('https://n8n.typebot.pro/webhook/contar-participantes', {\n                        method: 'POST',\n                        headers: { 'Content-Type': 'application/json' },\n                        body: JSON.stringify({ WhatsAppId: whatsappId, idConexao: idConexao })\n                    });\n                }\n            });\n            // Atualiza lista de grupos sincronizados\n            loadGruposSincronizados();\n        } catch (e) {\n            showMessage(syncModalMessage, e.message, 'error');\n        } finally {\n            setButtonLoading(saveGroupsBtn, false);\n        }\n    });\n\n    // Paginação de grupos\n    function renderPagination() {\n        const totalPages = Math.ceil(gruposSalvos.length / groupsPerPage);\n        const paginationContainerId = 'groupsPagination';\n        let paginationContainer = document.getElementById(paginationContainerId);\n        if (!paginationContainer) {\n            paginationContainer = document.createElement('div');\n            paginationContainer.id = paginationContainerId;\n            paginationContainer.style.display = 'flex';\n            paginationContainer.style.justifyContent = 'center';\n            paginationContainer.style.gap = '8px';\n            paginationContainer.style.margin = '20px auto 0 auto';\n            paginationContainer.style.flexWrap = 'wrap';\n            paginationContainer.style.width = '100%';\n            paginationContainer.style.maxWidth = '100%';\n            paginationContainer.style.clear = 'both';\n            paginationContainer.style.position = 'relative';\n            paginationContainer.style.zIndex = '1';\n            paginationContainer.style.boxSizing = 'border-box';\n            \n            // Inserir após a tabela, não dentro dela\n            if (!document.getElementById(paginationContainerId)) {\n                const tableSection = document.querySelector('.groups-table-container').closest('.section');\n                if (tableSection) {\n                    tableSection.appendChild(paginationContainer);\n                }\n            }\n        }\n        paginationContainer.innerHTML = '';\n        if (totalPages <= 1) {\n            paginationContainer.style.display = 'none';\n            return;\n        } else {\n            paginationContainer.style.display = 'flex';\n        }\n\n        // Lógica de paginação inteligente (máximo 10 páginas visíveis)\n        const maxVisiblePages = 10;\n        let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));\n        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);\n        \n        // Ajustar se não tiver páginas suficientes no início\n        if (endPage - startPage + 1 < maxVisiblePages) {\n            startPage = Math.max(1, endPage - maxVisiblePages + 1);\n        }\n\n        // Botão \"Primeira página\" (se não estiver no início)\n        if (startPage > 1) {\n            const firstBtn = document.createElement('button');\n            firstBtn.textContent = '« Primeira';\n            firstBtn.className = 'btn btn-secondary';\n            firstBtn.style.padding = '6px 12px';\n            firstBtn.style.fontSize = '0.85rem';\n            firstBtn.onclick = () => {\n                currentPage = 1;\n                renderGroupsTable();\n            };\n            paginationContainer.appendChild(firstBtn);\n        }\n\n        // Botão \"Anterior\"\n        if (currentPage > 1) {\n            const prevBtn = document.createElement('button');\n            prevBtn.textContent = '‹ Anterior';\n            prevBtn.className = 'btn btn-secondary';\n            prevBtn.style.padding = '6px 12px';\n            prevBtn.style.fontSize = '0.85rem';\n            prevBtn.onclick = () => {\n                currentPage = Math.max(1, currentPage - 1);\n                renderGroupsTable();\n            };\n            paginationContainer.appendChild(prevBtn);\n        }\n\n        // Páginas numeradas\n        for (let i = startPage; i <= endPage; i++) {\n            const btn = document.createElement('button');\n            btn.textContent = i;\n            btn.className = 'btn btn-secondary';\n            btn.style.minWidth = '36px';\n            btn.style.padding = '6px 12px';\n            btn.style.fontWeight = i === currentPage ? '700' : '500';\n            btn.style.background = i === currentPage ? 'linear-gradient(135deg, #25d366 0%, #128c7e 100%)' : '';\n            btn.style.color = i === currentPage ? 'white' : '';\n            btn.disabled = i === currentPage;\n            btn.onclick = () => {\n                currentPage = i;\n                renderGroupsTable();\n            };\n            paginationContainer.appendChild(btn);\n        }\n\n        // Botão \"Próxima\"\n        if (currentPage < totalPages) {\n            const nextBtn = document.createElement('button');\n            nextBtn.textContent = 'Próxima ›';\n            nextBtn.className = 'btn btn-secondary';\n            nextBtn.style.padding = '6px 12px';\n            nextBtn.style.fontSize = '0.85rem';\n            nextBtn.onclick = () => {\n                currentPage = Math.min(totalPages, currentPage + 1);\n                renderGroupsTable();\n            };\n            paginationContainer.appendChild(nextBtn);\n        }\n\n        // Botão \"Última página\" (se não estiver no final)\n        if (endPage < totalPages) {\n            const lastBtn = document.createElement('button');\n            lastBtn.textContent = 'Última »';\n            lastBtn.className = 'btn btn-secondary';\n            lastBtn.style.padding = '6px 12px';\n            lastBtn.style.fontSize = '0.85rem';\n            lastBtn.onclick = () => {\n                currentPage = totalPages;\n                renderGroupsTable();\n            };\n            paginationContainer.appendChild(lastBtn);\n        }\n    }\n\n    // Sempre que sincronizar grupos, resetar para página 1\n    function resetPagination() {\n        currentPage = 1;\n    }\n\n    // Renderizar tabela de grupos salvos (apenas quando dados já foram carregados)\n    function renderGroupsTable() {\n        // Se não há grupos, mostrar mensagem de \"nenhum grupo\"\n        if (!gruposSalvos.length) {\n            groupsTableBody.innerHTML = `\n                <tr>\n                    <td colspan=\"4\" style=\"text-align: center; color: #888; padding: 40px 20px;\">\n                        <div style=\"font-size: 3rem; margin-bottom: 15px;\">\n                            <svg style=\"width: 48px; height: 48px; fill: #888;\" viewBox=\"0 0 24 24\">\n                                <path d=\"M12,5.5A3.5,3.5 0 0,1 15.5,9A3.5,3.5 0 0,1 12,12.5A3.5,3.5 0 0,1 8.5,9A3.5,3.5 0 0,1 12,5.5M5,8C5.56,8 6.08,8.15 6.53,8.42C6.38,9.85 6.8,11.27 7.66,12.38C7.16,13.34 6.16,14 5,14A3,3 0 0,1 2,11A3,3 0 0,1 5,8M19,8A3,3 0 0,1 22,11A3,3 0 0,1 19,14C17.84,14 16.84,13.34 16.34,12.38C17.2,11.27 17.62,9.85 17.47,8.42C17.92,8.15 18.44,8 19,8M5.5,18.25C5.5,16.18 8.41,14.5 12,14.5C15.59,14.5 18.5,16.18 18.5,18.25V20H5.5V18.25M0,20V18.5C0,17.11 1.89,15.94 4.45,15.6C3.86,16.28 3.5,17.22 3.5,18.25V20H0M24,20H20.5V18.25C20.5,17.22 20.14,16.28 19.55,15.6C22.11,15.94 24,17.11 24,18.5V20Z\"/>\n                            </svg>\n                        </div>\n                        <p>Nenhum grupo sincronizado.</p>\n                        <p style=\"font-size: 0.85rem;\">Sincronize seus grupos usando o botão \"Sincronizar Grupos\" acima.</p>\n                    </td>\n                </tr>\n            `;\n            renderHeaderInfo();\n            renderPagination();\n            return;\n        }\n        \n        // Paginação\n        const startIdx = (currentPage - 1) * groupsPerPage;\n        const endIdx = startIdx + groupsPerPage;\n        const pageGroups = gruposSalvos.slice(startIdx, endIdx);\n        \n        groupsTableBody.innerHTML = pageGroups.map(g => `\n            <tr>\n                <td class=\"group-name\">${g.name}</td>\n                <td class=\"group-participants\">${g.participants}</td>\n                <td class=\"group-date\">${formatDate(g.added_at)}</td>\n                <td class=\"group-actions\">\n                    <button class=\"action-btn delete\" onclick=\"deleteGroup('${g.id}')\" title=\"Excluir\">\n                        <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\n                            <path d=\"M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z\"/>\n                        </svg>\n                    </button>\n                    <button class=\"action-btn export\" onclick=\"exportarParticipantes('${g.idConexao}','${g.WhatsAppId || g.WhatsappId || g.whatsappid || g.whatsappId}')\" title=\"Exportar participantes\" style=\"margin-left:4px;\">\n                        <svg width=\"14\" height=\"14\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\n                            <path d=\"M5,20H19V18H5M19,9H15V3H9V9H5L12,16L19,9Z\"/>\n                        </svg>\n                    </button>\n                </td>\n            </tr>\n        `).join('');\n        \n        renderHeaderInfo();\n        renderPagination();\n    }\n\n    // Excluir grupo\n    window.deleteGroup = async function(id) {\n        if (confirm('Tem certeza que deseja excluir este grupo da lista?')) {\n            const exportMsg = document.getElementById('exportMessage');\n            try {\n                const resp = await fetch('https://n8n.typebot.pro/webhook/excluir-grupo', {\n                    method: 'POST',\n                    headers: { 'Content-Type': 'application/json' },\n                    body: JSON.stringify({ idGrupo: id })\n                });\n                if (!resp.ok) {\n                    showMessage(groupsMessage, 'Erro ao excluir grupo.', 'error');\n                    return;\n                }\n                \n                // Remover o grupo da lista local sem fazer nova busca\n                const grupoIndex = gruposSalvos.findIndex(g => g.id == id);\n                if (grupoIndex !== -1) {\n                    gruposSalvos.splice(grupoIndex, 1);\n                    \n                    // Verificar se precisa ajustar a página atual\n                    const totalPages = Math.ceil(gruposSalvos.length / groupsPerPage);\n                    if (currentPage > totalPages && totalPages > 0) {\n                        currentPage = totalPages;\n                    }\n                    \n                    // Atualizar a interface\n                    renderGroupsTable();\n                    showMessage(groupsMessage, '✅ Grupo excluído com sucesso!', 'success');\n                }\n                \n                if (exportMsg) {\n                    exportMsg.textContent = 'Grupo removido.';\n                    exportMsg.style.background = 'rgba(255, 193, 7, 0.1)';\n                    exportMsg.style.color = '#ffc107';\n                    exportMsg.style.border = '1.5px solid rgba(255,193,7,0.3)';\n                    exportMsg.style.boxShadow = '0 4px 24px rgba(0,0,0,0.10)';\n                    exportMsg.style.borderRadius = '12px';\n                    exportMsg.style.padding = '16px 32px';\n                    exportMsg.style.fontWeight = '600';\n                    exportMsg.style.fontSize = '1.05rem';\n                    exportMsg.style.top = '24px';\n                    exportMsg.style.left = '50%';\n                    exportMsg.style.transform = 'translateX(-50%)';\n                    exportMsg.style.minWidth = '320px';\n                    exportMsg.style.maxWidth = '90vw';\n                    exportMsg.style.textAlign = 'center';\n                    exportMsg.style.opacity = '0.98';\n                    exportMsg.style.pointerEvents = 'none';\n                    exportMsg.style.display = 'block';\n                    setTimeout(() => { exportMsg.style.display = 'none'; }, 4000);\n                }\n            } catch (e) {\n                showMessage(groupsMessage, 'Erro ao excluir grupo: ' + e.message, 'error');\n            }\n        }\n    };\n\n    // Função para atualizar o contador de grupos selecionados no popup\n    function updateSelectedGroupsCounter() {\n        const countDiv = document.getElementById('groupsListCount');\n        if (!countDiv) return;\n\n        const selectedCount = allGroups.filter(g => g.selected).length;\n        const totalCount = allGroups.length;\n        const newGroupsCount = allGroups.filter(g => g.selected && !g.isDuplicate).length;\n        const duplicateSelectedCount = allGroups.filter(g => g.selected && g.isDuplicate).length;\n        \n        let countText = `${selectedCount} de ${totalCount} grupos selecionados`;\n        \n        if (duplicateSelectedCount > 0) {\n            countText += ` (${newGroupsCount} novos, ${duplicateSelectedCount} já existem)`;\n        }\n        \n        countDiv.textContent = countText;\n        \n        // Exibe ou esconde o botão de salvar grupos baseado na seleção de grupos novos\n        if (saveGroupsContainer) {\n            saveGroupsContainer.style.display = newGroupsCount > 0 ? 'block' : 'none';\n        }\n        \n        // Alterar cor do contador se apenas grupos existentes estiverem selecionados\n        if (countDiv) {\n            if (selectedCount > 0 && newGroupsCount === 0) {\n                countDiv.style.color = '#ffc107';\n            } else {\n                countDiv.style.color = '#25d366';\n            }\n        }\n    }\n\n    // Função para contar participantes de todos os grupos sincronizados\n    function contarParticipantesTodosGrupos() {\n        console.log('🔄 Função contarParticipantesTodosGrupos chamada');\n        console.log('📊 Grupos salvos:', gruposSalvos.length);\n        console.log('📋 Elemento groupsMessage:', groupsMessage);\n        \n        if (!gruposSalvos.length) {\n            console.log('⚠️ Nenhum grupo encontrado');\n            showMessage(groupsMessage, 'Nenhum grupo sincronizado para contar participantes.', 'info');\n            return;\n        }\n        \n        const countBtn = document.getElementById('countParticipantsBtn');\n        console.log('🔘 Botão encontrado:', !!countBtn);\n        \n        // Desabilitar botão temporariamente com feedback visual\n        if (countBtn) {\n            countBtn.disabled = true;\n            countBtn.innerHTML = '<svg class=\"btn-icon\" viewBox=\"0 0 24 24\"><path d=\"M12,5.5A3.5,3.5 0 0,1 15.5,9A3.5,3.5 0 0,1 12,12.5A3.5,3.5 0 0,1 8.5,9A3.5,3.5 0 0,1 12,5.5M5,8C5.56,8 6.08,8.15 6.53,8.42C6.38,9.85 6.8,11.27 7.66,12.38C7.16,13.34 6.16,14 5,14A3,3 0 0,1 2,11A3,3 0 0,1 5,8M19,8A3,3 0 0,1 22,11A3,3 0 0,1 19,14C17.84,14 16.84,13.34 16.34,12.38C17.2,11.27 17.62,9.85 17.47,8.42C17.92,8.15 18.44,8 19,8M5.5,18.25C5.5,16.18 8.41,14.5 12,14.5C15.59,14.5 18.5,16.18 18.5,18.25V20H5.5V18.25M0,20V18.5C0,17.11 1.89,15.94 4.45,15.6C3.86,16.28 3.5,17.22 3.5,18.25V20H0M24,20H20.5V18.25C20.5,17.22 20.14,16.28 19.55,15.6C22.11,15.94 24,17.11 24,18.5V20Z\"/></svg>Contando...';\n        }\n        \n        console.log('📢 Exibindo mensagem...');\n        showMessage(groupsMessage, `⏳ Contando participantes dos ${gruposSalvos.length} grupos sincronizados... Isso pode levar alguns minutos. ⚠️ Observação: Alguns grupos podem não trazer todos os participantes.`, 'info');\n        \n        gruposSalvos.forEach(g => {\n            fetch('https://n8n.typebot.pro/webhook/contar-participantes', {\n                method: 'POST',\n                headers: { 'Content-Type': 'application/json' },\n                body: JSON.stringify({ WhatsAppId: g.WhatsAppId, idConexao: g.idConexao })\n            });\n        });\n        \n        // Reativar botão após 5 segundos (tempo para mostrar feedback)\n        setTimeout(() => {\n            if (countBtn) {\n                countBtn.disabled = false;\n                countBtn.innerHTML = '<svg class=\"btn-icon\" viewBox=\"0 0 24 24\"><path d=\"M12,5.5A3.5,3.5 0 0,1 15.5,9A3.5,3.5 0 0,1 12,12.5A3.5,3.5 0 0,1 8.5,9A3.5,3.5 0 0,1 12,5.5M5,8C5.56,8 6.08,8.15 6.53,8.42C6.38,9.85 6.8,11.27 7.66,12.38C7.16,13.34 6.16,14 5,14A3,3 0 0,1 2,11A3,3 0 0,1 5,8M19,8A3,3 0 0,1 22,11A3,3 0 0,1 19,14C17.84,14 16.84,13.34 16.34,12.38C17.2,11.27 17.62,9.85 17.47,8.42C17.92,8.15 18.44,8 19,8M5.5,18.25C5.5,16.18 8.41,14.5 12,14.5C15.59,14.5 18.5,16.18 18.5,18.25V20H5.5V18.25M0,20V18.5C0,17.11 1.89,15.94 4.45,15.6C3.86,16.28 3.5,17.22 3.5,18.25V20H0M24,20H20.5V18.25C20.5,17.22 20.14,16.28 19.55,15.6C22.11,15.94 24,17.11 24,18.5V20Z\"/></svg>Contar Participantes';\n            }\n        }, 5000);\n    }\n\n    // Inicialização da tabela e carregamento automático\n    document.addEventListener('DOMContentLoaded', async function() {\n        console.log('🚀 Iniciando carregamento da página de Lista de Grupos...');\n        \n        if (!checkAuth()) {\n            return; // checkAuth já redireciona se necessário\n        }\n        \n        // Inicializar com nome oculto - será mostrado após buscarNomeLista()\n        const listNameDisplay = document.getElementById('listNameHighlight');\n        if (listNameDisplay) {\n            listNameDisplay.style.opacity = '0';\n            listNameDisplay.style.visibility = 'hidden';\n            listNameDisplay.textContent = 'Carregando...';\n        }\n        \n        try {\n            await buscarNomeLista();\n            await puxarListaGrupoAntes();\n            loadGruposSincronizados();\n            \n            const refreshBtn = document.getElementById('refreshGroupsBtn');\n            if (refreshBtn) refreshBtn.addEventListener('click', async () => {\n                setButtonLoading(refreshBtn, true);\n                resetPagination();\n                await loadGruposSincronizados();\n                setButtonLoading(refreshBtn, false);\n            });\n            \n            const countBtn = document.getElementById('countParticipantsBtn');\n            if (countBtn) {\n                console.log('✅ Anexando evento ao botão contar participantes');\n                countBtn.addEventListener('click', contarParticipantesTodosGrupos);\n            } else {\n                console.error('❌ Botão contarParticipantsBtn não encontrado');\n            }\n            \n            console.log('✅ Página de Lista de Grupos carregada com sucesso');\n        } catch (error) {\n            console.error('❌ Erro durante inicialização:', error);\n        }\n    });\n\n    // No JS, após carregar a página e puxar-listagrupo, renderizar a caixinha se houver conexão vinculada\n    function renderConexaoVinculadaBox() {\n        const box = document.getElementById('conexaoVinculadaBox');\n        if (!box) return;\n        if (conexaoVinculadaInfo && (conexaoVinculadaInfo.instanceName || conexaoVinculadaInfo.NomeConexao)) {\n            const nome = conexaoVinculadaInfo.NomeConexao || conexaoVinculadaInfo.instanceName;\n            const tel = conexaoVinculadaInfo.Telefone || conexaoVinculadaInfo.telefone || '';\n            const instance = conexaoVinculadaInfo.instanceName || conexaoVinculadaInfo.NomeConexao;\n            const foto = conexaoVinculadaInfo.FotoPerfil || '';\n            box.style.display = 'flex';\n            box.style.alignItems = 'center';\n            box.style.gap = '16px';\n            box.style.background = 'rgba(255,255,255,0.03)';\n            box.style.border = '1px solid rgba(255,255,255,0.10)';\n            box.style.borderRadius = '12px';\n            box.style.padding = '14px 22px';\n            box.style.marginBottom = '18px';\n            // Badge de status\n            let badge = '<span id=\"badgeStatusConexao\" style=\"margin-left:10px; font-weight:600; font-size:0.98rem; padding:2px 12px; border-radius:12px; background:#444; color:#fff;\">Verificando...</span>';\n            let fotoHtml = foto ? `<img src=\"${foto}\" alt=\"Foto perfil\" style=\"width:44px;height:44px;border-radius:50%;object-fit:cover;border:2px solid #25d366;\">` : '';\n            box.innerHTML = `${fotoHtml}<div><b>Conexão vinculada:</b> <span style='color:#25d366;'>${nome}</span>${tel ? `<span style='color:#888; font-size:0.98rem; margin-left:10px;'>${tel}</span>` : ''} ${badge}</div>`;\n            // Checa status\n            if (instance) {\n                fetch(`https://whatsapi.typebot.pro/instance/connectionState/${encodeURIComponent(instance)}`, {\n                    method: 'GET',\n                    headers: { 'apikey': 'b4d71f9c38e3ac12a6b08e4b6d53aa90' }\n                }).then(r => r.json()).then(statusData => {\n                    const state = statusData?.instance?.state || statusData?.state || statusData?.status || statusData?.connectionState;\n                    const badgeEl = document.getElementById('badgeStatusConexao');\n                    if (badgeEl) {\n                        if (state === 'open' || state === 'connected') {\n                            badgeEl.innerHTML = '<svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"currentColor\" style=\"margin-right:4px;\"><circle cx=\"12\" cy=\"12\" r=\"10\" fill=\"#25d366\"/></svg> Conectada';\n                            badgeEl.style.background = 'rgba(37,211,102,0.15)';\n                            badgeEl.style.color = '#25d366';\n                        } else {\n                            badgeEl.innerHTML = '<svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"currentColor\" style=\"margin-right:4px;\"><circle cx=\"12\" cy=\"12\" r=\"10\" fill=\"#ff4444\"/></svg> Desconectada';\n                            badgeEl.style.background = 'rgba(255,68,68,0.15)';\n                            badgeEl.style.color = '#ff4444';\n                        }\n                    }\n                }).catch(() => {\n                    const badgeEl = document.getElementById('badgeStatusConexao');\n                    if (badgeEl) {\n                        badgeEl.innerHTML = '<svg width=\"12\" height=\"12\" viewBox=\"0 0 24 24\" fill=\"currentColor\" style=\"margin-right:4px;\"><circle cx=\"12\" cy=\"12\" r=\"10\" fill=\"#ff4444\"/></svg> Desconhecido';\n                        badgeEl.style.background = 'rgba(255,68,68,0.15)';\n                        badgeEl.style.color = '#ff4444';\n                    }\n                });\n            }\n        } else {\n            box.style.display = 'none';\n            box.innerHTML = '';\n        }\n    }\n\n    // Função para exportar participantes\n    window.exportarParticipantes = async function(idConexao, WhatsAppId) {\n        const exportMsg = document.getElementById('exportMessage');\n        if (!idConexao || !WhatsAppId) {\n            alert('idConexao ou WhatsAppId não encontrado para exportação.');\n            return;\n        }\n        // Buscar nome do grupo\n        const grupo = gruposSalvos.find(g => g.idConexao == idConexao && (g.WhatsAppId === WhatsAppId || g.WhatsappId === WhatsAppId));\n        const nomeGrupo = grupo ? grupo.name : 'grupo';\n        // Data do dia\n        const hoje = new Date();\n        const dia = String(hoje.getDate()).padStart(2, '0');\n        const mes = String(hoje.getMonth() + 1).padStart(2, '0');\n        const ano = hoje.getFullYear();\n        const dataStr = `${dia}/${mes}/${ano}`;\n        try {\n            if (exportMsg) {\n                exportMsg.textContent = 'Exportando participantes...';\n                exportMsg.style.background = 'rgba(255, 193, 7, 0.1)';\n                exportMsg.style.color = '#ffc107';\n                exportMsg.style.border = '1.5px solid rgba(255,193,7,0.3)';\n                exportMsg.style.boxShadow = '0 4px 24px rgba(0,0,0,0.10)';\n                exportMsg.style.borderRadius = '12px';\n                exportMsg.style.padding = '16px 32px';\n                exportMsg.style.fontWeight = '600';\n                exportMsg.style.fontSize = '1.05rem';\n                exportMsg.style.top = '24px';\n                exportMsg.style.left = '50%';\n                exportMsg.style.transform = 'translateX(-50%)';\n                exportMsg.style.minWidth = '320px';\n                exportMsg.style.maxWidth = '90vw';\n                exportMsg.style.textAlign = 'center';\n                exportMsg.style.opacity = '0.98';\n                exportMsg.style.pointerEvents = 'none';\n                exportMsg.style.display = 'block';\n            }\n            const resp = await fetch('https://n8n.typebot.pro/webhook/exportar-participantes', {\n                method: 'POST',\n                headers: { 'Content-Type': 'application/json' },\n                body: JSON.stringify({ idConexao, WhatsAppId })\n            });\n            if (!resp.ok) throw new Error('Erro ao exportar participantes');\n            const data = await resp.json();\n            if (!data.participants || !Array.isArray(data.participants)) throw new Error('Resposta inesperada da API');\n            // Montar CSV\n            let csv = 'telefone,name\\n';\n            data.participants.forEach(p => {\n                const telefone = (p.id || '').replace(/@s\\.whatsapp\\.net$/, '');\n                const name = `${nomeGrupo} - ${dataStr}`;\n                csv += `${telefone},${name}\\n`;\n            });\n            // Baixar CSV\n            const blob = new Blob([csv], { type: 'text/csv' });\n            const url = window.URL.createObjectURL(blob);\n            const a = document.createElement('a');\n            // Nome do arquivo: nome do grupo + data\n            const nomeArquivo = `${nomeGrupo.replace(/[^a-zA-Z0-9-_]/g, '_')}-${dia}-${mes}-${ano}.csv`;\n            a.href = url;\n            a.download = nomeArquivo;\n            document.body.appendChild(a);\n            a.click();\n            document.body.removeChild(a);\n            window.URL.revokeObjectURL(url);\n            if (exportMsg) exportMsg.style.display = 'none';\n        } catch (e) {\n            if (exportMsg) {\n                exportMsg.textContent = 'Erro ao exportar participantes: ' + e.message;\n                exportMsg.style.background = 'rgba(255, 193, 7, 0.1)';\n                exportMsg.style.color = '#ffc107';\n                exportMsg.style.border = '1.5px solid rgba(255,193,7,0.3)';\n                exportMsg.style.boxShadow = '0 4px 24px rgba(0,0,0,0.10)';\n                exportMsg.style.borderRadius = '12px';\n                exportMsg.style.padding = '16px 32px';\n                exportMsg.style.fontWeight = '600';\n                exportMsg.style.fontSize = '1.05rem';\n                exportMsg.style.top = '24px';\n                exportMsg.style.left = '50%';\n                exportMsg.style.transform = 'translateX(-50%)';\n                exportMsg.style.minWidth = '320px';\n                exportMsg.style.maxWidth = '90vw';\n                exportMsg.style.textAlign = 'center';\n                exportMsg.style.opacity = '0.98';\n                exportMsg.style.pointerEvents = 'none';\n                exportMsg.style.display = 'block';\n                setTimeout(() => { exportMsg.style.display = 'none'; }, 5000);\n            }\n            else alert('Erro ao exportar participantes: ' + e.message);\n        }\n    }\n\n    // Botão voltar: redireciona para listas\n    function goBack() {\n        navigateToPage('https://n8n.typebot.pro/webhook/listas');\n    }\n\n    // Função de logout\n    function logout() {\n        console.log('🚪 Iniciando logout...');\n        \n        // Limpar todos os cookies\n        document.cookie = 'userId=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';\n        document.cookie = 'idLista=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';\n        document.cookie = 'idConexao=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';\n        document.cookie = 'idDisparo=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';\n        \n        // Limpar sessionStorage\n        sessionStorage.clear();\n        \n        console.log('🧹 Cookies e sessionStorage limpos');\n        console.log('🔄 Redirecionando para login...');\n        \n        // Redirecionar para página de login\n        window.location.href = 'https://n8n.typebot.pro/webhook/login';\n    }\n    </script>\n</body>\n</html> "},"type":"n8n-nodes-base.html","typeVersion":1.2,"position":[-4240,-4656],"id":"5cf6c79b-a03e-459e-96a8-02c14e7d5f01","name":"HTML10"},{"parameters":{"respondWith":"text","responseBody":"={{ $json.html }}","options":{}},"type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-4016,-4656],"id":"7f02e054-1f14-4241-a477-d028f35b5072","name":"Respond to Webhook9"},{"parameters":{"path":"listas-grupos","responseMode":"responseNode","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-4448,-4656],"id":"113cb5e0-7345-4e09-8050-8e31dc68be63","name":"LISTAS2","webhookId":"44ef5672-bb5e-47cb-8c16-50d5ffb78a8c"},{"parameters":{"content":"## GERAR MENSAGENS COM IA","height":500,"width":1220,"color":4},"type":"n8n-nodes-base.stickyNote","position":[-3600,-1104],"typeVersion":1,"id":"7ad5e456-5254-4a67-a644-0df08081a6c4","name":"Sticky Note25"},{"parameters":{"operation":"getAll","tableId":"SAAS_Usuarios","filters":{"conditions":[{"keyName":"id","condition":"eq","keyValue":"={{ $json.body.userId }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-3296,-1008],"id":"e3dbdc73-a958-4a7e-9e8d-7a6079f068d9","name":"BUSCAR APIKEY","credentials":{"supabaseApi":{"id":"gSmzosOueGcVRiU6","name":"supabase enviazap"}}},{"parameters":{"assignments":{"assignments":[{"id":"fe62ffe7-888d-48f8-b2cc-55f3fc433dd6","name":"mensagens","value":"={{ $json.choices[0].message.content }}","type":"object"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-2848,-1088],"id":"b9cfd4ad-5719-4870-ba5b-02cbce7d9dfa","name":"RESPOSTA4"},{"parameters":{"method":"POST","url":"https://api.openai.com/v1/chat/completions","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer {{ $json.apikey_gpt }}"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n    \"model\": \"gpt-4o-2024-08-06\",\n    \"messages\": [\n      {\n        \"role\": \"user\",\n        \"content\": \"Você é um copywriter especialista em mensagens de Whatsapp, preciso que você gere {{ $('GERAR MENSAGEM IA').item.json.body.quantidadeMensagens }} mensagens novas, seguindo como modelo esses exemplos: {{ $('GERAR MENSAGEM IA').item.json.body.variacoesMensagens }}. E essas instrucoes adicionais: {{ $('GERAR MENSAGEM IA').item.json.body.instrucoesAdicionais }}. REGRAS: Não utilize emojis, a não ser que seja pedido. Não invente informações, apenas o que foi informado pelo usuário, toda chamada de interação na mensagem, deve ser para responder a mensagem\"\n      }\n    ],\n    \"response_format\": {\n      \"type\": \"json_schema\",\n      \"json_schema\": {\n        \"name\": \"WhatsappSalesBurst\",\n        \"strict\": true,\n        \"schema\": {\n          \"type\": \"object\",\n          \"properties\": {\n            \"mensagens\": {\n              \"type\": \"array\",\n              \"items\": {\n                \"type\": \"string\",\n                \"description\": \"Mensagens\"\n              },\n              \"minItems\": {{ $('GERAR MENSAGEM IA').item.json.body.quantidadeMensagens }},\n              \"maxItems\": {{ $('GERAR MENSAGEM IA').item.json.body.quantidadeMensagens }}\n            }\n          },\n          \"required\": [\"mensagens\"],\n          \"additionalProperties\": false\n        }\n      }\n    },\n    \"temperature\": 0.7\n  }","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-3072,-1008],"id":"b677553b-97c2-4842-8ecc-cd2502f51eb3","name":"GERAR MENSAGENS","onError":"continueErrorOutput"},{"parameters":{"httpMethod":"POST","path":"gerarmensagem-ia","responseMode":"lastNode","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-3520,-1008],"id":"f8f17cea-71cd-43d5-b915-7bec0d0c62d3","name":"GERAR MENSAGEM IA","webhookId":"6fb8c7ca-f683-45d6-980c-830b976ccff3"},{"parameters":{"httpMethod":"POST","path":"puxarcontato-wpp","responseMode":"lastNode","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-2736,-3664],"id":"8bdddf23-e83a-421b-85d1-8907cc8f3cb5","name":"PUXAR CONTATOS4","webhookId":"0d210c58-1258-4a4b-a3ff-c6b5d1e7b9fc"},{"parameters":{"method":"POST","url":"=https://whatsapi.typebot.pro/chat/findChats/{{ $json.body.instanceName }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apikey","value":"=b4d71f9c38e3ac12a6b08e4b6d53aa90"}]},"options":{"redirect":{"redirect":{}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-2512,-3664],"id":"e54d3a85-3ed3-4bee-9e5e-d24e2d29f4a9","name":"PUXAR CONTATOS3"},{"parameters":{"aggregate":"aggregateAllItemData","options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[-2288,-3664],"id":"14294c3c-1bee-47d3-bc97-499c581179fc","name":"Aggregate7"},{"parameters":{"operation":"getAll","tableId":"SAAS_Grupos","limit":null,"filters":{"conditions":[{"keyName":"idLista","condition":"eq","keyValue":"={{ $json.body.idLista }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-3312,-2496],"id":"cb24c92c-8521-4649-bf96-82bd0401424a","name":"PUXAR GRUPOS1","credentials":{"supabaseApi":{"id":"gSmzosOueGcVRiU6","name":"supabase enviazap"}}},{"parameters":{"operation":"executeQuery","query":"SELECT public.create_disparo($1::jsonb) AS disparo_id;\n","options":{"queryReplacement":"={{ JSON.stringify($json) }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[352,-7328],"id":"6a95e7ba-c7f5-4c23-a6d5-fab14b19f097","name":"CRIAR TODOS DISPAROS","credentials":{"postgres":{"id":"M6jmYaJzaltqsIk4","name":"Postgres zappro"}}},{"parameters":{"httpMethod":"POST","path":"disparar","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-1472,-6816],"id":"1cc54b80-7392-4699-bd0f-545050ae5bcb","name":"DISPARAR MENSAGEM","webhookId":"a99059fc-4f49-43c8-a0b4-5789bcd27f9c"},{"parameters":{"operation":"getAll","tableId":"vw_Detalhes_Completo","returnAll":true,"matchType":"allFilters","filters":{"conditions":[{"keyName":"dataEnvio","condition":"gte","keyValue":"={{ $now }}"},{"keyName":"dataEnvio","condition":"lte","keyValue":"={{ $now.plus(1,'minute') }}"},{"keyName":"StatusDisparo","condition":"neq","keyValue":"Pausado"},{"keyName":"StatusDisparo","condition":"neq","keyValue":"Cancelado"},{"keyName":"Status","condition":"eq","keyValue":"pending"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-1280,-5792],"id":"7f76dde1-1275-4954-a13a-4cbf877bed73","name":"PUXAR DISPAROS MINUTO","credentials":{"supabaseApi":{"id":"gSmzosOueGcVRiU6","name":"supabase enviazap"}}},{"parameters":{"amount":"={{ (Math.max(0, (new Date($json.body.dataEnvio) - Date.now()) / 1000)).toFixed(2) }}"},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[-1248,-6816],"id":"654ad131-9dca-41a4-94a8-37e85fb2ef2c","name":"ESPERAR HORARIO","webhookId":"622057a2-8a0b-4c51-a81d-e5c89b99c638"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"a844e9d3-8bcb-4b79-9147-61936c8e1511","leftValue":"={{ $json.media.type }}","rightValue":"image","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"IMAGEM"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"921c72c0-30e7-42d1-8f68-55a41e6c4851","leftValue":"={{ $json.media.type }}","rightValue":"video","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"VIDEO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"04e10201-06a7-4b62-b060-b6dad7d0d613","leftValue":"={{ $json.media.type }}","rightValue":"audio","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"AUDIO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"a19bffbd-7874-497c-a8de-19f52e8aeb65","leftValue":"={{ $json.media.type }}","rightValue":"document","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"DOCUMENTO"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[-480,-6928],"id":"0af7b5e3-75d1-4781-ac66-94b6c94b4128","name":"ANEXOS2"},{"parameters":{"method":"POST","url":"=https://whatsapi.typebot.pro/message/sendText/{{ $item(\"0\").$node[\"DISPARAR MENSAGEM\"].json[\"body\"][\"InstanceName\"] }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apikey","value":"={{ $item(\"0\").$node[\"DISPARAR MENSAGEM\"].json[\"body\"][\"ApikeyConexao\"] }}"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"number","value":"={{ $item(\"0\").$node[\"DISPARAR MENSAGEM\"].json[\"body\"][\"TelefoneContato\"] }}"},{"name":"text","value":"={{ $item(\"0\").$node[\"DISPARAR MENSAGEM\"].json[\"body\"][\"Mensagem\"] }}"}]},"options":{"redirect":{"redirect":{}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-208,-6544],"id":"688de95f-4997-4a61-b729-a28fb2d6ef1e","name":"MSG TEXTO2","onError":"continueErrorOutput"},{"parameters":{"method":"POST","url":"=https://whatsapi.typebot.pro/message/sendMedia/{{ $item(\"0\").$node[\"DISPARAR MENSAGEM\"].json[\"body\"][\"InstanceName\"] }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apikey","value":"={{ $item(\"0\").$node[\"DISPARAR MENSAGEM\"].json[\"body\"][\"ApikeyConexao\"] }}"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"number","value":"={{ $item(\"0\").$node[\"DISPARAR MENSAGEM\"].json[\"body\"][\"TelefoneContato\"] }}"},{"name":"mediatype","value":"={{ $item(\"0\").$node[\"Redis1\"].json[\"media\"][\"type\"] }}"},{"name":"caption","value":"={{ $item(\"0\").$node[\"DISPARAR MENSAGEM\"].json[\"body\"][\"Mensagem\"] }}"},{"name":"media","value":"={{ $item(\"0\").$node[\"Redis1\"].json[\"media\"][\"base64\"] }}"},{"name":"fileName","value":"={{ $item(\"0\").$node[\"Redis1\"].json[\"media\"][\"filename\"] }}"}]},"options":{"redirect":{"redirect":{}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-208,-6992],"id":"61970354-8cf0-4f10-8076-be4be282b0b4","name":"MSG TEXTO + MEDIA2","retryOnFail":false,"executeOnce":false,"onError":"continueErrorOutput"},{"parameters":{"method":"POST","url":"=https://whatsapi.typebot.pro/message/sendWhatsAppAudio/{{ $item(\"0\").$node[\"DISPARAR MENSAGEM\"].json[\"body\"][\"InstanceName\"] }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apikey","value":"={{ $item(\"0\").$node[\"DISPARAR MENSAGEM\"].json[\"body\"][\"ApikeyConexao\"] }}"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"number","value":"={{ $item(\"0\").$node[\"DISPARAR MENSAGEM\"].json[\"body\"][\"TelefoneContato\"] }}"},{"name":"audio","value":"={{ $item(\"0\").$node[\"Redis1\"].json[\"media\"][\"base64\"] }}"}]},"options":{"redirect":{"redirect":{}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-208,-6816],"id":"46f9da47-4c7f-4d79-8ca0-b3fa59f51f9d","name":"MSG TEXTO + AUDIO2","onError":"continueErrorOutput"},{"parameters":{"fieldToSplitOut":"body.messages","options":{}},"type":"n8n-nodes-base.splitOut","typeVersion":1,"position":[-1248,-7328],"id":"8a885e43-5fa6-474b-8c9b-1aee53bff3b6","name":"Split Out5"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"62470e31-d630-4c15-b4ee-6970b69bd52b","leftValue":"={{ $json.media.base64 }}","rightValue":"","operator":{"type":"string","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-1040,-7328],"id":"5759914f-9dbc-4f37-8e0a-ae69226441ec","name":"If3"},{"parameters":{"operation":"set","key":"={{ $json.media.base64.substring(0,25) }}","value":"={{ $json.media }}","expire":true,"ttl":2592000},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-768,-7456],"id":"af409537-1986-4fcb-bd9e-d7876013f167","name":"SALVAR BASE64","credentials":{"redis":{"id":"UHcdFvnvoozYhCLm","name":"Redis account"}}},{"parameters":{},"type":"n8n-nodes-base.merge","typeVersion":3.1,"position":[-512,-7328],"id":"140d7161-2eb1-43fb-8e33-7fc9cc6404ab","name":"Merge"},{"parameters":{"aggregate":"aggregateAllItemData","options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[-80,-7328],"id":"41890d92-e633-4ec7-8471-491c02c8402c","name":"Aggregate11"},{"parameters":{"assignments":{"assignments":[{"id":"75534bdf-e8c5-491a-a0ba-f62119b87653","name":"userId","value":"={{ $item(\"0\").$node[\"SALVAR DISPAROS\"].json[\"body\"][\"userId\"] }}","type":"string"},{"id":"d12b29c1-b726-4140-850e-aa6740c6b774","name":"connections","value":"={{ $('SALVAR DISPAROS').item.json.body.connections }}","type":"array"},{"id":"a30d39d7-e09e-4a96-a6a4-23cf822fb05c","name":"idLista","value":"={{ $item(\"0\").$node[\"SALVAR DISPAROS\"].json[\"body\"][\"idLista\"] }}","type":"array"},{"id":"6fd45502-4bff-4f97-83bb-627968084297","name":"mensagens","value":"={{ $json.data }}","type":"array"},{"id":"f193cc0e-2ad5-4560-b67c-a75be3278539","name":"settings","value":"={{ $item(\"0\").$node[\"SALVAR DISPAROS\"].json[\"body\"][\"settings\"] }}","type":"object"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[128,-7328],"id":"5b03e0a1-802d-424b-ba54-ca9427b163d0","name":"ORGANIZAR"},{"parameters":{"assignments":{"assignments":[{"id":"9ddb9586-c233-4089-ae0c-bac3baaf8c9a","name":"text","value":"={{ $json.text }}","type":"string"},{"id":"2e628d31-ebf9-46c8-a711-038c7b2b0574","name":"media.type","value":"={{ $json.media.type }}","type":"string"},{"id":"844e1a95-87f7-44ec-9d8a-cfa03a3911ca","name":"media.filename","value":"={{ $json.media.filename }}","type":"string"},{"id":"f3c7d7a6-7969-477c-8ecf-d24e57d974b8","name":"media.hashredis","value":"={{ $json.media.base64.substring(0,25) }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-288,-7328],"id":"d37430d3-1fd7-4fd6-a429-69f8f6129c92","name":"MENSAGEM"},{"parameters":{"operation":"get","propertyName":"media","key":"={{ $('DISPARAR MENSAGEM').item.json.body.KeyRedis }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-736,-6896],"id":"6d0c01c3-2959-483e-a935-ebb0bfb9d9ba","name":"Redis1","credentials":{"redis":{"id":"UHcdFvnvoozYhCLm","name":"Redis account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"cb1408fb-482d-4102-8b74-f557843fd424","leftValue":"={{ $('DISPARAR MENSAGEM').item.json.body.KeyRedis }}","rightValue":"","operator":{"type":"string","operation":"notEmpty","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-992,-6816],"id":"33d8d88a-41be-4320-bdfd-d2a14e470290","name":"TEM MEDIA?"},{"parameters":{"operation":"update","tableId":"SAAS_Detalhes_Disparos","filters":{"conditions":[{"keyName":"id","condition":"eq","keyValue":"={{ $item(\"0\").$node[\"DISPARAR MENSAGEM\"].json[\"body\"][\"id\"] }}"}]},"fieldsUi":{"fieldValues":[{"fieldId":"Status","fieldValue":"=sent"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[672,-6992],"id":"a9b6ac7f-5dcd-477d-bafd-30ee751d196c","name":"SALVAR DISPARO - SUCESSO","credentials":{"supabaseApi":{"id":"gSmzosOueGcVRiU6","name":"supabase enviazap"}}},{"parameters":{"operation":"update","tableId":"SAAS_Detalhes_Disparos","filters":{"conditions":[{"keyName":"id","condition":"eq","keyValue":"={{ $item(\"0\").$node[\"DISPARAR MENSAGEM\"].json[\"body\"][\"id\"] }}"}]},"fieldsUi":{"fieldValues":[{"fieldId":"Status","fieldValue":"=failed"},{"fieldId":"Payload","fieldValue":"={{ $json.error.message }}"},{"fieldId":"mensagemErro","fieldValue":"={{ \n  $json.error.status === 500\n    ? 'Whatsapp desconectado ou bloqueado'\n    : ($json.error.status === 400\n        ? 'Contato inexistente'\n        : ''   // deixe vazio (ou defina outra mensagem) para outros códigos\n      )\n}}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[672,-6752],"id":"1d42e1a4-a79f-4f4c-8c01-bc6ed96e3a57","name":"SALVAR DISPARO - FALHO","credentials":{"supabaseApi":{"id":"gSmzosOueGcVRiU6","name":"supabase enviazap"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $json.error.status }}","rightValue":504,"operator":{"type":"number","operation":"equals"},"id":"1e4fdcaa-6f5a-48bd-938a-6dfaaf3eb97c"}],"combinator":"and"},"renameOutput":true,"outputKey":"TIMEOUT"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"3ca3b2c3-425d-4905-aa16-87e44c6349fb","leftValue":"={{ $json.error.status }}","rightValue":502,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"FORA DO AR"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"7a013dfa-a8c6-48f7-8e98-4afbc1cbb987","leftValue":"={{ $json.error.status }}","rightValue":400,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"NUMERO NAO EXISTE"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"a82245de-a9cc-4cb3-8c1b-d6785417dc0d","leftValue":"={{ $json.error.status }}","rightValue":500,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"DESCONECTADO"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[336,-6704],"id":"30079530-e2a1-4324-a626-c5607f4b9c69","name":"Switch"},{"parameters":{},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[672,-6304],"id":"82cc9e84-4603-4a4f-bff9-04092f2429b7","name":"ESPERAR 5 SEG","webhookId":"be0eabf6-8551-461a-8b5c-bdd9a407c450"},{"parameters":{"operation":"executeQuery","query":"SELECT public.swap_connection($1::bigint, $2::bigint, $3::uuid);","options":{"queryReplacement":"={{ $item(\"0\").$node[\"DISPARAR MENSAGEM\"].json[\"body\"][\"idDisparo\"] }},{{ $item(\"0\").$node[\"DISPARAR MENSAGEM\"].json[\"body\"][\"idConexao\"] }},{{ $item(\"0\").$node[\"DISPARAR MENSAGEM\"].json[\"body\"][\"UserId\"] }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[672,-6528],"id":"f221c5a5-159b-4180-8cbc-7d6385265d9c","name":"CONEXAO DESCONECTADA","credentials":{"postgres":{"id":"M6jmYaJzaltqsIk4","name":"Postgres zappro"}}},{"parameters":{"content":"## DISPARO DE MENSAGENS INDIVIDUAIS\n","height":1500,"width":4160,"color":3},"type":"n8n-nodes-base.stickyNote","position":[-1776,-7504],"typeVersion":1,"id":"afbc26c4-6162-47c5-9d11-82f7fa4e636b","name":"Sticky Note26"},{"parameters":{"httpMethod":"POST","path":"db56b0fb-cc58-4d51-8755-d7e04ccaa120","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-1472,-7328],"id":"2d65abf0-9e27-4840-bc3b-08cc1a983602","name":"SALVAR DISPAROS","webhookId":"db56b0fb-cc58-4d51-8755-d7e04ccaa120"},{"parameters":{"rule":{"interval":[{"field":"minutes","minutesInterval":1}]}},"type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[-1520,-5792],"id":"cc0306dc-5401-4ba8-b17a-8f68fd0ada37","name":"PROCURAR DISPAROS"},{"parameters":{"content":"## Tela Detalhes Disparo","height":260,"width":760,"color":2},"type":"n8n-nodes-base.stickyNote","position":[-4512,-4432],"typeVersion":1,"id":"2acd51cf-8521-443e-86d7-4a61f930193d","name":"Sticky Note27"},{"parameters":{"html":"<!DOCTYPE html>\n<html lang=\"pt-BR\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>Detalhes do Disparo - EnviaZap</title>\n    <script src=\"https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js\"></script>\n    <style>\n        * {\n            margin: 0;\n            padding: 0;\n            box-sizing: border-box;\n        }\n\n        body {\n            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);\n            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n            color: white;\n            min-height: 100vh;\n            overflow-x: hidden;\n        }\n\n        .app-layout {\n            display: flex;\n            min-height: 100vh;\n        }\n\n        /* Sidebar */\n        .sidebar {\n            width: 70px;\n            background: rgba(0, 0, 0, 0.3);\n            backdrop-filter: blur(10px);\n            border-right: 1px solid rgba(255, 255, 255, 0.1);\n            transition: all 0.3s ease;\n            position: relative;\n            z-index: 1000;\n            display: flex;\n            flex-direction: column;\n            height: 100vh;\n        }\n\n        .sidebar:hover {\n            width: 250px;\n        }\n\n        .sidebar-header {\n            padding: 20px;\n            text-align: center;\n            border-bottom: 1px solid rgba(255, 255, 255, 0.1);\n        }\n\n        .sidebar-logo {\n            font-size: 1.5rem;\n            font-weight: 600;\n            background: linear-gradient(135deg, #25d366 0%, #128c7e 100%);\n            -webkit-background-clip: text;\n            -webkit-text-fill-color: transparent;\n            background-clip: text;\n            white-space: nowrap;\n            opacity: 0;\n            transition: opacity 0.3s ease;\n        }\n\n        .sidebar:hover .sidebar-logo {\n            opacity: 1;\n        }\n\n        .sidebar-menu {\n            padding: 20px 0;\n            flex: 1;\n        }\n\n        .menu-item {\n            display: flex;\n            align-items: center;\n            padding: 15px 20px;\n            color: #ccc;\n            text-decoration: none;\n            transition: all 0.3s ease;\n            position: relative;\n            white-space: nowrap;\n        }\n\n        .menu-item:hover {\n            background: rgba(37, 211, 102, 0.1);\n            color: #25d366;\n        }\n\n        .menu-item.active {\n            background: rgba(37, 211, 102, 0.2);\n            color: #25d366;\n            border-right: 3px solid #25d366;\n        }\n\n        .menu-icon {\n            font-size: 1.2rem;\n            width: 30px;\n            text-align: center;\n            flex-shrink: 0;\n        }\n\n        .menu-text {\n            margin-left: 15px;\n            opacity: 0;\n            transition: opacity 0.3s ease;\n        }\n\n        .sidebar:hover .menu-text {\n            opacity: 1;\n        }\n\n        .sidebar-footer {\n            margin-top: auto;\n            border-top: 1px solid rgba(255, 255, 255, 0.1);\n            padding: 10px 0;\n        }\n\n        .logout-item {\n            color: #ff6b6b !important;\n        }\n\n        .logout-item:hover {\n            background: rgba(255, 107, 107, 0.1) !important;\n            color: #ff6b6b !important;\n        }\n\n        /* Main content */\n        .main-content {\n            flex: 1;\n            padding: 32px;\n            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);\n            overflow-x: auto;\n            position: relative;\n        }\n\n        /* Ações do disparo */\n        .disparo-actions {\n            display: flex;\n            align-items: center;\n            overflow: visible;\n        }\n\n        .actions-menu {\n            position: relative;\n            display: inline-block;\n            overflow: visible;\n        }\n\n        .actions-trigger {\n            background: rgba(255, 255, 255, 0.1);\n            border: 1px solid rgba(255, 255, 255, 0.2);\n            border-radius: 50%;\n            width: 40px;\n            height: 40px;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            cursor: pointer;\n            color: #fff;\n            font-size: 1.2rem;\n            transition: all 0.3s ease;\n        }\n\n        .actions-trigger:hover {\n            background: rgba(255, 255, 255, 0.2);\n            transform: scale(1.1);\n        }\n\n        .actions-dropdown {\n            position: absolute;\n            top: 100%;\n            right: 0;\n            background: #1a1a1a;\n            border: 1px solid rgba(255, 255, 255, 0.2);\n            border-radius: 8px;\n            min-width: 150px;\n            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);\n            opacity: 0;\n            visibility: hidden;\n            transform: translateY(-10px);\n            transition: all 0.3s ease;\n            z-index: 9999;\n        }\n\n        .actions-dropdown.show {\n            opacity: 1;\n            visibility: visible;\n            transform: translateY(0);\n        }\n\n        .actions-dropdown .dropdown-item {\n            padding: 12px 16px;\n            cursor: pointer;\n            transition: background 0.2s ease;\n            border-bottom: 1px solid rgba(255, 255, 255, 0.1);\n            color: #fff;\n            font-size: 0.9rem;\n        }\n\n        .actions-dropdown .dropdown-item:last-child {\n            border-bottom: none;\n        }\n\n        .actions-dropdown .dropdown-item:hover {\n            background: rgba(255, 255, 255, 0.1);\n        }\n\n        .actions-dropdown .dropdown-item.success:hover {\n            background: rgba(40, 167, 69, 0.2);\n        }\n\n        .actions-dropdown .dropdown-item.warning:hover {\n            background: rgba(255, 193, 7, 0.2);\n        }\n\n        .actions-dropdown .dropdown-item.danger:hover {\n            background: rgba(220, 53, 69, 0.2);\n        }\n\n        .actions-dropdown .dropdown-item.info {\n            color: #007aff;\n        }\n\n        .actions-dropdown .dropdown-item.info:hover {\n            background: rgba(0, 122, 255, 0.2);\n        }\n\n        /* Header moderno */\n        .header {\n            margin-bottom: 40px;\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            background: rgba(255, 255, 255, 0.05);\n            backdrop-filter: blur(20px);\n            padding: 24px 32px;\n            border-radius: 20px;\n            border: 1px solid rgba(255, 255, 255, 0.1);\n            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);\n            overflow: visible;\n        }\n\n        .header-info h1 {\n            font-size: 2.2rem;\n            font-weight: 700;\n            margin-bottom: 8px;\n            background: linear-gradient(135deg, #fff 0%, #e0e7ff 100%);\n            -webkit-background-clip: text;\n            -webkit-text-fill-color: transparent;\n            background-clip: text;\n        }\n\n        .header-info p {\n            color: rgba(255, 255, 255, 0.7);\n            font-size: 1rem;\n            font-weight: 500;\n        }\n\n        .header-actions {\n            display: flex;\n            gap: 16px;\n            align-items: center;\n        }\n\n        .btn-voltar {\n            padding: 12px 24px;\n            border-radius: 12px;\n            font-weight: 600;\n            cursor: pointer;\n            transition: all 0.3s ease;\n            display: flex;\n            align-items: center;\n            gap: 8px;\n            font-size: 0.9rem;\n            text-decoration: none;\n            border: none;\n            background: rgba(255, 255, 255, 0.1);\n            border: 1px solid rgba(255, 255, 255, 0.2);\n            color: rgba(255, 255, 255, 0.9);\n        }\n\n        .btn-voltar:hover {\n            background: rgba(255, 255, 255, 0.15);\n            transform: translateY(-2px);\n            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);\n        }\n\n        /* Dashboard grid moderna */\n        .dashboard {\n            display: grid;\n            gap: 24px;\n            grid-template-columns: repeat(12, 1fr);\n            grid-template-rows: auto auto auto auto;\n        }\n\n        /* Status do disparo - separado */\n        .status-row {\n            grid-column: 1 / -1;\n            margin-bottom: 8px;\n        }\n\n        .disparo-status {\n            background: rgba(255, 255, 255, 0.05);\n            backdrop-filter: blur(20px);\n            border: 1px solid rgba(255, 255, 255, 0.1);\n            border-radius: 16px;\n            padding: 20px;\n            text-align: center;\n            transition: all 0.3s ease;\n            display: flex;\n            flex-direction: column;\n            justify-content: center;\n            align-items: center;\n            min-height: 120px;\n            position: relative;\n            flex: 0 0 200px;\n        }\n\n        .disparo-status .section-title {\n            position: absolute;\n            top: 20px;\n            left: 50%;\n            transform: translateX(-50%);\n            white-space: nowrap;\n            text-align: center;\n        }\n\n        .disparo-status .status-value {\n            font-size: 1.8rem;\n            font-weight: 800;\n            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);\n            text-align: center;\n        }\n\n        .disparo-status:hover {\n            transform: translateY(-4px);\n            box-shadow: 0 16px 32px rgba(0, 0, 0, 0.15);\n        }\n\n        .status-label {\n            color: rgba(255, 255, 255, 0.8);\n            font-size: 0.9rem;\n            font-weight: 600;\n            text-transform: uppercase;\n            letter-spacing: 0.5px;\n            margin-bottom: 12px;\n        }\n\n        .status-value {\n            font-size: 1.8rem;\n            font-weight: 800;\n            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);\n        }\n\n        .status-value.success { color: #34c759; }\n        .status-value.warning { color: #ff9500; }\n        .status-value.danger { color: #ff3b30; }\n        .status-value.info { color: #007aff; }\n\n        /* Cards de estatísticas */\n        .stats-row {\n            grid-column: 1 / -1;\n            margin-bottom: 8px;\n        }\n\n        .status-stats-container {\n            display: flex;\n            gap: 24px;\n            align-items: stretch;\n        }\n\n        .config-section-inline {\n            flex: 1;\n            background: rgba(255, 255, 255, 0.05);\n            border: 1px solid rgba(255, 255, 255, 0.1);\n            border-radius: 16px;\n            padding: 24px;\n            display: flex;\n            flex-direction: column;\n            min-width: 0;\n            min-height: 170px; /* 120px (padrão) + 50px */\n        }\n\n\n\n        .config-grid-inline {\n            display: flex;\n            flex-direction: column;\n            gap: 16px;\n            margin-top: 24px;\n        }\n\n        .config-row {\n            display: flex;\n            gap: 24px;\n        }\n\n        .config-row .config-item {\n            flex: 1;\n        }\n\n        .config-item-full {\n            flex: 1 !important;\n        }\n\n        .table-messages-row {\n            grid-column: 1 / -1;\n            display: grid;\n            grid-template-columns: 2fr 1fr;\n            gap: 24px;\n            margin-bottom: 8px;\n            min-width: 0;\n        }\n\n        .table-section {\n            background: rgba(255, 255, 255, 0.05);\n            backdrop-filter: blur(20px);\n            border: 1px solid rgba(255, 255, 255, 0.1);\n            border-radius: 20px;\n            overflow: hidden;\n        }\n\n        .messages-section-side {\n            background: rgba(255, 255, 255, 0.05);\n            backdrop-filter: blur(20px);\n            border: 1px solid rgba(255, 255, 255, 0.1);\n            border-radius: 20px;\n            padding: 24px;\n        }\n\n        .stats-section, .finalizacao-section {\n            background: rgba(255, 255, 255, 0.05);\n            backdrop-filter: blur(20px);\n            border: 1px solid rgba(255, 255, 255, 0.1);\n            border-radius: 16px;\n            padding: 20px;\n            display: flex;\n            flex-direction: column;\n            align-items: center;\n            justify-content: center;\n            min-height: 170px; /* 120px + 50px */\n            position: relative;\n            flex: 0 0 250px;\n        }\n\n        .section-title {\n            font-size: 1rem;\n            font-weight: 600;\n            color: #fff;\n            display: flex;\n            align-items: center;\n            gap: 8px;\n        }\n\n        .stats-section .section-title,\n        .finalizacao-section .section-title {\n            position: absolute;\n            top: 20px;\n            left: 50%;\n            transform: translateX(-50%);\n            white-space: nowrap;\n            text-align: center;\n        }\n\n        .stats-compact {\n            display: flex;\n            gap: 32px;\n            align-items: center;\n            padding: 8px 0;\n            justify-content: space-around;\n        }\n\n        .stat-item-compact {\n            text-align: center;\n            flex: 1;\n        }\n\n        .stat-value-compact {\n            font-size: 1.8rem;\n            font-weight: 700;\n            margin-bottom: 4px;\n        }\n\n        .stat-value-compact.success { color: #34c759; }\n        .stat-value-compact.danger { color: #ff3b30; }\n        .stat-value-compact.info { color: #007aff; }\n\n        .stat-label-compact {\n            color: rgba(255, 255, 255, 0.7);\n            font-size: 0.85rem;\n            font-weight: 500;\n        }\n\n        .finalizacao-info {\n            text-align: center;\n            display: flex;\n            flex-direction: column;\n            align-items: center;\n            justify-content: center;\n        }\n\n        .finalizacao-value {\n            font-size: 1.4rem;\n            font-weight: 600;\n            color: #25d366;\n            margin-bottom: 4px;\n        }\n\n        .finalizacao-value.definir {\n            color: #ff9500;\n        }\n\n        .finalizacao-value.cancelado {\n            color: #ff3b30;\n        }\n\n        .finalizacao-label {\n            color: rgba(255, 255, 255, 0.7);\n            font-size: 0.85rem;\n            font-weight: 500;\n        }\n\n        /* Charts row */\n        .charts-row {\n            grid-column: 1 / -1;\n            display: grid;\n            grid-template-columns: 1fr 1fr;\n            gap: 24px;\n            margin-bottom: 8px;\n            min-width: 0;\n        }\n\n        .chart-panel {\n            background: rgba(255, 255, 255, 0.05);\n            backdrop-filter: blur(20px);\n            border: 1px solid rgba(255, 255, 255, 0.1);\n            border-radius: 20px;\n            padding: 24px;\n            transition: all 0.3s ease;\n            min-width: 0;\n            overflow: hidden;\n        }\n\n        .chart-panel:hover {\n            transform: translateY(-4px);\n            box-shadow: 0 16px 32px rgba(0, 0, 0, 0.15);\n        }\n\n        .chart-title {\n            font-size: 1.2rem;\n            font-weight: 700;\n            margin-bottom: 20px;\n            color: #fff;\n            display: flex;\n            align-items: center;\n            gap: 12px;\n            padding: 24px 24px 0;\n        }\n\n        .chart-container {\n            position: relative;\n            height: 300px;\n            width: 100%;\n            overflow: hidden;\n        }\n\n        .chart-container canvas {\n            max-width: 100%;\n            height: auto !important;\n        }\n\n        /* Configurações e Messages - Lado a lado */\n        .config-messages-row {\n            grid-column: 1 / -1;\n            display: grid;\n            grid-template-columns: 1fr 1fr;\n            gap: 24px;\n            margin-bottom: 8px;\n        }\n\n        .config-section, .messages-section {\n            background: rgba(255, 255, 255, 0.05);\n            backdrop-filter: blur(20px);\n            border: 1px solid rgba(255, 255, 255, 0.1);\n            border-radius: 20px;\n            padding: 24px;\n        }\n\n        .config-grid-compact {\n            display: flex;\n            flex-direction: column;\n            gap: 12px;\n            margin-top: 20px;\n        }\n\n        .config-item {\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            padding: 12px 16px;\n            background: rgba(255, 255, 255, 0.1);\n            border-radius: 8px;\n            border: 1px solid rgba(255, 255, 255, 0.15);\n            transition: all 0.3s ease;\n        }\n\n        .config-item:hover {\n            background: rgba(255, 255, 255, 0.15);\n            transform: translateY(-1px);\n        }\n\n        .config-label {\n            color: rgba(255, 255, 255, 0.8);\n            font-size: 0.85rem;\n            font-weight: 600;\n        }\n\n        .config-value {\n            color: #25d366;\n            font-weight: 700;\n            font-size: 0.85rem;\n        }\n\n        .messages-grid-compact {\n            display: flex;\n            flex-direction: column;\n            gap: 12px;\n            margin-top: 20px;\n            max-height: 300px;\n            overflow-y: auto;\n        }\n\n        .message-card {\n            background: rgba(255, 255, 255, 0.1);\n            border: 1px solid rgba(255, 255, 255, 0.15);\n            border-radius: 12px;\n            padding: 16px;\n            transition: all 0.3s ease;\n            cursor: pointer;\n        }\n\n        .message-card:hover {\n            transform: translateY(-2px);\n            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);\n            border-color: rgba(37, 211, 102, 0.4);\n        }\n\n        .message-type {\n            padding: 4px 8px;\n            border-radius: 6px;\n            font-size: 0.7rem;\n            font-weight: 700;\n            text-transform: uppercase;\n            letter-spacing: 0.8px;\n            color: rgba(255, 255, 255, 0.8);\n        }\n\n        .message-type.texto { background: rgba(37, 211, 102, 0.2); color: #25d366; }\n        .message-type.imagem { background: rgba(0, 122, 255, 0.2); color: #007aff; }\n        .message-type.video { background: rgba(255, 45, 85, 0.2); color: #ff2d55; }\n        .message-type.audio { background: rgba(255, 149, 0, 0.2); color: #ff9500; }\n        .message-type.documento { background: rgba(88, 86, 214, 0.2); color: #5856d6; }\n\n        /* Table moderna */\n        .table-row {\n            grid-column: 1 / -1;\n            background: rgba(255, 255, 255, 0.05);\n            backdrop-filter: blur(20px);\n            border: 1px solid rgba(255, 255, 255, 0.1);\n            border-radius: 20px;\n            overflow: hidden;\n        }\n\n        .table-wrapper {\n            max-height: 400px;\n            overflow-y: auto;\n        }\n\n        /* Filtros da tabela */\n        .table-filters {\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            padding: 16px 24px;\n            border-bottom: 1px solid rgba(255, 255, 255, 0.1);\n            background: rgba(255, 255, 255, 0.02);\n        }\n\n        .filter-group {\n            display: flex;\n            align-items: center;\n            gap: 12px;\n        }\n\n        .filter-label {\n            color: rgba(255, 255, 255, 0.8);\n            font-size: 0.9rem;\n            font-weight: 600;\n        }\n\n        .filter-select {\n            background: rgba(255, 255, 255, 0.1);\n            border: 1px solid rgba(255, 255, 255, 0.2);\n            border-radius: 8px;\n            padding: 8px 12px;\n            color: #fff;\n            font-size: 0.9rem;\n            cursor: pointer;\n            transition: all 0.3s ease;\n        }\n\n        .filter-select:hover {\n            background: rgba(255, 255, 255, 0.15);\n            border-color: rgba(255, 255, 255, 0.3);\n        }\n\n        .filter-select:focus {\n            outline: none;\n            border-color: #25d366;\n            box-shadow: 0 0 0 2px rgba(37, 211, 102, 0.2);\n        }\n\n        .filter-info {\n            color: rgba(255, 255, 255, 0.7);\n            font-size: 0.85rem;\n        }\n\n        /* Paginação */\n        .table-pagination {\n            display: flex;\n            justify-content: space-between;\n            align-items: center;\n            padding: 16px 24px;\n            border-top: 1px solid rgba(255, 255, 255, 0.1);\n            background: rgba(255, 255, 255, 0.02);\n        }\n\n        .pagination-info {\n            color: rgba(255, 255, 255, 0.7);\n            font-size: 0.85rem;\n        }\n\n        .pagination-controls {\n            display: flex;\n            align-items: center;\n            gap: 8px;\n        }\n\n        .pagination-btn {\n            background: rgba(255, 255, 255, 0.1);\n            border: 1px solid rgba(255, 255, 255, 0.2);\n            border-radius: 6px;\n            padding: 8px 16px;\n            color: #fff;\n            font-size: 0.85rem;\n            cursor: pointer;\n            transition: all 0.3s ease;\n        }\n\n        .pagination-btn:hover:not(:disabled) {\n            background: rgba(255, 255, 255, 0.15);\n            border-color: rgba(255, 255, 255, 0.3);\n        }\n\n        .pagination-btn:disabled {\n            opacity: 0.5;\n            cursor: not-allowed;\n        }\n\n        .page-numbers {\n            display: flex;\n            gap: 4px;\n        }\n\n        .page-number {\n            background: rgba(255, 255, 255, 0.1);\n            border: 1px solid rgba(255, 255, 255, 0.2);\n            border-radius: 4px;\n            padding: 6px 12px;\n            color: #fff;\n            font-size: 0.85rem;\n            cursor: pointer;\n            transition: all 0.3s ease;\n            min-width: 32px;\n            text-align: center;\n        }\n\n        .page-number:hover {\n            background: rgba(255, 255, 255, 0.15);\n            border-color: rgba(255, 255, 255, 0.3);\n        }\n\n        .page-number.active {\n            background: #25d366;\n            border-color: #25d366;\n            color: #fff;\n            font-weight: 600;\n        }\n\n        .disparos-table {\n            width: 100%;\n            border-collapse: collapse;\n            min-width: 0;\n            table-layout: fixed;\n        }\n\n        .disparos-table th,\n        .disparos-table td {\n            word-wrap: break-word;\n            overflow-wrap: break-word;\n        }\n\n        .disparos-table th {\n            background: rgba(255, 255, 255, 0.05);\n            padding: 20px 24px;\n            text-align: left;\n            font-weight: 700;\n            color: #fff;\n            border-bottom: 1px solid rgba(255, 255, 255, 0.1);\n            font-size: 0.9rem;\n            text-transform: uppercase;\n            letter-spacing: 0.5px;\n            position: sticky;\n            top: 0;\n            z-index: 10;\n        }\n\n        .disparos-table td {\n            padding: 20px 24px;\n            border-bottom: 1px solid rgba(255, 255, 255, 0.05);\n            vertical-align: middle;\n        }\n\n        .disparos-table tr:hover {\n            background: rgba(255, 255, 255, 0.08);\n        }\n\n        /* Pills de status */\n        .pill {\n            padding: 8px 16px;\n            border-radius: 20px;\n            font-size: 0.8rem;\n            font-weight: 700;\n            display: inline-block;\n            text-transform: uppercase;\n            letter-spacing: 0.5px;\n        }\n\n        .pill-enviado {\n            background: rgba(52, 199, 89, 0.2);\n            color: #34c759;\n            border: 1px solid rgba(52, 199, 89, 0.4);\n        }\n\n        .pill-falha {\n            background: rgba(255, 59, 48, 0.2);\n            color: #ff3b30;\n            border: 1px solid rgba(255, 59, 48, 0.4);\n        }\n\n        .pill-pendente {\n            background: rgba(255, 149, 0, 0.2);\n            color: #ff9500;\n            border: 1px solid rgba(255, 149, 0, 0.4);\n        }\n\n        /* Phone formatting */\n        .phone-cell {\n            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;\n            color: #25d366;\n            font-weight: 600;\n            font-size: 0.9rem;\n        }\n\n        .sem-conexao {\n            color: #ff3b30 !important;\n            font-weight: 700 !important;\n            text-shadow: 0 1px 2px rgba(255, 59, 48, 0.3);\n        }\n\n        /* Loading state */\n        .loading-container {\n            display: flex;\n            flex-direction: column;\n            align-items: center;\n            justify-content: center;\n            min-height: 400px;\n            gap: 24px;\n        }\n\n        .loading-spinner {\n            width: 80px;\n            height: 80px;\n            border: 6px solid rgba(37, 211, 102, 0.2);\n            border-top: 6px solid #25d366;\n            border-radius: 50%;\n            animation: spin 1s linear infinite;\n            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.2));\n        }\n\n        .loading-text {\n            color: #25d366;\n            font-size: 1.3rem;\n            font-weight: 600;\n        }\n\n        /* Error tooltip */\n        .tooltip {\n            position: relative;\n            display: inline-block;\n            margin-left: 8px;\n        }\n\n        .error-icon {\n            width: 16px;\n            height: 16px;\n            fill: #ff3b30;\n            cursor: pointer;\n        }\n\n        .tooltiptext {\n            visibility: hidden;\n            width: 200px;\n            background-color: #333;\n            color: #fff;\n            text-align: center;\n            border-radius: 6px;\n            padding: 8px;\n            position: absolute;\n            z-index: 1;\n            bottom: 125%;\n            left: 50%;\n            margin-left: -100px;\n            opacity: 0;\n            transition: opacity 0.3s;\n            font-size: 0.8rem;\n        }\n\n        .tooltip:hover .tooltiptext {\n            visibility: visible;\n            opacity: 1;\n        }\n\n        /* Animações */\n        @keyframes spin {\n            0% { transform: rotate(0deg); }\n            100% { transform: rotate(360deg); }\n        }\n\n        @keyframes fadeInUp {\n            from {\n                opacity: 0;\n                transform: translateY(30px);\n            }\n            to {\n                opacity: 1;\n                transform: translateY(0);\n            }\n        }\n\n        @keyframes pulse {\n            0%, 100% {\n                opacity: 1;\n            }\n            50% {\n                opacity: 0.7;\n            }\n        }\n\n        @keyframes shine {\n            0% {\n                left: -100%;\n            }\n            100% {\n                left: 100%;\n            }\n        }\n\n        .stat-card, .chart-panel, .message-card {\n            animation: fadeInUp 0.6s ease-out;\n        }\n\n        /* Responsivo */\n        @media (max-width: 1200px) {\n            .charts-row {\n                grid-template-columns: 1fr;\n            }\n            \n            .table-messages-row {\n                grid-template-columns: 1fr;\n            }\n        }\n\n                 @media (max-width: 768px) {\n            .sidebar {\n                width: 60px;\n            }\n            \n            .sidebar:hover {\n                width: 200px;\n            }\n\n            .main-content {\n                padding: 16px;\n            }\n\n            .header {\n                flex-direction: column;\n                gap: 20px;\n                text-align: center;\n                padding: 20px;\n            }\n\n            .header-info h1 {\n                font-size: 1.8rem;\n            }\n\n            .status-stats-container {\n                flex-direction: column;\n                gap: 16px;\n            }\n\n            .disparo-status {\n                flex: none;\n                max-width: none;\n            }\n\n            .stats-section, .finalizacao-section {\n                flex: none;\n            }\n\n            .config-section-inline {\n                flex: none;\n            }\n\n            .chart-panel {\n                padding: 16px;\n            }\n\n            .chart-container {\n                height: 250px;\n            }\n\n            .chart-title {\n                font-size: 1rem;\n                padding: 16px 16px 0;\n            }\n\n            .table-filters {\n                flex-direction: column;\n                gap: 12px;\n                align-items: stretch;\n            }\n\n            .filter-group {\n                justify-content: center;\n            }\n\n            .pagination-controls {\n                flex-wrap: wrap;\n                gap: 8px;\n            }\n\n            .page-numbers {\n                flex-wrap: wrap;\n            }\n        }\n\n        @media (max-width: 480px) {\n            .main-content {\n                padding: 12px;\n            }\n\n            .header {\n                padding: 16px;\n            }\n\n            .header-info h1 {\n                font-size: 1.5rem;\n            }\n\n            .chart-container {\n                height: 200px;\n            }\n\n            .config-row {\n                flex-direction: column;\n                gap: 12px;\n            }\n\n            .config-item {\n                padding: 10px 12px;\n            }\n\n            .config-label, .config-value {\n                font-size: 0.8rem;\n            }\n\n            .disparos-table {\n                font-size: 0.8rem;\n            }\n\n            .disparos-table th,\n            .disparos-table td {\n                padding: 12px 8px;\n            }\n\n                    .phone-cell {\n            font-size: 0.75rem;\n        }\n\n        .message-preview {\n            cursor: help;\n            border-bottom: 1px dotted rgba(255, 255, 255, 0.3);\n        }\n\n        .message-preview:hover {\n            color: #25d366 !important;\n        }\n\n        /* Aviso de Conexões */\n        .conexoes-aviso {\n            background: linear-gradient(135deg, rgba(255, 59, 48, 0.2) 0%, rgba(255, 59, 48, 0.1) 100%);\n            border: 3px solid #ff3b30;\n            border-radius: 16px;\n            padding: 24px;\n            margin-bottom: 24px;\n            animation: fadeInUp 0.6s ease-out;\n            position: relative;\n            overflow: hidden;\n        }\n\n        .conexoes-aviso::before {\n            content: '';\n            position: absolute;\n            top: 0;\n            left: 0;\n            right: 0;\n            height: 4px;\n            background: linear-gradient(90deg, #ff3b30, #ff453a, #ff3b30);\n            animation: pulse 2s infinite;\n        }\n\n        .conexoes-aviso::after {\n            content: '';\n            position: absolute;\n            top: 0;\n            left: -100%;\n            width: 100%;\n            height: 100%;\n            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);\n            animation: shine 3s infinite;\n        }\n\n        .aviso-content {\n            display: flex;\n            align-items: center;\n            gap: 16px;\n            position: relative;\n            z-index: 1;\n        }\n\n        .aviso-icon {\n            font-size: 2.5rem;\n            flex-shrink: 0;\n            animation: pulse 2s infinite;\n            filter: drop-shadow(0 2px 4px rgba(255, 59, 48, 0.5));\n        }\n\n        .aviso-text {\n            flex: 1;\n        }\n\n        .aviso-title {\n            color: #ff3b30 !important;\n            font-size: 1.4rem !important;\n            font-weight: 800 !important;\n            margin-bottom: 8px;\n            text-shadow: 0 2px 8px rgba(255, 59, 48, 0.5);\n            text-transform: uppercase;\n            letter-spacing: 0.5px;\n        }\n\n        .aviso-subtitle {\n            color: rgba(255, 255, 255, 0.8);\n            font-size: 0.95rem;\n            font-weight: 500;\n            line-height: 1.4;\n        }\n\n\n\n        /* MODAL TESTE - ABORDAGEM AGRESSIVA */\n        #modalTeste {\n            position: fixed !important;\n            top: 0 !important;\n            left: 0 !important;\n            right: 0 !important;\n            bottom: 0 !important;\n            width: 100vw !important;\n            height: 100vh !important;\n            background: rgba(0, 0, 0, 0.95) !important;\n            z-index: 2147483647 !important;\n            display: none;\n            align-items: center !important;\n            justify-content: center !important;\n            pointer-events: auto;\n            margin: 0 !important;\n            padding: 0 !important;\n            border: none !important;\n            outline: none !important;\n            overflow: hidden !important;\n            transform: none !important;\n            transform-origin: center !important;\n            transition: none !important;\n            animation: none !important;\n        }\n\n        #modalTeste.show {\n            display: flex !important;\n        }\n\n        #modalTeste .modal-teste-content {\n            background: #ff0000 !important;\n            color: white !important;\n            padding: 50px !important;\n            border-radius: 20px !important;\n            font-size: 24px !important;\n            font-weight: bold !important;\n            text-align: center !important;\n            position: relative !important;\n            z-index: 2147483647 !important;\n            margin: 0 !important;\n            border: none !important;\n            outline: none !important;\n            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8) !important;\n            transform: none !important;\n            transform-origin: center !important;\n            transition: none !important;\n            animation: none !important;\n        }\n\n        @keyframes spin {\n            0% { transform: rotate(0deg); }\n            100% { transform: rotate(360deg); }\n        }\n\n        /* Responsivo para o aviso */\n        @media (max-width: 768px) {\n            .conexoes-aviso {\n                padding: 16px;\n                margin-bottom: 16px;\n            }\n\n            .aviso-content {\n                flex-direction: column;\n                text-align: center;\n                gap: 12px;\n            }\n\n            .aviso-title {\n                font-size: 1rem;\n            }\n\n            .aviso-subtitle {\n                font-size: 0.85rem;\n            }\n            }\n        }\n    </style>\n</head>\n<body>\n    <div class=\"app-layout\">\n        <!-- Sidebar -->\n        <div class=\"sidebar\">\n            <div class=\"sidebar-header\">\n                <div class=\"sidebar-logo\">EnviaZap</div>\n            </div>\n            <nav class=\"sidebar-menu\">\n                <a href=\"#\" class=\"menu-item\" onclick=\"navigateToPage('https://n8n.typebot.pro/webhook/dashboard')\">\n                    <span class=\"menu-icon\">📊</span>\n                    <span class=\"menu-text\">Dashboard</span>\n                </a>\n                <a href=\"#\" class=\"menu-item active\" onclick=\"navigateToPage('https://n8n.typebot.pro/webhook/historico-disparos')\">\n                    <span class=\"menu-icon\">📋</span>\n                    <span class=\"menu-text\">Histórico de disparos</span>\n                </a>\n                <a href=\"#\" class=\"menu-item\" onclick=\"navigateToPage('https://n8n.typebot.pro/webhook/conectar')\">\n                    <span class=\"menu-icon\">🔗</span>\n                    <span class=\"menu-text\">Nova Conexão</span>\n                </a>\n                <a href=\"#\" class=\"menu-item\" onclick=\"navigateToPage('https://n8n.typebot.pro/webhook/conexoes')\">\n                    <span class=\"menu-icon\">🔌</span>\n                    <span class=\"menu-text\">Conexões</span>\n                </a>\n                <a href=\"#\" class=\"menu-item\" onclick=\"navigateToPage('https://n8n.typebot.pro/webhook/disparos-individuais')\">\n                    <span class=\"menu-icon\">📱</span>\n                    <span class=\"menu-text\">Disparos individuais</span>\n                </a>\n                <a href=\"#\" class=\"menu-item\" onclick=\"navigateToPage('https://n8n.typebot.pro/webhook/disparos-grupos')\">\n                    <span class=\"menu-icon\">👥</span>\n                    <span class=\"menu-text\">Disparos em grupo</span>\n                </a>\n                <a href=\"#\" class=\"menu-item\" onclick=\"navigateToPage('https://n8n.typebot.pro/webhook/listas')\">\n                    <span class=\"menu-icon\">📝</span>\n                    <span class=\"menu-text\">Listas</span>\n                </a>\n            </nav>\n            <div class=\"sidebar-footer\">\n                <a href=\"#\" class=\"menu-item logout-item\" onclick=\"logout()\">\n                    <span class=\"menu-icon\">🚪</span>\n                    <span class=\"menu-text\">Sair</span>\n                </a>\n            </div>\n        </div>\n\n        <!-- Main Content -->\n        <div class=\"main-content\">\n            <div class=\"header\">\n                <div class=\"header-info\">\n                    <h1>Detalhes do Disparo</h1>\n                    <p>Acompanhe o progresso e estatísticas em tempo real</p>\n                </div>\n                <div class=\"header-actions\">\n                    <a href=\"#\" class=\"btn-voltar\" onclick=\"voltarHistorico()\">\n                        ← Voltar\n                    </a>\n                    <!-- Ações do Disparo -->\n                    <div class=\"disparo-actions\">\n                        <div class=\"actions-menu\">\n                            <div class=\"actions-trigger\" onclick=\"toggleActionsMenu()\">⋯</div>\n                            <div class=\"actions-dropdown\" id=\"actionsDropdown\">\n                                <div class=\"dropdown-item\" onclick=\"carregarDetalhes()\">Atualizar dados</div>\n                                <div id=\"dynamicActions\">\n                                    <!-- Ações dinâmicas serão inseridas aqui -->\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n\n            <!-- Loading State -->\n            <div class=\"loading-container\" id=\"loadingContainer\">\n                <div class=\"loading-spinner\"></div>\n                <div class=\"loading-text\">Carregando detalhes...</div>\n            </div>\n\n            <!-- Aviso de Conexões -->\n            <div class=\"conexoes-aviso\" id=\"conexoesAviso\" style=\"display: none; background: linear-gradient(135deg, rgba(255, 59, 48, 0.2) 0%, rgba(255, 59, 48, 0.1) 100%); border: 3px solid #ff3b30; border-radius: 16px; padding: 24px; margin-bottom: 24px; backdrop-filter: blur(20px); box-shadow: 0 8px 32px rgba(255, 59, 48, 0.3); position: relative; overflow: hidden;\">\n                <!-- Barra superior animada -->\n                <div style=\"position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, #ff3b30, #ff453a, #ff3b30); animation: pulse 2s infinite; z-index: 0;\"></div>\n                <!-- Efeito de brilho -->\n                <div style=\"position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent); animation: shine 3s infinite; z-index: 0;\"></div>\n                <div class=\"aviso-content\" style=\"display: flex; align-items: center; gap: 16px; position: relative; z-index: 1;\">\n                    <div class=\"aviso-icon\" style=\"font-size: 2.5rem; flex-shrink: 0; animation: pulse 2s infinite; filter: drop-shadow(0 2px 4px rgba(255, 59, 48, 0.5));\">⚠️</div>\n                    <div class=\"aviso-text\" style=\"flex: 1;\">\n                        <div class=\"aviso-title\" style=\"color: #ff3b30 !important; font-size: 1.4rem !important; font-weight: 800 !important; margin-bottom: 8px; text-shadow: 0 2px 8px rgba(255, 59, 48, 0.5); text-transform: uppercase; letter-spacing: 0.5px;\">Disparo cancelado por falta de conexões ativas</div>\n                        <div class=\"aviso-subtitle\" style=\"color: rgba(255, 255, 255, 0.8); font-size: 0.95rem; font-weight: 500; line-height: 1.4;\">Todos Whatsapps selecionados no disparo foram desconectados ou bloqueados</div>\n                    </div>\n                    <button id=\"btnAdicionarConexoes\" style=\"background: transparent; border: 2px solid white; color: white; padding: 12px 20px; border-radius: 8px; font-weight: 600; font-size: 0.9rem; cursor: pointer; transition: all 0.3s ease; flex-shrink: 0; white-space: nowrap;\">Adicionar Conexões</button>\n                </div>\n            </div>\n\n\n\n            <!-- Dashboard -->\n            <div class=\"dashboard\" id=\"dashboardGrid\" style=\"display: none;\">\n                <!-- Status e Estatísticas - Lado a lado -->\n                <div class=\"stats-row\">\n                    <div class=\"status-stats-container\">\n                        <div class=\"disparo-status\">\n                            <div class=\"section-title\">📊 Status</div>\n                            <div class=\"status-value\" id=\"statusGeral\">-</div>\n                        </div>\n                        \n                        <div class=\"stats-section\">\n                            <div class=\"section-title\">📊 Estatísticas de Disparo</div>\n                            <div class=\"stats-compact\">\n                                <div class=\"stat-item-compact\">\n                                    <div class=\"stat-value-compact info\" id=\"totalDisparos\">0</div>\n                                    <div class=\"stat-label-compact\">Total</div>\n                                </div>\n                                <div class=\"stat-item-compact\">\n                                    <div class=\"stat-value-compact success\" id=\"enviados\">0</div>\n                                    <div class=\"stat-label-compact\">Enviados</div>\n                                </div>\n                                <div class=\"stat-item-compact\">\n                                    <div class=\"stat-value-compact danger\" id=\"falhas\">0</div>\n                                    <div class=\"stat-label-compact\">Falhas</div>\n                                </div>\n                            </div>\n                        </div>\n\n                        <div class=\"finalizacao-section\">\n                            <div class=\"section-title\">⏰ Previsão de Finalização</div>\n                            <div class=\"finalizacao-info\">\n                                <div class=\"finalizacao-value\" id=\"previsaoFinalizacao\">-</div>\n                            </div>\n                        </div>\n\n                        <!-- Configurações do Disparo na mesma linha -->\n                        <div class=\"config-section-inline\">\n                            <div class=\"section-title\">⚙️ Configurações</div>\n                            <div class=\"config-grid-inline\" id=\"configContainer\">\n                                <div class=\"config-row\">\n                                    <div class=\"config-item\">\n                                        <span class=\"config-label\">Horário:</span>\n                                        <span class=\"config-value\" id=\"horarioDisparo\">-</span>\n                                    </div>\n                                    <div class=\"config-item\">\n                                        <span class=\"config-label\">Dias:</span>\n                                        <span class=\"config-value\" id=\"diasDisparo\">-</span>\n                                    </div>\n                                </div>\n                                <div class=\"config-row\">\n                                    <div class=\"config-item\">\n                                        <span class=\"config-label\">Intervalo:</span>\n                                        <span class=\"config-value\" id=\"intervaloDisparo\">-</span>\n                                    </div>\n                                    <div class=\"config-item\">\n                                        <span class=\"config-label\">Pausa:</span>\n                                        <span class=\"config-value\" id=\"pausaDisparo\">-</span>\n                                    </div>\n                                </div>\n                                <div class=\"config-row\">\n                                    <div class=\"config-item config-item-full\">\n                                        <span class=\"config-label\">Conexões:</span>\n                                        <span class=\"config-value\" id=\"conexoesDisparo\">-</span>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n\n                <!-- Gráficos -->\n                <div class=\"charts-row\">\n                    <div class=\"chart-panel\">\n                        <div class=\"chart-title\">📊 Status dos Disparos</div>\n                        <div class=\"chart-container\">\n                            <canvas id=\"statusChart\"></canvas>\n                        </div>\n                    </div>\n\n                    <div class=\"chart-panel\">\n                        <div class=\"chart-title\">⏰ Disparos por Hora</div>\n                        <div class=\"chart-container\">\n                            <canvas id=\"hourlyChart\"></canvas>\n                        </div>\n                    </div>\n                </div>\n\n                <!-- Tabela de Detalhes e Preview das Mensagens - Lado a lado -->\n                <div class=\"table-messages-row\">\n                    <!-- Tabela de Detalhes -->\n                    <div class=\"table-section\">\n                        <div class=\"chart-title\">📋 Detalhes dos Contatos</div>\n                        <div class=\"table-wrapper\">\n                            <!-- Filtros -->\n                            <div class=\"table-filters\">\n                                <div class=\"filter-group\">\n                                    <label class=\"filter-label\">Filtrar por Status:</label>\n                                    <select id=\"statusFilter\" class=\"filter-select\">\n                                        <option value=\"all\">Todos</option>\n                                        <option value=\"sent\">Enviado</option>\n                                        <option value=\"failed\">Falha</option>\n                                        <option value=\"pending\">Pendente</option>\n                                    </select>\n                                </div>\n                                <div class=\"filter-info\">\n                                    <span id=\"filterInfo\">Mostrando 0 de 0 contatos</span>\n                                </div>\n                            </div>\n\n                            <table class=\"disparos-table\">\n                                <thead>\n                                    <tr>\n                                        <th>Telefone</th>\n                                        <th>Status</th>\n                                        <th>Data/Hora</th>\n                                        <th>Mensagem</th>\n                                        <th>CONEXÃO</th>\n                                    </tr>\n                                </thead>\n                                <tbody id=\"disparosTableBody\">\n                                </tbody>\n                            </table>\n\n                            <!-- Paginação -->\n                            <div class=\"table-pagination\">\n                                <div class=\"pagination-info\">\n                                    <span id=\"paginationInfo\">Página 1 de 1</span>\n                                </div>\n                                <div class=\"pagination-controls\">\n                                    <button id=\"prevPage\" class=\"pagination-btn\" disabled>Anterior</button>\n                                    <div class=\"page-numbers\" id=\"pageNumbers\">\n                                        <!-- Números das páginas serão inseridos dinamicamente -->\n                                    </div>\n                                    <button id=\"nextPage\" class=\"pagination-btn\">Próxima</button>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n\n                    <!-- Preview das Mensagens -->\n                    <div class=\"messages-section-side\">\n                        <div class=\"chart-title\">💬 Preview das Mensagens</div>\n                        <div class=\"messages-grid-compact\" id=\"messagesGrid\">\n                            <!-- Cards de mensagens serão inseridos dinamicamente -->\n                        </div>\n                    </div>\n                </div>\n            </div>\n        </div>\n    </div>\n\n    <script>\n        // Variáveis globais\n        let secureUserId = null;\n        let idDisparo = null;\n        let charts = {};\n        let dadosDisparo = null;\n        let arrayMensagens = [];\n        let tempoVarsValues = {\n            saudacao: '',\n            hora: '',\n            data: '',\n            diadasemana: '',\n            mes: '',\n            nome: ''\n        };\n        let availableVariables = ['nome', 'saudacao', 'hora', 'data', 'diadasemana', 'mes'];\n\n        // Variáveis de paginação e filtros\n        let currentPage = 1;\n        let itemsPerPage = 15;\n        let filteredData = [];\n        let currentFilter = 'all';\n        \n        // Garantir que a variável global seja acessível\n        window.arrayMensagens = arrayMensagens;\n\n        // Funções para gerenciar cookies\n        function setCookie(name, value, days = 7) {\n            const expires = new Date();\n            expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));\n            document.cookie = `${name}=${value};expires=${expires.toUTCString()};path=/;SameSite=Strict`;\n        }\n\n        function getCookie(name) {\n            const nameEQ = name + \"=\";\n            const ca = document.cookie.split(';');\n            for(let i = 0; i < ca.length; i++) {\n                let c = ca[i];\n                while (c.charAt(0) === ' ') c = c.substring(1, c.length);\n                if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);\n            }\n            return null;\n        }\n\n        function getSecureUserId() {\n            const userId = getCookie('userId');\n            if (userId && /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(userId)) {\n                return userId;\n            }\n            return null;\n        }\n\n        function checkAuth() {\n            const userId = getSecureUserId();\n            if (!userId) {\n                window.location.href = 'https://n8n.typebot.pro/webhook/login';\n            }\n        }\n\n        function navigateToPage(url) {\n            window.location.href = url;\n        }\n\n        function logout() {\n            document.cookie = 'userId=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';\n            document.cookie = 'idLista=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';\n            document.cookie = 'idConexao=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';\n            document.cookie = 'idDisparo=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';\n            sessionStorage.clear();\n            window.location.href = 'https://n8n.typebot.pro/webhook/login';\n        }\n\n        // Gerenciar menu de ações\n        function toggleActionsMenu() {\n            const dropdown = document.getElementById('actionsDropdown');\n            dropdown.classList.toggle('show');\n        }\n\n        // Fechar menu ao clicar fora\n        document.addEventListener('click', function(event) {\n            const actionsMenu = document.querySelector('.actions-menu');\n            if (!actionsMenu.contains(event.target)) {\n                const dropdown = document.getElementById('actionsDropdown');\n                dropdown.classList.remove('show');\n            }\n        });\n\n        // Atualizar ações dinâmicas baseadas no status\n        function atualizarAcoesDinamicas(status) {\n            const dynamicActions = document.getElementById('dynamicActions');\n            dynamicActions.innerHTML = '';\n\n            if (status === 'Aguardando' || status === 'Em andamento') {\n                dynamicActions.innerHTML += '<div class=\"dropdown-item warning\" onclick=\"pausarDisparo()\">Pausar disparo</div>';\n            }\n\n            if (status === 'Pausado') {\n                dynamicActions.innerHTML += '<div class=\"dropdown-item success\" onclick=\"retomarDisparo()\">Retomar disparo</div>';\n                dynamicActions.innerHTML += '<div class=\"dropdown-item danger\" onclick=\"excluirDisparo()\">Excluir disparo</div>';\n            }\n\n            if (status === 'Cancelado' || status === 'Finalizado') {\n                dynamicActions.innerHTML += '<div class=\"dropdown-item danger\" onclick=\"excluirDisparo()\">Excluir disparo</div>';\n            }\n\n            // Removido botão \"Adicionar Conexões\" do menu de ações - agora está no aviso\n        }\n\n        // Pausar disparo\n        async function pausarDisparo() {\n            const userId = getSecureUserId();\n            const idDisparo = getCookie('idDisparo');\n            \n            if (!userId || !idDisparo) {\n                console.error('userId ou idDisparo não encontrados');\n                return;\n            }\n\n            try {\n                const response = await fetch('https://n8n.typebot.pro/webhook/pausar-disparo', {\n                    method: 'POST',\n                    headers: {\n                        'Content-Type': 'application/json'\n                    },\n                    body: JSON.stringify({\n                        userId: userId,\n                        idDisparo: idDisparo\n                    })\n                });\n\n                if (response.ok) {\n                    console.log('Disparo pausado com sucesso');\n                    carregarDetalhes();\n                } else {\n                    console.error('Erro ao pausar disparo:', response.statusText);\n                }\n            } catch (error) {\n                console.error('Erro na requisição de pausar:', error);\n            }\n\n            document.getElementById('actionsDropdown').classList.remove('show');\n        }\n\n        // Retomar disparo\n        async function retomarDisparo() {\n            const userId = getSecureUserId();\n            const idDisparo = getCookie('idDisparo');\n            \n            if (!userId || !idDisparo) {\n                console.error('userId ou idDisparo não encontrados');\n                return;\n            }\n\n            try {\n                const response = await fetch('https://n8n.typebot.pro/webhook/retomar-disparo', {\n                    method: 'POST',\n                    headers: {\n                        'Content-Type': 'application/json'\n                    },\n                    body: JSON.stringify({\n                        userId: userId,\n                        idDisparo: idDisparo\n                    })\n                });\n\n                if (response.ok) {\n                    console.log('Disparo retomado com sucesso');\n                    carregarDetalhes();\n                } else {\n                    console.error('Erro ao retomar disparo:', response.statusText);\n                }\n            } catch (error) {\n                console.error('Erro na requisição de retomar:', error);\n            }\n\n            document.getElementById('actionsDropdown').classList.remove('show');\n        }\n\n        // Excluir disparo\n        async function excluirDisparo() {\n            if (!confirm('Tem certeza que deseja excluir este disparo? Esta ação não pode ser desfeita.')) {\n                return;\n            }\n\n            const userId = getSecureUserId();\n            const idDisparo = getCookie('idDisparo');\n            \n            if (!userId || !idDisparo) {\n                console.error('userId ou idDisparo não encontrados');\n                return;\n            }\n\n            try {\n                const response = await fetch('https://n8n.typebot.pro/webhook/excluir-disparo', {\n                    method: 'POST',\n                    headers: {\n                        'Content-Type': 'application/json'\n                    },\n                    body: JSON.stringify({\n                        userId: userId,\n                        idDisparo: idDisparo\n                    })\n                });\n\n                if (response.ok) {\n                    console.log('Disparo excluído com sucesso');\n                    voltarHistorico();\n                } else {\n                    console.error('Erro ao excluir disparo:', response.statusText);\n                }\n            } catch (error) {\n                console.error('Erro na requisição de excluir:', error);\n            }\n\n            document.getElementById('actionsDropdown').classList.remove('show');\n        }\n\n        function hideLoading() {\n            document.getElementById('loadingContainer').style.display = 'none';\n        }\n\n        function showDashboard() {\n            document.getElementById('dashboardGrid').style.display = 'grid';\n        }\n\n        // Criar gráfico de status com Chart.js\n        function criarGraficoStatus(enviados, falhas, pendentes) {\n            const ctx = document.getElementById('statusChart').getContext('2d');\n            \n            if (charts.statusChart) {\n                charts.statusChart.destroy();\n            }\n\n            charts.statusChart = new Chart(ctx, {\n                type: 'doughnut',\n                data: {\n                    labels: ['Enviados', 'Falhas', 'Pendentes'],\n                    datasets: [{\n                        data: [enviados, falhas, pendentes],\n                        backgroundColor: [\n                            'rgba(52, 199, 89, 0.8)',\n                            'rgba(255, 59, 48, 0.8)',\n                            'rgba(255, 193, 7, 0.8)'\n                        ],\n                        borderColor: [\n                            '#34c759',\n                            '#ff3b30',\n                            '#ffc107'\n                        ],\n                        borderWidth: 2,\n                        hoverBorderWidth: 3\n                    }]\n                },\n                options: {\n                    responsive: true,\n                    maintainAspectRatio: false,\n                    plugins: {\n                        legend: {\n                            position: 'bottom',\n                            labels: {\n                                color: 'white',\n                                font: {\n                                    size: 12,\n                                    weight: '600'\n                                },\n                                padding: 20,\n                                usePointStyle: true\n                            }\n                        }\n                    },\n                    cutout: '65%'\n                }\n            });\n        }\n\n        // Criar gráfico de disparos por hora\n        function criarGraficoHorario(arrayMensagens) {\n            const ctx = document.getElementById('hourlyChart').getContext('2d');\n            \n            if (charts.hourlyChart) {\n                charts.hourlyChart.destroy();\n            }\n\n            const horarios = {};\n            arrayMensagens.forEach(msg => {\n                if (msg.dataEnvio) {\n                    const hora = new Date(msg.dataEnvio).getHours();\n                    horarios[hora] = (horarios[hora] || 0) + 1;\n                }\n            });\n\n            const labels = [];\n            const data = [];\n            for (let i = 0; i < 24; i++) {\n                labels.push(`${i.toString().padStart(2, '0')}:00`);\n                data.push(horarios[i] || 0);\n            }\n\n            charts.hourlyChart = new Chart(ctx, {\n                type: 'line',\n                data: {\n                    labels: labels,\n                    datasets: [{\n                        label: 'Disparos por Hora',\n                        data: data,\n                        borderColor: '#25d366',\n                        backgroundColor: 'rgba(37, 211, 102, 0.1)',\n                        borderWidth: 3,\n                        fill: true,\n                        tension: 0.4,\n                        pointBackgroundColor: '#25d366',\n                        pointBorderColor: '#fff',\n                        pointBorderWidth: 2,\n                        pointRadius: 6,\n                        pointHoverRadius: 8\n                    }]\n                },\n                options: {\n                    responsive: true,\n                    maintainAspectRatio: false,\n                    plugins: {\n                        legend: {\n                            display: false\n                        }\n                    },\n                    scales: {\n                        x: {\n                            grid: {\n                                color: 'rgba(255, 255, 255, 0.1)'\n                            },\n                            ticks: {\n                                color: 'rgba(255, 255, 255, 0.8)',\n                                font: {\n                                    size: 11\n                                }\n                            }\n                        },\n                        y: {\n                            grid: {\n                                color: 'rgba(255, 255, 255, 0.1)'\n                            },\n                            ticks: {\n                                color: 'rgba(255, 255, 255, 0.8)',\n                                font: {\n                                    size: 11\n                                }\n                            }\n                        }\n                    }\n                }\n            });\n        }\n\n        // Funções de paginação e filtros\n        function aplicarFiltro() {\n            const statusFilter = document.getElementById('statusFilter');\n            if (!statusFilter) {\n                return;\n            }\n            \n            const filterValue = statusFilter.value;\n            currentFilter = filterValue;\n            currentPage = 1; // Reset para primeira página\n            \n            // Usar a variável global correta\n            const dadosParaFiltrar = arrayMensagens || window.arrayMensagens || [];\n            \n            // Verificar se arrayMensagens existe e é um array\n            if (!dadosParaFiltrar || !Array.isArray(dadosParaFiltrar)) {\n                filteredData = [];\n                atualizarTabela();\n                atualizarInfoFiltro();\n                atualizarPaginacao();\n                return;\n            }\n            \n            if (filterValue === 'all') {\n                filteredData = [...dadosParaFiltrar];\n            } else {\n                filteredData = dadosParaFiltrar.filter(item => {\n                    if (filterValue === 'sent') return item.Status === 'sent';\n                    if (filterValue === 'failed') return item.Status === 'failed' || item.Status === 'error';\n                    if (filterValue === 'pending') return item.Status === 'pending' || item.Status === 'waiting' || !item.Status;\n                    return true;\n                });\n            }\n            \n            atualizarTabela();\n            atualizarInfoFiltro();\n            atualizarPaginacao();\n        }\n\n        function atualizarInfoFiltro() {\n            const filterInfo = document.getElementById('filterInfo');\n            if (!filterInfo) {\n                return;\n            }\n            \n            // Verificar se filteredData é válido\n            if (!filteredData || !Array.isArray(filteredData)) {\n                filteredData = [];\n            }\n            \n            const total = filteredData.length;\n            const startIndex = (currentPage - 1) * itemsPerPage;\n            const endIndex = Math.min(startIndex + itemsPerPage, total);\n            const showing = endIndex - startIndex;\n            \n            filterInfo.textContent = `Mostrando ${showing} de ${total} contatos`;\n        }\n\n        function irParaPagina(pagina) {\n            currentPage = pagina;\n            atualizarTabela();\n            atualizarPaginacao();\n        }\n\n        function paginaAnterior() {\n            if (currentPage > 1) {\n                irParaPagina(currentPage - 1);\n            }\n        }\n\n        function proximaPagina() {\n            const totalPages = Math.ceil(filteredData.length / itemsPerPage);\n            if (currentPage < totalPages) {\n                irParaPagina(currentPage + 1);\n            }\n        }\n\n        function atualizarPaginacao() {\n            // Verificar se filteredData é válido\n            if (!filteredData || !Array.isArray(filteredData)) {\n                filteredData = [];\n            }\n            \n            const totalPages = Math.ceil(filteredData.length / itemsPerPage);\n            const paginationInfo = document.getElementById('paginationInfo');\n            const pageNumbers = document.getElementById('pageNumbers');\n            const prevBtn = document.getElementById('prevPage');\n            const nextBtn = document.getElementById('nextPage');\n            \n            if (!paginationInfo || !pageNumbers || !prevBtn || !nextBtn) {\n                return;\n            }\n            \n            paginationInfo.textContent = `Página ${currentPage} de ${totalPages}`;\n            prevBtn.disabled = currentPage === 1;\n            nextBtn.disabled = currentPage === totalPages;\n            \n            // Gerar números das páginas\n            pageNumbers.innerHTML = '';\n            const maxVisiblePages = 5;\n            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));\n            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);\n            \n            if (endPage - startPage + 1 < maxVisiblePages) {\n                startPage = Math.max(1, endPage - maxVisiblePages + 1);\n            }\n            \n            for (let i = startPage; i <= endPage; i++) {\n                const pageBtn = document.createElement('button');\n                pageBtn.className = `page-number ${i === currentPage ? 'active' : ''}`;\n                pageBtn.textContent = i;\n                pageBtn.onclick = () => irParaPagina(i);\n                pageNumbers.appendChild(pageBtn);\n            }\n        }\n\n        // Função principal para inserir dados\n        function inserirDadosDisparo(detalhesDisparo, mensagens) {\n            console.log('📊 Dados recebidos em inserirDadosDisparo:');\n            console.log('📊 detalhesDisparo:', detalhesDisparo);\n            console.log('📊 mensagens (primeiros 2 itens):', mensagens.slice(0, 2));\n            \n            if (!detalhesDisparo || !mensagens) {\n                return;\n            }\n\n            // Armazenar dados do disparo globalmente para uso nas ações\n            dadosDisparo = detalhesDisparo;\n\n            // Verificar se o disparo está sem conexões ativas\n            const conexoesAviso = document.getElementById('conexoesAviso');\n            if (detalhesDisparo.idConexoes && Array.isArray(detalhesDisparo.idConexoes) && detalhesDisparo.idConexoes.length === 0) {\n                console.log('⚠️ Disparo sem conexões ativas detectado');\n                conexoesAviso.style.display = 'block';\n            } else {\n                conexoesAviso.style.display = 'none';\n            }\n\n            const disparo = detalhesDisparo;\n            const totalDisparos = disparo.TotalDisparos || 0;\n            const enviados = mensagens.filter(msg => msg.Status === 'sent').length;\n            const falhas = mensagens.filter(msg => msg.Status === 'failed' || msg.Status === 'error').length;\n            const pendentes = mensagens.filter(msg => msg.Status === 'pending' || msg.Status === 'waiting' || !msg.Status).length;\n\n            // Atualizar estatísticas\n            document.getElementById('totalDisparos').textContent = totalDisparos;\n            document.getElementById('enviados').textContent = enviados;\n            document.getElementById('falhas').textContent = falhas;\n\n            // Atualizar status geral\n            const statusEl = document.getElementById('statusGeral');\n            statusEl.textContent = disparo.StatusDisparo || 'Desconhecido';\n            statusEl.className = 'status-value';\n            \n            if (disparo.StatusDisparo === 'Finalizado') {\n                statusEl.classList.add('success');\n            } else if (disparo.StatusDisparo === 'Em andamento') {\n                statusEl.classList.add('warning');\n            } else if (disparo.StatusDisparo === 'Cancelado') {\n                statusEl.classList.add('danger');\n            } else if (disparo.StatusDisparo === 'Pausado') {\n                statusEl.classList.add('warning');\n            } else {\n                statusEl.classList.add('info');\n            }\n\n            // A barra de progresso foi removida\n\n            // Atualizar ações dinâmicas baseadas no status\n            atualizarAcoesDinamicas(disparo.StatusDisparo);\n\n            // Preencher configurações\n            preencherConfiguracoes(disparo, mensagens);\n\n            // Criar gráficos\n            setTimeout(() => {\n                criarGraficoStatus(enviados, falhas, pendentes);\n                criarGraficoHorario(mensagens);\n            }, 100);\n\n            // Criar preview das mensagens\n            criarPreviewMensagens(disparo.Mensagens);\n\n            // Renderizar tabela\n            renderizarTabelaDetalhes(mensagens, disparo.Mensagens);\n\n            showDashboard();\n        }\n\n        function formatarDiasSemana(diasSelecionados) {\n            console.log('🔍 Dias selecionados recebidos:', diasSelecionados, 'Tipo:', typeof diasSelecionados);\n            \n            if (!diasSelecionados) return '-';\n            \n            const mapaDias = {\n                '0': 'Dom',\n                '1': 'Seg', \n                '2': 'Ter',\n                '3': 'Qua',\n                '4': 'Qui',\n                '5': 'Sex',\n                '6': 'Sab'\n            };\n            \n            // Se vier como string com números separados por vírgula\n            if (typeof diasSelecionados === 'string') {\n                console.log('📝 Processando string:', diasSelecionados);\n                const numeros = diasSelecionados.split(',').map(d => d.trim());\n                console.log('📝 Números extraídos:', numeros);\n                const diasFormatados = numeros.map(num => {\n                    const diaFormatado = mapaDias[num];\n                    console.log(`📝 Mapeando ${num} -> ${diaFormatado}`);\n                    return diaFormatado || num;\n                }).filter(Boolean);\n                console.log('📝 Dias formatados:', diasFormatados);\n                return diasFormatados.length > 0 ? diasFormatados.join(', ') : '-';\n            }\n            \n            // Se vier como array\n            if (Array.isArray(diasSelecionados)) {\n                console.log('📝 Processando array:', diasSelecionados);\n                const diasFormatados = diasSelecionados.map(num => {\n                    const diaFormatado = mapaDias[String(num)];\n                    console.log(`📝 Mapeando ${num} -> ${diaFormatado}`);\n                    return diaFormatado || String(num);\n                }).filter(Boolean);\n                console.log('📝 Dias formatados:', diasFormatados);\n                return diasFormatados.length > 0 ? diasFormatados.join(', ') : '-';\n            }\n            \n            // Se for um número único\n            if (typeof diasSelecionados === 'number') {\n                console.log('📝 Processando número:', diasSelecionados);\n                const diaFormatado = mapaDias[String(diasSelecionados)];\n                console.log(`📝 Mapeando ${diasSelecionados} -> ${diaFormatado}`);\n                return diaFormatado || String(diasSelecionados);\n            }\n            \n            console.log('📝 Retornando string direta:', String(diasSelecionados));\n            return String(diasSelecionados);\n        }\n\n        function extrairConexoesUnicas(arrayMensagens) {\n            if (!arrayMensagens || !Array.isArray(arrayMensagens)) return '-';\n            \n            // Extrair todos os NomeConexao únicos (ou InstanceName como fallback)\n            const conexoesUnicas = new Set();\n            \n            arrayMensagens.forEach((mensagem) => {\n                const nomeConexao = mensagem.NomeConexao || mensagem.InstanceName;\n                if (nomeConexao) {\n                    conexoesUnicas.add(nomeConexao);\n                }\n            });\n            \n            const conexoesArray = Array.from(conexoesUnicas);\n            return conexoesArray.length > 0 ? conexoesArray.join(', ') : '-';\n        }\n\n        function preencherConfiguracoes(disparo, mensagens) {\n            // Verificar se é disparo de grupos e ocultar configurações\n            const configContainer = document.getElementById('configContainer');\n            const configSection = configContainer.closest('.config-section-inline');\n            \n            if (disparo.TipoDisparo === 'Grupos') {\n                console.log('👥 Disparo de grupos detectado - ocultando configurações');\n                configSection.style.display = 'none';\n                return; // Não preenche as configurações para disparos de grupos\n            } else {\n                console.log('📱 Disparo individual detectado - mostrando configurações');\n                configSection.style.display = 'block';\n            }\n            \n            const horario = `${disparo.StartTime || '-'} às ${disparo.EndTime || '-'}`;\n            document.getElementById('horarioDisparo').textContent = horario;\n            \n            // Formatar dias da semana\n            console.log('📅 Disparo.DiasSelecionados:', disparo.DiasSelecionados);\n            const dias = formatarDiasSemana(disparo.DiasSelecionados);\n            console.log('📅 Dias formatados:', dias);\n            document.getElementById('diasDisparo').textContent = dias;\n            \n            const intervalo = `${disparo.intervaloMin || '-'} a ${disparo.intervaloMax || '-'} seg`;\n            document.getElementById('intervaloDisparo').textContent = intervalo;\n            \n            const pausa = `${disparo.PausaAposMensagens || '-'} msg, ${disparo.PausaMinutos || '-'} min`;\n            document.getElementById('pausaDisparo').textContent = pausa;\n            \n            // Extrair conexões únicas do InstanceName dos contatos\n            const conexoes = extrairConexoesUnicas(mensagens);\n            document.getElementById('conexoesDisparo').textContent = conexoes;\n            \n            // Atualizar previsão de finalização\n            const previsao = calcularPrevisaoFinalizacao(mensagens, disparo);\n            const previsaoElement = document.getElementById('previsaoFinalizacao');\n            previsaoElement.textContent = previsao;\n            \n            // Adicionar classes CSS baseadas no status\n            if (previsao === 'A definir') {\n                previsaoElement.classList.add('definir');\n                previsaoElement.classList.remove('cancelado');\n            } else if (previsao === '-' && disparo.StatusDisparo === 'Cancelado') {\n                previsaoElement.classList.add('cancelado');\n                previsaoElement.classList.remove('definir');\n            } else {\n                previsaoElement.classList.remove('definir', 'cancelado');\n            }\n        }\n\n        function calcularPrevisaoFinalizacao(arrayMensagens, disparo) {\n            // Verificar status do disparo primeiro\n            if (disparo && disparo.StatusDisparo) {\n                if (disparo.StatusDisparo === 'Finalizado') {\n                    return 'Finalizado';\n                } else if (disparo.StatusDisparo === 'Pausado') {\n                    return 'A definir';\n                } else if (disparo.StatusDisparo === 'Cancelado') {\n                    return '-';\n                }\n            }\n            \n            // Se não há mensagens, retornar '-'\n            if (!arrayMensagens || arrayMensagens.length === 0) return '-';\n            \n            // Para disparos em andamento, calcular baseado na última mensagem\n            const ultimoDisparo = arrayMensagens.reduce((latest, current) => {\n                const currentDate = new Date(current.dataEnvio);\n                const latestDate = new Date(latest.dataEnvio);\n                return currentDate > latestDate ? current : latest;\n            });\n            \n            if (ultimoDisparo && ultimoDisparo.dataEnvio) {\n                return formatarDataHora(ultimoDisparo.dataEnvio);\n            }\n            return '-';\n        }\n\n        function criarPreviewMensagens(mensagens) {\n            if (!mensagens || mensagens.length === 0) return;\n\n            const grid = document.getElementById('messagesGrid');\n            grid.innerHTML = '';\n\n            // Gerar valores dinâmicos para variáveis de tempo (igual ao disparos-individual)\n            const now = new Date();\n            const hora = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });\n            const data = now.toLocaleDateString('pt-BR');\n            const diasSemana = ['Domingo', 'Segunda-feira', 'Terça-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira', 'Sábado'];\n            const diadasemana = diasSemana[now.getDay()];\n            const meses = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];\n            const mes = meses[now.getMonth()];\n            \n            // Calcular saudação baseada na hora\n            const currentHour = now.getHours();\n            let saudacao;\n            if (currentHour >= 5 && currentHour < 12) {\n                saudacao = 'Bom dia';\n            } else if (currentHour >= 12 && currentHour < 18) {\n                saudacao = 'Boa tarde';\n            } else {\n                saudacao = 'Boa noite';\n            }\n\n            const tempoVarsValues = {\n                'saudacao': saudacao,\n                'hora': hora,\n                'data': data,\n                'diadasemana': diadasemana,\n                'mes': mes,\n                'nome': 'João Silva' // Exemplo padrão\n            };\n\n            // Definir variáveis disponíveis (igual ao disparos-individual)\n            const availableVariables = ['nome', 'saudacao', 'hora', 'data', 'diadasemana', 'mes'];\n\n            mensagens.slice(0, 8).forEach((mensagem, index) => {\n                const card = document.createElement('div');\n                card.className = 'message-card';\n                \n                const tipo = determinarTipoMensagem(mensagem);\n                const tipoTraduzido = traduzirTipoMensagem(tipo);\n                \n                // Determinar o conteúdo baseado no tipo de mensagem\n                let conteudo = '';\n                let tipoLabel = '';\n                \n                if (mensagem.media && mensagem.media.filename) {\n                    // Mensagem com mídia\n                    switch (mensagem.media.type) {\n                        case 'image':\n                            tipoLabel = 'IMAGEM ANEXADA';\n                            conteudo = mensagem.text || 'Imagem enviada';\n                            break;\n                        case 'document':\n                            tipoLabel = 'DOCUMENTO ANEXADO';\n                            conteudo = mensagem.text || 'Documento enviado';\n                            break;\n                        case 'video':\n                            tipoLabel = 'VÍDEO ANEXADO';\n                            conteudo = mensagem.text || 'Vídeo enviado';\n                            break;\n                        case 'audio':\n                            tipoLabel = 'ÁUDIO ANEXADO';\n                            conteudo = mensagem.text || 'Áudio enviado';\n                            break;\n                        default:\n                            tipoLabel = 'MÍDIA ANEXADA';\n                            conteudo = mensagem.text || 'Mídia enviada';\n                    }\n                } else if (mensagem.text) {\n                    // Mensagem de texto\n                    tipoLabel = 'MENSAGEM DE TEXTO';\n                    conteudo = mensagem.text;\n                } else {\n                    // Mensagem sem conteúdo\n                    tipoLabel = 'MENSAGEM VAZIA';\n                    conteudo = 'Sem conteúdo';\n                }\n                \n                // Aplicar formatação EXATAMENTE como na página disparos-individuais\n                let previewText = conteudo;\n                \n                // 1. PRIMEIRO: Processa as variáveis entre <> (antes da formatação HTML)\n                previewText = previewText.replace(/<([^>]+)>/g, (match, variable) => {\n                    // Verificar se é uma variável conhecida com valor real\n                    if (tempoVarsValues[variable]) {\n                        // Se tem valor real, mostra o valor destacado em verde\n                        return `<span style=\"background: rgba(37, 211, 102, 0.15); color: #25d366; font-weight: 600; padding: 2px 6px; border-radius: 4px; border: 1px solid rgba(37, 211, 102, 0.3); font-size: 0.85em;\">${tempoVarsValues[variable]}</span>`;\n                    } else {\n                        // Se não tem valor, mostra o label formatado entre < >\n                        const label = variable.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');\n                        return `<span style=\"background: rgba(37, 211, 102, 0.15); color: #25d366; font-weight: 600; padding: 2px 6px; border-radius: 4px; border: 1px solid rgba(37, 211, 102, 0.3); font-size: 0.85em;\">&lt;${label}&gt;</span>`;\n                    }\n                });\n                \n                // 2. DEPOIS: Aplica formatação (negrito e itálico) - isso não vai interferir nas variáveis\n                previewText = previewText.replace(/\\*(.*?)\\*/g, '<strong>$1</strong>');\n                previewText = previewText.replace(/_(.*?)_/g, '<em>$1</em>');\n                \n                // Truncar se muito longo (após formatação) - ATENÇÃO: não truncar HTML\n                let preview = previewText;\n                if (previewText.replace(/<[^>]*>/g, '').length > 120) {\n                    // Se o texto SEM tags HTML for muito longo, truncar cuidadosamente\n                    const textOnly = previewText.replace(/<[^>]*>/g, '');\n                    if (textOnly.length > 120) {\n                        // Procurar um ponto seguro para truncar (antes de uma tag)\n                        const truncateAt = previewText.indexOf('<', 120);\n                        if (truncateAt > 0 && truncateAt < previewText.length) {\n                            preview = previewText.substring(0, truncateAt) + '...';\n                        } else {\n                            preview = previewText.substring(0, 120) + '...';\n                        }\n                    }\n                }\n                \n\n\n                // Criar o conteúdo usando createElement para preservar HTML\n                const headerDiv = document.createElement('div');\n                headerDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;';\n                headerDiv.innerHTML = `\n                    <span class=\"message-type ${tipoTraduzido}\">${tipoLabel}</span>\n                    <span style=\"color: rgba(255,255,255,0.6); font-size: 0.7rem;\">#${index + 1}</span>\n                `;\n\n                const contentDiv = document.createElement('div');\n                contentDiv.style.cssText = 'color: rgba(255,255,255,0.9); line-height: 1.4; font-size: 0.85rem;';\n                contentDiv.innerHTML = preview; // Aqui o HTML será renderizado corretamente\n\n                card.appendChild(headerDiv);\n                card.appendChild(contentDiv);\n                \n                grid.appendChild(card);\n            });\n        }\n\n        function determinarTipoMensagem(mensagem) {\n            if (mensagem.media && mensagem.media.filename) {\n                return mensagem.media.type || 'document';\n            }\n            return 'text';\n        }\n\n        function traduzirTipoMensagem(tipo) {\n            const traducoes = {\n                'text': 'texto',\n                'image': 'imagem',\n                'video': 'video',\n                'audio': 'audio',\n                'document': 'documento'\n            };\n            return traducoes[tipo] || 'texto';\n        }\n\n        function renderizarTabelaDetalhes(mensagens, mensagensDisparo) {\n            // Verificar se mensagens é válido e atualizar variável global\n            if (!mensagens || !Array.isArray(mensagens)) {\n                mensagens = [];\n            }\n            \n            // Atualizar variável global\n            arrayMensagens = mensagens;\n            window.arrayMensagens = arrayMensagens;\n            \n            // Inicializar dados filtrados e resetar filtro\n            filteredData = [...arrayMensagens];\n            currentPage = 1;\n            currentFilter = 'all';\n            \n            // Resetar o select para \"Todos\"\n            const statusFilter = document.getElementById('statusFilter');\n            if (statusFilter) {\n                statusFilter.value = 'all';\n            }\n            \n            atualizarTabela();\n            atualizarInfoFiltro();\n            atualizarPaginacao();\n            \n            // Remover event listeners antigos para evitar duplicação\n            const prevBtn = document.getElementById('prevPage');\n            const nextBtn = document.getElementById('nextPage');\n            \n            if (statusFilter) {\n            statusFilter.removeEventListener('change', aplicarFiltro);\n            statusFilter.addEventListener('change', aplicarFiltro);\n            }\n            \n            if (prevBtn) {\n                prevBtn.removeEventListener('click', paginaAnterior);\n            prevBtn.addEventListener('click', paginaAnterior);\n            }\n            \n            if (nextBtn) {\n                nextBtn.removeEventListener('click', proximaPagina);\n                nextBtn.addEventListener('click', proximaPagina);\n            }\n        }\n\n        function atualizarTabela() {\n            const tableBody = document.getElementById('disparosTableBody');\n            if (!tableBody) {\n                return;\n            }\n            \n            tableBody.innerHTML = '';\n\n            // Verificar se filteredData é válido\n            if (!filteredData || !Array.isArray(filteredData)) {\n                filteredData = [];\n            }\n\n            const startIndex = (currentPage - 1) * itemsPerPage;\n            const endIndex = startIndex + itemsPerPage;\n            const pageData = filteredData.slice(startIndex, endIndex);\n\n            if (pageData.length === 0) {\n                const row = document.createElement('tr');\n                row.innerHTML = '<td colspan=\"5\" style=\"text-align: center; color: rgba(255,255,255,0.6); padding: 40px;\">Nenhum contato encontrado</td>';\n                tableBody.appendChild(row);\n                return;\n            }\n\n            pageData.forEach((mensagem, index) => {\n                const row = document.createElement('tr');\n                \n                // Debug: verificar campos disponíveis\n                if (index === 0) {\n                    console.log('🔍 Campos disponíveis na mensagem:', Object.keys(mensagem));\n                    console.log('🔍 Mensagem completa:', mensagem);\n                }\n                \n                // Verificar se é disparo de grupos e mostrar NomeGrupo em vez do telefone\n                let telefone;\n                if (dadosDisparo && dadosDisparo.TipoDisparo === 'Grupos') {\n                    // Para disparos de grupos, mostrar o NomeGrupo\n                    telefone = mensagem.NomeGrupo || mensagem.nomeGrupo || 'Grupo sem nome';\n                } else {\n                    // Para disparos individuais, mostrar o telefone formatado\n                    telefone = formatarTelefone(mensagem.TelefoneContato);\n                }\n                \n                // Manter o status original do JSON\n                let status = mensagem.Status || 'pending';\n                let statusClass = '';\n                \n                // Mapear status para classes CSS\n                switch (status) {\n                    case 'sent': status = 'Enviado'; statusClass = 'pill-enviado'; break;\n                    case 'failed': case 'error': status = 'Falha'; statusClass = 'pill-falha'; break;\n                    case 'pending': case 'waiting': status = 'Pendente'; statusClass = 'pill-pendente'; break;\n                    default: status = status.charAt(0).toUpperCase() + status.slice(1); statusClass = 'pill-pendente';\n                }\n                \n                const dataFormatada = formatarDataHora(mensagem.dataEnvio);\n                \n                // Verificar se há conexão\n                const temConexao = mensagem.NomeConexao || mensagem.InstanceName;\n                const conexao = temConexao || 'SEM CONEXÃO';\n                const conexaoClass = temConexao ? '' : 'sem-conexao';\n                \n                // Processar mensagem para exibição - tentar diferentes campos\n                const mensagemTexto = mensagem.MensagemEnviada || mensagem.text || mensagem.mensagem || mensagem.Mensagem || 'Sem mensagem';\n                const mensagemTruncada = mensagemTexto.length > 20 ? mensagemTexto.substring(0, 20) + '...' : mensagemTexto;\n                const mensagemHtml = mensagemTexto.length > 20 ? \n                    `<span class=\"message-preview\" title=\"${mensagemTexto.replace(/\"/g, '&quot;')}\">${mensagemTruncada}</span>` : \n                    `<span class=\"message-preview\">${mensagemTruncada}</span>`;\n\n                let statusHtml = `<span class=\"pill ${statusClass}\">${status}</span>`;\n                \n                // Mostrar ícone de erro se houver mensagemErro (independente de ter conexão)\n                if (mensagem.mensagemErro) {\n                    statusHtml += `\n                        <div class=\"tooltip\">\n                            <svg class=\"error-icon\" viewBox=\"0 0 24 24\">\n                                <path d=\"M12 2L1 21h22L12 2zm0 3.17L19.83 19H4.17L12 5.17zM11 16h2v2h-2zm0-6h2v4h-2z\"/>\n                            </svg>\n                            <span class=\"tooltiptext\">${mensagem.mensagemErro}</span>\n                        </div>\n                    `;\n                }\n\n                // Determinar a classe CSS para a célula do telefone/grupo\n                const telefoneClass = (dadosDisparo && dadosDisparo.TipoDisparo === 'Grupos') ? '' : 'phone-cell';\n                \n                row.innerHTML = `\n                    <td class=\"${telefoneClass}\" style=\"${dadosDisparo && dadosDisparo.TipoDisparo === 'Grupos' ? 'color: #25d366; font-weight: 600;' : ''}\">${telefone}</td>\n                    <td>${statusHtml}</td>\n                    <td style=\"color: rgba(255,255,255,0.6);\">${dataFormatada}</td>\n                    <td style=\"color: rgba(255,255,255,0.8); max-width: 200px; overflow: hidden;\">${mensagemHtml}</td>\n                    <td class=\"${conexaoClass}\" style=\"color: ${temConexao ? 'rgba(255,255,255,0.6)' : '#ff3b30'}; font-weight: ${temConexao ? 'normal' : '700'};\">${conexao}</td>\n                `;\n                \n                tableBody.appendChild(row);\n            });\n        }\n\n        function formatarTelefone(telefone) {\n            if (!telefone) return 'N/A';\n            let numero = telefone.replace(/^55/, '');\n            if (numero.length === 11) {\n                return `+55 (${numero.substring(0, 2)}) ${numero.substring(2, 7)}-${numero.substring(7)}`;\n            } else if (numero.length === 10) {\n                return `+55 (${numero.substring(0, 2)}) ${numero.substring(2, 6)}-${numero.substring(6)}`;\n            }\n            return `+55 ${numero}`;\n        }\n\n        function formatarDataHora(dataString) {\n            try {\n                const data = new Date(dataString);\n                if (isNaN(data.getTime())) return 'Data inválida';\n                \n                const dataFormatada = data.toLocaleDateString('pt-BR', {\n                    day: '2-digit',\n                    month: '2-digit',\n                    year: 'numeric'\n                });\n                \n                const horaFormatada = data.toLocaleTimeString('pt-BR', {\n                    hour: '2-digit',\n                    minute: '2-digit'\n                });\n                \n                return `${dataFormatada} ${horaFormatada}`;\n            } catch (error) {\n                console.warn('Erro ao formatar data:', dataString, error);\n                return 'Data inválida';\n            }\n        }\n\n        // Buscar detalhes\n        async function buscarDetalhesDisparo() {\n            const userId = getSecureUserId();\n            if (!userId) {\n                hideLoading();\n                console.error('Sessão inválida. Faça login novamente.');\n                return;\n            }\n\n            idDisparo = getCookie('idDisparo');\n            if (!idDisparo) {\n                hideLoading();\n                console.error('ID do disparo não encontrado.');\n                return;\n            }\n\n            try {\n                const response = await fetch('https://n8n.typebot.pro/webhook/buscardetalhesdisparo', {\n                    method: 'POST',\n                    headers: { 'Content-Type': 'application/json' },\n                    body: JSON.stringify({ userId: userId, idDisparo: idDisparo })\n                });\n\n                if (!response.ok) {\n                    throw new Error(`HTTP error! status: ${response.status}`);\n                }\n\n                const data = await response.json();\n                \n                if (data && (data.length > 0 || data['Detalhes Disparo'])) {\n                    const primeiroItem = Array.isArray(data) ? data[0] : data;\n                    \n                    let detalhesDisparo = JSON.parse(primeiroItem['Detalhes Disparo']);\n                    let mensagens = JSON.parse(primeiroItem['Contatos Disparo']);\n                    \n                    // Verificar se os dados foram parseados corretamente\n                    if (!Array.isArray(mensagens)) {\n                        mensagens = [];\n                    }\n                    \n                    inserirDadosDisparo(detalhesDisparo, mensagens);\n                    hideLoading();\n                } else {\n                    throw new Error('Nenhum dado encontrado para este disparo');\n                }\n\n            } catch (error) {\n                console.error('Erro na requisição:', error);\n                hideLoading();\n            }\n        }\n\n        async function carregarDetalhes() {\n            document.getElementById('actionsDropdown').classList.remove('show');\n            await buscarDetalhesDisparo();\n        }\n\n        function voltarHistorico() {\n            window.location.href = 'https://n8n.typebot.pro/webhook/historico-disparos';\n        }\n\n        // Funções do Popup de Conexões\n        let conexoesSelecionadas = [];\n        let conexoesAtivas = [];\n\n        function abrirPopupConexoes() {\n            console.log('🔍 Abrindo popup de conexões...');\n            const popup = document.getElementById('popupConexoes');\n            console.log('🔍 Elemento popup encontrado:', popup);\n            \n            if (popup) {\n                // Forçar display diretamente no style\n                popup.style.display = 'flex';\n                popup.style.position = 'fixed';\n                popup.style.top = '0';\n                popup.style.left = '0';\n                popup.style.width = '100vw';\n                popup.style.height = '100vh';\n                popup.style.background = 'rgba(0,0,0,0.8)';\n                popup.style.zIndex = '2147483647';\n                popup.style.alignItems = 'center';\n                popup.style.justifyContent = 'center';\n                \n                console.log('✅ Popup exibido com sucesso');\n                carregarConexoesDisponiveis();\n            } else {\n                console.error('❌ Elemento popupConexoes não encontrado');\n            }\n        }\n\n        function fecharPopupConexoes() {\n            const popup = document.getElementById('popupConexoes');\n            if (popup) {\n                popup.style.display = 'none';\n                console.log('✅ Popup fechado com sucesso');\n            }\n            conexoesSelecionadas = [];\n            conexoesAtivas = [];\n            atualizarBotaoConfirmar();\n        }\n\n        async function carregarConexoesDisponiveis() {\n            const userId = getSecureUserId();\n            if (!userId) {\n                console.error('Usuário não autenticado');\n                return;\n            }\n\n            const loadingDiv = document.getElementById('conexoesLoading');\n            const gridDiv = document.getElementById('conexoesGrid');\n            const progressDiv = document.getElementById('verificationProgress');\n\n            try {\n                // Mostrar loading\n                loadingDiv.style.display = 'block';\n                gridDiv.style.display = 'none';\n                progressDiv.textContent = 'Carregando conexões disponíveis...';\n\n                console.log('🔍 Fazendo requisição para listar conexões...');\n                console.log('🔍 userId:', userId);\n\n                const response = await fetch('https://n8n.typebot.pro/webhook/listarconexoes', {\n                    method: 'POST',\n                    headers: {\n                        'Content-Type': 'application/json'\n                    },\n                    body: JSON.stringify({ userId: userId })\n                });\n\n                console.log('🔍 Status da resposta:', response.status);\n                console.log('🔍 Response ok:', response.ok);\n\n                if (!response.ok) {\n                    const errorText = await response.text();\n                    console.error('❌ Erro na API:', response.status, errorText);\n                    throw new Error(`Erro ao carregar conexões: ${response.status} - ${errorText}`);\n                }\n\n                const responseData = await response.json();\n                console.log('✅ Conexões carregadas:', responseData);\n\n                // Processar conexões da resposta\n                let rawConnections = [];\n                if (responseData && responseData.Conexoes && Array.isArray(responseData.Conexoes)) {\n                    rawConnections = responseData.Conexoes;\n                } else if (Array.isArray(responseData) && responseData.length > 0 && responseData[0].Conexoes && Array.isArray(responseData[0].Conexoes)) {\n                    rawConnections = responseData[0].Conexoes;\n                } else if (responseData && responseData.data && Array.isArray(responseData.data)) {\n                    rawConnections = responseData.data;\n                } else if (Array.isArray(responseData)) {\n                    rawConnections = responseData;\n                } else {\n                    rawConnections = [];\n                }\n\n                console.log('🔍 Conexões brutas encontradas:', rawConnections);\n\n                // Filtrar apenas conexões ativas\n                conexoesAtivas = rawConnections.filter(conn => {\n                    const instanceName = conn.instanceName || conn.instance_name;\n                    const nomeConexao = conn.NomeConexao || conn.nomeConexao || conn.name;\n                    return instanceName && nomeConexao;\n                });\n\n                console.log('🔍 Conexões ativas filtradas:', conexoesAtivas);\n\n                progressDiv.textContent = `${conexoesAtivas.length} conexões encontradas`;\n                \n                if (conexoesAtivas.length === 0) {\n                    gridDiv.innerHTML = '<p style=\"text-align: center; color: rgba(255,255,255,0.7); padding: 20px;\">Nenhuma conexão encontrada. Conecte um WhatsApp primeiro.</p>';\n                } else {\n                    renderizarConexoes(conexoesAtivas);\n                }\n\n            } catch (error) {\n                console.error('❌ Erro ao carregar conexões:', error);\n                progressDiv.textContent = 'Erro ao carregar conexões';\n                gridDiv.innerHTML = `\n                    <div style=\"text-align: center; color: #ff3b30; padding: 20px;\">\n                        <p>❌ Erro ao carregar conexões</p>\n                        <p style=\"font-size: 0.9rem; margin-top: 10px;\">${error.message}</p>\n                        <button onclick=\"carregarConexoesDisponiveis()\" style=\"margin-top: 15px; padding: 8px 16px; background: #25d366; border: none; border-radius: 6px; color: white; cursor: pointer;\">Tentar Novamente</button>\n                    </div>\n                `;\n            } finally {\n                loadingDiv.style.display = 'none';\n                gridDiv.style.display = 'block';\n            }\n        }\n\n        function renderizarConexoes(conexoes) {\n            const grid = document.getElementById('conexoesGrid');\n            grid.innerHTML = '';\n\n            console.log('🎨 Renderizando conexões:', conexoes);\n\n            // Inicializar todas as conexões como \"verificando\" status\n            conexoes.forEach((conexao, index) => {\n                conexoesAtivas[index].isConnected = null; // null = verificando\n                conexoesAtivas[index].isVerifying = true;\n                console.log('📝 Conexão inicializada:', {\n                    idConexao: conexoesAtivas[index].idConexao,\n                    nome: conexoesAtivas[index].NomeConexao || conexoesAtivas[index].nomeConexao || conexoesAtivas[index].name,\n                    isConnected: conexoesAtivas[index].isConnected,\n                    isVerifying: conexoesAtivas[index].isVerifying\n                });\n            });\n\n            conexoes.forEach((conexao, index) => {\n                const item = document.createElement('div');\n                item.style.cssText = 'display: flex; align-items: center; gap: 12px; padding: 16px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; cursor: pointer; transition: all 0.3s ease; margin-bottom: 8px;';\n                item.onclick = () => toggleConexaoSelecao(conexao.id, item);\n\n                const nomeConexao = conexao.NomeConexao || conexao.nomeConexao || conexao.name || 'Conexão sem nome';\n                const instanceName = conexao.instanceName || conexao.instance_name;\n\n                item.innerHTML = `\n                    <div style=\"width: 20px; height: 20px; border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 4px; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;\"></div>\n                    <div style=\"flex: 1;\">\n                        <div style=\"color: #fff; font-weight: 600; margin-bottom: 4px;\">${nomeConexao}</div>\n                        <div style=\"font-size: 0.85rem; display: flex; align-items: center; gap: 6px;\">\n                            <div style=\"width: 8px; height: 8px; border-radius: 50%; background: #ff9500; animation: pulse 1s infinite;\"></div>\n                            <span style=\"color: #ff9500;\">Verificando...</span>\n                        </div>\n                    </div>\n                `;\n\n                grid.appendChild(item);\n            });\n\n            // Verificar status de cada conexão em paralelo\n            conexoes.forEach(async (conexao, index) => {\n                try {\n                    const instanceName = conexao.instanceName || conexao.instance_name;\n                    if (!instanceName) { \n                        conexoesAtivas[index].isConnected = false;\n                        conexoesAtivas[index].isVerifying = false;\n                        updateConexaoStatus(index, conexoesAtivas[index], false);\n                        return; \n                    }\n                    \n                    console.log(`🔍 Verificando status da conexão ${instanceName}...`);\n                    \n                    const statusResp = await fetch(`https://whatsapi.typebot.pro/instance/connectionState/${instanceName}`, {\n                        method: 'GET',\n                        headers: { 'apikey': 'b4d71f9c38e3ac12a6b08e4b6d53aa90' }\n                    });\n                    \n                    if (!statusResp.ok) { \n                        conexoesAtivas[index].isConnected = false;\n                        conexoesAtivas[index].isVerifying = false;\n                        updateConexaoStatus(index, conexoesAtivas[index], false);\n                        return; \n                    }\n                    \n                    const statusData = await statusResp.json();\n                    const state = statusData?.instance?.state || statusData?.state || statusData?.status || statusData?.connectionState;\n                    const isConnected = (state === 'open' || state === 'connected');\n                    conexoesAtivas[index].isConnected = isConnected;\n                    conexoesAtivas[index].isVerifying = false;\n                    \n                    console.log(`✅ Status da conexão ${instanceName}:`, {\n                        state,\n                        isConnected: conexoesAtivas[index].isConnected\n                    });\n                    \n                    updateConexaoStatus(index, conexoesAtivas[index], isConnected);\n                    \n                } catch (error) { \n                    console.error(`❌ Erro ao verificar status da conexão ${conexao.instanceName}:`, error);\n                    conexoesAtivas[index].isConnected = false; \n                    conexoesAtivas[index].isVerifying = false;\n                    updateConexaoStatus(index, conexoesAtivas[index], false);\n                }\n            });\n        }\n\n        function updateConexaoStatus(index, conexao, isConnected) {\n            const grid = document.getElementById('conexoesGrid');\n            const items = grid.children;\n            \n            if (items[index]) {\n                const item = items[index];\n                const statusIndicator = item.querySelector('div[style*=\"border-radius: 50%\"]');\n                const statusText = item.querySelector('span');\n                \n                if (statusIndicator && statusText) {\n                    if (isConnected) {\n                        // Conexão conectada - normal\n                        statusIndicator.style.background = '#25d366';\n                        statusIndicator.style.animation = 'none';\n                        statusText.textContent = 'Conectado';\n                        statusText.style.color = '#25d366';\n                        item.style.cursor = 'pointer';\n                        item.style.opacity = '1';\n                        console.log(`✅ Conexão ${index} marcada como CONECTADA`);\n                    } else {\n                        // Conexão desconectada - opaca e não clicável\n                        statusIndicator.style.background = '#ff3b30';\n                        statusIndicator.style.animation = 'none';\n                        statusText.textContent = 'Desconectado';\n                        statusText.style.color = '#ff3b30';\n                        item.style.cursor = 'not-allowed';\n                        item.style.opacity = '0.5';\n                        item.style.background = 'rgba(255, 255, 255, 0.02)';\n                        console.log(`❌ Conexão ${index} marcada como DESCONECTADA`);\n                    }\n                }\n            }\n        }\n\n        function toggleConexaoSelecao(idConexao, element) {\n            console.log('🔍 Tentando selecionar conexão:', idConexao);\n            console.log('📋 Conexões ativas:', conexoesAtivas);\n            \n            // Encontrar a conexão correspondente\n            const conexao = conexoesAtivas.find(conn => {\n                const connId = String(conn.id);\n                const targetId = String(idConexao);\n                const match = connId === targetId;\n                \n                console.log('🔍 Comparando:', {\n                    connId: connId,\n                    targetId: targetId,\n                    match: match\n                });\n                return match;\n            });\n            console.log('🎯 Conexão encontrada:', conexao);\n            \n            // Verificar se a conexão foi encontrada\n            if (!conexao) {\n                console.log('❌ Conexão não encontrada no array conexoesAtivas');\n                return;\n            }\n            \n            // Verificar se a conexão está desconectada ou ainda verificando\n            if (conexao.isConnected === false || conexao.isVerifying) {\n                console.log('❌ Conexão não pode ser selecionada:', {\n                    isConnected: conexao.isConnected,\n                    isVerifying: conexao.isVerifying\n                });\n                return; // Não permite seleção\n            }\n            \n            console.log('✅ Conexão pode ser selecionada:', conexao);\n            console.log('📊 Estado atual no array conexoesAtivas:', {\n                isConnected: conexao.isConnected,\n                isVerifying: conexao.isVerifying\n            });\n            \n            const index = conexoesSelecionadas.indexOf(idConexao);\n            \n            if (index > -1) {\n                // Remover da seleção\n                conexoesSelecionadas.splice(index, 1);\n                element.style.background = 'rgba(255, 255, 255, 0.05)';\n                element.style.borderColor = 'rgba(255, 255, 255, 0.1)';\n                element.querySelector('div').style.background = 'transparent';\n                element.querySelector('div').innerHTML = '';\n            } else {\n                // Adicionar à seleção\n                conexoesSelecionadas.push(idConexao);\n                element.style.background = 'rgba(37, 211, 102, 0.15)';\n                element.style.borderColor = '#25d366';\n                element.querySelector('div').style.background = '#25d366';\n                element.querySelector('div').innerHTML = '✓';\n                element.querySelector('div').style.color = 'white';\n                element.querySelector('div').style.fontWeight = 'bold';\n            }\n\n            atualizarBotaoConfirmar();\n        }\n\n        function atualizarBotaoConfirmar() {\n            const btnConfirmar = document.getElementById('btnConfirmarConexoes');\n            btnConfirmar.disabled = conexoesSelecionadas.length === 0;\n        }\n\n        async function confirmarAdicionarConexoes() {\n            if (conexoesSelecionadas.length === 0) {\n                alert('Selecione pelo menos uma conexão');\n                return;\n            }\n\n            const userId = getSecureUserId();\n            const idDisparo = getCookie('idDisparo');\n            \n            console.log('🔍 Valores obtidos:', {\n                userId: userId,\n                idDisparo: idDisparo,\n                conexoesSelecionadas: conexoesSelecionadas\n            });\n            \n            if (!userId || !idDisparo) {\n                console.error('❌ userId ou idDisparo não encontrados');\n                alert('Erro: Dados do disparo não encontrados. Recarregue a página.');\n                return;\n            }\n            \n            // Converter idDisparo para número\n            const idDisparoNum = parseInt(idDisparo);\n            if (isNaN(idDisparoNum)) {\n                console.error('❌ idDisparo não é um número válido:', idDisparo);\n                alert('Erro: ID do disparo inválido. Recarregue a página.');\n                return;\n            }\n\n            const btnConfirmar = document.getElementById('btnConfirmarConexoes');\n            btnConfirmar.disabled = true;\n            btnConfirmar.textContent = 'Adicionando...';\n\n            try {\n                console.log('🚀 Enviando requisição para adicionar conexões:', {\n                    userId: userId,\n                    idDisparo: idDisparoNum,\n                    idConexoes: conexoesSelecionadas\n                });\n\n                const response = await fetch('https://n8n.typebot.pro/webhook/vincular-conexoes-disparo', {\n                    method: 'POST',\n                    headers: {\n                        'Content-Type': 'application/json'\n                    },\n                    body: JSON.stringify({\n                        userId: userId,\n                        idDisparo: idDisparoNum,\n                        idConexoes: conexoesSelecionadas\n                    })\n                });\n\n                console.log('📡 Response status:', response.status);\n                console.log('📡 Response headers:', response.headers);\n\n                if (response.ok) {\n                    const result = await response.json();\n                    console.log('✅ Conexões adicionadas com sucesso:', result);\n                    fecharPopupConexoes();\n                    \n                    // Recarregar detalhes do disparo\n                    await buscarDetalhesDisparo();\n                    \n                    // Mostrar mensagem de sucesso\n                    alert('Conexões adicionadas com sucesso! O disparo será retomado automaticamente.');\n                } else {\n                    console.error('❌ Erro HTTP:', response.status, response.statusText);\n                    \n                    // Tentar ler o response como texto primeiro\n                    const responseText = await response.text();\n                    console.error('❌ Response body:', responseText);\n                    \n                    // Tentar parse como JSON se possível\n                    let errorMessage = `Erro ${response.status}: ${response.statusText}`;\n                    try {\n                        const errorData = JSON.parse(responseText);\n                        errorMessage = errorData.message || errorData.error || errorMessage;\n                    } catch (parseError) {\n                        console.error('❌ Não foi possível parsear response como JSON:', parseError);\n                        errorMessage = `Erro ${response.status}: ${response.statusText}`;\n                    }\n                    \n                    throw new Error(errorMessage);\n                }\n            } catch (error) {\n                console.error('❌ Erro ao adicionar conexões:', error);\n                alert('Erro ao adicionar conexões: ' + error.message);\n            } finally {\n                btnConfirmar.disabled = false;\n                btnConfirmar.textContent = 'Adicionar Conexões';\n            }\n        }\n\n        // Adicionar event listeners\n        document.addEventListener('DOMContentLoaded', function() {\n            console.log('🔍 Configurando event listeners...');\n            \n            // Event listener para o botão \"Adicionar Conexões\"\n            const btnAdicionarConexoes = document.getElementById('btnAdicionarConexoes');\n            if (btnAdicionarConexoes) {\n                btnAdicionarConexoes.addEventListener('click', function(e) {\n                    console.log('🔍 Botão Adicionar Conexões clicado!');\n                    e.preventDefault();\n                    abrirPopupConexoes();\n                });\n                console.log('✅ Event listener do botão adicionado com sucesso');\n            } else {\n                console.error('❌ Botão btnAdicionarConexoes não encontrado');\n            }\n\n            // Event listener para fechar popup ao clicar fora\n            const popupOverlay = document.getElementById('popupConexoes');\n            if (popupOverlay) {\n                popupOverlay.addEventListener('click', function(e) {\n                    if (e.target === popupOverlay) {\n                        console.log('🔍 Clicou fora do popup, fechando...');\n                        fecharPopupConexoes();\n                    }\n                });\n                console.log('✅ Event listener do popup adicionado com sucesso');\n            } else {\n                console.error('❌ Elemento popupConexoes não encontrado');\n            }\n\n            // Event listener para fechar com ESC\n            document.addEventListener('keydown', function(e) {\n                if (e.key === 'Escape') {\n                    const popup = document.getElementById('popupConexoes');\n                    if (popup && popup.style.display === 'flex') {\n                        fecharPopupConexoes();\n                    }\n                }\n            });\n        });\n\n        // Inicialização\n        async function inicializarPagina() {\n            checkAuth();\n            await buscarDetalhesDisparo();\n        }\n\n\n\n\n\n\n\n        if (document.readyState === 'loading') {\n            document.addEventListener('DOMContentLoaded', inicializarPagina);\n        } else {\n            inicializarPagina();\n        }\n    </script>\n\n    <!-- POPUP DE CONEXÕES - FUNCIONAL -->\n    <div id=\"popupConexoes\" style=\"position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.8); z-index: 2147483647; display: none; align-items: center; justify-content: center;\">\n        <div style=\"background: rgba(26, 26, 26, 0.95); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 16px; padding: 30px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; backdrop-filter: blur(10px); box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);\">\n            <!-- Header -->\n            <div style=\"display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;\">\n                <h3 style=\"font-size: 1.3rem; font-weight: 600; color: #25d366; margin: 0;\">🔗 Adicionar Conexões ao Disparo</h3>\n                <button onclick=\"fecharPopupConexoes()\" style=\"background: none; border: none; color: #888; font-size: 1.5rem; cursor: pointer; padding: 5px; border-radius: 4px; transition: all 0.3s ease;\">&times;</button>\n            </div>\n            \n            <!-- Body -->\n            <div style=\"margin-bottom: 20px;\">\n                <div style=\"margin-bottom: 20px;\">\n                    <p style=\"color: rgba(255, 255, 255, 0.9); margin-bottom: 12px;\">Selecione as conexões que deseja adicionar ao disparo:</p>\n                    <div id=\"verificationProgress\" style=\"color: rgba(255, 255, 255, 0.7); font-size: 0.9rem;\">Verificando conexões disponíveis...</div>\n                </div>\n                \n                <div id=\"conexoesLoading\" style=\"text-align: center; padding: 40px 20px;\">\n                    <div style=\"width: 40px; height: 40px; border: 4px solid rgba(37, 211, 102, 0.2); border-top: 4px solid #25d366; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;\"></div>\n                    <p style=\"color: rgba(255, 255, 255, 0.8); margin-top: 16px;\">Carregando conexões...</p>\n                </div>\n                \n                <div id=\"conexoesGrid\" style=\"display: none;\">\n                    <!-- Conexões serão inseridas aqui dinamicamente -->\n                </div>\n            </div>\n            \n            <!-- Footer -->\n            <div style=\"display: flex; justify-content: flex-end; gap: 12px; padding-top: 20px; border-top: 1px solid rgba(255, 255, 255, 0.1);\">\n                <button onclick=\"fecharPopupConexoes()\" style=\"background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: rgba(255, 255, 255, 0.8); padding: 12px 24px; border-radius: 8px; cursor: pointer; transition: all 0.3s ease;\">Cancelar</button>\n                <button id=\"btnConfirmarConexoes\" onclick=\"confirmarAdicionarConexoes()\" disabled style=\"background: #25d366; border: 1px solid #25d366; color: white; padding: 12px 24px; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; font-weight: 600;\">Adicionar Conexões</button>\n            </div>\n        </div>\n    </div>\n</body>\n</html>"},"type":"n8n-nodes-base.html","typeVersion":1.2,"position":[-4240,-4336],"id":"1db83d33-716b-4d4e-9c4f-5f3034e593dc","name":"HTML11"},{"parameters":{"respondWith":"text","responseBody":"={{ $json.html }}","options":{}},"type":"n8n-nodes-base.respondToWebhook","typeVersion":1.1,"position":[-4016,-4336],"id":"9429e680-e8ab-4cbf-ab8f-b7b1cd904111","name":"Respond to Webhook10"},{"parameters":{"path":"detalhes-disparo","responseMode":"responseNode","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-4448,-4336],"id":"eb17b911-d07c-447a-b718-e52c7e8c0daa","name":"DETALHES DISPARO","webhookId":"44ef5672-bb5e-47cb-8c16-50d5ffb78a8c"},{"parameters":{"operation":"getAll","tableId":"vw_Detalhes_Completo","returnAll":true,"matchType":"allFilters","filters":{"conditions":[{"keyName":"idDisparo","condition":"eq","keyValue":"={{ $('DADOS DETALHE DISPARO').item.json.body.idDisparo }}"},{"keyName":"UserId","condition":"eq","keyValue":"={{ $('DADOS DETALHE DISPARO').item.json.body.userId }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-3088,304],"id":"aec1abcc-7310-4758-9975-f57994abdc48","name":"BUSCAR DISPARO","credentials":{"supabaseApi":{"id":"gSmzosOueGcVRiU6","name":"supabase enviazap"}}},{"parameters":{"httpMethod":"POST","path":"pausar-disparo","responseMode":"lastNode","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-3520,-272],"id":"77304f89-d23b-4770-80e2-a874b69b3605","name":"PAUSAR DISPARO","webhookId":"474c4e0c-40db-41a4-96a4-ac4ab7cceae7"},{"parameters":{"httpMethod":"POST","path":"excluir-disparo","responseMode":"lastNode","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-3520,96],"id":"c31d2871-200e-4872-ad60-724f0a6e7a14","name":"EXCLUIR DISPARO","webhookId":"474c4e0c-40db-41a4-96a4-ac4ab7cceae7"},{"parameters":{"operation":"executeQuery","query":"SELECT public.pause_disparo($1::bigint, $2::uuid);","options":{"queryReplacement":"={{ $json.body.idDisparo }},{{ $json.body.userId }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-3296,-272],"id":"6927d7dd-e954-44bf-9528-d02be8886dec","name":"PAUSAR","credentials":{"postgres":{"id":"M6jmYaJzaltqsIk4","name":"Postgres zappro"}}},{"parameters":{"operation":"executeQuery","query":"SELECT public.delete_disparo($1::bigint, $2::uuid);","options":{"queryReplacement":"={{ $json.body.idDisparo }},{{ $json.body.userId }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-3296,96],"id":"1d0d1277-5cac-4984-8f6d-1ecfb4eeb339","name":"EXCLUIR","credentials":{"postgres":{"id":"M6jmYaJzaltqsIk4","name":"Postgres zappro"}}},{"parameters":{"httpMethod":"POST","path":"retomar-disparo","responseMode":"lastNode","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-3520,-96],"id":"66ee5382-c765-4b60-a745-ba15c6f1bf91","name":"RETOMAR DISPARO","webhookId":"474c4e0c-40db-41a4-96a4-ac4ab7cceae7"},{"parameters":{"operation":"executeQuery","query":"SELECT public.resume_disparo($1::bigint, $2::uuid);","options":{"queryReplacement":"={{ $json.body.idDisparo }},{{ $json.body.userId }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-3296,-96],"id":"2a648652-60fb-48e1-9926-2f338439cc81","name":"RETOMAR","credentials":{"postgres":{"id":"M6jmYaJzaltqsIk4","name":"Postgres zappro"}}},{"parameters":{"operation":"getAll","tableId":"SAAS_Disparos","returnAll":true,"matchType":"allFilters","filters":{"conditions":[{"keyName":"id","condition":"eq","keyValue":"={{ $json.body.idDisparo }}"},{"keyName":"userId","condition":"eq","keyValue":"={{ $json.body.userId }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-3296,304],"id":"f5a93f1d-f0b1-4d50-bfc0-dd2e91d546f0","name":"BUSCAR DISPARO3","credentials":{"supabaseApi":{"id":"gSmzosOueGcVRiU6","name":"supabase enviazap"}}},{"parameters":{"aggregate":"aggregateAllItemData","options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[-2896,304],"id":"9ffff694-18d2-4b9c-bb8a-c0d0316d8038","name":"Aggregate12"},{"parameters":{"httpMethod":"POST","path":"buscardetalhesdisparo","responseMode":"lastNode","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-3520,304],"id":"7741fd9d-619b-4a88-9785-d68abefcc7eb","name":"DADOS DETALHE DISPARO","webhookId":"474c4e0c-40db-41a4-96a4-ac4ab7cceae7"},{"parameters":{"assignments":{"assignments":[{"id":"ac41c1f4-5ae9-4908-998e-36d76cc6e4d2","name":"Detalhes Disparo","value":"={{ $('BUSCAR DISPARO3').item.json }}","type":"string"},{"id":"b72cd0e9-aba9-4e37-9ca9-3b4cb0b1a47f","name":"Contatos Disparo","value":"={{ $json.data }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-2720,304],"id":"5d63f7cc-1437-4f4d-b59e-29a6c35ee7e7","name":"RESPOSTA8"},{"parameters":{"httpMethod":"POST","path":"vincular-conexoes-disparo","responseMode":"lastNode","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-3520,496],"id":"2e39d0cb-3c31-4dbd-a430-f353a1027211","name":"VINCULAR CONEXOES","webhookId":"474c4e0c-40db-41a4-96a4-ac4ab7cceae7"},{"parameters":{"operation":"executeQuery","query":"SELECT public.add_connections_disparo(\n  $1::bigint,\n  regexp_split_to_array($2::text, '\\|')::bigint[],  -- <- converte \"10|12\" em {10,12}\n  $3::uuid\n);\n","options":{"queryReplacement":"={{ [ $json.body.idDisparo, $json.body.idConexoes.join('|'), $json.body.userId ] }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-3296,496],"id":"5618f545-5560-49ed-9a1f-5a7b70a63d81","name":"VINCULAR CONEXOES1","credentials":{"postgres":{"id":"M6jmYaJzaltqsIk4","name":"Postgres zappro"}}},{"parameters":{"operation":"update","tableId":"SAAS_Usuarios","filters":{"conditions":[{"keyName":"id","condition":"eq","keyValue":"={{ $json.body.userId }}"}]},"fieldsUi":{"fieldValues":[{"fieldId":"apikey_gpt","fieldValue":"={{ $json.body.apikeyGpt }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-3296,-832],"id":"89d82a0c-2be1-4509-80a8-e738e41abd7f","name":"SALVAR APIKEY","credentials":{"supabaseApi":{"id":"gSmzosOueGcVRiU6","name":"supabase enviazap"}}},{"parameters":{"httpMethod":"POST","path":"salvar-gpt","responseMode":"lastNode","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-3520,-832],"id":"9c84e1ea-1d00-49f4-a994-84d9ae707da3","name":"SALVAR APIKEY1","webhookId":"0d210c58-1258-4a4b-a3ff-c6b5d1e7b9fc"},{"parameters":{"httpMethod":"POST","path":"buscar-gpt","responseMode":"lastNode","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-2960,-768],"id":"850a7c3f-bd7c-4202-ad1d-6d99b04613ee","name":"BUSCAR APIKEY1","webhookId":"0d210c58-1258-4a4b-a3ff-c6b5d1e7b9fc"},{"parameters":{"operation":"getAll","tableId":"SAAS_Usuarios","filters":{"conditions":[{"keyName":"id","condition":"eq","keyValue":"={{ $json.body.userId }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-2736,-768],"id":"c2b36635-e060-47e4-9ed0-6cd44fcb6eae","name":"BUSCAR APIKEY2","credentials":{"supabaseApi":{"id":"gSmzosOueGcVRiU6","name":"supabase enviazap"}}},{"parameters":{"operation":"executeQuery","query":"SELECT public.create_disparo_grupo($1::jsonb) AS disparo_id;\n","options":{"queryReplacement":"={{ JSON.stringify($json) }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[160,-5152],"id":"93816215-646e-4f16-9aa5-3c0bb21bf9be","name":"CRIAR TODOS DISPAROS1","credentials":{"postgres":{"id":"M6jmYaJzaltqsIk4","name":"Postgres zappro"}}},{"parameters":{"fieldToSplitOut":"body.messages","options":{}},"type":"n8n-nodes-base.splitOut","typeVersion":1,"position":[-1408,-5104],"id":"945f06c9-bd6b-4d38-8066-a5923c5e1a97","name":"Split Out6"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"62470e31-d630-4c15-b4ee-6970b69bd52b","leftValue":"={{ $json.media.base64 }}","rightValue":"","operator":{"type":"string","operation":"exists","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-1232,-5152],"id":"fe8ec2de-4f77-4b4b-a3d1-41427e6a1b5e","name":"If4"},{"parameters":{"operation":"set","key":"={{ $json.media.base64.substring(0,25) }}","value":"={{ $json.media }}","expire":true,"ttl":2592000},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-976,-5264],"id":"34d81bec-5ca6-4b46-87e9-8dc0bd8fe305","name":"SALVAR BASE","credentials":{"redis":{"id":"UHcdFvnvoozYhCLm","name":"Redis account"}}},{"parameters":{},"type":"n8n-nodes-base.merge","typeVersion":3.1,"position":[-720,-5152],"id":"dd33d808-79f5-4c1e-b447-ebe94565c719","name":"Merge1"},{"parameters":{"aggregate":"aggregateAllItemData","options":{}},"type":"n8n-nodes-base.aggregate","typeVersion":1,"position":[-272,-5152],"id":"cade4a5c-b733-43b4-a68c-905cc720d97f","name":"Aggregate13"},{"parameters":{"assignments":{"assignments":[{"id":"75534bdf-e8c5-491a-a0ba-f62119b87653","name":"userId","value":"={{ $item(\"0\").$node[\"SALVAR DISPARO GRUPO\"].json[\"body\"][\"userId\"] }}","type":"string"},{"id":"d12b29c1-b726-4140-850e-aa6740c6b774","name":"connections","value":"={{ $item(\"0\").$node[\"SALVAR DISPARO GRUPO\"].json[\"body\"][\"connections\"] }}","type":"array"},{"id":"a30d39d7-e09e-4a96-a6a4-23cf822fb05c","name":"idLista","value":"={{ $item(\"0\").$node[\"SALVAR DISPARO GRUPO\"].json[\"body\"][\"idLista\"] }}","type":"array"},{"id":"6fd45502-4bff-4f97-83bb-627968084297","name":"mensagens","value":"={{ $json.data }}","type":"array"},{"id":"f193cc0e-2ad5-4560-b67c-a75be3278539","name":"settings","value":"={{ $item(\"0\").$node[\"SALVAR DISPARO GRUPO\"].json[\"body\"][\"settings\"] }}","type":"object"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-80,-5152],"id":"cd7674dc-9fae-4f7e-9e70-6b3159e13e52","name":"ORGANIZAR1"},{"parameters":{"assignments":{"assignments":[{"id":"9ddb9586-c233-4089-ae0c-bac3baaf8c9a","name":"text","value":"={{ $json.text }}","type":"string"},{"id":"2e628d31-ebf9-46c8-a711-038c7b2b0574","name":"media.type","value":"={{ $json.media.type }}","type":"string"},{"id":"844e1a95-87f7-44ec-9d8a-cfa03a3911ca","name":"media.filename","value":"={{ $json.media.filename }}","type":"string"},{"id":"f3c7d7a6-7969-477c-8ecf-d24e57d974b8","name":"media.hashredis","value":"={{ $json.media.base64.substring(0,25) }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-496,-5152],"id":"3e428790-41de-4007-b0e2-49a4509d634e","name":"MENSAGEM1"},{"parameters":{"httpMethod":"POST","path":"db56b0fb-cc58-4d51-8755-d7e04ccaa120123","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-1648,-5104],"id":"ec4e13fe-9575-4c6e-bd25-a75e1cf14669","name":"SALVAR DISPARO GRUPO","webhookId":"db56b0fb-cc58-4d51-8755-d7e04ccaa120"},{"parameters":{"httpMethod":"POST","path":"disparar-grupos","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-1648,-4736],"id":"fc28d687-ac25-448a-a7c1-45e79c44fac3","name":"DISPARAR MENSAGEM1","webhookId":"a99059fc-4f49-43c8-a0b4-5789bcd27f9c"},{"parameters":{"amount":"={{ (Math.max(0, (new Date($json.body.dataEnvio) - Date.now()) / 1000)).toFixed(2) }}"},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[-1440,-4736],"id":"a765bddb-b2d0-432a-be23-22f129198b85","name":"ESPERAR HORARIO1","webhookId":"622057a2-8a0b-4c51-a81d-e5c89b99c638"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"a844e9d3-8bcb-4b79-9147-61936c8e1511","leftValue":"={{ $json.media.type }}","rightValue":"image","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"IMAGEM"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"921c72c0-30e7-42d1-8f68-55a41e6c4851","leftValue":"={{ $json.media.type }}","rightValue":"video","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"VIDEO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"04e10201-06a7-4b62-b060-b6dad7d0d613","leftValue":"={{ $json.media.type }}","rightValue":"audio","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"AUDIO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"a19bffbd-7874-497c-a8de-19f52e8aeb65","leftValue":"={{ $json.media.type }}","rightValue":"document","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"DOCUMENTO"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[-656,-4848],"id":"23164a45-7561-4ede-9e5e-d1261aeed27d","name":"ANEXOS"},{"parameters":{"method":"POST","url":"=https://whatsapi.typebot.pro/message/sendText/{{ $item(\"0\").$node[\"DISPARAR MENSAGEM1\"].json[\"body\"][\"InstanceName\"] }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apikey","value":"={{ $item(\"0\").$node[\"DISPARAR MENSAGEM1\"].json[\"body\"][\"ApikeyConexao\"] }}"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"number","value":"={{ $item(\"0\").$node[\"DISPARAR MENSAGEM1\"].json[\"body\"][\"WhatsAppIdGrupo\"] }}"},{"name":"text","value":"={{ $item(\"0\").$node[\"DISPARAR MENSAGEM1\"].json[\"body\"][\"Mensagem\"] }}"},{"name":"mentionsEveryOne","value":"={{ $item(\"0\").$node[\"DISPARAR MENSAGEM1\"].json[\"body\"][\"FakeCall\"] }}"}]},"options":{"redirect":{"redirect":{}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-400,-4512],"id":"6d437e60-8974-4c14-9e07-bd9e6f46d48f","name":"MSG TEXTO","onError":"continueErrorOutput"},{"parameters":{"method":"POST","url":"=https://whatsapi.typebot.pro/message/sendMedia/{{ $item(\"0\").$node[\"DISPARAR MENSAGEM1\"].json[\"body\"][\"InstanceName\"] }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apikey","value":"={{ $item(\"0\").$node[\"DISPARAR MENSAGEM1\"].json[\"body\"][\"ApikeyConexao\"] }}"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"number","value":"={{ $item(\"0\").$node[\"DISPARAR MENSAGEM1\"].json[\"body\"][\"WhatsAppIdGrupo\"] }}"},{"name":"mediatype","value":"={{ $item(\"0\").$node[\"Redis\"].json[\"media\"][\"type\"] }}"},{"name":"caption","value":"={{ $item(\"0\").$node[\"DISPARAR MENSAGEM1\"].json[\"body\"][\"Mensagem\"] }}"},{"name":"media","value":"={{ $item(\"0\").$node[\"Redis\"].json[\"media\"][\"base64\"] }}"},{"name":"fileName","value":"={{ $item(\"0\").$node[\"Redis\"].json[\"media\"][\"filename\"] }}"},{"name":"mentionsEveryOne","value":"={{ $item(\"0\").$node[\"DISPARAR MENSAGEM1\"].json[\"body\"][\"FakeCall\"] }}"}]},"options":{"redirect":{"redirect":{}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-400,-4912],"id":"8c183b69-6a51-4021-a7f6-86a6c9ba8764","name":"MSG TEXTO + MEDIA","retryOnFail":false,"executeOnce":false,"onError":"continueErrorOutput"},{"parameters":{"method":"POST","url":"=https://whatsapi.typebot.pro/message/sendWhatsAppAudio/{{ $item(\"0\").$node[\"DISPARAR MENSAGEM1\"].json[\"body\"][\"InstanceName\"] }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apikey","value":"={{ $item(\"0\").$node[\"DISPARAR MENSAGEM1\"].json[\"body\"][\"ApikeyConexao\"] }}"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"number","value":"={{ $item(\"0\").$node[\"DISPARAR MENSAGEM1\"].json[\"body\"][\"WhatsAppIdGrupo\"] }}"},{"name":"audio","value":"={{ $item(\"0\").$node[\"Redis\"].json[\"media\"][\"base64\"] }}"},{"name":"mentionsEveryOne","value":"={{ $item(\"0\").$node[\"DISPARAR MENSAGEM1\"].json[\"body\"][\"FakeCall\"] }}"}]},"options":{"redirect":{"redirect":{}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-400,-4736],"id":"b5e7af1d-8255-42ba-bd95-f2fd2653ea75","name":"MSG TEXTO + AUDIO","onError":"continueErrorOutput"},{"parameters":{"operation":"get","propertyName":"media","key":"={{ $('DISPARAR MENSAGEM1').item.json.body.KeyRedis }}","options":{}},"type":"n8n-nodes-base.redis","typeVersion":1,"position":[-832,-4736],"id":"193dcfc3-c6d4-47d7-ad2f-92ce4a3742cd","name":"Redis","credentials":{"redis":{"id":"UHcdFvnvoozYhCLm","name":"Redis account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"cb1408fb-482d-4102-8b74-f557843fd424","leftValue":"={{ $('DISPARAR MENSAGEM1').item.json.body.KeyRedis }}","rightValue":"","operator":{"type":"string","operation":"notEmpty","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-1168,-4688],"id":"b9044201-97fb-4b33-bb5d-ae1ccd3f9266","name":"TEM MEDIA?1"},{"parameters":{"operation":"update","tableId":"SAAS_Detalhes_Disparos","filters":{"conditions":[{"keyName":"id","condition":"eq","keyValue":"={{ $item(\"0\").$node[\"DISPARAR MENSAGEM1\"].json[\"body\"][\"id\"] }}"}]},"fieldsUi":{"fieldValues":[{"fieldId":"Status","fieldValue":"=sent"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[496,-4912],"id":"371eee55-72ae-4c6c-afbe-145f0aaef60e","name":"SALVAR DISPARO - SUCESSO1","credentials":{"supabaseApi":{"id":"gSmzosOueGcVRiU6","name":"supabase enviazap"}}},{"parameters":{"operation":"update","tableId":"SAAS_Detalhes_Disparos","filters":{"conditions":[{"keyName":"id","condition":"eq","keyValue":"={{ $item(\"0\").$node[\"DISPARAR MENSAGEM1\"].json[\"body\"][\"id\"] }}"}]},"fieldsUi":{"fieldValues":[{"fieldId":"Status","fieldValue":"=failed"},{"fieldId":"Payload","fieldValue":"={{ $json.error.message }}"},{"fieldId":"mensagemErro","fieldValue":"={{ \n  $json.error.status === 500\n    ? 'Whatsapp desconectado ou bloqueado'\n    : ($json.error.status === 400\n        ? 'Contato inexistente'\n        : ''   // deixe vazio (ou defina outra mensagem) para outros códigos\n      )\n}}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[496,-4672],"id":"d3b65ad8-6c26-4b64-a4a9-22c0a370b767","name":"SALVAR DISPARO - FALHO1","credentials":{"supabaseApi":{"id":"gSmzosOueGcVRiU6","name":"supabase enviazap"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $json.error.status }}","rightValue":504,"operator":{"type":"number","operation":"equals"},"id":"1e4fdcaa-6f5a-48bd-938a-6dfaaf3eb97c"}],"combinator":"and"},"renameOutput":true,"outputKey":"TIMEOUT"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"3ca3b2c3-425d-4905-aa16-87e44c6349fb","leftValue":"={{ $json.error.status }}","rightValue":502,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"FORA DO AR"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"7a013dfa-a8c6-48f7-8e98-4afbc1cbb987","leftValue":"={{ $json.error.status }}","rightValue":400,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"NUMERO NAO EXISTE"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"a82245de-a9cc-4cb3-8c1b-d6785417dc0d","leftValue":"={{ $json.error.status }}","rightValue":500,"operator":{"type":"number","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"DESCONECTADO"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[160,-4624],"id":"8950894c-6c38-40fc-a11c-5106931c0332","name":"Switch1"},{"parameters":{},"type":"n8n-nodes-base.wait","typeVersion":1.1,"position":[496,-4224],"id":"358e5c47-f6c9-4f94-8517-0dc7d7ab3c30","name":"ESPERAR 5 SEG1","webhookId":"be0eabf6-8551-461a-8b5c-bdd9a407c450"},{"parameters":{"operation":"executeQuery","query":"SELECT public.swap_connection($1::bigint, $2::bigint, $3::uuid);","options":{"queryReplacement":"={{ $item(\"0\").$node[\"DISPARAR MENSAGEM1\"].json[\"body\"][\"idDisparo\"] }},{{ $item(\"0\").$node[\"DISPARAR MENSAGEM1\"].json[\"body\"][\"idConexao\"] }},{{ $item(\"0\").$node[\"DISPARAR MENSAGEM1\"].json[\"body\"][\"UserId\"] }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[496,-4448],"id":"70fd324c-a5ba-4dc0-90ab-025424145fa2","name":"CONEXAO DESCONECTADA1","credentials":{"postgres":{"id":"M6jmYaJzaltqsIk4","name":"Postgres zappro"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $json.TipoDisparo }}","rightValue":"Individual","operator":{"type":"string","operation":"equals"},"id":"f8d95b81-af2c-42b9-93f7-759e715cd2cf"}],"combinator":"and"},"renameOutput":true,"outputKey":"Individual"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"1e9be2b3-a5c1-48ed-b625-88428ea791f4","leftValue":"={{ $json.TipoDisparo }}","rightValue":"Grupos","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"Grupos"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[-1056,-5792],"id":"fe055640-911b-4f9f-a4b8-978f45ee3b8b","name":"Switch2"},{"parameters":{"method":"POST","url":"https://n8n.typebot.pro/webhook/disparar","sendBody":true,"specifyBody":"json","jsonBody":"={{ $json }}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-752,-5856],"id":"69e4ac78-52e7-4e9b-8de5-b9b2cd54ec63","name":"DISPARAR INDIVIDUAL"},{"parameters":{"method":"POST","url":"https://n8n.typebot.pro/webhook/disparar-grupos","sendBody":true,"specifyBody":"json","jsonBody":"={{ $json }}","options":{}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-752,-5664],"id":"fa669cf4-565d-43e4-ac22-22d6c74f3cb7","name":"DISPARAR GRUPOS"},{"parameters":{"operation":"executeQuery","query":"SELECT *\nFROM   public.get_contatos_by_lista($1::bigint);\n","options":{"queryReplacement":"={{ $json.body.idLista }}"}},"type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[-3296,-3664],"id":"213f350b-0d26-4d7c-9fd9-8b5383b411be","name":"PUXAR CONTATOS2","credentials":{"postgres":{"id":"M6jmYaJzaltqsIk4","name":"Postgres zappro"}}},{"parameters":{"assignments":{"assignments":[{"id":"e5defa12-b9f6-49b3-add9-49edf60fcfea","name":"erro","value":"={{ $json }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-2848,-912],"id":"dc6e1f8e-ec19-4e0a-a0d5-0274c09d4cd9","name":"ERRO"},{"parameters":{"method":"POST","url":"=https://whatsapi.typebot.pro/call/offer/{{ $item(\"0\").$node[\"DISPARAR MENSAGEM\"].json[\"body\"][\"InstanceName\"] }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apikey","value":"={{ $item(\"0\").$node[\"DISPARAR MENSAGEM\"].json[\"body\"][\"ApikeyConexao\"] }}"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n    \"number\": \"{{ $item(\"0\").$node[\"DISPARAR MENSAGEM\"].json[\"body\"][\"TelefoneContato\"] }}\",\n    \"isVideo\": false,\n    \"callDuration\": 7\n}","options":{"redirect":{"redirect":{}}}},"type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[-1632,-6528],"id":"fa598072-3a9c-48ad-a287-583a2dd511cf","name":"FAKE CALL","onError":"continueRegularOutput"}],"connections":{"HTML":{"main":[[{"node":"Respond to Webhook1","type":"main","index":0}]]},"Webhook":{"main":[[{"node":"HTML1","type":"main","index":0}]]},"HTML1":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]},"CRIAR CONEXAO":{"main":[[{"node":"HTML","type":"main","index":0}]]},"VERIFICAR LOGIN":{"main":[[{"node":"LOCALIZAR EMAIL","type":"main","index":0}]]},"LOGIN":{"main":[[{"node":"HTML2","type":"main","index":0}]]},"HTML2":{"main":[[{"node":"Respond to Webhook2","type":"main","index":0}]]},"LOCALIZAR EMAIL":{"main":[[{"node":"If","type":"main","index":0}]]},"If":{"main":[[{"node":"If1","type":"main","index":0}],[{"node":"NEGADO","type":"main","index":0}]]},"CRIAR INSTANCIA":{"main":[[{"node":"CRIAR CONEXAO1","type":"main","index":0}]]},"CRIAR CONEXAO1":{"main":[[{"node":"RESPOSTA","type":"main","index":0}]]},"Webhook3":{"main":[[{"node":"BUSCAR CONEXAO","type":"main","index":0}]]},"BUSCAR FOTO PERFIL":{"main":[[{"node":"SALVAR FOTO","type":"main","index":0}]]},"BUSCAR CONEXAO":{"main":[[{"node":"BUSCAR FOTO PERFIL","type":"main","index":0}]]},"SALVAR FOTO":{"main":[[{"node":"RESPOSTA1","type":"main","index":0}]]},"Webhook4":{"main":[[{"node":"BUSCAR CONEXAO1","type":"main","index":0}]]},"BUSCAR CONEXAO1":{"main":[[{"node":"Aggregate","type":"main","index":0}]]},"Aggregate":{"main":[[{"node":"RESPOSTA2","type":"main","index":0}]]},"LOGIN1":{"main":[[{"node":"HTML4","type":"main","index":0}]]},"HTML4":{"main":[[{"node":"Respond to Webhook3","type":"main","index":0}]]},"HTML5":{"main":[[{"node":"Respond to Webhook4","type":"main","index":0}]]},"DISPAROS GRUPOS":{"main":[[{"node":"HTML5","type":"main","index":0}]]},"Webhook5":{"main":[[{"node":"LISTAR GRUPO","type":"main","index":0}]]},"LISTAR GRUPO":{"main":[[{"node":"RESPOSTA3","type":"main","index":0}]]},"Webhook7":{"main":[[{"node":"BUSCAR DISPAROS","type":"main","index":0}]]},"Aggregate1":{"main":[[{"node":"RESPOSTA5","type":"main","index":0}]]},"BUSCAR DISPAROS":{"main":[[{"node":"Aggregate1","type":"main","index":0}]]},"HTML6":{"main":[[{"node":"Respond to Webhook5","type":"main","index":0}]]},"HISTORICO DISPAROS":{"main":[[{"node":"HTML6","type":"main","index":0}]]},"HTML7":{"main":[[{"node":"Respond to Webhook6","type":"main","index":0}]]},"DASHBOARD":{"main":[[{"node":"HTML7","type":"main","index":0}]]},"Webhook9":{"main":[[{"node":"BUSCAR DISPAROS2","type":"main","index":0}]]},"BUSCAR DISPAROS2":{"main":[[{"node":"Aggregate2","type":"main","index":0}]]},"Aggregate2":{"main":[[{"node":"BUSCAR CONEXOES","type":"main","index":0}]]},"BUSCAR CONEXOES":{"main":[[{"node":"Aggregate3","type":"main","index":0}]]},"Aggregate3":{"main":[[{"node":"RESPOSTA6","type":"main","index":0}]]},"CRIAR CONEXAO2":{"main":[[{"node":"CRIAR INSTANCIA","type":"main","index":0}]]},"APAGAR CONEXAO":{"main":[[{"node":"DESLOGAR INSTANCIA","type":"main","index":0}]]},"DELETAR INSTANCIA":{"main":[[{"node":"DELETAR CONEXAO","type":"main","index":0}]]},"DESLOGAR INSTANCIA":{"main":[[{"node":"DELETAR INSTANCIA","type":"main","index":0}]]},"DELETAR CONEXAO":{"main":[[{"node":"RESPOSTA7","type":"main","index":0}]]},"If1":{"main":[[{"node":"LIBERADO","type":"main","index":0}],[{"node":"BLOQUEADO","type":"main","index":0}]]},"CRIAR LISTA2":{"main":[[{"node":"CRIAR LISTA","type":"main","index":0}]]},"PUXAR LISTAS":{"main":[[{"node":"PUXAR LISTAS1","type":"main","index":0}]]},"PUXAR LISTAS1":{"main":[[{"node":"Aggregate4","type":"main","index":0}]]},"EXCLUIR LISTA":{"main":[[{"node":"EXCLUIR LISTA1","type":"main","index":0}]]},"CRIAR CONTATOS":{"main":[[{"node":"Split Out","type":"main","index":0}]]},"CRIAR VARIAVEIS":{"main":[[{"node":"CRIAR VARIAVEIS1","type":"main","index":0}]]},"PUXAR CONTATOS1":{"main":[[{"node":"PUXAR CONTATOS2","type":"main","index":0}]]},"PUXAR VARIAVEIS":{"main":[[{"node":"PUXAR VARIAVEIS1","type":"main","index":0}]]},"PUXAR VARIAVEIS1":{"main":[[{"node":"Aggregate6","type":"main","index":0}]]},"Split Out":{"main":[[{"node":"CRIAR CONTATOS1","type":"main","index":0}]]},"HTML8":{"main":[[{"node":"Respond to Webhook7","type":"main","index":0}]]},"LISTAS":{"main":[[{"node":"HTML8","type":"main","index":0}]]},"HTML9":{"main":[[{"node":"Respond to Webhook8","type":"main","index":0}]]},"LISTAS1":{"main":[[{"node":"HTML9","type":"main","index":0}]]},"EXCLUIR CONTATO":{"main":[[{"node":"EXCLUIR CONTATO1","type":"main","index":0}]]},"LISTAR GRUPO3":{"main":[[{"node":"Aggregate8","type":"main","index":0}]]},"LISTAR GRUPOS":{"main":[[{"node":"LISTAR GRUPO3","type":"main","index":0}]]},"PUXAR GRUPOS":{"main":[[{"node":"PUXAR GRUPOS1","type":"main","index":0}]]},"Split Out3":{"main":[[{"node":"SALVAR GRUPOS1","type":"main","index":0}]]},"SALVAR GRUPOS":{"main":[[{"node":"Split Out3","type":"main","index":0}]]},"SALVAR GRUPOS1":{"main":[[{"node":"Aggregate10","type":"main","index":0}]]},"LISTAR GRUPO4":{"main":[[{"node":"Split Out4","type":"main","index":0}]]},"CONTAR PARTICIPANTES":{"main":[[{"node":"PUXAR CONEXAO","type":"main","index":0}]]},"Split Out4":{"main":[[{"node":"Summarize","type":"main","index":0}]]},"Summarize":{"main":[[{"node":"SALVAR CONTAGEM","type":"main","index":0}]]},"PUXAR CONEXAO":{"main":[[{"node":"LISTAR GRUPO4","type":"main","index":0}]]},"VINCULAR CONEXAO":{"main":[[{"node":"VINCULAR CONEXAO LISTA","type":"main","index":0}]]},"PUXAR LISTAS2":{"main":[[{"node":"PUXAR LISTAS3","type":"main","index":0}]]},"PUXAR LISTAS3":{"main":[[{"node":"If2","type":"main","index":0}]]},"If2":{"main":[[{"node":"PUXAR CONEXAO1","type":"main","index":0}],[{"node":"Edit Fields","type":"main","index":0}]]},"PUXAR CONEXAO2":{"main":[[{"node":"LISTAR GRUPO5","type":"main","index":0}]]},"EXPORTAR PARTICIPANTES":{"main":[[{"node":"PUXAR CONEXAO2","type":"main","index":0}]]},"EXCLUIR GRUPO":{"main":[[{"node":"EXCLUIR GRUPO1","type":"main","index":0}]]},"HTML10":{"main":[[{"node":"Respond to Webhook9","type":"main","index":0}]]},"LISTAS2":{"main":[[{"node":"HTML10","type":"main","index":0}]]},"BUSCAR APIKEY":{"main":[[{"node":"GERAR MENSAGENS","type":"main","index":0}]]},"GERAR MENSAGENS":{"main":[[{"node":"RESPOSTA4","type":"main","index":0}],[{"node":"ERRO","type":"main","index":0}]]},"GERAR MENSAGEM IA":{"main":[[{"node":"BUSCAR APIKEY","type":"main","index":0}]]},"PUXAR CONTATOS4":{"main":[[{"node":"PUXAR CONTATOS3","type":"main","index":0}]]},"PUXAR CONTATOS3":{"main":[[{"node":"Aggregate7","type":"main","index":0}]]},"PUXAR GRUPOS1":{"main":[[{"node":"Aggregate9","type":"main","index":0}]]},"PUXAR DISPAROS MINUTO":{"main":[[{"node":"Switch2","type":"main","index":0}]]},"DISPARAR MENSAGEM":{"main":[[{"node":"ESPERAR HORARIO","type":"main","index":0}]]},"ANEXOS2":{"main":[[{"node":"MSG TEXTO + MEDIA2","type":"main","index":0}],[{"node":"MSG TEXTO + MEDIA2","type":"main","index":0}],[{"node":"MSG TEXTO + AUDIO2","type":"main","index":0}],[{"node":"MSG TEXTO + MEDIA2","type":"main","index":0}]]},"MSG TEXTO2":{"main":[[{"node":"SALVAR DISPARO - SUCESSO","type":"main","index":0}],[{"node":"Switch","type":"main","index":0}]]},"MSG TEXTO + MEDIA2":{"main":[[{"node":"SALVAR DISPARO - SUCESSO","type":"main","index":0}],[{"node":"Switch","type":"main","index":0}]]},"MSG TEXTO + AUDIO2":{"main":[[{"node":"SALVAR DISPARO - SUCESSO","type":"main","index":0}],[{"node":"Switch","type":"main","index":0}]]},"ESPERAR HORARIO":{"main":[[{"node":"TEM MEDIA?","type":"main","index":0}]]},"Split Out5":{"main":[[{"node":"If3","type":"main","index":0}]]},"If3":{"main":[[{"node":"SALVAR BASE64","type":"main","index":0}],[{"node":"Merge","type":"main","index":1}]]},"SALVAR BASE64":{"main":[[{"node":"Merge","type":"main","index":0}]]},"Merge":{"main":[[{"node":"MENSAGEM","type":"main","index":0}]]},"Aggregate11":{"main":[[{"node":"ORGANIZAR","type":"main","index":0}]]},"ORGANIZAR":{"main":[[{"node":"CRIAR TODOS DISPAROS","type":"main","index":0}]]},"MENSAGEM":{"main":[[{"node":"Aggregate11","type":"main","index":0}]]},"Redis1":{"main":[[{"node":"ANEXOS2","type":"main","index":0}]]},"TEM MEDIA?":{"main":[[{"node":"Redis1","type":"main","index":0}],[{"node":"MSG TEXTO2","type":"main","index":0}]]},"Switch":{"main":[[{"node":"ESPERAR 5 SEG","type":"main","index":0}],[{"node":"ESPERAR 5 SEG","type":"main","index":0}],[{"node":"SALVAR DISPARO - FALHO","type":"main","index":0}],[{"node":"CONEXAO DESCONECTADA","type":"main","index":0}]]},"ESPERAR 5 SEG":{"main":[[{"node":"ANEXOS2","type":"main","index":0}]]},"SALVAR DISPAROS":{"main":[[{"node":"Split Out5","type":"main","index":0}]]},"PROCURAR DISPAROS":{"main":[[{"node":"PUXAR DISPAROS MINUTO","type":"main","index":0}]]},"HTML11":{"main":[[{"node":"Respond to Webhook10","type":"main","index":0}]]},"DETALHES DISPARO":{"main":[[{"node":"HTML11","type":"main","index":0}]]},"PAUSAR DISPARO":{"main":[[{"node":"PAUSAR","type":"main","index":0}]]},"EXCLUIR DISPARO":{"main":[[{"node":"EXCLUIR","type":"main","index":0}]]},"RETOMAR DISPARO":{"main":[[{"node":"RETOMAR","type":"main","index":0}]]},"BUSCAR DISPARO":{"main":[[{"node":"Aggregate12","type":"main","index":0}]]},"BUSCAR DISPARO3":{"main":[[{"node":"BUSCAR DISPARO","type":"main","index":0}]]},"Aggregate12":{"main":[[{"node":"RESPOSTA8","type":"main","index":0}]]},"DADOS DETALHE DISPARO":{"main":[[{"node":"BUSCAR DISPARO3","type":"main","index":0}]]},"VINCULAR CONEXOES":{"main":[[{"node":"VINCULAR CONEXOES1","type":"main","index":0}]]},"SALVAR APIKEY1":{"main":[[{"node":"SALVAR APIKEY","type":"main","index":0}]]},"BUSCAR APIKEY1":{"main":[[{"node":"BUSCAR APIKEY2","type":"main","index":0}]]},"Split Out6":{"main":[[{"node":"If4","type":"main","index":0}]]},"If4":{"main":[[{"node":"SALVAR BASE","type":"main","index":0}],[{"node":"Merge1","type":"main","index":1}]]},"SALVAR BASE":{"main":[[{"node":"Merge1","type":"main","index":0}]]},"Merge1":{"main":[[{"node":"MENSAGEM1","type":"main","index":0}]]},"Aggregate13":{"main":[[{"node":"ORGANIZAR1","type":"main","index":0}]]},"ORGANIZAR1":{"main":[[{"node":"CRIAR TODOS DISPAROS1","type":"main","index":0}]]},"MENSAGEM1":{"main":[[{"node":"Aggregate13","type":"main","index":0}]]},"SALVAR DISPARO GRUPO":{"main":[[{"node":"Split Out6","type":"main","index":0}]]},"DISPARAR MENSAGEM1":{"main":[[{"node":"ESPERAR HORARIO1","type":"main","index":0}]]},"ESPERAR HORARIO1":{"main":[[{"node":"TEM MEDIA?1","type":"main","index":0}]]},"ANEXOS":{"main":[[{"node":"MSG TEXTO + MEDIA","type":"main","index":0}],[{"node":"MSG TEXTO + MEDIA","type":"main","index":0}],[{"node":"MSG TEXTO + AUDIO","type":"main","index":0}],[{"node":"MSG TEXTO + MEDIA","type":"main","index":0}]]},"MSG TEXTO":{"main":[[{"node":"SALVAR DISPARO - SUCESSO1","type":"main","index":0}],[{"node":"Switch1","type":"main","index":0}]]},"MSG TEXTO + MEDIA":{"main":[[{"node":"SALVAR DISPARO - SUCESSO1","type":"main","index":0}],[{"node":"Switch1","type":"main","index":0}]]},"MSG TEXTO + AUDIO":{"main":[[{"node":"SALVAR DISPARO - SUCESSO1","type":"main","index":0}],[{"node":"Switch1","type":"main","index":0}]]},"Redis":{"main":[[{"node":"ANEXOS","type":"main","index":0}]]},"TEM MEDIA?1":{"main":[[{"node":"Redis","type":"main","index":0}],[{"node":"MSG TEXTO","type":"main","index":0}]]},"Switch1":{"main":[[{"node":"ESPERAR 5 SEG1","type":"main","index":0}],[{"node":"ESPERAR 5 SEG1","type":"main","index":0}],[{"node":"SALVAR DISPARO - FALHO1","type":"main","index":0}],[{"node":"CONEXAO DESCONECTADA1","type":"main","index":0}]]},"ESPERAR 5 SEG1":{"main":[[{"node":"ANEXOS","type":"main","index":0}]]},"Switch2":{"main":[[{"node":"DISPARAR INDIVIDUAL","type":"main","index":0}],[{"node":"DISPARAR GRUPOS","type":"main","index":0}]]},"PUXAR CONTATOS2":{"main":[[{"node":"Aggregate5","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":{"node:PROCURAR DISPAROS":{"recurrenceRules":[]}},"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"5093da95-9442-4006-95dd-d66066e92874","triggerCount":49,"shared":[{"createdAt":"2025-09-01T14:27:59.787Z","updatedAt":"2025-09-01T14:27:59.787Z","role":"workflow:owner","workflowId":"XtB82qQyuXJqEADf","projectId":"86fLtGJ4RKYxddia"}],"tags":[]}