{"createdAt":"2025-06-12T03:12:02.965Z","updatedAt":"2025-07-21T14:00:57.797Z","id":"grH7fMnfxziLjdtJ","name":"[SANTOBET] - RANK DE AFILIADOS","active":false,"isArchived":false,"nodes":[{"parameters":{},"type":"n8n-nodes-base.manualTrigger","typeVersion":1,"position":[-800,-260],"id":"bce3dd00-3032-46f3-8764-25ee817f1b2a","name":"When clicking ‘Test workflow’"},{"parameters":{"documentId":{"__rl":true,"value":"1gkiZcv4TIQVnSZTyGz6kzO3T-sACsUeDgGMXvOInhME","mode":"list","cachedResultName":"SANTOBET - WEBHOOK","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1gkiZcv4TIQVnSZTyGz6kzO3T-sACsUeDgGMXvOInhME/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"JOGADOR","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1gkiZcv4TIQVnSZTyGz6kzO3T-sACsUeDgGMXvOInhME/edit#gid=0"},"filtersUI":{"values":[{"lookupColumn":"DATA","lookupValue":"={{ new Date().toLocaleDateString('pt-BR').split('/').join('-') }}"}]},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.5,"position":[-340,-260],"id":"ae94357c-791b-4900-aaa0-908338dfce05","name":"Google Sheets","credentials":{"googleSheetsOAuth2Api":{"id":"9W9MbbOmOV6F5Huv","name":"N8N - SHEET"}}},{"parameters":{"assignments":{"assignments":[{"id":"5731bcd8-a644-4489-9dee-5e1bb899a90d","name":"invite","value":"={{ $json['INDICADO POR'].split('@')[0] }}","type":"string"},{"id":"d47488fd-9bb4-4ac2-8d8e-fbd6fc7f44e0","name":"data","value":"={{ new Date().toLocaleDateString('pt-BR').split('/').join('-') }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-80,-260],"id":"5aaaaa33-bd53-4cf5-8b24-6008c4b81028","name":"Edit Fields"},{"parameters":{"jsCode":"// Agrupa por e-mail da coluna 'invite' e conta quantas vezes aparece\nconst contagem = {};\n\nfor (const item of items) {\n  let email = item.json.invite;\n\n  if (!email || email.trim() === '') {\n    email = 'Oculto';\n  }\n\n  if (contagem[email]) {\n    contagem[email]++;\n  } else {\n    contagem[email] = 1;\n  }\n}\n\n// Converte para array, ordena e monta mensagem de ranking\nconst medalhas = ['🥇', '🥈', '🥉'];\n\nconst ranking = Object.entries(contagem)\n  .map(([email, total]) => ({ email, total }))\n  .sort((a, b) => b.total - a.total)\n  .map((entry, index) => {\n    const posicao = index < 3 ? medalhas[index] : `${index + 1}º`;\n    return `${posicao} ${entry.email} — ${entry.total} cadastros`;\n  })\n  .join('\\n');\n\n// Retorna uma única saída com a mensagem pronta\nreturn [\n  {\n    json: {\n      mensagem: ranking\n    }\n  }\n];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[140,-260],"id":"0e690dc0-24e8-4bc7-b266-fec4e47643f4","name":"Code"},{"parameters":{"method":"POST","url":"=https://whatsapi.typebot.pro/message/sendText/BOSS","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apikey","value":"=b4d71f9c38e3ac12a6b08e4b6d53aa90"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"number","value":"120363382224860301@g.us"},{"name":"text","value":"=📊 RELATÓRIO REGISTROS DIÁRIOS\n📊 Filtro: CADASTROS JOGADOR POR AFILIADO\n📅 DATA: {{ new Date().toLocaleDateString('pt-BR').split('/').join('-') }}\n\n{{ $json.mensagem }}\n"}]},"options":{}},"id":"42a2797d-3e85-446a-88d5-7d05cbc6c02f","name":"ENVIO RELATORIO GRUPO1","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[380,-260],"alwaysOutputData":false},{"parameters":{"jsCode":"// Agrupa por e-mail da coluna 'invite' e conta quantas vezes aparece\nconst contagem = {};\n\nfor (const item of items) {\n  let email = item.json.invite;\n\n  if (!email || email.trim() === '') {\n    email = 'CADASTROS DA CASA';\n  }\n\n  if (contagem[email]) {\n    contagem[email]++;\n  } else {\n    contagem[email] = 1;\n  }\n}\n\n// Converte para array, ordena e adiciona ranking com emojis\nconst medalhas = ['🥇', '🥈', '🥉'];\n\nconst resultado = Object.entries(contagem)\n  .map(([email, total]) => ({ email, total }))\n  .sort((a, b) => b.total - a.total)\n  .map((entry, index) => {\n    const posicao = index < 3 ? medalhas[index] : `${index + 1}`;\n    return {\n      json: {\n        posicao,\n        email: entry.email,\n        total: entry.total\n      }\n    };\n  });\n\nreturn resultado;\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[120,-560],"id":"1cccf6da-7176-4a5e-8353-d935a4d3677a","name":"RANK INTENS SEPARADO"},{"parameters":{"jsCode":"const hoje = new Date();\nconst dataFormatada = hoje.toLocaleDateString('pt-BR').split('/').reverse().join('-'); // \"2025-06-12\"\n\nconst [ano, mes, dia] = dataFormatada.split('-');\nconst final = `${dia}-${mes}-${ano}`; // \"12-06-2025\"\n\nreturn [\n  {\n    json: {\n      hoje: final\n    }\n  }\n];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-580,-260],"id":"81e47d2d-beac-438e-b8de-87b7a340b829","name":"Code1"},{"parameters":{"documentId":{"__rl":true,"value":"1gkiZcv4TIQVnSZTyGz6kzO3T-sACsUeDgGMXvOInhME","mode":"list","cachedResultName":"SANTOBET - WEBHOOK","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1gkiZcv4TIQVnSZTyGz6kzO3T-sACsUeDgGMXvOInhME/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":"gid=0","mode":"list","cachedResultName":"JOGADOR","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1gkiZcv4TIQVnSZTyGz6kzO3T-sACsUeDgGMXvOInhME/edit#gid=0"},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.5,"position":[-960,0],"id":"ac389069-8a43-4fd1-a474-d99540a79a1a","name":"Google Sheets1","credentials":{"googleSheetsOAuth2Api":{"id":"9W9MbbOmOV6F5Huv","name":"N8N - SHEET"}}},{"parameters":{"assignments":{"assignments":[{"id":"5731bcd8-a644-4489-9dee-5e1bb899a90d","name":"invite","value":"={{ $json['INDICADO POR'].split('@')[0] }}","type":"string"},{"id":"d47488fd-9bb4-4ac2-8d8e-fbd6fc7f44e0","name":"data","value":"={{ new Date().toLocaleDateString('pt-BR').split('/').join('-') }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-80,160],"id":"b4b120eb-2434-47a9-8b75-31306d920bc5","name":"Edit Fields1"},{"parameters":{"jsCode":"const contagem = {};\nconst ocultos = [];\n\nfor (const item of items) {\n  let email = item.json.invite;\n\n  if (!email || email.trim() === '') {\n    ocultos.push(item.json.row_number); // salva a linha onde o invite está vazio\n    email = 'op.001.suporte';\n  }\n\n  if (contagem[email]) {\n    contagem[email]++;\n  } else {\n    contagem[email] = 1;\n  }\n}\n\nconst medalhas = ['🥇', '🥈', '🥉'];\n\nconst ranking = Object.entries(contagem)\n  .map(([email, total]) => ({ email, total }))\n  .sort((a, b) => b.total - a.total)\n  .slice(0, 10)\n  .map((entry, index) => {\n    const posicao = index < 3 ? medalhas[index] : `${index + 1}º`;\n    return `${posicao} ${entry.email} — ${entry.total} cadastros`;\n  })\n  .join('\\n');\n\nreturn [\n  {\n    json: {\n      mensagem: ranking,\n      ocultos: ocultos.length > 0 ? `Ocultos nas linhas: ${ocultos.join(', ')}` : 'Nenhum oculto'\n    }\n  }\n];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[160,160],"id":"2ea47dd2-0881-447c-8873-42772234c6bc","name":"Code2"},{"parameters":{"method":"POST","url":"=https://whatsapi.typebot.pro/message/sendText/BOSS","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apikey","value":"=b4d71f9c38e3ac12a6b08e4b6d53aa90"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"number","value":"120363382224860301@g.us"},{"name":"text","value":"=📊 RANK GERAL {{ [\"JANEIRO\", \"FEVEREIRO\", \"MARÇO\", \"ABRIL\", \"MAIO\", \"JUNHO\", \"JULHO\", \"AGOSTO\", \"SETEMBRO\", \"OUTUBRO\", \"NOVEMBRO\", \"DEZEMBRO\"][new Date().getMonth()] + '/' + new Date().getFullYear() }}\n📊 Filtro: CADASTROS JOGADOR POR AFILIADO\n📅 DATA: {{ (new Date()).getDate() >= 1 ? '01/' + ('0' + (new Date().getMonth() + 1)).slice(-2) + '/' + new Date().getFullYear() : '' }} a {{ ('0' + new Date().getDate()).slice(-2) + '/' + ('0' + (new Date().getMonth() + 1)).slice(-2) + '/' + new Date().getFullYear() }}\n\n\n{{ $json.mensagem }}\n"}]},"options":{}},"id":"10b17861-2a0d-4969-817f-c2fdd03a2c73","name":"ENVIO RELATORIO GRUPO","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[400,160],"alwaysOutputData":false},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"ec0bd2bc-cbf1-4ff8-83f4-8da209d907a0","leftValue":"={{ $json['INDICADO POR'] }}","rightValue":"facebook@santobet.com","operator":{"type":"string","operation":"notEquals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.filter","typeVersion":2.2,"position":[-540,0],"id":"b77ebff6-ddb8-4f02-a150-27338707fb63","name":"remove-facebook"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"8eceed11-0ce1-42aa-a199-9100f35415f4","leftValue":"={{ $json['INDICADO POR'] }}","rightValue":"calijorne.analamego@hotmail.com","operator":{"type":"string","operation":"notEquals"}},{"id":"3663676c-54a9-461a-a48a-a94a8fa0694b","leftValue":"={{ $json['INDICADO POR'] }}","rightValue":"lucassmorais1@hotmail.com","operator":{"type":"string","operation":"notEquals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.filter","typeVersion":2.2,"position":[-740,0],"id":"e5d39a40-f1d3-401f-9780-71639cf0f8cb","name":"remove-ana-lucas"},{"parameters":{"jsCode":"const dataCorte = new Date(2025, 6, 1); // 01-07-2025 (mês é 0-based) janeiro = 0, fev = 1...\n\nreturn items.filter(item => {\n  const dataTexto = item.json.DATA; // exemplo: \"26-11-2024\"\n  if (!dataTexto) return false;\n\n  const [dia, mes, ano] = dataTexto.split('-').map(v => parseInt(v, 10));\n  const dataAtual = new Date(ano, mes - 1, dia);\n\n  return dataAtual >= dataCorte;\n});\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-320,160],"id":"5f4d3f85-8e70-4977-8172-7fb3ac915f51","name":"filtra-data"}],"connections":{"When clicking ‘Test workflow’":{"main":[[{"node":"Code1","type":"main","index":0}]]},"Google Sheets":{"main":[[{"node":"Edit Fields","type":"main","index":0}]]},"Edit Fields":{"main":[[{"node":"Code","type":"main","index":0}]]},"Code":{"main":[[{"node":"ENVIO RELATORIO GRUPO1","type":"main","index":0}]]},"Code1":{"main":[[{"node":"Google Sheets","type":"main","index":0}]]},"Google Sheets1":{"main":[[{"node":"remove-ana-lucas","type":"main","index":0}]]},"Edit Fields1":{"main":[[{"node":"Code2","type":"main","index":0}]]},"Code2":{"main":[[{"node":"ENVIO RELATORIO GRUPO","type":"main","index":0}]]},"remove-facebook":{"main":[[{"node":"filtra-data","type":"main","index":0}]]},"remove-ana-lucas":{"main":[[{"node":"remove-facebook","type":"main","index":0}]]},"filtra-data":{"main":[[{"node":"Edit Fields1","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"c730de6a-f6dd-4dd3-9363-a9c120c9bf03","triggerCount":0,"tags":[]}