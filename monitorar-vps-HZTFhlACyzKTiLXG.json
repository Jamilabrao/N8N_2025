{"createdAt":"2025-01-09T20:00:21.054Z","updatedAt":"2025-01-09T20:01:07.759Z","id":"HZTFhlACyzKTiLXG","name":"MONITORAR VPS","active":false,"nodes":[{"parameters":{"rule":{"interval":[{"field":"hours"}]}},"id":"eccb5338-3bb9-4306-a6da-2c9059d8d63a","name":"Schedule Trigger","type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[1500,880]},{"parameters":{"command":"docker system prune -a --force"},"id":"cb69c17f-7b1c-41ac-b853-05aed8591061","name":"docker system prune -a","type":"n8n-nodes-base.ssh","typeVersion":1,"position":[1880,560]},{"parameters":{"command":"echo \"CPU: $(top -bn1 | grep 'Cpu(s)' | sed 's/.*, *\\([0-9.]*\\)%* id.*/\\1/' | awk '{print 100 - $1\"%\"}'), MEMÓRIA: $(free -m | awk '/Mem:/ { printf(\"%.2f%\"), $3/$2 * 100 }'), HD: $(df -h / | awk 'NR==2 {print $5}')\""},"id":"abdd21dc-8636-4677-9b8b-37bd4f459115","name":"puxa os dados da vps","type":"n8n-nodes-base.ssh","typeVersion":1,"position":[1680,880]},{"parameters":{"jsCode":"// Captura o valor de stdout do node anterior\nconst sshOutput = $json[\"stdout\"];\n\n// Extrair as porcentagens de CPU, Memória e HD usando regex\nconst cpuUsageMatch = sshOutput.match(/CPU: (\\d+(\\.\\d+)?)/);\nconst memoryUsageMatch = sshOutput.match(/MEMÓRIA: (\\d+(\\.\\d+)?)/);\nconst hdUsageMatch = sshOutput.match(/HD: (\\d+(\\.\\d+)?)/);\n\nif (cpuUsageMatch && memoryUsageMatch && hdUsageMatch) {\n    const cpu = parseFloat(cpuUsageMatch[1]);\n    const memoria = parseFloat(memoryUsageMatch[1]);\n    const hd = parseFloat(hdUsageMatch[1]);\n\n    // Retornar as porcentagens como um JSON com os itens separados\n    return {\n        cpu,\n        memoria,\n        hd\n    };\n} else {\n    throw new Error(\"Erro: Não foi possível extrair os valores de CPU, Memória e HD\");\n}"},"id":"8a9f2d80-ae2e-46b3-a040-4f10bd3f2b31","name":"Code","type":"n8n-nodes-base.code","typeVersion":2,"position":[1860,880]},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"7e75fe56-99c8-4e8a-a9b4-ddeb77017bb5","leftValue":"={{ $item(\"0\").$node[\"Code\"].json[\"cpu\"] }}","rightValue":80,"operator":{"type":"number","operation":"gte"}},{"id":"daacb5d3-2569-43e5-afc3-ab5a78e4980e","leftValue":"={{ $item(\"0\").$node[\"Code\"].json[\"memoria\"] }}","rightValue":80,"operator":{"type":"number","operation":"gte"}},{"id":"0b83b92e-1fee-455f-ba51-da4f8ac50ef7","leftValue":"={{ $item(\"0\").$node[\"Code\"].json[\"hd\"] }}","rightValue":80,"operator":{"type":"number","operation":"gte"}}],"combinator":"or"},"looseTypeValidation":true,"options":{}},"id":"4950c9fe-f6d7-4195-afb2-f2eeabb9b018","name":"If","type":"n8n-nodes-base.if","typeVersion":2.2,"position":[2040,880]},{"parameters":{"method":"POST","url":"https://api.magoautomacoes.com.br/message/sendText/mago","sendHeaders":true,"headerParameters":{"parameters":[{"name":"apikey","value":"677AB2E5CD29-44C6-80A5-D314498D77C2"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"number","value":"5515988243941"},{"name":"text","value":"=ALERTA VPS:\n\nCpu: {{ $item(\"0\").$node[\"If\"].json[\"cpu\"] }}%\n\nMemória: {{ $item(\"0\").$node[\"If\"].json[\"memoria\"] }}%\n\nHD: {{ $item(\"0\").$node[\"If\"].json[\"hd\"] }}%"}]},"options":{"redirect":{"redirect":{}}}},"id":"b9fb526a-6371-42fa-89df-002a033f84ff","name":"evolution envia msg","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[2300,860]},{"parameters":{"rule":{"interval":[{"field":"weeks"}]}},"id":"25e0a33d-0c3f-4408-b31c-4d8d997d2164","name":"Schedule Trigger1","type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[1480,560]},{"parameters":{"content":"##  Este workflow está configurado para monitorar o uso de CPU, memória e HD de uma VPS e enviar uma mensagem de alerta caso algum desses valores exceda um limite especificado (CPU e memória acima de 60% e HD acima de 80%).\n\n\n\n1. Trigger de Agendamento (Schedule Trigger)\nConfigurado para acionar em intervalos de horas. Verifique se o intervalo está configurado conforme desejado para evitar execuções frequentes desnecessárias.\n2. Comando para Limpeza de Sistema Docker\nEste node SSH executa o comando docker system prune -a --force, que limpa todos os containers, imagens e volumes não utilizados. Este comando é potencialmente destrutivo, pois remove todas as imagens e volumes que não estão em uso. Certifique-se de que deseja essa ação periódica.\n3. Comando para Coletar Dados do Sistema\nEste node SSH coleta dados de CPU, memória e HD e retorna a saída no formato:\nyaml\nCopiar código\nCPU: XX%, MEMÓRIA: XX%, HD: XX%\nEssa estrutura será usada pelo próximo node para extração de valores.\n4. Node de Código (JavaScript)\nEste node Code processa a saída anterior para extrair as porcentagens de CPU, memória e HD utilizando expressões regulares.\nA saída é transformada em um JSON com os valores separados para uso nos próximos nodes.\n5. Condições de Verificação (Node If)\nEste node If verifica se os valores de CPU, memória ou HD ultrapassam os limites configurados:\nCPU ≥ 60%\nMemória ≥ 60%\nHD ≥ 80%\nSe qualquer uma das condições for verdadeira, o fluxo segue para o próximo node para enviar o alerta.\n6. Node de Requisição HTTP\nEste node HTTP Request envia uma mensagem de alerta com os valores de CPU, memória e HD.\nSugestão de melhoria: Se desejar enviar este alerta por meio de um serviço específico (como um bot de Telegram ou outro API), configure o cabeçalho apikey e ajuste o endpoint para o destino desejado.\nPossíveis Ajustes ou Melhorias:\nIntervalo do Trigger: Ajuste o Schedule Trigger para a frequência de monitoramento ideal.\nConfirmação dos Limites de Alerta: Verifique se os valores de limite (CPU e memória em 60%, HD em 80%) estão adequados para o monitoramento da sua VPS.\nEndpoint HTTP para Alerta: Certifique-se de que o endpoint configurado para o alerta está correto e de que a apikey está preenchida corretamente.\n","height":920,"width":780,"color":5},"type":"n8n-nodes-base.stickyNote","position":[660,340],"typeVersion":1,"id":"014c70db-2bbf-418c-81ac-39768082d428","name":"Sticky Note"},{"parameters":{"command":"echo \"CPU: $(top -bn1 | grep 'Cpu(s)' | sed 's/.*, *\\([0-9.]*\\)%* id.*/\\1/' | awk '{print 100 - $1\"%\"}'), MEMÓRIA: $(free -m | awk '/Mem:/ { printf(\"%.2f%\"), $3/$2 * 100 }'), HD: $(df -h / | awk 'NR==2 {print $5}')\""},"id":"10684ab7-6e2f-42e0-824a-fb0f2fcafb1e","name":"puxa os dados da vps1","type":"n8n-nodes-base.ssh","typeVersion":1,"position":[1680,560]},{"parameters":{"content":"## Limpeza de Sistema Docker","height":240,"width":580,"color":3},"type":"n8n-nodes-base.stickyNote","position":[1460,480],"typeVersion":1,"id":"567af53f-0630-4bf0-8601-cae3ee56fa72","name":"Sticky Note1"},{"parameters":{"content":"##  Monitorar o uso de CPU, memória e HD da VPS\n","height":280,"width":1100},"type":"n8n-nodes-base.stickyNote","position":[1460,780],"typeVersion":1,"id":"67f18a6b-b595-4941-a95e-a567afa0f443","name":"Sticky Note2"},{"parameters":{"content":"## Enviar MSG Evolutiom","height":240,"width":220,"color":5},"type":"n8n-nodes-base.stickyNote","position":[2240,780],"typeVersion":1,"id":"56125103-9c0c-4dc9-9038-4c2f715756b6","name":"Sticky Note3"}],"connections":{"Schedule Trigger":{"main":[[{"node":"puxa os dados da vps","type":"main","index":0}]]},"puxa os dados da vps":{"main":[[{"node":"Code","type":"main","index":0}]]},"Code":{"main":[[{"node":"If","type":"main","index":0}]]},"If":{"main":[[{"node":"evolution envia msg","type":"main","index":0}]]},"Schedule Trigger1":{"main":[[{"node":"puxa os dados da vps1","type":"main","index":0}]]},"puxa os dados da vps1":{"main":[[{"node":"docker system prune -a","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":null,"pinData":{},"versionId":"542e5b86-1285-4618-aa34-e00adfa1cfbe","triggerCount":0,"tags":[]}