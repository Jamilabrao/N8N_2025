{"createdAt":"2025-03-06T13:33:30.434Z","updatedAt":"2025-03-06T22:15:33.758Z","id":"ysdf5AGr0JlEwaQ5","name":"ZAP FINANCEIRO - WH PERFECT","active":true,"nodes":[{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $json.body.sale_status_enum_key }}","rightValue":"approved","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"APROVADA"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"8e858286-3958-4c76-b11a-235a804c7de8","leftValue":"={{ $json.body.sale_status_enum_key }}","rightValue":"pending","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"PIX GERADO"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"e662c99a-b618-4c3d-935b-e8a049dee9b5","leftValue":"={{ $json.body.sale_status_enum_key }}","rightValue":"refunded","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"REEMBOLSO"}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[-860,220],"id":"a0887c88-d01c-4be8-98f1-406cdea9a3f7","name":"Switch4"},{"parameters":{"content":"# Webhook PERFECTPAY\n** BUSCA USUARIO NO DB, SE NÃO EXISTIR CRIA.\n** SE EXISTIR ATUALIZA STATUS","height":960,"width":1680,"color":2},"type":"n8n-nodes-base.stickyNote","position":[-1100,-180],"typeVersion":1,"id":"32d087db-a675-4fcc-be48-f46260ecac94","name":"Sticky Note10"},{"parameters":{"operation":"update","tableId":"usuario","filters":{"conditions":[{"keyName":"TELEFONE","condition":"eq","keyValue":"={{ $json.TELEFONE }}"}]},"fieldsUi":{"fieldValues":[{"fieldId":"NOME","fieldValue":"={{ $json.NOME }}"},{"fieldId":"EMAIL","fieldValue":"={{ $json.EMAIL }}"},{"fieldId":"TELEFONE","fieldValue":"={{ $json.TELEFONE }}"},{"fieldId":"STATUS","fieldValue":"=ATIVO"},{"fieldId":"DATA DA COMPRA","fieldValue":"={{ $('Edit Fields9').item.json['DATA DA COMPRA'] }}"},{"fieldId":"REMOTEJID-USUARIO","fieldValue":"={{ $json.TELEFONE }}@s.whatsapp.net "},{"fieldId":"CARGO","fieldValue":"={{ $json.CARGO }}"},{"fieldId":"ORIGEM","fieldValue":"PERFECTPAY"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-60,0],"id":"bb588dc4-5f18-44a3-a96d-e83dd89cc412","name":"Supabase","credentials":{"supabaseApi":{"id":"337Z7ndUMMaF8CZx","name":"Supabase ZAP FINANCEIRO"}}},{"parameters":{"assignments":{"assignments":[{"id":"02913ae9-eaad-40b5-8ec8-400b1d361573","name":"NOME","value":"={{ $json.body.customer.full_name }}","type":"string"},{"id":"e3c31034-4bf1-4f0b-a290-f90e9223014e","name":"EMAIL","value":"={{ $json.body.customer.email }}","type":"string"},{"id":"fa7279ac-d5d9-4ff2-8369-c0921e0638a2","name":"TELEFONE","value":"=55{{ $json.body.customer.phone_formated.replace(/\\D/g, '').replace(/^(\\d{2})9/, '$1') }}","type":"string"},{"id":"d0c63cd7-6f24-4bb7-b400-948bd1bf6a3d","name":"STATUS","value":"ATIVO","type":"string"},{"id":"ae1dc5b3-ba50-4ea1-9f57-00900364dba7","name":"DATA DA COMPRA","value":"={{ $json.body.date_approved }}","type":"string"},{"id":"cc2e7ab5-2cff-4c2c-b43d-5ca42b5e6525","name":"CARGO","value":"PADRÃO","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-600,-80],"id":"187de0d8-ea94-475b-8135-75d9b20ba5e8","name":"Edit Fields9"},{"parameters":{"assignments":{"assignments":[{"id":"02913ae9-eaad-40b5-8ec8-400b1d361573","name":"NOME","value":"={{ $json.body.customer.full_name }}","type":"string"},{"id":"e3c31034-4bf1-4f0b-a290-f90e9223014e","name":"EMAIL","value":"={{ $json.body.customer.email }}","type":"string"},{"id":"fa7279ac-d5d9-4ff2-8369-c0921e0638a2","name":"TELEFONE","value":"=55{{ $json.body.customer.phone_formated.replace(/\\D/g, '').replace(/^(\\d{2})9/, '$1') }}","type":"string"},{"id":"d0c63cd7-6f24-4bb7-b400-948bd1bf6a3d","name":"STATUS","value":"AGUARDANDO PAGAMENTO","type":"string"},{"id":"ae1dc5b3-ba50-4ea1-9f57-00900364dba7","name":"DATA DA COMPRA","value":"={{ $json.body.date_created }}","type":"string"},{"id":"cc2e7ab5-2cff-4c2c-b43d-5ca42b5e6525","name":"CARGO","value":"PADRÃO","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-260,220],"id":"0dea6ef2-5ff4-4148-b0f4-b8bd44b0a762","name":"Edit Fields2"},{"parameters":{"tableId":"usuario","fieldsUi":{"fieldValues":[{"fieldId":"NOME","fieldValue":"={{ $json.NOME }}"},{"fieldId":"EMAIL","fieldValue":"={{ $json.EMAIL }}"},{"fieldId":"TELEFONE","fieldValue":"={{ $json.TELEFONE }}"},{"fieldId":"STATUS","fieldValue":"={{ $json.STATUS }}"},{"fieldId":"DATA DA COMPRA","fieldValue":"={{ $json['DATA DA COMPRA'] }}"},{"fieldId":"REMOTEJID-USUARIO","fieldValue":"={{ $json.TELEFONE }}@s.whatsapp.net "},{"fieldId":"CARGO","fieldValue":"={{ $json.CARGO }}"},{"fieldId":"ORIGEM","fieldValue":"PERFECTPAY"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-60,220],"id":"096ad27e-2fdb-4250-9efd-f220e422bc2b","name":"Supabase4","credentials":{"supabaseApi":{"id":"337Z7ndUMMaF8CZx","name":"Supabase ZAP FINANCEIRO"}}},{"parameters":{},"type":"n8n-nodes-base.noOp","typeVersion":1,"position":[260,480],"id":"9fadc2ed-0bfe-4c8f-adee-c9c8f77d5f84","name":"No Operation, do nothing3"},{"parameters":{"httpMethod":"POST","path":"zapfinanceiroperfect","options":{}},"type":"n8n-nodes-base.webhook","typeVersion":2,"position":[-1060,220],"id":"581debbb-17ce-45ef-af27-deec225b9caf","name":"webhook-perfectpay","webhookId":"5d0dcfec-903c-4845-a8d6-9fd0656825f7"},{"parameters":{"tableId":"usuario","fieldsUi":{"fieldValues":[{"fieldId":"NOME","fieldValue":"={{ $('Edit Fields9').item.json.NOME }}"},{"fieldId":"EMAIL","fieldValue":"={{ $('Edit Fields9').item.json.EMAIL }}"},{"fieldId":"TELEFONE","fieldValue":"={{ $('Edit Fields9').item.json.TELEFONE }}"},{"fieldId":"STATUS","fieldValue":"=ATIVO"},{"fieldId":"DATA DA COMPRA","fieldValue":"={{ $('Edit Fields9').item.json['DATA DA COMPRA'] }}"},{"fieldId":"REMOTEJID-USUARIO","fieldValue":"={{ $('Edit Fields9').item.json.TELEFONE }}@s.whatsapp.net "},{"fieldId":"CARGO","fieldValue":"={{ $('Edit Fields9').item.json.CARGO }}"},{"fieldId":"ORIGEM","fieldValue":"PERFECTPAY"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-60,-160],"id":"5d75057b-51b0-4c83-9860-6449f4282c60","name":"Supabase5","credentials":{"supabaseApi":{"id":"337Z7ndUMMaF8CZx","name":"Supabase ZAP FINANCEIRO"}}},{"parameters":{"operation":"getAll","tableId":"usuario","returnAll":true,"filters":{"conditions":[{"keyName":"TELEFONE","condition":"eq","keyValue":"={{ \n  (() => {\n    let numero = $json.TELEFONE;\n\n    // Se o número tem 13 dígitos (celular com o 9 extra), removemos o \"9\" após os 4 primeiros dígitos\n    if (numero.length === 13) {\n      numero = numero.slice(0, 4) + numero.slice(5);\n    }\n\n    return numero;\n  })()\n}}\n"},{"keyName":"TELEFONE","condition":"eq","keyValue":"={{ \n  (() => {\n    let numero = $json.TELEFONE;\n\n    // Se o número tem 12 dígitos (indica celular antigo sem o 9), adicionamos o \"9\" após os 4 primeiros dígitos\n    if (numero.length === 12) {\n      numero = numero.slice(0, 4) + '9' + numero.slice(4);\n    }\n\n    return numero;\n  })()\n}}\n"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-420,-80],"id":"38790b07-45f4-478c-b6a8-994f512b017b","name":"Supabase6","alwaysOutputData":true,"credentials":{"supabaseApi":{"id":"337Z7ndUMMaF8CZx","name":"Supabase ZAP FINANCEIRO"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"1717d3dd-1b75-4cba-8b25-65c37e3dc7a0","leftValue":"={{ $json.TELEFONE }}","rightValue":"={{ $('Edit Fields9').item.json.TELEFONE }}","operator":{"type":"string","operation":"notEquals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"NÃO EXISTE"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"63da9779-70b2-4ad6-9000-d927b5702851","leftValue":"={{ $('Edit Fields9').item.json.TELEFONE }}","rightValue":"={{ $json.TELEFONE }}","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"EXISTE"}]},"looseTypeValidation":true,"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[-240,-80],"id":"7d33f731-7109-4ec3-9973-3afec19b04ab","name":"Switch7"},{"parameters":{"operation":"update","tableId":"usuario","filters":{"conditions":[{"keyName":"TELEFONE","condition":"eq","keyValue":"={{ $json.TELEFONE }}"}]},"fieldsUi":{"fieldValues":[{"fieldId":"NOME","fieldValue":"={{ $json.NOME }}"},{"fieldId":"EMAIL","fieldValue":"={{ $json.EMAIL }}"},{"fieldId":"TELEFONE","fieldValue":"={{ $json.TELEFONE }}"},{"fieldId":"STATUS","fieldValue":"={{ $('Edit Fields').item.json.STATUS }}"},{"fieldId":"DATA DA COMPRA","fieldValue":"={{ $('Edit Fields').item.json['DATA DA COMPRA'] }}"},{"fieldId":"REMOTEJID-USUARIO","fieldValue":"={{ $json.TELEFONE }}@s.whatsapp.net "},{"fieldId":"CARGO","fieldValue":"={{ $json.CARGO }}"},{"fieldId":"ORIGEM","fieldValue":"PERFECTPAY"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-40,620],"id":"fcee1e12-0773-4d89-aeb3-7c43c495666e","name":"Supabase1","credentials":{"supabaseApi":{"id":"337Z7ndUMMaF8CZx","name":"Supabase ZAP FINANCEIRO"}}},{"parameters":{"assignments":{"assignments":[{"id":"02913ae9-eaad-40b5-8ec8-400b1d361573","name":"NOME","value":"={{ $json.body.customer.full_name }}","type":"string"},{"id":"e3c31034-4bf1-4f0b-a290-f90e9223014e","name":"EMAIL","value":"={{ $json.body.customer.email }}","type":"string"},{"id":"fa7279ac-d5d9-4ff2-8369-c0921e0638a2","name":"TELEFONE","value":"=55{{ $json.body.customer.phone_formated.replace(/\\D/g, '').replace(/^(\\d{2})9/, '$1') }}","type":"string"},{"id":"d0c63cd7-6f24-4bb7-b400-948bd1bf6a3d","name":"STATUS","value":"BLOQUEADO","type":"string"},{"id":"ae1dc5b3-ba50-4ea1-9f57-00900364dba7","name":"DATA DA COMPRA","value":"={{ $json.body.date_approved }}","type":"string"},{"id":"cc2e7ab5-2cff-4c2c-b43d-5ca42b5e6525","name":"CARGO","value":"PADRÃO","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-620,520],"id":"971242ea-c90f-4807-86bc-3db0199f2f48","name":"Edit Fields"},{"parameters":{"tableId":"usuario","fieldsUi":{"fieldValues":[{"fieldId":"NOME","fieldValue":"={{ $('Edit Fields').item.json.NOME }}"},{"fieldId":"EMAIL","fieldValue":"={{ $('Edit Fields').item.json.EMAIL }}"},{"fieldId":"TELEFONE","fieldValue":"={{ $('Edit Fields').item.json.TELEFONE }}"},{"fieldId":"STATUS","fieldValue":"={{ $('Edit Fields').item.json.STATUS }}"},{"fieldId":"DATA DA COMPRA","fieldValue":"={{ $('Edit Fields').item.json['DATA DA COMPRA'] }}"},{"fieldId":"REMOTEJID-USUARIO","fieldValue":"={{ $('Edit Fields').item.json.TELEFONE }}@s.whatsapp.net "},{"fieldId":"CARGO","fieldValue":"={{ $('Edit Fields').item.json.CARGO }}"},{"fieldId":"ORIGEM","fieldValue":"PERFECTPAY"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-40,420],"id":"35b8d1ba-dfbd-42c0-bd13-cc1c3e3b5588","name":"Supabase9","credentials":{"supabaseApi":{"id":"337Z7ndUMMaF8CZx","name":"Supabase ZAP FINANCEIRO"}}},{"parameters":{"operation":"getAll","tableId":"usuario","returnAll":true,"filters":{"conditions":[{"keyName":"TELEFONE","condition":"eq","keyValue":"={{ \n  (() => {\n    let numero = $json.TELEFONE;\n\n    // Se o número tem 13 dígitos (celular com o 9 extra), removemos o \"9\" após os 4 primeiros dígitos\n    if (numero.length === 13) {\n      numero = numero.slice(0, 4) + numero.slice(5);\n    }\n\n    return numero;\n  })()\n}}\n"},{"keyName":"TELEFONE","condition":"eq","keyValue":"={{ \n  (() => {\n    let numero = $json.TELEFONE;\n\n    // Se o número tem 12 dígitos (indica celular antigo sem o 9), adicionamos o \"9\" após os 4 primeiros dígitos\n    if (numero.length === 12) {\n      numero = numero.slice(0, 4) + '9' + numero.slice(4);\n    }\n\n    return numero;\n  })()\n}}\n"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-420,520],"id":"9ef0eb1a-b200-47d9-b311-19bf0042ccd4","name":"Supabase10","alwaysOutputData":true,"credentials":{"supabaseApi":{"id":"337Z7ndUMMaF8CZx","name":"Supabase ZAP FINANCEIRO"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"1717d3dd-1b75-4cba-8b25-65c37e3dc7a0","leftValue":"={{ $json.TELEFONE }}","rightValue":"={{ $('Edit Fields').item.json.TELEFONE }}","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"NÃO EXISTE"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"63da9779-70b2-4ad6-9000-d927b5702851","leftValue":"={{ $('Edit Fields').item.json.TELEFONE }}","rightValue":"={{ $json.TELEFONE }}","operator":{"type":"string","operation":"notEquals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"EXISTE"}]},"looseTypeValidation":true,"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[-220,520],"id":"90b4adc5-eb7c-4e04-82b7-45fa8e46768e","name":"Switch8"},{"parameters":{"content":"## ZÉ DO REEMBOLSO","height":380,"width":800,"color":3},"type":"n8n-nodes-base.stickyNote","position":[-640,400],"typeVersion":1,"id":"c5bb1abe-2547-48d7-8ff9-a538261e92ea","name":"Sticky Note1"},{"parameters":{"operation":"appendOrUpdate","documentId":{"__rl":true,"value":"1NGpi4nP2hfBLV5mq9ZvcCSnec4qH_l2Wg-mmONQ3LzI","mode":"list","cachedResultName":"AGENTE IA - GASTOS","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1NGpi4nP2hfBLV5mq9ZvcCSnec4qH_l2Wg-mmONQ3LzI/edit?usp=drivesdk"},"sheetName":{"__rl":true,"value":1208608738,"mode":"list","cachedResultName":"SUPABASE","cachedResultUrl":"https://docs.google.com/spreadsheets/d/1NGpi4nP2hfBLV5mq9ZvcCSnec4qH_l2Wg-mmONQ3LzI/edit#gid=1208608738"},"columns":{"mappingMode":"autoMapInputData","value":{},"matchingColumns":["TELEFONE"],"schema":[{"id":"id","displayName":"id","required":false,"defaultMatch":true,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"NOME","displayName":"NOME","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"EMAIL","displayName":"EMAIL","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"TELEFONE","displayName":"TELEFONE","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false},{"id":"STATUS","displayName":"STATUS","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"REMOTEJID-USUARIO","displayName":"REMOTEJID-USUARIO","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"CARGO","displayName":"CARGO","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"DATA DA COMPRA","displayName":"DATA DA COMPRA","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true},{"id":"ORIGEM","displayName":"ORIGEM","required":false,"defaultMatch":false,"display":true,"type":"string","canBeUsedToMatch":true,"removed":false}],"attemptToConvertTypes":false,"convertFieldsToString":false},"options":{}},"type":"n8n-nodes-base.googleSheets","typeVersion":4.5,"position":[260,220],"id":"41897ff8-378d-429d-84c0-6f0002ac56b4","name":"Google Sheets","credentials":{"googleSheetsOAuth2Api":{"id":"c1hmUtfYiP5FWVBk","name":"GOOGLE JAMIL"}}},{"parameters":{"content":"## AGUARDANDO PAGAMENTO","height":180,"width":800,"color":5},"type":"n8n-nodes-base.stickyNote","position":[-640,200],"typeVersion":1,"id":"115c2db8-8b79-483d-b115-bd67fd242fea","name":"Sticky Note2"},{"parameters":{"content":"## PAGAMENTO OK","height":360,"width":800,"color":5},"type":"n8n-nodes-base.stickyNote","position":[-640,-180],"typeVersion":1,"id":"ae96b6e0-a133-4509-aa4b-1f570b895a3b","name":"Sticky Note3"},{"parameters":{"content":"## BACKUP SHEET","height":260,"width":280,"color":5},"type":"n8n-nodes-base.stickyNote","position":[180,140],"typeVersion":1,"id":"6b96be9d-89a2-4f19-a58e-f24de8d95a14","name":"Sticky Note4"}],"connections":{"Switch4":{"main":[[{"node":"Edit Fields9","type":"main","index":0}],[{"node":"Edit Fields2","type":"main","index":0}],[{"node":"Edit Fields","type":"main","index":0}]]},"Supabase":{"main":[[{"node":"Google Sheets","type":"main","index":0}]]},"Edit Fields9":{"main":[[{"node":"Supabase6","type":"main","index":0}]]},"Edit Fields2":{"main":[[{"node":"Supabase4","type":"main","index":0}]]},"Supabase4":{"main":[[{"node":"Google Sheets","type":"main","index":0}]]},"webhook-perfectpay":{"main":[[{"node":"Switch4","type":"main","index":0}]]},"Supabase5":{"main":[[{"node":"Google Sheets","type":"main","index":0}]]},"Supabase6":{"main":[[{"node":"Switch7","type":"main","index":0}]]},"Switch7":{"main":[[{"node":"Supabase5","type":"main","index":0}],[{"node":"Supabase","type":"main","index":0}]]},"Supabase1":{"main":[[{"node":"Google Sheets","type":"main","index":0}]]},"Edit Fields":{"main":[[{"node":"Supabase10","type":"main","index":0}]]},"Supabase9":{"main":[[{"node":"Google Sheets","type":"main","index":0}]]},"Supabase10":{"main":[[{"node":"Switch8","type":"main","index":0}]]},"Switch8":{"main":[[{"node":"Supabase9","type":"main","index":0}],[{"node":"Supabase1","type":"main","index":0}]]},"Google Sheets":{"main":[[{"node":"No Operation, do nothing3","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"f794c7f5-706b-46b6-9674-5e45871ce2e6","triggerCount":1,"tags":[{"createdAt":"2025-03-06T13:31:59.613Z","updatedAt":"2025-03-06T13:31:59.613Z","id":"SdawizUjteXovZWb","name":"ZAPFINANCEIRO"}]}